vdb.html5.ads = {};
vdb.html5.ads.AdConfigEntry = vdb.core.Class.extend(function() {
    var AdType = vdb.enums.AdType;
    var parse = function(obj) {
        this._transactionId = obj["transactionId"];
        this._adxResult = obj["adxResult"];
        this._usid = obj["usid"];
        this._ruleCompanyId = obj["rcid"];
        this._overlayURL = obj["overlayURL"];
        this._thumbnail = obj["thumbnail"];
        this._fullsizeThumbnail = obj["fullsizeThumbnail"];
        this._videoTitle = obj["videoTitle"];
        this._videoId = obj["videoId"];
        this._videoDuration = obj["videoDuration"];
        this._acid = obj["acid"];
        this._asid = obj["asid"];
        this._auid = obj["auid"];
        this._isShim = obj["usesShim"] || false;
        this._rid = obj["rid"];
        this._impressionTracker = obj["impTracker"];
        this._urls = obj["urls"] || [];
        if (obj["url"] && this._urls.indexOf(obj["url"]) === -1) {
            this._urls.unshift(obj["url"]);
        }
        this._urlsLength = this._urls.length;
        switchToNextUrl.call(this);
        this._vastXml = obj["vastXml"];
        this._vastAds = obj["vastAds"];
        if (!this._currentUrl && !this._vastXml && !this._vastAds) {
            throw new Error("URL, VAST XML or Ads should be specified for each ad config entry");
        }
        this._vendor = obj["vendor"];
        this._name = obj["name"];
        this._startTimeout = obj["startTimeout"] || 2147483647;
        this.costPerImpression = Number(obj["cpm"]);
        if (isNaN(this.costPerImpression)) {
            this.costPerImpression = Number(vdb.Utils.base64Decode(obj["cpm"] || "")) || 0;
        }
        this._priorityBoost = Number(obj["priorityBoost"]) || 1;
        this._type = obj["type"] || AdType.ALL;
        this._midrollTiming = obj["midrollTiming"];
        this._adEngineType = obj["adEngineType"] || vdb.enums.AdEngineType.VAST;
        this._houseAd = obj["houseAd"] || false;
        this._strictSiteCheck = obj["strictSiteCheck"] || false;
        this._useInlinePlayer = obj["useInlinePlayer"];
        this._payable = obj["pbl"] === undefined ? true : obj["pbl"];
        this._profitCenter = obj["profitCenter"];
        var saleForce = obj["saleforce"] || {};
        this._bookingId = saleForce["bookingId"];
        this._lineItemId = saleForce["lineItemId"];
        var trackers = obj["trackers"] || {};
        this._thirdPartyImpressionTrackers = trackers["Impression"] || [];
        this._extraProperties = obj["extraProperties"] || {};
        return this;
    };
    var getUrl = function() {
        return this._resolver ? this._resolver.resolve(this._currentUrl) : this._currentUrl;
    };
    var getUrlsLength = function() {
        return this._urlsLength;
    };
    var isFirstUrlInSet = function() {
        return this._urlsLength > 1 && this._urlsLength === this._urls.length + 1;
    };
    var switchToNextUrl = function() {
        if (this._urls.length > 0) {
            this._currentUrl = this._urls.shift();
            return true;
        }
        return false;
    };
    var getAdditionalRequestTimeout = function() {
        if (this._urlsLength > 1) {
            return 4E3;
        }
        return 0;
    };
    var getVendor = function() {
        return this._vendor || "";
    };
    var getBookingId = function() {
        return this._bookingId || "";
    };
    var getLineItemId = function() {
        return this._lineItemId || "";
    };
    var getProfitCenter = function() {
        return this._profitCenter || "";
    };
    var getIsShim = function() {
        return this._isShim;
    };
    var getAdEngineType = function() {
        return this._adEngineType || "";
    };
    var getType = function() {
        return this._type || "";
    };
    var getMidrollTiming = function() {
        return this._midrollTiming || "";
    };
    var getAcid = function() {
        return this._acid || "";
    };
    var getOverlayURL = function() {
        return this._overlayURL || "";
    };
    var getThumbnail = function() {
        return this._thumbnail || "";
    };
    var getFullsizeThumbnail = function() {
        return this._fullsizeThumbnail || "";
    };
    var getVideoTitle = function() {
        return this._videoTitle || "";
    };
    var getVideoId = function() {
        return this._videoId || "";
    };
    var getVideoDuration = function() {
        return this._videoDuration || "";
    };
    var getThirdPartyImpressionTrackers = function() {
        return this._thirdPartyImpressionTrackers;
    };
    var getAsid = function() {
        return this._asid || "";
    };
    var getAuid = function() {
        return this._auid || "";
    };
    var getVastXml = function() {
        return this._vastXml || "";
    };
    var getVastAds = function() {
        return this._vastAds;
    };
    var getName = function() {
        return this._name || "";
    };
    var isStrictSiteCheck = function() {
        return this._strictSiteCheck || false;
    };
    var isHouseAd = function() {
        return this._houseAd || false;
    };
    var getImpressionTracker = function() {
        return this._resolver ? this._resolver.resolve(this._impressionTracker) : this._impressionTracker;
    };
    var getPriority = function() {
        return this.costPerImpression * this._priorityBoost;
    };
    var getCpm = function() {
        return this.costPerImpression;
    };
    var useInlinePlayer = function() {
        return this._useInlinePlayer;
    };
    var getRuleId = function() {
        return this._rid;
    };
    var getStartTimeout = function() {
        return this._startTimeout;
    };
    var getTransactionId = function() {
        return this._transactionId;
    };
    var getAdxResult = function() {
        return this._adxResult;
    };
    var getUsid = function() {
        return this._usid;
    };
    var getRuleCompanyId = function() {
        return this._ruleCompanyId;
    };
    var getExtraProperties = function() {
        return this._extraProperties;
    };
    var isLinear = function() {
        return this._type === AdType.ALL || this._type === AdType.PREROLL || this._type === AdType.MIDROLL;
    };
    var isPayable = function() {
        return this._payable;
    };
    var conformsType = function(type) {
        return this._type === type || this._type === AdType.ALL && (type === AdType.PREROLL || type === AdType.MIDROLL);
    };
    var prepare = function(resolver, type) {
        var allowedTypes = [AdType.PREROLL, AdType.MIDROLL, AdType.OVERLAY];
        if (allowedTypes.indexOf(type) === -1) {
            throw new Error("Bad type value: " + type);
        }
        var entry = this.clone.call(this);
        entry._type = type;
        entry._resolver = resolver;
        return entry;
    };
    var toString = function() {
        return "AdConfigEntry{name=" + this._name + ", type=" + this._type + ", vendor=" + this._vendor + ", url=" + this._url + ", cpm=" + this.costPerImpression + ", impTracker=" + this._impressionTracker + ", priorityBoost=" + this._priorityBoost + ", asid=" + this._asid + ", rid=" + this._rid + ", acid=" + this._acid + ", houseAd=" + this._houseAd + ", useInlinePlayer=" + this._useInlinePlayer + "}";
    };
    var clone = function() {
        var newEntry = new vdb.html5.ads.AdConfigEntry;
        vdb.Utils.copy(this, newEntry);
        return newEntry;
    };
    return{getAcid:getAcid, getOverlayURL:getOverlayURL, getThumbnail:getThumbnail, getFullsizeThumbnail:getFullsizeThumbnail, getVideoTitle:getVideoTitle, getVideoId:getVideoId, getVideoDuration:getVideoDuration, getThirdPartyImpressionTrackers:getThirdPartyImpressionTrackers, getAsid:getAsid, getAuid:getAuid, getVastXml:getVastXml, getVastAds:getVastAds, getName:getName, getUrl:getUrl, getUrlsLength:getUrlsLength, getAdditionalRequestTimeout:getAdditionalRequestTimeout, isFirstUrlInSet:isFirstUrlInSet,
        switchToNextUrl:switchToNextUrl, getAdEngineType:getAdEngineType, getVendor:getVendor, getProfitCenter:getProfitCenter, getBookingId:getBookingId, getLineItemId:getLineItemId, isHouseAd:isHouseAd, prepare:prepare, parse:parse, clone:clone, conformsType:conformsType, getType:getType, getMidrollTiming:getMidrollTiming, getImpressionTracker:getImpressionTracker, getPriority:getPriority, getCpm:getCpm, isStrictSiteCheck:isStrictSiteCheck, useInlinePlayer:useInlinePlayer, getRuleId:getRuleId, getTransactionId:getTransactionId,
        getAdxResult:getAdxResult, getUsid:getUsid, getRuleCompanyId:getRuleCompanyId, isLinear:isLinear, isPayable:isPayable, toString:toString, getExtraProperties:getExtraProperties, getIsShim:getIsShim, getStartTimeout:getStartTimeout};
}());
vdb.html5.ads.AdEngineError = vdb.errors.Error.extend(function() {
    return{init:function(message, severityLevel, timeout) {
        this._super(message);
        this.severity = typeof severityLevel === "undefined" ? vdb.html5.ads.AdEngineError.SEVERITY_MID : severityLevel;
        this.timeout = timeout;
    }};
}());
(function(def) {
    def.SEVERITY_LOW = 0;
    def.SEVERITY_MID = 1;
    def.SEVERITY_HIGH = 2;
})(vdb.html5.ads.AdEngineError);
vdb.html5.ads.AdEngineProducer = vdb.core.Class.extend(function() {
    return{init:function(adSystem, adsConfig, adContainers) {
        this._adSystem = adSystem;
        this._adsConfig = adsConfig;
        this._adContainers = adContainers;
    }, createAdEngine:function() {
    }, getType:function() {
        return null;
    }};
}());
vdb.html5.ads.AdEngine = vdb.EventBus.extend(function() {
    return{init:function() {
        this._super();
    }, getAdConfigEntry:null, getLastError:null, showOverlay:null, showLinearAd:null, load:null, stop:null, skip:function() {
    }, isPaused:null, pause:function() {
    }, resume:function() {
    }, setVolume:function() {
    }};
}());
vdb.html5.ads.AdLoader = vdb.EventBus.extend(function() {
    return{load:null};
}());
(function(def) {
    def.COMPLETED = "AD_LOAD_COMPLETE";
    def.INTERRUPTED = "AD_LOAD_INTERRUPTED";
})(vdb.html5.ads.AdLoader);
vdb.html5.ads.CompanionSlot = vdb.core.Class.extend(function() {
    return{width:0, height:0, parentSelector:null, selectorType:null, init:function(width, height, parentSelector, keepCompanion, selectorType) {
        vdb.log.getLogger("CompanionSlot").debug("init", "width", width, "height", height, "parentSelector", parentSelector, "keepCompanion", keepCompanion, " selectorType", selectorType);
        this.width = width;
        this.height = height;
        this.parentSelector = parentSelector;
        this.keepCompanion = keepCompanion || false;
        this.selectorType = selectorType || vdb.enums.CompanionSelectorType.ID;
    }, getDimensions:function() {
        return{x:0, y:0, width:this.width, height:this.height};
    }, toString:function() {
        return vdb.Utils.jsonStringify(this);
    }};
}());
vdb.html5.ads.engineadapter = {};
vdb.html5.ads.engineadapter.AdEngineAdapterBase = vdb.EventBus.extend(function() {
    var init = function(adsConfig, adPoolManager) {
        this._super();
        this._adsConfig = adsConfig;
        this._adPoolManager = adPoolManager;
        this._state = vdb.html5.ads.engineadapter.AdEngineAdapterBase.LOADING;
    };
    var appendListeners = function() {
    };
    var load = function() {
    };
    var run = function() {
        this._state = vdb.html5.ads.engineadapter.AdEngineAdapterBase.RUNNING;
        if (typeof this._volume !== "undefined") {
            this.setVolume(this._volume);
        }
    };
    var stop = function() {
    };
    var skip = function() {
    };
    var pause = function() {
    };
    var resume = function() {
    };
    var setVolume = function(volume) {
        this._volume = volume;
    };
    var getDuration = function() {
        return 0;
    };
    var getAdSkippableState = function() {
        return false;
    };
    var isLoading = function() {
        return this._state === vdb.html5.ads.engineadapter.AdEngineAdapterBase.LOADING;
    };
    var isReady = function() {
        return this._state === vdb.html5.ads.engineadapter.AdEngineAdapterBase.READY;
    };
    var isRunning = function() {
        return this._state === vdb.html5.ads.engineadapter.AdEngineAdapterBase.RUNNING;
    };
    var isComplete = function() {
        return this._state === vdb.html5.ads.engineadapter.AdEngineAdapterBase.COMPLETE;
    };
    var isFailed = function() {
        return this._state === vdb.html5.ads.engineadapter.AdEngineAdapterBase.FAILED;
    };
    var isStopped = function() {
        return this._state === vdb.html5.ads.engineadapter.AdEngineAdapterBase.STOPPED;
    };
    var isPaused = function() {
        return false;
    };
    var getAdConfigEntry = function() {
        return null;
    };
    var getMediaContent = function() {
        return null;
    };
    return{init:init, appendListeners:appendListeners, load:load, run:run, stop:stop, skip:skip, pause:pause, resume:resume, setVolume:setVolume, getDuration:getDuration, getAdSkippableState:getAdSkippableState, isLoading:isLoading, isReady:isReady, isRunning:isRunning, isComplete:isComplete, isFailed:isFailed, isPaused:isPaused, isStopped:isStopped, getAdConfigEntry:getAdConfigEntry, getMediaContent:getMediaContent, getVastAdNumber:function() {
    }};
}());
vdb.html5.ads.engineadapter.AdEngineAdapterBase.LOADING = "Engine.LOADING";
vdb.html5.ads.engineadapter.AdEngineAdapterBase.READY = "Engine.READY";
vdb.html5.ads.engineadapter.AdEngineAdapterBase.RUNNING = "Engine.RUNNING";
vdb.html5.ads.engineadapter.AdEngineAdapterBase.COMPLETE = "Engine.COMPLETE";
vdb.html5.ads.engineadapter.AdEngineAdapterBase.FAILED = "Engine.FAILED";
vdb.html5.ads.engineadapter.AdEngineAdapterBase.STOPPED = "Engine.STOPPED";
vdb.html5.ads.engineadapter.AdEngineAdapter = vdb.html5.ads.engineadapter.AdEngineAdapterBase.extend(function() {
    var LOGGER = vdb.log.getLogger("AdEngineAdapter");
    var AdEngineAdapterBase = vdb.html5.ads.engineadapter.AdEngineAdapterBase;
    var init = function(adEngine, adsConfig, adPoolManager) {
        this._super(adsConfig, adPoolManager);
        this._engine = adEngine;
        this._listeners = vdb.events.EventContext.group(vdb.events.EventContext.bind(adEngine, vdb.events.AdEvent.AD_ENGINE_READY, _onEngineReady.bind(this)), vdb.events.EventContext.bind(adEngine, vdb.events.AdEvent.AD_ENGINE_COMPLETE, _onEngineComplete.bind(this)), vdb.events.EventContext.bind(adEngine, vdb.events.AdEvent.AD_STARTED, this.dispatchEvent.bind(this)));
    };
    var appendListeners = function() {
        this._listeners.link(vdb.events.EventContext.group(arguments));
    };
    var load = function() {
        LOGGER.debug("load");
        this._engine.load();
    };
    var run = function() {
        if (this.isStopped()) {
            return;
        }
        this._super();
        var type = this.getAdConfigEntry().getType();
        LOGGER.debug("run", "adType", type);
        if (type === vdb.enums.AdType.OVERLAY) {
            this._engine.showOverlay();
        } else {
            this._engine.showLinearAd(this._adsConfig.maxLinearShowTime);
        }
    };
    var stop = function() {
        var doStop = !this.isComplete() && !this.isFailed() && !this.isStopped();
        LOGGER.debug("stop", doStop);
        if (doStop) {
            this._engine.stop();
            this._state = AdEngineAdapterBase.STOPPED;
        }
    };
    var skip = function() {
        this._engine.skip();
    };
    var pause = function() {
        this._engine.pause();
    };
    var resume = function() {
        this._engine.resume();
    };
    var setVolume = function(volume) {
        this._super(volume);
        if (this.isRunning()) {
            this._engine.setVolume(volume);
        }
    };
    var getDuration = function() {
        if (this._engine.getDuration) {
            return this._engine.getDuration();
        }
    };
    var getAdSkippableState = function() {
        if (this._engine.getAdSkippableState) {
            return this._engine.getAdSkippableState();
        }
    };
    var getVastAdNumber = function() {
        if (this._engine.getVastAdNumber) {
            return this._engine.getVastAdNumber();
        }
    };
    var isPaused = function() {
        if (this._engine.isPaused) {
            return this._engine.isPaused();
        }
    };
    var getAdConfigEntry = function() {
        return this._engine.getAdConfigEntry();
    };
    var getMediaContent = function() {
        if (this._engine.getMediaContent) {
            return this._engine.getMediaContent();
        }
    };
    var _onEngineReady = function(event) {
        LOGGER.debug("onEngineReady", event);
        this._state = AdEngineAdapterBase.READY;
        this.dispatchEvent(event);
    };
    var _onEngineComplete = function(event) {
        LOGGER.debug("onEngineComplete", event);
        var engine = event.target;
        event.configEntry = this.getAdConfigEntry();
        if (this._state === AdEngineAdapterBase.RUNNING || engine.getLastError()) {
            this._adPoolManager.release(this.getAdConfigEntry());
        }
        this._state = engine.getLastError() ? AdEngineAdapterBase.FAILED : AdEngineAdapterBase.COMPLETE;
        this.dispatchEvent(event);
        this._listeners.unbind();
    };
    return{init:init, appendListeners:appendListeners, load:load, run:run, stop:stop, skip:skip, pause:pause, resume:resume, setVolume:setVolume, getDuration:getDuration, getAdSkippableState:getAdSkippableState, getVastAdNumber:getVastAdNumber, isPaused:isPaused, getAdConfigEntry:getAdConfigEntry, getMediaContent:getMediaContent};
}());
vdb.html5.ads.engineadapter.MassiveAdEngineAdapter = vdb.html5.ads.engineadapter.AdEngineAdapterBase.extend(function() {
    var LOGGER = vdb.log.getLogger("MassiveAdEngineAdapter");
    var AdEvent = vdb.events.AdEvent;
    var AdEngineAdapterBase = vdb.html5.ads.engineadapter.AdEngineAdapterBase;
    var init = function(adEngines, adsConfig, adPoolManager) {
        this._super(adsConfig, adPoolManager);
        this._shims = [];
        this._shimListeners = [];
        this._waiterEngines = [];
        for (var i = 0;i < adEngines.length;++i) {
            this._shims.push(new vdb.html5.ads.engineadapter.AdEngineAdapter(adEngines[i], this._adsConfig, this._adPoolManager));
        }
    };
    var load = function() {
        this._super();
        this._waiterEngines = [];
        var shims = this._shims.concat();
        for (var i = 0;i < shims.length;++i) {
            var shim = shims[i];
            _listenersFor.call(this, shim).link(vdb.events.EventContext.bind(shim, AdEvent.AD_ENGINE_READY, _onEngineReady.bind(this, shim)), vdb.events.EventContext.bind(shim, AdEvent.AD_ENGINE_COMPLETE, _shimLoadError.bind(this, shim)));
            shim.load();
        }
    };
    var run = function() {
        this._super();
        for (var i = 0;i < this._waiterEngines.length;++i) {
            _runShim.call(this, this._waiterEngines[i]);
        }
        this._waiterEngines = [];
    };
    var stop = function() {
        var doStop = !this.isComplete() && !this.isFailed() && !this.isStopped();
        if (!doStop) {
            return;
        }
        this._super();
        this._shims = [];
        var cleanOut = [];
        var i;
        for (i = 0;i < this._shimListeners.length;++i) {
            cleanOut.push(this._shimListeners[i]["shim"]);
        }
        for (i = 0;i < cleanOut.length;++i) {
            var shim = cleanOut[i];
            shim.stop();
            this._state = AdEngineAdapterBase.STOPPED;
            _unbind.call(this, shim);
        }
    };
    var skip = function() {
        this._super();
        for (var i = 0;i < this._shims.length;++i) {
            var shim = this._shims[i];
            shim.skip();
        }
    };
    var pause = function() {
        this._super();
        for (var i = 0;i < this._shims.length;++i) {
            var shim = this._shims[i];
            shim.pause();
        }
    };
    var resume = function() {
        this._super();
        for (var i = 0;i < this._shims.length;++i) {
            var shim = this._shims[i];
            shim.resume();
        }
    };
    var setVolume = function(volume) {
        this._super();
        for (var i = 0;i < this._shims.length;++i) {
            var shim = this._shims[i];
            if (this.isRunning()) {
                shim.setVolume(volume);
            }
        }
    };
    var getDuration = function() {
        if (this._shims.length > 0) {
            return this._shims[0].getDuration();
        }
        return this._super();
    };
    var getAdSkippableState = function() {
        if (this._shims.length > 0 && typeof this._shims[0].getAdSkippableState === "function") {
            return this._shims[0].getAdSkippableState();
        }
        return this._super();
    };
    var isPaused = function() {
        if (this._shims.length > 0) {
            return this._shims[0].isPaused();
        }
        return this._super();
    };
    var getAdConfigEntry = function() {
        if (this._shims.length > 0) {
            return this._shims[0].getAdConfigEntry();
        }
        return this._super();
    };
    var getMediaContent = function() {
        if (this._shims.length > 0) {
            return this._shims[0].getMediaContent();
        }
        return this._super();
    };
    var _listenersFor = function(shim$$0) {
        var self = this;
        var findListeners = function(shim) {
            for (var i = 0;i < self._shimListeners.length;++i) {
                var l = self._shimListeners[i];
                if (l["shim"] === shim) {
                    return l["listeners"];
                }
            }
            return null;
        };
        var listeners = findListeners(shim$$0);
        if (!listeners) {
            listeners = vdb.events.EventContext.empty();
            self._shimListeners.push({"shim":shim$$0, "listeners":listeners});
        }
        return listeners;
    };
    var _runShim = function(shim) {
        _unbind.call(this, shim);
        _listenersFor.call(this, shim).link(vdb.events.EventContext.bind(shim, AdEvent.AD_STARTED, _shimStarted.bind(this, shim)), vdb.events.EventContext.bind(shim, AdEvent.AD_ENGINE_COMPLETE, _shimComplete.bind(this, shim)));
        shim.run();
    };
    var _unbind = function(shim) {
        _listenersFor.call(this, shim).unbind();
        for (var i = 0;i < this._shimListeners.length;++i) {
            var l = this._shimListeners;
            if (l["shim"] === shim) {
                this._shimListeners.splice(i, 1);
                return;
            }
        }
    };
    var _onEngineReady = function(shim, event) {
        if (!this._readySent) {
            this._readySent = true;
            this._state = AdEngineAdapterBase.READY;
            this.dispatchEvent(event);
        }
        if (this.isRunning()) {
            _runShim.call(this, shim);
        } else {
            this._waiterEngines.push(shim);
        }
    };
    var _shimLoadError = function(shim, event) {
        _releaseShim.call(this, shim);
        if (this._shims.length == 0) {
            _completeWith.call(this, AdEngineAdapterBase.FAILED, shim, event);
        }
    };
    var _shimStarted = function(shim) {
        var idx = this._shims.indexOf(shim);
        var cfg = shim.getAdConfigEntry();
        LOGGER.debug("Winner shim is " + (cfg ? cfg.getName() : "undefined") + ". Killing others.");
        var unbindShims = this._shims.concat();
        unbindShims.splice(idx, 1);
        for (var i = 0;i < unbindShims.length;++i) {
            var s = unbindShims[i];
            _unbind.call(this, s);
            s.stop();
        }
        this._shims = [shim];
    };
    var _shimComplete = function(shim, event) {
        _releaseShim.call(this, shim);
        if (this._shims.length == 0) {
            _completeWith.call(this, shim.isFailed() ? AdEngineAdapterBase.FAILED : AdEngineAdapterBase.COMPLETE, shim, event);
        }
    };
    var _completeWith = function(completeState, shim, event) {
        event.configEntry = shim.getAdConfigEntry();
        this._state = completeState;
        this.dispatchEvent(event);
    };
    var _releaseShim = function(shim) {
        _unbind.call(this, shim);
        var shimIdx = this._shims.indexOf(shim);
        if (shimIdx != -1) {
            this._shims.splice(shimIdx, 1);
        }
    };
    return{init:init, load:load, run:run, stop:stop, skip:skip, pause:pause, resume:resume, setVolume:setVolume, getDuration:getDuration, getAdSkippableState:getAdSkippableState, isPaused:isPaused, getAdConfigEntry:getAdConfigEntry, getMediaContent:getMediaContent};
}());
vdb.html5.ads.AdsRunner = vdb.EventBus.extend(function() {
    function runAdapter(adapter) {
        LOGGER.debug("runReadyEngineAdapter", adapter);
        this._activeEngineAdapter = adapter;
        this._adSystem.dispatchEvent(AdEvent.AD_ENGINE_RUN, adapter);
        adapter.run();
    }
    function isStopped() {
        return this._state === STATE.STOPPED;
    }
    function isLoaded() {
        return this._state === STATE.LOADED;
    }
    var LOGGER = vdb.log.getLogger("AdsRunner");
    var AdEvent = vdb.events.AdEvent;
    var STATE = {CREATED:"Created", LOADED:"Loaded", RUNNING:"Running", STOPPED:"Stopped"};
    var init = function(adsConfig, adSystem, adPoolManager, adContainers) {
        LOGGER.debug("init", "adsConfig", adsConfig);
        this._super();
        this._adSystem = adSystem;
        this._adsConfig = adsConfig;
        this._adPoolManager = adPoolManager;
        this._adContainers = adContainers;
        this.reset();
    };
    var reset = function() {
        this._deferred = [];
        this._state = STATE.CREATED;
        this._engineAdapters = [];
        this._activeEngineAdapter = null;
        this._volume = 1;
        this._softTimeoutId = -1;
        this._hardTimeoutId = -1;
    };
    var _callDeferred = function() {
        var deferred = this._deferred;
        this._deferred = [];
        for (var i = 0;i < deferred.length;i++) {
            var f = deferred[i];
            LOGGER.debug("Execute deferred function:", f);
            f.call(this);
        }
    };
    var _registerDeferred = function(f) {
        LOGGER.debug("Register deferred function:", f);
        this._deferred.push(f);
    };
    var run = function() {
        LOGGER.debug("run");
        if (this.isStopped()) {
            finish.call(this, "Runner already stopped");
            return;
        }
        if (this._state !== STATE.LOADED) {
            _registerDeferred.call(this, run);
            return;
        }
        this._state = STATE.RUNNING;
        if (this._engineAdapters[0].isReady()) {
            LOGGER.debug("run the most priority adapter", this._engineAdapters[0]);
            _runReadyEngineAdapter.call(this);
        }
        if (this._softTimeoutId === -1) {
            _runReadyEngineAdapter.call(this);
        }
        if (this._engineAdapters.length === 0) {
            finish.call(this, "No adapters - finish");
        } else {
            if (_allAdaptersFailed.call(this)) {
                finish.call(this, "All adapters failed - finish");
            }
        }
    };
    var _allAdaptersFailed = function() {
        for (var i = 0;i < this._engineAdapters.length;i++) {
            var adapter = this._engineAdapters[i];
            if (!adapter.isFailed()) {
                return false;
            }
        }
        return true;
    };
    var _onEngineReady = function(callback) {
        if (this._state === STATE.LOADED || this._state === STATE.RUNNING) {
            return;
        }
        this._state = STATE.LOADED;
        _callDeferred.call(this);
        if (callback) {
            setTimeout(callback, 0);
        }
    };
    var _bindAdapterListeners = function(engineAdapter, callback) {
        vdb.events.EventContext.bindOnce(engineAdapter, AdEvent.AD_ENGINE_READY, _onEngineReady.bind(this, callback));
        engineAdapter.appendListeners(vdb.events.EventContext.bind(engineAdapter, AdEvent.AD_ENGINE_READY, _adapterReadyOnLoad.bind(this, engineAdapter)), vdb.events.EventContext.bind(engineAdapter, AdEvent.AD_ENGINE_COMPLETE, adapterComplete.bind(this)));
    };
    var load = function(preparedEntries, callback) {
        LOGGER.debug("load", preparedEntries);
        if (preparedEntries.length === 0) {
            finish.call(this, "no ad entries");
            return;
        }
        var _this = this;
        vdb.Utils.callAsync(function(preparedEntries) {
            var shimEngines = [];
            var extraTimeout = 0;
            for (var i = 0;i < preparedEntries.length;i++) {
                var configEntry = preparedEntries[i];
                extraTimeout = Math.max(extraTimeout, configEntry.getAdditionalRequestTimeout());
                var engineType = configEntry.getAdEngineType();
                var adEngineProducer = _this._adSystem.getAdEngineProducer(engineType);
                if (!adEngineProducer) {
                    LOGGER.error("Ignore ad config entry ", configEntry, " Unknown ad engine type ", engineType);
                    _this._adPoolManager.markFailed(configEntry);
                    continue;
                }
                var adEngine = adEngineProducer.createAdEngine(configEntry);
                if (configEntry.getIsShim()) {
                    shimEngines.push(adEngine);
                } else {
                    var engineAdapter = new vdb.html5.ads.engineadapter.AdEngineAdapter(adEngine, _this._adsConfig, _this._adPoolManager);
                    _this._engineAdapters.push(engineAdapter);
                    _bindAdapterListeners.call(_this, engineAdapter, callback);
                }
            }
            if (shimEngines.length > 0) {
                var massiveAdapter = new vdb.html5.ads.engineadapter.MassiveAdEngineAdapter(shimEngines, _this._adsConfig, _this._adPoolManager);
                _this._engineAdapters.push(massiveAdapter);
                _bindAdapterListeners.call(_this, massiveAdapter, callback);
            }
            _this._softTimeoutId = setTimeout(_softTimeout.bind(_this), _this._adsConfig.softTimeout * 1E3);
            _this._hardTimeoutId = setTimeout(_hardTimeout.bind(_this), _this._adsConfig.hardTimeout * 1E3 + extraTimeout);
            this._adSystem.dispatchEvent(AdEvent.AD_ENGINES_LOAD, _this._engineAdapters);
            for (var x = 0;x < _this._engineAdapters.length;x++) {
                engineAdapter = _this._engineAdapters[x];
                if (_this._volume !== undefined) {
                    engineAdapter.setVolume(_this._volume);
                }
                engineAdapter.load();
            }
        }.bind(this, preparedEntries));
    };
    var _adapterReadyOnLoad = function(adapter) {
        LOGGER.debug("adapterReady", adapter);
        if (this._state === STATE.RUNNING) {
            if (this._engineAdapters[0].isReady()) {
                LOGGER.debug("run the most priority adapter", adapter);
                _runReadyEngineAdapter.call(this);
            }
            if (this._softTimeoutId === -1) {
                _runReadyEngineAdapter.call(this);
            }
        }
    };
    var _softTimeout = function() {
        LOGGER.debug("softTimeout (" + this._adsConfig.softTimeout + "s)");
        this._softTimeoutId = -1;
        if (this._state === STATE.RUNNING) {
            if (this._engineAdapters[0].isRunning()) {
                LOGGER.info("the most priority adapter is already running");
                return;
            }
            _runReadyEngineAdapter.call(this);
        }
    };
    var _hardTimeout = function() {
        LOGGER.debug("hardTimeout (" + this._adsConfig.hardTimeout + "s)");
        this._hardTimeoutId = -1;
        if (this._state === STATE.RUNNING) {
            if (!this._activeEngineAdapter) {
                finish.call(this, "hard timeout");
            }
        }
    };
    var _runReadyEngineAdapter = function() {
        if (this._activeEngineAdapter) {
            return;
        }
        for (var i = 0;i < this._engineAdapters.length;i++) {
            var adapter = this._engineAdapters[i];
            if (adapter.isReady()) {
                runAdapter.call(this, adapter);
                break;
            }
        }
    };
    var stop = function() {
        LOGGER.debug("stop");
        this._state = STATE.STOPPED;
        var i = 0;
        for (var len = this._engineAdapters.length;i < len;i++) {
            this._engineAdapters[i].stop();
        }
    };
    var skip = function() {
        if (this._activeEngineAdapter) {
            this._activeEngineAdapter.skip();
        } else {
            if (this._engineAdapters[0]) {
                this._engineAdapters[0].skip();
            }
        }
    };
    var pause = function() {
        var i = 0;
        for (var len = this._engineAdapters.length;i < len;i++) {
            var adapter = this._engineAdapters[i];
            if (adapter.isRunning()) {
                adapter.pause();
            }
        }
    };
    var isPaused = function() {
        if (this._activeEngineAdapter) {
            return this._activeEngineAdapter.isPaused();
        }
        return undefined;
    };
    var resume = function() {
        var i = 0;
        for (var len = this._engineAdapters.length;i < len;i++) {
            var adapter = this._engineAdapters[i];
            if (adapter.isRunning()) {
                adapter.resume();
            }
        }
    };
    var setVolume = function(volume) {
        this._volume = volume;
        var i = 0;
        for (var len = this._engineAdapters.length;i < len;i++) {
            var adapter = this._engineAdapters[i];
            adapter.setVolume(volume);
        }
    };
    var getDuration = function() {
        if (this._activeEngineAdapter) {
            return this._activeEngineAdapter.getDuration();
        }
        return undefined;
    };
    var getAdSkippableState = function() {
        if (this._activeEngineAdapter) {
            return this._activeEngineAdapter.getAdSkippableState();
        }
        return undefined;
    };
    var getVastAdNumber = function() {
        if (this._activeEngineAdapter) {
            return this._activeEngineAdapter.getVastAdNumber();
        }
        return undefined;
    };
    var getMediaContent = function() {
        if (this._activeEngineAdapter) {
            return this._activeEngineAdapter.getMediaContent();
        }
        return undefined;
    };
    var adapterComplete = function(event) {
        var configEntry = event.configEntry;
        LOGGER.debug("adapterComplete", "configEntry", configEntry, "event", event);
        var adapter = event.target;
        var isActiveAdapter = adapter === this._activeEngineAdapter;
        if (isActiveAdapter) {
            this._activeEngineAdapter = null;
        }
        if (adapter.isFailed()) {
            adapterFailed.call(this, configEntry, adapter, isActiveAdapter);
        } else {
            this._state = _hasLiveAdapters.call(this) ? STATE.LOADED : STATE.STOPPED;
            this.dispatchEvent(new vdb.events.Event(vdb.events.Event.COMPLETE));
        }
        this._adSystem.dispatchEvent(AdEvent.AD_ENGINE_COMPLETE, configEntry);
    };
    var adapterFailed = function(configEntry, adapter, isActiveAdapter) {
        LOGGER.debug("adapterFailed", configEntry, adapter, isActiveAdapter);
        this._adPoolManager.markFailed(configEntry);
        if (_allAdaptersFailed.call(this)) {
            finish.call(this, "all ads are failed");
        } else {
            if (this._state === STATE.RUNNING && isActiveAdapter) {
                LOGGER.info("Engine completed with error.");
                if (_hasLiveAdapters.call(this)) {
                    LOGGER.info("Trying next engine...");
                    _runReadyEngineAdapter.call(this);
                } else {
                    this.dispatchEvent(new vdb.events.Event(vdb.events.Event.COMPLETE, {error:"no alive adapters left"}));
                }
            }
        }
    };
    var _hasLiveAdapters = function() {
        for (var key in this._engineAdapters) {
            if (Object.prototype.hasOwnProperty.call(this._engineAdapters, key)) {
                if (this._engineAdapters[key].isLoading() || this._engineAdapters[key].isReady()) {
                    return true;
                }
            }
        }
        return false;
    };
    var finish = function(error) {
        LOGGER.debug("finish", error);
        this.stop();
        this.dispatchEvent(new vdb.events.Event(vdb.events.Event.COMPLETE, {error:error}));
    };
    return{init:init, load:load, run:run, stop:stop, skip:skip, reset:reset, pause:pause, resume:resume, setVolume:setVolume, isPaused:isPaused, getDuration:getDuration, getAdSkippableState:getAdSkippableState, getVastAdNumber:getVastAdNumber, getMediaContent:getMediaContent, isStopped:isStopped, isLoaded:isLoaded};
}());
vdb.html5.ads.events = {};
vdb.html5.ads.events.AdSystemEvent = {};
(function(def) {
    def.RESIZE = "AdSystem.Resize";
    def.LINEAR_CHANGE = "AdSystem.LinearChange";
})(vdb.html5.ads.events.AdSystemEvent);
vdb.html5.ads.modules = {};
vdb.html5.ads.modules.ima = {};
vdb.html5.ads.modules.ima.ImaLibLoader = function() {
    function loadIma() {
        LOGGER.debug("Loading IMA lib...");
        imaLibLoadState = IMA_LIB_LOAD_STATES.LOADING;
        vdb.Utils.injectScript(document, this._url, onImaLoaded.bind(this));
    }
    function onImaLoaded(success) {
        if (success && window["google"] && window["google"]["ima"]) {
            imaLibLoadState = IMA_LIB_LOAD_STATES.SUCCESS;
            LOGGER.debug("IMA lib loaded", "version", window["google"]["ima"]["VERSION"]);
        } else {
            success = false;
            imaLibLoadState = IMA_LIB_LOAD_STATES.FAILED;
            LOGGER.error("Failed to load IMA lib");
        }
        for (var i = 0;i < imaLoadCallbacks.length;i++) {
            imaLoadCallbacks[i](success);
        }
        imaLoadCallbacks = [];
    }
    var LOGGER = vdb.log.getLogger("ImaLibLoader");
    var IMA_LIB_LOAD_STATES = {NOT_STARTED:"not_started", LOADING:"loading", FAILED:"failed", SUCCESS:"success"};
    var imaLibLoadState = IMA_LIB_LOAD_STATES.NOT_STARTED;
    var imaLoadCallbacks = [];
    return{load:function(isSecure, callback) {
        this._url = isSecure ? vdb.Props["ima.url.secure"] : vdb.Props["ima.url"];
        if (imaLibLoadState === IMA_LIB_LOAD_STATES.NOT_STARTED) {
            loadIma.call(this);
        }
        if (callback) {
            if (imaLibLoadState === IMA_LIB_LOAD_STATES.LOADING) {
                imaLoadCallbacks.push(callback);
            } else {
                if (imaLibLoadState === IMA_LIB_LOAD_STATES.SUCCESS) {
                    callback(true);
                } else {
                    callback(false);
                }
            }
        }
    }};
}();
vdb.html5.ads.modules.vast = {};
vdb.html5.ads.modules.vast.adapter = {};
vdb.html5.ads.modules.vast.adapter.InlinePlayerAdapter = vdb.core.Class.extend(function() {
    function loadScript(container, callback, inlineUrl) {
        (new vdb.modules.ModuleLoader({container:container, scriptUrls:inlineUrl, initFuncName:"InlinePlayer"})).appendHtml('<div class="inline-player" style="height:100%;position:relative"></div>').setIsolated(true).load(callback);
    }
    var LOGGER = vdb.log.getLogger("InlinePlayerAdapter");
    return{init:function(container, options, inlineUrl, callback) {
        this._deferred = [];
        var _this = this;
        loadScript(container, function(iwin) {
            LOGGER.debug("Inline Player script loaded");
            _this._player = new iwin["InlinePlayer"](options);
            _this._execAllDeferred();
            callback();
        }, inlineUrl);
    }, loadVideo:function(url) {
        if (this._player) {
            this._player["loadVideo"](url);
        } else {
            this._addDeferred(this.loadVideo, arguments);
        }
    }, _addDeferred:function(func, args) {
        var _this = this;
        this._deferred.push(function() {
            func.apply(_this, args);
        });
    }, _execAllDeferred:function() {
        for (var deferred;deferred = this._deferred.shift();) {
            deferred();
        }
    }, getCurrentTime:function() {
        return this._player ? this._player["getCurrentTime"]() : 0;
    }, getDuration:function() {
        return this._player ? this._player["getDuration"]() : 0;
    }, getVolume:function() {
        return this.isMuted() ? 0 : 1;
    }, getRemainingTime:function() {
        return this.getDuration() - this.getCurrentTime();
    }, getCurrentPercent:function() {
        return this.getCurrentTime() / this.getDuration();
    }, play:function() {
        if (this._player) {
            this._player["play"]();
        } else {
            this._addDeferred(this.play);
        }
    }, pause:function() {
        if (this._player) {
            this._player["pause"]();
        } else {
            this._addDeferred(this.pause);
        }
    }, mute:function() {
        if (this._player) {
            this._player["mute"]();
        } else {
            this._addDeferred(this.mute);
        }
    }, unmute:function() {
        if (this._player) {
            this._player["unmute"]();
        } else {
            this._addDeferred(this.unmute);
        }
    }, isMuted:function() {
        return this._player ? this._player["isMuted"]() : true;
    }, isPaused:function() {
        return this._player ? this._player["isPaused"]() : undefined;
    }, isPlaying:function() {
        return this._player ? this._player["isPlaying"]() : undefined;
    }, stop:function() {
        if (this._player) {
            this._player["stop"]();
        } else {
            this._addDeferred(this.stop);
        }
    }, addEventListener:function(event, callback) {
        if (this._player) {
            this._player["on"](event, callback);
        } else {
            this._addDeferred(this.addEventListener, arguments);
        }
    }, removeEventListener:function(event, callback) {
        if (this._player) {
            this._player["off"](event, callback);
        } else {
            this._addDeferred(this.removeEventListener, arguments);
        }
    }};
}());
vdb.html5.ads.modules.vast.enums = {};
vdb.html5.ads.modules.vast.enums.InlinePlayerEvent = {VIDEO_META:"VIDEO_META", VIDEO_START:"VIDEO_START", VIDEO_PLAY:"VIDEO_PLAY", VIDEO_PAUSE:"VIDEO_PAUSE", VIDEO_END:"VIDEO_END", VIDEO_TIMEUPDATE:"VIDEO_TIMEUPDATE", VOLUME_CHANGE:"VOLUME_CHANGE", ENTER_FULLSCREEN:"ENTER_FULLSCREEN", EXIT_FULLSCREEN:"EXIT_FULLSCREEN", VIDEO_CLICK:"VIDEO_CLICK", ERROR:"ERROR", CONTROLS_PAUSE:"imp_controls_pause"};
vdb.html5.ads.modules.vast.event = {};
vdb.html5.ads.modules.vast.event.AdHonestyErrorEvent = vdb.events.Event.extend(function() {
    return{};
}());
(function(def) {
    def.UNIQUE_ERROR = "UNIQUE_ERROR";
})(vdb.html5.ads.modules.vast.event.AdHonestyErrorEvent);
vdb.html5.ads.modules.vast.event.VastEngineEvent = {};
(function(def) {
    def.COMPLETE = "VASTAdEngineComplete";
    def.IMPRESSION = "VASTAdImpression";
    def.AD_REQUESTED = "VASTAdRequested";
    def.AD_STARTING = "VASTAdStarting";
    def.AD_STARTED = "VASTAdStarted";
    def.AD_PAUSED = "VASTAdPaused";
    def.AD_VOLUME_CHANGED = "VASTAdVolumeChanged";
    def.AD_TIMEUPDATE = "VASTAdTimeUpdate";
    def.AD_WAITING = "VASTAdWaiting";
    def.AD_RESUMED = "VASTAdResumed";
    def.CONTENT_PAUSE_REQUESTED = "VASTContentPauseRequested";
    def.AD_ERROR = "VASTAdError";
    def.AD_FINISHED = "VASTAdFinished";
    def.AD_FORCE_FINISHED = "VASTAdFinishedForce";
    def.AD_INTERACTION = "VASTAdInteraction";
    def.AD_LOADING = "VASTAdLoading";
    def.AD_LOADED = "VASTAdLoaded";
    def.COMPANION_DIED = "VASTCompanionAdDied";
    def.COMPANION_STARTED = "VASTCompanionAdStarted";
})(vdb.html5.ads.modules.vast.event.VastEngineEvent);
vdb.html5.ads.modules.vast.event.VastEvent = vdb.events.Event.extend(function() {
    var init = function(type, creative, clickThrough, data) {
        this._super(type, data);
        this._targetCreative = creative;
        this._clickThrough = clickThrough;
        this.eventRecords = [];
    };
    var setChildEvent = function(childEvent) {
        childEvent.isRootEvent = false;
        this._childEvent = childEvent;
    };
    var getTargetCreative = function() {
        return this._targetCreative || null;
    };
    var getClickThrough = function() {
        return this._clickThrough || null;
    };
    var getChildEvent = function() {
        return this._childEvent || null;
    };
    var clone = function() {
        return new vdb.html5.ads.modules.vast.event.VastEvent(this.type, this._targetCreative, this._clickThrough, this.data);
    };
    return{eventRecords:null, isRootEvent:true, init:init, setChildEvent:setChildEvent, getTargetCreative:getTargetCreative, getClickThrough:getClickThrough, getChildEvent:getChildEvent, clone:clone, toString:function() {
        return "VastEvent{type=" + this.type + ", recordCount=" + this.eventRecords.length + "}";
    }};
}());
(function(def) {
    def.ATTEMPT = "VastEventAttempt";
    def.IMPRESSION = "VastEventImpression";
    def.CLICK = "VastEventClick";
    def.ERROR = "VastEventError";
})(vdb.html5.ads.modules.vast.event.VastEvent);
vdb.html5.ads.modules.vast.event.CompanionShowEvent = {};
(function(def) {
    vdb.html5.ads.modules.vast.event.CompanionShowEvent = vdb.html5.ads.modules.vast.event.VastEvent.extend(function() {
        var LOGGER = vdb.log.getLogger("CompanionShowEvent");
        var init = function(creative, childEvent) {
            LOGGER.debug("init", creative, "childEvent", childEvent);
            this._super(def.CompanionShowEvent.COMPANION_SHOW, creative);
            if (childEvent instanceof def.CompanionShowEvent) {
                this.companionCreatives = childEvent.companionCreatives.slice(0);
            } else {
                this.companionCreatives = [];
            }
        };
        var clone = function() {
            LOGGER.debug("clone");
            return new def.CompanionShowEvent(this._targetCreative, this);
        };
        return{companionCreatives:null, init:init, clone:clone};
    }());
    def.CompanionShowEvent.COMPANION_SHOW = "VASTEventCompanionShow";
})(vdb.html5.ads.modules.vast.event);
vdb.html5.ads.modules.vast.event.CompanionTrackingEvent = {};
(function(def) {
    vdb.html5.ads.modules.vast.event.CompanionTrackingEvent = vdb.html5.ads.modules.vast.event.VastEvent.extend(function() {
        var LOGGER = vdb.log.getLogger("CompanionTrackingEvent");
        var init = function(type, creative, companion) {
            LOGGER.debug("init", type, creative, companion);
            this._super(def.CompanionTrackingEvent.COMPANION_TRACKING, creative, null);
            this.trackingType = type;
            this.companion = companion;
        };
        var clone = function() {
            LOGGER.debug("clone");
            return new def.CompanionTrackingEvent(this.trackingType, this._targetCreative, this.companion);
        };
        return{trackingType:null, companion:null, init:init, clone:clone};
    }());
    def.CompanionTrackingEvent.COMPANION_TRACKING = "VASTEventCompanionTracking";
})(vdb.html5.ads.modules.vast.event);
vdb.html5.ads.modules.vast.event.handler = {};
vdb.html5.ads.modules.vast.event.handler.VastEventHandler = vdb.core.Class.extend(function() {
    return{onVastEvent:null};
}());
vdb.html5.ads.modules.vast.event.VideoTrackingEvent = {};
(function(def) {
    vdb.html5.ads.modules.vast.event.VideoTrackingEvent = vdb.html5.ads.modules.vast.event.VastEvent.extend(function() {
        var init = function(type, creative, data) {
            this._super(def.VideoTrackingEvent.VIDEO_TRACKING, creative, null);
            this.trackingType = type;
            this.data = data || {};
        };
        var clone = function() {
            return new def.VideoTrackingEvent(this.trackingType, this._targetCreative, this.data);
        };
        return{trackingType:null, data:null, init:init, clone:clone, toString:function() {
            return "VideoTrackingEvent{trackingType=" + this.trackingType + ", recordCount=" + this.eventRecords.length + "}";
        }};
    }());
    def.VideoTrackingEvent.VIDEO_TRACKING = "VASTEventVideoTracking";
})(vdb.html5.ads.modules.vast.event);
vdb.html5.ads.modules.vast.moat = {};
vdb.html5.ads.modules.vast.moat.VastMoatTracker = vdb.reporting.moat.BaseTracker.extend(function() {
    var AdEvent = vdb.events.AdEvent;
    var EventContext = vdb.events.EventContext;
    var _bindTrackers = function() {
        this._super();
        this._isPaused = false;
        EventContext.bind(this._eventBus, AdEvent.AD_VOLUME_CHANGED, this._onVolumeChange.bind(this)).link(this._eventContext);
        EventContext.bind(this._eventBus, AdEvent.AD_FINISHED, this._onEnd.bind(this)).link(this._eventContext);
        EventContext.bind(this._eventBus, AdEvent.AD_PAUSED, this._onPaused.bind(this)).link(this._eventContext);
        EventContext.bind(this._eventBus, AdEvent.AD_RESUMED, this._onPlay.bind(this)).link(this._eventContext);
        EventContext.bind(this._eventBus, AdEvent.AD_QUARTILE, _onQuartile.bind(this)).link(this._eventContext);
    };
    var _onQuartile = function(adEvent) {
        this._sendQuartile(adEvent.data.adStage);
    };
    return{init:function(partnerCode, getIds, container, eventBus, environment) {
        this._eventBus = eventBus;
        this._super(partnerCode, getIds, this._eventBus, AdEvent.AD_STARTED, container, environment);
    }, _bindTrackers:_bindTrackers};
}());
vdb.html5.ads.modules.vast.model = {};
vdb.html5.ads.modules.vast.model.AbstractCreative = vdb.core.Class.extend(function() {
    return{id:"", sequence:null, adID:"", trackingEvents:[], init:function() {
        this.trackingEvents = [];
    }, toString:function() {
        return "AbstractCreative{id:" + this.id + ",sequence:" + this.sequence + ",adID:" + this.adID + ",trackingEvents:[" + this.trackingEvents + "]}";
    }};
}());
vdb.html5.ads.modules.vast.model.AbstractExpandableResource = vdb.core.Class.extend(function() {
    return{width:null, height:null, id:"", expandedWidth:null, expandedHeight:null, apiFramework:"", resources:[], clickThroughUrl:null, clickTrackingUrl:null, parameters:null, init:function() {
        this.resources = [];
    }, toString:function() {
        return "AbstractExpandableResource{width:" + this.width + ",height:" + this.height + ",id:" + this.id + ",expandedWidth:" + this.expandedWidth + ",expandedHeight:" + this.expandedHeight + ",apiFramework:" + this.apiFramework + ",resources:[" + this.resources + "],clickThroughUrl:" + this.clickThroughUrl + ",clickTrackingUrl:" + this.clickTrackingUrl + ",parameters:" + this.parameters + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.AdParameters = vdb.core.Class.extend(function() {
    return{value:"", xmlEncoded:false, toString:function() {
        return "AdParameters{value:" + this.value + ",xmlEncoded:" + this.xmlEncoded + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.AdSystem = vdb.core.Class.extend(function() {
    return{version:"", name:"", toString:function() {
        return "AdSystem{version:" + this.version + ",name:" + this.name + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.CompanionCreative = vdb.html5.ads.modules.vast.model.AbstractCreative.extend(function() {
    return{required:null, companions:[], init:function() {
        this._super();
        this.companions = [];
    }, toString:function() {
        return "CompanionCreative(" + this._super() + "){required:" + this.required + ",companions:[" + this.companions + "]}";
    }};
}());
vdb.html5.ads.modules.vast.model.Companion = vdb.html5.ads.modules.vast.model.AbstractExpandableResource.extend(function() {
    return{assetWidth:null, assetHeight:null, adSlotID:"", altText:"", trackingEvents:[], init:function() {
        this._super();
        this.trackingEvents = [];
    }, toString:function() {
        return "Companion(" + this._super() + "){assetWidth:" + this.assetWidth + ",assetHeight:" + this.assetHeight + ",adSlotID:" + this.adSlotID + ",altText:" + this.altText + ",trackingEvents:[" + this.trackingEvents + "]}";
    }};
}());
vdb.html5.ads.modules.vast.model.CompanionsRequired = vdb.core.Class.extend(function() {
    return{init:function(value) {
        this.value = value + "";
    }, toString:function() {
        return "CompanionsRequired{" + this.value + "}";
    }};
}());
(function(def) {
    def.ALL = new def("ALL");
    def.ANY = new def("ANY");
    def.NONE = new def("NONE");
})(vdb.html5.ads.modules.vast.model.CompanionsRequired);
vdb.html5.ads.modules.vast.model.ConcatPixels = vdb.core.Class.extend(function() {
    return{attempts:[], impressions:[], errors:[], extensions:[], init:function() {
        this.creatives = [{trackingEvents:[], clickTrackings:[]}];
    }};
}());
vdb.html5.ads.modules.vast.model.CustomVastEvents = {AD_LOADED_TIMEOUT:"ad_loaded_timeout", AD_STARTED_TIMEOUT:"ad_started_timeout", BREAK_LOADED_TIMEOUT:"break_loaded_timeout", VIEWABLE:"iab_viewable", VIEWABLE_DETECTION_STARTED:"iab_detection_started", VIEWABLE_DETECTION_FAILED:"iab_detection_failed", CLICK_TROUGH:"clickThru", COMPANION_DISPLAY:"companionDisplay", COMPANION_CLICK:"companionClick", LOADED:"loaded", STOPPED:"stopped", LINEAR_CHANGE:"linearChange"};
vdb.html5.ads.modules.vast.model.DeliveryType = vdb.core.Class.extend(function() {
    return{init:function(type) {
        this.type = type + "";
    }, toString:function() {
        return "DeliveryType{" + this.type + "}";
    }};
}());
(function(def) {
    def.STREAMING = new def("STREAMING");
    def.PROGRESSIVE = new def("PROGRESSIVE");
})(vdb.html5.ads.modules.vast.model.DeliveryType);
vdb.html5.ads.modules.vast.model.ExtensionType = {SCRIPT:"adaptv_scripts", INVENTORY_ATTRIBUTES:"one_video_inventory_attributes", TIMEOUT_BEACON:"adaptv_timeout_beacons", IAB_VIEWABLE_BEACON:"adaptv_iab_viewable_beacons", CUSTOM_BEACONS:"one_video_custom_tracking_beacons", AD_CHROMES:"ad_chromes", CAPTIONS:"vidible_captions", THREE_SIXTY_AD:"vidible_360", LEAVE_BEHIND:"o2Player_leaveBehind", ADAPTV_ERROR:"adaptv_error", ONE_VIDEO_FEACONS:"one_video_feacons"};
vdb.html5.ads.modules.vast.model.Ad360 = vdb.core.Class.extend(function() {
    return{init:function(ad360Node) {
        this.type = ad360Node.getAttribute("type");
    }, prepare:function(ad) {
        ad.config360 = {projectionType:this.type || "Equirectangular"};
    }};
}());
vdb.html5.ads.modules.vast.model.AdViewabilityTracker = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("AdViewabilityTracker");
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    return{init:function(ad, creative, adSystem) {
        LOGGER.debug("init");
        adSystem.getInjector().resolve(vdb.enums.Dependencies.IAB).then(function(iab) {
            this.iab = iab;
            this.iab.setCallbacks(function() {
                ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(CustomVastEvents.VIEWABLE_DETECTION_STARTED, creative));
            }, function() {
                ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(CustomVastEvents.VIEWABLE, creative));
            }, function() {
                ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(CustomVastEvents.VIEWABLE_DETECTION_FAILED, creative));
            });
        }.bind(this));
    }, unbind:function() {
        if (this.iab) {
            this.iab.unbind();
        }
    }};
}());
vdb.html5.ads.modules.vast.model.Beacon = vdb.core.Class.extend(function() {
    return{type:"", value:"", init:function(beaconNode) {
        this.type = beaconNode.getAttribute("type");
        this.value = vdb.dom.text(beaconNode);
    }, prepare:function(eventContextGroup, adSystem) {
        this.eventContextGroup = eventContextGroup;
        this.adSystem = adSystem;
        this.macrosResolver = adSystem.getResolver();
    }, callPixel:function() {
        if (this.macrosResolver) {
            this.value = this.macrosResolver.resolve(this.value);
        }
        (new Image).src = this.value;
    }};
}());
vdb.html5.ads.modules.vast.model.Captions = vdb.core.Class.extend(function() {
    function setCaptionsJson(captions) {
        var i = -1;
        for (var len = captions.length;++i < len;) {
            var caption = captions[i];
            this.subtitles[caption.lang] = {"displayText":caption.displayText, "formats":caption.formats};
        }
    }
    var AdEvent = vdb.events.AdEvent;
    return{init:function(captions, injector) {
        this.subtitles = {};
        this._injector = injector;
        setCaptionsJson.call(this, captions);
    }, prepare:function() {
        var eventBus = this._injector.resolveSync(vdb.enums.Dependencies.EVENT_BUS);
        vdb.events.EventContext.bindOnce(eventBus, AdEvent.AD_STARTING, eventBus.dispatchEvent.bind(eventBus, new AdEvent(AdEvent.AD_SUBTITLES_FOUND, null, {"subtitles":this.subtitles})));
    }};
}());
vdb.html5.ads.modules.vast.model.CustomBeacon = vdb.html5.ads.modules.vast.model.Beacon.extend(function() {
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    var EventContext = vdb.events.EventContext;
    var attachEvent = function(obj, event) {
        this.eventContextGroup.addContext(EventContext.bind(obj, event, function(data) {
            var isCompanion = data._targetCreative.companions;
            if (isCompanion && this.type == CustomVastEvents.COMPANION_CLICK || !isCompanion && this.type == CustomVastEvents.CLICK_TROUGH) {
                this.callPixel();
            }
        }.bind(this)));
    };
    var attachEventOnce = function(obj, event) {
        this.eventContextGroup.addContext(EventContext.bindOnce(obj, event, function() {
            this.callPixel();
        }.bind(this)));
    };
    return{prepare:function(eventContextGroup, vastEngine) {
        this._super(eventContextGroup, vastEngine.adSystem);
        switch(this.type) {
            case CustomVastEvents.COMPANION_DISPLAY:
                attachEventOnce.call(this, vastEngine, vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPANION_STARTED);
                break;
            case CustomVastEvents.COMPANION_CLICK:
                ;
            case CustomVastEvents.CLICK_TROUGH:
                attachEvent.call(this, vastEngine.ad, vdb.html5.ads.modules.vast.event.VastEvent.CLICK);
                break;
        }
    }};
}());
vdb.html5.ads.modules.vast.model.InventoryAttribute = vdb.core.Class.extend(function() {
    var convertCamelCaseToLowerCaseUnderscore = function(attribute) {
        return attribute.match(/([A-Z]?[^A-Z]*)/g).slice(0, -1).join("_").toLowerCase();
    };
    return{type:"", value:"", init:function(attribute, value) {
        this.type = convertCamelCaseToLowerCaseUnderscore(attribute);
        this.value = vdb.dom.text(value);
    }};
}());
vdb.html5.ads.modules.vast.model.Script = vdb.core.Class.extend(function() {
    function injectScript() {
        if (this.resourceType == "url") {
            var macrosResolver = this.adSystem.getResolver();
            this.value = macrosResolver.resolve(this.value);
            vdb.dom.loadScript(this.value);
        } else {
            this._scriptElement = (new vdb.Dom(document)).injectCode(this.value);
        }
    }
    function cleanUp() {
        if (this._scriptElement && this._scriptElement.parentNode) {
            this._scriptElement.parentNode.removeChild(this._scriptElement);
        }
    }
    return{resourceType:"", event:"", value:"", init:function(scriptNode) {
        this.resourceType = scriptNode.getAttribute("resourceType");
        this.event = scriptNode.getAttribute("event");
        this.value = vdb.dom.text(scriptNode);
    }, prepare:function(eventContextGroup, ad, adContainer, adSystem) {
        this.adContainer = adContainer;
        this.adSystem = adSystem;
        eventContextGroup.addContext(vdb.events.EventContext.bind(adSystem, vdb.events.AdEvent.AD_FINISHED, cleanUp.bind(this)));
        if (this.event == vdb.enums.VastEvents.IMPRESSION) {
            eventContextGroup.addContext(vdb.events.EventContext.bind(ad, vdb.html5.ads.modules.vast.event.VastEvent.IMPRESSION, injectScript.bind(this)));
        } else {
            injectScript.call(this);
        }
    }};
}());
vdb.html5.ads.modules.vast.model.TimeoutBeacon = vdb.html5.ads.modules.vast.model.Beacon.extend(function() {
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    var AdEvent = vdb.events.AdEvent;
    var EventContext = vdb.events.EventContext;
    var DEFAULT_AD_LOADED_TIMEOUT = 5E3;
    var DEFAULT_AD_STARTED_TIMEOUT = 7E3;
    var DEFAULT_BREAK_LOADED_TIMEOUT = 3E4;
    var updateTimeout = function() {
        var inventoryAttributesExtension = getInventoryAttributesExtension.call(this);
        if (inventoryAttributesExtension) {
            this.timeout = inventoryAttributesExtension.inventoryAttributes[this.type];
        }
        if (!this.timeout) {
            switch(this.type) {
                case CustomVastEvents.AD_LOADED_TIMEOUT:
                    this.timeout = DEFAULT_AD_LOADED_TIMEOUT;
                    break;
                case CustomVastEvents.AD_STARTED_TIMEOUT:
                    this.timeout = DEFAULT_AD_STARTED_TIMEOUT;
                    break;
                case CustomVastEvents.BREAK_LOADED_TIMEOUT:
                    this.timeout = DEFAULT_BREAK_LOADED_TIMEOUT;
                    break;
            }
        }
    };
    var getInventoryAttributesExtension = function() {
        var i = 0;
        for (var len = this.ad.extensions.length;i < len;i++) {
            if (this.ad.extensions[i].type == vdb.html5.ads.modules.vast.model.ExtensionType.INVENTORY_ATTRIBUTES) {
                return this.ad.extensions[i];
            }
        }
    };
    var attachEvents = function(startEvent, endEvent) {
        this.eventContextGroup.addContext(EventContext.bind(this.adSystem, startEvent, function() {
            startBeaconTimer.call(this);
            this.eventContextGroup.addContext(EventContext.bindOnce(this.adSystem, endEvent, stopBeaconTimer.bind(this)));
            this.eventContextGroup.addContext(EventContext.bind(this.adSystem, AdEvent.AD_FINISHED, stopBeaconTimer.bind(this)));
        }.bind(this)));
    };
    var startBeaconTimer = function() {
        clearTimeout(this.beaconTime);
        this.beaconTime = setTimeout(function() {
            this.callPixel();
        }.bind(this), this.timeout);
    };
    var stopBeaconTimer = function() {
        clearTimeout(this.beaconTime);
    };
    return{timeout:null, prepare:function(eventContextGroup, ad, adContainer, adSystem) {
        this.ad = ad;
        this.adContainer = adContainer;
        this._super(eventContextGroup, adSystem);
        updateTimeout.call(this);
        switch(this.type) {
            case CustomVastEvents.AD_LOADED:
                attachEvents.call(this, AdEvent.AD_LOADED, AdEvent.AD_STARTED);
                break;
            case CustomVastEvents.AD_STARTED:
                attachEvents.call(this, AdEvent.AD_STARTED, AdEvent.AD_TIMEUPDATE);
                break;
            case CustomVastEvents.BREAK_LOADED:
                attachEvents.call(this, AdEvent.AD_ENGINE_RUN, AdEvent.AD_STARTED);
                break;
        }
    }};
}());
vdb.html5.ads.modules.vast.model.ViewabilityBeacon = vdb.html5.ads.modules.vast.model.Beacon.extend(function() {
    var LOGGER = vdb.log.getLogger("ViewabilityBeacon");
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    var isBeaconType = function(item) {
        return this.type == item.type;
    };
    var loadViewabilityBeaconScript = function(beaconType) {
        LOGGER.debug("loadViewabilityBeaconScript", beaconType);
        var beacon = this.viewabilityBeacons.filter(isBeaconType, {type:beaconType})[0];
        beacon.prepare(this.eventContextGroup, this.adSystem);
        beacon.callPixel();
    };
    return{init:function(eventContextGroup, viewabilityBeacons, adSystem) {
        LOGGER.debug("init");
        this.eventContextGroup = eventContextGroup;
        this.viewabilityBeacons = viewabilityBeacons;
        this.adSystem = adSystem;
        adSystem.getInjector().resolve(vdb.enums.Dependencies.IAB).then(function(iab) {
            this.iab = iab;
            this.iab.setCallbacks(function() {
                loadViewabilityBeaconScript.call(this, CustomVastEvents.VIEWABLE_DETECTION_STARTED);
            }.bind(this), function() {
                loadViewabilityBeaconScript.call(this, CustomVastEvents.VIEWABLE);
            }.bind(this), function() {
                loadViewabilityBeaconScript.call(this, CustomVastEvents.VIEWABLE_DETECTION_FAILED);
            }.bind(this));
        }.bind(this));
    }, unbind:function() {
        this.iab && this.iab.unbind();
    }};
}());
vdb.html5.ads.modules.vast.model.Extension = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("VastExtension");
    var prepareScripts = function() {
        var i = 0;
        for (var len = this.scripts.length;i < len;i++) {
            this.scripts[i].prepare(this.eventContextGroup, this.ad, this.adContainer, this.adSystem);
        }
    };
    var prepareTimeoutBeacons = function() {
        var i = 0;
        for (var len = this.timeoutBeacons.length;i < len;i++) {
            this.timeoutBeacons[i].prepare(this.eventContextGroup, this.ad, this.adContainer, this.adSystem);
        }
    };
    var prepareCustomBeacons = function() {
        var i = 0;
        for (var len = this.customBeacons.length;i < len;i++) {
            this.customBeacons[i].prepare(this.eventContextGroup, this.vastEngine);
        }
    };
    var prepareViewabilityBeacons = function() {
        this.viewabilityBeacon = new vdb.html5.ads.modules.vast.model.ViewabilityBeacon(this.eventContextGroup, this.viewabilityBeacons, this.adSystem);
    };
    var prepareAdChromes = function() {
        var i = 0;
        for (var len = this.adChromes.length;i < len;i++) {
            this.adChromes[i].prepare(this.adSystem);
        }
    };
    var prepareCaptions = function() {
        var captions = new vdb.html5.ads.modules.vast.model.Captions(this.captions, this.adSystem.getInjector());
        captions.prepare();
    };
    var prepare360Ad = function() {
        this.ad360.prepare(this.ad);
    };
    var prepareLeaveBehind = function() {
        if (this.leaveBehind) {
            this.leaveBehind.prepare(this.adSystem, this.eventContextGroup);
        }
    };
    var prepareFeacons = function() {
        var i = 0;
        for (var len = this.feacons.length;i < len;i++) {
            this.feacons[i].prepare(this.adSystem);
        }
    };
    var unbindEvents = function() {
        LOGGER.debug("unbindEvents");
        this.eventContextGroup && this.eventContextGroup.unbind();
        this.eventContextGroup = null;
        this.viewabilityBeacon && this.viewabilityBeacon.unbind();
        this.viewabilityBeacon = null;
    };
    return{type:null, inventoryAttributes:{}, scripts:[], timeoutBeacons:[], customBeacons:[], viewabilityBeacons:[], adChromes:[], captions:[], leaveBehind:null, feacons:[], prepare:function(vastEngine) {
        LOGGER.debug("prepare", this.type);
        this.eventContextGroup = new vdb.events.EventContextBindGroup;
        this.vastEngine = vastEngine;
        this.adSystem = vastEngine.adSystem;
        this.adContainer = vastEngine.getAdContainer();
        this.ad = vastEngine.ad;
        switch(this.type) {
            case vdb.html5.ads.modules.vast.model.ExtensionType.SCRIPT:
                prepareScripts.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.TIMEOUT_BEACON:
                prepareTimeoutBeacons.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.IAB_VIEWABLE_BEACON:
                prepareViewabilityBeacons.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.CUSTOM_BEACONS:
                prepareCustomBeacons.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.AD_CHROMES:
                prepareAdChromes.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.CAPTIONS:
                prepareCaptions.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.THREE_SIXTY_AD:
                prepare360Ad.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.LEAVE_BEHIND:
                prepareLeaveBehind.call(this);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.ONE_VIDEO_FEACONS:
                prepareFeacons.call(this);
        }
        vdb.events.EventContext.bindOnce(this.adSystem, vdb.events.AdEvent.AD_FINISHED, unbindEvents.bind(this));
    }};
}());
vdb.html5.ads.modules.vast.model.Icon = vdb.core.Class.extend(function() {
    return{width:null, height:null, xPosition:"", yPosition:"", offset:null, duration:null, staticResourceUrl:"", clickThrough:"", viewTracking:"", clickTracking:"", toString:function() {
        return "Icon{width:" + this.width + ",height:" + this.height + ",xPosition:" + this.xPosition + ",yPosition:" + this.yPosition + ",offset:" + this.offset + ",duration:" + this.duration + ",staticResourceUrl:" + this.staticResourceUrl + ",iconClickThrough:" + this.clickThrough + ",iconViewTracking:" + this.viewTracking + ",iconClickTracking:" + this.clickTracking + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.LinearCreative = vdb.html5.ads.modules.vast.model.AbstractCreative.extend(function() {
    return{duration:null, skippable:false, skipOffsetTime:null, skipOffsetPercent:null, parameters:null, clickThroughUrl:null, clickTrackings:[], customClickUrl:null, mediaFiles:[], icons:[], init:function() {
        this._super();
        this.clickTrackings = [];
        this.mediaFiles = [];
        this.icons = [];
    }, toString:function() {
        return "LinearCreative(" + this._super() + "){duration:" + this.duration + ",skippable:" + this.skippable + ",skipOffsetTime:" + this.skipOffsetTime + ",skipOffsetPercent:" + this.skipOffsetPercent + ",parameters:" + this.parameters + ",clickThroughUrl:" + this.clickThroughUrl + ",clickTrackings:[" + this.clickTrackings + "],customClickUrl:" + this.customClickUrl + ",mediaFiles:[" + this.mediaFiles + ",icons:[" + this.icons + "]}";
    }};
}());
vdb.html5.ads.modules.vast.model.AbstractAd = vdb.EventBus.extend(function() {
    var LOGGER = vdb.log.getLogger("AbstractAd");
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    var pushToEventRecords = function(event, arr) {
        var i = -1;
        var len = arr.length;
        for (var url;++i < len;) {
            url = arr[i];
            if (url.url) {
                event.eventRecords.push(url.url);
            }
        }
    };
    var getCreativeOfType = function(parentCreative) {
        var i = -1;
        var len = this.creatives.length;
        for (var creative;++i < len;) {
            creative = this.creatives[i];
            if (creative.__proto__ === parentCreative.__proto__) {
                return creative;
            }
        }
    };
    var readyToFire = function(event, tracking) {
        var offsetString = tracking.offset || "";
        offsetString = vdb.utils.StringUtils.trim(offsetString);
        if (!event || event.trackingType !== vdb.enums.VastEvents.PROGRESS || !offsetString) {
            return true;
        }
        var progressState = event.data || {};
        if (!progressState.duration) {
            return false;
        }
        var time = 0;
        var percent = 0;
        if (offsetString.indexOf("%") == -1) {
            time = vdb.Utils.timeToSec(offsetString);
        } else {
            percent = Number(offsetString.substr(0, offsetString.length - 1));
            time = progressState.duration * percent / 100;
        }
        var result = progressState.currentTime >= time && this._trackedProgress.indexOf(tracking) == -1;
        if (result) {
            this._trackedProgress.push(tracking);
        }
        return result;
    };
    var pushEventRecordsUrls = function(creative, eventRecords, trackingType, event) {
        if (!creative || !creative.trackingEvents) {
            return;
        }
        for (var i = 0;i < creative.trackingEvents.length;i++) {
            var trackingUrl = creative.trackingEvents[i];
            if (trackingUrl.type == trackingType && trackingUrl.url && readyToFire.call(this, event, trackingUrl)) {
                var eventRecord = trackingUrl.url;
                if (!hasCbMacro(trackingUrl.url)) {
                    eventRecord += (trackingUrl.url.indexOf("?") > -1 ? "&" : "?") + "cb=" + Math.random().toString(10).substr(2);
                }
                eventRecords.push(eventRecord);
            }
        }
    };
    var hasCbMacro = function(url) {
        var cbMacro = vdb.enums.ReportingMacros.CACHE_BUSTER;
        for (var k in cbMacro) {
            if (cbMacro.hasOwnProperty(k) && url.indexOf(cbMacro[k]) !== -1) {
                return true;
            }
        }
        return false;
    };
    return{id:"", adSystem:null, attempts:[], impressions:[], errors:[], creatives:[], extensions:[], isWrapper:false, sequenceNumber:null, state:{loaded:false}, init:function() {
        this._super();
        this._trackedProgress = [];
        this.attempts = [];
        this.impressions = [];
        this.errors = [];
        this.creatives = [];
        this.extensions = [];
    }, dispatchEvent:function(event) {
        LOGGER.debug("dispatchEvent", event);
        var parentCreative = event.getTargetCreative();
        var creative = event.isRootEvent ? parentCreative : !vdb.Utils.isEmpty(parentCreative) && getCreativeOfType.call(this, parentCreative);
        var trackingUrl;
        var cr;
        var i;
        var len;
        switch(event.type) {
            case vdb.html5.ads.modules.vast.event.VastEvent.ATTEMPT:
                pushToEventRecords(event, this.attempts);
                break;
            case vdb.html5.ads.modules.vast.event.VastEvent.IMPRESSION:
                pushToEventRecords(event, this.impressions);
                break;
            case vdb.html5.ads.modules.vast.event.VastEvent.ERROR:
                pushToEventRecords(event, this.errors);
                break;
            case vdb.html5.ads.modules.vast.event.VastEvent.CLICK:
                if (creative instanceof vdb.html5.ads.modules.vast.model.LinearCreative) {
                    i = -1;
                    for (len = creative.clickTrackings.length;++i < len;) {
                        var idUrl = creative.clickTrackings[i];
                        if (idUrl.url) {
                            event.eventRecords.push(idUrl.url);
                        }
                    }
                    if (creative.trackingEvents) {
                        for (var j in creative.trackingEvents) {
                            var trackingEvent = creative.trackingEvents[j];
                            if (trackingEvent["type"] == vdb.html5.ads.modules.vast.model.CustomVastEvents.CLICK_TROUGH && trackingEvent["url"]) {
                                event.eventRecords.push(trackingEvent["url"]);
                            }
                        }
                    }
                } else {
                    if (creative && creative.companions) {
                        pushEventRecordsUrls.call(this, creative, event.eventRecords, CustomVastEvents.COMPANION_CLICK);
                    }
                }
                break;
            case vdb.html5.ads.modules.vast.event.VideoTrackingEvent.VIDEO_TRACKING:
                pushEventRecordsUrls.call(this, creative, event.eventRecords, event.trackingType, event);
                break;
            case vdb.html5.ads.modules.vast.event.CompanionShowEvent.COMPANION_SHOW:
                i = -1;
                for (len = this.creatives.length;++i < len;) {
                    cr = this.creatives[i];
                    if (cr instanceof vdb.html5.ads.modules.vast.model.CompanionCreative) {
                        event.companionCreatives.push(cr);
                    }
                }
                break;
            case vdb.html5.ads.modules.vast.event.CompanionTrackingEvent.COMPANION_TRACKING:
                if (!creative) {
                    return;
                }
                var trEvs = event.companion.trackingEvents;
                i = -1;
                for (len = trEvs.length;++i < len;) {
                    trackingUrl = trEvs[i];
                    if (trackingUrl.type == event.trackingType && trackingUrl.url) {
                        event.eventRecords.push(trackingUrl.url);
                    }
                }
                break;
            case CustomVastEvents.LOADED:
                this.state.loaded = true;
            case CustomVastEvents.VIEWABLE_DETECTION_STARTED:
                ;
            case CustomVastEvents.VIEWABLE:
                ;
            case CustomVastEvents.VIEWABLE_DETECTION_FAILED:
                ;
            case CustomVastEvents.COMPANION_DISPLAY:
                ;
            case CustomVastEvents.STOPPED:
                ;
            case CustomVastEvents.LINEAR_CHANGE:
                pushEventRecordsUrls.call(this, creative, event.eventRecords, event.type);
                break;
        }
        return this._super(event);
    }, toString:function() {
        return "AbstractAd{id:" + this.id + ",adSystem:" + this.adSystem + ",attempts:[" + this.attempts + "]" + ",impressions:[" + this.impressions + "],errors:[" + this.errors + "],creatives:[" + this.creatives + "],extensions:[" + this.extensions + "]}";
    }};
}());
vdb.html5.ads.modules.vast.model.InLineAd = vdb.html5.ads.modules.vast.model.AbstractAd.extend(function() {
    return{title:"", description:"", advertiser:"", surveyUri:null, init:function() {
        this._super();
    }, toString:function() {
        return "InLineAd(" + this._super() + "){title:" + this.title + ",description:" + this.description + ",advertiser:" + this.advertiser + ",surveyUri:" + this.surveyUri + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.NonLinearCreative = vdb.html5.ads.modules.vast.model.AbstractCreative.extend(function() {
    return{nonLinears:[], init:function() {
        this._super();
        this.nonLinears = [];
    }, toString:function() {
        return "NonLinearCreative(" + this._super() + "){nonLinears:[" + this.nonLinears + "]}";
    }};
}());
vdb.html5.ads.modules.vast.model.NonLinear = vdb.html5.ads.modules.vast.model.AbstractExpandableResource.extend(function() {
    return{scalable:true, maintainAspectRatio:true, minSuggestedDuration:null, toString:function() {
        return "NonLinear(" + this._super() + "){scalable:" + this.scalable + ",maintainAspectRatio:" + this.maintainAspectRatio + ",minSuggestedDuration:" + this.minSuggestedDuration + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.ResourceType = vdb.core.Class.extend(function() {
    return{init:function(type) {
        this.type = type;
    }, toString:function() {
        return "ResourceType{" + this.type + "}";
    }};
}());
(function(def) {
    def.STATIC = new def("STATIC");
    def.IFRAME = new def("IFRAME");
    def.HTML = new def("HTML");
})(vdb.html5.ads.modules.vast.model.ResourceType);
vdb.html5.ads.modules.vast.model.Resource = vdb.core.Class.extend(function() {
    return{type:null, mimeType:"", value:"", toString:function() {
        return "Resource{type:" + this.type + ",mimeType:" + this.mimeType + ",value:" + this.value + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.SimpleUrl = vdb.core.Class.extend(function() {
    return{url:"", init:function(url) {
        this.url = url;
    }, toString:function() {
        return "SimpleUrl{url:" + this.url + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.IdUrl = vdb.html5.ads.modules.vast.model.SimpleUrl.extend(function() {
    return{id:"", init:function(url, id) {
        this._super(url);
        this.id = id;
    }, toString:function() {
        return "IdUrl(" + this._super() + "){id:" + this.id + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.MediaFile = vdb.html5.ads.modules.vast.model.IdUrl.extend(function() {
    return{delivery:null, mimeType:"", width:null, height:null, codec:"", bitrate:null, minBitrate:null, maxBitrate:null, scalable:true, maintainAspectRatio:true, apiFramework:"", init:function(url, id) {
        this._super(url, id);
    }, toString:function() {
        return "MediaFile(" + this._super() + "){delivery:" + this.delivery + ",mimeType:" + this.mimeType + ",width:" + this.width + ",height:" + this.height + ",codec:" + this.codec + ",bitrate:" + this.bitrate + ",minBitrate:" + this.minBitrate + ",maxBitrate:" + this.maxBitrate + ",scalable:" + this.scalable + ",maintainAspectRatio:" + this.maintainAspectRatio + ",apiFramework:" + this.apiFramework + "}";
    }};
}());
(function(def) {
    def.FLASH_MIME_TYPE = "application/x-shockwave-flash";
    def.JS_MIME_TYPE = "application/javascript";
    def.JSX_MIME_TYPE = "application/x-javascript";
    def.UPLYNK_HLS_MIME_TYPE = "uplynk/m3u8";
    def.FLV_VIDEO = "video/x-flv";
})(vdb.html5.ads.modules.vast.model.MediaFile);
vdb.html5.ads.modules.vast.LinearResolver = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("LinearResolver");
    var MediaFile = vdb.html5.ads.modules.vast.model.MediaFile;
    var init = function(flashDetector) {
        this._flashDetector = flashDetector;
    };
    var isSupported = function(mimeType) {
        return vdb.utils.Common.isSupported(mimeType) || mimeType === MediaFile.JS_MIME_TYPE || mimeType === MediaFile.JSX_MIME_TYPE || mimeType === MediaFile.FLASH_MIME_TYPE && this._flashDetector.isFlashAvailable() || mimeType === MediaFile.UPLYNK_HLS_MIME_TYPE || mimeType === MediaFile.FLV_VIDEO && this._flashDetector.isFlashAvailable();
    };
    var rtmpFilter = function(mf) {
        var url = mf ? mf.url : "";
        url = url && vdb.utils.StringUtils.trim(url);
        return url && !vdb.utils.StringUtils.startsWith(url, "rtmp", true);
    };
    var resolveMediaFiles = function(width, height, mediaFiles) {
        var supported = mediaFiles.filter(function(mf) {
            if (vdb.utils.StringUtils.endsWith(mf.url, "m3u8")) {
                return false;
            }
            return isSupported.call(this, mf.mimeType);
        }.bind(this));
        supported = supported.filter(rtmpFilter);
        supported = sortByQuality(supported);
        var types = decomposeByType(supported);
        var mediaFile = findMediaFile(types.video, width, height);
        if (mediaFile == null) {
            var noVideo = types.js.length ? types.js : types.flash;
            mediaFile = findMediaFile(noVideo, width, height);
        }
        if (mediaFile == null && mediaFiles.length > 0) {
            LOGGER.warn("None of the provided mime-types is supported", mediaFiles);
        }
        return mediaFile;
    };
    var decomposeByType = function(mediaFiles) {
        var mf;
        var types = {video:[], js:[], flash:[]};
        for (var i = 0;i < mediaFiles.length;i++) {
            mf = mediaFiles[i];
            if (mf.mimeType === MediaFile.FLV_VIDEO || mf.mimeType === MediaFile.FLASH_MIME_TYPE) {
                types.flash.push(mf);
            } else {
                if (mf.mimeType === MediaFile.JS_MIME_TYPE || mf.mimeType === MediaFile.JSX_MIME_TYPE) {
                    types.js.push(mf);
                } else {
                    types.video.push(mf);
                }
            }
        }
        return types;
    };
    var sortByQuality = function(files) {
        var sorted = files.slice();
        return sorted.sort(function(a, b) {
            var q1 = a.width * a.height - (+a.bitrate || 0) || 0;
            var q2 = b.width * b.height - (+b.bitrate || 0) || 0;
            return q1 < q2 ? 1 : -1;
        });
    };
    var findMediaFile = function(mediaFiles, width, height) {
        var mf;
        var mediaFile = null;
        var noScalableMediaFile = null;
        var closestSizeMediaFile = null;
        if (mediaFiles.length) {
            var maxSize = mediaFiles[0];
            for (var i = mediaFiles.length - 1;i >= 0;i--) {
                mf = mediaFiles[i];
                if (!mf.scalable && mf.width <= width && mf.height <= height) {
                    noScalableMediaFile = mf;
                }
                if (mf.width >= width && mf.height >= height) {
                    closestSizeMediaFile = mf;
                    break;
                }
            }
            mediaFile = noScalableMediaFile || closestSizeMediaFile || maxSize;
        }
        return mediaFile;
    };
    return{init:init, resolveMediaFiles:resolveMediaFiles};
}());
vdb.html5.ads.modules.vast.model.Tracking = vdb.html5.ads.modules.vast.model.SimpleUrl.extend(function() {
    return{type:"", offset:"", init:function(url, type, offset) {
        this._super(url);
        this.type = type;
        this.offset = offset;
    }, toString:function() {
        return "Tracking(" + this._super() + "){type:" + this.type + "}";
    }};
}());
(function(def) {
    def.CREATIVE_VIEW = "creativeView";
    def.START = "start";
    def.MIDPOINT = "midpoint";
    def.FIRST_QUARTILE = "firstQuartile";
    def.THIRD_QUARTILE = "thirdQuartile";
    def.COMPLETE = "complete";
    def.MUTE = "mute";
    def.UNMUTE = "unmute";
    def.PAUSE = "pause";
    def.REWIND = "rewind";
    def.RESUME = "resume";
    def.FULLSCREEN = "fullscreen";
    def.EXPAND = "expand";
    def.COLLAPSE = "collapse";
    def.ACCEPT_INVITATION = "acceptInvitation";
    def.CLOSE = "close";
    def.PROGRESS = "progress";
})(vdb.html5.ads.modules.vast.model.Tracking);
vdb.html5.ads.modules.vast.model.VastRoot = vdb.core.Class.extend(function() {
    return{error:null, init:function() {
        this.ads = [];
    }, toString:function() {
        return "VastRoot{error:" + this.error + ",ads:[" + this.ads.join(",") + "]}";
    }, getFailoverModel:function(adPodAllowed) {
        if ((this.supportFailOver || adPodAllowed) && this.ads.length > 0) {
            return this;
        }
        if (this.parent) {
            return this.parent.getFailoverModel(adPodAllowed);
        }
        return null;
    }, getParentAds:function(parentModel) {
        var model = this;
        for (var ads = [];true;) {
            if (model.parentAd) {
                ads.push(model.parentAd);
            }
            if (model.parent == parentModel) {
                return ads;
            } else {
                if (!model.parent) {
                    return[];
                }
                model = model.parent;
            }
        }
    }};
}());
vdb.html5.ads.modules.vast.model.VersionUrl = vdb.html5.ads.modules.vast.model.SimpleUrl.extend(function() {
    return{version:"", init:function(url, version) {
        this._super(url);
        this.version = version;
    }, toString:function() {
        return "VersionUrl(" + this._super() + "){version:" + this.version + "}";
    }};
}());
vdb.html5.ads.modules.vast.model.WrapperAd = vdb.html5.ads.modules.vast.model.AbstractAd.extend(function() {
    var _onVastEvent = function(event) {
        var clonedEvent = event.clone();
        event.setChildEvent(clonedEvent);
        this.dispatchEvent(clonedEvent);
    };
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    var VastEvent = vdb.html5.ads.modules.vast.event.VastEvent;
    var eventsFromChildAd = [VastEvent.ATTEMPT, VastEvent.IMPRESSION, VastEvent.CLICK, vdb.html5.ads.modules.vast.event.VideoTrackingEvent.VIDEO_TRACKING, vdb.html5.ads.modules.vast.event.CompanionTrackingEvent.COMPANION_TRACKING, vdb.html5.ads.modules.vast.event.CompanionShowEvent.COMPANION_SHOW, CustomVastEvents.VIEWABLE_DETECTION_STARTED, CustomVastEvents.VIEWABLE, CustomVastEvents.VIEWABLE_DETECTION_FAILED, CustomVastEvents.COMPANION_DISPLAY, CustomVastEvents.LOADED, CustomVastEvents.STOPPED, CustomVastEvents.LINEAR_CHANGE];
    return{childVASTUrl:null, init:function() {
        this._super();
        this.isWrapper = true;
    }, attachChildEvents:function(vastModel) {
        var vastEventListener = _onVastEvent.bind(this);
        var i = -1;
        var len = vastModel.ads.length;
        for (var ad;++i < len;) {
            ad = vastModel.ads[i];
            for (var j = 0;j < eventsFromChildAd.length;j++) {
                ad.addEventListener(eventsFromChildAd[j], vastEventListener);
            }
        }
    }, propagateNodes:function(vastModel, parentVastModel) {
        var i = -1;
        for (var ad;++i < vastModel.ads.length;) {
            ad = vastModel.ads[i];
            if (parentVastModel.extensions) {
                ad.extensions = (ad.extensions || []).concat(parentVastModel.extensions);
            }
            for (var j = 0;j < ad.creatives.length;j++) {
                var innerCreative = ad.creatives[j];
                if (innerCreative.icons && innerCreative.icons.length == 0 && parentVastModel.creatives.length > 0 && parentVastModel.creatives[0] instanceof vdb.html5.ads.modules.vast.model.LinearCreative) {
                    var outerCreative = parentVastModel.creatives[0];
                    innerCreative.icons = innerCreative.icons.concat(outerCreative.icons);
                }
            }
        }
    }, dispatchErrorEvent:function(eventHandler, error) {
        if (this._errorSent) {
            return;
        }
        this._errorSent = true;
        var VASTEvent = vdb.html5.ads.modules.vast.event.VastEvent;
        var attemptEvent = new VASTEvent(VASTEvent.ATTEMPT);
        this.dispatchEvent(attemptEvent);
        eventHandler.onVastEvent(attemptEvent);
        var errorEvent = new VASTEvent(VASTEvent.ERROR, null, null, {error:error});
        this.dispatchEvent(errorEvent);
        eventHandler.onVastEvent(errorEvent);
    }, toString:function() {
        return "WrapperAd(" + this._super() + "){childVASTUrl:" + this.childVASTUrl + "}";
    }};
}());
vdb.html5.ads.modules.vast.NonLinearResolver = vdb.core.Class.extend(function() {
    function _supportsMimeType(mimeType) {
        for (var i = 0;i < MIME_TYPES_SUPPORTED.length;i++) {
            if ((new RegExp(MIME_TYPES_SUPPORTED[i])).test(mimeType)) {
                return true;
            }
        }
        return false;
    }
    function _resolveByMimeType(nonLinears, includeTypes) {
        includeTypes = includeTypes || [];
        var result = [];
        var alwaysSupport = [];
        if (includeTypes.indexOf(vdb.html5.ads.modules.vast.model.ResourceType.STATIC) < 0) {
            includeTypes.push(vdb.html5.ads.modules.vast.model.ResourceType.STATIC);
        }
        for (var i = 0;i < nonLinears.length;i++) {
            var nonLinear = nonLinears[i];
            var res = nonLinear.resources[0];
            LOGGER.debug("resolveByMimeType", "Found supported resource", res);
            if (includeTypes.indexOf(res.type) >= 0) {
                switch(res.type) {
                    case vdb.html5.ads.modules.vast.model.ResourceType.STATIC:
                        if (_supportsMimeType(res.mimeType)) {
                            alwaysSupport.push(nonLinear);
                        }
                        break;
                    case vdb.html5.ads.modules.vast.model.ResourceType.IFRAME:
                        result.push(nonLinear);
                        break;
                    case vdb.html5.ads.modules.vast.model.ResourceType.HTML:
                        result.push(nonLinear);
                        break;
                }
            }
        }
        return result.concat(alwaysSupport);
    }
    var LOGGER = vdb.log.getLogger("NonLinearResolver");
    var MediaFile = vdb.html5.ads.modules.vast.model.MediaFile;
    var MIME_TYPES_SUPPORTED = ["image/.*", MediaFile.FLASH_MIME_TYPE, MediaFile.JS_MIME_TYPE, MediaFile.JSX_MIME_TYPE];
    var resolve = function(slot, nonLinears, includeTypes) {
        nonLinears = vdb.Utils.sortBySize(nonLinears.slice(), false);
        LOGGER.debug("resolve", slot, nonLinears, includeTypes);
        var supported = _resolveByMimeType(nonLinears, includeTypes);
        LOGGER.debug("resolve", "supported", supported);
        for (var i = 0;i < supported.length;i++) {
            var nl = supported[i];
            if (nl.scalable || nl.width <= slot.width && nl.height <= slot.height) {
                return nl;
            }
        }
        LOGGER.info("No resources resolved");
        return null;
    };
    return{resolve:resolve};
}());
vdb.html5.ads.modules.vast.params = {};
vdb.html5.ads.modules.vast.params.AdVendorParams = vdb.core.Class.extend(function() {
    return{parse:function(ad) {
        this.adImpressionId = ad.id;
    }};
}());
(function(def) {
    def.create = function(configEntry) {
        switch(configEntry.getVendor()) {
            case vdb.html5.ads.modules.vast.params.CollectiveAdVendorParams.VENDOR_ID:
                return new vdb.html5.ads.modules.vast.params.CollectiveAdVendorParams;
            default:
                return new def;
        }
    };
})(vdb.html5.ads.modules.vast.params.AdVendorParams);
vdb.html5.ads.modules.vast.params.CollectiveAdVendorParams = vdb.html5.ads.modules.vast.params.AdVendorParams.extend(function() {
    return{parse:function(ad) {
        var creative = ad.creatives[0];
        var trackingSetup = creative.trackingEvents[0];
        if (trackingSetup.type == vdb.enums.VastEvents.START) {
            var url = trackingSetup.url;
            this.adPlacementId = /cid=(\d+)/.exec(url)[1];
            this.advertiserId = /src=(\d+)/.exec(url)[1];
        }
        this.adImpressionId = ad.id;
    }};
}());
(function(def) {
    def.VENDOR_ID = "collective";
})(vdb.html5.ads.modules.vast.params.CollectiveAdVendorParams);
vdb.html5.ads.modules.vast.parser = {};
vdb.html5.ads.modules.vast.parser.dom = {};
(function(dom) {
    dom.immediateChildrenByNames = function(node) {
        var result = {};
        var children = node.childNodes;
        for (var i = 0;i < children.length;i++) {
            var e = children[i];
            var name = e.nodeName;
            if (e.nodeType === 1) {
                if (!result[name]) {
                    result[name] = e;
                }
            }
        }
        return result;
    };
    dom.immediateChildByName = function(node, name) {
        var children = node.childNodes;
        for (var i = 0;i < children.length;i++) {
            var e = children[i];
            if (e.nodeType === 1 && e.nodeName == name) {
                return e;
            }
        }
        return null;
    };
    dom.allImmediateChildrenByNames = function(node, filter) {
        var result = {};
        var children = node.childNodes;
        for (var i = 0;i < children.length;i++) {
            var e = children[i];
            var name = e.nodeName;
            if (e.nodeType === 1) {
                if (filter && filter.length > 0 && filter.indexOf(name) < 0) {
                    continue;
                }
                if (!result[name]) {
                    result[name] = [];
                }
                result[name].push(e);
            }
        }
        return result;
    };
    dom.hasSimpleContent = function(node) {
        if (!node) {
            return false;
        }
        if (node.nodeType === 3 || node.nodeType === 2) {
            return true;
        }
        if (node.hasChildNodes()) {
            return!node.firstElementChild;
        }
        return false;
    };
})(vdb.html5.ads.modules.vast.parser.dom);
vdb.html5.ads.modules.vast.model.AdChrome = vdb.core.Class.extend(function() {
    var ADAPTV_AD_PARTNER_CODE = "aolonebuyervideoflashint2012897410256";
    var VIEWMODE = "normal";
    var getIds = function() {
        return{"level1":this["orgId"], "level2":this["campaignId"], "level3":this["adId"], "level4":this["marketplaceId"], "slicer1":this["pageUrl"], "zMoatParams":this["params"], "partnerCode":ADAPTV_AD_PARTNER_CODE, "viewMode":VIEWMODE};
    };
    return{"orgId":"", "campaignId":"", "adId":"", "marketplaceId":"", "pageUrl":"", "params":"", init:function(adChromeNode) {
        var adChromeAttributes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(adChromeNode);
        for (var attribute in adChromeAttributes) {
            this[attribute] = vdb.dom.text(adChromeAttributes[attribute][0]);
        }
    }, prepare:function(adSystem) {
        if (this["params"]) {
            var macrosResolver = adSystem.getResolver();
            this["params"] = macrosResolver.resolve(this["params"]);
        }
        var container = adSystem.getInjector().resolveSync(vdb.enums.Dependencies.ROOT_CONTAINER);
        var environment = adSystem.getInjector().resolveSync(vdb.enums.Dependencies.ENVIRONMENT);
        (new vdb.html5.ads.modules.vast.moat.VastMoatTracker(ADAPTV_AD_PARTNER_CODE, getIds.bind(this), container, adSystem, environment)).singleRun(true);
    }};
}());
vdb.html5.ads.modules.vast.model.Caption = vdb.core.Class.extend(function() {
    var setFormats = function(captionNode) {
        var formats = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(captionNode)["Format"] || [];
        var i = -1;
        for (var len = formats.length;++i < len;) {
            this.formats[formats[i].getAttribute("type")] = vdb.dom.text(formats[i]);
        }
    };
    return{lang:"", displayText:"", init:function(captionNode) {
        this.lang = captionNode.getAttribute("lang");
        this.displayText = captionNode.getAttribute("displayText");
        this.formats = {};
        setFormats.call(this, captionNode);
    }};
}());
vdb.html5.ads.modules.vast.model.Feacons = vdb.core.Class.extend(function() {
    return{init:function(node) {
        this.feacons = [];
        for (var i = 0;i < node.length;i++) {
            var feaconNodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node[i])["Feacon"] || [];
            for (var j = 0;j < feaconNodes.length;j++) {
                this.feacons.push(vdb.dom.text(feaconNodes[j]));
            }
        }
    }, prepare:function(adSystem, isRoot) {
        this.adSystem = adSystem;
        if (isRoot) {
            vdb.events.EventContext.group(vdb.events.EventContext.bindOnce(this.adSystem, vdb.events.AdEvent.AD_BLOCKER_REQUEST, this.adBlockerRequestHandler.bind(this)), vdb.events.EventContext.bindOnce(this.adSystem, vdb.events.AdEvent.AD_BLOCKER_COMPLETE, this.adBlockerRequestHandler.bind(this)));
        } else {
            this.adBlockerRequestHandler();
        }
    }, adBlockerRequestHandler:function() {
        this.macrosResolver = this.adSystem.getResolver();
        for (var i = 0;i < this.feacons.length;++i) {
            (new Image).src = this.macrosResolver.resolve(this.feacons[i]);
        }
    }};
}());
vdb.html5.ads.modules.vast.parser.elem = {};
vdb.html5.ads.modules.vast.parser.elem.AbstractElementParser = vdb.core.Class.extend(function() {
    return{init:function(tag) {
        this._tag = tag;
        this._contentParsers = {};
    }, addContentParsers:function(parsersArr) {
        for (var i = 0;i < parsersArr.length;i++) {
            this._addContentParser(parsersArr[i]);
        }
    }, _addContentParser:function(parser) {
        this._contentParsers[parser.getTag()] = parser;
    }, getContentParser:function(tag) {
        return this._contentParsers[tag];
    }, parse:function(node) {
        if (!this.shouldParse || !this.shouldParse(node)) {
            return null;
        }
        return this.parseImpl(node);
    }, getTag:function() {
        return this._tag;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractElementParser.extend(function() {
    return{init:function(tag, contentParsers) {
        this._super(tag);
        if (contentParsers && contentParsers.length > 0) {
            this.addContentParsers(contentParsers);
        }
    }, shouldParse:function(node) {
        return node && node.nodeName == this.getTag() && node.hasChildNodes() && node.firstElementChild;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.AbstractSimpleElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractElementParser.extend(function() {
    return{shouldParse:function(node) {
        return node && node.nodeName === this.getTag() && vdb.html5.ads.modules.vast.parser.dom.hasSimpleContent(node);
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.AdParametersElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractSimpleElementParser.extend(function() {
    return{init:function() {
        this._super("AdParameters");
    }, parseImpl:function(node) {
        var adParameters = new vdb.html5.ads.modules.vast.model.AdParameters;
        adParameters.value = vdb.dom.text(node);
        adParameters.xmlEncoded = node.getAttribute("xmlEncoded");
        return adParameters;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.AdParametersElementParser.INSTANCE = new vdb.html5.ads.modules.vast.parser.elem.AdParametersElementParser;
vdb.html5.ads.modules.vast.parser.elem.AdSystemParser = vdb.html5.ads.modules.vast.parser.elem.AbstractSimpleElementParser.extend(function() {
    return{init:function() {
        this._super("AdSystem");
    }, parseImpl:function(node) {
        var adSystem = new vdb.html5.ads.modules.vast.model.AdSystem;
        adSystem.version = node.getAttribute("version");
        adSystem.name = vdb.dom.text(node);
        return adSystem;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.ExtensionElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    var getScripts = function(scriptNodes) {
        var scripts = [];
        var i = 0;
        for (var len = scriptNodes.length;i < len;i++) {
            scripts.push(new vdb.html5.ads.modules.vast.model.Script(scriptNodes[i]));
        }
        return scripts;
    };
    var getTimeoutBeacons = function(beaconNodes) {
        var timeoutBeacons = [];
        var i = 0;
        for (var len = beaconNodes.length;i < len;i++) {
            timeoutBeacons.push(new vdb.html5.ads.modules.vast.model.TimeoutBeacon(beaconNodes[i]));
        }
        return timeoutBeacons;
    };
    var getViewabilityBeacons = function(beaconNodes) {
        var viewabilityBeacons = [];
        var i = 0;
        for (var len = beaconNodes.length;i < len;i++) {
            viewabilityBeacons.push(new vdb.html5.ads.modules.vast.model.Beacon(beaconNodes[i]));
        }
        return viewabilityBeacons;
    };
    var getCustomBeacons = function(beaconNodes) {
        var customBeacons = [];
        var i = 0;
        for (var len = beaconNodes.length;i < len;i++) {
            customBeacons.push(new vdb.html5.ads.modules.vast.model.CustomBeacon(beaconNodes[i]));
        }
        return customBeacons;
    };
    var getInventoryAttributes = function(inventoryAttributesObject) {
        var inventoryAttributes = {};
        for (var attribute in inventoryAttributesObject) {
            var inventoryAttribute = new vdb.html5.ads.modules.vast.model.InventoryAttribute(attribute, inventoryAttributesObject[attribute][0]);
            inventoryAttributes[inventoryAttribute.type] = inventoryAttribute.value;
        }
        return inventoryAttributes;
    };
    var getAdChromes = function(adChromesNode) {
        var adChromes = [];
        var adChromesNodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(adChromesNode)["AdChrome"] || [];
        for (var i = 0;i < adChromesNodes.length;i++) {
            switch(adChromesNodes[i].getAttribute("type")) {
                case "MoatChrome":
                    adChromes.push(new vdb.html5.ads.modules.vast.model.AdChrome(adChromesNodes[i]));
                    break;
            }
        }
        return adChromes;
    };
    var getCaptions = function(captionNodes) {
        var captions = [];
        var i = 0;
        for (var len = captionNodes.length;i < len;i++) {
            captions.push(new vdb.html5.ads.modules.vast.model.Caption(captionNodes[i]));
        }
        return captions;
    };
    var getAd360 = function(ad360Node) {
        return new vdb.html5.ads.modules.vast.model.Ad360(ad360Node);
    };
    return{init:function() {
        this._super("Extension");
    }, parseImpl:function(node) {
        var extension = new vdb.html5.ads.modules.vast.model.Extension;
        var extensionType = extension.type = node.getAttribute("type");
        var children = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node);
        switch(extensionType) {
            case vdb.html5.ads.modules.vast.model.ExtensionType.SCRIPT:
                var scripts = children["Script"] || [];
                extension.scripts = getScripts(scripts);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.INVENTORY_ATTRIBUTES:
                var inventoryAttributes = children || {};
                extension.inventoryAttributes = getInventoryAttributes(inventoryAttributes);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.TIMEOUT_BEACON:
                var beacons = children["Beacon"] || [];
                extension.timeoutBeacons = getTimeoutBeacons(beacons);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.IAB_VIEWABLE_BEACON:
                beacons = children["Beacon"] || [];
                extension.viewabilityBeacons = getViewabilityBeacons(beacons);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.CUSTOM_BEACONS:
                beacons = children["Beacon"] || [];
                extension.customBeacons = getCustomBeacons(beacons);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.AD_CHROMES:
                var adChromesNode = children["AdChromes"][0] || [];
                extension.adChromes = getAdChromes(adChromesNode);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.LEAVE_BEHIND:
                var leaveBehindNode = new vdb.html5.ads.modules.vast.model.LeaveBehind(node);
                extension.leaveBehind = leaveBehindNode;
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.CAPTIONS:
                var captions = children["Caption"] || [];
                extension.captions = getCaptions(captions);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.THREE_SIXTY_AD:
                var ad360Node = children["Projection"][0] || [];
                extension.ad360 = getAd360(ad360Node);
                break;
            case vdb.html5.ads.modules.vast.model.ExtensionType.ONE_VIDEO_FEACONS:
                extension.feacons.push(new vdb.html5.ads.modules.vast.model.Feacons(children["Feacons"]));
                break;
        }
        return extension;
    }, shouldParse:function(node) {
        return node && node.nodeName == this.getTag();
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.IconElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function() {
        this._super("Icon");
    }, parseImpl:function(node) {
        var icon = new vdb.html5.ads.modules.vast.model.Icon;
        icon.width = +node.getAttribute("width") || 0;
        icon.height = +node.getAttribute("height") || 0;
        icon.xPosition = +node.getAttribute("xPosition") || node.getAttribute("xPosition");
        icon.yPosition = +node.getAttribute("yPosition") || node.getAttribute("yPosition");
        icon.offset = vdb.Utils.timeToSec(node.getAttribute("offset") || "");
        icon.duration = vdb.Utils.timeToSec(node.getAttribute("duration") || "");
        var children = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node) || {};
        var iconClicks = children["IconClicks"][0];
        var iconClicksChildren = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(iconClicks);
        var clickThrough = iconClicksChildren["IconClickThrough"] && iconClicksChildren["IconClickThrough"][0];
        var clickTracking = iconClicksChildren["IconClickTracking"] && iconClicksChildren["IconClickTracking"][0];
        if (children["StaticResource"] && children["StaticResource"][0]) {
            icon.staticResourceUrl = vdb.dom.text(children["StaticResource"][0]).trim();
        }
        if (children["IconViewTracking"] && children["IconViewTracking"][0]) {
            icon.viewTracking = vdb.dom.text(children["IconViewTracking"][0]).trim();
        }
        if (clickThrough) {
            icon.clickThrough = vdb.dom.text(clickThrough).trim();
        }
        if (clickTracking) {
            icon.clickTracking = vdb.dom.text(clickTracking).trim();
        }
        return icon;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.IconElementParser.INSTANCE = new vdb.html5.ads.modules.vast.parser.elem.IconElementParser;
vdb.html5.ads.modules.vast.parser.elem.ResourceElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractSimpleElementParser.extend(function() {
    return{init:function(tag, resourceType) {
        this._super(tag);
        this._resourceType = resourceType;
    }, parseImpl:function(node) {
        var res = new vdb.html5.ads.modules.vast.model.Resource;
        res.type = this._resourceType;
        res.value = vdb.dom.text(node);
        res.mimeType = node.getAttribute("creativeType");
        return res;
    }};
}());
(function(def, resType) {
    def.STATIC_PARSER = new def("StaticResource", resType.STATIC);
    def.IFRAME_PARSER = new def("IFrameResource", resType.IFRAME);
    def.HTML_PARSER = new def("HTMLResource", resType.HTML);
})(vdb.html5.ads.modules.vast.parser.elem.ResourceElementParser, vdb.html5.ads.modules.vast.model.ResourceType);
vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser = vdb.html5.ads.modules.vast.parser.elem.AbstractSimpleElementParser.extend(function() {
    return{parseImpl:function(node) {
        var url = this.createUrl();
        url.url = vdb.utils.StringUtils.trim(vdb.dom.text(node));
        return url;
    }, createUrl:function() {
        return new vdb.html5.ads.modules.vast.model.SimpleUrl;
    }};
}());
(function(def) {
    def.SURVEY_PARSER = new def("Survey");
    def.ATTEMPT_PARSER = new def("Attempt");
    def.IMPRESSION_PARSER = new def("Impression");
    def.ERROR_PARSER = new def("Error");
    def.VASTADTAGURI_PARSER = new def("VASTAdTagURI");
    def.COMPANION_CLICKTHROUGH_PARSER = new def("CompanionClickThrough");
    def.NONLINEAR_CLICKTHROUGH_PARSER = new def("NonLinearClickThrough");
})(vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser);
vdb.html5.ads.modules.vast.parser.elem.IdUrlParser = vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.extend(function() {
    return{parseImpl:function(node) {
        var url = this._super(node);
        url.id = node.getAttribute("id");
        return url;
    }, createUrl:function() {
        return new vdb.html5.ads.modules.vast.model.IdUrl;
    }};
}());
(function(def) {
    def.CLICKTHROUGH_PARSER = new def("ClickThrough");
    def.CLICKTRACKING_PARSER = new def("ClickTracking");
    def.CUSTOMCLICK_PARSER = new def("CustomClick");
    def.COMPANION_CLICKTRACKING_PARSER = new def("CompanionClickTracking");
    def.NONLINEAR_CLICKTRACKING_PARSER = new def("NonLinearClickTracking");
})(vdb.html5.ads.modules.vast.parser.elem.IdUrlParser);
vdb.html5.ads.modules.vast.parser.elem.MediaFileElementParser = vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.extend(function() {
    return{init:function() {
        this._super("MediaFile");
    }, parseImpl:function(node) {
        var mediaFile = this._super(node);
        switch(String(node.getAttribute("delivery"))) {
            case "streaming":
                mediaFile.delivery = vdb.html5.ads.modules.vast.model.DeliveryType.STREAMING;
                break;
            case "progressive":
                mediaFile.delivery = vdb.html5.ads.modules.vast.model.DeliveryType.PROGRESSIVE;
                break;
            default:
                break;
        }
        var height = node.getAttribute("height");
        mediaFile.height = isNaN(height) ? 0 : height;
        var width = node.getAttribute("width");
        mediaFile.width = isNaN(width) ? 0 : width;
        mediaFile.codec = node.getAttribute("codec");
        mediaFile.bitrate = node.getAttribute("bitrate");
        mediaFile.minBitrate = node.getAttribute("minBitrate");
        mediaFile.maxBitrate = node.getAttribute("maxBitrate");
        var scalable = node.getAttribute("scalable");
        mediaFile.scalable = scalable ? scalable === "true" || parseInt(scalable) > 0 : true;
        mediaFile.maintainAspectRatio = node.getAttribute("maintainAspectRatio") === "true";
        mediaFile.mimeType = node.getAttribute("type");
        mediaFile.apiFramework = node.getAttribute("apiFramework");
        return mediaFile;
    }, createUrl:function() {
        return new vdb.html5.ads.modules.vast.model.MediaFile;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.MediaFileElementParser.INSTANCE = new vdb.html5.ads.modules.vast.parser.elem.MediaFileElementParser;
vdb.html5.ads.modules.vast.parser.elem.TrackingEventElementParser = vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.extend(function() {
    return{init:function() {
        this._super("Tracking");
    }, parseImpl:function(node) {
        var url = this._super(node);
        url.type = node.getAttribute("event");
        url.offset = node.getAttribute("offset");
        return url;
    }, createUrl:function() {
        return new vdb.html5.ads.modules.vast.model.Tracking;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.TrackingEventElementParser.INSTANCE = new vdb.html5.ads.modules.vast.parser.elem.TrackingEventElementParser;
vdb.html5.ads.modules.vast.parser.elem.AbstractExpandableResourceParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(tag, contentParsers) {
        this._super(tag, contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.ResourceElementParser.STATIC_PARSER, vdb.html5.ads.modules.vast.parser.elem.ResourceElementParser.IFRAME_PARSER, vdb.html5.ads.modules.vast.parser.elem.ResourceElementParser.HTML_PARSER, vdb.html5.ads.modules.vast.parser.elem.AdParametersElementParser.INSTANCE, vdb.html5.ads.modules.vast.parser.elem.TrackingEventElementParser.INSTANCE]);
        }
    }, parseImpl:function(node) {
        var er = this.createExpandableResource();
        er.height = node.getAttribute("height");
        er.width = node.getAttribute("width");
        er.id = node.getAttribute("id");
        var expandedWidth = node.getAttribute("expandedWidth");
        er.expandedWidth = isNaN(expandedWidth) ? 0 : expandedWidth;
        var expandedHeight = node.getAttribute("expandedHeight");
        er.expandedHeight = isNaN(expandedHeight) ? 0 : expandedHeight;
        er.apiFramework = node.getAttribute("apiFramework");
        var childrenByNames = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node);
        var resourceNodes = [childrenByNames["StaticResource"], childrenByNames["IFrameResource"], childrenByNames["HTMLResource"]];
        for (var i = 0;i < resourceNodes.length;i++) {
            var list = resourceNodes[i];
            if (list) {
                for (var j = 0;j < list.length;j++) {
                    var resourceNode = list[j];
                    var parser = this.getContentParser(resourceNode.nodeName);
                    er.resources.push(parser.parse(resourceNode));
                }
            }
        }
        var adParameters = childrenByNames["AdParameters"];
        if (adParameters) {
            er.parameters = this.getContentParser("AdParameters").parse(adParameters[0]);
        }
        var clickThroughNodes = childrenByNames[this.getClickThroughTag()];
        if (clickThroughNodes) {
            er.clickThroughUrl = this.getClickThroughElementParser().parse(clickThroughNodes[0]);
        }
        var clickTrackingNodes = childrenByNames[this.getClickTrackingTag()];
        if (clickTrackingNodes) {
            er.clickTrackingUrl = this.getClickTrackingElementParser().parse(clickTrackingNodes[0]);
        }
        return er;
    }, getClickThroughElementParser:function() {
        var clickThroughTag = this.getClickThroughTag();
        return this.getContentParser(clickThroughTag);
    }, getClickTrackingElementParser:function() {
        var clickTrackingTag = this.getClickTrackingTag();
        return this.getContentParser(clickTrackingTag);
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.CompanionElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractExpandableResourceParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("Companion", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.COMPANION_CLICKTHROUGH_PARSER, vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.COMPANION_CLICKTRACKING_PARSER]);
        }
    }, parseImpl:function(node) {
        var companion = this._super(node);
        companion.assetWidth = node.getAttribute("assetWidth");
        companion.assetHeight = node.getAttribute("assetHeight");
        companion.adSlotID = node.getAttribute("adSlotID");
        var children = vdb.html5.ads.modules.vast.parser.dom.immediateChildrenByNames(node);
        var altTextNode = children["AltText"];
        if (altTextNode) {
            companion.altText = vdb.dom.text(altTextNode);
        }
        var trackingEventsNode = children["TrackingEvents"];
        if (trackingEventsNode) {
            var trackingEventElementParser = this.getContentParser("Tracking");
            var trackingEventNodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(trackingEventsNode)["Tracking"] || [];
            for (var i = 0;i < trackingEventNodes.length;i++) {
                var trackingEventNode = trackingEventNodes[i];
                companion.trackingEvents.push(trackingEventElementParser.parse(trackingEventNode));
            }
        }
        return companion;
    }, createExpandableResource:function() {
        return new vdb.html5.ads.modules.vast.model.Companion;
    }, getClickThroughTag:function() {
        return vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.COMPANION_CLICKTHROUGH_PARSER.getTag();
    }, getClickTrackingTag:function() {
        return vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.COMPANION_CLICKTRACKING_PARSER.getTag();
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.CompanionElementParser.INSTANCE = new vdb.html5.ads.modules.vast.parser.elem.CompanionElementParser;
vdb.html5.ads.modules.vast.parser.elem.CompanionCreativeElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("CompanionAds", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.CompanionElementParser.INSTANCE]);
        }
    }, parseImpl:function(node) {
        var creative = new vdb.html5.ads.modules.vast.model.CompanionCreative;
        var required = node.getAttribute("required");
        if (required) {
            switch(String(required)) {
                case "all":
                    creative.required = vdb.html5.ads.modules.vast.model.CompanionsRequired.ALL;
                    break;
                case "any":
                    creative.required = vdb.html5.ads.modules.vast.model.CompanionsRequired.ANY;
                    break;
                case "none":
                    creative.required = vdb.html5.ads.modules.vast.model.CompanionsRequired.NONE;
                    break;
            }
        }
        var companionNodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node, ["Companion"])["Companion"];
        if (companionNodes) {
            var companionParser = this.getContentParser("Companion");
            for (var i = 0;i < companionNodes.length;i++) {
                var companion = companionParser.parse(companionNodes[i]);
                creative.companions.push(companion);
            }
        }
        return creative;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.LinearCreativeElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("Linear", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.TrackingEventElementParser.INSTANCE, vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.CLICKTHROUGH_PARSER, vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.CLICKTRACKING_PARSER, vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.CUSTOMCLICK_PARSER, vdb.html5.ads.modules.vast.parser.elem.MediaFileElementParser.INSTANCE, vdb.html5.ads.modules.vast.parser.elem.IconElementParser.INSTANCE, vdb.html5.ads.modules.vast.parser.elem.AdParametersElementParser.INSTANCE])
            ;
        }
    }, parseImpl:function(node) {
        var creative = new vdb.html5.ads.modules.vast.model.LinearCreative;
        var children = vdb.html5.ads.modules.vast.parser.dom.immediateChildrenByNames(node);
        var skipoffset = node.getAttribute("skipoffset");
        var i;
        if (skipoffset) {
            creative.skippable = true;
            if (skipoffset.slice(-1) == "%") {
                creative.skipOffsetPercent = Number(skipoffset.slice(0, -1));
            } else {
                creative.skipOffsetTime = skipoffset ? vdb.Utils.timeToSec(skipoffset) : NaN;
            }
        }
        var duration = vdb.dom.text(children["Duration"]);
        creative.duration = duration ? vdb.Utils.timeToSec(duration) : NaN;
        var adParameters = children["AdParameters"];
        if (adParameters) {
            creative.parameters = this.getContentParser("AdParameters").parse(adParameters);
        }
        var trackingEventsNode = children["TrackingEvents"];
        if (trackingEventsNode) {
            var trackingEventElementParser = this.getContentParser("Tracking");
            var trackingEventNodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(trackingEventsNode)["Tracking"] || [];
            for (i = 0;i < trackingEventNodes.length;i++) {
                var trackingEventNode = trackingEventNodes[i];
                creative.trackingEvents.push(trackingEventElementParser.parse(trackingEventNode));
            }
        }
        var videoClicksNode = children["VideoClicks"];
        if (videoClicksNode) {
            var videoClicksChildren = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(videoClicksNode);
            var clickThroughNodes = videoClicksChildren["ClickThrough"];
            if (clickThroughNodes) {
                var clickThroughNode = clickThroughNodes[0];
                if (clickThroughNode) {
                    creative.clickThroughUrl = this.getContentParser("ClickThrough").parse(clickThroughNode);
                }
            }
            var clickTrackingNodes = videoClicksChildren["ClickTracking"];
            if (clickTrackingNodes) {
                var clickTrackingElementParser = this.getContentParser("ClickTracking");
                for (i = 0;i < clickTrackingNodes.length;i++) {
                    var clickTrackingNode = clickTrackingNodes[i];
                    creative.clickTrackings.push(clickTrackingElementParser.parse(clickTrackingNode));
                }
            }
            var customClickNodes = videoClicksChildren["CustomClick"];
            if (customClickNodes) {
                var customClickNode = customClickNodes[0];
                if (customClickNode) {
                    creative.customClickUrl = this.getContentParser("CustomClick").parse(customClickNode);
                }
            }
        }
        var iconsNode = children["Icons"];
        if (iconsNode) {
            var iconsChildren = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(iconsNode);
            var iconNodes = iconsChildren["Icon"];
            if (iconNodes) {
                var iconElementParser = this.getContentParser("Icon");
                for (i = 0;i < iconNodes.length;i++) {
                    var iconNode = iconNodes[i];
                    creative.icons.push(iconElementParser.parse(iconNode, true));
                }
            }
        }
        var mediaFileElementParser = this.getContentParser("MediaFile");
        var mfs = children["MediaFiles"];
        var mfNodes = mfs && vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(mfs)["MediaFile"] || [];
        for (i = 0;i < mfNodes.length;i++) {
            var mfNode = mfNodes[i];
            var mf = mediaFileElementParser.parse(mfNode);
            if (mf) {
                creative.mediaFiles.push(mf);
            }
        }
        return creative;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.NonLinearElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractExpandableResourceParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("NonLinear", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.NONLINEAR_CLICKTHROUGH_PARSER, vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.NONLINEAR_CLICKTRACKING_PARSER]);
        }
    }, parseImpl:function(node) {
        var nonlinear = this._super(node);
        var scalable = node.getAttribute("scalable");
        nonlinear.scalable = scalable ? "true" == scalable || parseInt(scalable) > 0 : true;
        var maintainAspectRatio = node.getAttribute("maintainAspectRatio");
        nonlinear.maintainAspectRatio = maintainAspectRatio ? "true" == maintainAspectRatio || parseInt(maintainAspectRatio) > 0 : true;
        var minSuggestedDuration = node.getAttribute("minSuggestedDuration");
        nonlinear.minSuggestedDuration = minSuggestedDuration ? vdb.Utils.timeToSec(minSuggestedDuration) : NaN;
        return nonlinear;
    }, createExpandableResource:function() {
        return new vdb.html5.ads.modules.vast.model.NonLinear;
    }, getClickThroughTag:function() {
        return vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.NONLINEAR_CLICKTHROUGH_PARSER.getTag();
    }, getClickTrackingTag:function() {
        return vdb.html5.ads.modules.vast.parser.elem.IdUrlParser.NONLINEAR_CLICKTRACKING_PARSER.getTag();
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.NonLinearElementParser.INSTANCE = new vdb.html5.ads.modules.vast.parser.elem.NonLinearElementParser;
vdb.html5.ads.modules.vast.parser.elem.NonLinearCreativeElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("NonLinearAds", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.TrackingEventElementParser.INSTANCE, vdb.html5.ads.modules.vast.parser.elem.NonLinearElementParser.INSTANCE]);
        }
    }, parseImpl:function(node) {
        var creative = new vdb.html5.ads.modules.vast.model.NonLinearCreative;
        var children = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node);
        var nonlinearNodes = children["NonLinear"];
        var i;
        if (nonlinearNodes) {
            var nonlinearParser = this.getContentParser("NonLinear");
            for (i = 0;i < nonlinearNodes.length;i++) {
                var nonlinear = nonlinearParser.parse(nonlinearNodes[i]);
                creative.nonLinears.push(nonlinear);
            }
        }
        var trackingEventsNodes = children["TrackingEvents"];
        if (trackingEventsNodes) {
            var trackingEventsNode = trackingEventsNodes[0];
            var trackingEventElementParser = this.getContentParser("Tracking");
            var trackingEventNodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(trackingEventsNode)["Tracking"] || [];
            for (i = 0;i < trackingEventNodes.length;i++) {
                var trackingEventNode = trackingEventNodes[i];
                creative.trackingEvents.push(trackingEventElementParser.parse(trackingEventNode));
            }
        }
        return creative;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.CreativeElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("Creative", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([new vdb.html5.ads.modules.vast.parser.elem.LinearCreativeElementParser, new vdb.html5.ads.modules.vast.parser.elem.NonLinearCreativeElementParser, new vdb.html5.ads.modules.vast.parser.elem.CompanionCreativeElementParser]);
        }
    }, parseImpl:function(node) {
        var creative = null;
        var children = node.childNodes;
        for (var i = 0;i < children.length;i++) {
            var child = children[i];
            var parser = this.getContentParser(child.nodeName);
            if (parser) {
                creative = parser.parse(child);
                if (creative) {
                    creative.id = node.getAttribute("id");
                    var sequence = node.getAttribute("sequence");
                    creative.sequence = isNaN(sequence) ? 0 : sequence;
                    creative.adID = node.getAttribute("adID") || node.getAttribute("AdID");
                }
            }
        }
        return creative;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.AbstractAdChildElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    var getInnerNodesArray = function(nodes, nodeName) {
        var innerNodesArr = [];
        if (nodes) {
            var node = nodes[0];
            nodes = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node)[nodeName] || [];
            innerNodesArr = getNodesArray.call(this, nodes, nodeName);
        }
        return innerNodesArr;
    };
    var getNodesArray = function(nodes, nodeName) {
        var nodesArr = [];
        if (nodes) {
            var nodeParser = this.getContentParser(nodeName);
            var i = 0;
            for (var len = nodes.length;i < len;i++) {
                var node = nodes[i];
                var np = nodeParser.parse(node);
                if (np) {
                    nodesArr.push(np);
                }
            }
        }
        return nodesArr;
    };
    var moveCustomBeaconsTrackers = function(creatives) {
        var linearCreative = ejectCreative(creatives, vdb.html5.ads.modules.vast.model.LinearCreative);
        var companionCreative = ejectCreative(creatives, vdb.html5.ads.modules.vast.model.CompanionCreative);
        if (!linearCreative || !companionCreative) {
            return;
        }
        var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
        var eventListToMove = [CustomVastEvents.CLICK_TROUGH, CustomVastEvents.COMPANION_CLICK, CustomVastEvents.COMPANION_DISPLAY];
        var linearEvents = linearCreative.trackingEvents;
        var companionEvents = companionCreative.trackingEvents;
        for (var i in linearEvents) {
            var eventType = linearEvents[i]["type"];
            if (eventListToMove.indexOf(eventType) !== -1) {
                if (!isTrackingEventExists(companionEvents, eventType)) {
                    companionEvents.push(linearEvents[i]);
                }
            }
        }
    };
    var ejectCreative = function(creatives, creativeType) {
        var filtered = creatives.filter(function(cr) {
            return cr instanceof creativeType;
        });
        return filtered[0];
    };
    var isTrackingEventExists = function(trackingEvents, event) {
        for (var i in trackingEvents) {
            if (trackingEvents[i]["type"] == event) {
                return true;
            }
        }
        return false;
    };
    return{init:function(tag, contentParsers) {
        this._super(tag, contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([new vdb.html5.ads.modules.vast.parser.elem.AdSystemParser, vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.ATTEMPT_PARSER, vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.ERROR_PARSER, vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.IMPRESSION_PARSER, new vdb.html5.ads.modules.vast.parser.elem.CreativeElementParser, new vdb.html5.ads.modules.vast.parser.elem.ExtensionElementParser]);
        }
    }, parseImpl:function(node) {
        var ad = this.createAd();
        var children = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(node);
        ad.adSystem = this.getContentParser("AdSystem").parse(children["AdSystem"][0]);
        ad.attempts = getNodesArray.call(this, children["Attempt"], "Attempt");
        ad.impressions = getNodesArray.call(this, children["Impression"], "Impression");
        ad.errors = getNodesArray.call(this, children["Error"], "Error");
        ad.creatives = getInnerNodesArray.call(this, children["Creatives"], "Creative");
        ad.creatives.sort(function(c1, c2) {
            return c1.sequence - c2.sequence;
        });
        moveCustomBeaconsTrackers(ad.creatives);
        ad.extensions = getInnerNodesArray.call(this, children["Extensions"], "Extension");
        return ad;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.InLineElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractAdChildElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("InLine", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.SURVEY_PARSER]);
        }
    }, parseImpl:function(node) {
        var ad = this._super(node);
        var children = vdb.html5.ads.modules.vast.parser.dom.immediateChildrenByNames(node);
        ad.title = vdb.dom.text(children["AdTitle"]);
        ad.description = vdb.dom.text(children["Description"]);
        ad.advertiser = vdb.dom.text(children["Advertiser"]);
        ad.surveyUri = this.getContentParser("Survey").parse(children["Survey"]);
        return ad;
    }, createAd:function() {
        return new vdb.html5.ads.modules.vast.model.InLineAd;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.VastErrorElementParser = vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.extend(function() {
    return{init:function() {
        this._super("Error");
    }, parseImpl:function(node) {
        var model = this._super(node);
        model.version = node.getAttribute("version");
        return model;
    }, createUrl:function() {
        return new vdb.html5.ads.modules.vast.model.VersionUrl;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.WrapperElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractAdChildElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("Wrapper", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([vdb.html5.ads.modules.vast.parser.elem.SimpleUrlParser.VASTADTAGURI_PARSER]);
        }
    }, parseImpl:function(node) {
        var ad = this._super(node);
        var uriElem = vdb.html5.ads.modules.vast.parser.dom.immediateChildByName(node, "VASTAdTagURI");
        ad.childVASTUrl = this.getContentParser("VASTAdTagURI").parse(uriElem);
        return ad;
    }, createAd:function() {
        return new vdb.html5.ads.modules.vast.model.WrapperAd;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.AdElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(contentParsers) {
        this._super("Ad", contentParsers);
        if (!contentParsers || contentParsers.length == 0) {
            this.addContentParsers([new vdb.html5.ads.modules.vast.parser.elem.InLineElementParser, new vdb.html5.ads.modules.vast.parser.elem.WrapperElementParser]);
        }
    }, parseImpl:function(node) {
        var ad = null;
        var child = node.firstElementChild;
        var parser = this.getContentParser(child.nodeName);
        if (parser) {
            ad = parser.parse(child);
            ad.id = node.getAttribute("id");
            var sequence = node.getAttribute("sequence");
            if (sequence) {
                ad.sequence = +sequence;
            }
        }
        return ad;
    }};
}());
vdb.html5.ads.modules.vast.parser.elem.VastRootElementParser = vdb.html5.ads.modules.vast.parser.elem.AbstractComplexElementParser.extend(function() {
    return{init:function(adSystem) {
        this._adSystem = adSystem;
        this._super("VAST", [new vdb.html5.ads.modules.vast.parser.elem.AdElementParser, new vdb.html5.ads.modules.vast.parser.elem.VastErrorElementParser]);
    }, shouldParse:function() {
        return true;
    }, parseImpl:function(rootNode) {
        var model = new vdb.html5.ads.modules.vast.model.VastRoot;
        var children = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(rootNode);
        model.supportFailOver = rootNode.getAttribute("adaptvFailover") || false;
        var error = children["Error"];
        if (error) {
            var errorNode = error[0];
            var parser = this.getContentParser("Error");
            model.error = parser.parse(errorNode);
        }
        var extensions = children["Extensions"];
        if (extensions && this._adSystem) {
            for (var i = 0;i < extensions.length;++i) {
                var extention = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(extensions[i])["Extension"] || [];
                for (var j = 0;j < extention.length;++j) {
                    var type = extention[j] && extention[j].getAttribute("type") || "";
                    if (type == vdb.html5.ads.modules.vast.model.ExtensionType.ONE_VIDEO_FEACONS) {
                        var feaconsNode = vdb.html5.ads.modules.vast.parser.dom.allImmediateChildrenByNames(extention[j])["Feacons"];
                        var feacons = new vdb.html5.ads.modules.vast.model.Feacons(feaconsNode);
                        feacons.prepare(this._adSystem, true);
                    }
                }
            }
        }
        var adNodes = children["Ad"];
        if (adNodes) {
            var adParser = this.getContentParser("Ad");
            for (var y = 0;y < adNodes.length;y++) {
                var adNode = adNodes[y];
                var ad = adParser.parse(adNode);
                ad.sequenceNumber = y + 1;
                if (ad) {
                    model.ads.push(ad);
                }
            }
        }
        return model;
    }};
}());
vdb.html5.ads.modules.vast.utils = {};
vdb.html5.ads.modules.vast.utils.VastUtils = {getCreativesMediaExtensions:function(creatives) {
    var extensions = [];
    creatives = vdb.Utils.toCollection(creatives);
    for (var i = 0;i < creatives.length;i++) {
        var mediaFiles = creatives[i].mediaFiles || [];
        for (var j = 0;j < mediaFiles.length;j++) {
            var mediaFile = mediaFiles[j];
            extensions.push(vdb.html5.ads.modules.vast.utils.VastUtils.getMediaFileExtension(mediaFile));
        }
    }
    return extensions;
}, getMediaFileExtension:function(mediaFile) {
    mediaFile = mediaFile || {};
    var url = mediaFile.url || "";
    return vdb.Utils.getExtensionFromUrl(url) || mediaFile.mimeType;
}};
vdb.html5.ads.modules.vast.errorCodes = {VAST_PARSING:{code:100, description:"VAST parsing error"}, VAST_VERSION:{code:102, description:"VAST version not supported"}, DURATION_MISMATCH:{code:202, description:"Video player expecting different duration"}, GENERAL_WRAPPER_ERROR:{code:300, description:"General Wrapper error"}, WRAPPER_TIMEOUT:{code:301, description:"Timeout of VAST URI provided in Wrapper element, or of VAST URI provided in a subsequent Wrapper element. (URI was either unavailable or reached a timeout as defined by the video player.)"},
    WRAPPER_LIMIT:{code:302, description:"Wrapper limit reached, as defined by the video player. Too many Wrapper responses have been received with no InLine response."}, NO_ADS_AFTER_WRAPPER:{code:303, description:"No ads VAST response after one or more Wrappers. Also includes number of empty VAST responses from fallback."}, GENERAL_LINEAR_ERROR:{code:400, description:"General    Linear    error. Video player is unable to display the Linear Ad"}, FILE_NOT_FOUND:{code:401, description:"File not found. Unable to find Linear/MediaFile from URI"},
    MEDIA_FILE_URI_TIMEOUT:{code:402, description:"Timeout of MediaFile URI"}, NO_SUITABLE_CREATIVE:{code:403, description:"Couldn\u2019t find MediaFile that is supported by this video player, based on the attributes of the MediaFile element."}, MEDIA_FILE_DISPLAYING:{code:405, description:"Problem displaying MediaFile."}, UNDEFINED:{code:900, description:"Undefined error."}, GENERAL_VPAID_ERROR:{code:901, description:"General VPAID error."}};
vdb.html5.ads.AdEngineBase = vdb.html5.ads.AdEngine.extend(function() {
    var LOGGER = vdb.log.getLogger("AdEngineBase");
    var TrackEvent = vdb.events.TrackEvent;
    var AdStage = vdb.ads.AdStage;
    var Dependencies = vdb.enums.Dependencies;
    var _siteChecked = false;
    var _resolveDependencies = function() {
        var injector = this.adSystem.getInjector();
        this._impressionTracker = injector.resolveSync(Dependencies.PIXEL_TRACKER);
        this._display = injector.resolveSync(Dependencies.DISPLAY);
        this._config = injector.resolveSync(Dependencies.CONFIG);
    };
    var init = function(adSystem, adsConfig, adLoader) {
        LOGGER.debug("init", "adsConfig", adsConfig);
        this._super();
        this._siteCheckPassed = false;
        this.adSystem = adSystem;
        this._adsConfig = adsConfig;
        this._adLoader = adLoader;
        this._loaded = false;
        this._stageTracked = [];
        this._isPaused = false;
        _resolveDependencies.call(this);
        if (this._adLoader) {
            this._adLoader.addEventListener(vdb.html5.ads.AdLoader.COMPLETED, this.onLoaded.bind(this));
            this._adLoader.addEventListener(vdb.html5.ads.AdLoader.INTERRUPTED, this.onInterrupted.bind(this));
        }
    };
    var getAdConfigEntry = function() {
        return this._configEntry || null;
    };
    var getAdContainer = function() {
        return this._adContainer || null;
    };
    var getLastError = function() {
        return this._lastError || null;
    };
    var showOverlay = function() {
        LOGGER.debug("showOverlay");
        this._startTime = (new Date).getTime();
        this.trackFlow(AdStage.LOADED);
        return false;
    };
    var showLinearAd = function(maxTime) {
        LOGGER.debug("showLinearAd", "maxTime", maxTime);
        var adConfigTimeout = 9999999;
        if (this.getAdConfigEntry()) {
            adConfigTimeout = this.getAdConfigEntry().getStartTimeout();
        }
        var startTimeout = Math.min(adConfigTimeout, this._adsConfig.startTimeout);
        startTimeout = Math.floor(startTimeout * 1E3);
        _stopStartTimer.call(this);
        if (startTimeout > 0 && this._config.playsNativeInline()) {
            this._startTimer = setTimeout(this.failOver.bind(this, "Start timeout error: " + startTimeout + "ms"), startTimeout);
        }
        this._startTime = (new Date).getTime();
        this._maxTime = maxTime || 0;
        if (this._maxTime > 0) {
            this._forceStopTimer = new vdb.utils.Timer;
            this._forceStopTimer.schedule(function() {
                this._forceStop = true;
                this.stop();
            }.bind(this), this._maxTime * 1E3, false);
        }
    };
    var _stopStartTimer = function() {
        if (this._startTimer) {
            clearTimeout(this._startTimer);
        }
    };
    var load = function() {
        LOGGER.debug("load");
        this._siteCheckPassed = _checkSite.call(this);
        this._startLoadingTimemark = (new Date).getTime();
        if (this._siteCheckPassed) {
            _loadAfterSiteCheck.call(this);
        } else {
            this._loaded = false;
            var conf = this.getAdConfigEntry();
            this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_ENGINE_READY, conf ? conf.getType() : null));
        }
    };
    var _loadAfterSiteCheck = function() {
        this.track(TrackEvent.AD_ENGINE_REQUEST, {displayWidth:this._adContainer.offsetWidth, displayHeight:this._adContainer.offsetHeight});
        this._lastError = null;
        if (this._adLoader && this._adLoader.load) {
            this._adLoader.load();
        }
    };
    var _checkSite = function() {
        if (this._configEntry.isStrictSiteCheck()) {
            var mUrl = vdb.Utils.getDomain(this._config.getMacro(vdb.constants.PlayerMacros.URL));
            var site = vdb.Utils.getDomain(vdb.utils.WindowUtil.getTopMostLocation(window));
            if (mUrl && site && mUrl != site && mUrl != "undefined") {
                if (!_siteChecked) {
                    this.trackFlow(AdStage.SITE_MISMATCH);
                    this._lastError = new vdb.html5.ads.AdEngineError("Site check is not passed, required " + mUrl + ", but found " + site);
                    _siteChecked = true;
                }
                return false;
            }
        }
        return true;
    };
    var onLoaded = function(ad) {
        LOGGER.debug("onLoaded", ad);
        this.ready(true);
    };
    var onInterrupted = function(error) {
        LOGGER.debug("onInterrupted", error);
        this._lastError = error;
    };
    var _onAdEngineFinished = function() {
        if (!this._loaded) {
            this.onInterrupted(new vdb.errors.Error("ad engine did not finish loading"));
        }
        this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_ENGINE_COMPLETE, this._configEntry ? this._configEntry.getType() : null));
    };
    var reportCompanionShow = function() {
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_SHOW_COMPANIONS);
    };
    var stop = function() {
        LOGGER.debug("stop");
        if (!this._stopped) {
            this._started = false;
            this._stopped = true;
            if (this._forceStopTimer) {
                this._forceStopTimer.stop();
            }
            _onAdEngineFinished.call(this);
        }
    };
    var skip = function() {
        LOGGER.debug("skip");
        this.stop();
    };
    var complete = function() {
        LOGGER.debug("complete");
        _stopStartTimer.call(this);
        this._started = false;
        if (!this._stopped && this._siteCheckPassed && !this._loaded) {
            if (this._lastError && this._lastError.timeout !== undefined && this._lastError.timeout !== null) {
                this.trackResponse(false, this._lastError.timeout);
            } else {
                if (this._lastError && this._lastError.severity > vdb.html5.ads.AdEngineError.SEVERITY_LOW) {
                    this.trackAdIssue(AdStage.FAILOVER, this._lastError.message);
                }
                this.trackResponse(false);
            }
        }
        if (!this._stopped) {
            this._stopped = true;
            _onAdEngineFinished.call(this);
        }
    };
    var _fireBroadcastAdEvent = function(type, data) {
        if (!data) {
            data = {};
        }
        var ad = data.ad = this.getAdConfigEntry();
        this.dispatchEvent(new vdb.events.AdEvent(type, ad ? ad.getType() : null, data));
        this.adSystem.dispatchEvent(new vdb.events.AdEvent(type, ad ? ad.getType() : null, data));
    };
    var ready = function(success) {
        LOGGER.debug("ready");
        this._loaded = true;
        this.trackResponse(success);
        var conf = this.getAdConfigEntry();
        this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_ENGINE_READY, conf ? conf.getType() : null));
    };
    var adLoaded = function(data) {
        LOGGER.debug("adLoaded");
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_LOADED, data);
        this.trackAdLoaded();
    };
    var trackAdLoaded = function() {
        this.trackFlow(AdStage.LOADED);
        if (!this._configEntry.getIsShim()) {
            this.trackFlow(AdStage.WIN);
        }
    };
    var impression = function() {
        var impTrackerUrl = this._configEntry.getImpressionTracker();
        if (impTrackerUrl) {
            var macrosResolver = this.adSystem.getResolver();
            if (macrosResolver) {
                impTrackerUrl = macrosResolver.resolve(impTrackerUrl);
            }
            this._impressionTracker.callExternalPixel(impTrackerUrl);
        }
    };
    var adStarting = function(data) {
        LOGGER.debug("adStarting");
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_STARTING, data);
    };
    var adStarted = function(event, adView) {
        LOGGER.debug("adStarted", event);
        _stopStartTimer.call(this);
        event = event || {};
        this._isPaused = false;
        this._activeAdView = adView;
        if (this._configEntry.getIsShim()) {
            this.trackFlow(AdStage.WIN);
        }
        if (this._forceStopTimer) {
            this._forceStopTimer.start();
        }
        if (this.adSystem.failedOver) {
            this.adSystem.failedOver = false;
            this.trackFlow(AdStage.BOOST);
        }
        var data = event.data || {};
        if (adView) {
            data.apiType = adView.getApiType();
            data.adId = adView.getAdId();
            data.adIconsContainer = adView.iconsLayer;
        }
        if (!data.parameters) {
            data.parameters = {};
        }
        data.parameters["minibar"] = !!this._configEntry.getExtraProperties()["minibar"];
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_STARTED, data);
        this.track(TrackEvent.REVENUE_SHARE);
        this.trackFlow(AdStage.STARTED, event.data);
        this._started = true;
    };
    var adPaused = function(event) {
        LOGGER.debug("adPaused");
        this._isPaused = true;
        if (this._forceStopTimer) {
            this._forceStopTimer.pause();
        }
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_PAUSED, event && event.data);
    };
    var adVolumeChanged = function(event) {
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_VOLUME_CHANGED, event && event.data);
    };
    var adTimeUpdate = function(event) {
        var eventData = event.data;
        var dataOfEventData = eventData.data || eventData;
        var curTime = dataOfEventData["currentTime"];
        var duration = Math.min(dataOfEventData["duration"], this._maxTime);
        if (duration > 0) {
            eventData.timeRemaining = duration - curTime;
            eventData.progressPercent = curTime / duration * 100;
        } else {
            eventData.timeRemaining = eventData.progressPercent = 0;
        }
        eventData.maxTime = this._maxTime;
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_TIMEUPDATE, eventData);
    };
    var adWaiting = function() {
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_WAITING);
    };
    var adResumed = function() {
        LOGGER.debug("adResumed");
        this._isPaused = false;
        if (this._forceStopTimer) {
            this._forceStopTimer.resume();
        }
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_RESUMED);
    };
    var isPaused = function() {
        return this._isPaused;
    };
    var adClick = function(clickThroughUrl) {
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_CLICK, {clickThroughUrl:clickThroughUrl});
        this.track(TrackEvent.CLICK, {clickType:"ad", clickThroughUrl:clickThroughUrl});
    };
    var adFinished = function(currentTime, data) {
        LOGGER.debug("adFinished", {"currentTime":currentTime, "data":data});
        _stopStartTimer.call(this);
        if (this._forceStop || this._killed) {
            this.trackFlow(AdStage.KILLED, data);
        } else {
            if (this._started) {
                if (this._skipped) {
                    this.trackFlow(AdStage.SKIPPED, data);
                } else {
                    this.trackFlow(AdStage.FINISHED, data);
                }
            }
        }
        _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_FINISHED, {currentTime:currentTime});
    };
    var trackFailoverAdIssue = function(msg) {
        if (!this._lastError) {
            this._lastError = new vdb.html5.ads.AdEngineError(msg);
        }
        if (this._lastError.severity > vdb.html5.ads.AdEngineError.SEVERITY_LOW) {
            this.trackAdIssue(AdStage.LOADED, msg);
        }
    };
    var failOver = function(msg) {
        LOGGER.debug("failOver", msg);
        this.trackFailoverAdIssue.call(this, msg);
        this.adSystem.failedOver = true;
        this.trackFlow(AdStage.FAILOVER);
    };
    var earlyStop = function(msg) {
        LOGGER.debug("earlyStop", msg);
        this._lastError = new vdb.html5.ads.AdEngineError(msg);
        this.trackFlow(AdStage.EARLY_STOP);
    };
    var track = function(eventType, params) {
        LOGGER.debug("track", "eventType", eventType, "params", params);
        params = vdb.Utils.copy(params);
        params = vdb.Utils.extend(params, {"acid":this._configEntry.getAcid(), "asid":this._configEntry.getAsid(), "auid":this._configEntry.getAuid(), "bookingId":this._configEntry.getBookingId(), "costPerImpression":this._configEntry.getCpm(), "fullsizeThumbnail":this._configEntry.getFullsizeThumbnail(), "isHouseAd":this._configEntry.isHouseAd(), "isPayable":this._configEntry.isPayable(), "lineItemId":this._configEntry.getLineItemId(), "name":this._configEntry.getName(), "overlayURL":this._configEntry.getOverlayURL(),
            "profitCenter":this._configEntry.getProfitCenter(), "ruleCompanyId":this._configEntry.getRuleCompanyId(), "ruleId":this._configEntry.getRuleId(), "thirdPartyImpressionTrackers":this._configEntry.getThirdPartyImpressionTrackers(), "thumbnail":this._configEntry.getThumbnail(), "transactionId":this._configEntry.getTransactionId(), "type":this._configEntry.getType(), "usid":this._configEntry.getUsid(), "url":this._configEntry.getUrl(), "vastXml":this._configEntry.getVastXml(), "vendor":this._configEntry.getVendor(),
            "videoDuration":this._configEntry.getVideoDuration(), "videoTitle":this._configEntry.getVideoTitle()});
        this.adSystem.dispatchEvent(new TrackEvent(eventType, params));
    };
    var trackAdInteraction = function(data) {
        var actionType = typeof data === "string" ? data : data.data;
        if (actionType) {
            this.track(TrackEvent.AD_INTERACTION, {action:actionType});
        }
        if (this._forceStopTimer) {
            this._forceStopTimer.stop();
        }
    };
    var trackFlow = function(adStage, params) {
        function sequenced(stage) {
            return sequence ? stage + sequence : stage;
        }
        LOGGER.debug("trackFlow", "adStage", adStage, "params", params);
        var aid = null;
        var sequence = this.adSystem.getAdsLoaded();
        if (params) {
            sequence = params.sequence || sequence;
            aid = params.aid || null;
        }
        var activeAd = this._activeAdView && this._activeAdView.ad ? this._activeAdView.ad : this.ad;
        if (activeAd) {
            aid = aid || activeAd.id || null;
        }
        var trackedStage = sequenced(adStage);
        if (adStage === AdStage.KILLED) {
            var started = sequenced(AdStage.STARTED);
            var loaded = sequenced(AdStage.LOADED);
            if (!this.isStageTracked(started) && this.isStageTracked(loaded)) {
                adStage = AdStage.FAILOVER;
            }
        }
        if (!this.isStageTracked(trackedStage)) {
            var newParams = {costPerImpression:this._configEntry.costPerImpression, displayWidth:this._adContainer.offsetWidth, displayHeight:this._adContainer.offsetHeight, autoPlay:_isAutoPlay.call(this), muted:this.adSystem.isMuted(), adxResult:this._configEntry.getAdxResult(), usid:this._configEntry.getUsid()};
            if (sequence) {
                newParams.sequence = sequence;
            }
            var latencyValue = null;
            switch(adStage) {
                case AdStage.LOADED:
                    latencyValue = this._loadTime;
                    break;
                case AdStage.STARTING:
                    ;
                case AdStage.STARTED:
                    latencyValue = (new Date).getTime() - this._startTime;
                    break;
                case AdStage.FAILOVER:
                    if (this._responseTime) {
                        latencyValue = (new Date).getTime() - this._responseTime;
                    }
                    break;
            }
            if (latencyValue) {
                newParams.latency = latencyValue;
            }
            vdb.Utils.copy(params, newParams);
            var _basicAdParams = this.basicAdParams(adStage, newParams, aid);
            this.track(TrackEvent.AD_ENGINE_FLOW, _basicAdParams);
            this._stageTracked[trackedStage] = true;
            if (_isQuartileStage(adStage)) {
                _fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_QUARTILE, _basicAdParams);
            }
        }
    };
    var _isQuartileStage = function(stage) {
        return[AdStage.FIRST_QUARTILE, AdStage.SECOND_QUARTILE, AdStage.THIRD_QUARTILE, AdStage.FINISHED].indexOf(stage) !== -1;
    };
    var _isAutoPlay = function() {
        var autoplay = this._adsConfig.autoplay;
        if (!autoplay) {
            return false;
        }
        var autoplaySupport = this.adSystem.getCanAutoplay();
        if (autoplaySupport == undefined) {
            return autoplay;
        }
        return autoplay && autoplaySupport;
    };
    var trackAdIssue = function(adStage, details) {
        LOGGER.debug("trackAdIssue", "adStage", adStage, "details", details);
        this.track(TrackEvent.AD_ISSUE, this.basicAdParams(adStage, {details:details}));
    };
    var trackResponse = function(success, timeout) {
        LOGGER.debug("trackResponse", "success", success, "timeout", timeout);
        if (this._startLoadingTimemark) {
            this._loadTime = (new Date).getTime() - this._startLoadingTimemark;
        } else {
            this._loadTime = 0;
            LOGGER.error("load is not called before track response");
        }
        this._responseTime = (new Date).getTime();
        this.track(TrackEvent.AD_ENGINE_RESPONSE, {isSuccess:success, timeout:timeout == undefined ? null : timeout, latency:this._loadTime, vastAdsNumber:this._loaded ? this._vastAdsNumber : 0, displayWidth:this._adContainer.offsetWidth, displayHeight:this._adContainer.offsetHeight});
    };
    var basicAdParams = function(adStage, additional, adId) {
        LOGGER.debug("basicAdParams", "adStage", adStage, "additional", additional, "adId", adId);
        var newParams = {adImpressionId:adId};
        if (adStage != null) {
            newParams.adStage = adStage;
        }
        vdb.Utils.copy(additional, newParams);
        return newParams;
    };
    var isStageTracked = function(adStage) {
        return this._stageTracked[adStage] || false;
    };
    return{_configEntry:null, _viewContainer:null, _lastError:null, _started:false, _stopped:false, _forceStopTimer:null, init:init, getAdConfigEntry:getAdConfigEntry, getAdContainer:getAdContainer, getLastError:getLastError, showOverlay:showOverlay, showLinearAd:showLinearAd, load:load, onLoaded:onLoaded, onInterrupted:onInterrupted, stop:stop, impression:impression, skip:skip, complete:complete, ready:ready, adLoaded:adLoaded, adStarting:adStarting, adStarted:adStarted, adPaused:adPaused, adResumed:adResumed,
        isPaused:isPaused, adVolumeChanged:adVolumeChanged, adTimeUpdate:adTimeUpdate, adWaiting:adWaiting, adClick:adClick, adFinished:adFinished, failOver:failOver, trackFailoverAdIssue:trackFailoverAdIssue, earlyStop:earlyStop, track:track, trackFlow:trackFlow, trackAdInteraction:trackAdInteraction, trackAdIssue:trackAdIssue, trackAdLoaded:trackAdLoaded, trackResponse:trackResponse, basicAdParams:basicAdParams, isStageTracked:isStageTracked, _fireBroadcastAdEvent:_fireBroadcastAdEvent, reportCompanionShow:reportCompanionShow};
}());
vdb.html5.ads.modules.ima.ImaEngine = vdb.html5.ads.AdEngineBase.extend(function() {
    var LOGGER = vdb.log.getLogger("ImaEngine");
    var AdUserInteraction = vdb.enums.AdUserInteraction;
    var _muteAllVideos = function(mute) {
        if (this._config.playsNativeInline()) {
            var videos = this._adContainer.getElementsByTagName("video");
            for (var i = 0;i < videos.length;i++) {
                videos[i].muted = mute;
            }
        }
    };
    var _onPlayerResize = function() {
        var containerSize = _getContainerSize.call(this);
        if (this._overlaySize) {
            _resizeOverlay.call(this, containerSize.width, containerSize.height);
        } else {
            _resize.call(this, containerSize.width, containerSize.height);
        }
    };
    var _resize = function(width, height) {
        this._adsManager["resize"](width, height, this._ima["ViewMode"]["NORMAL"]);
    };
    var _resizeOverlay = function(maxWidth, maxHeight) {
        var width = Math.min(this._overlaySize.width, maxWidth);
        var height = Math.min(this._overlaySize.height, maxHeight);
        var style = this._adContainer.style;
        style.position = "absolute";
        style.bottom = "0";
        style.width = width + "px";
        style.height = height + "px";
        style.left = (maxWidth - width) / 2 + "px";
        _resize.call(this, width, height);
    };
    var _getContainerSize = function() {
        var container = this._adContainer.parentNode;
        return{width:container.clientWidth, height:container.clientHeight};
    };
    var _onAdsManagerLoaded = function(event) {
        LOGGER.debug("onAdsManagerLoaded()", event);
        if (this._killed) {
            return;
        }
        this._adsManager = event["getAdsManager"](this._display.getPrerollAreaElement());
        this.ready(true);
    };
    var _onError = function(event) {
        var imaError = event["getError"]();
        this._lastError = new vdb.html5.ads.AdEngineError(imaError["getMessage"](), vdb.html5.ads.AdEngineError.SEVERITY_MID);
        LOGGER.error("onError()", this._lastError);
        if (this.isStageTracked(vdb.ads.AdStage.LOADED)) {
            this.failOver("Unable to find suitable linear creatives");
        } else {
            this.complete();
        }
        _destroy.call(this);
    };
    var _onAdClick = function(event) {
        var ad = event["getAd"]();
        var clickThroughUrl = ad["getClickThroughUrl"]();
        this.adClick(clickThroughUrl);
    };
    var _destroy = function() {
        LOGGER.debug("destroy()");
        if (this._playerResizeHandler) {
            this.adSystem.removeEventListener(vdb.html5.ads.events.AdSystemEvent.RESIZE, this._playerResizeHandler);
        }
        if (this._adsManager) {
            if (this._adsManagerListeners) {
                this._adsManagerListeners.unbind();
                this._adsManagerListeners = null;
            }
            this._adsManager["destroy"]();
        }
        setTimeout(function() {
            if (this._imaAdDisplay) {
                this._imaAdDisplay["destroy"]();
            }
            if (this._adContainer.parentNode) {
                this._adContainer.parentNode.removeChild(this._adContainer);
            }
        }.bind(this), 1E3);
    };
    var _onContentPauseRequested = function() {
        if (this._pauseRequested) {
            return;
        }
        this._pauseRequested = true;
        LOGGER.debug("onContentPauseRequested()");
        this.adStarting();
    };
    var _onContentResumeRequested = function() {
        LOGGER.debug("onContentResumeRequested()");
        this.complete();
        _hideAdContainer.call(this);
    };
    var _showAdContainer = function() {
        this._adContainer.style.setProperty("visibility", "visible");
    };
    var _hideAdContainer = function() {
        this._adContainer.style.setProperty("visibility", "hidden");
    };
    var _onAdEvent = function(adEvent) {
        LOGGER.debug("onAdEvent", adEvent);
        var AdEventType = this._ima["AdEvent"]["Type"];
        var ad = adEvent["getAd"] && adEvent["getAd"]();
        var duration = ad["getDuration"]();
        var isLinear = ad && Boolean(ad["isLinear"]());
        switch(adEvent.type) {
            case AdEventType["LOADED"]:
                this.setVolume(this.adSystem.getVolume());
                var isConfigLinear = Boolean(this._configEntry.isLinear());
                if (!isLinear) {
                    this._fireBroadcastAdEvent(vdb.events.AdEvent.AD_BLOCKER_COMPLETE);
                }
                if (isLinear !== isConfigLinear) {
                    LOGGER.warn("Ignore ad. Expected " + (isConfigLinear ? "" : "non-") + "linear ad, " + "but found " + (isLinear ? "" : "non-") + "linear ad");
                    _destroy.call(this);
                    return;
                }
                _showAdContainer.call(this);
                this.adLoaded();
                if (!isLinear) {
                    var adData = adEvent["getAdData"]();
                    this._overlaySize = {width:adData["width"], height:adData["height"]};
                    _onPlayerResize.call(this);
                }
                break;
            case AdEventType["STARTED"]:
                this.impression();
                this.adStarted();
                this.setVolume(this.adSystem.getVolume());
                if (isLinear) {
                    this._intervalTimer = setInterval(_fireTimeUpdate.bind(this, adEvent, duration), 250);
                }
                break;
            case AdEventType["PAUSED"]:
                if (this._intervalTimer) {
                    clearInterval(this._intervalTimer);
                }
                this.adPaused();
                break;
            case AdEventType["RESUMED"]:
                this._intervalTimer = setInterval(_fireTimeUpdate.bind(this, adEvent, duration), 250);
                this.adResumed();
                break;
            case AdEventType["CLICK"]:
                _onAdClick.call(this, adEvent);
                break;
            case AdEventType["FIRST_QUARTILE"]:
                this.trackFlow(vdb.ads.AdStage.FIRST_QUARTILE);
                break;
            case AdEventType["MIDPOINT"]:
                this.trackFlow(vdb.ads.AdStage.SECOND_QUARTILE);
                break;
            case AdEventType["THIRD_QUARTILE"]:
                this.trackFlow(vdb.ads.AdStage.THIRD_QUARTILE);
                break;
            case AdEventType["VOLUME_CHANGED"]:
                ;
            case AdEventType["VOLUME_MUTED"]:
                this.adVolumeChanged();
                break;
            case AdEventType["COMPLETE"]:
                this.adFinished(duration);
                if (this._intervalTimer) {
                    clearInterval(this._intervalTimer);
                }
                break;
            case AdEventType["EXPANDED_CHANGED"]:
                var isExpanded = Boolean(ad["expanded"]);
                this.trackAdInteraction(isExpanded ? AdUserInteraction.EXPAND : AdUserInteraction.COLLAPSE);
                break;
            case AdEventType["USER_CLOSE"]:
                this.trackAdInteraction(isLinear ? AdUserInteraction.CLOSE_LINEAR : AdUserInteraction.CLOSE);
                break;
            case this._ima["AdErrorEvent"]["Type"]["AD_ERROR"]:
                _onError.call(this, adEvent);
                break;
        }
    };
    var _getAdEvents = function() {
        var AdEventType = this._ima["AdEvent"]["Type"];
        return[AdEventType["LOADED"], AdEventType["STARTED"], AdEventType["CLICK"], AdEventType["FIRST_QUARTILE"], AdEventType["MIDPOINT"], AdEventType["THIRD_QUARTILE"], AdEventType["COMPLETE"], AdEventType["PAUSED"], AdEventType["RESUMED"], AdEventType["VOLUME_CHANGED"], AdEventType["VOLUME_MUTED"], AdEventType["EXPANDED_CHANGED"], AdEventType["USER_CLOSE"], this._ima["AdErrorEvent"]["Type"]["AD_ERROR"]];
    };
    var _requestAds = function() {
        var adsRequest = new this._ima["AdsRequest"];
        adsRequest["adTagUrl"] = this._configEntry.getUrl();
        var size = _getContainerSize.call(this);
        adsRequest["linearAdSlotWidth"] = adsRequest["nonLinearAdSlotWidth"] = size.width;
        adsRequest["linearAdSlotHeight"] = adsRequest["nonLinearAdSlotHeight"] = size.height;
        LOGGER.debug("requestAds()", adsRequest);
        this._imaAdsLoader["requestAds"](adsRequest);
    };
    var _hideCovering = function() {
        if (this._covering && this._covering.parentNode) {
            this._covering.parentNode.removeChild(this._covering);
        }
    };
    var _showCovering = function(callback) {
        _hideCovering.call(this);
        LOGGER.debug("showCovering()");
        this._covering = vdb.Utils.createElement("div", {"position":"absolute", "zIndex":100, "width":"100%", "height":"100%", "display":"table", "backgroundColor":"#000"}, this._adContainer);
        var innerLayout = vdb.Utils.createElement("div", {"verticalAlign":"middle", "textAlign":"center", "display":"table-cell"}, this._covering);
        var playBtn = vdb.Utils.createElement("div", {"class":"ima-play-button"}, innerLayout, '<svg class="player-icon" version="1.1" id="Layer_2" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 841.891 595.279" enable-background="new 0 0 841.891 595.279" xml:space="preserve"><radialGradient id="SVGID_1_" cx="428.8484" cy="299.6243" r="29.6255" gradientTransform="matrix(1 0 0 -1 -0.0552 595.1392)" gradientUnits="userSpaceOnUse"><stop offset="0" style="stop-color:#FFFFFF"/><stop offset="1" style="stop-color:#000000"/></radialGradient><circle opacity="0.7" fill="url(#SVGID_1_)" enable-background="new" cx="428.794" cy="295.515" r="29.625"/><path fill="#D9D9D9" d="M428.794,263.765c-17.536,0-31.751,14.215-31.751,31.75s14.215,31.75,31.751,31.75 c17.534,0,31.75-14.215,31.75-31.75S446.328,263.765,428.794,263.765z M428.794,325.14c-16.361,0-29.626-13.264-29.626-29.625 s13.265-29.625,29.626-29.625c16.36,0,29.625,13.264,29.625,29.625S445.154,325.14,428.794,325.14z"/><g><g><polygon fill="#FFFFFF" points="422.169,284.64 422.169,307.64 441.044,296.14"/></g></g></svg> ');
        playBtn.addEventListener("click", callback, false);
        _showAdContainer.call(this);
    };
    var _showAd = function() {
        this._imaAdDisplay["initialize"]();
        if (this._adsManager) {
            LOGGER.debug("bind AdsManager event listeners");
            var _this = this;
            this._adsManagerListeners = vdb.events.EventContext.group(vdb.events.EventContext.bind(this._adsManager, this._ima["AdEvent"]["Type"]["CONTENT_PAUSE_REQUESTED"], _onContentPauseRequested.bind(this)), vdb.events.EventContext.bind(this._adsManager, this._ima["AdEvent"]["Type"]["CONTENT_RESUME_REQUESTED"], _onContentResumeRequested.bind(this)), vdb.events.EventContext.bind(this._adsManager, this._ima["AdEvent"]["Type"]["ALL_ADS_COMPLETED"], function() {
                _destroy.call(_this);
            }));
            var adEventCallback = _onAdEvent.bind(this);
            var adEvents = _getAdEvents.call(this);
            for (var i = 0;i < adEvents.length;i++) {
                this._adsManager.addEventListener(adEvents[i], adEventCallback);
            }
            this._playerResizeHandler = _onPlayerResize.bind(this);
            this.adSystem.addEventListener(vdb.html5.ads.events.AdSystemEvent.RESIZE, this._playerResizeHandler);
            try {
                this._adsManager["init"](this._adContainer.offsetWidth, this._adContainer.offsetHeight, this._ima["ViewMode"]["NORMAL"]);
                _hideCovering.call(this);
                this._adsManager["start"]();
            } catch (adError) {
            }
        } else {
            this._lastError = new vdb.html5.ads.AdEngineError("Failed to obtain IMA ads manager");
            LOGGER.warn("showAd()", "error", this._lastError);
            this.complete();
            _destroy.call(this);
        }
    };
    var _resolveDependencies = function() {
        var injector = this.adSystem.getInjector();
        this._urls = injector.resolveSync(vdb.enums.Dependencies.URLS);
        this._config = injector.resolveSync(vdb.enums.Dependencies.CONFIG);
    };
    var _fireTimeUpdate = function(event, duration) {
        if (this.isPaused()) {
            return;
        }
        var remainingTime = this._adsManager["getRemainingTime"]();
        remainingTime = remainingTime > 0 ? remainingTime : 0;
        var currentTime = Math.round(duration - remainingTime);
        var eventData = event.data || {};
        eventData.timeRemaining = remainingTime;
        eventData.progressPercent = currentTime / duration * 100;
        this._fireBroadcastAdEvent.call(this, vdb.events.AdEvent.AD_TIMEUPDATE, eventData);
    };
    return{init:function(adSystem, adsConfig, adContainers, adEntry) {
        this._super(adSystem, adsConfig);
        LOGGER.debug("init");
        this._configEntry = adEntry;
        this._adContainer = vdb.dom.nodeFromHTML('<div style="width: 100%;height: 100%;position: absolute;z-index: 1;" class="ima-ad-container"></div>');
        adContainers.adContainer.appendChild(this._adContainer);
        _hideAdContainer.call(this);
        _resolveDependencies.call(this);
        vdb.html5.ads.modules.ima.ImaLibLoader.load(this._urls.isSecure());
    }, load:function() {
        var superFunc = this._super.bind(this);
        var onImaLoaded = function(success) {
            if (!success) {
                LOGGER.error("Failed to load IMA lib");
                this.complete();
                _destroy.call(this);
                return;
            }
            superFunc();
            var ima = this._ima = window["google"]["ima"];
            ima["settings"]["setVpaidMode"](ima["ImaSdkSettings"]["VpaidMode"]["INSECURE"]);
            ima["settings"]["setDisableCustomPlaybackForIOS10Plus"](true);
            var type = this._configEntry.getType();
            this._element = type === vdb.enums.AdType.PREROLL ? this._display.blockByVPAIDPreroll().getElement() : null;
            this._imaAdDisplay = new this._ima["AdDisplayContainer"](this._adContainer, this._element);
            LOGGER.debug("load()", "AdDisplayContainer", this._imaAdDisplay);
            this._imaAdsLoader = new this._ima["AdsLoader"](this._imaAdDisplay);
            this._imaAdsLoader.addEventListener(this._ima["AdsManagerLoadedEvent"]["Type"]["ADS_MANAGER_LOADED"], _onAdsManagerLoaded.bind(this), false);
            this._imaAdsLoader.addEventListener(this._ima["AdErrorEvent"]["Type"]["AD_ERROR"], _onError.bind(this), false);
            _requestAds.call(this);
        }.bind(this);
        vdb.html5.ads.modules.ima.ImaLibLoader.load(this._urls.isSecure(), onImaLoaded);
    }, stop:function() {
        this._killed = true;
        this._super();
        var currentTime = Math.round(this._adsManager["getCurrentAd"]()["getDuration"]() - this._adsManager["getRemainingTime"]());
        this.adFinished(currentTime);
        _destroy.call(this);
    }, pause:function() {
        this._adsManager["pause"]();
    }, adVolumeChanged:function() {
        var data = {};
        data.volume = this._adsManager["getVolume"]();
        this._super({data:data});
    }, resume:function() {
        this._adsManager["resume"]();
    }, setVolume:function(volume) {
        LOGGER.debug("setVolume()", volume);
        this._adsManager["setVolume"](volume);
        _muteAllVideos.call(this, !volume);
    }, showLinearAd:function(maxTime) {
        var superShowLinearAd = this._super.bind(this);
        var show = function() {
            superShowLinearAd(maxTime);
            _showAd.call(this);
        }.bind(this);
        var type = this._configEntry.getType();
        if (vdb.Utils.browser.isMobile() && type === vdb.enums.AdType.MIDROLL) {
            _onContentPauseRequested.call(this);
            _showCovering.call(this, show);
        } else {
            show();
        }
    }, showOverlay:function() {
        this._super();
        _showAd.call(this);
    }};
}());
vdb.html5.ads.modules.ima.ImaEngineProducer = vdb.html5.ads.AdEngineProducer.extend(function() {
    return{createAdEngine:function(ad) {
        vdb.log.getLogger("ImaEngineProducer").debug("createAdEngine", ad);
        return new vdb.html5.ads.modules.ima.ImaEngine(this._adSystem, this._adsConfig, this._adContainers, ad);
    }, getType:function() {
        return vdb.enums.AdEngineType.IMA;
    }};
}());
vdb.html5.ads.modules.vast.ex = {};
vdb.html5.ads.modules.vast.ex.VastError = function() {
    var DEFAULT_ERROR = vdb.html5.ads.modules.vast.errorCodes.UNDEFINED;
    var VastError = function(code, message) {
        this.message = message || DEFAULT_ERROR.description;
        this.code = code || DEFAULT_ERROR.code;
    };
    vdb.utils.Common.inherit(VastError, Error);
    VastError.prototype.toString = function() {
        return "VastError{code=" + this.code + ",message=" + this.message + "}";
    };
    return VastError;
}();
vdb.html5.ads.modules.vast.loader = {};
vdb.html5.ads.modules.vast.loader.VastLoader = vdb.html5.ads.AdLoader.extend(function() {
    var LOGGER = vdb.log.getLogger("VastLoader");
    var VAST_AJAX_ERROR = "VAST ajax error";
    var MAX_WRAPPER_DEPTH = 8;
    var _initStateFields = function() {
        this._wrapperDepth = 0;
        this.vastRoot = null;
    };
    var _loadingTimeOut = function() {
        _adFailed.call(this, vdb.html5.ads.modules.vast.errorCodes.WRAPPER_TIMEOUT);
        _interruptOnError.call(this, new vdb.errors.TimeoutError("Loading timeout " + this._loadTimeout + " ms is exceeded", this._loadTimeout));
    };
    var _failOver = function(cause, details) {
        var lastVastModel = this.lastVastModel;
        this.lastVastModel = null;
        LOGGER.debug("failOver", cause, lastVastModel);
        if (lastVastModel) {
            if (cause == VAST_AJAX_ERROR) {
                _adFailed.call(this, vdb.html5.ads.modules.vast.errorCodes.FILE_NOT_FOUND);
            }
            if (lastVastModel.ads.length === 0 && lastVastModel.parent) {
                var parentAd = lastVastModel.parentAd;
                var error = cause == VAST_AJAX_ERROR ? vdb.html5.ads.modules.vast.errorCodes.FILE_NOT_FOUND : vdb.html5.ads.modules.vast.errorCodes.GENERAL_WRAPPER_ERROR;
                var vastEvent = new vdb.html5.ads.modules.vast.event.VastEvent(vdb.html5.ads.modules.vast.event.VastEvent.ERROR, null, null, {error:error});
                parentAd.dispatchEvent(vastEvent);
                this._eventHandler.onVastEvent(vastEvent);
                this.lastVastModel = lastVastModel = lastVastModel.parent;
            }
            if (this.lastVastModelAd == lastVastModel.ads[0]) {
                lastVastModel.ads.shift();
            }
            _processModel.call(this, lastVastModel, true);
        } else {
            _interruptOnError.call(this, cause + (details ? " (" + details + ")" : ""));
        }
    };
    var _interruptOnError = function(cause) {
        LOGGER.warn("interruptOnError", cause);
        _stopTimer.call(this);
        var message = cause instanceof vdb.errors.Error ? cause.message : cause;
        var severity = message === vdb.html5.ads.modules.vast.loader.VastLoader.NO_ADS_PROVIDED ? vdb.html5.ads.AdEngineError.SEVERITY_LOW : vdb.html5.ads.AdEngineError.SEVERITY_MID;
        var timeout = cause instanceof vdb.errors.TimeoutError ? cause.timeoutMs : null;
        var adEngineError = new vdb.html5.ads.AdEngineError(message, severity, timeout);
        this.dispatchEvent(vdb.html5.ads.AdLoader.INTERRUPTED, adEngineError);
    };
    var _loadVastFrom = function(url, onParsed) {
        var vastUrl = url || this._ad && this._ad.getUrl();
        vastUrl = this._resolverProducer.getResolver().resolve(vastUrl);
        var _this = this;
        var requestTimeout = this._ad && this._ad.isFirstUrlInSet() && !url ? this._ad.getAdditionalRequestTimeout() : this._loadTimeout;
        var onAjaxErrorWithCredentials = function(response, request, timedOut) {
            if (this._ad && this._ad.isFirstUrlInSet() && !url) {
                onAjaxError(response, request, timedOut);
            } else {
                this._errorTracker.trackError("ad", null, "Failed VAST request with Credentials");
                vdb.ajax.get(vastUrl, null, onAjaxSuccess, onAjaxError, null, {timeout:requestTimeout});
            }
        };
        var onAjaxError = function(response, request, timedOut) {
            _this._resolverProducer.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.loader.VastLoader.VAST_LOADED, {ad:_this._ad, url:vastUrl}));
            if (url || !entryFallback.call(_this)) {
                _failOver.call(_this, VAST_AJAX_ERROR, timedOut ? "request timeout over " + requestTimeout + "ms" : null);
            }
        };
        var onAjaxSuccess = function(resp) {
            _this._resolverProducer.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.loader.VastLoader.VAST_LOADED, {ad:_this._ad, url:vastUrl}));
            var data = resp.data;
            if (!data) {
                data = resp.text;
            }
            if (!_isStopped.call(_this)) {
                _parseAndProcess.call(_this, data, onParsed, url);
            }
        };
        if (this._urls.isSecure()) {
            vastUrl = vdb.utils.StringUtils.replaceAll(vastUrl, "http://", "https://");
        }
        vastUrl = vdb.utils.StringUtils.replaceAll(vastUrl, "#", encodeURIComponent("#"));
        _this._resolverProducer.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.loader.VastLoader.VAST_LOADING, {ad:_this._ad, url:vastUrl}));
        vdb.ajax.get(vastUrl, null, onAjaxSuccess, onAjaxErrorWithCredentials.bind(this), null, {withCredentials:true, timeout:requestTimeout});
    };
    var _parseAndProcess = function(data, onParsed, childUrl) {
        LOGGER.debug("parseAndProcess", data);
        try {
            var vastModel = this._vastParser.parse(data);
            this._parseError = null;
            if (onParsed) {
                onParsed(vastModel);
            }
            _processModel.call(this, vastModel);
        } catch (e) {
            if (!childUrl && entryFallback.call(this)) {
                return;
            }
            this._parseError = e.code;
            _failOver.call(this, e.message);
        }
    };
    var entryFallback = function() {
        if (this._ad && this._ad.switchToNextUrl()) {
            this._errorTracker.trackError("ad", null, "switching to the next ad in [urls] in the same entry");
            _loadVastFrom.call(this, null);
            return true;
        }
        return false;
    };
    var _processFailoverWrapper = function(vastModel, adIndex) {
        _processModel.call(this, vastModel, undefined, adIndex);
    };
    var _processModel = function(vastModel, alreadySorted, adIndex) {
        adIndex = adIndex || 0;
        LOGGER.debug("processModel", vastModel);
        if (!this.vastRoot) {
            this.vastRoot = vastModel;
        }
        if (vastModel.ads.length === 0) {
            _failOver.call(this, vdb.html5.ads.modules.vast.loader.VastLoader.NO_ADS_PROVIDED);
            if (this._parseError) {
                if (this._parseError == vdb.html5.ads.modules.vast.errorCodes.VAST_VERSION.code) {
                    _adFailed.call(this, vdb.html5.ads.modules.vast.errorCodes.VAST_VERSION);
                } else {
                    _adFailed.call(this, vdb.html5.ads.modules.vast.errorCodes.VAST_PARSING);
                }
            } else {
                if (this._wrapperDepth > 0) {
                    _adFailed.call(this, vdb.html5.ads.modules.vast.errorCodes.NO_ADS_AFTER_WRAPPER);
                }
            }
            return;
        }
        if (!alreadySorted) {
            _sortVastModelAds(vastModel);
        }
        var ad = vastModel.ads[adIndex];
        if (ad.isWrapper) {
            this.lastVastModel = vastModel;
            this.lastVastModelAd = vastModel.ads.splice(adIndex, 1)[0];
            this._wrapperDepth += 1;
            if (this._wrapperDepth <= this._maxWrapperDepth) {
                var redirectionTarget = ad.childVASTUrl.url;
                _loadVastFrom.call(this, redirectionTarget, function(childVastModel) {
                    ad.attachChildEvents(childVastModel);
                    ad.propagateNodes(childVastModel, this.lastVastModelAd);
                    childVastModel.parent = vastModel;
                    childVastModel.parentAd = ad;
                }.bind(this));
            } else {
                this.lastVastModel = null;
                _adFailed.call(this, vdb.html5.ads.modules.vast.errorCodes.WRAPPER_LIMIT);
                _failOver.call(this, "Max number of wrapper redirects " + this._maxWrapperDepth + " is exceeded");
            }
        } else {
            _loadingInlineAdCompleted.call(this, vastModel);
        }
    };
    var _sortVastModelAds = function(vastModel) {
        vastModel.ads.sort(function(ad1, ad2) {
            return ad1.sequence - ad2.sequence;
        });
    };
    var _loadingInlineAdCompleted = function(vastModel) {
        _stopTimer.call(this);
        this.dispatchEvent(vdb.html5.ads.AdLoader.COMPLETED, vastModel);
    };
    var _startTimer = function() {
        var additionalTimeout = this._ad && this._ad.getAdditionalRequestTimeout() || 0;
        this._timeoutId = setTimeout(_loadingTimeOut.bind(this), this._loadTimeout + additionalTimeout);
    };
    var _stopTimer = function() {
        clearTimeout(this._timeoutId);
        this._timeoutId = null;
    };
    var _isStopped = function() {
        return this._timeoutId === null;
    };
    var _adFailed = function(error) {
        if (this.lastVastModelAd) {
            this.lastVastModelAd.dispatchErrorEvent(this._eventHandler, error);
        }
    };
    return{_eventBus:null, _loadTimeout:0, _vastParser:null, _timeoutId:null, _maxWrapperDepth:MAX_WRAPPER_DEPTH, _wrapperDepth:0, vastRoot:null, _initStateFields:_initStateFields, _startTimer:_startTimer, _parseAndProcess:_parseAndProcess, processModel:_processModel, processFailoverWrapper:_processFailoverWrapper, init:function(ad, vastParser, loadTimeout, vastEventHandler, urls, resolverProducer) {
        this._super();
        this._ad = ad;
        this._eventHandler = vastEventHandler;
        this._vastParser = vastParser;
        this._loadTimeout = loadTimeout;
        this._urls = urls;
        this._resolverProducer = resolverProducer;
        this._errorTracker = resolverProducer.getInjector().resolveSync(vdb.enums.Dependencies.ERROR_TRACKER);
    }, load:function() {
        _initStateFields.call(this);
        _startTimer.call(this);
        _loadVastFrom.call(this, null);
    }};
}());
(function(def) {
    def.NO_ADS_PROVIDED = "No ads provided";
    def.VAST_LOADING = "VastLoader.Vast.Loading";
    def.VAST_LOADED = "VastLoader.Vast.Loaded";
})(vdb.html5.ads.modules.vast.loader.VastLoader);
vdb.html5.ads.modules.vast.loader.AdsVastLoader = vdb.html5.ads.modules.vast.loader.VastLoader.extend(function() {
    return{init:function(vastAds, vastParser, loadTimeout, vastEventHandler, urls, resolverProducer) {
        this._super(null, vastParser, loadTimeout, vastEventHandler, urls, resolverProducer);
        this._vastAds = vastAds;
        this._eventHandler = vastEventHandler;
    }, load:function() {
        this._initStateFields();
        this._startTimer();
        var model = new vdb.html5.ads.modules.vast.model.VastRoot;
        model.ads = this._vastAds || [];
        this.processModel(model);
    }};
}());
vdb.html5.ads.modules.vast.loader.EmbedVastLoader = vdb.html5.ads.modules.vast.loader.VastLoader.extend(function() {
    return{init:function(vastXml, vastParser, loadTimeout, vastEventHandler, urls, resolverProducer) {
        this._super(null, vastParser, loadTimeout, vastEventHandler, urls, resolverProducer);
        this._vastXml = vastXml;
        this._eventHandler = vastEventHandler;
    }, load:function() {
        this._initStateFields();
        this._startTimer();
        this._parseAndProcess(this._vastXml);
    }};
}());
vdb.html5.ads.modules.vast.parser.VastParser = vdb.core.Class.extend(function() {
    function xmlToDom(xml) {
        var type = typeof xml;
        if (type == "string") {
            try {
                return parseXml(xml);
            } catch (e) {
                LOGGER.error(e, "Invalid VAST xml", xml);
                throwParseError("Invalid VAST: " + (e.message ? e.message : e));
            }
        } else {
            if (type == "object") {
                return xml;
            } else {
                throwParseError("Cannot parse VAST: non-supported type", type);
            }
        }
    }
    function parseXml(xmlStr) {
        var xmlDoc;
        if (typeof window.DOMParser != "undefined") {
            xmlDoc = (new window.DOMParser).parseFromString(xmlStr, "text/xml");
            if (xmlDoc.getElementsByTagName("parsererror").length > 0 || !xmlDoc.documentElement) {
                throwParseError("Invalid XML");
            }
            return xmlDoc;
        } else {
            if (typeof window.ActiveXObject != "undefined" && new window.ActiveXObject("Microsoft.XMLDOM")) {
                xmlDoc = new window.ActiveXObject("Microsoft.XMLDOM");
                xmlDoc.async = "false";
                xmlDoc.loadXML(xmlStr);
                if (xmlDoc.parseError.errorCode != 0 || !xmlDoc.documentElement) {
                    throwParseError("Invalid XML");
                }
                return xmlDoc;
            } else {
                throwParseError("No XML parser found");
            }
        }
    }
    function throwParseError(msg, code) {
        throw new vdb.errors.ParseError(msg, code);
    }
    function getRoot(xml) {
        var doc = xmlToDom(xml);
        var root = doc.documentElement;
        if (root.nodeName != "VAST") {
            throwParseError("Invalid VAST XML", vdb.html5.ads.modules.vast.errorCodes.VAST_PARSING.code);
        }
        var version = root.getAttribute("version");
        if (VAST_ACCEPTABLE_VERSIONS.indexOf(version) == -1) {
            throwParseError("Unsupported VAST version", vdb.html5.ads.modules.vast.errorCodes.VAST_VERSION.code);
        }
        return root;
    }
    var LOGGER = vdb.log.getLogger("VastParser");
    var VAST_ACCEPTABLE_VERSIONS = ["2.0", "2.0.1", "3.0", "4.0"];
    return{init:function(adSystem) {
        this._adSystem = adSystem;
    }, parse:function(xml) {
        var root = getRoot(xml);
        var rootParser = new vdb.html5.ads.modules.vast.parser.elem.VastRootElementParser(this._adSystem);
        return rootParser.parse(root);
    }, validate:function(xml) {
        try {
            return!!getRoot(xml);
        } catch (e) {
        }
        return false;
    }};
}());
vdb.html5.ads.modules.vast.VastTracker = vdb.tracking.PixelTracker.extend(function() {
    var LOGGER = vdb.log.getLogger("VastTracker");
    return{init:function(dependencies) {
        this._super(dependencies);
        this._enabled = true;
    }, track:function(pixelURL) {
        LOGGER.info("VAST track", pixelURL);
        this.callExternalPixel(pixelURL);
    }};
}());
vdb.html5.ads.modules.vast.event.handler.SimpleVastEventHandler = vdb.html5.ads.modules.vast.event.handler.VastEventHandler.extend(function() {
    var LOGGER = vdb.log.getLogger("SimpleVastEventHandler");
    var impressionTrackersToBlock = [];
    var onAdEngineResponse = function(e) {
        impressionTrackersToBlock = e["data"]["thirdPartyImpressionTrackers"] || [];
    };
    var checkUrlSent = function(thirdPartyUrl) {
        if (!thirdPartyUrl) {
            return false;
        }
        var i = 0;
        for (var j = impressionTrackersToBlock.length;i < j;++i) {
            var normalizedUrl = thirdPartyUrl.replace(/(https?\:)?/, "").replace(/\&cb\=[^&]*/, "").replace(/\&apid\=\[object\sObject\]/, "&apid=[APID]").replace(/;ord\=[^;]*/, ";ord=[timestamp]");
            if (normalizedUrl === impressionTrackersToBlock[i]) {
                return true;
            }
        }
        return false;
    };
    var init = function(adSystem) {
        this._adSystem = adSystem;
        this._adsConfig = adSystem.getAdsConfig();
        var injector = adSystem.getInjector();
        this._eventBus = injector.resolveSync(vdb.enums.Dependencies.EVENT_BUS);
        this._environment = injector.resolveSync(vdb.enums.Dependencies.ENVIRONMENT);
        if (this._adsConfig.isBrandedContent) {
            this._eventBus.addEventListener(vdb.events.TrackEvent.AD_ENGINE_RESPONSE, onAdEngineResponse.bind(this));
        }
        this.trackerPromise = injector.createClass(vdb.html5.ads.modules.vast.VastTracker);
    };
    var onVastEvent = function(event, adEntry) {
        LOGGER.debug("onVastEvent", event, adEntry);
        for (var e = event;e;) {
            LOGGER.debug("onVastEvent", "process", e);
            for (var i = 0;i < e.eventRecords.length;i++) {
                var record = e.eventRecords[i];
                if (!checkUrlSent.call(this, record)) {
                    record = this._adSystem.getResolver().resolve(record);
                    if (e.type === vdb.html5.ads.modules.vast.event.VastEvent.ERROR) {
                        var err = e.data.error ? e.data.error.code : vdb.html5.ads.modules.vast.errorCodes.UNDEFINED.code;
                        record = record.replace(/\[ERRORCODE\]|%5BERRORCODE%5D|\{errNo\}/g, err);
                    }
                    this.trackerPromise.then(function(url, tracker) {
                        tracker.track(url);
                    }.bind(this, record));
                }
            }
            e = e.getChildEvent();
        }
        if (event.type === vdb.html5.ads.modules.vast.event.VastEvent.CLICK) {
            try {
                var clickThroughUrl = event.getClickThrough();
                if (clickThroughUrl) {
                    LOGGER.info("Open on ad click", clickThroughUrl);
                    vdb.utils.Common.openLinkInNewTab(clickThroughUrl);
                }
            } catch (ex) {
                LOGGER.error("onVastEvent", ex);
            }
        }
    };
    return{init:init, onVastEvent:onVastEvent};
}());
vdb.html5.ads.modules.vast.view = {};
vdb.html5.ads.modules.vast.view.AdView = vdb.EventBus.extend(function() {
    var LOGGER = vdb.log.getLogger("AdView");
    var Dependencies = vdb.enums.Dependencies;
    var EnvironmentEvent = vdb.events.EnvironmentEvent;
    var VastEngineEvent = vdb.html5.ads.modules.vast.event.VastEngineEvent;
    var init = function(timer, adContainer, ad, creative, mediaContent, adSystem) {
        LOGGER.debug("create", {"ad":ad, "creative":creative, "mediaContent":mediaContent});
        this._super();
        this._timer = timer;
        this._adContainer = adContainer;
        this.ad = ad;
        this.creative = creative;
        this._mediaContent = mediaContent;
        this._resizable = true;
        this._adSystem = adSystem;
        this._adViewabilityTracker = new vdb.html5.ads.modules.vast.model.AdViewabilityTracker(ad, creative, adSystem);
        this._adsConfig = this._adSystem.getAdsConfig();
        this._adConfigEntry = this._adSystem.getAdConfigEntry();
    };
    var initView = function(volume) {
        this._mediaElement = this.resolveMediaElement();
        if (this._mediaElement) {
            var injector = this._adSystem.getInjector();
            this._errorTracker = injector.resolveSync(Dependencies.ERROR_TRACKER);
            this._environment = injector.resolveSync(Dependencies.ENVIRONMENT);
            this._environment.addEventListener(EnvironmentEvent.PLAYER_RESIZE, this._mediaElement.resize.bind(this._mediaElement));
            this._environment.addEventListener(EnvironmentEvent.PLAYER_CONTROLS_STATE_CHANGE, function(event) {
                this._mediaElement.invokeAdMethod("controlsStateChange", event.data);
            }.bind(this));
            this._mediaElement.adView = this;
            this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_REQUESTED));
            this.setVolume(volume);
            loadMediaElement.call(this);
        } else {
            this.complete(true);
        }
    };
    var loadMediaElement = function() {
        if (this._mediaElement.isO2Shim && this._mediaElement.isO2Shim()) {
            var url = this._adConfigEntry && this._adConfigEntry.getUrl();
            var openApi = url && vdb.utils.UrlUtils.getParameterByName("o2token", this._adConfigEntry.getUrl()) ? "enabled" : "disabled";
            this._errorTracker.trackError("ad", null, "Player gets o2shim to play ad. Open API: " + openApi);
        }
        this._mediaElement.load();
    };
    var noResize = function() {
        this._resizable = false;
    };
    var draw = function() {
        this.resize();
        this._adContainer.appendChild(this._mediaElement.element);
        this._adContainer.appendChild(this.iconsLayer);
        this._mediaElement.initElement();
        this.showCompanion();
    };
    var resize = function(isFullScreen) {
        if (!this._resizable) {
            return;
        }
        var adElement = this._mediaElement.element;
        var style = adElement.style;
        style.position = "absolute";
        if (isFullScreen) {
            style.top = "0";
            style.left = "0";
            style.width = "100%";
            style.height = "100%";
        } else {
            var bounds = this.calculateViewBounds(this._adContainer.offsetWidth, this._adContainer.offsetHeight, this.getAdWidth(), this.getAdHeight(), this.getAdScalable(), this.getAdMaintainAspectRatio());
            style.top = bounds.y + "px";
            style.left = bounds.x + "px";
            style.width = bounds.width + "px";
            style.height = bounds.height + "px";
        }
    };
    var stop = function() {
        LOGGER.debug("stop", this._mediaElement);
        if (this._mediaElement) {
            this._mediaElement.stop();
        } else {
            this.complete(true);
        }
    };
    var skip = function() {
        LOGGER.debug("skip", this._mediaElement);
        if (this._mediaElement) {
            this._mediaElement.skip();
        } else {
            this.complete(true);
        }
    };
    var complete = function(force, event) {
        LOGGER.debug("complete");
        this._adViewabilityTracker.unbind();
        if (this._mediaElement && this._mediaElement.element.parentNode == this._adContainer) {
            this._adContainer.removeChild(this._mediaElement.element);
        }
        var error;
        if (this._mediaElement) {
            error = this._mediaElement.error;
            var fallbackMediaElement = this._mediaElement.fallbackMediaElement;
            if (error && fallbackMediaElement) {
                fallback.call(this, fallbackMediaElement);
                return;
            }
        }
        var ev = new vdb.events.Event(VastEngineEvent.COMPLETE);
        if (event) {
            ev.data = event.data;
            ev.currentTime = event.currentTime;
        }
        ev.force = force;
        this.dispatchEvent(ev);
        if (error) {
            this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_ERROR));
        } else {
            if (!force) {
                this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_FINISHED));
            } else {
                this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_FORCE_FINISHED));
            }
        }
    };
    var fallback = function(mediaElement) {
        LOGGER.debug("Fallback to", mediaElement);
        this._mediaElement = mediaElement;
        this._mediaElement.adView = this;
        this._mediaElement.load();
    };
    var showCompanion = function() {
    };
    var dispatchVastEvent = function(eventType, data) {
        LOGGER.debug("dispatchVastEvent", eventType, data);
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(eventType, this.creative, null, data));
    };
    var dispatchVastTrackerEvent = function(trackingType, data) {
        LOGGER.debug("dispatchVastTrackerEvent", trackingType, data);
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VideoTrackingEvent(trackingType, this.creative, data));
    };
    var dispatchClickThrough = function(defaultURL, useDefault) {
        LOGGER.debug("dispatchClickThrough", defaultURL);
        var clickThrough = this.getClickThrough();
        if ((!clickThrough || useDefault) && defaultURL) {
            clickThrough = defaultURL;
        }
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(vdb.html5.ads.modules.vast.event.VastEvent.CLICK, this.creative, clickThrough));
    };
    var setVolume = function(volume) {
        if (this._mediaElement) {
            this._mediaElement.setVolume(volume);
        }
    };
    var pause = function() {
        if (this._mediaElement) {
            this._mediaElement.pause();
        }
    };
    var impression = function() {
        this.dispatchEvent(new vdb.events.Event(VastEngineEvent.IMPRESSION));
    };
    var _onPaused = function(e) {
        this.pauseTimer();
        this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_PAUSED, e));
    };
    var _onVolumeChanged = function(data) {
        this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_VOLUME_CHANGED, data));
    };
    var _onTimeUpdate = function(e) {
        e.config360 = this.ad.config360;
        this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_TIMEUPDATE, e));
        this.dispatchVastTrackerEvent(vdb.enums.VastEvents.PROGRESS, e);
    };
    var _onWaiting = function() {
        this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_WAITING));
    };
    var pauseTimer = function() {
        if (this._timer) {
            this._timer.pause();
        }
    };
    var resume = function() {
        if (this._mediaElement) {
            this._mediaElement.resume();
        }
    };
    var _onResumed = function() {
        this.resumeTimer();
        this.dispatchEvent(new vdb.events.Event(VastEngineEvent.AD_RESUMED));
    };
    var resumeTimer = function() {
        if (this._timer) {
            this._timer.resume();
        }
    };
    var getAdError = function() {
        if (this._mediaElement) {
            return this._mediaElement.error;
        }
        return null;
    };
    var calculateViewBounds = function(availableWidth, availableHeight, originalWidth, originalHeight, scalable, maintainAspectRatio) {
        if (scalable === undefined) {
            scalable = true;
        }
        if (maintainAspectRatio === undefined) {
            maintainAspectRatio = true;
        }
        var w = availableWidth;
        var h = availableHeight;
        if (!scalable) {
            w = originalWidth;
            h = originalHeight;
        } else {
            if (maintainAspectRatio) {
                var originRatio = originalWidth / originalHeight;
                var scaleRatio = w / h;
                if (scaleRatio < originRatio) {
                    h = originalHeight * w / originalWidth;
                } else {
                    w = originalWidth * h / originalHeight;
                }
            }
        }
        return{x:(availableWidth - w) / 2, y:(availableHeight - h) / 2, width:w, height:h};
    };
    var getAdWidth = function() {
        return-1;
    };
    var getAdHeight = function() {
        return-1;
    };
    var getAdScalable = function() {
        return true;
    };
    var getAdMaintainAspectRatio = function() {
        return true;
    };
    var linearChange = function(isLinear) {
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(vdb.html5.ads.modules.vast.model.CustomVastEvents.LINEAR_CHANGE, this.creative));
    };
    var getTimeOffsetEnd = function() {
        return this.ad.timeOffsetEnd || 0;
    };
    var getInitialStartTime = function() {
        return this.initialStartTime || 0;
    };
    return{_onPaused:_onPaused, _onVolumeChanged:_onVolumeChanged, _onTimeUpdate:_onTimeUpdate, _onWaiting:_onWaiting, _onResumed:_onResumed, pauseTimer:pauseTimer, resumeTimer:resumeTimer, type:"AdView", ad:null, creative:null, init:init, _mediaElement:null, _mediaContent:null, _timer:null, initialStartTime:null, iconsLayer:vdb.Utils.createElement("div", {"class":"ad-icons-layer", "style":"position: relative;"}), initView:initView, noResize:noResize, draw:draw, resize:resize, stop:stop, skip:skip,
        complete:complete, showCompanion:showCompanion, impression:impression, dispatchVastEvent:dispatchVastEvent, dispatchVastTrackerEvent:dispatchVastTrackerEvent, dispatchClickThrough:dispatchClickThrough, setVolume:setVolume, pause:pause, resume:resume, getAdError:getAdError, calculateViewBounds:calculateViewBounds, getAdWidth:getAdWidth, getAdHeight:getAdHeight, getAdScalable:getAdScalable, getAdMaintainAspectRatio:getAdMaintainAspectRatio, resolveMediaElement:function() {
        }, getAdConfigEntry:function() {
        }, getClickThrough:function() {
        }, linearChange:linearChange, getTimeOffsetEnd:getTimeOffsetEnd, fallback:fallback, getInitialStartTime:getInitialStartTime};
}());
(function(def) {
    def.BACKGROUND = "backgroundFade";
})(vdb.html5.ads.modules.vast.view.AdView);
vdb.html5.ads.modules.vast.view.inner = {};
vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement = vdb.EventBus.extend(function() {
    var initElement = function() {
        this.adView.initialStartTime = this._display.getCurrentTime();
    };
    var load = function() {
        this.element = this.createElement();
    };
    var onStart = function(data) {
        data = data || {};
        var creative = this.adView.creative;
        data.duration = creative.duration;
        data.skippable = creative.skippable || false;
        data.skipOffsetTime = creative.skipOffsetTime || null;
        data.skipOffsetPercent = creative.skipOffsetPercent || null;
        var sequence = this.adView.ad ? this.adView.ad.sequence : null;
        if (sequence) {
            data.sequence = sequence;
        }
        if (this._display) {
            this._display.emptyQueue();
        }
        data.seq = creative.skipOffsetPercent || null;
        fireAdStarting.call(this, data);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_STARTED, data));
    };
    var fireAdStarting = function(data) {
        if (!this.adStartingFired) {
            this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_STARTING, data));
            this.adStartingFired = true;
        }
    };
    var onImpression = function() {
        if (this._impressionProcessed) {
            return;
        }
        this._impressionProcessed = true;
        this.adView.impression();
        this.adView.dispatchVastEvent(vdb.html5.ads.modules.vast.event.VastEvent.IMPRESSION);
        this.track(vdb.enums.VastEvents.CREATIVE_VIEW);
    };
    var stop = function() {
        this.adView.complete(true);
    };
    var skip = function() {
        this.adView.stop();
    };
    var track = function(trackingType, data) {
        this.adView.dispatchVastTrackerEvent(trackingType, data);
    };
    var trackOnce = function(trackingType, data) {
        if (!this._trackedCache) {
            this._trackedCache = [];
        }
        if (this._trackedCache.indexOf(trackingType) == -1) {
            this._trackedCache.push(trackingType);
            this.track(trackingType, data);
        }
    };
    var isO2Shim = function() {
        var o2shimUrlMatcher = /^((http[s]?|ftp):\/)?\/?([^:\/\s]+)((\/\w+)*\/)o2shim/i;
        return o2shimUrlMatcher.test(this._url);
    };
    return{element:null, error:null, adView:null, init:function(display) {
        this._super();
        this._display = display;
    }, onStart:onStart, fireAdStarting:fireAdStarting, onImpression:onImpression, track:track, trackOnce:trackOnce, load:load, initElement:initElement, stop:stop, skip:skip, pause:function() {
    }, resume:function() {
    }, setVolume:function() {
    }, getDuration:function() {
        return-1;
    }, getRemainingTime:function() {
        return-1;
    }, getCurrentTime:function() {
        var remain = this.getRemainingTime();
        var duration = this.getDuration();
        return duration > 0 && remain > 0 ? duration - remain : 0;
    }, invokeAdMethod:function() {
    }, resize:function() {
    }, isO2Shim:isO2Shim};
}());
vdb.html5.ads.modules.vast.view.inner.ExternalMediaElement = vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement.extend(function() {
    var LOGGER = vdb.log.getLogger("ExternalMediaElement");
    var originalContentRestorers = {};
    var init = function(win) {
        this._super();
        this._win = win;
    };
    var initPeer = function(parentSelector, selectorType) {
        LOGGER.debug("initPeer", "parentSelector", parentSelector);
        try {
            this._document = this._win.document;
        } catch (e) {
            return;
        }
        if (selectorType === vdb.enums.CompanionSelectorType.CLASS) {
            this.target = this.container = this._document.getElementsByClassName(parentSelector)[0];
        } else {
            this.target = this.container = this._document.getElementById(parentSelector);
        }
        if (!this.container) {
            var parentWindow = vdb.utils.WindowUtil.getParentWindow(this._win);
            if (parentWindow && this._win != parentWindow) {
                this._win = parentWindow;
                initPeer.call(this, parentSelector, selectorType);
                return;
            }
        }
        var restoreContent = originalContentRestorers[parentSelector];
        if (restoreContent) {
            restoreContent();
        }
        _saveOriginalContent.call(this);
        if (this.container == null) {
            LOGGER.error("Cannot find element with id", parentSelector);
        }
    };
    var stop = function() {
        LOGGER.debug("stop");
        if (!this.keepCompanion) {
            _restoreOriginalContent.call(this);
            this.element.removeEventListener("click", this._clickCallback);
        }
        this._super();
    };
    var initElement = function() {
        LOGGER.debug("initElement");
        this.onStart();
        this.onImpression();
        originalContentRestorers[this.target.id] = _restoreOriginalContent.bind(this);
        _wrapInIframe.call(this);
    };
    var _wrapInIframe = function() {
        var iframe = document.createElement("iframe");
        (iframe.frameElement || iframe).style.cssText = "width:100%;height:100%;border:0;";
        iframe.marginWidth = "0";
        iframe.marginHeight = "0";
        this.element.appendChild(iframe);
        var doc = iframe.contentWindow ? iframe.contentWindow.document : iframe.contentDocument;
        doc.open();
        doc.write(this.html);
        doc.close();
        this._clickCallback = _onClick.bind(this);
        doc.body.addEventListener("click", this._clickCallback.bind(this));
    };
    var _saveOriginalContent = function() {
        for (this._fragmentWithOriginalContent = this._document.createDocumentFragment();this.target && this.target.firstChild;) {
            this._fragmentWithOriginalContent.appendChild(this.target.firstChild);
        }
    };
    var _restoreOriginalContent = function() {
        for (this.target.innerHTML = "";this._fragmentWithOriginalContent.firstChild;) {
            this.target.appendChild(this._fragmentWithOriginalContent.firstChild);
        }
        delete originalContentRestorers[this.target.id];
    };
    var _onClick = function() {
        LOGGER.debug("onClick");
        this.adView.dispatchClickThrough();
    };
    var load = function() {
        LOGGER.debug("load");
        this._super();
        this.adView.draw();
    };
    var createElement = function() {
        LOGGER.debug("createDisplayObject");
        return this.container;
    };
    var setKeepCompanion = function(keepCompanion) {
        this.keepCompanion = keepCompanion;
    };
    var onImpression = function() {
        this.track(vdb.enums.VastEvents.CREATIVE_VIEW);
    };
    return{init:init, html:"<span>Companion HTML</span>", initPeer:initPeer, stop:stop, initElement:initElement, load:load, createElement:createElement, setKeepCompanion:setKeepCompanion, onImpression:onImpression};
}());
vdb.html5.ads.modules.vast.view.inner.flash = {};
var Dependencies = vdb.enums.Dependencies;
vdb.html5.ads.modules.vast.view.inner.flash.BaseRunner = vdb.core.Class.extend(function() {
    var CONNECTION_DELAY = 100;
    var timeoutAttempts = 40;
    var FLASH_VERSION = "%FLASH_VERSION%";
    var RUNNER_SWF_FOLDER = "player/swf/" + FLASH_VERSION + "/";
    var LOGGER = vdb.log.getLogger("BaseRunner");
    var RUNNER_METHODS = ["showObject", "hideAll", "callMethod", "removeWrappedObject"];
    var _fillMethods = function() {
        var ready = true;
        var methods = RUNNER_METHODS.concat(this._customRunnerMethods);
        for (var i = 0;i < methods.length;++i) {
            var methodName = methods[i];
            var method = this._flashElement[methodName];
            if (method) {
                this._runner[methodName] = method.bind(this._flashElement);
            } else {
                if (!this._runner[methodName]) {
                    ready = false;
                }
            }
        }
        return ready;
    };
    var _embedRunner = function() {
        this._runnerFuture = new vdb.Future;
        this._virgin = true;
        this._flashId = "flash_runner_" + Math.random().toString().slice(2) + "_" + (new Date).getTime();
        var flashVars = {"flashObjectId":this._flashId};
        if (this._chromeHackAllowed) {
            this._chromeHacker = new vdb.utils.ChromeModeHack(this._config, this._slot, this._rootContainer);
        }
        var path = RUNNER_SWF_FOLDER + this._swfName;
        var flashElement = vdb.flashembed.embed(this._slot, {"id":this._flashId, "src":this._urls.getCdnUrl(path.replace(FLASH_VERSION, this._flashVersion)), "version":[11, 1], "wmode":"transparent", "allowscriptaccess":"always", "onFail":_flashEmbedFailed.bind(this, "Flash embedding failed")}, flashVars);
        this._attempts = 0;
        _connectToFlash.call(this, flashElement.getApi());
    };
    var _flashEmbedFailed = function(message) {
        this._runnerFuture.reject("BaseRunner failed with message: " + message);
    };
    var _connectToFlash = function(flashElement) {
        var events;
        if (flashElement) {
            this._flashElement = flashElement;
        }
        if (flashElement && (events = flashElement["events"]) && _fillMethods.call(this)) {
            if (this._chromeHacker) {
                this._chromeHacker.resetSettings();
            }
            try {
                this._events = events;
                events["readyCallback"]();
                this._runnerFuture.resolve();
            } catch (e) {
                this._runnerFuture.reject(e.toString());
            }
        } else {
            this._attempts += 1;
            if (this._attempts > timeoutAttempts) {
                _flashEmbedFailed.call(this, "Flash peer waiting timeout" + this._flashDetector.countFlashTimeouts());
            } else {
                setTimeout(_connectToFlash.bind(this, flashElement), CONNECTION_DELAY);
            }
        }
    };
    var _recreate = function() {
        this._slot.innerHTML = "";
        _embedRunner.call(this);
    };
    var _onVideoSelected = function() {
        if (this._virgin) {
            return;
        }
        _recreate.call(this);
    };
    var _cleanUp = function() {
        var elements = this._slot.parentNode.children;
        for (var i = 0;i < elements.length;++i) {
            var element = elements[i];
            if (element !== this._flashElement.parentNode) {
                vdb.Utils.removeFromParent(element);
            }
        }
        elements = this._slot.children;
        for (var y = 0;y < elements.length;++y) {
            element = elements[y];
            if (element !== this._flashElement) {
                vdb.Utils.removeFromParent(element);
            }
        }
    };
    return{init:function(dependencies) {
        var Dependencies = vdb.enums.Dependencies;
        this._urls = dependencies[Dependencies.URLS];
        this._config = dependencies[Dependencies.CONFIG];
        this._flashVersion = this._config.getFlashVersion() || "latest";
        this._environment = dependencies[Dependencies.ENVIRONMENT];
        this._eventBus = dependencies[Dependencies.EVENT_BUS];
        this._rootContainer = dependencies[Dependencies.ROOT_CONTAINER];
        this._flashDetector = dependencies[Dependencies.FLASH_DETECTOR];
        var adContainer = dependencies[Dependencies.AD_CONTAINER];
        vdb.dom.embedCssToHead(".flash-runner{width:100%;height:100%;position:absolute;z-index:-100}");
        this._runner = {};
        this._wrapper = vdb.Utils.createElement("div", {"class":"flash-runner"}, adContainer);
        this._wrapper.style.width = "100%";
        this._wrapper.style.height = "100%";
        this._slot = (new vdb.utils.HtmlInjector(this._wrapper)).injectIFrame("").contentDocument.body;
        this._chromeHackAllowed = this._config.getMidrollWorkaround();
        this._config.useMidrollWorkaround(false);
        this._environment.addEventListener(vdb.events.EnvironmentEvent.VIDEO_SELECTED, _onVideoSelected.bind(this));
        this._eventBus.addEventListener(vdb.events.AdEvent.AD_BLOCKER_COMPLETE, _cleanUp.bind(this));
        _embedRunner.call(this);
    }, getInitPromise:function() {
        return this._runnerFuture.getPromise().then(function() {
            return this;
        }.bind(this));
    }, callMethod:function() {
        if (this._runner) {
            return this._runner["callMethod"].apply(this._runner, arguments);
        } else {
            LOGGER.error("Calling runner before it's ready, arguments: " + arguments.join(" "));
        }
    }, removeWrappedObject:function(id) {
        this._runner["removeWrappedObject"](id);
    }, addEventListener:function(id, event, listener) {
        var events = this._runner["events" + id];
        events.addEventListener(event, listener);
    }, removeEventListener:function(id, event, listener) {
        var events = this._runner["events" + id];
        events.removeEventListener(event, listener);
    }, hide:function() {
        this._wrapper.style.visibility = "hidden";
    }, show:function() {
        this._wrapper.style.zIndex = 2;
        this._wrapper.style.visibility = "visible";
    }};
}(), [Dependencies.URLS, Dependencies.FLASH_DETECTOR, Dependencies.AD_CONTAINER, Dependencies.ENVIRONMENT, Dependencies.CONFIG, Dependencies.EVENT_BUS, Dependencies.ROOT_CONTAINER]);
vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper = vdb.EventBus.extend(function() {
    return{init:function(runner, id) {
        this._super();
        this._runner = runner;
        this._id = id;
    }, callMethod:function() {
        var args = [this._id].concat(Array.prototype.slice.call(arguments));
        try {
            return this._runner.callMethod.apply(this._runner, args);
        } catch (e) {
        }
        this.dispatchEvent(vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.CRITICAL_ERROR);
        return undefined;
    }, addEventListener:function(eventName, listener) {
        if (eventName === vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.CRITICAL_ERROR) {
            this._super(eventName, listener);
            return;
        }
        this._runner.addEventListener(this._id, eventName, listener);
    }, removeEventListener:function(eventName, listener) {
        if (eventName === vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.CRITICAL_ERROR) {
            this._super(eventName, listener);
            return;
        }
        this._runner.removeEventListener(this._id, eventName, listener);
    }};
}());
vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.CRITICAL_ERROR = "FlashObjectWrapper.CRITICAL_ERROR";
vdb.html5.ads.modules.vast.view.inner.flash.FlashVPAID = vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.extend(function() {
    return{init:function(runner, id) {
        this._super(runner, id);
        this._listenersMap = [];
    }, "initAd":function(width, height, viewMode, desiredBitrate, creativeData) {
        creativeData = creativeData["AdParameters"] || "";
        this.callMethod("initAd", width, height, viewMode, desiredBitrate, creativeData, "");
    }, "startAd":function() {
        this.callMethod("startAd");
    }, "stopAd":function() {
        this.callMethod("stopAd");
    }, "setAdVolume":function(value) {
        this.callMethod("setAdVolume", value);
    }, "getAdVolume":function() {
        return this.callMethod("getAdVolume");
    }, "resizeAd":function(width, height, viewMode) {
        this.callMethod("resizeAd", width, height, viewMode);
    }, "pauseAd":function() {
        this.callMethod("pauseAd");
    }, "resumeAd":function() {
        this.callMethod("resumeAd");
    }, "collapseAd":function() {
        this.callMethod("collapseAd");
    }, "expandAd":function() {
        this.callMethod("expandAd");
    }, "getAdExpanded":function() {
        return this.callMethod("getAdExpanded");
    }, "getAdSkippableState":function() {
        return this.callMethod("getAdSkippableState");
    }, "skipAd":function() {
        this.callMethod("skipAd");
    }, "getAdWidth":function() {
        return this.callMethod("getAdWidth");
    }, "getAdHeight":function() {
        return this.callMethod("getAdHeight");
    }, "getAdDuration":function() {
        return this.callMethod("getAdDuration");
    }, "getAdLinear":function() {
        return this.callMethod("getAdLinear");
    }, "getAdRemainingTime":function() {
        return this.callMethod("getAdRemainingTime");
    }, "getAdIcons":function() {
        return this.callMethod("getAdIcons");
    }, "getAdCompanions":function() {
        return this.callMethod("getAdCompanions");
    }, "handshakeVersion":function(playerVPAIDVersion) {
        return this.callMethod("handshakeVersion", playerVPAIDVersion);
    }, "subscribe":function(listener, eventName, context) {
        var boundListener = listener;
        if (context) {
            boundListener = listener.bind(context);
            this._listenersMap.push({listener:listener, boundListener:boundListener});
        }
        this.addEventListener(eventName, boundListener);
    }, "unsubscribe":function(listener, eventName) {
        for (var i = 0;i < this._listenersMap.length;++i) {
            var node = this._listenersMap[i];
            if (listener === node.listener) {
                this.removeEventListener(eventName, node.boundListener);
                return;
            }
        }
        this.removeEventListener(eventName, listener);
    }};
}());
vdb.html5.ads.modules.vast.view.inner.flash.FlashVPAID.SOUND_VIOLATION = "VPAIDWrapper.SOUND_VIOLATION";
vdb.html5.ads.modules.vast.view.inner.flash.FlvPlayer = vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.extend(function() {
    return{init:function(runner, id) {
        this._super(runner, id);
    }, getBytesLoaded:function() {
        return this.callMethod("getBytesLoaded");
    }, getBytesTotal:function() {
        return this.callMethod("getBytesTotal");
    }, getTotalTime:function() {
        return this.callMethod("getTotalTime");
    }, getCurrentTime:function() {
        return this.callMethod("getCurrentTime");
    }, getCurrentPercent:function() {
        return this.callMethod("getCurrentPercent");
    }, seek:function(time) {
        this.callMethod("seek", time);
    }, stop:function() {
        this.callMethod("stop");
    }, pause:function() {
        this.callMethod("pause");
    }, resume:function() {
        this.callMethod("resume");
    }, getState:function() {
        return this.callMethod("getState");
    }, getIsPlaying:function() {
        return this.callMethod("getIsPlaying");
    }, play:function(url) {
        this.callMethod("play", url);
    }, setSoundTransform:function(volume) {
        this.callMethod("setSoundTransform", volume);
    }, setSize:function(width, height) {
        this.callMethod("setSize", width, height);
    }, destroy:function() {
        this._runner.removeWrappedObject(this._id);
        this._runner.hide();
    }};
}());
vdb.html5.ads.modules.vast.view.inner.flash.FLVRunner = vdb.html5.ads.modules.vast.view.inner.flash.BaseRunner.extend(function() {
    var SWF_NAME = "flv-runner.swf";
    return{init:function(dependencies) {
        this._swfName = SWF_NAME;
        this._customRunnerMethods = ["addFLVPlayer"];
        this._super(dependencies);
    }, addFLVPlayer:function() {
        this._virgin = false;
        var flvPlayerFuture = new vdb.Future;
        this._runnerFuture.getPromise().then(function() {
            var id = this._runner["addFLVPlayer"]();
            var events = this._runner["events" + id] = this._flashElement["events" + id];
            events["readyCallback"]();
            var flvPlayer = new vdb.html5.ads.modules.vast.view.inner.flash.FlvPlayer(this, id);
            flvPlayerFuture.resolve(flvPlayer);
        }.bind(this), flvPlayerFuture.reject.bind(flvPlayerFuture));
        return flvPlayerFuture.getPromise();
    }};
}());
vdb.html5.ads.modules.vast.view.inner.flash.VpaidRunner = vdb.html5.ads.modules.vast.view.inner.flash.BaseRunner.extend(function() {
    var SWF_NAME = "vpaid-runner.swf";
    var _onVPAIDReady = function(future, id) {
        future.resolve(new vdb.html5.ads.modules.vast.view.inner.flash.FlashVPAID(this, id));
    };
    var _onVPAIDError = function(future, id) {
        future.reject("VPAID number " + id + " failed.");
    };
    return{init:function(dependencies) {
        this._swfName = SWF_NAME;
        this._customRunnerMethods = ["addVPAID"];
        this._super(dependencies);
    }, addVPAID:function(url) {
        this._virgin = false;
        var vpaidFuture = new vdb.Future;
        this._runnerFuture.getPromise().then(function() {
            var id;
            try {
                id = this._runner["addVPAID"](url);
                var events = this._runner["events" + id] = this._flashElement["events" + id];
                events["readyCallback"]();
                events.addEventListener("VPAIDWrapper.READY", _onVPAIDReady.bind(this, vpaidFuture, id));
                events.addEventListener("VPAIDWrapper.ERROR", _onVPAIDError.bind(this, vpaidFuture, id));
            } catch (e) {
                vpaidFuture.reject("Critical problem with vpaid initialisation");
            }
        }.bind(this), vpaidFuture.reject.bind(vpaidFuture));
        return vpaidFuture.getPromise();
    }};
}());
vdb.html5.ads.modules.vast.view.inner.FlvMediaElement = vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement.extend(function() {
    var LOGGER = vdb.log.getLogger("FlvMediaElement");
    var START_TIMEOUT = 3E3;
    var ErrorCodes = vdb.html5.ads.modules.vast.errorCodes;
    var init = function(display, videoUrl, flashRunnerPromise, rootContainer, adContainer) {
        this._super(display);
        LOGGER.debug("init", videoUrl);
        this._videoUrl = videoUrl;
        this._flashRunnerPromise = flashRunnerPromise;
        this._rootContainer = rootContainer;
        this._adContainer = adContainer;
        this._playerFuture = new vdb.Future;
    };
    var load = function() {
        this._super();
        this.adView.draw();
    };
    var stopByError = function(message) {
        LOGGER.debug("stopByError", message);
        clearTimeout(this._startTimer);
        this.error = new vdb.html5.ads.modules.vast.ex.VastError(ErrorCodes.MEDIA_FILE_DISPLAYING.code, message);
        this.stop();
    };
    var onError = function() {
        this.error = new vdb.html5.ads.modules.vast.ex.VastError(ErrorCodes.MEDIA_FILE_DISPLAYING.code, "Can not get flv runner");
        stopByError.call(this, this.error);
    };
    var _killByTimer = function() {
        stopByError.call(this, "flv ad not started in " + START_TIMEOUT + "ms");
    };
    var redispatchMouseMove = function(e) {
        var event;
        if (vdb.Utils.isIE) {
            event = document.createEvent("MouseEvent");
            event.initEvent(e.type, !e["\ufeffcancelBubble"], e["\ufeffcancelable"]);
        } else {
            event = new MouseEvent(e.type, e);
        }
        this._rootContainer.dispatchEvent(event);
    };
    var _onWrapperError = function() {
        stopByError.call(this, "Internal wrapper error");
    };
    var _clickHandler = function() {
        if (this.adView) {
            this.adView.dispatchClickThrough();
        }
    };
    var onVideoStart = function() {
        this._runner.show();
        this.adView.startRemainingTimer();
        this.trackOnce(vdb.enums.VastEvents.START);
        this.onStart();
        this.onImpression();
    };
    var _onVideoPause = function() {
        this.track(vdb.enums.VastEvents.PAUSE);
        this.adView._onPaused();
    };
    var stateChange = function() {
        var st = this._player.getState();
        clearTimeout(this._startTimer);
        if (st === "playing") {
            onVideoStart.call(this);
        } else {
            if (st === "paused") {
                _onVideoPause.call(this);
            } else {
                if (st === "buffering" || st === "loading") {
                    this.adView._onWaiting();
                } else {
                    if (st === "stopped") {
                        this.onVideoEnd();
                    } else {
                        if (st === "resumed") {
                            this.track(vdb.enums.VastEvents.RESUME);
                            this.adView._onResumed();
                        }
                    }
                }
            }
        }
    };
    var checkVideoTime = function(percentage) {
        percentage = percentage || this._player.getCurrentPercent();
        if (percentage > .25) {
            this.trackOnce(vdb.enums.VastEvents.FIRST_QUARTILE);
        }
        if (percentage > .5) {
            this.trackOnce(vdb.enums.VastEvents.MIDPOINT);
        }
        if (percentage > .75) {
            this.trackOnce(vdb.enums.VastEvents.THIRD_QUARTILE);
        }
    };
    var onVideoTimeUpdate = function() {
        var e = {data:{}};
        e.data["currentTime"] = this._player.getCurrentTime();
        e.data["duration"] = this._player.getTotalTime();
        this.adView._onTimeUpdate(e.data);
        checkVideoTime.call(this);
    };
    var setupListeners = function() {
        var EventContext = vdb.events.EventContext;
        var CRITICAL_ERROR = vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.CRITICAL_ERROR;
        this._eventContext = EventContext.group(EventContext.bind(this._player, "WrapperError", _onWrapperError.bind(this)), EventContext.bind(this._player, "click", _clickHandler.bind(this)), EventContext.bind(this._player, "stateChange", stateChange.bind(this)), EventContext.bind(this._player, "heartbeat", onVideoTimeUpdate.bind(this)), EventContext.bind(this._player, CRITICAL_ERROR, _onWrapperError.bind(this)));
    };
    var onFLVPlayerReady = function(player) {
        this._player = player;
        this._playerFuture.resolve(player);
        this._startTimer = setTimeout(_killByTimer.bind(this), START_TIMEOUT);
        this._mouseMoveRedispatcher = redispatchMouseMove.bind(this);
        this._adContainer.addEventListener("mousemove", this._mouseMoveRedispatcher, true);
        setupListeners.call(this);
        this._player.play(this._videoUrl);
        this._player.setSoundTransform(this._value || 0);
    };
    var onRunnerReady = function(runner) {
        this._runner = runner;
        runner.addFLVPlayer(this._videoUrl).then(onFLVPlayerReady.bind(this), onError.bind(this));
    };
    var initElement = function() {
        this._flashRunnerPromise.then(onRunnerReady.bind(this), onError.bind(this));
    };
    var resizeAd = function() {
        if (this._player) {
            this._player.setSize(this._display.getWidth(), this._display.getHeight());
        } else {
            this._playerFuture.getPromise().then(function(player) {
                player.setSize(this._display.getWidth(), this._display.getHeight());
            }.bind(this));
        }
    };
    var resize = function() {
        this._super();
        resizeAd.call(this);
    };
    var _unsubscribe = function() {
        if (this._eventContext) {
            this._eventContext.unbind();
        }
        if (this._mouseMoveRedispatcher) {
            this._adContainer.removeEventListener("mousemove", this._mouseMoveRedispatcher);
            this._mouseMoveRedispatcher = null;
        }
        if (this._player) {
            this._player.destroy();
        }
    };
    var onVideoEnd = function(event) {
        this.trackOnce(vdb.enums.VastEvents.COMPLETE);
        _unsubscribe.call(this);
        this.adView.complete(false, event);
    };
    var stop = function() {
        LOGGER.debug("stop");
        if (this._runner) {
            this._runner.hide();
        }
        _unsubscribe.call(this);
        this._super();
    };
    var pause = function() {
        this._player.pause();
    };
    var resume = function() {
        this._player.resume();
    };
    var createElement = function() {
        return vdb.dom.nodeFromHTML("<div/>");
    };
    var setVolume = function(value) {
        this._volume = value;
        if (this._player) {
            this._player.setSoundTransform(value);
        }
        this.adView._onVolumeChanged({volume:this._volume, muted:this._volume === 0});
    };
    var getDuration = function() {
        return this._player.getTotalTime();
    };
    var getRemainingTime = function() {
        return this.getDuration() - this._player.getCurrentTime();
    };
    var isPreroll = function() {
        var configEntry = this.adView.getAdConfigEntry();
        return configEntry && configEntry.getType() === vdb.enums.AdType.PREROLL;
    };
    return{init:init, load:load, initElement:initElement, onVideoStart:onVideoStart, onVideoTimeUpdate:onVideoTimeUpdate, checkVideoTime:checkVideoTime, onVideoEnd:onVideoEnd, stop:stop, pause:pause, resume:resume, createElement:createElement, setVolume:setVolume, getDuration:getDuration, getRemainingTime:getRemainingTime, isPreroll:isPreroll, resize:resize};
}());
vdb.html5.ads.modules.vast.view.inner.HTMLResourceMediaElement = vdb.html5.ads.modules.vast.view.inner.ExternalMediaElement.extend(function() {
    var init = function(html, win) {
        this._super(win);
        this.html = html;
    };
    return{html:null, init:init};
}());
vdb.html5.ads.modules.vast.view.inner.IFrameResourceMediaElement = vdb.html5.ads.modules.vast.view.inner.ExternalMediaElement.extend(function() {
    var init = function(src, win) {
        this._super(win);
        this.html = '<iframe width="100%" height="100%" marginwidth="0" marginheight="0" frameborder="0" scrolling="no" src="' + src + '"></iframe>';
    };
    return{html:null, init:init};
}());
vdb.html5.ads.modules.vast.view.inner.LoadableImageElement = vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement.extend(function() {
    var LOGGER = vdb.log.getLogger("LoadableImageElement");
    var init = function(url, display) {
        this._super(display);
        LOGGER.debug("init", url);
        this._url = url;
    };
    var createElement = function() {
        LOGGER.debug("createDisplayObject");
        var img = vdb.dom.nodeFromHTML('<img style="position:absolute;z-index:1"/>');
        this._imgEvents = vdb.events.EventContext.group(vdb.events.EventContext.bind(img, "load", this.onImageLoaded.bind(this)), vdb.events.EventContext.bind(img, "error", this.onImageError.bind(this)));
        img.src = this._url.replace(/\s+/g, "");
        return img;
    };
    var onImageLoaded = function() {
        LOGGER.info("onImageLoaded", this._url);
        this.element.addEventListener("click", _onImageClick.bind(this));
        _draw.call(this);
    };
    var onImageError = function(error) {
        LOGGER.debug("onImageError", error);
        if (this.element.offsetWidth) {
            onImageLoaded.call(this);
            return;
        }
        this.adView.dispatchVastEvent(vdb.html5.ads.modules.vast.event.VastEvent.ERROR, {error:error});
        this.adView.complete(true);
    };
    var _draw = function() {
        LOGGER.debug("draw");
        this.onStart();
        this.onImpression();
        this.adView.draw();
    };
    var _onImageClick = function() {
        LOGGER.debug("onImageClick");
        this.adView.dispatchClickThrough(null);
    };
    var stop = function() {
        LOGGER.debug("stop");
        if (this._imgEvents) {
            this._imgEvents.unbind();
        }
        this._super();
    };
    return{init:init, createElement:createElement, stop:stop, onImageLoaded:onImageLoaded, onImageError:onImageError};
}());
vdb.html5.ads.modules.vast.view.IconElement = vdb.html5.ads.modules.vast.view.inner.LoadableImageElement.extend(function() {
    var LOGGER = vdb.log.getLogger("IconElement");
    var init = function(icon, display) {
        LOGGER.debug("create", icon);
        this.icon = icon || {};
        this._super(this.icon.staticResourceUrl, display);
    };
    var showInAd = function(adView) {
        this.adView = adView;
        this.load();
        var style = {width:this.icon.width + "px", height:this.icon.height + "px", zIndex:3};
        vdb.Utils.setStyle(this.element, style);
        this.adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR, onAdComplete.bind(this));
        this.adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_FINISHED, onAdComplete.bind(this));
        this.adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_FORCE_FINISHED, onAdComplete.bind(this));
    };
    var onAdComplete = function() {
        if (this._imgEvents) {
            this._imgEvents.unbind();
        }
        removeIcon.call(this);
    };
    var removeIcon = function() {
        vdb.Utils.removeFromParent(this.element);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_HIDE_ICON));
    };
    var onImageError = function(error) {
        this.adView.dispatchVastEvent(vdb.html5.ads.modules.vast.event.VastEvent.ERROR, {error:error});
    };
    var onAdTimeUpdate = function(e) {
        if (e.data.currentTime > this.icon.offset) {
            this.adView.iconsLayer.appendChild(this.element);
            if (this.icon.duration === 0) {
                this.adView.removeEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_TIMEUPDATE, this.timeUpdateHandler);
            }
        }
        if (this.icon.duration > 0 && e.data.currentTime > this.icon.offset + this.icon.duration) {
            if (this.element.parentElement) {
                removeIcon.call(this);
            }
            this.adView.removeEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_TIMEUPDATE, this.timeUpdateHandler);
        }
    };
    var setIconPosition = function() {
        switch(this.icon.xPosition) {
            case "left":
                this.element.style.left = "0px";
                break;
            case "right":
                this.element.style.right = "0px";
                break;
            default:
                if (typeof this.icon.xPosition === "number") {
                    this.element.style.left = this.icon.xPosition + "px";
                }
                ;
        }
        switch(this.icon.yPosition) {
            case "bottom":
                this.element.style.bottom = "0px";
                break;
            default:
                this.element.style.top = (typeof this.icon.yPosition === "number" ? this.icon.yPosition : 0) + "px";
        }
    };
    var track = function(url) {
        var tracker = vdb.dom.createElement("img");
        tracker.src = url;
    };
    var onImageLoaded = function() {
        var that = this;
        setIconPosition.call(this);
        if (this.icon.clickThrough) {
            this.element.style.cursor = "pointer";
            this.element.addEventListener("click", function(e) {
                e.stopPropagation();
                that.adView.dispatchClickThrough(that.icon.clickThrough, true);
            });
        }
        if (this.icon.clickTracking) {
            this.element.addEventListener("click", function() {
                track(that.icon.clickTracking);
            });
        }
        if (this.icon.viewTracking) {
            track(this.icon.viewTracking);
        }
        if (this.icon.offset === 0) {
            this.adView.iconsLayer.appendChild(this.element);
        }
        if (this.icon.offset !== 0 || this.icon.duration !== 0) {
            this.timeUpdateHandler = onAdTimeUpdate.bind(this);
            this.adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_TIMEUPDATE, this.timeUpdateHandler);
        }
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_SHOW_ICON));
    };
    return{init:init, showInAd:showInAd, onImageLoaded:onImageLoaded, onImageError:onImageError};
}());
vdb.html5.ads.modules.vast.view.inner.SimpleVideoMediaElement = vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement.extend(function() {
    var LOGGER = vdb.log.getLogger("SimpleVideoMediaElement");
    var STATE = {CREATED:"created", PLAYING:"playing", PAUSED:"paused", STOPPED:"stopped"};
    var init = function(display, videoUrl, adContainer) {
        this._super(display);
        LOGGER.debug("init", videoUrl);
        this._state = STATE.CREATED;
        this._videoUrl = videoUrl;
        this._adContainer = adContainer;
    };
    var createElement = function() {
        return vdb.dom.nodeFromHTML("<div style='display: none;'/>");
    };
    var _setupEventListeners = function() {
        var EC = vdb.events.EventContext;
        var VideoEvent = vdb.events.VideoEvent;
        var adDispatcher = this._display.getAdEventDispatcher();
        this._eventContext = EC.group(EC.bind(adDispatcher, VideoEvent.VIDEO_CLICK, _clickHandler.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_ERROR, _errorHandler.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_PLAY, this.onVideoPlay.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_STARTED, this.onVideoStart.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_RESUME, _onVideoResume.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_PAUSE, _onVideoPause.bind(this)), EC.bind(adDispatcher,
            VideoEvent.VIDEO_END, this.onVideoEnd.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_VOLUME_CHANGED, _onVolumeChanged.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_TIMEUPDATE, this.onVideoTimeUpdate.bind(this)), EC.bind(adDispatcher, VideoEvent.VIDEO_WAITING, _onVideoWaiting.bind(this)), EC.bind(this._adContainer, "click", _clickHandler.bind(this)));
        var style = this._display.getElement().style;
        if (style && this.adView.creative.clickThroughUrl) {
            style.cursor = "pointer";
        }
    };
    var _clickHandler = function() {
        LOGGER.debug("mouseClickHandler");
        if (!this._adClickedTimeout) {
            this.adView.dispatchClickThrough();
            this._adClickedTimeout = setTimeout(function() {
                this._adClickedTimeout = null;
            }.bind(this), 100);
        }
    };
    var _errorHandler = function(e) {
        this.stopByError(e.message, e.code);
    };
    var onVideoPlay = function() {
        this._state = STATE.PLAYING;
    };
    var onVideoStart = function() {
        if (this._impressionProcessed) {
            return;
        }
        this.adView.startRemainingTimer();
        this.trackOnce(vdb.enums.VastEvents.START);
        this.onStart();
        this.onImpression();
    };
    var _onVideoPause = function() {
        this._state = STATE.PAUSED;
        this.track(vdb.enums.VastEvents.PAUSE);
        this.adView._onPaused();
    };
    var _onVolumeChanged = function(data) {
        this.adView._onVolumeChanged(data);
        data = data || {};
        if (data.muted === true) {
            this.track(vdb.enums.VastEvents.MUTE);
        } else {
            this.track(vdb.enums.VastEvents.UNMUTE);
        }
    };
    var onVideoTimeUpdate = function(e) {
        this.adView._onTimeUpdate(e);
        checkVideoTime.call(this);
    };
    var _onVideoWaiting = function() {
        this.adView._onWaiting();
    };
    var _onVideoResume = function() {
        this._state = STATE.PLAYING;
        this.track(vdb.enums.VastEvents.RESUME);
        this.adView._onResumed();
    };
    var onVideoEnd = function(event) {
        this._display.resetContext();
        this._state = STATE.STOPPED;
        this.trackOnce(vdb.enums.VastEvents.COMPLETE);
        this._eventContext.unbind();
        this.adView.complete(false, event);
    };
    var load = function() {
        this._super();
        this.adView.draw();
    };
    var createVideo = function() {
        var video = new vdb.model.Video({"videoUrls":[this._videoUrl], "title":"Video"});
        var config360 = this.adView.ad && this.adView.ad.config360;
        if (config360) {
            video.data360 = {projectionType:config360["projectionType"] && vdb.Utils.containsValue(vdb.enums.video.ProjectionType360, config360["projectionType"].toLowerCase()) ? config360["projectionType"] : vdb.enums.video.ProjectionType360.EQUIRECTANGULAR};
        }
        return video;
    };
    var initElement = function() {
        function onVideoSet() {
            self._videoSet = true;
            _setupEventListeners.call(self);
            self._display.play();
        }
        var self = this;
        LOGGER.debug("initElement");
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.CONTENT_PAUSE_REQUESTED));
        var video = createVideo.call(this);
        if (this.isPreroll() && this._display.isPreroll()) {
            stopByError.call(this, "Display already busy with another preroll");
            return;
        }
        var promise = this.isPreroll() ? this._display.setPreroll(video) : this._display.setMidroll(video);
        if (promise && promise.then) {
            promise.then(onVideoSet);
        } else {
            onVideoSet();
        }
    };
    var isPreroll = function() {
        var configEntry = this.adView.getAdConfigEntry();
        return configEntry && configEntry.getType() === vdb.enums.AdType.PREROLL;
    };
    var stop = function() {
        LOGGER.debug("stop");
        this._state = STATE.STOPPED;
        if (this._videoSet) {
            this._eventContext.unbind();
            this._display.stop();
            this._display.resetContext();
            var style = this._display.getElement().style;
            if (style) {
                style.cursor = "";
            }
        }
        this._super();
    };
    var pause = function() {
        if (this._state == STATE.PLAYING) {
            this._display.pause();
        }
    };
    var resume = function() {
        if (this._state == STATE.PAUSED) {
            this._display.play();
        }
    };
    var getRemainingTime = function() {
        return this._display.getRemainingTime();
    };
    var checkVideoTime = function(percentage) {
        percentage = percentage || this._display.getCurrentPercent();
        if (percentage > .25) {
            this.trackOnce(vdb.enums.VastEvents.FIRST_QUARTILE);
        }
        if (percentage > .5) {
            this.trackOnce(vdb.enums.VastEvents.MIDPOINT);
        }
        if (percentage > .75) {
            this.trackOnce(vdb.enums.VastEvents.THIRD_QUARTILE);
        }
    };
    var stopByError = function(message, videoCode) {
        LOGGER.debug("stopByError", message);
        this._state = STATE.STOPPED;
        var error = vdb.html5.ads.modules.vast.errorCodes.GENERAL_LINEAR_ERROR;
        var details = "video playback error";
        switch(videoCode) {
            case 1:
                break;
            case 2:
                error = vdb.html5.ads.modules.vast.errorCodes.FILE_NOT_FOUND;
                break;
            case 3:
                ;
            case 4:
                error = vdb.html5.ads.modules.vast.errorCodes.MEDIA_FILE_DISPLAYING;
                break;
            case 5:
                error = vdb.html5.ads.modules.vast.errorCodes.MEDIA_FILE_DISPLAYING;
                details = "autoplay issue";
        }
        this.error = new vdb.html5.ads.modules.vast.ex.VastError(error, details);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR), message);
        if (!this._impressionProcessed) {
            this.adView.dispatchVastEvent(vdb.html5.ads.modules.vast.event.VastEvent.ERROR, {error:error});
        }
        this.stop();
    };
    var setVolume = function(volume) {
        this._display.setVolume(volume);
        this._display.mute(volume == 0);
    };
    var getDuration = function() {
        return this._display.getDuration();
    };
    return{init:init, load:load, initElement:initElement, onVideoPlay:onVideoPlay, onVideoStart:onVideoStart, onVideoTimeUpdate:onVideoTimeUpdate, checkVideoTime:checkVideoTime, onVideoEnd:onVideoEnd, stop:stop, pause:pause, resume:resume, createElement:createElement, setVolume:setVolume, getDuration:getDuration, getRemainingTime:getRemainingTime, stopByError:stopByError, isPreroll:isPreroll};
}());
vdb.html5.ads.modules.vast.view.inner.StaticResourceMediaElement = vdb.html5.ads.modules.vast.view.inner.ExternalMediaElement.extend(function() {
    var LOGGER = vdb.log.getLogger("StaticResourceMediaElement");
    var init = function(src, mimeType, win) {
        this._super(win);
        mimeType = (mimeType || "").toLowerCase();
        if (mimeType.indexOf("image/") == 0 || mimeType == "") {
            this.html = '<img width="100%" height="100%" src="' + src + '" />';
        } else {
            if (mimeType == "application/x-javascript") {
                this.html = '<script src="' + src + '">\x3c/script>';
            } else {
                if (mimeType == "application/x-shockwave-flash") {
                    this.html = '<object width="100%" height="100%" data="' + src + '"></object>';
                } else {
                    LOGGER.warn("Non-supported mime type", mimeType);
                }
            }
        }
    };
    return{html:null, init:init};
}());
vdb.html5.ads.modules.vast.view.CompanionView = vdb.html5.ads.modules.vast.view.AdView.extend(function() {
    var LOGGER = vdb.log.getLogger("CompanionView");
    var ResourceType = vdb.html5.ads.modules.vast.model.ResourceType;
    var init = function(ad, creative, mediaContent, slot, adSystem) {
        LOGGER.debug("init", ad, creative, mediaContent, slot);
        this._super(null, vdb.dom.createDocumentFragment(), ad, creative, mediaContent, adSystem);
        this._slot = slot;
        this.noResize();
    };
    var resolveMediaElement = function() {
        LOGGER.debug("resolveMediaElement");
        var media = this._mediaContent.resources[0];
        var mediaElement;
        var win = this._adSystem.getInjector().resolveSync(vdb.enums.Dependencies.HOST_WINDOW_PROVIDER).getWindow();
        switch(media.type) {
            case ResourceType.HTML:
                mediaElement = new vdb.html5.ads.modules.vast.view.inner.HTMLResourceMediaElement(media.value, win);
                break;
            case ResourceType.IFRAME:
                mediaElement = new vdb.html5.ads.modules.vast.view.inner.IFrameResourceMediaElement(media.value, win);
                break;
            case ResourceType.STATIC:
                mediaElement = new vdb.html5.ads.modules.vast.view.inner.StaticResourceMediaElement(media.value, media.mimeType, win);
                break;
        }
        if (!mediaElement) {
            LOGGER.warn("Non-supported companion media type", media.type);
        } else {
            if (!mediaElement.html) {
                LOGGER.warn("Media element doesn't have any markup");
            } else {
                mediaElement.setKeepCompanion(this._slot && this._slot.keepCompanion);
                mediaElement.initPeer(this._slot.parentSelector, this._slot.selectorType);
                if (!mediaElement.container) {
                    LOGGER.warn("Media element could not find a container");
                } else {
                    var wrapper = vdb.dom.nodeFromHTML("<div style='width: " + this._slot.width + "px; height: " + this._slot.height + "px;'></div>");
                    mediaElement.container.appendChild(wrapper);
                    mediaElement.container = wrapper;
                    return mediaElement;
                }
            }
        }
        return this._super ? this._super() : null;
    };
    var draw = function() {
        this._mediaElement.initElement();
    };
    var getAdParameters = function() {
        return this._mediaContent.parameters;
    };
    var getAdMaintainAspectRatio = function() {
        return true;
    };
    var getAdScalable = function() {
        return false;
    };
    var getAdHeight = function() {
        return this._mediaContent.height;
    };
    var getAdWidth = function() {
        return this._mediaContent.width;
    };
    var getClickThrough = function() {
        return this._mediaContent.clickThroughUrl ? this._mediaContent.clickThroughUrl.url : null;
    };
    var dispatchVastTrackerEvent = function(trackingType) {
        if (trackingType == vdb.enums.VastEvents.CREATIVE_VIEW) {
            this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.CompanionTrackingEvent(trackingType, this.creative, this._mediaContent));
        }
    };
    var resume = function() {
        LOGGER.debug("resume");
    };
    var pause = function() {
        LOGGER.debug("pause");
    };
    return{init:init, draw:draw, resolveMediaElement:resolveMediaElement, getAdParameters:getAdParameters, getAdMaintainAspectRatio:getAdMaintainAspectRatio, getAdScalable:getAdScalable, getAdHeight:getAdHeight, getAdWidth:getAdWidth, getClickThrough:getClickThrough, dispatchVastTrackerEvent:dispatchVastTrackerEvent, resume:resume, pause:pause};
}());
vdb.html5.ads.modules.vast.view.inner.VPAIDMediaElement = vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement.extend(function() {
    function checkVPAIDInterface() {
        var api_2_0 = ["handshakeVersion", "initAd", "startAd", "stopAd", "skipAd", "resizeAd", "pauseAd", "resumeAd", "expandAd", "collapseAd", "subscribe", "unsubscribe"];
        for (var i = 0;i < api_2_0.length;i++) {
            var fname = api_2_0[i];
            if (typeof this._creative[fname] !== "function") {
                throw new Error("API function " + fname + " is missing");
            }
        }
        _callMethod.call(this, "handshakeVersion", VPAID_VERSION_SUPPORT);
        return true;
    }
    var LOGGER = vdb.log.getLogger("VPAIDMediaElement");
    var AdUserInteraction = vdb.enums.AdUserInteraction;
    var VPAID_VERSION_SUPPORT = "2.0";
    var DEFAULT_ERROR = vdb.html5.ads.modules.vast.errorCodes.GENERAL_VPAID_ERROR;
    var ViewMode = {NORMAL:"normal", THUMBNAIL:"thumbnail", FULLSCREEN:"fullscreen"};
    var Fullscreen = vdb.utils.Fullscreen;
    var utl;
    var noErrorMessages = ["There was an error in the google ad. AdError 1009: The VAST response document is empty."];
    var uniqueEvents = ["AdStarted", "AdStopped", "AdSkipped", "AdLoaded", "AdImpression"];
    var getCallbacks = function() {
        return{"AdStarted":_onStartAd, "AdStopped":_onStopAd, "AdSkipped":_onSkipAd, "AdLoaded":_onAdLoaded, "AdLinearChange":_onAdLinearChange, "AdSizeChange":_onAdSizeChange, "AdExpandedChange":_onAdExpandedChange, "AdSkippableStateChange":_onAdSkippableStateChange, "AdDurationChange":_onAdDurationChange, "AdRemainingTimeChange":_onAdRemainingTimeChange, "AdVolumeChange":_onAdVolumeChange, "AdImpression":_onAdImpression, "AdClickThru":_onAdClickThru, "AdInteraction":_onAdInteraction, "AdVideoStart":_onAdVideoStart,
            "AdVideoFirstQuartile":_onAdVideoFirstQuartile, "AdVideoMidpoint":_onAdVideoMidpoint, "AdVideoThirdQuartile":_onAdVideoThirdQuartile, "AdVideoComplete":_onAdVideoComplete, "AdUserAcceptInvitation":_onAdUserAcceptInvitation, "AdUserMinimize":_onAdUserMinimize, "AdUserClose":_onAdUserClose, "AdPaused":_onAdPaused, "AdPlaying":_onAdPlaying, "AdError":_onAdError, "AdLog":_onAdLog};
    };
    var setVPAIDCallbacks = function() {
        var callbacks = this.getCallbacks();
        var self = this;
        this._creativeEventDispatcher = {addEventListener:function(name, callback) {
            _callMethod.call(self, "subscribe", callback, name, self);
        }, removeEventListener:function(name, callback) {
            try {
                _callMethod.call(self, "unsubscribe", callback, name);
            } catch (e) {
            }
        }};
        for (var eventName in callbacks) {
            if (Object.prototype.hasOwnProperty.call(callbacks, eventName)) {
                _linkCallback.call(this, eventName);
            }
        }
        this._initialRemainingTime = 0;
    };
    var _linkCallback = function(eventName) {
        function callback() {
            try {
                if (uniqueEvents.indexOf(eventName) !== -1) {
                    if (this._eventsFired.indexOf(eventName) !== -1) {
                        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.AdHonestyErrorEvent.UNIQUE_ERROR, eventName));
                        return;
                    }
                    this._eventsFired.push(eventName);
                }
                callbacks[eventName].apply(this, arguments);
            } catch (e) {
                LOGGER.error("Failed to handle " + eventName + " event:", e);
            }
        }
        var callbacks = this.getCallbacks();
        this._callbacksContext.link(vdb.events.EventContext.bind(this._creativeEventDispatcher, eventName, callback.bind(this)));
    };
    var init = function(display, url, adType, rootContainer, config, adsConfig) {
        LOGGER.debug("init");
        utl = vdb.Utils;
        this._super(display);
        this._adType = adType;
        this._callbacksContext = vdb.events.EventContext.empty();
        this._volume = 1;
        this._url = url;
        this._rootContainer = rootContainer;
        this._config = config;
        this._adsConfig = adsConfig;
        this._eventsFired = [];
    };
    var load = function() {
        this._super();
        this.adView.noResize();
        this.adView.draw();
        _showHide.call(this, !_isInsideVideo.call(this));
    };
    var createElement = function() {
        return utl.createElement("div", {"style":"position: absolute; width: 100%; height: 100%; z-index: 1; text-align: left; top:0px;"});
    };
    var redispatchMouseMove = function(e) {
        var event;
        if (vdb.Utils.isIE) {
            event = document.createEvent("MouseEvent");
            event.initEvent(e.type, !e["\ufeffcancelBubble"], e["\ufeffcancelable"]);
        } else {
            event = new MouseEvent(e.type, e);
        }
        if (this._rootContainer !== e.currentTarget) {
            this._rootContainer.dispatchEvent(event);
        }
    };
    var _showHide = function(showHide) {
        this.element.style.visibility = showHide ? "visible" : "hidden";
    };
    var _showHideVideo = function(showHide) {
        if (!this._videoElement || !this._videoElement.style) {
            return;
        }
        this._videoElement.style.visibility = showHide ? "visible" : "hidden";
        this._videoElement.style.display = showHide ? "block" : "none";
    };
    var initElement = function() {
        LOGGER.debug("initElement");
        this._super();
        var frame = (new vdb.utils.HtmlInjector(this.element)).injectIFrame("");
        frame.style = "pointer-events: auto !important;";
        var wrapper = frame.contentDocument.body;
        vdb.dom.embedCssToHead("video{position:absolute;width:100%;height:100%;z-index:1}iframe{position:absolute;z-index:2;pointer-events:auto!important}", frame.contentDocument.head);
        onWrapperReady.call(this, wrapper);
    };
    var onWrapperReady = function(element) {
        var self = this;
        if (_isInsideVideo.call(this) || this._display.isPlaying()) {
            this._videoElement = utl.createVideoTag();
            element.appendChild(this._videoElement);
        } else {
            this._useMainVideoArea = true;
            this._display.blockByVPAIDPreroll();
            this._videoElement = this._display.getPrerollAreaElement();
        }
        _showHideVideo.call(this, !_isInsideVideo.call(this));
        _showHide.call(this, !_isInsideVideo.call(this));
        this._vpaidLoader = (new vdb.modules.ModuleLoader({container:element, scriptUrls:this._url, initFuncName:"window"})).setIsolated(true).setIsolateErrors(true).load(function(iwin, idoc) {
            if (vdb.Utils.isIE && idoc.readyState !== "complete") {
                vdb.events.addEventListener(idoc, "readystatechange", function() {
                    if (idoc.readyState === "complete") {
                        initialize.call(self, iwin, idoc);
                    }
                });
            } else {
                initialize.call(self, iwin, idoc);
            }
        });
    };
    var initialize = function(iwin, idoc) {
        var getVPAIDAd = iwin["getVPAIDAd"];
        if (typeof getVPAIDAd !== "function") {
            forceInitialization.call(this, "function getVPAIDAd is not exist");
            return;
        }
        this._creative = getVPAIDAd.call(iwin);
        if (!this._creative) {
            forceInitialization.call(this, "getVPAIDAd() global function is not found");
            return;
        }
        try {
            initializeVPAID.call(this, idoc.body);
        } catch (e) {
            forceInitialization.call(this, e.message);
        }
    };
    var forceInitialization = function(message) {
        this.error = new vdb.html5.ads.modules.vast.ex.VastError(DEFAULT_ERROR.code, message);
        this.trackVPAIDError(this.error);
        this.forceStop();
    };
    var initializeVPAID = function(item) {
        checkVPAIDInterface.call(this);
        setVPAIDCallbacks.call(this);
        initAd.call(this, item);
        item.addEventListener("mousemove", redispatchMouseMove.bind(this), true);
        item.addEventListener("mouseover", redispatchMouseMove.bind(this), true);
    };
    var getEnvironmentVars = function() {
        var content = utl.createElement("div", {"class":"vpaid-content", "style":"height: 100%"}, this._container);
        var topOffsetFuture = this._config.getAdParams().topOffsetFuture;
        return{"videoSlot":this._videoElement, "slot":content, "companionSlots":this._adsConfig.companionSlots, "videoSlotCanAutoPlay":true, "topOffsetPromise":topOffsetFuture ? topOffsetFuture.getPromise() : vdb.Promise.resolve()};
    };
    var isMidroll = function() {
        return this._adType === "Midroll";
    };
    var isOverlay = function() {
        return this._adType === vdb.enums.AdType.OVERLAY;
    };
    var _isInsideVideo = function() {
        return isMidroll.call(this) || isOverlay.call(this);
    };
    var initAd = function(container) {
        this._container = container;
        var width = container.offsetWidth;
        var height = container.offsetHeight;
        this._viewMode = ViewMode.NORMAL;
        var desiredBitrate = this.adView.getAdBitrate();
        var adParameters = this.adView.getAdParameters();
        var creativeData = {"AdParameters":adParameters && adParameters.value};
        var environmentVars = this.getEnvironmentVars();
        LOGGER.debug("initAd", width, height, this._viewMode, desiredBitrate, creativeData, environmentVars);
        _callMethod.call(this, "initAd", width, height, this._viewMode, desiredBitrate, creativeData, environmentVars);
    };
    var resize = function() {
        this._super();
        this._viewMode = Fullscreen.enabled() && Fullscreen.isFullscreen() ? ViewMode.FULLSCREEN : ViewMode.NORMAL;
        resizeAd.call(this, this._display.getWidth(), this._display.getHeight(), this._viewMode);
    };
    var _onAdError = function(data) {
        var message;
        if (utl.isObject(data)) {
            if (utl.isObject(data["data"])) {
                message = data["data"]["message"] || data["data"]["errorMessage"];
            } else {
                message = "Internal Vpaid Error";
            }
        } else {
            message = data;
        }
        LOGGER.warn("VPAID_UNIT:", message);
        if (noErrorMessages.indexOf(message) !== -1) {
            this.stop();
        } else {
            this.stopByError(message);
        }
    };
    var stopByError = function(message) {
        LOGGER.debug("stopByError", message);
        message = message || DEFAULT_ERROR.description;
        this.error = new vdb.html5.ads.modules.vast.ex.VastError(DEFAULT_ERROR.code, message);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR), message);
        this.stop();
    };
    var _onAdLog = function(message) {
        LOGGER.debug("VPAID_UNIT:", message);
    };
    var _onAdUserAcceptInvitation = function() {
        LOGGER.debug("onAdUserAcceptInvitation");
        var isLinear = getAdLinear.call(this);
        this.track(vdb.enums.VastEvents.ACCEPT_INVITATION);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION, isLinear ? AdUserInteraction.ACCEPT_INVITATION_LINEAR : AdUserInteraction.ACCEPT_INVITATION));
    };
    var _onAdUserMinimize = function() {
        LOGGER.debug("onAdUserMinimize");
        this.track(vdb.enums.VastEvents.COLLAPSE);
    };
    var _onAdUserClose = function() {
        LOGGER.debug("onAdUserClose");
        var isLinear = getAdLinear.call(this);
        this.track(vdb.enums.VastEvents.CLOSE);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION, isLinear ? AdUserInteraction.CLOSE_LINEAR : AdUserInteraction.CLOSE));
    };
    var _onAdSkippableStateChange = function() {
        LOGGER.debug("Ad Skippable State changed to", _callMethod.call(this, "getAdSkippableState"));
        this.dispatchEvent(vdb.events.AdEvent.AD_SKIPPABLE_STATE_CHANGE);
    };
    var _onAdExpandedChange = function() {
        var expanded = getAdExpanded.call(this);
        LOGGER.debug("Ad Expanded changed to", expanded);
        if (expanded) {
            this.track(vdb.enums.VastEvents.EXPAND);
            this.adView.pauseTimer();
            this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION, AdUserInteraction.EXPAND));
        } else {
            this.track(vdb.enums.VastEvents.COLLAPSE);
            this.adView.resumeTimer();
            this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION, AdUserInteraction.COLLAPSE));
        }
    };
    var getAdExpanded = function() {
        return _callMethod.call(this, "getAdExpanded");
    };
    var getAdSkippableState = function() {
        return _callMethod.call(this, "getAdSkippableState");
    };
    var _onAdSizeChange = function() {
        LOGGER.debug("Ad size changed to: w=" + _callMethod.call(this, "getAdWidth") + " h=" + _callMethod.call(this, "getAdHeight"));
    };
    var _onAdDurationChange = function() {
        LOGGER.debug("Ad Duration changed to", _callMethod.call(this, "getAdDuration"));
    };
    var _onAdRemainingTimeChange = function() {
        LOGGER.debug("Ad Remaining Time changed to", this.getRemainingTime());
        this.adView.startRemainingTimer();
    };
    var getAdRemainingTime = function() {
        return _callMethod.call(this, "getAdRemainingTime");
    };
    var getDuration = function() {
        if (!this._creative) {
            return 0;
        }
        var d = _callMethod.call(this, "getAdDuration");
        if (d <= 0 && this._initialRemainingTime > 0) {
            d = this._initialRemainingTime;
        }
        return d;
    };
    var _onAdImpression = function() {
        if (this._impressionProcessed) {
            return;
        }
        LOGGER.debug("Ad Impression");
        this.onImpression();
        this.onStart();
        if (_isInsideVideo.call(this)) {
            _showHide.call(this, true);
        }
        if (this.isMidroll()) {
            _showHideVideo.call(this, true);
        }
    };
    var _onAdClickThru = function(url, id, playerHandles) {
        LOGGER.debug("Clickthrough portion of the ad was clicked", url, id, playerHandles);
        playerHandles = Boolean(playerHandles) || playerHandles === undefined;
        if (!playerHandles) {
            url = null;
        }
        this.adView.dispatchClickThrough(url);
    };
    var _onAdInteraction = function(id) {
        LOGGER.debug("A non-clickthrough event has occured");
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION));
    };
    var _onAdVideoStart = function() {
        LOGGER.debug("Video 0% completed");
        this.trackOnce(vdb.enums.VastEvents.START);
        _showHideVideo.call(this, true);
    };
    var _onAdVideoFirstQuartile = function() {
        LOGGER.debug("Video 25% completed");
        this.trackOnce(vdb.enums.VastEvents.FIRST_QUARTILE);
    };
    var _onAdVideoMidpoint = function() {
        LOGGER.debug("Video 50% completed");
        this.trackOnce(vdb.enums.VastEvents.MIDPOINT);
    };
    var _onAdVideoThirdQuartile = function() {
        LOGGER.debug("Video 75% completed");
        this.trackOnce(vdb.enums.VastEvents.THIRD_QUARTILE);
    };
    var _onAdVideoComplete = function() {
        LOGGER.debug("Video 100% completed");
        this.trackOnce(vdb.enums.VastEvents.COMPLETE);
    };
    var _onAdLinearChange = function() {
        var isLinear = getAdLinear.call(this);
        LOGGER.debug("Ad linear changed to", isLinear);
        this.adView.linearChange(isLinear);
    };
    var getAdLinear = function() {
        return _callMethod.call(this, "getAdLinear");
    };
    var startAd = function() {
        if (this._stopped) {
            return;
        }
        LOGGER.debug("startAd");
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.CONTENT_PAUSE_REQUESTED));
        _callMethod.call(this, "startAd");
        this.adView.resize(Fullscreen.enabled() && Fullscreen.isFullscreen());
    };
    var _onAdLoaded = function() {
        LOGGER.debug("ad has been loaded", this);
        setVolume.call(this, this._volume);
        utl.callAsync(startAd.bind(this));
    };
    var _onStartAd = function() {
        LOGGER.debug("Ad has started");
        setVolume.call(this, this._volume);
        this.fireAdStarting();
        this.adView.startRemainingTimer();
        this.adView.showCompanion();
    };
    var stopAd = function() {
        LOGGER.debug("stopAd");
        if (this._stopped) {
            return;
        }
        this._stopped = true;
        if (this._creative) {
            try {
                _callMethod.call(this, "stopAd");
                this._stopTimer = setTimeout(_onStopAd.bind(this), 400);
            } catch (error) {
                LOGGER.error("Exception on vpaid.stopAd call: " + error.toString());
                this.forceStop();
            }
        } else {
            _onStopAd.call(this);
        }
    };
    var _onStopAd = function() {
        LOGGER.debug("Ad has stopped");
        if (this._stopTimer) {
            clearTimeout(this._stopTimer);
        }
        this.dispose();
        this.adView.complete(false, {currentTime:this.getCurrentTime()});
    };
    var trackVPAIDError = function(error) {
        LOGGER.error(error.toString());
    };
    var forceStop = function() {
        LOGGER.debug("forceStop");
        this.dispose();
        if (this._stopTimer) {
            clearTimeout(this._stopTimer);
        }
        this.adView.complete(true);
    };
    var dispose = function() {
        if (this._useMainVideoArea) {
            this._display.releaseMainArea();
        }
        LOGGER.debug("dispose");
        if (this._callbacksContext) {
            this._callbacksContext.unbind();
            this._callbacksContext = null;
        }
        if (this._vpaidLoader) {
            this._vpaidLoader.dispose();
        }
    };
    var skipAd = function() {
        _callMethod.call(this, "skipAd");
    };
    var _onSkipAd = function() {
        LOGGER.debug("Ad was skipped");
        this.forceStop();
    };
    var setVolume = function(volume) {
        this._volume = volume;
        _callMethod.call(this, "setAdVolume", volume);
    };
    var getVolume = function() {
        return _callMethod.call(this, "getAdVolume");
    };
    var _onAdVolumeChange = function() {
        var adVolume = getVolume.call(this);
        LOGGER.debug("Ad Volume changed to", adVolume);
        if (adVolume) {
            this.track(vdb.enums.VastEvents.UNMUTE);
        } else {
            this.track(vdb.enums.VastEvents.MUTE);
        }
        this._volume = adVolume;
        this.adView._onVolumeChanged({volume:this._volume});
    };
    var resizeAd = function(width, height) {
        LOGGER.debug("resize ad", {"width":width, "height":height, "viewMode":this._viewMode});
        _callMethod.call(this, "resizeAd", width, height, this._viewMode);
    };
    var pauseAd = function() {
        _callMethod.call(this, "pauseAd");
    };
    var _onAdPaused = function() {
        LOGGER.debug("onAdPaused");
        this.adView._onPaused();
    };
    var resumeAd = function() {
        _callMethod.call(this, "resumeAd");
    };
    var _onAdPlaying = function() {
        LOGGER.debug("onAdPlaying");
        this.adView._onResumed();
    };
    var expandAd = function() {
        _callMethod.call(this, "expandAd");
    };
    var collapseAd = function() {
        _callMethod.call(this, "collapseAd");
    };
    var invokeAdMethod = function(method, data) {
        _callMethod.call(this, "invokeAdMethod", method, data);
    };
    var _getRemainingTime = function() {
        if (!this._creative) {
            return 0;
        }
        var r = _callMethod.call(this, "getAdRemainingTime");
        if (r > this._initialRemainingTime) {
            this._initialRemainingTime = r;
        }
        return r;
    };
    var _callMethod = function(methodName) {
        if (!this._creative) {
            return undefined;
        }
        try {
            var args = [].slice.call(arguments, 1);
            var method = this._creative[methodName];
            if (method) {
                return method.apply(this._creative, args);
            }
            return undefined;
        } catch (e) {
            LOGGER.error(methodName, e);
            return undefined;
        }
    };
    return{init:init, load:load, createElement:createElement, initElement:initElement, stop:stopAd, pause:pauseAd, resume:resumeAd, skip:skipAd, setVolume:setVolume, getDuration:getDuration, getVolume:getVolume, getEnvironmentVars:getEnvironmentVars, getRemainingTime:_getRemainingTime, getCallbacks:getCallbacks, getAdSkippableState:getAdSkippableState, isMidroll:isMidroll, initializeVPAID:initializeVPAID, trackVPAIDError:trackVPAIDError, invokeAdMethod:invokeAdMethod, forceStop:forceStop, stopByError:stopByError,
        dispose:dispose, resize:resize};
}());
vdb.html5.ads.modules.vast.view.inner.SWFVPAIDMediaElement = vdb.html5.ads.modules.vast.view.inner.VPAIDMediaElement.extend(function() {
    var init = function(display, url, adType, flashRunnerPromise, rootContainer, adContainer, adConfigEntry, config, adsConfig) {
        this._super(display, url, adType, rootContainer, config, adsConfig);
        this._flashRunnerPromise = flashRunnerPromise;
        this._adContainer = adContainer;
        this._adConfigEntry = adConfigEntry;
    };
    var getRemainingTime = function() {
        if (!this._creative) {
            return 0;
        }
        return this._creative["getAdRemainingTime"]();
    };
    var initElement = function() {
        this.adView.initialStartTime = this._display.getCurrentTime();
        this.element.style.visibility = "hidden";
        this._flashRunnerPromise.then(onRunnerReady.bind(this), onError.bind(this));
    };
    var onRunnerReady = function(runner) {
        this._runner = runner;
        runner.addVPAID(this._url).then(onVPAIDReady.bind(this), onError.bind(this));
    };
    var onVPAIDReady = function(vpaid) {
        if (this._stopped) {
            vpaid["stopAd"]();
            return;
        }
        this._creative = vpaid;
        var CRITICAL_ERROR = vdb.html5.ads.modules.vast.view.inner.flash.FlashObjectWrapper.CRITICAL_ERROR;
        var SOUND_VIOLATION = vdb.html5.ads.modules.vast.view.inner.flash.FlashVPAID.SOUND_VIOLATION;
        this._callbacksContext.link(vdb.events.EventContext.bind(this._creative, CRITICAL_ERROR, onCriticalError.bind(this)), vdb.events.EventContext.bind(this._creative, SOUND_VIOLATION, onSoundViolation.bind(this)));
        this.initializeVPAID(this._adContainer);
    };
    var onSoundViolation = function() {
        if (!this.soundVilationCounter) {
            this.soundVilationCounter = 1;
        } else {
            this.soundVilationCounter++;
        }
        if (this.soundVilationCounter > 2) {
            this.stopByError("Sound violation");
        }
    };
    var onCriticalError = function() {
        this.stopByError("Internal wrapper critical error");
    };
    var onError = function(message) {
        this.stopByError("Error with flash vpaid: " + message);
    };
    var getEnvironmentVars = function() {
        return{};
    };
    var dispose = function() {
        this._super();
        if (this._runner && this._runnerOnScreen) {
            this._runner.hide();
        }
    };
    var onImpression = function() {
        if (this._impressionProcessed) {
            return;
        }
        this._super();
        if (this._runner) {
            this._runnerOnScreen = true;
            this._runner.show();
        }
    };
    return{init:init, initElement:initElement, getRemainingTime:getRemainingTime, getEnvironmentVars:getEnvironmentVars, onImpression:onImpression, dispose:dispose};
}());
vdb.html5.ads.modules.vast.view.ui = {};
vdb.html5.ads.modules.vast.view.ui.MuteButton = vdb.EventBus.extend(function() {
    function _onClick(e) {
        e.stopPropagation();
        this.dispatchEvent(vdb.html5.ads.modules.vast.view.ui.MuteButton.CLICK, !this._isMuted);
    }
    function _showButton(isMuted) {
        this._icon.innerHTML = "";
        var button = isMuted ? '<svg class="player-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 153.61 94.026" style="position: absolute; top: 0; left: 0;"><path fill="#D0D0D0" d="M19.744,30.013c-2.616,0-5.236,2.157-5.236,4.874v16.125v4v11.307c0,2.717,2.62,4.693,5.236,4.693h20.962 l24.795,22h0.007V92.96c0,0.146,0.657,0.053,1.079,0.053h1.96c1.808,0,2.961-1.353,2.961-3.161v-3.513V55.013v-1.196 L29.766,30.013H19.744z"/><path fill="#D0D0D0" d="M71.508,14.868v-3.513c0-1.808-1.153-3.341-2.962-3.341h-1.96c-0.421,0-1.078,0.087-1.078,0.233V8.014 h-0.007L50.189,21.599l21.319,12.157V14.868z"/><polygon fill-rule="evenodd" clip-rule="evenodd" fill="#D0D0D0" points="0,9.526 5.5,0 153.61,84.5 148.11,94.026"/><path fill="#D0D0D0" d="M88.19,67.712l4.53,7.949c2.171-1.907,4.088-4.093,5.698-6.499l-7.343-4.188 C90.266,65.987,89.316,66.909,88.19,67.712"><animate attributeType="CSS" attributeName="opacity" dur="2s" values="0;1;1;1;0" repeatCount="indefinite" /></path><path fill="#D0D0D0" d="M104.001,50.754c0-10.063-4.474-19.072-11.563-25.209l-4.691,9.459C91.331,38.02,93.86,42.225,94.735,47 l9.225,5.261C103.982,51.761,104.001,51.26,104.001,50.754"><animate attributeType="CSS" attributeName="opacity" dur="2s" values="0;1;1;1;0" repeatCount="indefinite" /></path><path fill="#D0D0D0" d="M126.931,50.553c0-16.354-6.628-31.147-17.192-42.167l-5.881,8.353 c8.727,8.705,14.263,20.63,14.263,33.814c0,3.164-0.33,6.254-0.937,9.249l8.131,4.636 C126.363,59.997,126.931,55.357,126.931,50.553"><animate attributeType="CSS" attributeName="opacity" dur="2s" values="0;0;1;1;0" repeatCount="indefinite" /></path><path fill="#D0D0D0" d="M103.327,84.819l6.105,8.001c3.613-3.632,6.739-7.679,9.322-12.062l-8.214-4.685 C108.479,79.268,106.057,82.206,103.327,84.819"><animate attributeType="CSS" attributeName="opacity" dur="2s" values="0;0;1;1;0" repeatCount="indefinite" /></path></svg> ' :
            '<svg class="player-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 153.61 94.026" style="position: absolute; top: 0; left: 0;"><path fill="#D0D0D0" d="M59.34,13.276h-1.695c-0.365,0-0.936-0.08-0.936,0.046v-0.045h-0.007L35.237,32.322l-18.146-0.025 c-0.598,0-1.191,0.131-1.748,0.363c-1.554,0.609-2.783,1.992-2.783,3.727v0.13v27.081v0.129c0,1.733,1.23,3.117,2.786,3.728 c0.555,0.232,1.149,0.362,1.745,0.362h8.677l9.471-0.025l21.467,19.045h0.006V86.79c0,0.126,0.567,0.046,0.935,0.046h1.695 c1.564,0,2.562-1.172,2.562-2.735V16.014C61.902,14.448,60.904,13.276,59.34,13.276z"/><path fill="#D0D0D0" d="M90.036,50.255c0-8.711-3.873-16.511-10.009-21.824l-4.062,8.188c3.104,2.611,5.292,6.252,6.051,10.387 c0,0,0.255,1.449,0.255,3.242c0,1.796-0.255,3.403-0.255,3.403c-0.758,4.133-2.947,7.772-6.051,10.385l4.062,8.188 c6.137-5.313,10.009-13.112,10.009-21.823c0-0.022,0-0.05-0.001-0.074C90.036,50.302,90.036,50.277,90.036,50.255z"><animate attributeType="CSS" attributeName="opacity" dur="2s" values="0;1;1;1;0" repeatCount="indefinite" /></path><path fill="#D0D0D0" d="M109.87,51.171c0.006-0.294,0.013-1.035,0.013-1.052c0-0.014,0.001-0.027,0.001-0.043 c0-0.041-0.008-0.713-0.014-1.007c-0.008-0.384-0.021-0.767-0.035-1.146c-0.002-0.029-0.002-0.061-0.004-0.09 c-0.57-13.265-6.172-25.227-14.831-34.259l-5.091,7.23c5.758,5.744,9.907,13.108,11.559,21.339c0,0,0.785,5.252,0.788,7.976 c-0.003,2.726-0.288,5.386-0.811,7.966l0.021,0.012c-1.65,8.23-5.801,15.596-11.559,21.34l5.091,7.23 c8.659-9.032,14.261-20.994,14.831-34.26c0.002-0.029,0.002-0.06,0.004-0.089C109.851,51.937,109.863,51.554,109.87,51.171z"><animate attributeType="CSS" attributeName="opacity" dur="2s" values="0;0;1;1;0" repeatCount="indefinite" /></path></svg> ';
        utl.createElement("div", {"style":"position: absolute; display: block; left: 10%; width: 80%; top: 25.5%; height: 49%;"}, this._icon, button);
    }
    var utl = vdb.Utils;
    return{init:function(isMuted, parent) {
        this._super();
        this._isMuted = isMuted;
        this._element = utl.createElement("div", {"id":"oath-volume-button-container", "style":"width: 26px; height: 26px; position: absolute; right: 20px; bottom: 20px; z-index: 10; cursor: pointer;"}, parent);
        this._icon = utl.createElement("div", {"id":"oath-volume-button-icon", "style":"position: absolute; display: block; width: 100%; height: 100%; border-radius: 20%; background-color: rgba(34, 34, 34, 0.85);"}, this._element);
        _showButton.call(this, isMuted);
        this._element.addEventListener("click", _onClick.bind(this));
    }, onVolumeChange:function(isMuted) {
        this._isMuted = isMuted;
        _showButton.call(this, isMuted);
    }, destroy:function() {
        utl.removeFromParent(this._element);
    }};
}());
vdb.html5.ads.modules.vast.view.ui.MuteButton.CLICK = "MuteButton.Click";
vdb.html5.ads.OverlaySlotInfo = {};
(function(def) {
    def.OverlaySlotInfo = vdb.core.Class.extend({width:0, height:0, delay:0, maxShowTime:0, position:""});
    def.OverlaySlotInfo.POSITION_TOP = "TOP";
    def.OverlaySlotInfo.POSITION_RIGHT = "RIGHT";
    def.OverlaySlotInfo.POSITION_BOTTOM = "BOTTOM";
    def.OverlaySlotInfo.POSITION_LEFT = "LEFT";
    def.OverlaySlotInfo.POSITION_FULL = "FULL";
})(vdb.html5.ads);
vdb.html5.ads.modules.vast.view.OverlayView = vdb.html5.ads.modules.vast.view.AdView.extend(function() {
    function _buildMediaUrl(content) {
        var resource = content.resources[0] || {};
        LOGGER.debug("buildMediaUrl", resource);
        var value = resource.value;
        if (_supportsVideoMimeType(resource.mimeType) && content.clickThroughUrl) {
            var url = encodeURIComponent(content.clickThroughUrl.url);
            var clickTag = "clickTAG=" + url + "&clickTag=" + url;
            value += value.indexOf("?") === -1 ? "?" : "&";
            value += clickTag;
        }
        return value;
    }
    function _supportsVideoMimeType(mimeType) {
        return["video/ogg", "video/mp4", "video/webm"].indexOf(mimeType) !== -1;
    }
    var LOGGER = vdb.log.getLogger("OverlayView");
    var Dependencies = vdb.enums.Dependencies;
    var _resolveDependencies = function() {
        var injector = this._adSystem.getInjector();
        this._rootContainer = injector.resolveSync(Dependencies.ROOT_CONTAINER);
        this._config = injector.resolveSync(Dependencies.CONFIG);
    };
    var init = function(timer, adContainer, ad, creative, mediaContent, overlaySlotInfo, adSystem, display) {
        LOGGER.debug("init", ad, creative);
        this._super(timer, adContainer, ad, creative, mediaContent, adSystem);
        this._display = display;
        this.overlaySlotInfo = overlaySlotInfo;
        var injector = adSystem.getInjector();
        this._rootContainer = injector.resolveSync(vdb.enums.Dependencies.ROOT_CONTAINER);
        this._adContainer = injector.resolveSync(vdb.enums.Dependencies.AD_CONTAINER);
        _resolveDependencies.call(this);
    };
    var resolveMediaElement = function() {
        var resource = this._mediaContent.resources[0] || {};
        if (resource.type === vdb.html5.ads.modules.vast.model.ResourceType.STATIC) {
            if (this._mediaContent.apiFramework && this._mediaContent.apiFramework.toLowerCase() === vdb.enums.ApiType.VPAID) {
                if (resource.mimeType === "application/x-shockwave-flash") {
                    var flashRunnerPromise = this._adSystem.getInjector().resolve(Dependencies.VPAID_RUNNER);
                    return new vdb.html5.ads.modules.vast.view.inner.SWFVPAIDMediaElement(this._display, resource.value, vdb.enums.AdType.OVERLAY, flashRunnerPromise, this._rootContainer, this._adContainer, this._adConfigEntry, this._config, this._adsConfig);
                }
                return new vdb.html5.ads.modules.vast.view.inner.VPAIDMediaElement(this._display, resource.value, vdb.enums.AdType.OVERLAY, this._rootContainer, this._config, this._adsConfig);
            }
            var value = _buildMediaUrl(this._mediaContent);
            return new vdb.html5.ads.modules.vast.view.inner.LoadableImageElement(value, this._display);
        }
        return this._super();
    };
    var showCompanion = function() {
        LOGGER.debug("showCompanion");
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.CompanionShowEvent(this.creative));
    };
    var draw = function() {
        this._super();
        this._timer.start();
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(vdb.html5.ads.modules.vast.model.CustomVastEvents.LOADED, this.creative));
    };
    var getAdParameters = function() {
        return this._mediaContent.parameters;
    };
    var getAdMaintainAspectRatio = function() {
        return this._mediaContent.maintainAspectRatio;
    };
    var getAdScalable = function() {
        return this._mediaContent.scalable;
    };
    var getAdHeight = function() {
        return Math.max(this._mediaContent.height, this._mediaContent.expandedHeight);
    };
    var getAdWidth = function() {
        return Math.max(this._mediaContent.width, this._mediaContent.expandedWidth);
    };
    var getClickThrough = function() {
        var clickThroughUrl = this._mediaContent.clickThroughUrl;
        return clickThroughUrl ? clickThroughUrl.url : null;
    };
    var calculateViewBounds = function(availableWidth, availableHeight, originalWidth, originalHeight, scalable, maintainAspectRatio) {
        if (scalable === undefined) {
            scalable = true;
        }
        if (maintainAspectRatio === undefined) {
            maintainAspectRatio = true;
        }
        var safeOverlaySlotInfoWidth = this.overlaySlotInfo.width || availableWidth;
        var safeOverlaySlotInfoHeight = this.overlaySlotInfo.height || availableHeight;
        var viewBounds = this._super(safeOverlaySlotInfoWidth, safeOverlaySlotInfoHeight, originalWidth, originalHeight, scalable, maintainAspectRatio);
        var resource = this._mediaContent.resources[0] || {};
        if (resource.mimeType === "application/javascript") {
            return _calculateOverlayBounds.call(this, safeOverlaySlotInfoWidth, safeOverlaySlotInfoHeight);
        }
        return _calculateOverlayBounds.call(this, Math.min(viewBounds.width, safeOverlaySlotInfoWidth), Math.min(viewBounds.height, safeOverlaySlotInfoHeight));
    };
    var _calculateOverlayBounds = function(overlayWidth, overlayHeight) {
        var bounds = {x:0, y:0, width:overlayWidth, height:overlayHeight};
        bounds.x = (this._adContainer.offsetWidth - overlayWidth) / 2;
        bounds.y = (this._adContainer.offsetHeight - overlayHeight) / 2;
        switch(this.overlaySlotInfo.position) {
            case vdb.html5.ads.OverlaySlotInfo.POSITION_TOP:
                bounds.y = 0;
                break;
            case vdb.html5.ads.OverlaySlotInfo.POSITION_RIGHT:
                bounds.x = this._adContainer.offsetWidth - overlayWidth;
                break;
            case vdb.html5.ads.OverlaySlotInfo.POSITION_BOTTOM:
                bounds.y = this._adContainer.offsetHeight - overlayHeight;
                break;
            case vdb.html5.ads.OverlaySlotInfo.POSITION_LEFT:
                bounds.x = 0;
                break;
            case vdb.html5.ads.OverlaySlotInfo.POSITION_FULL:
                break;
            default:
                break;
        }
        return bounds;
    };
    var linearChange = function(isLinear) {
        this._super();
        _dispatchAdEvent.call(this, vdb.events.AdEvent.AD_LINEAR_CHANGE, {isLinear:isLinear});
        if (isLinear) {
            this.pause();
            _dispatchAdEvent.call(this, vdb.events.AdEvent.AD_INTERACTION_START);
        } else {
            _dispatchAdEvent.call(this, vdb.events.AdEvent.AD_INTERACTION_END);
            this.resume();
        }
    };
    var _dispatchAdEvent = function(type, data) {
        this._adSystem.dispatchEvent(new vdb.events.AdEvent(type, vdb.enums.AdType.OVERLAY, data));
    };
    var getAdBitrate = function() {
        return 0;
    };
    var startRemainingTimer = function() {
    };
    var noResize = function() {
    };
    return{type:"OverlayView", init:init, resolveMediaElement:resolveMediaElement, draw:draw, showCompanion:showCompanion, getAdParameters:getAdParameters, getAdMaintainAspectRatio:getAdMaintainAspectRatio, getAdScalable:getAdScalable, getAdHeight:getAdHeight, getAdWidth:getAdWidth, getClickThrough:getClickThrough, calculateViewBounds:calculateViewBounds, linearChange:linearChange, getAdBitrate:getAdBitrate, startRemainingTimer:startRemainingTimer, noResize:noResize};
}());
vdb.html5.ads.OverlayAdConfigEntry = {};
(function(def) {
    def.OverlayAdConfigEntry = vdb.html5.ads.AdConfigEntry.extend(function() {
        function clone() {
            var newEntry = new def.OverlayAdConfigEntry;
            vdb.Utils.copy(this, newEntry);
            return newEntry;
        }
        function verifyAdPosition(position) {
            var supported = [vdb.html5.ads.OverlaySlotInfo.POSITION_BOTTOM, vdb.html5.ads.OverlaySlotInfo.POSITION_FULL, vdb.html5.ads.OverlaySlotInfo.POSITION_LEFT, vdb.html5.ads.OverlaySlotInfo.POSITION_RIGHT, vdb.html5.ads.OverlaySlotInfo.POSITION_TOP].indexOf(position) !== -1;
            if (!supported) {
                throw new Error("Bad overlay slot position: " + position);
            }
        }
        function parse(obj) {
            this._super(obj);
            var objSlot = obj["slot"] || {};
            this.slotInfo = new vdb.html5.ads.OverlaySlotInfo;
            this.slotInfo.delay = objSlot["delay"] || 1;
            this.slotInfo.width = objSlot["width"];
            this.slotInfo.height = objSlot["height"];
            this.slotInfo.maxShowTime = objSlot["maxShowTime"] || Number.POSITIVE_INFINITY;
            this.slotInfo.position = objSlot["position"] || vdb.html5.ads.OverlaySlotInfo.POSITION_FULL;
            verifyAdPosition(this.slotInfo.position);
            return this;
        }
        return{slotInfo:null, clone:clone, parse:parse};
    }());
})(vdb.html5.ads);
vdb.html5.ads.AdConfigEntryParser = function() {
    var LOGGER = vdb.log.getLogger("AdConfigEntryParser");
    var AdConfigEntry = vdb.html5.ads.AdConfigEntry;
    var AdType = vdb.enums.AdType;
    return{parse:function(obj) {
        LOGGER.debug("parse", obj);
        switch(obj.type) {
            case AdType.OVERLAY:
                return(new vdb.html5.ads.OverlayAdConfigEntry).parse(obj);
            case AdType.PREROLL:
                ;
            case AdType.MIDROLL:
                ;
            case AdType.ALL:
                ;
            case null:
                return(new AdConfigEntry).parse(obj);
            default:
                throw new Error("Bad ad config entry type: " + obj.type);;
        }
    }};
}();
vdb.html5.ads.AdsConfig = {};
(function(def) {
    function parse(obj) {
        LOGGER.debug("parse", obj);
        var aeg = obj["aeg"] || [];
        for (var i = 0;i < aeg.length;i++) {
            var gr = aeg[i];
            var entryGroup = [];
            for (var j = 0;j < gr.length;j++) {
                entryGroup.push(vdb.html5.ads.AdConfigEntryParser.parse(gr[j]));
            }
            this.entryGroups.push(entryGroup);
        }
        parseCompanionSlots.call(this, obj["companions"] || []);
        this.asids = obj["asids"] || [];
        this.maxLinearShowTime = obj["maxLinearShowTime"] || Defaults.maxLinearShowTime;
        this.maxAdsPerVideo = obj["maxAdsCount"] || Defaults.maxAdsPerVideo;
        this.adsInterleave = obj["prerollInterleave"] != null ? obj["prerollInterleave"] : Defaults.adsInterleave;
        this.adsPodSize = obj["podSize"] || Defaults.adsPodSize;
        this.midrollTiming = obj["midrollTiming"];
        this.domainOptimisation = obj["domainOptimisation"];
        this.overlayTiming = obj["overlayTiming"];
        this.softTimeout = obj["softTimeout"] || Defaults.softTimeout;
        this.hardTimeout = obj["hardTimeout"] || this.softTimeout * 8;
        this.startTimeout = Math.min(obj["startTimeout"] || this.hardTimeout * 6, 2147483647);
        this.maxAdSearchTime = Math.min(1E3 * obj["maxAdSearchTime"] || Defaults.maxAdSearchTime, 2147483647);
        if (this.hardTimeout < this.softTimeout) {
            var tmp = this.softTimeout;
            this.softTimeout = this.hardTimeout;
            this.hardTimeout = tmp;
        }
        this.autoplay = obj.autoplay;
        this.autoplayInView = obj.autoplayInView;
        this.volume = obj.volume;
        this.publisherPayout = obj.publisherPayout;
        this.publisherAmount = obj.publisherAmount;
        this.adStrategy = obj["adStrategy"] || vdb.enums.AdStrategyType.ADSET_BASED;
        this.isBrandedContent = obj["isBrandedContent"];
        this.skipSettings = obj["skipSettings"] || {};
        this.clickThroughUrl = obj["clickThroughUrl"];
        return this;
    }
    function parseCompanionSlots(slots) {
        LOGGER.debug("parseCompanionSlots", "raw slots", slots);
        for (var i = 0;i < slots.length;i++) {
            var objSlot = slots[i];
            this.companionSlots.push(new vdb.html5.ads.CompanionSlot(objSlot["width"], objSlot["height"], objSlot["parent"], objSlot["keepCompanion"], objSlot["selectorType"]));
        }
        LOGGER.debug("parseCompanionSlots", "parsed slots", this.companionSlots);
    }
    var LOGGER = vdb.log.getLogger("AdsConfig");
    var Defaults = {maxLinearShowTime:90, maxAdsPerVideo:99999999, adsInterleave:1, adsPodSize:1, softTimeout:.4, maxAdSearchTime:0};
    def.AdsConfig = vdb.core.Class.extend({companionSlots:[], entryGroups:[]});
    def.AdsConfig.parse = function(json) {
        return parse.call(new def.AdsConfig, json);
    };
})(vdb.html5.ads);
vdb.html5.ads.loaders = {};
vdb.html5.ads.loaders.BaseAdEntriesLoader = vdb.EventBus.extend(function() {
    var LOGGER = vdb.log.getLogger("BaseAdEntriesLoader");
    var AdConfigEntryParser = vdb.html5.ads.AdConfigEntryParser;
    var Dependencies = vdb.enums.Dependencies;
    var _onAdEntriesLoadSucceed = function(response) {
        LOGGER.info("Ad groups loaded", response.data, this._parser);
        var aeg = response.data["aeg"] || [];
        if (this._useOverride) {
            var adEngineOverrider = new vdb.override.AdEngineOverrider(this._config.getOverrider(vdb.enums.ClientOverrideEnum.AD_ENGINE));
            aeg = adEngineOverrider.override(aeg);
        }
        var apid = response.data["apid"];
        this._config.setATPData({"utid":apid, "audiences":[]});
        var adGroups = [];
        for (var i = 0;i < aeg.length;i++) {
            var adGroup = [];
            for (var j = 0;j < aeg[i].length;j++) {
                try {
                    var entryObj = aeg[i][j];
                    entryObj["type"] = entryObj["type"] || this._type;
                    entryObj["transactionId"] = response.data["txid"];
                    entryObj["adxResult"] = response.data["adxResult"];
                    entryObj["usid"] = response.data["usid"];
                    entryObj["auid"] = response.data["auid"];
                    if (this._config.isAggressiveMode()) {
                        entryObj["usesShim"] = true;
                    }
                    var entry = AdConfigEntryParser.parse(entryObj);
                    adGroup.push(entry);
                } catch (e) {
                    LOGGER.warn(e);
                    this._errorTracker.trackError("ad", null, e.message);
                }
            }
            adGroups.push(adGroup);
        }
        var eventData = {adGroups:adGroups, response:response.data, type:this._type, requestUrl:this._requestUrlWithParams};
        this.dispatchEvent(new vdb.events.Event(vdb.html5.ads.loaders.BaseAdEntriesLoader.LOADED, eventData));
    };
    var _onAdEntriesLoadFailed = function(error) {
        LOGGER.error("Failed to load ad entries", error);
        this.dispatchEvent(new vdb.events.Event(vdb.html5.ads.loaders.BaseAdEntriesLoader.FAILED, {error:error, type:this._type, requestUrl:this._requestUrlWithParams}));
    };
    return{init:function(requestUrl, injector) {
        this._super();
        this._requestUrl = requestUrl;
        this._useOverride = false;
        this._paramsCombine = injector.resolveSync(Dependencies.PARAMETERS_COMBINE);
        this._config = injector.resolveSync(Dependencies.CONFIG);
        this._errorTracker = injector.resolveSync(Dependencies.ERROR_TRACKER);
    }, load:function(type) {
        this._type = type;
        LOGGER.info("Request ad groups", this._requestUrl);
    }, _makeRequest:function(params) {
        this.serializedParams = params && vdb.Utils.serialize(params) || this.serializedParams;
        var aegOverride = this._config.getO2playerSettings()["aegOverride"];
        if (aegOverride && params && aegOverride["type"].toLowerCase() === params["at"]) {
            this._useOverride = true;
        }
        if (aegOverride && aegOverride["replace"]) {
            _onAdEntriesLoadSucceed.call(this, {data:{"aeg":[]}});
        } else {
            this._requestUrlWithParams = this._requestUrl + "&" + this.serializedParams;
            vdb.ajax.get(this._requestUrlWithParams, null, _onAdEntriesLoadSucceed.bind(this), _onAdEntriesLoadFailed.bind(this), undefined, {withCredentials:true, timeout:5E3});
        }
    }};
}());
(function(def) {
    def.LOADING = "BaseAdEntriesLoader.LOADING";
    def.LOADED = "BaseAdEntriesLoader.LOADED";
    def.FAILED = "BaseAdEntriesLoader.FAILED";
})(vdb.html5.ads.loaders.BaseAdEntriesLoader);
vdb.html5.ads.loaders.AdEntriesLoader = vdb.html5.ads.loaders.BaseAdEntriesLoader.extend(function() {
    return{load:function(type) {
        this._super(type);
        this._makeRequest(this._paramsCombine.getAdsParams(type));
    }};
}());
vdb.html5.ads.loaders.VrmAdEntriesLoader = vdb.html5.ads.loaders.BaseAdEntriesLoader.extend(function() {
    return{load:function(type) {
        this._super(type);
        this._makeRequest(this._paramsCombine.getVrmParams(type));
    }};
}());
vdb.html5.ads.AdEntriesManager = vdb.core.Class.extend(function() {
    var AD_POOL_NUMBER = 1;
    var LOGGER = vdb.log.getLogger("AdEntriesManager");
    var AdStrategyType = vdb.enums.AdStrategyType;
    var EventContext = vdb.events.EventContext;
    var BaseAdEntriesLoader = vdb.html5.ads.loaders.BaseAdEntriesLoader;
    var Dependencies = vdb.enums.Dependencies;
    var DEFAULT_IDLE_TIMEOUT = 50;
    var _initAdPools = function(adGroups) {
        adGroups = adGroups || [];
        LOGGER.debug("init ad pools with ad groups", adGroups);
        this._adPools = [];
        for (var i = 0;i < adGroups.length;i++) {
            var adGroup = adGroups[i];
            var adPool = new vdb.Pool(adGroup);
            adPool.AdEntriesManager_poolKey = "aem_" + AD_POOL_NUMBER++;
            for (var j = 0;j < adGroup.length;j++) {
                var adEntry = adGroup[j];
                adEntry.AdEntriesManager_poolKey = adPool.AdEntriesManager_poolKey;
            }
            this._adPools.push(adPool);
        }
        LOGGER.debug("Created Ad Pools", this._adPools);
    };
    var _getAdEntries = function(type) {
        _removeEmptyAdPools.call(this);
        _removeFailedPools.call(this);
        for (var i = 0;i < this._adPools.length;i++) {
            var adPool = this._adPools[i];
            var entries = adPool.getEntries();
            for (var j = 0;j < entries.length;j++) {
                if (entries[j].conformsType(type)) {
                    LOGGER.debug("Return ad entries of pool", adPool);
                    return entries;
                }
            }
        }
        return[];
    };
    var _removeEmptyAdPools = function() {
        for (var i = 0;i < this._adPools.length;i++) {
            var adPool = this._adPools[i];
            if (adPool.size() === 0) {
                LOGGER.debug("Remove empty ad pool", adPool);
                this._adPools.splice(i, 1);
                i--;
            }
        }
    };
    var _removeFailedPools = function() {
        for (var i = 0;i < this._adPools.length;i++) {
            var adPool = this._adPools[i];
            var entries = adPool.getEntries();
            var failed = true;
            for (var e in entries) {
                if (!_isEntryFailed.call(this, entries[e])) {
                    failed = false;
                    break;
                }
            }
            if (failed) {
                this._adPools.splice(i, 1);
                i--;
            }
        }
    };
    var _isEntryFailed = function(entry) {
        return!!this._failedAdEntries[_getAdEntryKey(entry)];
    };
    var _load = function(callback, type) {
        this._adPools = [];
        EventContext.group(EventContext.bindOnce(this._adLoader, BaseAdEntriesLoader.LOADED, _onEntriesLoaded.bind(this, type, callback)), EventContext.bindOnce(this._adLoader, BaseAdEntriesLoader.FAILED, _onEntriesLoadingFailed.bind(this, type, callback)));
        this._adSystem.dispatchEvent(new vdb.events.Event(vdb.html5.ads.loaders.BaseAdEntriesLoader.LOADING, {adGroups:this._adsConfig.entryGroups, type:type, adStrategy:this._adsConfig.adStrategy}));
        this._adLoader.load(type);
    };
    var _onEntriesLoadingFailed = function(type, callback, event) {
        this._adSystem.dispatchEvent(event);
        _initAdPools.call(this);
        callback(_getAdEntries.call(this, type));
    };
    var _onEntriesLoaded = function(type, callback, event) {
        this._adSystem.dispatchEvent(event);
        _initAdPools.call(this, event.data.adGroups);
        var entries = _getAdEntries.call(this, type);
        if (entries.length === 0) {
            this._blockedFuture = new vdb.Future;
            setTimeout(this._blockedFuture.resolve.bind(this._blockedFuture), this._idleTimeout *= 2);
        } else {
            this._idleTimeout = DEFAULT_IDLE_TIMEOUT;
        }
        callback(entries);
    };
    var _getAdEntryKey = function(adEntry) {
        if (adEntry && adEntry.AdEntriesManager_poolKey && adEntry._poolKey) {
            return adEntry.AdEntriesManager_poolKey + "." + adEntry._poolKey;
        }
        return null;
    };
    var _setAdLoader = function() {
        var injector = this._adSystem.getInjector();
        var urls = injector.resolveSync(Dependencies.URLS);
        if (this._adsConfig.adStrategy === AdStrategyType.CONTENT_BASED) {
            this._adLoader = new vdb.html5.ads.loaders.VrmAdEntriesLoader(urls.getAdServerVRMURL(), injector);
        } else {
            this._adLoader = new vdb.html5.ads.loaders.AdEntriesLoader(urls.getAdServerUrlAds(), injector);
        }
    };
    return{init:function(adsConfig, adSystem) {
        LOGGER.debug("init with config", adsConfig);
        this._adPools = [];
        this._adsConfig = adsConfig;
        this._releaseDisabled = adsConfig.entryGroups && adsConfig.entryGroups.length > 0;
        this._failedAdEntries = {};
        this._adSystem = adSystem;
        this._idleTimeout = DEFAULT_IDLE_TIMEOUT;
        _setAdLoader.call(this);
    }, release:function(adEntry) {
        if (this._releaseDisabled) {
            return;
        }
        for (var i = 0;i < this._adPools.length;i++) {
            var adPool = this._adPools[i];
            if (adPool.AdEntriesManager_poolKey === adEntry.AdEntriesManager_poolKey) {
                adPool.release(adEntry);
                if (adPool.size() === 0) {
                    LOGGER.debug("Remove empty ad pool", adPool);
                    this._adPools.splice(i, 1);
                }
                return;
            }
        }
        LOGGER.warn("Unable to release ad entry. Ad pool not exists.", "ad entry", adEntry, "ad pools", this._adPools);
    }, receive:function(callback, type) {
        this._adSystem.dispatchEvent(new vdb.events.TrackEvent(vdb.events.TrackEvent.AD_REQUEST, {type:type}));
        if (this._releaseDisabled) {
            _onEntriesLoaded.call(this, type, callback, new vdb.events.Event(vdb.html5.ads.loaders.BaseAdEntriesLoader.LOADED, {adGroups:this._adsConfig.entryGroups, type:type}));
        } else {
            LOGGER.debug("receive ad entries");
            if (this._blockedFuture) {
                this._blockedFuture.getPromise().then(function() {
                    _load.call(this, callback, type);
                    this._blockedFuture = null;
                }.bind(this));
            } else {
                _load.call(this, callback, type);
            }
        }
    }, markFailed:function(adEntry) {
        var key = _getAdEntryKey(adEntry);
        if (key) {
            this._failedAdEntries[key] = key;
        }
    }, getAdEntries:_getAdEntries};
}());
vdb.html5.ads.modules.vast.model.LeaveBehind = vdb.core.Class.extend(function() {
    function onAdFinished() {
        this.config["replace"] = true;
        this.config["type"] = vdb.enums.AdType.OVERLAY;
        this.oldConfig = this._playerConfig.getO2playerSettings()[vdb.enums.ClientOverrideEnum.AD_ENGINE];
        this._playerConfig.setO2playerSetting(vdb.enums.ClientOverrideEnum.AD_ENGINE, this.config);
        EventContext.group(EventContext.bindOnce(this.adSystem, BaseAdEntriesLoader.LOADED, restoreAegOverride.bind(this)), EventContext.bindOnce(this.adSystem, BaseAdEntriesLoader.FAILED, restoreAegOverride.bind(this)));
        this.oldOverlayTiming = this.adSystem.getAdsConfig().overlayTiming;
        this.adSystem.getAdsConfig().overlayTiming = "00:00:01";
    }
    function restoreAegOverride() {
        this._playerConfig.setO2playerSetting(vdb.enums.ClientOverrideEnum.AD_ENGINE, this.oldConfig);
        this.adSystem.getAdsConfig().overlayTiming = this.oldOverlayTiming;
    }
    var AdEvent = vdb.events.AdEvent;
    var EventContext = vdb.events.EventContext;
    var BaseAdEntriesLoader = vdb.html5.ads.loaders.BaseAdEntriesLoader;
    return{init:function(leaveBehindNode) {
        var json = vdb.dom.text(leaveBehindNode);
        this.config = JSON.parse(json);
    }, prepare:function(adSystem, eventContextGroup) {
        this.adSystem = adSystem;
        eventContextGroup.addContext(EventContext.bind(adSystem, AdEvent.AD_FINISHED, onAdFinished.bind(this)));
        this._playerConfig = this.adSystem.getInjector().resolveSync(vdb.enums.Dependencies.CONFIG);
    }};
}());
vdb.html5.ads.SkipButtonControl = vdb.core.Class.extend(function() {
    function addEventListeners() {
        vdb.events.EventContext.bindOnce(this._adSystem, AdEvent.AD_FINISHED, onAdSlotEnd.bind(this));
        if (this._skipTimer > 0) {
            this._onAdTimeUpdateCallback = onAdTimeUpdate.bind(this);
            this._adSystem.addEventListener(AdEvent.AD_TIMEUPDATE, this._onAdTimeUpdateCallback);
        }
    }
    function onAdStart(event) {
        if (!this._skipable || !this._adSystem.getAdSkippableState()) {
            return;
        }
        this._skipTimer = getSkipOffsetTime.call(this, event);
        if (this._skipTimer === null) {
            return;
        }
        showButton.call(this);
        setTimeout(function() {
            utl.replaceClass(this._skipButton, "collapse-skip-button", "expand-skip-button");
        }.bind(this), 800);
    }
    function onAdTimeUpdate(event) {
        var currentTimeFloor = Math.floor(event.data["currentTime"]);
        if (this._skipIn > 0 && this._skipTimer - this._skipIn < currentTimeFloor) {
            var newTime = this._skipTimer - currentTimeFloor;
            if (newTime <= 0) {
                activateButton.call(this, event);
            } else {
                setSkipTime.call(this, newTime);
            }
        }
    }
    function onAdSlotEnd() {
        if (this._onAdTimeUpdateCallback) {
            this._adSystem.removeEventListener(AdEvent.AD_TIMEUPDATE, this._onAdTimeUpdateCallback);
        }
        utl.replaceClass(this._skipButton, "expand-skip-button", "collapse-skip-button");
        utl.removeClass(this._skipButton, "skippable");
        this._active = true;
    }
    function onButtonClick() {
        if (this._active) {
            this._adSystem.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_SKIP_REQUESTED));
            utl.removeClass(this._skipButton, "skippable");
            this._active = false;
        }
    }
    function appendButtonOnce() {
        var skipButtonFromContainer = this._container.getElementsByClassName(SKIP_BUTTON_CLASS)[0];
        if (this._skipButton) {
            return;
        }
        if (skipButtonFromContainer) {
            this._skipButton = skipButtonFromContainer;
            this._skipButtonText = this._skipButton.getElementsByClassName(SKIP_BUTTON_TEXT_CLASS)[0];
        } else {
            vdb.dom.embedCssToHead(".ad-skip-button-container{position:relative;overflow:hidden;width:100%;height:100%}.ad-skip-button{position:absolute;width:110px;right:-110px;bottom:65px;padding:6px 0;background-color:rgba(34,34,34,0.85);color:#d0d0d0;font:12px Arial;text-align:center;border:1px #747474 solid;border-right:0;opacity:1;z-index:3;transition:right 1s ease-in}.fullscreen-mode .ad-skip-button{width:165px;bottom:98px;padding:9px 0;border-width:1.5px;font-size:18px}.ad-skip-button.skippable{text-decoration:underline;cursor:pointer}.ad-skip-button.skippable:hover{color:#fff}.expand-skip-button{opacity:1;right:0;margin-right:0}.collapse-skip-button{opacity:0;right:-110px}.fullscreen-mode .collapse-skip-button{opacity:0;right:-165px}");
            this._skipContainer = utl.createElement("div", {"class":SKIP_BUTTON_CONTAINER_CLASS}, this._container);
            this._skipButton = utl.createElement("div", {"class":SKIP_BUTTON_CLASS}, this._skipContainer);
            this._skipButtonText = utl.createElement("div", {"class":SKIP_BUTTON_TEXT_CLASS}, this._skipButton);
        }
    }
    function activateButton(event) {
        var currentTime = event ? Math.floor(event.data["currentTime"]) : 0;
        var duration = event ? event.data["duration"] : 0;
        this._skipButtonText.innerHTML = this.skippableText.replace("%t", this.showTimer ? "| " + Math.round(duration - currentTime) : "");
        utl.addClass(this._skipButton, "skippable");
        this._active = true;
        vdb.events.EventContext.bindOnce(this._skipButton, "click", onButtonClick.bind(this));
    }
    function getSkipOffsetTime(event) {
        var data = event.data;
        var duration = data.duration;
        var skipOffsetTime = data.skipOffsetTime;
        var skipOffsetPercent = data.skipOffsetPercent;
        var skipInSeconds = this.skipInSeconds;
        if (skipOffsetTime || skipOffsetTime === 0) {
            skipInSeconds = skipOffsetTime;
        } else {
            if (skipOffsetPercent || skipOffsetPercent === 0) {
                skipInSeconds = ~~(duration * skipOffsetPercent / 100);
            }
        }
        var adDuration = Math.min(this.maxLinearShowTime, duration);
        return skipInSeconds < adDuration ? skipInSeconds : null;
    }
    function showButton() {
        addEventListeners.call(this);
        appendButtonOnce.call(this);
        if (this._skipTimer > 0) {
            setSkipTime.call(this, this._skipTimer);
        } else {
            activateButton.call(this);
        }
    }
    function setSkipTime(time) {
        this._skipIn = time;
        this._skipButtonText.innerHTML = this.timerText.replace("%d", this._skipIn);
    }
    var SKIPPABLE_TEXT = "Skip ad %t";
    var TIMER_TEXT = "Skip ad in %ds";
    var DEFAULT_SKIP_TIME = 5;
    var SKIP_BUTTON_CONTAINER_CLASS = "ad-skip-button-container";
    var SKIP_BUTTON_CLASS = "ad-skip-button";
    var SKIP_BUTTON_TEXT_CLASS = "ad-skip-button-text";
    var SHOW_TIMER = false;
    var utl = vdb.Utils;
    var AdEvent = vdb.events.AdEvent;
    return{init:function(adSystem, skipable) {
        this.skipConfig = adSystem.getAdsConfig().skipSettings || {};
        this.skippableText = this.skipConfig["skippableText"] || SKIPPABLE_TEXT;
        this.timerText = this.skipConfig["timerText"] || TIMER_TEXT;
        this.showTimer = this.skipConfig["showTimer"] || SHOW_TIMER;
        this.skipInSeconds = this.skipConfig["skipInSeconds"] || DEFAULT_SKIP_TIME;
        this.maxLinearShowTime = this.skipConfig["maxLinearShowTime"] || 90;
        this._skipable = skipable;
        this._adSystem = adSystem;
        this._container = adSystem.getAdContainers().adContainer;
        this._active = false;
        vdb.events.EventContext.bindOnce(this._adSystem, AdEvent.AD_STARTED, onAdStart.bind(this));
        vdb.events.EventContext.bindOnce(this._adSystem, AdEvent.AD_SKIPPABLE_STATE_CHANGE, function(event) {
            if (event.data.skippable) {
                this.showTimer = false;
                this._skipTimer = 0;
                showButton.call(this);
                utl.replaceClass(this._skipButton, "collapse-skip-button", "expand-skip-button");
            }
        }.bind(this));
    }};
}());
vdb.html5.ads.modules.vast.view.LinearView = vdb.html5.ads.modules.vast.view.AdView.extend(function() {
    var LOGGER = vdb.log.getLogger("LinearView");
    var ApiType = vdb.enums.ApiType;
    var Dependencies = vdb.enums.Dependencies;
    var _resolveDependencies = function() {
        this._config = this._injector.resolveSync(Dependencies.CONFIG);
        this._rootContainer = this._injector.resolveSync(Dependencies.ROOT_CONTAINER);
        this._adContainer = this._injector.resolveSync(Dependencies.AD_CONTAINER);
    };
    var init = function(timer, adContainer, ad, creative, mediaContent, adConfigEntry, adSystem, display) {
        this._super(timer, adContainer, ad, creative, mediaContent, adSystem);
        this._display = display;
        this._adConfigEntry = adConfigEntry;
        this._adType = adConfigEntry.getType();
        this._injector = adSystem.getInjector();
        _resolveDependencies.call(this);
        this._config.updateAdParams({topOffsetFuture:new vdb.Future});
        if (!_isVPAID.call(this)) {
            _processAdapCreativeData.call(this);
        }
        var skipable = creative && creative.skippable || this._adsConfig.skipSettings && !vdb.Utils.isEmpty(this._adsConfig.skipSettings);
        if (this._config.getPlayerType() != vdb.enums.PlayerType.O2UNIT) {
            new vdb.html5.ads.SkipButtonControl(adSystem, skipable);
        }
    };
    var _processAdapCreativeData = function() {
        var creative = this.creative || {};
        var adParametersString = creative.parameters && creative.parameters.value;
        if (typeof adParametersString !== "string") {
            return;
        }
        var adParameters = vdb.Utils.deserialize(adParametersString.trim().replace(/\+/g, "%20"));
        var cdString = adParameters["cd"] || "";
        if (!cdString) {
            return;
        }
        var cd;
        try {
            cd = JSON.parse(adParameters["cd"]);
        } catch (e) {
        }
        cd = cd || {};
        var startMuted = cd["startMuted"];
        if (startMuted) {
            if (!this._adSystem.isMuted()) {
                this._adSystem.mute(true);
            }
        }
        var muteButtonEnabled = cd["muteButtonEnabled"];
        if (muteButtonEnabled) {
            setTimeout(_setupMuteButton.bind(this), 100);
        }
    };
    var _setupMuteButton = function() {
        this._muteButton = new vdb.html5.ads.modules.vast.view.ui.MuteButton(this._adSystem.isMuted(), this._adContainer);
        this._muteButton.addEventListener(vdb.html5.ads.modules.vast.view.ui.MuteButton.CLICK, function(mute) {
            this._adSystem.mute(mute);
        }.bind(this));
    };
    var _onVolumeChanged = function(data) {
        this._super(data);
        if (this._muteButton) {
            this._muteButton.onVolumeChange(data.muted);
        }
    };
    var initView = function(volume) {
        _setupResizeListener.call(this);
        this._super(volume);
    };
    var fallback = function(mediaElement) {
        this._super(mediaElement);
        _setupResizeListener.call(this);
    };
    var _setupResizeListener = function() {
        if (this._eventContext) {
            this._eventContext.unbind();
            this._eventContext = null;
        }
        if (this._mediaElement) {
            _getEventContext.call(this).link(vdb.events.EventContext.bind(this._adSystem, vdb.html5.ads.events.AdSystemEvent.RESIZE, function() {
                this._mediaElement.resize();
            }.bind(this)));
        }
    };
    var onRemainTimer = function() {
        var remTime = this._mediaElement.getRemainingTime();
        if (remTime <= 0) {
            clearInterval(this._remainTimerId);
            return;
        }
        this.dispatchEvent(new vdb.events.AdRemainingTimeUpdateEvent(remTime * 1E3));
        var currentTime = this._mediaElement.getCurrentTime();
        var duration = this._mediaElement.getDuration() || currentTime;
        var event = {currentTime:Math.min(currentTime, duration), duration:duration};
        this._onTimeUpdate(event);
    };
    var _getEventContext = function() {
        if (!this._eventContext) {
            this._eventContext = vdb.events.EventContext.empty();
        }
        return this._eventContext;
    };
    var _isVPAID = function() {
        var mediaFile = this.getMediaContent();
        return mediaFile && mediaFile.apiFramework && mediaFile.apiFramework.toLowerCase() === ApiType.VPAID;
    };
    var resolveMediaElement = function() {
        var mediaFile = this.getMediaContent();
        var mediaElement;
        if (_isVPAID.call(this)) {
            this._apiType = ApiType.VPAID;
            if (mediaFile.mimeType == vdb.html5.ads.modules.vast.model.MediaFile.FLASH_MIME_TYPE) {
                if (this._adType === vdb.enums.AdType.PREROLL) {
                    this._config.useMidrollWorkaround(true);
                }
                var flashRunnerPromise = this._injector.resolve(Dependencies.VPAID_RUNNER);
                mediaElement = new vdb.html5.ads.modules.vast.view.inner.SWFVPAIDMediaElement(this._display, mediaFile.url, this._adType, flashRunnerPromise, this._rootContainer, this._adContainer, this._adConfigEntry, this._config, this._adsConfig);
            } else {
                mediaElement = new vdb.html5.ads.modules.vast.view.inner.VPAIDMediaElement(this._display, mediaFile.url, this._adType, this._rootContainer, this._config, this._adsConfig);
            }
            _getEventContext.call(this).link(vdb.events.EventContext.bind(mediaElement, vdb.events.AdEvent.AD_SKIPPABLE_STATE_CHANGE, function() {
                this._adSystem.dispatchEvent(new vdb.events.Event(vdb.events.AdEvent.AD_SKIPPABLE_STATE_CHANGE, {skippable:this.getAdSkippableState()}));
            }.bind(this)));
        } else {
            if (this._adSystem.useInlinePlayer(this._adConfigEntry)) {
                LOGGER.debug("Use Inline Player");
                mediaElement = new vdb.html5.ads.modules.vast.view.inner.InlinePlayerMediaElement(this._display, mediaFile.url, this._config, this._injector);
                mediaElement.fallbackMediaElement = new vdb.html5.ads.modules.vast.view.inner.SimpleVideoMediaElement(this._display, mediaFile.url, this._adContainer);
            } else {
                if (mediaFile.mimeType == vdb.html5.ads.modules.vast.model.MediaFile.FLV_VIDEO) {
                    var flvRunnerPromise = this._injector.resolve(Dependencies.FLV_RUNNER);
                    mediaElement = new vdb.html5.ads.modules.vast.view.inner.FlvMediaElement(this._display, mediaFile.url, flvRunnerPromise, this._rootContainer, this._adContainer);
                } else {
                    mediaElement = new vdb.html5.ads.modules.vast.view.inner.SimpleVideoMediaElement(this._display, mediaFile.url, this._adContainer);
                }
            }
        }
        return mediaElement;
    };
    var complete = function(force, event) {
        if (this._muteButton) {
            this._muteButton.destroy();
        }
        if (this._eventContext) {
            this._eventContext.unbind();
            this._eventContext = null;
        }
        clearInterval(this._remainTimerId);
        this._super(force, event);
        clearTimeout(this._startRemainingTimerId);
    };
    var linearChange = function(isLinear) {
        this._super(isLinear);
        var event = new vdb.events.AdEvent(vdb.events.AdEvent.AD_LINEAR_CHANGE, this._adType, {isLinear:isLinear});
        LOGGER.debug("linear state changed to", isLinear, "dispatch event", event);
        this.dispatchEvent(event);
    };
    var showCompanion = function() {
        LOGGER.debug("showCompanion");
        this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.CompanionShowEvent(this.creative));
    };
    var draw = function() {
        LOGGER.debug("draw");
        this._super();
    };
    var startRemainingTimer = function() {
        if (!this._remainTimerId) {
            if (this._mediaElement.getRemainingTime() > 0) {
                this._remainTimerId = setInterval(this.onRemainTimer.bind(this), 1E3);
            } else {
                clearTimeout(this._startRemainingTimerId);
                this._startRemainingTimerId = setTimeout(startRemainingTimer.bind(this), 200);
            }
        }
    };
    var getMediaContent = function() {
        return this._mediaContent || null;
    };
    var getAdParameters = function() {
        return this.creative.parameters;
    };
    var getAdBitrate = function() {
        return this._mediaContent.bitrate;
    };
    var getAdMaintainAspectRatio = function() {
        return this._mediaContent.maintainAspectRatio;
    };
    var getAdScalable = function() {
        return this._mediaContent.scalable;
    };
    var getAdHeight = function() {
        return this._mediaContent.height;
    };
    var getAdWidth = function() {
        return this._mediaContent.width;
    };
    var getClickThrough = function() {
        var url = this._adSystem.getClickThroughUrl();
        if (!url) {
            var clickThroughUrl = this.creative.clickThroughUrl;
            url = clickThroughUrl ? clickThroughUrl.url : null;
        }
        return url;
    };
    var getDuration = function() {
        if (this._mediaElement) {
            return this._mediaElement.getDuration();
        }
    };
    var getAdSkippableState = function() {
        if (this._mediaElement && this._mediaElement.getAdSkippableState) {
            return this._mediaElement.getAdSkippableState();
        }
    };
    var getAdConfigEntry = function() {
        return this._adConfigEntry;
    };
    var getApiType = function() {
        return this._apiType;
    };
    var getAdId = function() {
        return this.ad.id;
    };
    var getAdSystem = function() {
        return this._adSystem;
    };
    var stop = function() {
        if (this._muteButton) {
            this._muteButton.destroy();
        }
        this._super();
    };
    return{type:"LinearView", init:init, initView:initView, onRemainTimer:onRemainTimer, resolveMediaElement:resolveMediaElement, showCompanion:showCompanion, draw:draw, startRemainingTimer:startRemainingTimer, getMediaContent:getMediaContent, getAdParameters:getAdParameters, getAdBitrate:getAdBitrate, getAdMaintainAspectRatio:getAdMaintainAspectRatio, getAdScalable:getAdScalable, getAdHeight:getAdHeight, getAdWidth:getAdWidth, getDuration:getDuration, getAdSkippableState:getAdSkippableState, getClickThrough:getClickThrough,
        complete:complete, linearChange:linearChange, getAdConfigEntry:getAdConfigEntry, getApiType:getApiType, getAdId:getAdId, getAdSystem:getAdSystem, fallback:fallback, _onVolumeChanged:_onVolumeChanged, stop:stop};
}());
vdb.html5.ads.modules.vast.VastEngine = vdb.html5.ads.AdEngineBase.extend(function() {
    function getAdContainerSize() {
        var width = this._adContainer.offsetWidth;
        var height = this._adContainer.offsetHeight;
        if (width === 0) {
            this._adContainer.style.width = "100%";
            width = parent.offsetWidth;
        }
        if (height === 0) {
            this._adContainer.style.height = "100%";
            height = parent.offsetHeight;
        }
        return{width:width, height:height};
    }
    function track(eventType, params) {
        params = params || {};
        params["vastModelAd"] = this.ad;
        this._super(eventType, params);
    }
    function failOver() {
        this._super();
        _killAds.call(this);
    }
    var LOGGER = vdb.log.getLogger("VastEngine");
    var DEFAULT_ERROR = vdb.html5.ads.modules.vast.errorCodes.UNDEFINED;
    var TRACKING_TYPE_TO_AD_STAGE = {};
    TRACKING_TYPE_TO_AD_STAGE[vdb.enums.VastEvents.FIRST_QUARTILE] = vdb.ads.AdStage.FIRST_QUARTILE;
    TRACKING_TYPE_TO_AD_STAGE[vdb.enums.VastEvents.MIDPOINT] = vdb.ads.AdStage.SECOND_QUARTILE;
    TRACKING_TYPE_TO_AD_STAGE[vdb.enums.VastEvents.THIRD_QUARTILE] = vdb.ads.AdStage.THIRD_QUARTILE;
    var EventContext = vdb.events.EventContext;
    var VastEvent = vdb.html5.ads.modules.vast.event.VastEvent;
    var VideoTrackingEvent = vdb.html5.ads.modules.vast.event.VideoTrackingEvent;
    var CustomVastEvents = vdb.html5.ads.modules.vast.model.CustomVastEvents;
    var init = function(adSystem, adsConfig, adEntry, vastLoader, linearResolver, nonLinearResolver, vastEventHandler, adContainers, companionSlots) {
        this._super(adSystem, adsConfig, vastLoader);
        this._vastLoader = vastLoader;
        this._linearResolver = linearResolver;
        this._nonLinearResolver = nonLinearResolver;
        this._configEntry = adEntry;
        this._adContainer = adContainers.adContainer;
        this._overlayContainer = adContainers.overlayContainer;
        this._eventHandler = vastEventHandler;
        this._companionSlots = companionSlots || [];
        this._linearCreatives = [];
        this._overlayCreatives = [];
        this._isFirstAd = true;
        this._views = [];
        this._overlayTimer = new vdb.utils.Timer;
        this._flashDetector = this.adSystem.getInjector().resolveSync(vdb.enums.Dependencies.FLASH_DETECTOR);
        this._errorTracker = this.adSystem.getInjector().resolveSync(vdb.enums.Dependencies.ERROR_TRACKER);
        this.adSystem.addEventListener(vdb.html5.ads.events.AdSystemEvent.RESIZE, _onPlayerResize.bind(this));
    };
    var _onPlayerResize = function() {
        for (var i = 0;i < this._views.length;i++) {
            this._views[i].resize();
        }
    };
    var onLoaded = function(vastModel) {
        LOGGER.debug("onLoaded", vastModel);
        this._vastAdsNumber = vastModel && vastModel.ads.length;
        if (this._stopped) {
            return;
        }
        this._vastModel = vastModel;
        var ad = this._vastModel.ads.shift();
        this._flowParams = vdb.html5.ads.modules.vast.params.AdVendorParams.create(this._configEntry);
        this._flowParams.parse(ad);
        _prepareCreatives.call(this, ad);
        if (!this._loaded) {
            this._super(ad);
        } else {
            _showFirstLinearCreative.call(this);
        }
    };
    var _prepareCreatives = function(ad) {
        LOGGER.debug("prepareCreatives", ad);
        _instrumentAd.call(this, ad);
        this.ad = ad;
        var VASTEvent = vdb.html5.ads.modules.vast.event.VastEvent;
        this.ad.dispatchEvent(new VASTEvent(VastEvent.ATTEMPT));
        this._linearCreatives = [];
        this._overlayCreatives = [];
        for (var i = 0;i < ad.creatives.length;i++) {
            var creative = ad.creatives[i];
            LOGGER.debug("prepareCreatives", "creative", creative);
            if (creative instanceof vdb.html5.ads.modules.vast.model.LinearCreative) {
                this._linearCreatives.push(creative);
            } else {
                if (creative instanceof vdb.html5.ads.modules.vast.model.NonLinearCreative) {
                    this._overlayCreatives.push(creative);
                }
            }
        }
    };
    var _prepareExtensions = function() {
        LOGGER.debug("prepareExtensions", this.ad);
        var adExtensions = this.ad.extensions;
        for (var i = 0;i < adExtensions.length;i++) {
            var extension = adExtensions[i];
            LOGGER.debug("prepare extension", extension);
            extension.prepare(this);
        }
    };
    var _onVastEvent = function(vastEvent) {
        this._eventHandler.onVastEvent(vastEvent, this._configEntry);
    };
    var _instrumentAd = function(ad) {
        LOGGER.debug("instrumentAd", ad);
        var _this = this;
        var onAdClick = function(vastEvent) {
            var clickThroughUrl = vastEvent.getClickThrough();
            _this.adClick(clickThroughUrl);
        };
        var trackAdFlow = function(vastEvent) {
            var adStage = TRACKING_TYPE_TO_AD_STAGE[vastEvent.trackingType];
            if (adStage) {
                _this.trackFlow(adStage, vastEvent.data);
            }
        };
        var eventsToListen = [VastEvent.ATTEMPT, VastEvent.IMPRESSION, VastEvent.ERROR, VastEvent.CLICK, CustomVastEvents.VIEWABLE, CustomVastEvents.VIEWABLE_DETECTION_STARTED, CustomVastEvents.VIEWABLE_DETECTION_FAILED, CustomVastEvents.COMPANION_DISPLAY, CustomVastEvents.COMPANION_CLICK, CustomVastEvents.LOADED, CustomVastEvents.STOPPED, CustomVastEvents.LINEAR_CHANGE, VideoTrackingEvent.VIDEO_TRACKING];
        for (var k in eventsToListen) {
            if (Object.prototype.hasOwnProperty.call(eventsToListen, k)) {
                ad.addEventListener(eventsToListen[k], _onVastEvent.bind(_this));
            }
        }
        ad.addEventListener(VastEvent.CLICK, onAdClick);
        ad.addEventListener(VideoTrackingEvent.VIDEO_TRACKING, trackAdFlow);
        ad.addEventListener(vdb.html5.ads.modules.vast.event.CompanionShowEvent.COMPANION_SHOW, _showCompanions.bind(this));
    };
    var showLinearAd = function(maxTime) {
        this._super(maxTime || 0);
        this.adLoaded();
        _showFirstLinearCreative.call(this);
    };
    var showOverlay = function() {
        this._super();
        var overlaySlot = this._configEntry.slotInfo;
        LOGGER.debug("showOverlay", overlaySlot);
        var w = !isNaN(overlaySlot.width) ? Math.min(overlaySlot.width, this._overlayContainer.offsetWidth) : this._overlayContainer.offsetWidth;
        var h = !isNaN(overlaySlot.height) ? Math.min(overlaySlot.height, this._overlayContainer.offsetHeight) : this._overlayContainer.offsetHeight;
        for (var i = 0;i < this._overlayCreatives.length;i++) {
            var creative = this._overlayCreatives[i];
            this._mediaFile = this._nonLinearResolver.resolve({x:0, y:0, width:w, height:h}, creative.nonLinears);
            if (this._mediaFile && this._mediaFile.resources[0] && this._mediaFile.resources[0].value) {
                this._views.push(new vdb.html5.ads.modules.vast.view.OverlayView(this._overlayTimer, this._overlayContainer, this._vastModel.ads[0] || this.ad, creative, this._mediaFile, overlaySlot, this.adSystem, this._display));
                this._overlayTimer.schedule(_displayOverlay.bind(this), overlaySlot.delay * 1E3);
                return true;
            }
        }
        this.trackAdIssue(vdb.ads.AdStage.LOADED, "Unable to find suitable overlay creatives");
        return false;
    };
    var _displayOverlay = function() {
        var overlayView = this._views[0];
        LOGGER.debug("displayOverlay", overlayView);
        this._overlayTimer.clean();
        if (overlayView) {
            overlayView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPLETE, _completeAd.bind(this));
            overlayView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_STARTED, this.adStarted.bind(this));
            overlayView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPLETE, _onOverlayComplete.bind(this));
            overlayView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION, function(e) {
                this.adSystem.dispatchEvent(new vdb.events.Event(vdb.events.AdEvent.AD_INTERACTION_END, e.data));
            }.bind(this));
            _initAdView.call(this, overlayView);
            var hideTime = overlayView.overlaySlotInfo.maxShowTime;
            if (isNaN(hideTime)) {
                hideTime = overlayView._mediaContent.minSuggestedDuration;
            }
            if (hideTime !== Number.POSITIVE_INFINITY) {
                hideTime = (isNaN(hideTime) ? 15 : hideTime) * 1E3;
                this._overlayTimer.schedule(_killAds.bind(this), hideTime);
            }
        }
    };
    var _onOverlayComplete = function() {
        if (this.isStageTracked(vdb.ads.AdStage.STARTED)) {
            this.trackFlow(vdb.ads.AdStage.FINISHED);
        } else {
            this.trackFlow(vdb.ads.AdStage.FAILOVER);
        }
    };
    var stop = function() {
        this._overlayTimer.stop();
        if (this.ad && this.ad.state.loaded) {
            _killAds.call(this);
        } else {
            this.trackFlow(vdb.ads.AdStage.EARLY_STOP);
        }
        this._currentCreative = null;
        this._super();
    };
    var skip = function() {
        this._skipped = true;
        if (this._activeAdView) {
            this._activeAdView.dispatchVastTrackerEvent(vdb.enums.VastEvents.SKIP);
            this._activeAdView.skip();
        } else {
            _killAds.call(this, true);
        }
    };
    var pause = function() {
        LOGGER.debug("pause");
        if (this._started) {
            this._overlayTimer.pause();
            for (var i = 0;i < this._views.length;i++) {
                this._views[i].pause();
            }
        }
    };
    var resume = function() {
        LOGGER.debug("resume");
        if (this._started) {
            this._overlayTimer.resume();
            for (var i = 0;i < this._views.length;i++) {
                this._views[i].resume();
            }
        }
    };
    var setVolume = function(volume) {
        LOGGER.debug("setVolume", volume);
        for (var i = 0;i < this._views.length;i++) {
            this._views[i].setVolume(volume);
        }
    };
    var getDuration = function() {
        var duration = 0;
        for (var i = 0;i < this._views.length;i++) {
            if (this._views[i].getDuration) {
                duration = Math.max(duration, this._views[i].getDuration());
            }
        }
        return duration;
    };
    var getAdSkippableState = function() {
        var adSkippableState = this._currentCreative ? this._currentCreative.skippable : false;
        if (this.currentAdView.getAdSkippableState) {
            var skipState = this.currentAdView.getAdSkippableState();
            adSkippableState = typeof skipState !== "undefined" ? skipState : adSkippableState;
        }
        return adSkippableState;
    };
    var getVastAdNumber = function() {
        return this.ad && this.ad.sequenceNumber;
    };
    var basicAdParams = function(adStage, additional, adId) {
        if (!adId && this._flowParams) {
            adId = this._flowParams.adImpressionId;
        }
        return this._super(adStage, additional, adId);
    };
    var trackFlow = function(adStage, params) {
        params = params || {};
        if (this._currentCreative) {
            params.adDuration = this._currentCreative.duration;
        }
        if (this._flowParams) {
            if (this._flowParams.adPlacementId) {
                params.adPlacementId = this._flowParams.adPlacementId;
            }
            if (this._flowParams.advertiserId) {
                params.advertiserId = this._flowParams.advertiserId;
            }
            if (this._mediaFile) {
                params.mediaFile = this._mediaFile;
            }
        }
        if (this._failedAds) {
            params.failedAds = this._failedAds;
        }
        this._super(adStage, params);
    };
    var _failOver = function(error) {
        if (_getMediaExtensions.call(this) !== "swf" || this._flashDetector.isFlashAvailable()) {
            this.trackFailoverAdIssue(error.description);
        }
        if (!this.isStageTracked(vdb.ads.AdStage.STARTED)) {
            this.currentAdView.dispatchVastEvent(vdb.html5.ads.modules.vast.event.VastEvent.ERROR, {error:error});
        } else {
            this._errorTracker.trackError("ad", null, "ad failed after start");
        }
        this._vastError = null;
        if (this._failedAds) {
            this._failedAds++;
        } else {
            this._failedAds = 1;
        }
        var noAdsError = _noAdsError.call(this) && this._vastModel.ads.length > 0;
        var isAdPodAllowed = _isAdPodAllowed.call(this);
        var playNext = noAdsError || isAdPodAllowed;
        var vastFailoverModel = this._vastModel.getFailoverModel(isAdPodAllowed);
        var failoverModel = vastFailoverModel || playNext && this._vastModel;
        var parentAdsWithErrors = this._vastModel.getParentAds(vastFailoverModel);
        for (var i = 0;i < parentAdsWithErrors.length;i++) {
            var parentAd = parentAdsWithErrors[i];
            var vastEvent = new vdb.html5.ads.modules.vast.event.VastEvent(vdb.html5.ads.modules.vast.event.VastEvent.ERROR, null, null, {error:error});
            parentAd.dispatchEvent(vastEvent);
            this._eventHandler.onVastEvent(vastEvent);
        }
        if (failoverModel) {
            var adIndex = 0;
            if (isAdPodAllowed) {
                for (var y = 0;y < failoverModel.ads.length;y++) {
                    if (failoverModel.ads[y] && !failoverModel.ads[y].sequence) {
                        adIndex = y;
                        break;
                    }
                }
            }
            var ad = failoverModel.ads[adIndex];
            if (ad) {
                this._vastModel = failoverModel;
                if (ad.isWrapper) {
                    _processFailoverWrapper.call(this, adIndex);
                } else {
                    this._vastModel.ads.splice(adIndex, 1);
                    LOGGER.debug("showNextLinearCreative", "show failover ad");
                    _prepareCreatives.call(this, ad);
                    _showFirstLinearCreative.call(this);
                }
                return true;
            }
        }
        if (this.isStageTracked(vdb.ads.AdStage.LOADED) && !this.isStageTracked(vdb.ads.AdStage.STARTED)) {
            this.trackFlow(vdb.ads.AdStage.FAILOVER);
        }
        return false;
    };
    var _noAdsError = function() {
        if (this._lastError) {
            return/^(n|.*n)o ads/i.test(this._lastError.message);
        }
        return false;
    };
    var _processFailoverWrapper = function(adIndex) {
        this._vastLoader._startTimer();
        this._vastLoader.processFailoverWrapper(this._vastModel, adIndex);
    };
    var _processModel = function(vastModel) {
        this._vastLoader._startTimer();
        this._vastLoader.processModel(vastModel);
    };
    var _showFirstLinearCreative = function() {
        LOGGER.debug("showFirstLinearCreative", this._linearCreatives);
        if (this._linearCreatives.length === 0) {
            if (this.ad) {
                this.currentAdView = new vdb.html5.ads.modules.vast.view.LinearView(this._forceStopTimer, this._adContainer, this.ad, {}, {}, this._configEntry, this.adSystem, this._display);
                var error = _createVastError.call(this, vdb.html5.ads.modules.vast.errorCodes.NO_SUITABLE_CREATIVE);
                var failedOver = _failOver.call(this, error);
                if (!failedOver) {
                    this.complete();
                }
            } else {
                this.complete();
            }
        } else {
            this._lastError = null;
            this._currentCreative = this._linearCreatives.shift();
            this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(CustomVastEvents.LOADED, this._currentCreative));
            if (!this._isFirstAd) {
                this.adLoaded();
            } else {
                this._isFirstAd = false;
            }
            var size = getAdContainerSize.call(this);
            this._mediaFile = this._linearResolver.resolveMediaFiles(size.width, size.height, this._currentCreative.mediaFiles);
            if (this._mediaFile && this._mediaFile.url) {
                _prepareExtensions.call(this);
                this.adSystem.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_LOADING, {ad:this._configEntry, url:this._mediaFile.url}));
                var adView = new vdb.html5.ads.modules.vast.view.LinearView(this._forceStopTimer, this._adContainer, this.ad, this._currentCreative, this._mediaFile, this._configEntry, this.adSystem, this._display);
                this.currentAdView = adView;
                _clearAdViewEventsContext.call(this);
                this._adViewEventsContext = EventContext.group(EventContext.bind(adView, vdb.events.AdRemainingTimeUpdateEvent.TYPE, _onAdRemainingTimeUpdate.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPLETE, function(event) {
                    _completeAd.call(this, adView, event);
                }.bind(this)), EventContext.bind(adView, vdb.events.AdEvent.AD_LINEAR_CHANGE, _onLinearChange.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.IMPRESSION, this.impression.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_STARTING, this.adStarting.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_STARTED, function(event) {
                    this.adStarted(event, adView);
                    this.adSystem.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_LOADED, {ad:this._configEntry}));
                    _checkDuration.call(this);
                }.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_PAUSED, this.adPaused.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_VOLUME_CHANGED, this.adVolumeChanged.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_TIMEUPDATE, function(event) {
                    this.adTimeUpdate(event);
                    _skippableCheck.call(this, event);
                }.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_WAITING, this.adWaiting.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_INTERACTION, this.trackAdInteraction.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_RESUMED, this.adResumed.bind(this)), EventContext.bind(adView, vdb.html5.ads.modules.vast.event.AdHonestyErrorEvent.UNIQUE_ERROR, function(event) {
                    _trackError.call(this, event);
                }.bind(this)));
                this._views.push(adView);
                _initAdView.call(this, adView);
            } else {
                _showFirstLinearCreative.call(this);
            }
        }
    };
    var _trackError = function(event) {
        var message = 'VPAID sends "' + event.data + '" event twice';
        this._errorTracker.trackError("ad", null, message);
    };
    var _checkDuration = function() {
        var adDuration = +this.currentAdView.getDuration();
        var creativeDuration = +this._currentCreative.duration;
        if (adDuration > 0 && (adDuration > 1.8 * creativeDuration || creativeDuration > 1.8 * adDuration)) {
            this._errorTracker.trackError("ad", null, "ad duration mismatch: expected " + creativeDuration + " but real duration: " + adDuration);
        }
    };
    var _skippableCheck = function(event) {
        var creative = this._currentCreative || {};
        if (!creative.skippable || this._skippableDispatched) {
            return;
        }
        var time = 0;
        var data = event.data || {};
        if (creative.skipOffsetTime) {
            time = creative.skipOffsetTime;
        } else {
            if (creative.skipOffsetPercent) {
                time = data.duration * creative.skipOffsetPercent / 100;
            }
        }
        if (data.currentTime >= time) {
            this._skippableDispatched = true;
            this.adSystem.dispatchEvent(new vdb.events.Event(vdb.events.AdEvent.AD_SKIPPABLE_STATE_CHANGE, {skippable:this.getAdSkippableState()}));
        }
    };
    var _clearAdViewEventsContext = function() {
        if (this._adViewEventsContext) {
            this._adViewEventsContext.unbind();
            this._adViewEventsContext = null;
        }
    };
    var _onLinearChange = function(e) {
        LOGGER.debug("received linear change event", e);
        if (!e.data.isLinear) {
            this.trackFlow(vdb.ads.AdStage.NON_LINEAR);
        }
        this.adSystem.dispatchEvent(vdb.html5.ads.events.AdSystemEvent.LINEAR_CHANGE, e);
    };
    var _showNextLinearCreative = function() {
        LOGGER.debug("showNextLinearCreative");
        if (this._lastError) {
            if (!this._vastError) {
                this._vastError = _createVastError.call(this);
            }
            var failedOver = _failOver.call(this, this._vastError);
            if (!failedOver) {
                _completeAd.call(this);
            }
        } else {
            var isAdPod = _isAdPodAllowed.call(this) && _isNextAdPodAllowed.call(this);
            if (this.adSystem.isNextAdPodAllowed() || isAdPod) {
                var preparedNextAd = _prepareNextAd.call(this);
                if (!preparedNextAd) {
                    _completeAd.call(this);
                }
            } else {
                _completeAd.call(this);
            }
        }
    };
    var _prepareNextAd = function() {
        var ad = this._vastModel.ads[0];
        if (ad) {
            if (ad.isWrapper) {
                _processModel.call(this, this._vastModel);
            } else {
                this._vastModel.ads.shift();
                _prepareCreatives.call(this, ad);
                _showFirstLinearCreative.call(this);
            }
            return true;
        }
        var parentWithAds = _getFirstParentWithAds.call(this);
        if (parentWithAds) {
            _processModel.call(this, parentWithAds, true);
            return true;
        }
        return false;
    };
    var _isAdPodAllowed = function() {
        return this._adsConfig.adsPodSize === -1;
    };
    var _isNextAdPodAllowed = function() {
        var ad = this._vastModel.ads[0];
        return!!(ad && ad.sequence);
    };
    var _getFirstParentWithAds = function() {
        for (var parentModel = this._vastModel.parent;parentModel && (parentModel.ads.length === 0 || !parentModel.ads[0].sequence);) {
            this._vastLoader._wrapperDepth -= 1;
            parentModel = parentModel.parent;
        }
        return parentModel;
    };
    var _getCompanionForSlot = function(slot, companions) {
        var i = -1;
        for (var len = companions.length;++i < len;) {
            if (companions[i].adSlotID === slot.parentSelector || +companions[i].width === slot.width && +companions[i].height === slot.height) {
                return companions[i];
            }
        }
        return null;
    };
    var _onAdRemainingTimeUpdate = function(event) {
        var time = event.remainingTime;
        if (this._forceStopTimer) {
            time = Math.min(this._forceStopTimer.remaining(), time);
        }
        var e = new vdb.events.AdRemainingTimeUpdateEvent(time);
        this.dispatchEvent(e);
        this.adSystem.dispatchEvent(e);
    };
    var _showCompanions = function(event) {
        LOGGER.debug("showCompanions", event);
        if (this._views.length > 1) {
            return;
        }
        for (var slotFilled = {};event;) {
            var ad = event.target;
            for (var i = 0;i < this._companionSlots.length;i++) {
                var slot = this._companionSlots[i];
                var slotId = slot.parentSelector;
                if (!slotFilled[slotId]) {
                    for (var j = 0;j < event.companionCreatives.length;j++) {
                        var creative = event.companionCreatives[j];
                        var companion = _getCompanionForSlot(slot, creative.companions);
                        if (companion) {
                            ad.addEventListener(vdb.html5.ads.modules.vast.event.CompanionTrackingEvent.COMPANION_TRACKING, _onVastEvent.bind(this));
                            var view = new vdb.html5.ads.modules.vast.view.CompanionView(ad, creative, companion, slot, this.adSystem);
                            this.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPANION_STARTED));
                            ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(CustomVastEvents.COMPANION_DISPLAY, creative));
                            this.reportCompanionShow();
                            this._companionEndCallback = _companionDied.bind(this);
                            view.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR, this._companionEndCallback);
                            view.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_FINISHED, this._companionEndCallback);
                            view.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_FORCE_FINISHED, this._companionEndCallback);
                            _initAdView.call(this, view);
                            this._views.push(view);
                            slotFilled[slotId] = true;
                            break;
                        }
                    }
                }
            }
            event = event._childEvent;
        }
    };
    var _companionDied = function(event) {
        LOGGER.debug("companionDied", event);
        var view = event.target;
        view.removeEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR, this._companionEndCallback);
        view.removeEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_FINISHED, this._companionEndCallback);
        view.removeEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_FORCE_FINISHED, this._companionEndCallback);
        this.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPANION_DIED));
    };
    var onInterrupted = function(loaderError) {
        var error = loaderError;
        if (!(error instanceof vdb.html5.ads.AdEngineError)) {
            if (error instanceof vdb.errors.TimeoutError) {
                error = new vdb.html5.ads.AdEngineError(loaderError.message, vdb.html5.ads.AdEngineError.SEVERITY_MID, loaderError.timeoutMs);
            } else {
                error = new vdb.html5.ads.AdEngineError(loaderError.message);
            }
        }
        LOGGER.debug("onInterrupted", error, "configEntry", this._configEntry);
        this._super(error);
        _completeAd.call(this);
    };
    var adFinished = function(currentTime, data) {
        this._super(currentTime, data);
        if (this.ad) {
            this.ad.dispatchEvent(new vdb.html5.ads.modules.vast.event.VastEvent(CustomVastEvents.STOPPED, this._currentCreative));
        }
        if (!_getFirstParentWithAds.call(this) && this._vastModel.ads.length === 0) {
            this.stop();
        }
        this.ad = null;
        this._skipped = false;
    };
    var _killAds = function(skipped) {
        LOGGER.debug("killAds");
        this._killed = true;
        this._overlayTimer.stop();
        this._linearCreatives.length = 0;
        if (this._views.length > 0) {
            for (var i = 0;i < this._views.length;i++) {
                this._views[i].stop();
            }
        } else {
            _completeAd.call(this);
        }
        if (!skipped) {
            this._views.length = 0;
        }
    };
    var _stopViews = function(adView, event) {
        var stoppingViews = [];
        var i;
        for (i = 0;i < this._views.length;i++) {
            var view = this._views[i];
            if (view !== adView) {
                stoppingViews.push(view);
            }
        }
        this._views.length = 0;
        if (stoppingViews.length === 0) {
            return null;
        }
        var sync = new vdb.utils.Synchronizer(stoppingViews, _completeAd.bind(this, adView, event));
        sync.useReleaseEvent(vdb.html5.ads.modules.vast.event.VastEngineEvent.COMPLETE);
        for (i = 0;i < stoppingViews.length;i++) {
            stoppingViews[i].stop();
        }
        return stoppingViews;
    };
    var _completeAd = function(adView, event) {
        LOGGER.debug("completeAd", adView, event);
        this._overlayTimer.stop();
        this._forceStop = false;
        if (event) {
            if (_stopViews.call(this, adView, event) != null) {
                return;
            }
            var adViewError = adView.getAdError();
            if (adViewError) {
                this._lastError = new vdb.html5.ads.AdEngineError(adViewError ? adViewError.message : "");
                this._vastError = _createVastError.call(this, adViewError && adViewError.code);
            }
            if (event.force) {
                this._forceStop = true;
            }
            this.adFinished(event.currentTime, event.data);
            if (adView instanceof vdb.html5.ads.modules.vast.view.LinearView) {
                _showNextLinearCreative.call(this);
                return;
            }
            if (adView instanceof vdb.html5.ads.modules.vast.view.OverlayView) {
                _completeAd.call(this);
                return;
            }
        }
        if (!this._forceStop) {
            this.complete();
        }
    };
    var _createVastError = function(error) {
        var environment = vdb.Utils.browser.isMobile() ? "mobile" : "desktop";
        var mediaExtensions = _getMediaExtensions.call(this);
        var code = error && error.code || DEFAULT_ERROR.code;
        var flashEnabled = this._flashDetector.isFlashAvailable() ? 1 : 0;
        var details = this._lastError && this._lastError.message || error && error.description || DEFAULT_ERROR.description;
        var message = environment + " : " + mediaExtensions + " : fs-" + flashEnabled + " : " + code + " " + details;
        return{code:code, description:message};
    };
    var getMediaContent = function() {
        for (var i = 0;i < this._views.length;i++) {
            var view = this._views[i];
            if (view.getMediaContent) {
                return view.getMediaContent();
            }
        }
        return null;
    };
    var _getMediaExtensions = function() {
        var url;
        var ext;
        var extensions = [];
        if (this.ad && this.ad.creatives && this.ad.creatives.length) {
            extensions = vdb.html5.ads.modules.vast.utils.VastUtils.getCreativesMediaExtensions(this.ad.creatives);
        } else {
            if (this._views && this._views.length) {
                for (var i = 0;i < this._views.length;i++) {
                    var view = this._views[i];
                    if (view.getMediaContent) {
                        url = (view.getMediaContent() || {}).url || "";
                        ext = vdb.Utils.getExtensionFromUrl(url) || url;
                        extensions.push(ext);
                    }
                }
            } else {
                if (this.currentAdView && this.currentAdView.getMediaContent) {
                    url = (this.currentAdView.getMediaContent() || {}).url || "";
                    ext = vdb.Utils.getExtensionFromUrl(url) || url;
                    extensions.push(ext);
                }
            }
        }
        return extensions.join(",");
    };
    var _initAdView = function(adView) {
        adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.CONTENT_PAUSE_REQUESTED, this.dispatchEvent.bind(this));
        adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_STARTED, this.dispatchEvent.bind(this));
        adView.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR, _viewErrorHandler.bind(this, adView));
        adView.initView(this.adSystem.getVolume());
        if (adView.creative && adView.creative.icons) {
            for (var i = 0;i < adView.creative.icons.length;i++) {
                (new vdb.html5.ads.modules.vast.view.IconElement(adView.creative.icons[i], this._display)).showInAd(adView);
            }
        }
    };
    var _viewErrorHandler = function(adView) {
        LOGGER.warn("VAST error occurred in ad", adView);
    };
    return{init:init, showLinearAd:showLinearAd, onLoaded:onLoaded, adFinished:adFinished, onInterrupted:onInterrupted, showOverlay:showOverlay, stop:stop, skip:skip, pause:pause, resume:resume, setVolume:setVolume, getDuration:getDuration, getAdSkippableState:getAdSkippableState, basicAdParams:basicAdParams, trackFlow:trackFlow, getVastAdNumber:getVastAdNumber, getMediaContent:getMediaContent, track:track, failOver:failOver};
}());
vdb.html5.ads.modules.vast.VastEngineProducer = vdb.html5.ads.AdEngineProducer.extend(function() {
    var LOGGER = vdb.log.getLogger("VastEngineProducer");
    return{init:function(adSystem, adsConfig, adContainers) {
        this._super(adSystem, adsConfig, adContainers);
        var flashDetector = adSystem.getInjector().resolveSync(vdb.enums.Dependencies.FLASH_DETECTOR);
        this._eventHandler = new vdb.html5.ads.modules.vast.event.handler.SimpleVastEventHandler(adSystem);
        this._vastParser = new vdb.html5.ads.modules.vast.parser.VastParser(adSystem);
        this._linearResolver = new vdb.html5.ads.modules.vast.LinearResolver(flashDetector);
        this._nonLinearResolver = new vdb.html5.ads.modules.vast.NonLinearResolver;
        this._companionSlots = adsConfig.companionSlots;
        this._hardTimeout = adsConfig.hardTimeout;
    }, createAdEngine:function(ad) {
        LOGGER.debug("createAdEngine", ad);
        var engine = vdb.html5.ads.modules.vast.VastEngine;
        var vastXml = ad.getVastXml();
        var hardTimeout = this._hardTimeout * 1E3;
        var vastAds;
        var vastLoader;
        var urls = this._adSystem.getInjector().resolveSync(vdb.enums.Dependencies.URLS);
        if (vastXml) {
            vastLoader = new vdb.html5.ads.modules.vast.loader.EmbedVastLoader(vastXml, this._vastParser, hardTimeout, this._eventHandler, urls, this._adSystem);
        } else {
            vastAds = ad.getVastAds();
            if (vastAds) {
                vastLoader = new vdb.html5.ads.modules.vast.loader.AdsVastLoader(vastAds, this._vastParser, hardTimeout, this._eventHandler, urls, this._adSystem);
            } else {
                vastLoader = new vdb.html5.ads.modules.vast.loader.VastLoader(ad, this._vastParser, hardTimeout, this._eventHandler, urls, this._adSystem);
            }
        }
        return new engine(this._adSystem, this._adsConfig, ad, vastLoader, this._linearResolver, this._nonLinearResolver, this._eventHandler, this._adContainers, this._companionSlots);
    }, getType:function() {
        return vdb.enums.AdEngineType.VAST;
    }};
}());
vdb.html5.ads.modules.vast.EmbedVastEngineProducer = vdb.html5.ads.modules.vast.VastEngineProducer.extend(function() {
    var LOGGER = vdb.log.getLogger("EmbedVastEngineProducer");
    return{createAdEngine:function(ad) {
        LOGGER.debug("createAdEngine", ad);
        var urls = this._adSystem.getInjector().resolveSync(vdb.enums.Dependencies.URLS);
        var vastLoader = new vdb.html5.ads.modules.vast.loader.EmbedVastLoader(ad.getVastXml(), this._vastParser, this._hardTimeout * 1E3, this._eventHandler, urls, this._adSystem);
        return new vdb.html5.ads.modules.vast.VastEngine(this._adSystem, this._adsConfig, ad, vastLoader, this._linearResolver, this._nonLinearResolver, this._eventHandler, this._adContainers, this._companionSlots);
    }, getType:function() {
        return vdb.enums.AdEngineType.EMBED_VAST;
    }};
}());
vdb.html5.ads.modules.vast.view.inner.InlinePlayerMediaElement = vdb.html5.ads.modules.vast.view.inner.AbstractMediaElement.extend(function() {
    var LOGGER = vdb.log.getLogger("InlinePlayerMediaElement");
    var Dependencies = vdb.enums.Dependencies;
    var State = {CREATED:"created", PLAYING:"playing", PAUSED:"paused", STOPPED:"stopped"};
    var init = function(display, videoUrl, config, injector) {
        this._super(display);
        LOGGER.debug("init", videoUrl);
        this._state = State.CREATED;
        this._videoUrl = videoUrl;
        this._config = config;
        this._inlineUrl = injector.resolveSync(Dependencies.URLS).getInlinePlayerUrl();
        this._environment = injector.resolveSync(Dependencies.ENVIRONMENT);
    };
    var createElement = function() {
        return vdb.Utils.createElement("div", {"class":"inline-player-unit", "style":"position: absolute; width: 100%; height: 100%; z-index: 1"});
    };
    var initElement = function() {
        var _this = this;
        var options = {"controls":true, "autoPlay":true};
        var iosMode = this._config.getMacro(vdb.constants.PlayerMacros.O2INLINE_IOS) || null;
        if (iosMode !== null) {
            options["iosMode"] = iosMode === "true";
        }
        _this._player = new vdb.html5.ads.modules.vast.adapter.InlinePlayerAdapter(this.element, options, this._inlineUrl, function() {
            _this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.CONTENT_PAUSE_REQUESTED));
            _attachEventListeners.call(_this);
            _this._player.loadVideo(_this._videoUrl);
        });
    };
    var _play = function() {
        if (!this._timeout) {
            this._timeout = setTimeout(_onError.bind(this), 2E3);
        }
        this._player.play();
    };
    var _attachEventListeners = function() {
        function listen(event, callback) {
            return vdb.events.EventContext.bind(_this._player, event, callback.bind(_this));
        }
        var _this = this;
        this._eventContext = vdb.events.EventContext.group(listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VIDEO_START, _onVideoStart), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VIDEO_PLAY, _onVideoPlay), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VIDEO_PAUSE, _onVideoPause), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VIDEO_END, _onVideoEnd), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VIDEO_TIMEUPDATE, _onVideoTimeUpdate), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VOLUME_CHANGE,
            _onVolumeChanged), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.ENTER_FULLSCREEN, _onEnterFullscreen), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.EXIT_FULLSCREEN, _onExitFullscreen), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.VIDEO_CLICK, _onVideoClick), listen(vdb.html5.ads.modules.vast.enums.InlinePlayerEvent.ERROR, _onError));
    };
    var _onEnterFullscreen = function() {
        LOGGER.debug("onEnterFullscreen");
    };
    var _onExitFullscreen = function() {
        LOGGER.debug("onExitFullscreen");
        this._display.hide();
    };
    var _onVideoClick = function() {
        LOGGER.debug("onVideoClick");
        this.adView.dispatchClickThrough();
    };
    var _onVideoPlay = function() {
        if (this._state === State.PAUSED) {
            _onVideoResume.call(this);
        }
        LOGGER.debug("onVideoPlay");
        this._state = State.PLAYING;
    };
    var _onVideoStart = function() {
        LOGGER.debug("onVideoStart");
        clearTimeout(this._timeout);
        this.adView.startRemainingTimer();
        this.trackOnce(vdb.enums.VastEvents.START);
        var event = {playerSubType:"inline"};
        this.onStart(event);
        this.onImpression();
        this._display.hide();
    };
    var _onVideoPause = function() {
        LOGGER.debug("onVideoPause");
        this._state = State.PAUSED;
        var event = {playerSubType:"inline"};
        this.adView._onPaused(event);
    };
    var _onVolumeChanged = function() {
        LOGGER.debug("onVolumeChanged");
        this.adView._onVolumeChanged();
    };
    var _onVideoTimeUpdate = function() {
        LOGGER.debug("onVideoTimeUpdate");
        var event = {currentTime:this.getCurrentTime(), duration:this.getDuration()};
        this.adView._onTimeUpdate(event);
        _checkVideoTime.call(this);
    };
    var _onVideoResume = function() {
        LOGGER.debug("onVideoResume");
        this._state = State.PLAYING;
        this.adView._onResumed();
    };
    var _onVideoEnd = function() {
        this._state = State.STOPPED;
        this.trackOnce(vdb.enums.VastEvents.COMPLETE);
        this._eventContext.unbind();
        var event = {currentTime:this._player.getCurrentTime(), data:{}};
        event.data.playerSubType = "inline";
        this.adView.complete(false, event);
    };
    var track = function(trackingType, data) {
        data = data || {};
        data.playerSubType = "inline";
        this._super(trackingType, data);
    };
    var load = function() {
        this._super();
        this.adView.noResize();
        this.adView.draw();
    };
    var stop = function() {
        LOGGER.debug("stop");
        this._player.stop();
        this._super();
    };
    var pause = function() {
        if (this._state === State.PLAYING) {
            this._player.pause();
        }
    };
    var resume = function() {
        if (this._state === State.PAUSED) {
            _play.call(this);
        }
    };
    var getRemainingTime = function() {
        return this._player.getRemainingTime();
    };
    var getCurrentTime = function() {
        return this._player.getCurrentTime();
    };
    var _checkVideoTime = function() {
        var percentage = this._player.getCurrentPercent();
        if (percentage > .25) {
            this.trackOnce(vdb.enums.VastEvents.FIRST_QUARTILE);
        }
        if (percentage > .5) {
            this.trackOnce(vdb.enums.VastEvents.MIDPOINT);
        }
        if (percentage > .75) {
            this.trackOnce(vdb.enums.VastEvents.THIRD_QUARTILE);
        }
    };
    var setVolume = function(volume) {
        if (!this._player) {
            return;
        }
        if (!volume) {
            this._player.mute();
        } else {
            this._player.unmute();
        }
    };
    var getDuration = function() {
        return this._player.getDuration();
    };
    var getVolume = function() {
        return this._player.getVolume();
    };
    var _onError = function(e) {
        LOGGER.debug("onError", e);
        _stopByError.call(this, e ? e.message : "Inline player stopped by timeout");
    };
    var _stopByError = function(message) {
        LOGGER.debug("stopByError", message);
        this._state = State.STOPPED;
        this.error = new vdb.html5.ads.modules.vast.ex.VastError(vdb.html5.ads.modules.vast.errorCodes.GENERAL_VPAID_ERROR.code, "Inline Player: " + message);
        this.adView.dispatchEvent(new vdb.events.Event(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_ERROR), message);
        this.stop();
    };
    return{init:init, load:load, createElement:createElement, initElement:initElement, track:track, getRemainingTime:getRemainingTime, getCurrentTime:getCurrentTime, stop:stop, pause:pause, resume:resume, setVolume:setVolume, getDuration:getDuration, getVolume:getVolume};
}());
vdb.html5.ads.SlotOpportunityHandler = vdb.core.Class.extend(function() {
    var EventContext = vdb.events.EventContext;
    var USER_SKIP = "UAX_SKIP";
    var _extractResponseInfo = function(response) {
        this._slot = response["slot"];
        this._transactionId = response["txid"];
        this._adxResult = response["adxResult"];
        this._usid = response["usid"];
    };
    var _onAdEntriesLoaded = function(event) {
        var response = event.data.response || {};
        this._type = event.data.type;
        _extractResponseInfo.call(this, response);
        if (this._slot) {
            this._group && this._group.unbind();
            this._group = EventContext.empty();
            if (this._adxResult === "LOOKAHEAD") {
                EventContext.bindOnce(this._adSystem, vdb.events.AdEvent.AD_SKIPPED, _sendSlotOpportunity.bind(this, USER_SKIP)).link(this._group);
                EventContext.bindOnce(this._adSystem, vdb.events.AdEvent.AD_BLOCKER_COMPLETE, _sendSlotOpportunity.bind(this, this._slot)).link(this._group);
            } else {
                EventContext.bindOnce(this._environment, vdb.events.EnvironmentEvent.VIDEO_START, _sendSlotOpportunity.bind(this, this._slot)).link(this._group);
            }
            EventContext.bindOnce(this._adSystem, vdb.events.AdEvent.AD_STARTING, _sendSlotOpportunity.bind(this, this._slot)).link(this._group);
        }
    };
    var _sendSlotOpportunity = function(slot) {
        this._adSystem.dispatchEvent(new vdb.events.TrackEvent(vdb.events.TrackEvent.AD_SLOT_OPPORTUNITY, {slot:slot || this._slot, type:this._type, transactionId:this._transactionId, adxResult:this._adxResult, usid:this._usid, displayWidth:this.adContainers.adContainer.offsetWidth}));
    };
    return{init:function(adSystem) {
        this._adSystem = adSystem;
        this.adContainers = adSystem.getAdContainers();
        this._adSystem.addEventListener(vdb.html5.ads.loaders.BaseAdEntriesLoader.LOADED, _onAdEntriesLoaded.bind(this));
        this._environment = this._adSystem.getInjector().resolveSync(vdb.enums.Dependencies.ENVIRONMENT);
    }};
}());
vdb.html5.ads.tracking = {};
vdb.html5.ads.tracking.AdTracker = vdb.tracking.PixelTracker.extend(function() {
    var LOGGER = vdb.log.getLogger("AdTracker");
    var NONE = "None";
    var PER_AD = "Per Ad";
    var SHARE = "Revenue Share";
    var init = function(dependencies) {
        this._super(dependencies);
        this._eventBus = dependencies[vdb.enums.Dependencies.EVENT_BUS];
        this._flashDetector = dependencies[vdb.enums.Dependencies.FLASH_DETECTOR];
    };
    var attach = function() {
        var TrackEvent = vdb.events.TrackEvent;
        if (!this._eventContext) {
            this._eventContext = vdb.events.EventContext.group(_listen.call(this, TrackEvent.REVENUE_SHARE, trackRevenueShare), _listen.call(this, TrackEvent.AD_REQUEST, trackAdRequest), _listen.call(this, TrackEvent.AD_ISSUE, trackAdIssue), _listen.call(this, TrackEvent.AD_ENGINE_REQUEST, trackAdEngineRequest), _listen.call(this, TrackEvent.AD_ENGINE_RESPONSE, trackAdEngineResponse), _listen.call(this, TrackEvent.AD_ENGINE_FLOW, trackAdEngineFlow), _listen.call(this, TrackEvent.AD_INTERACTION, trackAdInteraction),
                _listen.call(this, TrackEvent.AD_FALLBACK, trackAdFallback), _listen.call(this, TrackEvent.CLICK, trackAdClick), _listen.call(this, TrackEvent.AD_SLOT_OPPORTUNITY, trackSlotOpportunity));
        }
    };
    var detach = function() {
        if (this._eventContext) {
            this._eventContext.unbind();
        }
    };
    var _listen = function(eventType, listener) {
        return vdb.events.EventContext.bind(this._eventBus, eventType, listener.bind(this));
    };
    var trackRevenueShare = function(trackEvent) {
        var amount;
        switch(this._payout) {
            case PER_AD:
                amount = this._amount / 1E3;
                break;
            case SHARE:
                amount = trackEvent.data["costPerImpression"] / 1E3 * this._amount;
                break;
        }
        if (amount) {
            this.callPixel("prs.gif", {"amt":vdb.Utils.base64Encode(amount)});
        }
    };
    var trackAdRequest = function(trackEvent) {
        LOGGER.debug("trackAdRequest", trackEvent);
        var result = {};
        this.generatePixelParams({"at":trackEvent.data.type.toLowerCase(), "vid":_getVideoId.call(this), "ps":vdb.Utils.getPlatformSupport(this._flashDetector.isFlashAvailable())}, {}, result);
        this.viewabilityParams(result);
        this.callPixel("ad-request.gif", result);
    };
    var trackAdIssue = function(trackEvent) {
        LOGGER.debug("trackAdIssue", trackEvent);
        var result = {};
        _baseParams.call(this, trackEvent, result);
        _issueParams.call(this, trackEvent, result);
        this.generatePixelParams({}, {"sact":this._config.getSact()}, result);
        this.callPixel("ad-issue.gif", result);
    };
    var trackAdEngineRequest = function(trackEvent) {
        LOGGER.debug("trackAdEngineRequest", trackEvent);
        var result = {};
        _baseParams.call(this, trackEvent, result);
        this.viewabilityParams(result);
        this.generatePixelParams({}, {"h":trackEvent.data.displayHeight, "auid":trackEvent.data["auid"], "sact":this._config.getSact()}, result);
        this.callPixel("ad-engine-request.gif", result);
        _trkAdRequest.call(this, result);
    };
    var trackAdEngineResponse = function(trackEvent) {
        LOGGER.debug("trackAdEngineResponse", trackEvent);
        var result = {};
        _baseParams.call(this, trackEvent, result);
        _responseParams.call(this, trackEvent, result);
        this.generatePixelParams({}, {"h":trackEvent.data.displayHeight, "auid":trackEvent.data["auid"], "sact":this._config.getSact()}, result);
        this.callPixel("ad-engine-response.gif", result);
    };
    var _trkAdRequest = function(parameters) {
        if (this._domainOptimisation && (parameters["acid"] || parameters["rid"])) {
            _trkAdPixel.call(this, this._urls.getAdTrackingUrl("ads/ad-request.gif"), parameters);
        }
    };
    var _trkAdPixel = function(baseUrl, parameters) {
        var pixelParams = {};
        vdb.Utils.copy(this._config.getParameters(), pixelParams);
        vdb.Utils.copy(parameters, pixelParams);
        var pixelURL = baseUrl + (pixelParams ? "?" + vdb.Utils.serialize(pixelParams) : "");
        this._callUrl(pixelURL);
    };
    var trackAdEngineFlow = function(trackEvent) {
        LOGGER.debug("trackAdEngineFlow", trackEvent);
        var result = {};
        _baseParams.call(this, trackEvent, result);
        _issueParams.call(this, trackEvent, result);
        _flowParams.call(this, trackEvent, result);
        this.viewabilityParams(result);
        this.generatePixelParams({}, {"auid":trackEvent.data["auid"], "sact":this._config.getSact()}, result);
        this.callPixel("ad-engine-flow.gif", result);
        if (result["stg"] === vdb.ads.AdStage.STARTED) {
            _trkAdStart.call(this, result);
        }
    };
    var trackAdInteraction = function(trackEvent) {
        LOGGER.debug("trackAdInteraction", trackEvent);
        var result = {};
        _baseParams.call(this, trackEvent, result);
        this.generatePixelParams({"action":trackEvent.data.action}, {}, result);
        this.callPixel("ad-interaction.gif", result);
    };
    var _trkAdStart = function(parameters) {
        if (parameters["acid"] || parameters["rid"]) {
            _trkAdPixel.call(this, this._urls.getAdServerUrl("ads/ad-start.gif"), parameters);
        }
    };
    var trackAdFallback = function(trackEvent) {
        LOGGER.debug("trackAdFallback", trackEvent);
        var result = {};
        _baseParams.call(this, trackEvent, result);
        _fallbackParams(trackEvent, result);
        this.callPixel("ad-fallback.gif", result);
    };
    var trackAdClick = function(trackEvent) {
        LOGGER.debug("trackAdClick", trackEvent);
        var params = {};
        _baseParams.call(this, trackEvent, params);
        this.generatePixelParams({"t":this._environment.getCurrentVideo()["time"] || 0, "ct":trackEvent.data.clickType, "cd":trackEvent.data.clickThroughUrl || "none"}, {}, params);
        this.callPixel("click.gif", params);
    };
    var trackSlotOpportunity = function(trackEvent) {
        LOGGER.debug("trackSlotOpportunity", trackEvent);
        var params = {};
        _baseParams.call(this, trackEvent, params);
        this.generatePixelParams({"slot":trackEvent.data.slot, "atsub":trackEvent.data.adxResult === "LOOKAHEAD" ? "SKIPPABLE_PREROLL" : ""}, {}, params);
        this.viewabilityParams(params);
        this.callPixel("slot-opp.gif", params);
    };
    var _getVideoId = function() {
        return this._environment.getCurrentVideoId();
    };
    var _getIntegration = function() {
        return this._environment.getIntegration();
    };
    var _getCrtParam = function(trackEvent) {
        var mediaFile = trackEvent.data.mediaFile;
        if (mediaFile) {
            var resources = mediaFile.resources;
            var mimeType = resources && resources[0] && resources[0].mimeType || mediaFile.mimeType;
            return mediaFile.apiFramework ? mediaFile.apiFramework + " " + mimeType : mimeType;
        }
    };
    var _baseParams = function(trackEvent, result) {
        var data = trackEvent.data || {};
        var sequence = data.sequence || -1;
        return this.generatePixelParams({"at":(data["type"] || "").toLowerCase()}, {"asid":data["asid"], "acid":data["acid"], "vid":_getVideoId.call(this), "v":data["vendor"], "aen":data["name"], "scope":data["isHouseAd"] ? "ha" : null, "rid":data["ruleId"], "txid":data["transactionId"], "rcid":data["ruleCompanyId"], "pst":data.playerSubType, "pbl":data["isPayable"], "pc":data["profitCenter"], "sfbid":data["bookingId"], "sfliid":data["lineItemId"], "adIdx":sequence, "ps":vdb.Utils.getPlatformSupport(this._flashDetector.isFlashAvailable()),
            "w":data && data.displayWidth, "usid":data["usid"], "itg":_getIntegration.call(this)}, result);
    };
    var _issueParams = function(trackEvent, result) {
        var data = trackEvent.data;
        return this.generatePixelParams({"stg":data.adStage, "curl":data["url"] || "", "crt":_getCrtParam(trackEvent) || ""}, {"aid":data.adImpressionId, "dt":data.details, "al":data.adDuration}, result);
    };
    var _responseParams = function(trackEvent, result) {
        var loadTime = trackEvent.data.latency / 100;
        var sto = this._adsConfig.softTimeout;
        var hto = this._adsConfig.hardTimeout;
        return this.generatePixelParams({"ar":trackEvent.data.isSuccess ? "yes" : trackEvent.data.timeout ? "timeout" : "no", "aert":trackEvent.data.latency, "ft":loadTime <= sto ? 0 : loadTime <= hto ? 1 : 2, "fo":trackEvent.data.vastAdsNumber}, {"to":trackEvent.data.timeout}, result);
    };
    var _flowParams = function(trackEvent, result) {
        var failedAds = trackEvent.data.failedAds || 0;
        var failOverCounter = trackEvent.data.adStage && trackEvent.data.adStage !== "win" && trackEvent.data.adStage !== "loaded" ? failedAds : undefined;
        return this.generatePixelParams({"avid":trackEvent.data.advertiserId, "h":trackEvent.data.displayHeight, "ap":trackEvent.data.autoPlay, "m":trackEvent.data.muted, "cpm":trackEvent.data.costPerImpression, "atsub":trackEvent.data.adxResult === "LOOKAHEAD" ? "SKIPPABLE_PREROLL" : "", "fo":failOverCounter}, {"ltc":trackEvent.data.latency}, result);
    };
    var _fallbackParams = function(trackEvent, result) {
        return this.generatePixelParams({"ac":trackEvent.data.adCycles}, {}, result);
    };
    var setAdsConfig = function(adsConfig) {
        this._adsConfig = adsConfig;
        this._payout = adsConfig.publisherPayout || NONE;
        this._amount = adsConfig.publisherAmount;
        this._domainOptimisation = adsConfig.domainOptimisation;
        if (this._payout == SHARE) {
            if (this._amount < 0) {
                this._amount = 0;
            }
            if (this._amount > 100) {
                this._amount = 100;
            }
            if (this._amount > 1) {
                this._amount /= 100;
            }
        }
    };
    return{init:init, attach:attach, detach:detach, setAdsConfig:setAdsConfig};
}(), [vdb.enums.Dependencies.EVENT_BUS, vdb.enums.Dependencies.FLASH_DETECTOR]);
vdb.html5.ads.tracking.SyncPixelsTracker = function() {
    var pixels = ["https://cm.g.doubleclick.net/pixel?google_nid=adaptv_dbm&google_cm&google_sc", "https://match.adsrvr.org/track/cmf/generic?ttd_pid=adaptv&ttd_tpi=1", "https://sync.adaptv.advertising.com/sync?rUrl=https%3A%2F%2Fpr-bh.ybp.yahoo.com%2Fsync%2Fadaptv_ortb%2F%7Buid%7D"];
    var sync = function() {
        if (Math.random() < .02) {
            pixels.forEach(function(pixelURL) {
                var tracker = vdb.dom.createElement("img");
                tracker.src = pixelURL;
            });
        }
    };
    return{sync:sync};
}();
vdb.utils.AdMacrosResolver = vdb.utils.MacrosResolver.extend(function() {
    var ReportingMacros = vdb.enums.ReportingMacros;
    return{init:function(adSystem, adsConfig) {
        this._adSystem = adSystem;
        this._super(adSystem.getInjector(), adsConfig);
    }, initRules:function() {
        var adConfigEntry = this._adSystem.getAdConfigEntry();
        var cpm = adConfigEntry && adConfigEntry.getCpm() || "";
        this._super();
        this._rules.push(ReportingMacros.ADSEQ.concat(this._adSystem.getVastAdNumber()), ReportingMacros.ECPM.concat(cpm));
    }};
}());
vdb.utils.AdTimeLogger = vdb.core.Class.extend(function() {
    return{init:function(adSystem) {
        this._log = {"initTime":+new Date, "startAdTime":null, "adStartTime":null, "adServerRequests":[]};
        this._adSlot = null;
        this._currentGroup = null;
        this._adChains = [];
        this._adSystem = adSystem;
        this.addAdListeners();
    }, getLog:function() {
        return this._log;
    }, addAdListeners:function() {
        this._adSystem.addEventListener(vdb.html5.ads.loaders.BaseAdEntriesLoader.LOADING, function(event) {
            this.addAdServer(event);
        }.bind(this));
        this._adSystem.addEventListener(vdb.html5.ads.loaders.BaseAdEntriesLoader.LOADED, function(event) {
            this.finishAdServer("LOADED", event);
        }.bind(this));
        this._adSystem.addEventListener(vdb.html5.ads.loaders.BaseAdEntriesLoader.FAILED, function(event) {
            this.finishAdServer("FAILED", event);
        }.bind(this));
        this._adSystem.addEventListener(vdb.events.AdEvent.AD_ENGINE_RUN, function() {
            this.finishAd();
        }.bind(this));
        this._adSystem.addEventListener(vdb.events.AdEvent.AD_BLOCKER_COMPLETE, function() {
            this.finishAd();
        }.bind(this));
        this._adSystem.addEventListener(vdb.events.AdEvent.AD_NONE, function() {
            this.finishAd();
        }.bind(this));
        this._adSystem.addEventListener(vdb.events.AdEvent.AD_ENGINES_LOAD, function(event) {
            this.addAdGroup();
            this.addAdGroupListeners(event);
        }.bind(this));
        this._adSystem.addEventListener(vdb.html5.ads.modules.vast.loader.VastLoader.VAST_LOADING, function(event) {
            this.addAdChain(event.data);
        }.bind(this));
        this._adSystem.addEventListener(vdb.html5.ads.modules.vast.loader.VastLoader.VAST_LOADED, function(event) {
            this.finishAdChain(event.data);
        }.bind(this));
        this._adSystem.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_LOADING, function(event) {
            this.addAdMediaFile(event.data);
        }.bind(this));
        this._adSystem.addEventListener(vdb.html5.ads.modules.vast.event.VastEngineEvent.AD_LOADED, function(event) {
            this.finishAdMediaFile(event.data);
        }.bind(this));
    }, finishAd:function() {
        if (!this._log["adStartTime"]) {
            this._log["startAdTime"] = +new Date;
            this._log["adStartTime"] = this._log["startAdTime"] - this._log["initTime"];
            this.finishAdGroup();
        }
    }, addAdGroupListeners:function(entries) {
        for (var x = 0;x < entries.length;x++) {
            var engineAdapter = entries[x];
            var adLogger = this.addAd(engineAdapter);
            engineAdapter.addEventListener(vdb.events.AdEvent.AD_ENGINE_READY, function(ad) {
                ad["end"] = +new Date;
                ad["duration"] = ad["end"] - ad["start"];
            }.bind(this, adLogger));
            engineAdapter.addEventListener(vdb.events.AdEvent.AD_ENGINE_COMPLETE, function(ad) {
                ad["complete"] = +new Date;
            }.bind(this, adLogger));
        }
    }, addAdServer:function(event) {
        var eventData = event && event.data || {};
        if (this._adSlot && !this._adSlot["adServerResponse"]) {
            this.finishAdServer("FAILED");
        }
        this._adSlot = {"label":"adServerRequest", "start":+new Date, "end":null, "duration":null, "requestUrl":null, "type":eventData.type, "adStrategy":eventData.adStrategy, "adGroups":[]};
        this._log["adServerRequests"].push(this._adSlot);
        return this._adSlot;
    }, finishAdServer:function(status, event) {
        if (!this._adSlot) {
            this.addAdServer();
        }
        var adServer = this._adSlot;
        adServer["end"] = +new Date;
        adServer["duration"] = adServer["end"] - adServer["start"];
        adServer["requestUrl"] = event && event.data && event.data.requestUrl || null;
        adServer["status"] = status;
    }, addAdGroup:function() {
        if (!this._adSlot) {
            this.addAdServer();
        }
        if (this._currentGroup && !this._currentGroup["end"]) {
            this.finishAdGroup();
        }
        this._currentGroup = {"label":"aegGroup", "start":+new Date, "end":null, "duration":null, "ads":[]};
        this._adSlot["adGroups"].push(this._currentGroup);
        return this._currentGroup;
    }, finishAdGroup:function() {
        if (this._currentGroup) {
            this._currentGroup["end"] = +new Date;
            this._currentGroup["duration"] = this._currentGroup["end"] - this._currentGroup["start"];
        }
    }, addAd:function(engineAdapter) {
        var configEntry = engineAdapter.getAdConfigEntry();
        var acid = "";
        var type = "";
        var vendor = "";
        var name = "";
        if (configEntry) {
            acid = configEntry.getAcid();
            type = configEntry.getType();
            vendor = configEntry.getVendor();
            name = configEntry.getName();
        }
        var ad = {"start":+new Date, "end":null, "duration":null, "name":name, "type":type, "vendor":vendor, "acid/rcid":acid, "adChain":[], "adMediaFiles":[]};
        var chain = {ad:ad, entry:configEntry};
        this._adChains.push(chain);
        this._currentGroup["ads"].push(ad);
        return ad;
    }, getAdByEntry:function(entry) {
        var ad = null;
        for (var x = 0;x < this._adChains.length;x++) {
            if (this._adChains[x].entry === entry) {
                ad = this._adChains[x].ad;
            }
        }
        return ad;
    }, addAdChain:function(data) {
        var ad = this.getAdByEntry(data.ad);
        if (ad) {
            ad["adChain"].push({"url":data.url, "start":+new Date, "end":null, "duration":null});
        }
    }, finishAdChain:function(data) {
        var ad = this.getAdByEntry(data.ad);
        if (ad && ad["adChain"].length) {
            var lastChain = ad["adChain"][ad["adChain"].length - 1];
            lastChain["end"] = +new Date;
            lastChain["duration"] = lastChain["end"] - lastChain["start"];
        }
    }, addAdMediaFile:function(data) {
        var ad = this.getAdByEntry(data.ad);
        if (ad) {
            ad["adMediaFiles"].push({"url":data.url, "start":+new Date, "end":null, "duration":null});
        }
    }, finishAdMediaFile:function(data) {
        var ad = this.getAdByEntry(data.ad);
        if (ad && ad["adMediaFiles"].length) {
            var lastFile = ad["adMediaFiles"][ad["adMediaFiles"].length - 1];
            lastFile["end"] = +new Date;
            lastFile["duration"] = lastFile["end"] - lastFile["start"];
        }
    }};
}());
vdb.html5.ads.VideoAdsLimiter = vdb.core.Class.extend(function() {
    return{init:function(adsConfig, adSystem) {
        this.conf = adsConfig;
        this._adsCount = 0;
        var that = this;
        var incrementCounter = function() {
            that._adsCount += 1;
        };
        var resetCounter = function() {
            that._adsCount = 0;
        };
        vdb.events.EventContext.bind(adSystem, vdb.events.AdEvent.AD_STARTED, incrementCounter);
        var environment = adSystem.getInjector().resolveSync(vdb.enums.Dependencies.ENVIRONMENT);
        vdb.events.EventContext.bind(environment, vdb.events.EnvironmentEvent.VIDEO_SELECTED, resetCounter);
    }, isNextAllowed:function() {
        return this._adsCount < this.conf.maxAdsPerVideo;
    }, setAdsConfig:function(adsConfig) {
        this.conf = adsConfig;
    }};
}());
vdb.html5.ads.AdSystem = vdb.core.Class.extend(function() {
    function init(injector, adContainers) {
        this._adContainers = adContainers;
        this._adsLeft = 0;
        this._adsLoaded = 0;
        this._adSequence = 0;
        this._injector = injector ? injector.createChild() : new vdb.ioc.Injector;
        this._eventBus = new vdb.EventBus;
        _prepareDependencies.call(this);
        this._prerollRequest = 0;
        this._volume = vdb.Utils.mobileOs() ? 0 : 1;
        this._adEngineProducers = {};
        this._hasSucessfulAdGroup = false;
        this.failedOver = false;
        this._adsPodPlayed = 0;
        this._eventGroup = new vdb.events.EventContextBindGroup;
        vdb.html5.ads.tracking.SyncPixelsTracker.sync();
    }
    function _registerProducers() {
        this.registerAdEngineProducer(new vdb.html5.ads.modules.vast.VastEngineProducer(this, this._adsConfig, this._adContainers));
        this.registerAdEngineProducer(new vdb.html5.ads.modules.vast.EmbedVastEngineProducer(this, this._adsConfig, this._adContainers));
        this.registerAdEngineProducer(new vdb.html5.ads.modules.ima.ImaEngineProducer(this, this._adsConfig, this._adContainers));
    }
    function _prepareDependencies() {
        this._injector.setOptions({enforceUniqueProviders:false});
        this._injector.provideValue(Dependencies.AD_CONTAINER, this._adContainers.adContainer);
        this._injector.provideClass(Dependencies.VPAID_RUNNER, vdb.html5.ads.modules.vast.view.inner.flash.VpaidRunner);
        this._injector.provideClass(Dependencies.FLV_RUNNER, vdb.html5.ads.modules.vast.view.inner.flash.FLVRunner);
        this._injector.provideClass(Dependencies.AD_TRACKER, vdb.html5.ads.tracking.AdTracker);
        this._injector.provideValue(Dependencies.PARAMETERS_COMBINE, new vdb.utils.ParametersCombine(this._injector));
        this._injector.provideValue(Dependencies.EVENT_BUS, this._eventBus);
    }
    function _resolveDependencies() {
        this._flashDetector = this._injector.resolveSync(Dependencies.FLASH_DETECTOR);
        this._config = this._injector.resolveSync(Dependencies.CONFIG);
        this._environment = this._injector.resolveSync(Dependencies.ENVIRONMENT);
    }
    function setup(adsConfig) {
        return this._injector.resolveAll([Dependencies.AD_TRACKER, Dependencies.ENVIRONMENT]).then(completeSetup.bind(this, vdb.html5.ads.AdsConfig.parse(adsConfig)));
    }
    function completeSetup(adsConfig, dependencies) {
        var adTracker = dependencies[0];
        _resolveDependencies.call(this);
        this.addEventListener(vdb.events.AdEvent.AD_LOADED, function() {
            this._adsLoaded += 1;
        }.bind(this));
        this.addEventListener(vdb.events.AdEvent.AD_STARTED, function() {
            clearTimeout(this._adLookUpTimer);
            this._adsPodPlayed += 1;
        }.bind(this));
        this.addEventListener(vdb.events.AdEvent.AD_SKIP_REQUESTED, this.skip.bind(this));
        this.addEventListener(vdb.events.AdEvent.AD_ENGINE_RUN, function(event) {
            this._adConfigEntry = event.getAdConfigEntry();
        }.bind(this));
        this.addEventListener(vdb.events.AdEvent.AD_VOLUME_CHANGED, function(event) {
            this._volume = event.data.volume;
        }.bind(this));
        this.addEventListener(vdb.html5.ads.events.AdSystemEvent.LINEAR_CHANGE, function(event) {
            if (!event.data.isLinear) {
                if (this.getLeftAdCount() <= 1) {
                    this.dispatchEvent(vdb.events.AdEvent.AD_LINEAR_CHANGE, event);
                } else {
                    this.nextAd();
                }
            }
        }.bind(this));
        LOGGER.debug("setup");
        this._adsConfig = adsConfig;
        adTracker.setAdsConfig(this._adsConfig);
        adTracker.attach();
        this._adPoolManager = new vdb.html5.ads.AdEntriesManager(this._adsConfig, this);
        this._slotOpportunityHandler = new vdb.html5.ads.SlotOpportunityHandler(this);
        this._videoAdsLimiter = new vdb.html5.ads.VideoAdsLimiter(this._adsConfig, this);
        this._adTimeLogger = new vdb.utils.AdTimeLogger(this);
        this._adsRunner = new vdb.html5.ads.AdsRunner(this._adsConfig, this, this._adPoolManager, this._adContainers);
        this._adsRunner.setVolume(this._volume);
        this._adsRunner.addEventListener(vdb.events.Event.COMPLETE, _runnerCompleteHandler.bind(this));
        _resetAdsLeft.call(this);
        var chromeMidrollsWorkaroundRequired = isChromeMidrollsWorkaroundRequired.call(this);
        this._config.useMidrollWorkaround(chromeMidrollsWorkaroundRequired);
        if (chromeMidrollsWorkaroundRequired) {
            this._injector.resolve(Dependencies.VPAID_RUNNER);
        }
        _registerProducers.call(this);
    }
    function isChromeMidrollsWorkaroundRequired() {
        var hasAdsetBasedAd = this._adsConfig.adStrategy === vdb.enums.AdStrategyType.ADSET_BASED && (this._adsConfig.asids.length > 0 || this._adsConfig.entryGroups.length > 0);
        return vdb.Utils.browser.name === "chrome" && hasAdsetBasedAd && !!this._adsConfig.midrollTiming && this._flashDetector.isFlashAvailable();
    }
    function canAutoplay(entry) {
        return this._config.playsNativeInline() || entry && useInlinePlayer.call(this, entry);
    }
    function loadAds(options, callback) {
        options = options || {};
        LOGGER.debug("Load ads", options);
        this._onLoaded = function(opts) {
            clearTimeout(this._loadingTimer);
            opts = opts || {};
            opts["canAutoplay"] = canAutoplay.call(this, this._loadedAdEntries[0]);
            this._canAutoplay = opts["canAutoplay"];
            this._onLoaded = null;
            if (callback) {
                setTimeout(function() {
                    callback(opts);
                }, options && options.error ? 500 : 0);
            }
        }.bind(this);
        if (!options.type) {
            options.type = vdb.enums.AdType.PREROLL;
        }
        if (options["currentVideo"]) {
            this._environment.setCurrentVideo(options["currentVideo"]);
        }
        this._type = options.type;
        this._loadedAdEntries = [];
        if (!this._videoAdsLimiter.isNextAllowed() || this._type === vdb.enums.AdType.PREROLL && this._prerollRequest++ % this._adsConfig.adsInterleave !== 0) {
            this._onLoaded();
            return;
        }
        var _this = this;
        var onAdsLoaded = function(adEntries) {
            LOGGER.debug("onAdsLoaded", adEntries);
            _this._adSequence = 0;
            _this._adsPodPlayed = 0;
            _this._loadedAdEntries = [];
            var filteredEntries = _prepareAdConfig.call(_this, adEntries || []);
            if (filteredEntries.length > 0) {
                _this._loadedAdEntries = filteredEntries;
                _this._adsRunner.load(filteredEntries, _this._onLoaded);
            } else {
                if (_this._onLoaded) {
                    _this._onLoaded();
                }
            }
            _this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.ADS_LOADED, _this._type, filteredEntries));
        };
        this._adPoolManager.receive(onAdsLoaded, this._type);
        clearTimeout(this._adLookUpTimer);
        clearTimeout(this._loadingTimer);
        var maxAdSearchTime = this._adsConfig.maxAdSearchTime;
        if (maxAdSearchTime > 0) {
            this._adLookUpTimer = setTimeout(stopByTimer.bind(this), maxAdSearchTime);
        }
        if (options["loadTimeLimit"] && this._type === vdb.enums.AdType.PREROLL) {
            this._loadingTimer = setTimeout(resumeByTimer.bind(this), options["loadTimeLimit"]);
        }
    }
    function resumeByTimer() {
        this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_BLOCKER_COMPLETE, this._type));
    }
    function stopByTimer() {
        this.stop();
        _resumePlayer.call(this);
    }
    function startAds() {
        LOGGER.info("Start ads", this._loadedAdEntries, "of type", this._type);
        this._blockerStarted = true;
        if (this._loadedAdEntries.length > 0) {
            _blockPlayer.call(this);
            this._adsRunner.run();
        } else {
            LOGGER.info("No ads to start - resume content");
            _resumePlayer.call(this, vdb.enums.AdReason.NO_ADS);
        }
    }
    function pauseAds() {
        LOGGER.debug("Pause Ads");
        this._adsRunner.pause();
    }
    function isPlaying() {
        return!this._adsRunner.isPaused();
    }
    function resumeAds() {
        LOGGER.debug("Resume Ads");
        this._adsRunner.resume();
    }
    function setVolume(volume) {
        LOGGER.debug("Set Volume", volume);
        this._volume = volume;
        this._adsRunner.setVolume(this._volume);
    }
    function mute(muted) {
        LOGGER.debug("Mute");
        if (muted) {
            this._oldVolume = this._volume;
            setVolume.call(this, 0);
        } else {
            if (this._oldVolume > 0) {
                setVolume.call(this, this._oldVolume);
            } else {
                if (this._volume === 0) {
                    setVolume.call(this, 1);
                }
            }
        }
    }
    function isMuted() {
        return!this._volume;
    }
    function getDuration() {
        return this._adsRunner.getDuration();
    }
    function getAdSkippableState() {
        return this._adsRunner.getAdSkippableState();
    }
    function getVolume() {
        return this._volume;
    }
    function getClickThroughUrl() {
        return this.getAdsConfig().clickThroughUrl;
    }
    function getVastAdNumber() {
        return this._adsRunner.getVastAdNumber();
    }
    function getMediaContent() {
        return this._adsRunner.getMediaContent();
    }
    function stop() {
        LOGGER.debug("stop");
        this._onLoaded = null;
        this._adsRunner.stop();
    }
    function skip() {
        LOGGER.debug("skip");
        this.dispatchEvent(vdb.events.AdEvent.AD_SKIPPED);
        this.dispatchEvent(new vdb.events.TrackEvent(vdb.events.TrackEvent.CLICK, {clickType:"skipAhead"}));
        this._adsRunner.skip();
    }
    function isPrerollOrMidroll() {
        return this._type === vdb.enums.AdType.PREROLL || this._type === vdb.enums.AdType.MIDROLL;
    }
    function _resumePlayer(reason) {
        LOGGER.debug("resumePlayer");
        clearTimeout(this._adLookUpTimer);
        this._adsLoaded = 0;
        this._adsRunner.reset();
        this._eventGroup.unbind();
        _resetAdsLeft.call(this);
        if (this._adsPodPlayed === 0) {
            this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_NONE, this._type));
        }
        if (isPrerollOrMidroll.call(this) && this._blockerStarted) {
            this._blockerStarted = false;
            this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_BLOCKER_COMPLETE, this._type, {reason:reason}));
        }
    }
    function _blockPlayer() {
        LOGGER.debug("blockPlayer");
        if (isPrerollOrMidroll.call(this)) {
            this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_BLOCKER_REQUEST, this._type));
            this._eventGroup.addContext(vdb.events.EventContext.bindOnce(this, vdb.events.AdEvent.AD_STARTED, this.dispatchEvent.bind(this, new vdb.events.AdEvent(vdb.events.AdEvent.AD_BLOCKER_STARTED, this._type))));
        }
    }
    function _prepareAdConfig(entries) {
        LOGGER.debug("prepareAdConfig", entries);
        var result = [];
        for (var i = 0;i < entries.length;i++) {
            if (entries[i].conformsType(this._type)) {
                result.push(entries[i].prepare(this.getResolver(), this._type));
            }
        }
        return result;
    }
    function _getResolver() {
        if (!this._macrosResolver) {
            this._macrosResolver = new vdb.utils.AdMacrosResolver(this, this._adsConfig);
        }
        return this._macrosResolver;
    }
    function _runWaterfall() {
        var entries = this._adPoolManager.getAdEntries(this._type);
        LOGGER.debug("runWaterfall", entries);
        if (entries.length) {
            _onAdEntriesReceived.call(this, entries);
        } else {
            this._hasSucessfulAdGroup = false;
            this._adPoolManager.receive(_onAdEntriesReceived.bind(this), this._type);
        }
    }
    function _onAdEntriesReceived(adEntries) {
        var filteredEntries = _prepareAdConfig.call(this, adEntries);
        this._loadedAdEntries = filteredEntries;
        LOGGER.debug("onAdEntriesReceived", filteredEntries);
        if (filteredEntries.length > 0 && this._videoAdsLimiter.isNextAllowed()) {
            if (!this._adsRunner.isLoaded()) {
                this._adsRunner.reset();
                this._adsRunner.load(filteredEntries, this.startAds.bind(this));
            } else {
                this.startAds();
            }
        } else {
            _resumePlayer.call(this);
        }
    }
    function _runNextOrResume(error) {
        LOGGER.debug("runNextOrResume");
        if (this._type !== vdb.enums.AdType.OVERLAY && this._adsLeft > 0 && this.isNextAdPodAllowed() && this._hasSucessfulAdGroup) {
            _runWaterfall.call(this);
        } else {
            if (this._onLoaded) {
                this._onLoaded(error ? {error:error} : null);
            }
            _resumePlayer.call(this, error);
        }
    }
    function _runnerCompleteHandler(event) {
        LOGGER.debug("runnerCompleteHandler", event);
        if (event && event.data && event.data.error) {
            _onAdGroupFailed.call(this, event.data.error);
            return;
        }
        this._hasSucessfulAdGroup = true;
        this._adsLeft -= 1;
        _runNextOrResume.call(this);
    }
    function _onAdGroupFailed(error) {
        var adEntries = this._adPoolManager.getAdEntries(this._type);
        this._loadedAdEntries = _prepareAdConfig.call(this, adEntries);
        this._adsRunner.reset();
        LOGGER.warn("on ad group failed:", error, this._loadedAdEntries);
        if (this._loadedAdEntries.length && this.isNextAdPodAllowed() && this._config.getPlayerType() !== vdb.enums.PlayerType.O2UNIT) {
            var cb = this._onLoaded || this._adsRunner.run.bind(this._adsRunner);
            this._adsRunner.load(this._loadedAdEntries, cb);
        } else {
            _runNextOrResume.call(this, vdb.enums.AdReason.AD_GROUP_FAILED);
        }
    }
    function nextAd() {
        this._adsRunner.stop();
        _runnerCompleteHandler.call(this);
    }
    function getLeftAdCount() {
        return this._adsLeft;
    }
    function getAdsLoaded() {
        return this._adsLoaded;
    }
    function getAdsConfig() {
        return this._adsConfig;
    }
    function registerAdEngineProducer(producer) {
        this._adEngineProducers[producer.getType()] = producer;
    }
    function getAdEngineProducer(type) {
        for (var producerType in this._adEngineProducers) {
            if (producerType === type) {
                return this._adEngineProducers[type];
            }
        }
        return null;
    }
    function useInlinePlayer(adEntry) {
        if (this._config.playsNativeInline()) {
            return false;
        }
        var inview = this.getAdsConfig().autoplayInView;
        var autoplay = this._adsConfig.autoplay || inview > 0;
        var mobile = vdb.Utils.mobileOs();
        var preroll = adEntry.getType() === vdb.enums.AdType.PREROLL;
        var adEngineType = adEntry.getAdEngineType();
        LOGGER.debug("autoplay = " + autoplay + ", inview = " + inview + ", mobile = " + mobile + ", preroll = " + preroll + ", adEngineType = " + adEngineType);
        if (autoplay && mobile && preroll) {
            switch(adEngineType) {
                case vdb.enums.AdEngineType.VAST:
                    ;
                case vdb.enums.AdEngineType.EMBED_VAST:
                    return adEntry.useInlinePlayer() || this._config.getMacro(vdb.constants.PlayerMacros.O2INLINE);
                default:
                    break;
            }
        }
        return false;
    }
    function isNextAdPodAllowed() {
        return this._adsPodPlayed < this._adsConfig.adsPodSize;
    }
    function _resetAdsLeft() {
        this._adsLeft = this._adsConfig.adsPodSize;
    }
    function getAdContainers() {
        return this._adContainers;
    }
    function resize() {
        this.dispatchEvent(vdb.html5.ads.events.AdSystemEvent.RESIZE);
    }
    function getInjector() {
        return this._injector;
    }
    function getAdConfigEntry() {
        return this._adConfigEntry;
    }
    function addEventListener(event, handler) {
        this._eventBus.addEventListener(event, handler);
    }
    function removeEventListener(event, handler) {
        this._eventBus.removeEventListener(event, handler);
    }
    function dispatchEvent() {
        this._eventBus.dispatchEvent.apply(this._eventBus, arguments);
    }
    function getCanAutoplay() {
        return this._canAutoplay;
    }
    function getTimeLog() {
        return this._adTimeLogger.getLog();
    }
    var LOGGER = vdb.log.getLogger("AdSystem");
    var Dependencies = vdb.enums.Dependencies;
    return{init:init, setup:setup, getResolver:_getResolver, loadAds:loadAds, startAds:startAds, pauseAds:pauseAds, resumeAds:resumeAds, setVolume:setVolume, mute:mute, isMuted:isMuted, getDuration:getDuration, getVolume:getVolume, getLeftAdCount:getLeftAdCount, getAdsLoaded:getAdsLoaded, getClickThroughUrl:getClickThroughUrl, stop:stop, skip:skip, getAdSkippableState:getAdSkippableState, nextAd:nextAd, getAdsConfig:getAdsConfig, isPlaying:isPlaying, registerAdEngineProducer:registerAdEngineProducer,
        getAdEngineProducer:getAdEngineProducer, useInlinePlayer:useInlinePlayer, isNextAdPodAllowed:isNextAdPodAllowed, getAdContainers:getAdContainers, resize:resize, getInjector:getInjector, getVastAdNumber:getVastAdNumber, getAdConfigEntry:getAdConfigEntry, addEventListener:addEventListener, removeEventListener:removeEventListener, dispatchEvent:dispatchEvent, getMediaContent:getMediaContent, getCanAutoplay:getCanAutoplay, getTimeLog:getTimeLog};
}());
vdb.html5.enums = {};
vdb.html5.enums.AnimatedPosterType = {VIDEO:"video", GIF:"gif"};
vdb.html5.enums.Control360Type = {VIDEO:"video", COMPASS:"compass"};
vdb.html5.enums.MouseButton = {LEFT:0, MIDDLE:1, RIGHT:2};
vdb.html5.enums.PreviewPosterType = {ANIMATED:"animated", STATIC:"image"};
vdb.html5.enums.TimeUnit = {SECOND:"SECOND", PERCENT:"PERCENT"};
vdb.html5.enums.VideoPlayType = {AUTOPLAY:"auto", CLICK:"click", AUTO_PLAY_IN_VIEW:"auto_play_in_view"};
vdb.html5.player = {};
vdb.html5.player.AdConfig = vdb.core.Class.extend(function() {
    return{init:function(adConfig) {
        this._adConfig = adConfig || {};
        this._adConfig["skipSettings"] = {};
    }, isSsai:function() {
        return false;
    }, getAdStrategy:function() {
        return this._adConfig["adStrategy"];
    }, getMaxLinearShowTime:function() {
        return this._adConfig["maxLinearShowTime"];
    }, getMidrollTiming:function() {
        return this._adConfig["midrollTiming"];
    }, getOverlayTiming:function() {
        return this._adConfig["overlayTiming"];
    }, update:function(key, value) {
        if (typeof key === "string") {
            this._adConfig[key] = value;
        } else {
            for (var k in key) {
                if (Object.prototype.hasOwnProperty.call(key, k)) {
                    this._adConfig[k] = key[k];
                }
            }
        }
    }, updateMidrollTiming:function(timing) {
        this._adConfig["midrollTiming"] = timing;
    }, isAutoplay:function() {
        return this._adConfig["autoplay"];
    }, getRawConfig:function() {
        return this._adConfig;
    }, setBrandedContent:function(isBranded) {
        this._adConfig["isBrandedContent"] = isBranded;
    }, updateSkipSettings:function(settings) {
        this._adConfig["skipSettings"] = settings;
    }, setClickThroughUrl:function(url) {
        this._adConfig["clickThroughUrl"] = url;
    }};
}());
vdb.html5.player.AdInfoBar = vdb.EventBus.extend(function() {
    var $ = vdb.utils.Common;
    var utl = vdb.Utils;
    var ec = vdb.events.EventContext;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var isMobile = !!utl.mobileOs();
    var buildControls = function() {
        this.adInfoBar = utl.createElement("div", {"class":"ad-info-bar"});
        this.adProgressbar = utl.createElement("div", {"class":"ad-progress-bar"}, this.adInfoBar);
        this.adProgress = utl.createElement("div", {"class":"ad-progress"}, this.adProgressbar);
        this.topAdContainer = utl.createElement("div", {"class":"top-ad-container"});
        this.adInfoContainer = utl.createElement("div", {"class":"ad-info-container"}, this.topAdContainer);
        this.adInfoCaption = utl.createElement("div", {"class":"ad-info-caption"}, this.adInfoContainer);
        this.adTimeRemaining = utl.createElement("div", {"class":"ad-time-remaining"}, this.adInfoContainer);
        this.tinyAdInfoContainer = utl.createElement("div", {"class":"tiny-ad-info-container"}, this.topAdContainer);
        this.player.container.appendChild(this.adInfoBar);
        this.player.container.appendChild(this.topAdContainer);
        vdb.dom.embedCssToHead(".ad-info-bar{position:absolute;bottom:100%;width:100%;-moz-transform:translateY(-37px);-webkit-transform:translateY(-37px);transform:translateY(-37px);-moz-transition:-moz-transform .5s;-webkit-transition:-webkit-transform .5s;transition:transform .5s;z-index:4}.top-ad-container{position:absolute;top:4px;width:100%;z-index:1}.ad-progress-bar{bottom:-4px;height:4px;background-color:rgba(34,34,34,0.15);position:relative;opacity:0}.expand-ad-info-bar .ad-progress-bar,.small-ad-info-bar .ad-progress-bar{opacity:1}.expand-ad-info-bar .ad-info-bar,.small-ad-info-bar .ad-info-bar,.tiny-ad-info-bar .ad-info-bar{-moz-transform:translateY(0);-webkit-transform:translateY(0);transform:translateY(0);-moz-transition:-moz-transform .5s;-webkit-transition:-webkit-transform .5s;transition:transform .5s;display:block}.ad-progress{position:absolute;top:0;left:0;height:100%;width:0;background-color:#fff}.in-progress{-webkit-transition:width .3s linear;-moz-transition:width .3s linear;transition:width .3s linear}.ad-info-container{color:#d0d0d0;font:12px/13px Arial;background-color:rgba(34,34,34,0.85);padding:10px 15px;display:none;table-layout:fixed;width:100%;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}.expand-ad-info-bar .ad-info-container{display:table}.tiny-ad-info-container{color:#d0d0d0;padding:2px 6px 3px;font:11px Arial;background-color:rgba(34,34,34,0.6);width:auto;border-color:rgba(153,153,153,0.6);border-width:1px;border-style:solid;display:inline-block;position:absolute;right:0;opacity:0;pointer-events:none;-webkit-transition:opacity .5s;-moz-transition:opacity .5s;transition:opacity .5s}.tiny-ad-info-bar .tiny-ad-info-container{opacity:1;display:inline-block;pointer-events:auto}.ad-info-caption{display:table-cell;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ad-time-remaining{display:table-cell;text-align:right;width:40px}");
        if (isMobile) {
            utl.addClass(this.adInfoBar, "mobile");
        }
    };
    var bindEvents = function() {
        this.eventGroup = this.eventGroup || new vdb.events.EventContextBindGroup(ec.bind(this.player, PlayerEvent.AD_START, onAdStart.bind(this)), ec.bind(this.player, PlayerEvent.AD_TIMEUPDATE, onAdTimeUpdate.bind(this)), ec.bind(this.player, PlayerEvent.AD_END, onAdEnd.bind(this)), ec.bind(this.player, vdb.html5.player.AD_SLOT_END, onAdSlotEnd.bind(this)));
    };
    var unbindEvents = function() {
        if (this.eventGroup) {
            this.eventGroup.unbind();
            this.eventGroup = null;
        }
    };
    var onAdStart = function(e) {
        if (e.data.type === vdb.enums.AdType.OVERLAY) {
            return;
        }
        this.adDataMinibar = e.data["parameters"] && e.data["parameters"]["minibar"];
        var topOffsetFuture = vdb.ctx.getAdParams().topOffsetFuture;
        if (topOffsetFuture) {
            topOffsetFuture.resolve(this.adInfoBar.offsetHeight);
        }
        var currentVideo = this.controller.getCurrentVideo();
        this.isAdPlaying = true;
        this.isInline = e.data["isInline"];
        this.eventContext = ec.bind(window, "resize", setAdInfoBarVisibility.bind(this));
        this.adInfoCaption.innerHTML = this.adInfoText.replace(this.VIDEO_TITLE_MACRO, currentVideo && currentVideo.title || "Your video");
        this.adTimeRemaining.innerHTML = "";
        utl.setStyle(this.adProgress, {width:"0"});
        utl.addClass(this.adProgress, "in-progress");
        this.tinyAdInfoContainer.innerHTML = "";
        if (this.controller.isBrandedWithControls()) {
            utl.addClass(this.container, "branded-player");
        }
        if (e.data["adIconsContainer"]) {
            this.adInfoBar.appendChild(e.data["adIconsContainer"]);
        }
        setAdInfoBarVisibility.call(this);
    };
    var onAdTimeUpdate = function(e) {
        if (this.controller.isBrandedWithControls()) {
            return;
        }
        var progressPercent = e.data["progressPercent"];
        var timeRemaining = e.data["timeRemaining"];
        utl.setStyle(this.adProgress, {width:progressPercent + "%"});
        if (timeRemaining > 0) {
            this.adTimeRemaining.innerHTML = $.formatTime(timeRemaining);
            var seconds = parseInt(timeRemaining);
            var secondsStr = seconds < 10 ? "0" + seconds : seconds;
            this.tinyAdInfoContainer.innerHTML = "Video will play in " + secondsStr;
        }
    };
    var onAdEnd = function() {
        utl.removeClass(this.adProgress, "in-progress");
    };
    var onAdSlotEnd = function() {
        if (this.eventContext) {
            this.eventContext.unbind();
        }
        this.isAdPlaying = false;
        removeAdInfoBar.call(this);
    };
    var removeAdInfoBar = function() {
        utl.removeClass(this.player.container, ["small-ad-info-bar", "expand-ad-info-bar", "tiny-ad-info-bar"]);
    };
    var setAdInfoBarVisibility = function() {
        if (this.isAdPlaying) {
            removeAdInfoBar.call(this);
            var hideInfoOnMinibar = this.toggleContainerOnMinibar && !this.progressBarOnly && this.adDataMinibar;
            if (this.progressBarOnly || this.player.isAdOnly() || hideInfoOnMinibar) {
                utl.addClass(this.player.container, "small-ad-info-bar");
            } else {
                if (this.isInline || this.container.clientWidth >= this.AD_RIBBON_MIN_WIDTH) {
                    utl.addClass(this.player.container, "expand-ad-info-bar");
                } else {
                    utl.addClass(this.player.container, "tiny-ad-info-bar");
                }
            }
        }
    };
    return{init:function(controller) {
        this.controller = controller;
        this.player = controller.getPlayer();
        this.container = controller.getContainer();
        this.progressBarOnly = !controller.isAol || vdb.ctx.getMacro(vdb.constants.PlayerMacros.ADMINIBAR);
        this.toggleContainerOnMinibar = true;
        this.adInfoText = '"' + this.VIDEO_TITLE_MACRO + '" will play after the ad';
        buildControls.call(this);
        bindEvents.call(this);
        this.adTimeRemaining.innerHTML = "&nbsp;";
    }, dispose:function() {
        unbindEvents.call(this);
        vdb.Utils.removeFromParent(this.adInfoBar);
    }, AD_RIBBON_MIN_WIDTH:400, VIDEO_TITLE_MACRO:"{videotitle}"};
}());
vdb.html5.player.AdSystemController = vdb.core.Class.extend(function() {
    function initAdSystem() {
        this._isSsai = false;
        this.adSystem = new vdb.html5.ads.AdSystem(this.injector, this.adContainers);
        return this.adSystem.setup(this.adConfig.getRawConfig()).then(function() {
            return this;
        }.bind(this));
    }
    function initSsai() {
        this._isSsai = true;
        this.adSystem = new vdb.ssai.SsaiAdManager(this.injector, this.adConfig);
        return vdb.Promise.resolve(this);
    }
    function playOnPause(type, time) {
        this.adSystem.startAds(type, time);
        this.display.removeContentListener(vdb.html5.player.VIDEO_RESUME, this.playOnPauseListener);
    }
    var Dependencies = vdb.enums.Dependencies;
    var LOGGER = vdb.log.getLogger("AdSystemController");
    return{init:function(injector, adContainers, adConfig, hasAdBlocker) {
        this.injector = injector;
        this.adContainers = adContainers;
        this.adConfig = adConfig;
        this.environment = injector.resolveSync(Dependencies.ENVIRONMENT);
        this.config = injector.resolveSync(Dependencies.CONFIG);
        this.aggressiveMode = this.config.isAggressiveMode() && !hasAdBlocker;
        this.display = vdb.html5.player.Display.getInstance();
        if (this.aggressiveMode) {
            this.eventGroup = new vdb.events.EventContextBindGroup;
            this.adConfig.update({"midrollTiming":null, "podSize":1, "prerollInterleave":0});
        }
    }, addEventListener:function(event, callback) {
        this.adSystem.addEventListener(event, callback);
    }, dispatchEvent:function(event, data) {
        this.adSystem.dispatchEvent(event, data);
    }, getAdsPassedTime:function(time) {
        return this._isSsai ? this.adSystem.getAdsPassedTime(time) : 0;
    }, getLoadTime:function() {
        return this.adSystem.getTimeLog();
    }, getDuration:function() {
        return this.adSystem.getDuration();
    }, getLeftAdCount:function() {
        return this.adSystem.getLeftAdCount();
    }, getVolume:function() {
        return this.adSystem.getVolume();
    }, isMuted:function() {
        return this.adSystem.isMuted();
    }, isPlaying:function() {
        return this.adSystem.isPlaying();
    }, isSsai:function() {
        return this._isSsai;
    }, loadAds:function(event, callback) {
        event = event || {};
        event["currentVideo"] = this.environment.getCurrentVideo() || {};
        event["currentVideo"]["time"] = this.environment.getVideoTime();
        event["loadTimeLimit"] = this.config.getLoadTimeLimit();
        if (this.config.isAdsDisabled()) {
            LOGGER.debug("Ads disabled - abort loading ads");
            callback();
        } else {
            if (this.aggressiveMode) {
                this.eventGroup.addContext(vdb.events.EventContext.bindOnce(this.adSystem, vdb.events.AdEvent.AD_BLOCKER_COMPLETE, this.loadAds.bind(this, {type:vdb.enums.AdType.MIDROLL}, this.startAds.bind(this, vdb.enums.AdType.MIDROLL))));
                this.adSystem.loadAds(event, callback);
            } else {
                this.adSystem.loadAds(event, callback);
            }
        }
    }, mute:function(muted) {
        this.adSystem.mute(muted);
    }, nextAd:function() {
        this.adSystem.nextAd();
    }, pauseAds:function() {
        this.adSystem.pauseAds();
    }, removeEventListener:function(event, handler) {
        this.adSystem.removeEventListener(event, handler);
    }, resize:function() {
        this.adSystem.resize();
    }, resumeAds:function() {
        this.adSystem.resumeAds();
    }, setVolume:function(volume) {
        this.adSystem.setVolume(volume);
    }, setup:function() {
        if ((this.adConfig.isSsai() || vdb.utils.UrlUtils.getParameterByName("ssai")) && !this.environment.getAdOnly()) {
            if (this.adConfig.getAdStrategy() === vdb.enums.AdStrategyType.ADSET_BASED) {
                return initSsai.call(this);
            }
            return this.environment.getAdBlockerPromise().then(function(hasAdBlocker) {
                return hasAdBlocker ? initSsai.call(this) : initAdSystem.call(this);
            }.bind(this));
        }
        return initAdSystem.call(this);
    }, skip:function() {
        this.adSystem.skip();
    }, startAds:function(type, time) {
        if (this.config.isAdsDisabled()) {
            type = type || vdb.enums.AdType.PREROLL;
            this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_NONE, type));
            this.dispatchEvent(new vdb.events.AdEvent(vdb.events.AdEvent.AD_BLOCKER_COMPLETE, type, {}));
        } else {
            if (this.display.isPaused()) {
                this.playOnPauseListener = playOnPause.bind(this, type, time);
                this.display.addContentListener(vdb.html5.player.VIDEO_RESUME, this.playOnPauseListener);
                return;
            }
            this.adSystem.startAds(type, time);
        }
    }, stop:function() {
        if (this.aggressiveMode) {
            this.eventGroup.unbind();
        }
        this.adSystem.stop();
    }};
}());
vdb.html5.player.AdControllerProducer = function() {
    return{produce:function(injector, adContainers, config, hasAdBlocker) {
        this.adController = new vdb.html5.player.AdSystemController(injector, adContainers, config, hasAdBlocker);
        return this.adController.setup();
    }};
}();
vdb.html5.player.AgeGate = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("Age Gate");
    var COOKIE_GATE = "gate";
    var GATE_EXPIRATION = 60 * 60 * 24 * 7;
    var GATE_PREFIX = "vdb_aol_gate_prefix-";
    var $ = vdb.Utils;
    var ageStages = [0, 7, 10, 14, 17, 21];
    var _checkAge = function() {
        var currentVideo = this._controller.getCurrentVideo();
        if (!currentVideo) {
            return;
        }
        this._videoRate = _getMinAge.call(this, currentVideo);
        if (this._videoRate > 0) {
            this._parent = this._controller.getPlayer().getElement();
            this._gate = this._cookies.get(COOKIE_GATE);
            if (!this._gate) {
                setTimeout(function() {
                    vdb.html5.player.Display.getInstance().stop();
                    _showBirthdayWidget.call(this);
                }.bind(this), 100);
            } else {
                _validateCurrentVideo.call(this);
            }
        } else {
            _startVideo.call(this);
        }
    };
    var _getMinAge = function(currentVideo) {
        if (currentVideo.metadata && currentVideo.metadata["commonRating"] && currentVideo.metadata["commonRating"]["minAge"]) {
            return currentVideo.metadata["commonRating"]["minAge"];
        }
        return-1;
    };
    var _startVideo = function() {
        this._controller.continueStart();
    };
    var _showBirthdayWidget = function() {
        LOGGER.debug("show Birthday widget");
        this._widgetContainer = vdb.dom.createElement("div");
        var content = vdb.dom.createElement("div");
        var bdLabel = vdb.dom.createElement("span");
        var dateBlock = vdb.dom.createElement("p");
        var monthSelectList = vdb.dom.createElement("select");
        var dateSelectList = vdb.dom.createElement("select");
        var yearSelectList = vdb.dom.createElement("select");
        var underline = vdb.dom.createElement("span");
        var buttonBlock = vdb.dom.createElement("p");
        var button = vdb.dom.createElement("span");
        var monthList = {1:"Jan", 2:"Feb", 3:"Mar", 4:"Apr", 5:"May", 6:"Jun", 7:"Jul", 8:"Aug", 9:"Sep", 10:"Oct", 11:"Nov", 12:"Dec"};
        var dateList = {};
        for (var i = 1;i <= 31;i++) {
            dateList[i] = i;
        }
        var yearList = {};
        var currYear = (new Date).getFullYear();
        for (i = 0;i < 80;i++) {
            var year = currYear - i;
            yearList[year] = year;
        }
        _containerView(this._widgetContainer);
        _contentView(content);
        _labelView(bdLabel);
        _underlineView(underline);
        _button_blockView(buttonBlock);
        _buttonView.call(this, button);
        _dateBlockView(dateBlock);
        _selectView(monthSelectList, monthList, "bd-month");
        _selectView(dateSelectList, dateList, "bd-date");
        _selectView(yearSelectList, yearList, "bd-year");
        content.appendChild(bdLabel);
        dateBlock.appendChild(monthSelectList);
        dateBlock.appendChild(dateSelectList);
        dateBlock.appendChild(yearSelectList);
        content.appendChild(dateBlock);
        content.appendChild(underline);
        buttonBlock.appendChild(button);
        content.appendChild(buttonBlock);
        this._widgetContainer.appendChild(content);
        this._parent.appendChild(this._widgetContainer);
        this._player.dispatchEvent(vdb.constants.PlayerEvent.AGE_GATE_DISPLAYED);
    };
    var _showBlockWindow = function() {
        LOGGER.debug("block video");
        vdb.html5.player.Display.getInstance().stop();
        var content = vdb.dom.createElement("div");
        var blockTitle = vdb.dom.createElement("div");
        var blockDescription = vdb.dom.createElement("div");
        this._widgetContainer = vdb.dom.createElement("div");
        _containerView(this._widgetContainer);
        _blockView(content);
        _blockTitleView(blockTitle);
        _blockDescriptionView.call(this, blockDescription);
        content.appendChild(blockTitle);
        content.appendChild(blockDescription);
        this._widgetContainer.appendChild(content);
        this._parent.appendChild(this._widgetContainer);
    };
    var _containerView = function(container) {
        $.setStyle(container, {width:"100%", height:"100%", top:"0", display:"table", position:"absolute", zIndex:"100", background:"rgb(26, 26, 26)", color:"white"});
    };
    var _contentView = function(content) {
        $.setStyle(content, {position:"relative", display:"block", margin:"20% auto", width:"285px"});
    };
    var _labelView = function(label) {
        _setElementText(label, "Please enter your date of birth");
        $.setStyle(label, {color:"rgb(208, 208, 208)", display:"block", fontFamily:"Arial, sans-serif", fontSize:"16px", lineHeight:"20px", marginBottom:"20px"});
    };
    var _underlineView = function(underline) {
        $.setStyle(underline, {display:"block", height:"1px", borderBottomWidth:"1px", borderBottomStyle:"solid", borderBottomColor:"rgb(85, 85, 85)"});
    };
    var _button_blockView = function(buttonBlock) {
        $.setStyle(buttonBlock, {marginTop:"10px"});
    };
    var _buttonView = function(button) {
        $.setStyle(button, {cursor:"pointer", display:"inline-block", borderRadius:"12px", color:"rgb(0, 0, 0)", fontSize:"12px", textTransform:"uppercase", padding:"5px 8px", fontWeight:"bold", styleFloat:"right", cssFloat:"right", backgroundColor:"rgb(255, 255, 255)", fontFamily:"Arial, sans-serif"});
        button.innerHTML = "Submit";
        button.addEventListener("click", _birthdayEntered.bind(this));
    };
    var _blockView = function(block) {
        $.setStyle(block, {color:"rgb(208, 208, 208)", marginTop:"20%", textAlign:"center", fontFamily:"Arial, sans-serif"});
    };
    var _blockTitleView = function(title) {
        _setElementText(title, "Video is blocked");
        $.setStyle(title, {fontSize:"2rem"});
    };
    var _blockDescriptionView = function(title) {
        _setElementText(title, "To view this video\nyou must be over " + this._videoRate + " years old");
        $.setStyle(title, {fontSize:"1.4rem"});
    };
    var _dateBlockView = function(dateBlock) {
        $.setStyle(dateBlock, {display:"block", marginBottom:"20px", fontWeight:"bold"});
    };
    var _selectView = function(select, list, id) {
        var isYearList = id === "bd-year";
        select.id = id;
        var style = {color:"rgb(17, 17, 17)", display:"inline-block", fontFamily:"Arial, sans-serif", fontSize:"15px", lineHeight:"15px", height:"26px", borderRadius:"2px", width:"84px", backgroundColor:"rgb(255, 255, 255)"};
        if (id === "bd-month") {
            style.marginLeft = "0px";
        } else {
            style.marginLeft = "15px";
        }
        $.setStyle(select, style);
        for (var i in list) {
            if (list.hasOwnProperty(i)) {
                var option = vdb.dom.createElement("option");
                option.value = i > 9 ? i : "0" + i;
                option.text = list[i];
                if (isYearList) {
                    select.insertBefore(option, select.firstChild);
                } else {
                    select.appendChild(option);
                }
            }
        }
    };
    var _setElementText = function(el, text) {
        el.innerText = text;
        el.textContent = text;
    };
    var _birthdayEntered = function(event) {
        LOGGER.debug("close Birthday widget");
        if (event.type == vdb.constants.PlayerEvent.BIRTH_DATE_ENTERED) {
            this._birthDate = event.data;
        } else {
            var bd = [];
            bd.push(_getInputValue("bd-year"));
            bd.push(_getInputValue("bd-month"));
            bd.push(_getInputValue("bd-date"));
            this._birthDate = bd.length && bd.join("-");
        }
        if (!this._birthDate || this._birthDate.length == 0 || isNaN(Date.parse(this._birthDate))) {
            return;
        }
        this._userAge = vdb.Utils.getAge(this._birthDate);
        this._gate = _encodeGate.call(this);
        this._cookies.set(COOKIE_GATE, this._gate, {expires:GATE_EXPIRATION});
        this._widgetContainer.parentNode.removeChild(this._widgetContainer);
        _validateCurrentVideo.call(this);
    };
    var _getLastStage = function() {
        for (var i = 1;i < ageStages.length;i++) {
            if (this._userAge < ageStages[i]) {
                return ageStages[i - 1];
            }
        }
        return ageStages[ageStages.length - 1];
    };
    var _encodeGate = function() {
        return vdb.Utils.md5(GATE_PREFIX + _getLastStage.call(this));
    };
    var _decodeGate = function() {
        for (var i = 0;i < ageStages.length;i++) {
            if (this._gate == vdb.Utils.md5(GATE_PREFIX + ageStages[i])) {
                return ageStages[i];
            }
        }
        return 0;
    };
    var _getInputValue = function(elId) {
        var elem = document.getElementById(elId);
        if (elem) {
            return elem.value;
        }
        return null;
    };
    var _validateCurrentVideo = function() {
        this._userAge = vdb.Utils.getAge(this._birthDate);
        if (this._videoRate > _decodeGate.call(this)) {
            _showBlockWindow.call(this);
        } else {
            _startVideo.call(this);
        }
    };
    return{init:function(_controller) {
        if (this._instance) {
            throw "Only one Age Gate object may be created.";
        }
        LOGGER.debug("init");
        this._instance = this;
        this._controller = _controller;
        this._player = vdb.ctx.api;
        this._cookies = new vdb.utils.Cookies;
        this._player.addEventListener(vdb.constants.PlayerEvent.BIRTH_DATE_ENTERED, _birthdayEntered.bind(this));
    }, checkAge:_checkAge};
}());
vdb.coverings = {};
vdb.coverings.covering = {};
vdb.html5.player.CoveringsManager = vdb.core.Class.extend(function() {
    var DEFAULT_COVERING_TYPE = "skin5";
    var onComplete = function() {
        this.coveringFuture.resolve();
    };
    return{init:function(coveringType) {
        this.coveringFuture = new vdb.Future;
        if (coveringType === DEFAULT_COVERING_TYPE) {
            onComplete.call(this);
        } else {
            var coveringUrl = vdb.ctx.getCdnUrl("js/coverings/%s.js".replace("%s", coveringType)) + "?cb=" + vdb.ver();
            vdb.Utils.injectScript(document, coveringUrl, onComplete.bind(this));
        }
    }, getCovering:function() {
        return this.coveringFuture.getPromise();
    }};
}());
vdb.html5.player.DisplayMode = {NONE:"none", CONTENT:"content", PREROLL:"preroll", MIDROLL:"midroll"};
vdb.html5.player.FullscreenController = vdb.core.Class.extend(function() {
    var fs = vdb.utils.Fullscreen;
    var $ = vdb.utils.Common;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var LOGGER = vdb.log.getLogger("FullscreenController");
    var attachEvents = function() {
        this.player.addEventListener(PlayerEvent.PLAYER_SKIN_READY, onPlayerSkinReady.bind(this));
        if (fs.enabled()) {
            fs.addFullscreenChangeListener(function() {
                if (fs.isFullscreen() && (fs.element() === this.player.container || fs.element() === this.frameElement)) {
                    this.player.dispatchEvent(PlayerEvent.ENTER_FULLSCREEN);
                    LOGGER.debug("Enter fullscreen");
                } else {
                    this.player.dispatchEvent(PlayerEvent.EXIT_FULLSCREEN, {"userInitiated":!this.forcedExitFullscreen});
                    this.forcedExitFullscreen = false;
                    onExitFullscreen.call(this);
                    LOGGER.debug("Exit fullscreen");
                }
            }.bind(this));
        } else {
            if ($.isWebkitFullscreenVideoSupported) {
                this.display.addEventListener(vdb.html5.player.VIDEO_WEBKIT_BEGIN_FULLSCREEN, function() {
                    this.player.dispatchEvent(PlayerEvent.ENTER_FULLSCREEN);
                    LOGGER.debug("Enter fullscreen");
                }.bind(this));
                this.display.addEventListener(vdb.html5.player.VIDEO_WEBKIT_END_FULLSCREEN, function() {
                    this.player.dispatchEvent(PlayerEvent.EXIT_FULLSCREEN, {"userInitiated":!this.forcedExitFullscreen});
                    this.forcedExitFullscreen = false;
                    LOGGER.debug("Exit fullscreen");
                }.bind(this));
            }
        }
    };
    var enterFullscreen = function() {
        var elements = [];
        this.savedContainerStyle = this.container.getAttribute("style");
        this.savedVideosContainerStyle = this.videosContainer.getAttribute("style");
        this.savedControlsBarContainerStyle = this.controlsBarContainer && this.controlsBarContainer.getAttribute("style");
        if (this.container) {
            elements.push(this.container);
        }
        if (this.videosContainer) {
            elements.push(this.videosContainer);
        }
        if (this.controlsBarContainer) {
            elements.push(this.controlsBarContainer);
        }
        vdb.Utils.setStyle(elements, {"padding":"0", "margin":"0", "width":"100%", "height":"100%", "left":"0", "top":"0"});
        fs.enter(this.container);
    };
    var exitFullscreen = function() {
        fs.exit();
    };
    var onPlayerSkinReady = function(e) {
        var skin = e.data;
        this.controlsBarContainer = skin.controlsBarContainer;
    };
    var onExitFullscreen = function() {
        if (this.savedContainerStyle) {
            this.container.setAttribute("style", this.savedContainerStyle);
        }
        if (this.savedVideosContainerStyle) {
            this.videosContainer.setAttribute("style", this.savedVideosContainerStyle);
        }
        if (this.savedControlsBarContainerStyle) {
            this.controlsBarContainer.setAttribute("style", this.savedControlsBarContainerStyle);
        }
    };
    var toggleFullscreen = function(onOff) {
        if (fs.enabled()) {
            if (onOff === fs.isFullscreen()) {
                return;
            }
            if (typeof onOff === "undefined") {
                onOff = !fs.isFullscreen();
            }
            if (onOff) {
                enterFullscreen.call(this);
            } else {
                exitFullscreen.call(this);
            }
        } else {
            if ($.isWebkitFullscreenVideoSupported) {
                if (onOff === this.display.isWebkitFullscreen()) {
                    return;
                }
                if (typeof onOff === "undefined") {
                    onOff = !this.display.isWebkitFullscreen();
                }
                if (onOff) {
                    this.display.webkitEnterFullscreen();
                } else {
                    this.display.webkitExitFullscreen();
                }
            }
        }
    };
    return{init:function(controller) {
        this.controller = controller;
        this.player = controller.getPlayer();
        this.display = vdb.html5.player.Display.getInstance();
        this.container = this.player.container;
        this.videosContainer = this.player.videosContainer;
        this.forcedExitFullscreen = false;
        try {
            this.frameElement = window["frameElement"];
        } catch (e) {
            this.frameElement = null;
        }
        attachEvents.call(this);
    }, isFullscreen:function() {
        return fs.isFullscreen();
    }, toggleFullscreen:function(pseudoMode, onOff) {
        if (pseudoMode) {
            if (!this._pseudoFSController) {
                this._pseudoFSController = new vdb.html5.player.PseudoFullscreenController(this.controller);
            }
            this._pseudoFSController.toggleFullscreen(onOff);
        } else {
            toggleFullscreen.call(this, onOff);
        }
    }, attemptToExitFullscreen:function() {
        if (fs.enabled()) {
            if (fs.isFullscreen()) {
                this.forcedExitFullscreen = true;
                exitFullscreen.call(this);
            }
        } else {
            if ($.isWebkitFullscreenVideoSupported) {
                if (this.display.isWebkitFullscreen()) {
                    this.forcedExitFullscreen = true;
                    this.display.webkitExitFullscreen();
                }
            }
        }
    }};
}());
vdb.html5.player.LookAheadAdView = vdb.EventBus.extend(function() {
    var utl = vdb.Utils;
    var TIME_LEFT_TEXT = "Ad will start in ";
    var SKIP_AD_TEXT = "Skip ad";
    var buildPanel = function() {
        this.adPanel = utl.createElement("div", {"class":"look-ahead-ad-panel"});
        this.adPanelElement = utl.createElement("div", {"class":"look-ahead-ad-panel-element"}, this.adPanel);
        this.adPanelElementSpan = utl.createElement("span", {"class":"look-ahead-ad-panel-span"}, this.adPanelElement);
        this.adPanelElementTimeSpan = utl.createElement("span", {"class":"look-ahead-ad-panel-time-span"}, this.adPanelElement);
        this.adPanelSkip = utl.createElement("div", {"class":"look-ahead-ad-panel-skip"}, this.adPanel);
        this.adPanelElementSkipSpan = utl.createElement("span", {"class":"look-ahead-ad-panel-skip-span"}, this.adPanelSkip);
        this.adPanelElementSkipIcon = utl.createElement("div", {"class":"look-ahead-ad-panel-skip-icon"}, this.adPanelSkip, '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 6.3 10.3" xml:space="preserve"><path class="st0" d="M6.1,5.8c-0.4,0.4-1,0.4-1.4,0L0.3,1.7c-0.4-0.4-0.4-1,0-1.4c0.4-0.4,1-0.4,1.4,0L6,4.4 C6.4,4.8,6.5,5.4,6.1,5.8z"/><path class="st0" d="M6,5.9L1.7,10c-0.4,0.4-1,0.4-1.4,0c-0.4-0.4-0.4-1,0-1.4l4.3-4.1c0.4-0.4,1-0.4,1.4,0C6.5,4.8,6.4,5.5,6,5.9z"/></svg> ');
        vdb.dom.embedCssToHead(".look-ahead-ad-panel{position:absolute;bottom:60px;right:0;width:125px;height:45px;z-index:6;color:#d0d0d0;font:12px/13px Arial;background-color:rgba(34,34,34,0.85);padding:8px 15px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;border:1px solid black;border-top-left-radius:35px;border-bottom-left-radius:35px;text-align:right;-moz-transform:translateX(100%);-webkit-transform:translateX(100%);transform:translateX(100%);cursor:pointer}.look-ahead-ad-panel:hover .look-ahead-ad-panel-skip{text-decoration:underline}.look-ahead-ad-panel:hover .look-ahead-ad-panel-skip .player-icon{fill:#customColor}.fullscreen-mode .look-ahead-ad-panel{width:165px;height:55px;bottom:98px;font-size:18px}.fullscreen-mode .look-ahead-ad-panel-skip{margin-top:10px}.look-ahead-ad-panel-skip{margin-top:5px;text-transform:uppercase}.look-ahead-ad-panel-element{width:100%}.look-ahead-ad-panel-time-span{font-weight:bold}.look-ahead-ad-panel-skip-icon{width:7px;height:7px;margin-left:5px;display:inline-block}.expand-skip-button{opacity:1;-moz-animation:expand-skip-button .7s;-webkit-animation:expand-skip-button .7s;animation:expand-skip-button .7s;-moz-transform:translateX(0);-webkit-transform:translateX(0);transform:translateX(0)}.collapse-skip-button{opacity:0;-moz-animation:collapse-skip-button .7s;-webkit-animation:collapse-skip-button .7s;animation:collapse-skip-button .7s}@keyframes expand-skip-button{from{-moz-transform:translateX(100%);-webkit-transform:translateX(100%);transform:translateX(100%)}to{-moz-transform:translateX(0);-webkit-transform:translateX(0);transform:translateX(0)}}@-moz-keyframes expand-skip-button{from{-moz-transform:translateX(100%);transform:translateX(100%)}to{-moz-transform:translateX(0);transform:translateX(0)}}@-webkit-keyframes expand-skip-button{from{-webkit-transform:translateX(100%);transform:translateX(100%)}to{-webkit-transform:translateX(0);transform:translateX(0)}}@keyframes collapse-skip-button{from{opacity:1;-moz-transform:translateX(0);-webkit-transform:translateX(0);transform:translateX(0)}to{opacity:1;-moz-transform:translateX(100%);-webkit-transform:translateX(100%);transform:translateX(100%)}}@-moz-keyframes collapse-skip-button{from{opacity:1;-moz-transform:translateX(0);transform:translateX(0)}to{opacity:1;-moz-transform:translateX(100%);transform:translateX(100%)}}@-webkit-keyframes collapse-skip-button{from{opacity:1;-webkit-transform:translateX(0);transform:translateX(0)}to{opacity:1;-webkit-transform:translateX(100%);transform:translateX(100%)}}".replace(/#customColor/g,
            this._player.getControlsCustomColor()));
        this.adPanelElementSpan.innerText = TIME_LEFT_TEXT;
        this.adPanelElementSkipSpan.innerText = SKIP_AD_TEXT;
    };
    return{init:function(player) {
        this._player = player;
        this._container = player.videosContainer;
        buildPanel.call(this);
        this._isVisible = false;
    }, update:function(timeLeft) {
        this.adPanelElementTimeSpan.innerText = timeLeft;
    }, isVisible:function() {
        return this._isVisible;
    }, show:function() {
        utl.replaceClass(this.adPanel, "collapse-skip-button", "expand-skip-button");
        this._isVisible = true;
    }, hide:function() {
        utl.replaceClass(this.adPanel, "expand-skip-button", "collapse-skip-button");
        this._isVisible = false;
    }, attachAdPanel:function() {
        this._container.appendChild(this.adPanel);
    }};
}());
vdb.html5.player.LookAheadAdManager = vdb.core.Class.extend(function() {
    var ec = vdb.events.EventContext;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var SECONDS_TO_AD = 5;
    var SKIP_BUTTON_SHOW_DELAY = 1E3;
    var bindEvents = function() {
        this._eventGroup = this._eventGroup || new vdb.events.EventContextBindGroup(ec.bind(this._player, PlayerEvent.AD_START, hideView.bind(this)), ec.bind(this._player, PlayerEvent.VIDEO_END, hideView.bind(this)), ec.bind(this._player, PlayerEvent.VIDEO_START, onVideoStart.bind(this)), ec.bind(this._player, PlayerEvent.VIDEO_TIMEUPDATE, onVideoTimeUpdate.bind(this)), ec.bind(this._player, PlayerEvent.ADS_LOADED, onAdsLoaded.bind(this)), ec.bind(this._player, vdb.html5.player.AD_NONE, onAdNone.bind(this)),
            ec.bind(this._view.adPanel, "click", onSkipButtonClick.bind(this)));
    };
    var onSkipButtonClick = function() {
        this._adController.skip();
        this._lookAheadFuture.reject();
        this._view.hide();
        this._controller.hideSpinner();
    };
    var onAdsLoaded = function(e) {
        this._lookAheadFuture = new vdb.Future;
        this._adController = this._controller.getAdController();
        this._hasLookAhead = this._controller.getCurrentVideoIndex() === 0 && e["data"] && e["data"][0] && e["data"][0].getAdxResult() === "LOOKAHEAD";
        if (this._hasLookAhead) {
            this._view.attachAdPanel();
        }
    };
    var hideView = function() {
        if (this.hasLookAhead() && this._view.isVisible()) {
            this._view.hide();
        }
    };
    var onVideoStart = function() {
        if (this.hasLookAhead() && !this._noSkipMode) {
            setTimeout(function() {
                this._view.show();
            }.bind(this), SKIP_BUTTON_SHOW_DELAY);
        }
    };
    var onAdNone = function() {
        this._hasLookAhead = false;
    };
    var onVideoTimeUpdate = function(e) {
        if (!this.hasLookAhead()) {
            return;
        }
        var currentTime = e && e["data"] && e["data"]["currentTime"] || 0;
        this._view.update(Math.max(Math.round(SECONDS_TO_AD - currentTime), 1));
        if (currentTime >= SECONDS_TO_AD) {
            this._lookAheadFuture.resolve();
            hideView.call(this);
        }
    };
    var _getPromise = function() {
        return this._lookAheadFuture.getPromise();
    };
    return{init:function(controller, noSkipMode) {
        this._controller = controller;
        this._player = controller.getPlayer();
        this._view = new vdb.html5.player.LookAheadAdView(this._player);
        this._noSkipMode = noSkipMode || false;
        this._view.update(SECONDS_TO_AD);
        bindEvents.call(this);
    }, hasLookAhead:function() {
        return this._hasLookAhead || this._noSkipMode;
    }, look:function() {
        this._controller.playUntilLookAhead();
        return _getPromise.call(this);
    }};
}());
vdb.html5.player.MessageReceiver = vdb.core.Class.extend(function() {
    function dispatchExternalEvent(type, data) {
        switch(type) {
            case "devicemotion":
                var event = vdb.utils.Common.makeEvent(type, data);
                window.dispatchEvent(event);
                break;
            default:
                ;
        }
    }
    function onWindowMessage(event) {
        var data = event.data && event.data.split(":");
        if (data && data[0] === "event") {
            var eventType = data[1];
            var eventData = JSON.parse(decodeURIComponent(data[2]));
            dispatchExternalEvent(eventType, eventData);
        }
    }
    function init() {
        vdb.$win.addEventListener("message", onWindowMessage, false);
    }
    return{init:init};
}());
vdb.html5.player.Modal = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var removeTransitionOnFinish = function(element) {
        var removeTransitionFromElement = function() {
            utl.setStyle(element, {"-webkit-transition":"none", "-moz-transition":"none", "-o-transition":"none", "transition":"none"});
        };
        ["transitionend", "webkitTransitionEnd", "otransitionend"].forEach(function(event) {
            element.addEventListener(event, function() {
                removeTransitionFromElement(element);
            }, false);
        });
    };
    var prepareForAnimation = function(elements) {
        var objRect;
        elements.forEach(function(element) {
            objRect = element.getBoundingClientRect();
            element.removeAttribute("style");
            utl.setStyle(element, {position:"fixed", height:objRect.height + "px", width:objRect.width + "px", top:objRect.top + "px", left:objRect.left + "px", zIndex:"999999999"});
            removeTransitionOnFinish(element);
        });
    };
    var clearElementsCssClasses = function(elements) {
        elements.forEach(function(element) {
            element.className = "";
        });
    };
    var setContainers = function(wrapper, content, additionalElements) {
        this.wrapper = wrapper;
        this.content = content;
        this.additionalElements = additionalElements || [];
    };
    var saveElementsStyle = function(elements) {
        elements.forEach(function(element) {
            this.elementsInitialStyle.push({element:element, cssText:element.style.cssText, className:element.className});
        }.bind(this));
    };
    var activate = function(wrapper, content, additionalElements, shouldClearCssClasses) {
        var elementsToPrepare;
        setContainers.call(this, wrapper, content, additionalElements);
        elementsToPrepare = [this.wrapper, this.content].concat(this.additionalElements);
        saveElementsStyle.call(this, elementsToPrepare);
        if (shouldClearCssClasses) {
            clearElementsCssClasses.call(this, elementsToPrepare);
        }
        prepareForAnimation.call(this, [this.wrapper, this.content]);
        setTimeout(function() {
            utl.setStyle(this.wrapper, {position:"fixed", zIndex:"999999999", height:"100%", width:"100%", top:"0", left:"0", background:"rgba(0,0,0,0.75)", webkitTransition:"background 0.15s ease-in", mozTransition:"background 0.15s ease-in", oTransition:"background 0.15s ease-in", transition:"background 0.15s ease-in"});
            utl.setStyle(this.content, {position:"absolute", top:"50%", left:"50%", width:"70%", height:"initial", webkitTransform:"translate(-50%, -50%)", mozTransform:"translate(-50%, -50%)", msTransform:"translate(-50%, -50%)", transform:"translate(-50%, -50%)", webkitTransition:"all 0.35s ease-in-out", mozTransition:"all 0.35s ease-in-out", oTransition:"all 0.35s ease-in-out", transition:"all 0.35s ease-in-out"});
        }.bind(this), 50);
    };
    var deactivate = function() {
        this.elementsInitialStyle.forEach(function(obj) {
            obj.element.style.cssText = obj.cssText;
            obj.element.className = obj.className;
        });
        this.elementsInitialStyle = [];
    };
    return{init:function() {
        this.elementsInitialStyle = [];
    }, activate:activate, deactivate:deactivate};
}());
vdb.html5.player.OverlayContainer = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var insertOverlayContainer = function() {
        this.overlayContainer = utl.createElement("div", {"id":"vdb-player-overlay-container-" + this.playerId, "class":"vdb-player-overlay-container", "style":["position: absolute;", "width: 100%;", "height: 100%;", "left: 0;", "top: 0;", "z-index: 2;", "pointer-events: none;"]}, this.player.container);
    };
    return{init:function(player) {
        this.player = player;
        this.playerId = vdb.ctx.playerId;
        insertOverlayContainer.call(this);
    }};
}());
vdb.html5.player.PlayerState = vdb.core.Class.extend(function() {
    return{startPlayTimeCounting:function() {
        if (!this._playStartTime) {
            this._playStartTime = (new Date).getTime();
        }
    }, stopPlayTimeCounting:function() {
        if (this._playStartTime) {
            var now = Date.now();
            this._totalPlayTime = (this._totalPlayTime ? this._totalPlayTime : 0) + now - this._playStartTime;
            this._currentPlayTime = (this._currentPlayTime ? this._currentPlayTime : 0) + now - this._playStartTime;
            this._playStartTime = 0;
        }
    }, onPlayerReady:function() {
        this._totalVideoCount = 0;
    }, onVideoPlay:function() {
        this._totalVideoCount++;
    }, onVideoChange:function() {
        this._currentPlayTime = 0;
    }, onMetadata:function(metadata, video) {
        this._videoLength = metadata.duration ? metadata.duration : 0;
        var maxLength = video && video.metadata && video.metadata["duration"];
        if (maxLength) {
            this._videoLength = Math.min(this._videoLength, maxLength);
        }
    }, onTimeUpdate:function(value) {
        this._currentTime = Math.min(value || 0, this.getVideoLength());
        if (this._videoLength) {
            this._currentPercent = this._currentTime / this._videoLength;
        } else {
            this._currentPercent = 0;
        }
    }, getTotalPlayTime:function(now) {
        now = now || Date.now();
        return((this._totalPlayTime ? this._totalPlayTime : 0) + (this._playStartTime ? now - this._playStartTime : 0)) / 1E3;
    }, getCurrentPlayTime:function(now) {
        now = now || Date.now();
        return((this._currentPlayTime ? this._currentPlayTime : 0) + (this._playStartTime ? now - this._playStartTime : 0)) / 1E3;
    }, getTotalVideoCount:function() {
        return this._totalVideoCount || 0;
    }, getVideoLength:function() {
        return this._videoLength || 0;
    }, getCurrentTime:function() {
        return this._currentTime || 0;
    }, getCurrentPercent:function() {
        return this._currentPercent || 0;
    }, getState:function() {
        var now = Date.now();
        return{"currentTime":this.getCurrentTime(), "currentPlayTime":this.getCurrentPlayTime(now), "currentPercent":this.getCurrentPercent(), "videoLength":this.getVideoLength(), "totalPlayTime":this.getTotalPlayTime(), "totalVideoCount":this.getTotalVideoCount(now)};
    }};
}());
vdb.html5.player.poster = {};
vdb.html5.player.poster.AnimatedPoster = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("AnimatedPoster");
    var LARGE_ANIMATED_POSTER_WIDTH = 426;
    var LARGE_ANIMATED_POSTER_HEIGHT = 240;
    var ANIMATED_POSTER_TIMEOUT_DURATION = 4E3;
    var AnimatedPosterType = vdb.html5.enums.AnimatedPosterType;
    var getAnimatedPosterSize = function() {
        return this._size || (this._container.clientWidth > LARGE_ANIMATED_POSTER_WIDTH || this._container.clientHeight > LARGE_ANIMATED_POSTER_HEIGHT ? "large" : "small");
    };
    var getAnimatedPosterUrl = function(type) {
        var size = getAnimatedPosterSize.call(this);
        var animatedPosters = this._trailer[type + "s"] || [];
        var animatedPosterUrls = {};
        var animatedPoster;
        var len = animatedPosters.length;
        for (var i = -1;++i < len;) {
            animatedPoster = animatedPosters[i];
            if (animatedPoster["size"]) {
                animatedPosterUrls[animatedPoster["size"].toLowerCase()] = animatedPoster["url"];
            }
        }
        return size === "large" ? animatedPosterUrls["large"] || animatedPosterUrls["small"] : animatedPosterUrls["small"];
    };
    var createVideoPoster = function(animatedPosterUrl) {
        var onError = onVideoPosterError.bind(this, animatedPosterUrl);
        this._mediaElement = vdb.Utils.createElement("video", {"src":animatedPosterUrl, "autoplay":"true", "loop":"true", "muted":"true", "playsinline":"true", "webkit-playsinline":"true"});
        this._mediaElement.onerror = onError;
        this._animatedPosterTimeout = setTimeout(onError, ANIMATED_POSTER_TIMEOUT_DURATION);
        vdb.events.EventContext.bindOnce(this._mediaElement, "play", onAnimatedPosterPlay.bind(this));
        appendPoster.call(this);
    };
    var createGifPoster = function(animatedPosterUrl) {
        var imageLoader = new Image;
        var onError = onGifPosterError.bind(this, animatedPosterUrl);
        this._mediaElement = vdb.Utils.createElement("div", {"style":'background-image: url("' + animatedPosterUrl + '")'});
        this._animatedPosterTimeout = setTimeout(onError, ANIMATED_POSTER_TIMEOUT_DURATION);
        imageLoader.onload = onAnimatedPosterPlay.bind(this);
        imageLoader.onerror = onError;
        imageLoader.src = animatedPosterUrl;
        appendPoster.call(this);
    };
    var attemptCreateGifPoster = function() {
        var animatedPosterUrl = getAnimatedPosterUrl.call(this, AnimatedPosterType.GIF);
        if (animatedPosterUrl) {
            createGifPoster.call(this, animatedPosterUrl);
        } else {
            exitAnimatedPoster.call(this);
        }
    };
    var appendPoster = function() {
        vdb.Utils.addClass(this._mediaElement, "animated-poster-media-element");
        this._container.appendChild(this._mediaElement);
        if (!this._hideOverlay) {
            addOverlay.call(this);
        }
    };
    var addOverlay = function() {
        if (this._overlay) {
            return;
        }
        vdb.Utils.addClass(this._container, "animated-poster-loading");
        this._overlay = vdb.Utils.createElement("div", {"class":"animated-poster-overlay"}, this._container);
        if (!this._hideOverlayText) {
            this._overlayText = vdb.Utils.createElement("div", {"class":"click-to-play"}, this._overlay, "Click to " + (this.isReplay ? "re" : "") + "play full video");
            this._resizeListener = vdb.events.EventContext.bind(window, "resize", resizeOverlayText.bind(this));
            resizeOverlayText.call(this);
        }
        vdb.Utils.createElement("div", {"class":["poster-curtain", "top-left-curtain", "inner-curtain"]}, this._overlay);
        vdb.Utils.createElement("div", {"class":["poster-curtain", "top-left-curtain", "outer-curtain"]}, this._overlay);
        vdb.Utils.createElement("div", {"class":["poster-curtain", "bottom-right-curtain", "inner-curtain"]}, this._overlay);
        vdb.Utils.createElement("div", {"class":["poster-curtain", "bottom-right-curtain", "outer-curtain"]}, this._overlay);
    };
    var resizeOverlayText = function() {
        var fontSize = Math.max(~~(this._container.clientWidth / 30), 12);
        var blurRadius = ~~(fontSize / 6);
        vdb.Utils.setStyle(this._overlayText, {"font-size":fontSize + "px", "line-height":fontSize + "px", "text-shadow":"0px 0 " + blurRadius + "px #000"});
    };
    var onAnimatedPosterPlay = function() {
        var that = this;
        clearTimeout(this._animatedPosterTimeout);
        this._onAnimatedPosterPlay();
        if (this._overlay) {
            setTimeout(function() {
                vdb.Utils.removeClass(that._container, "animated-poster-loading");
                setTimeout(function() {
                    vdb.Utils.addClass(that._container, "animated-poster-loaded");
                }, 1E3);
            }, 1);
        }
    };
    var onAnimatedPosterError = function(animatedPosterUrl) {
        clearTimeout(this._animatedPosterTimeout);
        LOGGER.error("Failed to load animated poster", animatedPosterUrl);
    };
    var onVideoPosterError = function(animatedPosterUrl) {
        onAnimatedPosterError.call(this, animatedPosterUrl);
        disposeMediaElement.call(this);
        attemptCreateGifPoster.call(this);
    };
    var onGifPosterError = function(animatedPosterUrl) {
        onAnimatedPosterError.call(this, animatedPosterUrl);
        exitAnimatedPoster.call(this);
    };
    var exitAnimatedPoster = function() {
        this.dispose();
        this._onError();
    };
    var disposeMediaElement = function() {
        vdb.Utils.removeFromParent(this._mediaElement);
        delete this._mediaElement;
    };
    return{init:function(opts) {
        this._container = opts.container;
        this._trailer = opts.video && opts.video.trailer || {};
        this._size = opts.size;
        this._hideOverlay = opts.hideOverlay;
        this._hideOverlayText = opts.hideOverlayText;
        this._onAnimatedPosterPlay = opts.onAnimatedPosterPlay || function() {
        };
        this._onError = opts.onError || function() {
        };
        var animatedPosterUrl = getAnimatedPosterUrl.call(this, AnimatedPosterType.VIDEO);
        if (vdb.Utils.browser.playsNativeInline() && animatedPosterUrl) {
            createVideoPoster.call(this, animatedPosterUrl);
        } else {
            attemptCreateGifPoster.call(this);
        }
    }, removeOverlay:function() {
        if (this._resizeListener) {
            this._resizeListener.unbind();
        }
        vdb.Utils.removeFromParent(this._overlay);
        delete this._overlay;
        vdb.Utils.removeClass(this._container, ["animated-poster-loading", "animated-poster-loaded"]);
    }, dispose:function() {
        clearTimeout(this._animatedPosterTimeout);
        disposeMediaElement.call(this);
        if (this._overlay) {
            this.removeOverlay();
        }
    }};
}());
vdb.dom.embedCssToHead(".animated-poster-media-element{width:100%;height:100%;opacity:1;-webkit-transition:opacity .9s;-moz-transition:opacity .9s;-ms-transition:opacity .9s;-o-transition:opacity .9s;transition:opacity .9s}div.animated-poster-media-element{background-repeat:no-repeat;background-position:center;background-size:cover}video.animated-poster-media-element{object-fit:cover}.animated-poster-loading .animated-poster-media-element{opacity:0}.animated-poster-overlay{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;opacity:1;-webkit-transition:opacity .1s;-moz-transition:opacity .1s;-ms-transition:opacity .1s;-o-transition:opacity .1s;transition:opacity .1s}.animated-poster-loading .animated-poster-overlay{opacity:0}.click-to-play{position:absolute;top:11px;left:11px;display:inline-block;font-family:Arial;color:rgba(255,255,255,0.8);z-index:3;-webkit-transition:opacity 1s;-moz-transition:opacity 1s;-ms-transition:opacity 1s;-o-transition:opacity 1s;transition:opacity 1s;opacity:0}.animated-poster-loaded .click-to-play{opacity:1}.inner-curtain,.outer-curtain{position:absolute;top:0;width:100%;height:100%;overflow:hidden;background-color:rgba(0,0,0,0.3);-webkit-transform:skew(-23deg);-moz-transform:skew(-23deg);-ms-transform:skew(-23deg);-o-transform:skew(-23deg);transform:skew(-23deg)}.inner-curtain{z-index:1}.outer-curtain{z-index:2}.top-left-curtain{-webkit-transition:left 1s;-moz-transition:left 1s;-ms-transition:left 1s;-o-transition:left 1s;transition:left 1s}.bottom-right-curtain{-webkit-transition:right 1s;-moz-transition:right 1s;-ms-transition:right 1s;-o-transition:right 1s;transition:right 1s}.animated-poster-loaded .top-left-curtain{-webkit-transition:left .3s;-moz-transition:left .3s;-ms-transition:left .3s;-o-transition:left .3s;transition:left .3s}.animated-poster-loaded .bottom-right-curtain{-webkit-transition:right .3s;-moz-transition:right .3s;-ms-transition:right .3s;-o-transition:right .3s;transition:right .3s}.animated-poster-loading .top-left-curtain{left:-50%!important}.animated-poster-loading .bottom-right-curtain{right:-50%!important}.top-left-curtain.outer-curtain{left:-76%}.top-left-curtain.inner-curtain{left:-88%}.bottom-right-curtain.outer-curtain{right:-76%}.bottom-right-curtain.inner-curtain{right:-88%}.hover-enabled .animated-poster-loaded:hover .top-left-curtain.outer-curtain{left:-80%}.hover-enabled .animated-poster-loaded:hover .top-left-curtain.inner-curtain{left:-90%}.hover-enabled .animated-poster-loaded:hover .bottom-right-curtain.outer-curtain{right:-80%}.hover-enabled .animated-poster-loaded:hover .bottom-right-curtain.inner-curtain{right:-90%}");
vdb.html5.player.poster.BasePoster = vdb.EventBus.extend(function() {
    var utl = vdb.Utils;
    return{init:function(container) {
        this.posterOuterContainer = utl.createElement("div", {"class":"poster-outer-container"}, container);
        this.posterInnerContainer = utl.createElement("div", {"class":"poster-inner-container"}, this.posterOuterContainer);
        this.eventGroup = new vdb.events.EventContextBindGroup;
        this._super();
        if (utl.mobileOs()) {
            utl.addClass(this.posterOuterContainer, "mobile");
        }
    }, bindListeners:function() {
        this.eventGroup.addContext(vdb.events.EventContext.bind(this.posterOuterContainer, "click", this.click.bind(this)));
    }, setOnPosterAction:function(callback) {
        this._onPosterAction = callback;
    }, setThirdPartyPoster:function(element) {
        this.remove();
        this.eventGroup.addContext(vdb.events.EventContext.bind(element, "click", this.click.bind(this)));
    }, posterAction:function(isUserInteraction) {
        if (utl.isFunction(this._onPosterAction)) {
            this._onPosterAction(isUserInteraction);
        }
    }, click:function() {
        var isUserInteraction = true;
        this.posterAction(isUserInteraction);
    }, remove:function() {
        this.eventGroup.unbind();
        utl.removeFromParent(this.posterOuterContainer);
    }, addControls:function() {
    }};
}());
vdb.dom.embedCssToHead(".ad-mode video::-webkit-media-controls{display:none}.poster-outer-container{width:100%;height:100%;position:absolute;left:0;top:0;z-index:8;cursor:pointer}.poster-outer-gray{background-color:#333}.poster-inner-container{width:100%;height:100%;position:absolute;left:0;top:0;z-index:2;background-repeat:no-repeat;background-position:center;background-size:cover}");
vdb.html5.player.poster.PlayPoster = vdb.html5.player.poster.BasePoster.extend(function() {
    var LOGGER = vdb.log.getLogger("PlayPoster");
    var POSTER_360_MAGNIFIER = 2;
    var PlayerMacros = vdb.constants.PlayerMacros;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var has360Support = function() {
        return!(vdb.Utils.isIE && vdb.Utils.browser["version"] < 11) && vdb.Utils.webglSupport;
    };
    var is360Poster = function() {
        var videoData = this.video["metadata"] || this.video.metadata || {};
        if (videoData["videoType"] === vdb.enums.video.Type.THREE_SIXTY && has360Support()) {
            switch(this.context.getMacro(PlayerMacros.DISABLE360POSTER)) {
                case "mobile":
                    return!vdb.Utils.mobileOs();
                case "desktop":
                    return!vdb.Utils.desktopOs();
                case "1":
                    ;
                case "all":
                    return false;
                default:
                    return true;
            }
        }
        return false;
    };
    var isYouTube = function() {
        return this.video && (this.video["videoSourceType"] || this.video.videoSourceType || "").toLowerCase() === vdb.enums.VideoSourceType.YOUTUBE;
    };
    var dispatchReadyEventOnLoad = function(url) {
        var imageLoader = new Image;
        if (url) {
            imageLoader.onload = this.player.dispatchEvent.bind(this.player, PlayerEvent.VIDEO_POSTER_READY, this);
        } else {
            this.player.dispatchEvent(PlayerEvent.VIDEO_POSTER_READY, this);
        }
        imageLoader.src = url;
    };
    var setPosterBackground = function() {
        var staticPosterUrl;
        var containerWidth;
        var containerHeight;
        if (this.isYouTube) {
            vdb.Utils.setStyle(this.posterOuterContainer, {"display":"none"});
            return;
        }
        vdb.Utils.addClass(this.posterOuterContainer, "poster-outer-gray");
        if (this.isAnimated) {
            this.animatedPoster = new vdb.html5.player.poster.AnimatedPoster({container:this.posterOuterContainer, video:this.video, hideOverlayText:vdb.ctx.getMacro(vdb.constants.PlayerMacros.ANIMATED_POSTER_TEXT) === "0", onAnimatedPosterPlay:function() {
                this.player.dispatchEvent(PlayerEvent.VIDEO_POSTER_READY, this);
            }.bind(this), onError:function() {
                this.isAnimated = false;
                setPosterBackground.call(this);
            }.bind(this)});
            return;
        }
        staticPosterUrl = this.video.fullSizeThumbnail || "";
        containerWidth = this.posterInnerContainer.clientWidth;
        containerHeight = this.posterInnerContainer.clientHeight;
        if (containerWidth && containerHeight) {
            if (this.is360) {
                containerWidth = Math.max(containerWidth * POSTER_360_MAGNIFIER, 1440);
                containerHeight = containerWidth / 2;
            }
            staticPosterUrl = vdb.utils.Common.getThumbnailModifiedUrl(null, staticPosterUrl, containerWidth, containerHeight, vdb.ctx.urls.isSecure());
        }
        if (this.is360) {
            vdb.html5.player.vrLoader.load().then(function() {
                var data360 = this.video && this.video.data360;
                this.poster360 = new vdb["vr"]["Poster"]({"container":this.posterInnerContainer, "url":staticPosterUrl, "projectionType":data360 && data360.projectionType, "tilt":data360 && data360.tilt, "centeredFishEye":vdb.ctx.getMacro(PlayerMacros.CENTEREDFISHEYE), "fishEyeAngle":vdb.ctx.getMacro(PlayerMacros.FISHEYEANGLE)});
                this.poster360["render"]();
            }.bind(this))["catch"](function(e) {
                LOGGER.warn("Failed to create 360 poster ", e);
            });
        }
        this.overrideThumbnail(staticPosterUrl);
        dispatchReadyEventOnLoad.call(this, staticPosterUrl);
    };
    var canCustomizePlayButton = function() {
        return this.playButtonSettings.hasOwnProperty("w") && this.playButtonSettings.hasOwnProperty("h") && this.playButtonSettings.hasOwnProperty("x") && this.playButtonSettings.hasOwnProperty("y") && this.playButtonSettings["w"] < this.posterInnerContainer.clientWidth && this.playButtonSettings["h"] < this.posterInnerContainer.clientHeight;
    };
    return{init:function(player, container, video, mouseoverStart, isAnimated, isReplay, controller) {
        this.context = vdb["getContext"](vdb.ctx.id);
        this.player = player;
        this.video = video || {};
        this.mouseoverStart = mouseoverStart;
        this.is360 = is360Poster.call(this);
        this.isYouTube = isYouTube.call(this);
        this.isAnimated = vdb.utils.UrlUtils.getParameterByName("animatedposter") === "1" || isAnimated && !this.is360;
        this.isReplay = isReplay;
        this.showOnlyPlayButton = vdb.ctx.getMacro(PlayerMacros.POSTERSTYLE) === "button_only";
        this.hideDuration = vdb.ctx.getMacro(PlayerMacros.HIDEDURATION) === "true";
        this.playsNativeInline = vdb.Utils.browser.playsNativeInline();
        this.controller = controller;
        this._super(container);
        setPosterBackground.call(this);
        this.addControls();
        this.setTitleAndDuration(this.video.title || "", (this.video.metadata || {}).duration, this.video.studioName || "", this.video.description);
        this.bindListeners();
    }, customizeStartButton:function() {
        this.playButton = this.playButton || this.posterInnerContainer.firstChild;
        this.playButtonSettings = this.context.getCoveringsSkinLocation();
        var playButtonHeight = this.playButton.clientHeight;
        var playButtonWidth = this.playButton.clientWidth;
        var playButtonProportion = playButtonHeight / playButtonWidth;
        var playButtonWidthToSet = this.playButtonSettings["w"];
        var playButtonHeightToSet = this.playButtonSettings["w"] * playButtonProportion;
        if (canCustomizePlayButton.call(this)) {
            if (playButtonWidthToSet === 0) {
                playButtonWidthToSet = this.playButtonSettings["h"] / playButtonProportion;
                playButtonHeightToSet = this.playButtonSettings["h"];
            }
            vdb.Utils.setStyle(this.playButton, {width:playButtonWidthToSet + "px", height:playButtonHeightToSet + "px", margin:"0px", left:this.playButtonSettings["x"] + "px", top:this.playButtonSettings["y"] + "px", "min-width":0, "min-height":0, "-webkit-transform":"none", "-moz-transform":"none", "-ms-transform":"none", "transform":"none"});
        }
    }, removeControls:function() {
        this.posterInnerContainer.innerHTML = "";
        this.animatedPoster && this.animatedPoster.removeOverlay();
    }, overrideThumbnail:function(thumbnailUrl) {
        this.posterInnerContainer.style.backgroundImage = 'url("' + thumbnailUrl + '")';
    }, posterAction:function(isUserInteraction) {
        this.poster360 && this.poster360["destroy"]();
        this._super(isUserInteraction);
    }, bindListeners:function() {
        if (vdb.Utils.desktopOs() && this.mouseoverStart) {
            this.eventGroup.addContext(vdb.events.EventContext.bind(this.posterInnerContainer, "mouseover", this.posterAction.bind(this)));
        }
        this.player.addEventListener(PlayerEvent.ENTER_FULLSCREEN, function() {
            this.isFullScreen = true;
        }.bind(this));
        this.player.addEventListener(PlayerEvent.EXIT_FULLSCREEN, function() {
            this.isFullScreen = false;
        }.bind(this));
        this._super();
    }, setTitleAndDuration:function(title, duration, owner, description) {
        this.videoTitle = title || this.videoTitle;
        this.videoDuration = duration ? Math.round(duration / 1E3) : this.videoDuration;
        this.videoOwner = owner || this.videoOwner;
        this.videoDescription = description || this.videoDescription;
        if (this.videoTitle && !this.showOnlyPlayButton) {
            this.setTitle();
        } else {
            this.titleRibbonTable && this.titleRibbonTable.removeAttribute("style");
        }
        if (this.videoDuration && !this.hideDuration) {
            this.setDuration();
        }
        if (this.videoOwner && !this.showOnlyPlayButton) {
            this.setOwner();
        }
        if (this.videoDescription && !this.showOnlyPlayButton) {
            this.setDescription();
        }
    }, setDescription:function() {
    }, setTitle:function() {
    }, setDuration:function() {
    }, setOwner:function() {
    }, remove:function() {
        this.animatedPoster && this.animatedPoster.dispose();
        this._super();
    }, setReplayMinimizedControls:function(icon) {
        if (this.isReplay && (vdb.utils.Fullscreen.enabled() && vdb.utils.Fullscreen.isFullscreen() || vdb.utils.Common.isWebkitFullscreenVideoSupported && vdb.Utils.browser.isIos() && this.isFullScreen)) {
            this.fullscreenButtonCell = vdb.Utils.createElement("div", {"class":"fullscreen-cell"}, this.titleRibbonRow);
            this.fullscreenButton = vdb.Utils.createElement("div", {"class":"fullscreen-button-replay"}, this.fullscreenButtonCell);
            vdb.Utils.createElement("div", {"class":"exit-fullscreen-icon-replay"}, this.fullscreenButton, icon);
            this.fullscreenButton.addEventListener(vdb.Utils.mobileOs() ? "touchend" : "click", function() {
                this.controller.toggleFullscreen();
            }.bind(this));
        }
    }, click:function() {
        this._super();
        this.context.dispatchEvent(PlayerEvent.POSTER_CLICK);
    }};
}());
vdb.html5.player.poster.ResumeAdPoster = vdb.html5.player.poster.BasePoster.extend({init:function(container) {
    this._super(container);
    this.addControls();
    this.bindListeners();
}});
vdb.coverings.covering.PlayPoster = vdb.html5.player.poster.PlayPoster.extend(function() {
    var utl = vdb.Utils;
    var $ = vdb.utils.Common;
    return{addControls:function() {
        if (this.showOnlyPlayButton) {
            this.playButton = utl.createElement("div", {"class":["skin5-poster-play-button", "skin5-poster-corner-button"]}, this.posterInnerContainer);
        } else {
            var titleRibbonAttributes = {"class":"skin5-poster-title-ribbon"};
            if (utl.iPhoneOS()) {
                titleRibbonAttributes["style"] = "bottom: 0;";
            }
            this.titleRibbon = utl.createElement("div", titleRibbonAttributes, this.posterInnerContainer);
            this.titleRibbonTable = utl.createElement("div", {"class":"skin5-poster-title-ribbon-table", "style":"visibility: hidden;"}, this.titleRibbon);
            this.titleRibbonRow = utl.createElement("div", {"class":"skin5-poster-title-ribbon-row"}, this.titleRibbonTable);
            this.playButtonCell = utl.createElement("div", {"class":"skin5-poster-play-button-cell"}, this.titleRibbonRow);
            this.playButton = utl.createElement("div", {"class":"skin5-poster-play-button"}, this.playButtonCell, '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="36.813 0 22 22"><path d="M47.813,1.126c5.424,0,9.862,4.431,9.862,9.874s-4.438,9.873-9.862,9.873s-9.862-4.43-9.862-9.873 S42.39,1.126,47.813,1.126 M47.813,0c-6.069,0-11,4.918-11,11s4.931,11,11,11s11-4.918,11-11S53.883,0,47.813,0L47.813,0z"/><g class="medium-ring-arc"><clipPath id="medium-ring-clip-path"><path d="M47.813,1.126c5.424,0,9.862,4.431,9.862,9.874s-4.438,9.873-9.862,9.873s-9.862-4.43-9.862-9.873 S42.39,1.126,47.813,1.126 M47.813,0c-6.069,0-11,4.918-11,11s4.931,11,11,11s11-4.918,11-11S53.883,0,47.813,0L47.813,0z"/></clipPath><polygon points="36.813,0 36.813,22 47.813,11" fill="currentColor" clip-path="url(@func-iri-prefix#medium-ring-clip-path)"/></g></svg> ');
            this.titleCell = utl.createElement("div", null, this.titleRibbonRow);
            if (!this.hideDuration) {
                this.durationContainer = utl.createElement("div", {"class":"skin5-poster-duration-container"}, this.posterInnerContainer);
                if (utl.iPhoneOS()) {
                    this.durationContainer.style.bottom = "72px";
                }
            }
            this.setReplayMinimizedControls('<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 27.6 21.8"><path d="M4.6,0H2.3v2.3H0v2.3h4.6V0z M4.6,17.2H23V4.6H4.6V17.2z M8.1,8h11.4v5.8H8.1V8z M25.3,2.3V0H23v4.6h4.6V2.3 H25.3z M23,21.8h2.3v-2.3h2.3v-2.3H23V21.8z M0,19.5h2.3v2.3h2.3v-4.6H0V19.5z"/></svg>');
        }
        this.playIcon = utl.createElement("div", {"class":["skin5-poster-" + (this.isReplay ? "re" : "") + "play-icon", "poster-control"]}, this.playButton, this.isReplay ? '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 53.1 49.2"><path d="M24.5,49.1C11,49.1,0,38.1,0,24.6C0,11.1,11,0.1,24.5,0.1c11,0,20.8,7.4,23.7,18.1l0.1,0.2l0.1,0.2h4.7L45,26.6 l-8.1-8.1h5.6l-0.3-0.8C39.3,10.5,32.4,6,24.7,6C14.3,6,5.9,14.4,5.9,24.7c0,10.3,8.4,18.7,18.7,18.7c7.2,0,13.8-4.1,16.9-10.6 l4.2,4.1C41.3,44.4,33.2,49.1,24.5,49.1z"/></svg>' :
            '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 7 10"><path d="M0,9.5C0,9,0,0.9,0,0.6c0-0.4,0.3-0.7,0.7-0.5c0.3,0.2,5.6,4.1,6.1,4.4c0.3,0.2,0.3,0.7,0,1 C6.4,5.7,1.1,9.7,0.7,9.9C0.4,10.2,0,9.9,0,9.5z"/></svg>');
    }, bindListeners:function() {
        if (!this.showOnlyPlayButton) {
            vdb.events.EventContext.bind(window, "resize", function() {
                this.setTitleAndDuration();
            }.bind(this));
        }
        this._super();
    }, setTitle:function() {
        var titleRibbonTable = this.titleRibbonTable;
        var titleCell = this.titleCell;
        var titleCellHeight;
        var videoTitle = this.videoTitle;
        var insertTitle = function(fontSize, maxTextLines) {
            titleCell.innerHTML = "";
            titleCell.setAttribute("class", "skin5-poster-title-cell-" + fontSize + "-font");
            titleCellHeight = utl.getInnerHeight(titleCell);
            titleCell.setAttribute("style", "line-height: " + titleCellHeight / maxTextLines + "px;");
            titleCell.innerHTML = videoTitle;
        };
        titleRibbonTable.setAttribute("style", "visibility: hidden;");
        insertTitle("large", 1);
        if (utl.getInnerHeight(titleCell) > titleCellHeight) {
            insertTitle("medium", 2);
            if (utl.getInnerHeight(titleCell) > titleCellHeight) {
                insertTitle("small", 3);
                utl.truncateTextToFit(videoTitle, titleCell, titleCellHeight);
            }
        }
        titleCell.removeAttribute("style");
        titleRibbonTable.removeAttribute("style");
    }, setDuration:function() {
        if (this.durationContainer) {
            $.toggle(this.durationContainer, this.videoDuration);
            this.durationContainer.innerHTML = $.formatTime(this.videoDuration);
        }
    }};
}());
vdb.dom.embedCssToHead(".skin5-poster-title-ribbon{padding:0 24px;width:100%;height:100px;background-color:rgba(34,34,34,0.85);position:absolute;bottom:18px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;display:table}.skin5-poster-title-ribbon-table{display:table;height:100%;width:100%}.skin5-poster-title-ribbon-row{display:table-row}.skin5-poster-title-ribbon-row>div{display:table-cell;vertical-align:middle}.skin5-poster-play-button-cell{width:1px}.skin5-poster-title-cell-large-font,.skin5-poster-title-cell-medium-font,.skin5-poster-title-cell-small-font{max-width:450px;font-family:Arial;color:#d0d0d0;padding:15px 0 15px 15px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;position:relative}.skin5-poster-title-cell-large-font{font-size:28px}.skin5-poster-title-cell-medium-font{font-size:18px;line-height:22px}.skin5-poster-title-cell-small-font{padding-top:30px;font-size:15px;line-height:18px}.skin5-poster-duration-container{position:absolute;bottom:90px;left:112px;font:11px/11px Arial;color:#8e8f8d}.skin5-poster-corner-button{position:absolute;left:calc(50% - 32px);top:calc(50% - 32px)}.skin5-poster-play-button{width:65px;height:65px;border-radius:73px;background-color:rgba(0,0,0,0.85);padding:4px;position:relative}.skin5-poster-play-button.skin5-poster-resume-ad-button{position:absolute;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);-moz-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}.skin5-poster-play-icon{position:absolute;width:13px;height:21px;top:calc(50% - 10px);left:calc(50% - 5px)}.skin5-poster-replay-icon{position:absolute;width:36px;height:35px;top:calc(50% - 17px);left:calc(50% - 17px)}.skin5-poster-play-button .player-icon{fill:#d0d0d0}.skin5-poster-play-button .medium-ring-arc{display:none}.fullscreen-button-replay{width:40px;height:40px;margin-top:10px}.exit-fullscreen-icon-replay{display:block}");
vdb.coverings.covering.ResumeAdPoster = vdb.html5.player.poster.ResumeAdPoster.extend({addControls:function() {
    var resumeAdButton = vdb.Utils.createElement("div", {"class":["skin5-poster-play-button", "skin5-poster-resume-ad-button"]}, this.posterInnerContainer, '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="36.813 0 22 22"><path d="M47.813,1.126c5.424,0,9.862,4.431,9.862,9.874s-4.438,9.873-9.862,9.873s-9.862-4.43-9.862-9.873 S42.39,1.126,47.813,1.126 M47.813,0c-6.069,0-11,4.918-11,11s4.931,11,11,11s11-4.918,11-11S53.883,0,47.813,0L47.813,0z"/><g class="medium-ring-arc"><clipPath id="medium-ring-clip-path"><path d="M47.813,1.126c5.424,0,9.862,4.431,9.862,9.874s-4.438,9.873-9.862,9.873s-9.862-4.43-9.862-9.873 S42.39,1.126,47.813,1.126 M47.813,0c-6.069,0-11,4.918-11,11s4.931,11,11,11s11-4.918,11-11S53.883,0,47.813,0L47.813,0z"/></clipPath><polygon points="36.813,0 36.813,22 47.813,11" fill="currentColor" clip-path="url(@func-iri-prefix#medium-ring-clip-path)"/></g></svg> ');
    vdb.Utils.createElement("div", {"class":["skin5-poster-play-icon", "poster-control"]}, resumeAdButton, '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 7 10"><path d="M0,9.5C0,9,0,0.9,0,0.6c0-0.4,0.3-0.7,0.7-0.5c0.3,0.2,5.6,4.1,6.1,4.4c0.3,0.2,0.3,0.7,0,1 C6.4,5.7,1.1,9.7,0.7,9.9C0.4,10.2,0,9.9,0,9.5z"/></svg>');
}});
vdb.html5.player.poster.UnmuteOverlay = vdb.html5.player.poster.BasePoster.extend(function() {
    var PlayerEvent = vdb.constants.PlayerEvent;
    var initEvents = function() {
        var clickEvent = vdb.Utils.mobileOs() ? "touchend" : "click";
        this.eventGroup.addContext(vdb.events.EventContext.bind(this.posterOuterContainer, clickEvent, this.click.bind(this)));
        this.player.addEventListener(PlayerEvent.AD_VOLUME_CHANGED, onVolumeChange.bind(this));
        this.player.addEventListener(PlayerEvent.VIDEO_VOLUME_CHANGED, onVolumeChange.bind(this));
        this.player.dispatchEvent(PlayerEvent.HIDE_CONTROLS);
    };
    var buildOverlay = function() {
        var overlayUrl = this.controller.getContext().getUnmuteOverlayUrl();
        vdb.ajax.getWithPromise(overlayUrl).then(function(response) {
            this.posterInnerContainer.innerHTML = response.text;
            this.posterInnerContainer.style.fill = this.player.getControlsCustomColor();
        }.bind(this));
    };
    var onVolumeChange = function() {
        if (!this.player.controller.isMuted()) {
            this.remove();
        }
    };
    return{init:function(controller) {
        this.controller = controller;
        this._super(this.controller.getContainer());
        this.player = controller.getPlayer();
        buildOverlay.call(this);
        initEvents.call(this);
    }, click:function(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        this._super();
    }, posterAction:function() {
        this._super();
        this.remove();
        this.player.dispatchEvent(PlayerEvent.USER_INTERACTION, {"interactionType":vdb.enums.UserInteraction.UNMUTE_OVERLAY_CLICK});
    }};
}());
vdb.html5.player.PseudoFullscreenController = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var LOGGER = vdb.log.getLogger("PseudoFullscreenController");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var toggleFullscreen = function(onOff) {
        if (onOff == this.isFullscreen) {
            return;
        }
        if (typeof onOff === "undefined") {
            onOff = !this.isFullscreen;
        }
        if (onOff) {
            enterFullscreen.call(this);
        } else {
            exitFullscreen.call(this);
        }
    };
    var onResize = function() {
        if (this.isFullscreen) {
            setPlaceholderSize.call(this);
            setTimeout(function() {
                this._parentWin.scrollTo(0, 0);
            }.bind(this), 0);
            if (this.skin) {
                this.skin.updateProgressBar();
            }
        }
    };
    var disableScroll = function() {
        this._parentWin.ontouchstart = function(e) {
            e.preventDefault();
        };
        this._parentDoc.documentElement.style.overflow = "hidden";
        this._parentDoc.body.scroll = "no";
    };
    var enableScroll = function() {
        this._parentWin.ontouchstart = null;
        this._parentDoc.documentElement.style.overflow = "auto";
        this._parentDoc.body.scroll = "yes";
    };
    var setPlaceholderSize = function() {
        this.placeholderParent.style.width = this._parentWin.innerWidth + "px";
        this.placeholderParent.style.height = this._parentWin.innerHeight + "px";
    };
    var resetPlaceholderSize = function() {
        this.placeholderParent.style.width = this.placeholderParentStyle.width;
        this.placeholderParent.style.height = this.placeholderParentStyle.height;
    };
    var enterFullscreen = function() {
        LOGGER.debug("enterFullscreen");
        utl.addClass(this._parentDoc.body, "vdb-fullscreen-body");
        utl.addClass([this.videosContainer, this.container], "vdb-fullscreen");
        utl.addClass(this.placeholderElement, "vdb-fullscreen-placeholder");
        utl.addClass(this.placeholderParent, "vdb-fullscreen-placeholder-parent");
        this.skinPromise.then(function(skin) {
            this.skin = skin;
            this.controlsBarContainer = skin.controlsBarContainer;
            utl.addClass(this.controlsBarContainer, "vdb-fullscreen");
        }.bind(this));
        this.placeholderParentStyle = {width:this.placeholderParent.style.width, height:this.placeholderParent.style.height};
        this._parentWin.scrollTo(0, 0);
        setPlaceholderSize.call(this);
        disableScroll.call(this);
        this.player.dispatchEvent(PlayerEvent.ENTER_FULLSCREEN, {"userInitiated":true});
        this._parentWin.addEventListener("resize", this._onResizeHandler);
        this.scrollOffset = {x:this._parentWin.scrollX, y:this._parentWin.scrollY};
        this.isFullscreen = true;
    };
    var exitFullscreen = function() {
        LOGGER.debug("exitFullscreen");
        utl.removeClass(this._parentDoc.body, "vdb-fullscreen-body");
        utl.removeClass([this.videosContainer, this.controlsBarContainer, this.container], "vdb-fullscreen");
        utl.removeClass(this.placeholderElement, "vdb-fullscreen-placeholder");
        utl.removeClass(this.placeholderParent, "vdb-fullscreen-placeholder-parent");
        resetPlaceholderSize.call(this);
        enableScroll.call(this);
        this._context.api._resizeHandler && this._context.api._resizeHandler();
        this._parentWin.scrollTo(this.scrollOffset["x"], this.scrollOffset["y"]);
        this._parentWin.removeEventListener("resize", this._onResizeHandler);
        this.player.dispatchEvent(PlayerEvent.EXIT_FULLSCREEN, {"userInitiated":true});
        this.isFullscreen = false;
    };
    return{init:function(controller) {
        this._context = vdb["getContext"](vdb.ctx.id);
        this.player = controller.getPlayer();
        this.placeholderElement = this._context.api.getElement();
        if (this._context.isResponsive) {
            this.placeholderElement = this.placeholderElement.parentElement;
        }
        this.placeholderParent = this.placeholderElement.parentElement;
        this.videosContainer = this.player.videosContainer;
        this.container = this.player.container;
        this.skinPromise = controller.getSkin();
        this._onResizeHandler = onResize.bind(this);
        this._parentDoc = vdb.$doc;
        this._parentWin = vdb.$win;
        this.isFullscreen = false;
        var cssText = ".vdb-fullscreen-body{overflow:hidden!important}.vdb-fullscreen{width:100%!important;height:100%!important;padding:0!important;max-width:none!important;max-height:none!important}.vdb-fullscreen-placeholder-parent{width:100%;height:100%;max-width:none;max-height:none;position:fixed;top:0;left:0;background-color:black;z-index:999999}.vdb-fullscreen-placeholder{padding:0!important;max-width:none!important;max-height:none!important;position:absolute!important;height:100%!important;width:100%!important;bottom:0;left:0}";
        vdb.dom.embedCssToHead(cssText, this._parentDoc.head);
        vdb.dom.embedCssToHead(cssText);
    }, toggleFullscreen:toggleFullscreen};
}());
vdb.html5.player.SkinsManager = vdb.core.Class.extend(function() {
    var onComplete = function(success) {
        if (success && vdb.skins && vdb.skins[this.skinType]) {
            var skin = new vdb.skins[this.skinType](this.controller);
            vdb.html5.player.hasSkin = true;
            this.controller.getPlayer().dispatchEvent(vdb.constants.PlayerEvent.PLAYER_SKIN_READY, skin);
        }
    };
    return{init:function(controller) {
        this.controller = controller;
    }, loadSkin:function(skinType) {
        if (vdb.html5.player.hasSkin) {
            return;
        }
        var skinUrl = vdb.ctx.getCdnUrl("js/skins/%s.js".replace("%s", skinType)) + "?cb=" + vdb.ver();
        this.skinType = skinType;
        vdb.Utils.injectScript(document, "http://localhost:63342/player-skins-test/build/main.bundle.js", onComplete.bind(this));
    }};
}());
vdb.html5.player.Spinner = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var $ = vdb.utils.Common;
    return{init:function(player) {
        this.container = player.container;
        this.spinner = utl.createElement("div", {"class":"player-spinner"}, this.container, utl.setFuncIRIPrefix('<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 66 66"><linearGradient id="thin-spinner-gradient" gradientUnits="userSpaceOnUse" x1="55.6484" y1="14.5625" x2="-28.5724" y2="85.2322" gradientTransform="matrix(0 1 1.5 .1 0 -2)"><stop offset="0" stop-color="currentColor" stop-opacity="1"/><stop offset="0.5" stop-color="currentColor" stop-opacity="0"/></linearGradient><path id="thin-spinner-path" fill="url(@func-iri-prefix#thin-spinner-gradient)" d="M-0.014,33c0,18.193,14.813,32.992,33.006,32.992 C51.188,65.992,66,51.193,66,33C66,14.809,51.188,0.008,32.992,0.008C14.799,0.008-0.014,14.809-0.014,33z M61.986,33 c0,15.996-13.006,29.01-28.992,29.01S4.002,48.996,4.002,33S17.008,3.99,32.994,3.99S61.986,17.004,61.986,33z"/><clipPath id="thin-spinner-clip-path"><use xlink:href="@func-iri-prefix#thin-spinner-path"/></clipPath><rect x="0" y="0" clip-path="url(@func-iri-prefix#thin-spinner-clip-path)" fill="currentColor" width="33" height="66"/></svg>'));
        this.visible = true;
    }, show:function() {
        if (!this.visible) {
            $.show(this.spinner);
            this.visible = true;
        }
    }, hide:function() {
        if (this.visible) {
            $.hide(this.spinner);
            this.visible = false;
        }
    }};
}());
vdb.html5.player.TimeParamManager = vdb.core.Class.extend(function() {
    function isMatchingUrl() {
        var regex = /.*aol\.com\/.*/g;
        var url = vdb.utils.WindowUtil.getTopMostLocation();
        if (url && regex.test(url)) {
            return true;
        }
        return false;
    }
    function getTimeParamValue(timeParamValue) {
        try {
            if (timeParamValue === "") {
                return undefined;
            } else {
                if (isNaN(timeParamValue)) {
                    return getSecondsFromHourMinSec(timeParamValue);
                }
            }
            return parseInt(timeParamValue);
        } catch (e) {
            LOGGER.debug('Error while parsing "t" param', e);
        }
    }
    function getSecondsFromHourMinSec(timeParamValue) {
        var totalSeconds;
        if (timeParamValue.indexOf("h") !== -1) {
            totalSeconds = parseInt(timeParamValue.substring(0, timeParamValue.indexOf("h"))) * 3600;
            timeParamValue = timeParamValue.substring(timeParamValue.indexOf("h") + 1);
        }
        if (timeParamValue.indexOf("m") !== -1) {
            totalSeconds = getTotal(totalSeconds, parseInt(timeParamValue.substring(0, timeParamValue.indexOf("m"))) * 60);
            timeParamValue = timeParamValue.substring(timeParamValue.indexOf("m") + 1);
        }
        if (timeParamValue.indexOf("s") !== -1) {
            totalSeconds = getTotal(totalSeconds, parseInt(timeParamValue.substring(0, timeParamValue.indexOf("s"))));
        }
        return totalSeconds;
    }
    function getTotal(currentTotal, value) {
        if (currentTotal) {
            return currentTotal + value;
        }
        return value;
    }
    var LOGGER = vdb.log.getLogger("TimeParamManager");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var urlUtils = vdb.utils.UrlUtils;
    var init = function(player) {
        LOGGER.debug("init");
        var eventFunction = function(event) {
            var videoDuration = Math.floor(event.data.duration);
            var timeParamValue = getTimeParamValue(urlUtils.getParameterByName("t"));
            if (timeParamValue && videoDuration && timeParamValue < videoDuration && isMatchingUrl()) {
                player.controller.seekTo(timeParamValue);
            }
            player.removeEventListener(PlayerEvent.VIDEO_META, eventFunction);
        };
        player.addEventListener(PlayerEvent.VIDEO_META, eventFunction);
    };
    return{init:init};
}());
vdb.html5.player.video = {};
vdb.html5.player.video.module = {};
vdb.html5.player.video.module.VideoAreaModule = vdb.EventBus.extend(function() {
    var loadResource = function() {
        var self = this;
        if (this._libName) {
            this._promise = vdb.dom.loadScript(vdb.ctx.getCdnUrl("js/lib/" + self._libName)).then(this.prepareModule.bind(this));
        } else {
            this._promise = vdb.Promise.resolve();
        }
        return this._promise;
    };
    return{_promise:null, init:function(element) {
        this._super();
        this._element = element;
    }, prepareModule:function() {
    }, load:function() {
        if (this._promise) {
            return this._promise;
        }
        return loadResource.call(this);
    }, setVideo:function(video) {
    }, play:function() {
        this._element.play();
    }, pause:function() {
        this._element.pause();
    }, detach:function() {
        if (vdb.ctx.vrPlayer) {
            vdb.ctx.vrPlayer["destroy"]();
            delete vdb.ctx.vrPlayer;
        }
    }, videoError:function(code) {
        this.dispatchEvent(vdb.html5.player.video.module.VideoAreaModule.VIDEO_ERROR, {code:code});
    }, videoClick:function() {
        this.dispatchEvent(vdb.html5.player.video.module.VideoAreaModule.VIDEO_CLICK);
    }, finishVideo:function() {
        this.dispatchEvent(vdb.html5.player.video.module.VideoAreaModule.FINISH_VIDEO);
    }, isPlayVideo:function() {
    }, touch:function() {
    }};
}());
vdb.html5.player.video.module.VideoAreaModule.VIDEO_ERROR = "VideoAreaModule.VIDEO_ERROR";
vdb.html5.player.video.module.VideoAreaModule.VIDEO_CLICK = "VideoAreaModule.VIDEO_CLICK";
vdb.html5.player.video.module.VideoAreaModule.FINISH_VIDEO = "VideoAreaModule.FINISH_VIDEO";
vdb.html5.player.video.module.BaseModule360 = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    var ec = vdb.events.EventContext;
    var Event360 = vdb.html5.events.Event360;
    var Control360Type = vdb.html5.enums.Control360Type;
    var THREE_SIXTY_SCROLL_ACTION = "360_scroll";
    var onPress = function(type) {
        this._moved = false;
        this._movedHandler = ec.bindOnce(vdb.ctx, Event360.MOVED, onMoved.bind(this, type));
    };
    var onRelease = function(type) {
        if (!this._moved) {
            if (this._movedHandler) {
                this._movedHandler.unbind();
            }
            if (type === Control360Type.VIDEO) {
                this.videoClick();
            }
        }
    };
    var onMoved = function(type) {
        this._moved = true;
        this._tracker.action(THREE_SIXTY_SCROLL_ACTION, null, this.getCurrentTime(), null, null, {_title:type});
    };
    return{init:function(element) {
        this._super(element);
        this._tracker = vdb.ctx.ctx.createBasicTracker();
        this._eventContext = ec.empty();
    }, bindEvents:function() {
        ec.bind(vdb.ctx, Event360.VIDEO_PRESS, onPress.bind(this, Control360Type.VIDEO)).link(this._eventContext);
        ec.bind(vdb.ctx, Event360.VIDEO_RELEASE, onRelease.bind(this, Control360Type.VIDEO)).link(this._eventContext);
        ec.bind(vdb.ctx, Event360.COMPASS_PRESS, onPress.bind(this, Control360Type.COMPASS)).link(this._eventContext);
        ec.bind(vdb.ctx, Event360.COMPASS_RELEASE, onRelease.bind(this, Control360Type.COMPASS)).link(this._eventContext);
    }, getCurrentTime:function() {
        return this._element.currentTime || 0;
    }, detach:function() {
        this._super();
        this._eventContext.unbind();
    }};
}());
vdb.html5.player.video.module.DashModule = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    var LOGGER = vdb.log.getLogger("DashModule");
    return{init:function(element) {
        LOGGER.debug("init");
        this._super(element);
        this._libName = "dash.all.js";
    }, prepareModule:function() {
        this._super();
        var context = new window["Dash"]["di"]["DashContext"];
        this._player = new window["MediaPlayer"](context);
        context["debug"]["setLogToBrowserConsole"](false);
        this._player["startup"]();
    }, setVideo:function(video) {
        this._player["attachView"](this._element);
        this._player["attachSource"](video.urlToPlay);
        return new vdb.Promise(function(resolve) {
            resolve();
        }.bind(this));
    }, detach:function() {
        this._super();
        this._player["reset"]();
    }};
}());
vdb.html5.player.video.module.DashModule.isRequired = function(video) {
    if (!video || !video.urlToPlay) {
        return false;
    }
    var browser = vdb.Utils.browser;
    var browserSupportsDash = !(browser.isIos() || browser["safari"] || vdb.Utils.isIE);
    return browserSupportsDash && video.urlToPlay.indexOf(".mpd") !== -1;
};
vdb.html5.player.video.module.DashModule.isPlayVideo = true;
vdb.html5.player.video.module.EnvrmntModule360 = vdb.html5.player.video.module.BaseModule360.extend(function() {
    var LOGGER = vdb.log.getLogger("EnvrmntModule360");
    var $ = vdb.utils.Common;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var Event360 = vdb.html5.events.Event360;
    var ec = vdb.events.EventContext;
    var PLAYER_ID = "envrmnt-360-player";
    var AXIS = Math.PI / 2;
    var onLoaded = function() {
        var duration = this.getDuration();
        if (this.envrmntPlayer["hasUnmuteOverlay"]()) {
            this._player.dispatchEvent(PlayerEvent.HIDE_CONTROLS);
        }
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_LOAD);
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_METADATA, {durationWithoutAds:duration, duration:duration, playbackRate:this.envrmntPlayer["getPlaybackRate"](), width:this._container.clientWidth, height:this._container.clientHeight});
        this._readyFuture.resolve();
    };
    var onPlayerReady = function(player) {
        LOGGER.debug("onPlayerReady", player);
        this.envrmntPlayer = player;
        this.bindEvents();
        onLoaded.call(this);
    };
    var loadIsolatedEnvrmnt = function() {
        this.moduleLoader = (new vdb.modules.ModuleLoader({container:this._container, scriptUrls:"https://stg-watch.envrmnt.com/kelvin/client/libs/kelvin-api.js", initFuncName:["ENVRMNT", "createPlayer"]})).appendHtml('<div id="' + PLAYER_ID + '" style="width: 100%; height: 100%;"></div>').setIsolated(true).setStyle("width: 100%; height: 100%; position: absolute; top: 0; left: 0; border: 0;").load(function(iwin) {
            var ENVRMNT = iwin["ENVRMNT"];
            this.EnvrmntPlayerEvent = ENVRMNT["PlayerEvent"];
            ENVRMNT["createPlayer"](this.playerConfig, "#" + PLAYER_ID).then(onPlayerReady.bind(this));
        }.bind(this));
    };
    var dispatchContainerEvent = function(eventName) {
        var event = this._container.ownerDocument.createEvent("Events");
        event.initEvent(eventName, true, true);
        this._container.dispatchEvent(event);
    };
    var dispatchDocumentEvent = function(eventName) {
        var doc = this._container.ownerDocument;
        var event = doc.createEvent("Events");
        event.initEvent(eventName, true, true);
        doc.dispatchEvent(event);
    };
    var onStart = function() {
        this._started = true;
        this._paused = false;
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_STARTED, {duration:this.getDuration()});
    };
    var onWaiting = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_WAITING);
    };
    var onTimeUpdate = function() {
        var duration = this.getDuration();
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_TIMEUPDATE, {currentTime:this.getCurrentTime(), buffered:this.envrmntPlayer["getBuffered"](), duration:duration, durationWithoutAds:duration});
    };
    var onProgress = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_PROGRESS, {waiting:this.envrmntPlayer["getReadyState"](), buffered:this.envrmntPlayer["getBuffered"](), duration:this.getDuration()});
    };
    var onPlaying = function() {
        if (this._paused) {
            this._paused = false;
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_RESUME, {duration:this.getDuration()});
        } else {
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_PLAY, {duration:this.getDuration()});
        }
    };
    var onPause = function() {
        this._paused = !this.envrmntPlayer["isEnded"]();
        if (this._paused) {
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_PAUSE);
        }
    };
    var onSeeking = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_SEEKSTART, {currentTime:this.getCurrentTime()});
    };
    var onSeeked = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_SEEKEND);
    };
    var onVolumeChange = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_VOLUME_CHANGED, {muted:this.muted(), volume:this.getVolume()});
    };
    var onEnd = function() {
        this._started = false;
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_END, {currentTime:this.getCurrentTime(), complete:true});
    };
    var onError = function(e) {
        this._videoArea.reportError.call(this._videoArea, e["code"], e["message"], true);
    };
    var onUnmuteOverlayClick = function() {
        this._player.dispatchEvent(PlayerEvent.USER_INTERACTION, {"interactionType":vdb.enums.UserInteraction.UNMUTE_OVERLAY_CLICK});
    };
    var onMouseDown = function() {
        vdb.ctx.dispatchEvent(Event360.VIDEO_PRESS);
    };
    var onMouseEnter = function() {
        dispatchContainerEvent.call(this, "mouseover");
        this._videoArea.dispatchEvent(vdb.html5.player.MOUSE_OVER_VIDEO);
    };
    var onMouseLeave = function() {
        dispatchDocumentEvent.call(this, "mouseout");
    };
    var onMouseMove = function() {
        dispatchContainerEvent.call(this, "mousemove");
    };
    var onMouseUp = function() {
        dispatchDocumentEvent.call(this, "mouseup");
        vdb.ctx.dispatchEvent(Event360.VIDEO_RELEASE);
    };
    var onTouchEnd = function() {
        dispatchDocumentEvent.call(this, "touchend");
        vdb.ctx.dispatchEvent(Event360.VIDEO_RELEASE);
    };
    var onTouchStart = function() {
        dispatchContainerEvent.call(this, "touchstart");
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_TOUCH_START);
        vdb.ctx.dispatchEvent(Event360.VIDEO_PRESS);
    };
    var onCameraRotation = function(e) {
        var y = e["y"];
        var r = Math.abs(y) % (2 * Math.PI);
        var t = r > Math.PI ? r - 2 * Math.PI : r;
        var theta = y < 0 ? -t : t;
        vdb.ctx.vrPlayer["rotateCompass"](theta);
        vdb.ctx.dispatchEvent(Event360.MOVED);
    };
    return{init:function(element, videoArea) {
        LOGGER.debug("init");
        this._super(element);
        this._container = element.parentNode;
        this._videoArea = videoArea;
        this._player = vdb.ctx["getPlayer"]().player;
        this._started = false;
    }, bindEvents:function() {
        var VrEvents = vdb["vr"]["Events"];
        new vdb.html5.player.VrEventProxy(vdb.ctx.vrPlayer, this._eventContext);
        ec.bind(vdb.ctx.vrPlayer, VrEvents["MOVE"], this.rotateCamera.bind(this)).link(this._eventContext);
        ec.bind(vdb.ctx.vrPlayer, VrEvents["RESET"], this.resetCamera.bind(this)).link(this._eventContext);
        ec.bind(vdb.ctx, PlayerEvent.TOGGLE_STEREOSCOPIC, this.toggleStereoscopic.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["CAMERA_ROTATION"], onCameraRotation.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["ERROR"], onError.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["UNMUTE_OVERLAY_CLICK"], onUnmuteOverlayClick.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_ABORT"], onEnd.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_ENDED"], onEnd.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_MOUSEDOWN"], onMouseDown.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_MOUSEENTER"], onMouseEnter.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_MOUSELEAVE"], onMouseLeave.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_MOUSEMOVE"], onMouseMove.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_MOUSEUP"], onMouseUp.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_PAUSE"], onPause.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_PLAYING"], onPlaying.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_PROGRESS"], onProgress.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_SEEKED"], onSeeked.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_SEEKING"], onSeeking.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_TIMEUPDATE"], onTimeUpdate.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_TOUCHEND"], onTouchEnd.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_TOUCHSTART"], onTouchStart.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_VOLUMECHANGE"], onVolumeChange.bind(this)).link(this._eventContext);
        ec.bind(this.envrmntPlayer, this.EnvrmntPlayerEvent["VIDEO_WAITING"], onWaiting.bind(this)).link(this._eventContext);
        this._super();
    }, setVideo:function(video) {
        var customColor = this._player.getControlsCustomColor();
        var unmuteOverlayUrl = vdb.ctx.getUnmuteOverlayUrl();
        this.playerConfig = {"autoplay":false, "mute":this._element.muted, "volume":this._element.volume, "unmuteOverlay":{"fill":customColor, "url":unmuteOverlayUrl}, "uuid":video.externalId};
        LOGGER.debug("setVideo", this.playerConfig);
        vdb.ctx.vrPlayer = new vdb["vr"]["Player"]({"container":this._container, "panel":{"customColor":customColor}});
        this._originalElementPlay = this._element.play;
        this._element.play = function() {
        };
        $.hide(this._element);
        this._readyFuture = new vdb.Future;
        loadIsolatedEnvrmnt.call(this);
        return this._readyFuture.getPromise();
    }, play:function() {
        if (this.envrmntPlayer) {
            this.envrmntPlayer["play"]();
            if (!this._started) {
                onStart.call(this);
            }
        }
    }, pause:function() {
        if (this.envrmntPlayer) {
            this.envrmntPlayer["pause"]();
        }
    }, mute:function(mute) {
        if (this.envrmntPlayer) {
            this.envrmntPlayer[mute ? "mute" : "unmute"]();
        }
    }, seek:function(position) {
        if (this.envrmntPlayer) {
            this.envrmntPlayer["seekTo"](position);
        }
    }, rotateCamera:function(e) {
        if (this.envrmntPlayer) {
            var currentCameraRotation = this.envrmntPlayer["getCameraRotation"]();
            var x = Math.max(Math.min(currentCameraRotation["x"] - e.data.y / 60, AXIS), AXIS * -1);
            var y = currentCameraRotation["y"] - e.data.x / 60;
            this.envrmntPlayer["setCamera"](x, y, 0);
        }
    }, resetCamera:function() {
        if (this.envrmntPlayer) {
            this.envrmntPlayer["resetCamera"]();
        }
    }, toggleStereoscopic:function() {
        if (this.envrmntPlayer) {
            this.envrmntPlayer["toggleVR"]();
        }
    }, isStarted:function() {
        return this._started;
    }, isPlaying:function() {
        return this._started && !this._paused;
    }, getCurrentTime:function() {
        var currentTime = 0;
        if (this.envrmntPlayer) {
            currentTime = this.envrmntPlayer["getCurrentTime"]() || 0;
        }
        return currentTime;
    }, getDuration:function() {
        var duration = 0;
        if (this.envrmntPlayer) {
            duration = this.envrmntPlayer["getDuration"]() || 0;
        }
        return duration;
    }, setVolume:function(volume) {
        if (this.envrmntPlayer) {
            this.envrmntPlayer["setVolume"](Math.round(volume * 100) / 100);
        }
    }, getVolume:function() {
        var volume = 0;
        if (this.envrmntPlayer) {
            volume = this.envrmntPlayer["getVolume"]() || 0;
        }
        return volume;
    }, muted:function() {
        var isMuted = false;
        if (this.envrmntPlayer) {
            isMuted = this.envrmntPlayer["isMuted"]() || !this.getVolume();
        }
        return isMuted;
    }, detach:function() {
        LOGGER.debug("detach");
        this._super();
        this._started = false;
        this.moduleLoader.dispose();
        this._element.play = this._originalElementPlay;
        $.show(this._element);
    }};
}());
vdb.html5.player.video.module.EnvrmntModule360.isRequired = function(video) {
    return!!video && !!video.data360 && vdb.ctx.vrRenderer === vdb.enums.VrRendererType.ENVRMNT && !vdb.ctx.video360Error;
};
vdb.html5.player.video.module.EnvrmntModule360.isPlayVideo = true;
vdb.html5.player.video.module.ErrorModule360 = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    var LOGGER = vdb.log.getLogger("ErrorModule360");
    return{init:function(element) {
        LOGGER.debug("init");
        this._super(element);
    }, play:function() {
    }, pause:function() {
    }, setVideo:function() {
        var api = vdb.ctx["getPlayer"]();
        var customColor = api && api.player && api.player.getControlsCustomColor();
        LOGGER.debug("setVideo");
        vdb.ctx.vrPlayer = new vdb["vr"]["Player"]({"container":this._element.parentNode, "panel":{"customColor":customColor}});
        return vdb.Promise.resolve();
    }, detach:function() {
        LOGGER.debug("detach");
        this._super();
    }};
}());
vdb.html5.player.video.module.ErrorModule360.isRequired = function(video) {
    return!!(video && video.data360 && vdb.ctx.video360Error);
};
vdb.html5.player.video.module.ErrorModule360.isPlayVideo = false;
vdb.html5.player.video.module.OathHLSModule = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    var LOGGER = vdb.log.getLogger("OathHLSModule");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var _onWaiting = function(event) {
        var flag = event && event.detail && event.detail.value;
        if (typeof flag !== "undefined") {
            if (flag) {
                this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_BUFFERING_START);
            } else {
                this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_BUFFERING_END);
            }
        }
    };
    var _onStreamSwitched = function(event) {
        LOGGER.debug(event["type"], event["detail"]);
    };
    var _onStreamUpdated = function(event) {
        var type = event["type"];
        var detail = event["detail"];
        var stream = detail && detail["stream"];
        LOGGER.debug(type, detail);
        if (stream) {
            vdb.ctx.dispatchEvent(PlayerEvent.BITRATE_UPDATE, {bitrate:stream["bitrate"]});
        }
    };
    return{init:function(element, videoArea) {
        this._super(element);
        this._videoArea = videoArea;
        LOGGER.debug("init()");
        if (!window["JsHls"]) {
            this._libName = "oath.hls.min.js";
        }
    }, prepareModule:function() {
        this._super();
    }, setVideo:function(video) {
        LOGGER.debug("setVideo()", video);
        if (this._hls) {
            this.detach();
            LOGGER.error("Go to next video w/o detach call");
        }
        this._hls = new window["JsHls"](this._element);
        this._element.addEventListener("streamSwitched", _onStreamSwitched.bind(this));
        this._element.addEventListener("streamUpdated", _onStreamUpdated.bind(this));
        this._element.addEventListener("hlsWaiting", _onWaiting.bind(this));
        this._hls["setSrc"]({"url":video.urlToPlay});
        this._hls["play"]();
        return vdb.Promise.resolve();
    }, detach:function() {
        this._super();
        if (this._hls) {
            this._hls["unload"]();
            this._hls["destroy"]();
            this._hls = null;
        }
    }};
}());
vdb.html5.player.video.module.OathHLSModule.hlsSupportedByBrowser = function() {
    return vdb.utils.Common.isHlsSupported();
};
vdb.html5.player.video.module.OathHLSModule.isSupported = function() {
    return vdb.utils.UrlUtils.getParameterByName("oathHlsJs", vdb.utils.WindowUtil.getTopMostLocation()) || vdb.ctx.getMacro(vdb.constants.PlayerMacros.OATH_HLS_JS);
};
vdb.html5.player.video.module.OathHLSModule.isRequired = function(video) {
    return video && video.urlToPlay && video.urlToPlay.indexOf(".m3u8") !== -1 && vdb.Utils.hlsPluginSupported() && vdb.html5.player.video.module.OathHLSModule.isSupported();
};
vdb.html5.player.video.module.OathHLSModule.isPlayVideo = true;
vdb.html5.player.video.module.HLSModule = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    var LOGGER = vdb.log.getLogger("HLSModule");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var onError = function(event, data) {
        var errorType = data["type"];
        var errorDetails = data["details"];
        var errorFatal = data["fatal"];
        LOGGER.debug("Stream error ", errorType, errorDetails, errorFatal);
        if (this._recoveryInProgress) {
            this.videoError(MediaError.MEDIA_ERR_DECODE);
            return;
        }
        this._recoveryInProgress = false;
        if (errorFatal) {
            switch(data.type) {
                case window["Hls"]["ErrorTypes"]["NETWORK_ERROR"]:
                    LOGGER.debug("fatal network error encountered, try to recover");
                    this._hls["startLoad"]();
                    if (this._hls["streamController"]["state"] === "STOPPED") {
                        this.videoError(MediaError.MEDIA_ERR_DECODE);
                    } else {
                        this._recoveryInProgress = true;
                    }
                    break;
                case window["Hls"]["ErrorTypes"]["MEDIA_ERROR"]:
                    LOGGER.debug("fatal media error encountered, try to recover");
                    this._recoveryInProgress = true;
                    this._hls["recoverMediaError"]();
                    break;
                default:
                    this.videoError(MediaError.MEDIA_ERR_DECODE);
                    break;
            }
        } else {
            if (errorDetails === window["Hls"]["ErrorDetails"]["BUFFER_STALLED_ERROR"] && this._hls["streamController"]["state"] === "ENDED") {
                this.videoError(MediaError.MEDIA_ERR_NETWORK);
            }
        }
    };
    var onManifestLoaded = function(event, data) {
        LOGGER.debug(event, data);
        vdb.ctx.dispatchEvent(PlayerEvent.MANIFEST_LOADED, data);
        this._levels = data && data["levels"];
    };
    var onLevelLoaded = function(event, data) {
        LOGGER.debug(event, data);
        vdb.ctx.dispatchEvent(PlayerEvent.LEVEL_LOADED, data);
        if (this._levels && this._levels.length > 0 && data && data["level"]) {
            vdb.ctx.dispatchEvent(PlayerEvent.BITRATE_UPDATE, {bitrate:this._levels[data["level"]]["bitrate"]});
        }
    };
    var onFragChanged = function(event, data) {
        LOGGER.debug(event, data);
        var level = data["frag"] && data["frag"]["level"];
        if (level && this._level !== level) {
            var levelObj = this._hls["levels"][level];
            var mediaUrl = levelObj && levelObj["url"][0];
            this._level = level;
            vdb.ctx.dispatchEvent(PlayerEvent.LEVEL_SWITCHED, {"level":level, "url":mediaUrl});
        }
    };
    return{init:function(element) {
        this._super(element);
        LOGGER.debug("init()");
        this._recoveryInProgress = false;
        if (!window["Hls"]) {
            this._libName = "hls.min.js";
        }
    }, prepareModule:function() {
        this._super();
    }, setVideo:function(video) {
        LOGGER.debug("setVideo()", video);
        this._recoveryInProgress = false;
        if (this._hls) {
            this.detach();
            LOGGER.error("Go to next video w/o detach call");
        }
        this._hls = new window["Hls"];
        this._hls["on"](window["Hls"]["Events"]["ERROR"], onError.bind(this));
        this._hls["on"](window["Hls"]["Events"]["MANIFEST_LOADED"], onManifestLoaded.bind(this));
        this._hls["on"](window["Hls"]["Events"]["LEVEL_LOADED"], onLevelLoaded.bind(this));
        this._hls["on"](window["Hls"]["Events"]["FRAG_CHANGED"], onFragChanged.bind(this));
        vdb.ctx.playerAPI.dispatchEvent(new vdb.events.Event(PlayerEvent.VIDEO_MODULE_CREATED, {"hls":this._hls}));
        vdb.html5.player.video.module.HLSModule.hls = this._hls;
        return new vdb.Promise(function(resolve) {
            this._hls["loadSource"](video.urlToPlay);
            this._hls["attachMedia"](this._element);
            this._level = this._hls["currentLevel"];
            this._hls["on"](window["Hls"]["Events"]["MANIFEST_PARSED"], resolve);
        }.bind(this));
    }, detach:function() {
        this._super();
        this._recoveryInProgress = false;
        if (this._hls) {
            this._hls["destroy"]();
            this._hls = null;
        }
    }};
}());
vdb.html5.player.video.module.HLSModule.hlsSupportedByBrowser = function() {
    return vdb.utils.Common.isHlsSupported();
};
vdb.html5.player.video.module.HLSModule.isSupported = function() {
    return typeof window["Hls"] !== "undefined" && window["Hls"].isSupported() || vdb.html5.player.video.module.HLSModule.hlsSupportedByBrowser();
};
vdb.html5.player.video.module.HLSModule.isRequired = function(video) {
    return video && video.urlToPlay && video.urlToPlay.indexOf(".m3u8") !== -1 && !vdb.html5.player.video.module.HLSModule.hlsSupportedByBrowser() && vdb.Utils.hlsPluginSupported() && !vdb.html5.player.video.module.OathHLSModule.isSupported();
};
vdb.html5.player.video.module.HLSModule.isPlayVideo = true;
vdb.html5.player.video.module.YoutubeModule = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    function onPlayerError(event) {
        LOGGER.error("Player error:" + event.data);
        if (this._readyFuture) {
            this._readyFuture.reject();
        }
    }
    function setMainArea() {
        var display = vdb.html5.player.Display.getInstance();
        this._contentArea = display.getMainArea();
    }
    function fireContentVideoEvent(playerEventType, eventData) {
        var firstVideo = this.bid.getVideo(0);
        if (!firstVideo) {
            return;
        }
        eventData = eventData || {};
        eventData["id"] = firstVideo["id"];
        eventData["name"] = eventData["name"] || firstVideo["title"];
        eventData["url"] = this._ytPlayer["getVideoUrl"]();
        vdb.ctx.api.getAdapterPromise().then(function(adapter) {
            adapter.dispatchEvent({type:playerEventType, data:eventData});
        });
    }
    function onPlayerReady() {
        setMainArea.call(this);
        this._playerReady = true;
        this.bid = new vdb.model.Bid(vdb.ctx.api.bid);
        if (!this._video) {
            this._video = this.bid.getCurrentVideo();
            this._ytPlayer["cueVideoById"](this._video.externalId);
        } else {
            this.setVideo(this._video);
        }
        this._ytPlayer["setSize"]("100%", "100%");
        this.setVolume(this._volume);
        this.mute(this._muted);
        document.getElementById(this._iframeId).removeAttribute("allowfullscreen");
        this.tracker = vdb.ctx.ctx.createBasicTracker();
        this.tracker.display({width:this._ytContainer.offsetWidth, height:this._ytContainer.offsetHeight});
        this._readyFuture.resolve();
        vdb.ctx.playerAPI.dispatchEvent(new vdb.events.Event(vdb.constants.PlayerEvent.VIDEO_MODULE_CREATED));
    }
    function startTimeUpdate() {
        this._timeUpdateInterval = setInterval(function() {
            var currentTime = this.getCurrentTime();
            if (currentTime !== this._oldCurrentTime) {
                this._oldCurrentTime = currentTime;
                this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_TIMEUPDATE, {currentTime:currentTime, duration:this.getDuration(), buffered:this._element.buffered, durationWithoutAds:this.getDuration()});
            }
        }.bind(this), 500);
    }
    function fillMetadata() {
        this._video.metadata["duration"] = this._ytPlayer["getDuration"]() * 1E3;
    }
    function onVideoStart() {
        var poster = this.player.controller.getPoster();
        if (poster) {
            poster.posterAction();
        } else {
            this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_LOAD);
            this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_METADATA, {durationWithoutAds:this.getDuration(), duration:this.getDuration(), playbackRate:this.getPlaybackRate(), width:this._ytContainer.offsetWidth, height:this._ytContainer.offsetHeight});
            this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_STARTED, {duration:this.getDuration()});
            startTimeUpdate.call(this);
            fillMetadata.call(this);
            fireContentVideoEvent.call(this, "youtubevideoselected", {"videoId":this._video["id"], "name":this._video["title"], "overlayURL":this._video.metadata["overlayUrl"] || "", "duration":this.getDuration()});
        }
    }
    function onPlayerStateChange(event) {
        switch(event.data) {
            case window["YT"]["PlayerState"]["PLAYING"]:
                if (!this._started) {
                    this._started = true;
                    this._ended = false;
                    onVideoStart.call(this);
                }
                if (this._paused) {
                    this._paused = false;
                    this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_RESUME, {duration:this.getDuration()});
                } else {
                    this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_PLAY, {duration:this.getDuration()});
                }
                this.tracker.action("play", undefined, this._ytPlayer["getDuration"]());
                break;
            case window["YT"]["PlayerState"]["ENDED"]:
                this._ended = true;
                this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_END, {currentTime:this.getCurrentTime(), complete:true});
                this._ytContainer.style.zIndex = "9";
                break;
            case window["YT"]["PlayerState"]["PAUSED"]:
                this._paused = true;
                this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_PAUSE);
                break;
            case window["YT"]["PlayerState"]["BUFFERING"]:
                break;
            case window["YT"]["PlayerState"]["CUED"]:
                break;
            default:
                LOGGER.info("YouTube event.data:", event.data);
        }
    }
    function onVolumeChange() {
        if (!this._contentArea) {
            setMainArea.call(this);
        }
        this._contentArea.dispatchEvent(vdb.html5.player.VIDEO_VOLUME_CHANGED, {muted:this._muted, volume:this._volume});
    }
    var LOGGER = vdb.log.getLogger("YoutubeModule");
    var YT_BASE_ELEMENT_ID = "vdb-youtube-player-";
    var YT_IFRAME_API_SRC = "https://www.youtube.com/iframe_api";
    var VIDEO_ID_REG_EXP = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|\?v=)([^#\u200c\u200b\&\?]*).*/;
    return{init:function(element, videoArea, config) {
        this._super(element);
        this._iframeId = YT_BASE_ELEMENT_ID + vdb.ctx.id;
        this._videosContainer = document.getElementById("videos-container");
        this._readyFuture = new vdb.Future;
        this._ytContainer = document.createElement("div");
        this._ytContainer.setAttribute("id", "youtubeContainer");
        this._ytContainer.style.width = "100%";
        this._ytContainer.style.height = "100%";
        this._ytContainer.style.position = "absolute";
        this._ytContainer.style.zIndex = "9";
        this._videosContainer.insertBefore(this._ytContainer, this._videosContainer.firstChild);
        this._originalElementZIndex = element.style.zIndex;
        element.style.zIndex = "-1000";
        var divForIframe = document.createElement("div");
        divForIframe.setAttribute("id", this._iframeId);
        this._ytContainer.appendChild(divForIframe);
        var ytTag = document.createElement("script");
        ytTag.src = config ? config.ytIframeApiSrc : YT_IFRAME_API_SRC;
        this._ytContainer.insertBefore(ytTag, this._ytContainer.firstChild);
        var initialisePlayer = function() {
            this._ytPlayer = new window["YT"]["Player"](this._iframeId, {"height":element.clientHeight, "width":element.clientWidth, "playerVars":{"controls":0}, "events":{"onReady":onPlayerReady.bind(this), "onStateChange":onPlayerStateChange.bind(this), "onError":onPlayerError.bind(this)}});
            this.player = vdb.ctx.playerAPI.player;
        }.bind(this);
        if (window["YT"] && window["YT"]["Player"]) {
            initialisePlayer();
        } else {
            window["onYouTubeIframeAPIReady"] = initialisePlayer;
        }
    }, setVideo:function(video) {
        this._video = video;
        if (this._playerReady) {
            this._ytContainer.style.zIndex = "4";
            this._ytContainer.style.display = "";
            var url = this._ytPlayer["getVideoUrl"]();
            var match = url && url.match(VIDEO_ID_REG_EXP);
            var currentId = match && match[2];
            if (currentId !== this._video.externalId || this._ended) {
                this._ytPlayer["cueVideoById"](this._video.externalId);
            } else {
                onVideoStart.call(this);
            }
            this._element.style.zIndex = "-1000";
        }
        return this._readyFuture.getPromise();
    }, detach:function() {
        this._super();
        this._ytContainer.style.zIndex = "9";
        this._element.style.zIndex = this._originalElementZIndex;
        this._ytContainer.style.display = "none";
        clearInterval(this._timeUpdateInterval);
        this._started = false;
    }, play:function() {
        if (this._playerReady) {
            this._ytPlayer["playVideo"]();
        }
    }, pause:function() {
        if (this._playerReady) {
            this._ytPlayer["pauseVideo"]();
        }
    }, getDuration:function() {
        return this._playerReady && this._ytPlayer["getDuration"]();
    }, getPlaybackRate:function() {
        return this._playerReady && this._ytPlayer["getPlaybackRate"]();
    }, getCurrentTime:function() {
        return this._playerReady && this._ytPlayer["getCurrentTime"]();
    }, isPlaying:function() {
        return this._playerReady && this._ytPlayer["getPlayerState"]() === window["YT"]["PlayerState"]["PLAYING"];
    }, seek:function(position) {
        if (this._playerReady) {
            this._ytPlayer["seekTo"](position);
        }
    }, isStarted:function() {
        return this._started;
    }, setVolume:function(volume) {
        this._volume = volume;
        if (this._ytPlayer) {
            this._ytPlayer["setVolume"](Math.round(volume * 100));
        }
        onVolumeChange.call(this);
    }, mute:function(mute) {
        var action = mute ? "mute" : "unMute";
        if (this._ytPlayer) {
            this._ytPlayer[action]();
        }
        this._muted = mute;
        onVolumeChange.call(this);
    }, muted:function() {
        return this._muted;
    }, getVolume:function() {
        return this._volume || this._playerReady && this._ytPlayer["getVolume"]() / 100;
    }};
}());
vdb.html5.player.video.module.YoutubeModule.isRequired = function(video) {
    video = video || vdb.Utils.getValueOrDefault(vdb.ctx.playerAPI.bid, ["videos", 0]);
    return!!video && (video["videoSourceType"] || video.videoSourceType || "").toLowerCase() === vdb.enums.VideoSourceType.YOUTUBE;
};
vdb.html5.player.video.module.YoutubeModule.isPlayVideo = true;
vdb.html5.player.video.module.YoutubeModule.keepOnEnd = true;
vdb.html5.player.video.recovery = {};
vdb.html5.player.video.recovery.RecoveryTracker = vdb.tracking.PlayerPixelTrackerBase.extend(function() {
    function onAdapterCreated(adapter) {
        this._adapter = adapter;
    }
    function _getVideoWatchTime() {
        var state = this._adapter.getPlayerState() || {};
        return Math.floor(Math.min(state["videoLength"] * 3, state["currentPlayTime"])) || 0;
    }
    function _addBasicParams(params) {
        this.sizeParams(params);
        this.skinParams(params);
        this.videoParams(params);
        return params;
    }
    return{init:function(context) {
        this._super(context);
        this._trackingUrl = this._urls.TRACKING_QOE_URL;
        this._context = context;
        if (context.api.adapter) {
            onAdapterCreated.call(this, context.api.adapter);
        } else {
            context.addEventListener(context.ctx.adapter.CREATED, onAdapterCreated.bind(this));
        }
    }, trackRecoveryStart:function(data) {
        var params = {"ec":data.errorCode, "att":data.attemptNumber, "t":_getVideoWatchTime.call(this), "et":data.time};
        _addBasicParams.call(this, params);
        this.callPixel("video-recovery-start.gif", params);
    }, trackVideoConfigLoad:function(data) {
        var params = {"att":data.attemptNumber, "et":data.time};
        _addBasicParams.call(this, params);
        this.callPixel("video-config-load.gif", params);
    }, trackRecoverySuccess:function(data) {
        var params = {"att":data.attemptNumber, "t":_getVideoWatchTime.call(this), "et":data.time};
        _addBasicParams.call(this, params);
        this.callPixel("video-recovery-success.gif", params);
    }};
}());
vdb.html5.player.video.SelectBestVideoUrl = function() {
    var video;
    var urls;
    var sourceCheck;
    var sortVideoTypes = function() {
        handleType.call(this, "video/ogg", ".ogg");
        handleType.call(this, "video/mp4", ".mp4");
        var hasPoorHlsSupport = vdb.utils.Common.getCanPlayType("application/vnd.apple.mpegurl") === "maybe";
        var androidVersion = vdb.Utils.androidOS();
        if (androidVersion && (androidVersion < 4.4 || androidVersion <= 5.1 && hasPoorHlsSupport) || !vdb.html5.player.video.module.HLSModule.isSupported()) {
            urls.sort(sortingFunc(".m3u8", -1));
        } else {
            urls.sort(sortingFunc(".m3u8"));
        }
        if (video.data360) {
            handleType.call(this, "video/webm", ".webm");
        }
    };
    var handleType = function(type, ext) {
        if (!vdb.utils.Common.isSupported(type)) {
            urls.sort(sortingFunc(ext, -1));
        } else {
            urls.sort(sortingFunc(ext));
        }
    };
    var sortingFunc = function(ext, i) {
        i = i || 1;
        return function(a, b) {
            if (a.indexOf(ext) != -1) {
                return b.indexOf(ext) != -1 ? 0 : -i;
            }
            return b.indexOf(ext) != -1 ? i : 0;
        };
    };
    return function(videoObj, sourceCheckFunc) {
        sourceCheck = sourceCheckFunc;
        video = videoObj;
        urls = video.videoUrls;
        if (!urls) {
            return[];
        }
        sortVideoTypes.call(this);
        if (typeof sourceCheck !== "function") {
            video.setUrlToPlay(urls[0]);
        } else {
            for (var i = 0;i < urls.length;i++) {
                video.setUrlToPlay(urls[i]);
                if (sourceCheck(video)) {
                    return urls;
                }
            }
            video.setUrlToPlay(null);
        }
        return urls;
    };
}();
vdb.html5.player.video.module.YahooModule = vdb.html5.player.video.module.VideoAreaModule.extend(function() {
    function generateConfig(video) {
        var mediaItems = [];
        if (isYahooVideo(video)) {
            var yahooVideoId = vdb.html5.player.video.module.YahooModule._getYahooId(video) || DEFAULT_YAHOO_VIDEO_ID;
            mediaItems.push({"id":yahooVideoId});
        } else {
            vdb.html5.player.video.SelectBestVideoUrl(video, function(vi) {
                var url = vi.urlToPlay;
                return url && url.indexOf(".m3u8") !== -1;
            });
            mediaItems.push({"streams":[{"url":video.urlToPlay}]});
        }
        return{"playlist":{"mediaItems":mediaItems}, "region":"US", "autoplay":false, "stopAtLastFrame":true, "chromeless":false, "html5":"hls"};
    }
    function loadScript() {
        return(new vdb.Dom(window.document)).loadScript("https://yep.video.yahoo.com/js/3/videoplayer-min.js?r=nextgen-core-desktop&lang=en-US", false);
    }
    function onBufferingStart() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_BUFFERING_START);
    }
    function onBufferingEnd() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_BUFFERING_END);
    }
    function onTimeUpdate() {
        var duration = this.getDuration();
        this._currentTime = this.getCurrentTime();
        if (this._currentTime > duration) {
            this._currentTime = duration;
        }
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_TIMEUPDATE, {currentTime:this._currentTime, buffered:0, duration:duration, durationWithoutAds:duration});
    }
    function onVolumeChange() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_VOLUME_CHANGED, {volume:this.getVolume(), muted:this.muted()});
    }
    function onPlaybackStart() {
        this._started = true;
        this._yahooControls["disableControls"]();
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_LOAD);
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_METADATA, {durationWithoutAds:this.getDuration(), duration:this.getDuration(), playbackRate:this.getPlaybackRate(), width:this._yahooContainer.offsetWidth, height:this._yahooContainer.offsetHeight});
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_STARTED, {duration:this.getDuration()});
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_PLAY, {duration:this.getDuration()});
    }
    function onPause() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_PAUSE);
    }
    function onResume() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_RESUME);
    }
    function onReady() {
        if (vdb.ctx.playsNativeInline()) {
            var videoTags = this._yahooContainer.getElementsByTagName("video");
            for (var i = 0;i < videoTags.length;i++) {
                videoTags[i].setAttribute("playsinline", "playsinline");
            }
        }
    }
    function onRendered() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.THIRD_PARTY_POSTER_AVAILABLE, this._yahooContainer.firstChild);
    }
    function onComplete() {
        this._videoArea.dispatchEvent(vdb.events.VideoEvent.VIDEO_END, {currentTime:this.getCurrentTime(), complete:true});
        this._videoArea.onEnded();
    }
    function attachListeners() {
        var playerEvents = window["YAHOO"]["VideoPlatform"]["API_Events"];
        this._yahooPlayer["on"](playerEvents["PLAYBACK_START"], onPlaybackStart.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYBACK_TIME_UPDATE"], onTimeUpdate.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYER_VOLUME_CHANGE"], onVolumeChange.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYER_MUTE_CHANGE"], onVolumeChange.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYBACK_PAUSE"], onPause.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYBACK_RESUMED"], onResume.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYBACK_COMPLETE"], onComplete.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYER_READY"], onReady.bind(this));
        this._yahooPlayer["on"](playerEvents["PLAYER_RENDERED"], onRendered.bind(this));
        this._yahooPlayer["on"](playerEvents["BUFFERING_START"], onBufferingStart.bind(this));
        this._yahooPlayer["on"](playerEvents["BUFFERING_END"], onBufferingEnd.bind(this));
    }
    function isYahooVideo(video) {
        return!!(video && video.metadata && video.metadata["yahooId"]);
    }
    var LOGGER = vdb.log.getLogger("YahooModule");
    var DEFAULT_YAHOO_VIDEO_ID = "1a2aa009-29d3-3715-a67e-f583aea76371";
    return{init:function(element, videoArea) {
        this._super(element);
        this._videoArea = videoArea;
        this._videosContainer = document.getElementById("videos-container");
        this._started = false;
        this._yahooContainer = document.createElement("div");
        this._yahooContainer.setAttribute("id", "yahooContainer");
        this._yahooContainer.style.width = "100%";
        this._yahooContainer.style.height = "100%";
        this._yahooContainer.style.position = "absolute";
        this._yahooContainer.style.zIndex = "2";
        this._videosContainer.insertBefore(this._yahooContainer, this._videosContainer.firstChild);
        this._scriptPromise = loadScript.call(this);
        LOGGER.debug("init() loading Yahoo script");
        var videoObj = vdb.Utils.getValueOrDefault(vdb.ctx.playerAPI.bid, ["videos", 0]);
        this.setVideo(new vdb.model.Video(videoObj));
    }, setVideo:function(video) {
        LOGGER.debug("setVideo()", video);
        return this._scriptPromise.then(function() {
            if (!this._video || isYahooVideo(video) && video.metadata["yahooId"] !== this._video["metadata"]["yahooId"] && this._started) {
                this._video = video;
                var config = generateConfig(video);
                if (!this._yahooPlayer) {
                    LOGGER.debug("script loaded creating player", config);
                    this._yahooPlayer = new window["YAHOO"]["VideoPlatform"]["VideoPlayer"](config);
                    attachListeners.call(this);
                    this._yahooPlayer["render"](this._yahooContainer);
                    this._yahooControls = this._yahooPlayer["controls"];
                } else {
                    this._yahooPlayer["config"] = config;
                }
            }
        }.bind(this));
    }, detach:function() {
        this._super();
    }, play:function() {
        if (this._yahooControls) {
            this._yahooControls["play"]();
        }
    }, pause:function() {
        if (this._yahooControls) {
            this._yahooControls["pause"]();
        }
    }, getDuration:function() {
        return this._yahooControls && this._yahooControls["getDuration"]();
    }, getPlaybackRate:function() {
    }, getCurrentTime:function() {
        if (this._yahooControls) {
            return this._yahooControls["getCurrentTime"]();
        }
        return 0;
    }, isPlaying:function() {
        return this._yahooControls && this._yahooControls["isPlaying"]() || false;
    }, seek:function(position) {
        this._yahooControls["seek"](position);
    }, isStarted:function() {
        return this._started;
    }, setVolume:function(volume) {
        if (this._yahooControls) {
            this._yahooControls["setVolume"](volume);
            this.mute(false);
        }
    }, mute:function(mute) {
        if (this._yahooControls) {
            this._yahooControls["setMute"](mute);
        }
    }, muted:function() {
        return this._yahooControls && this._yahooControls["getMute"]();
    }, getVolume:function() {
        return this._yahooControls && this._yahooControls["getVolume"]();
    }, hide:function() {
        this.pause();
        this._yahooContainer.style.display = "none";
        this._yahooContainer.style.visibility = "hidden";
    }, show:function() {
        this._yahooContainer.style.display = "block";
        this._yahooContainer.style.visibility = "";
    }};
}());
(function(def) {
    def._getYahooId = function _getYahooId(video) {
        video = video || {};
        var metadata = video.metadata || {};
        return metadata["yahooId"];
    };
    def.isRequired = function() {
        return vdb.utils.BootstrapUtils.isYahooRequired(vdb.ctx);
    };
    def.isPlayVideo = true;
    def.keepOnEnd = true;
})(vdb.html5.player.video.module.YahooModule);
vdb.html5.player.video.streamUrlLoader = {};
vdb.html5.player.video.streamUrlLoader.YahooStreamUrlLoader = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("YahooStreamUrlLoader");
    var YAHOO_VIDEO_URL = "https://video-api.yql.yahoo.com/v1/video/sapi/streams/%{yahoo_id}?protocol=http&format=fmp4%2Cm3u8%2Cmp4%2Cwebm&srid=234125282&rt=html&devtype=desktop&offnetwork=false&region=US&site=frontpage&expb=strm026%2CCG003%2CCompression-ctrl%2Cfpdmcntrl%2CFF004&expn=advance&lang=en-US&width=167&height=94&resize=true&ps=jl4lqfcw&autoplay=true&image_sizes=&excludePS=true&acctid&synd=&pspid=&plidl=&topic&pver=7.86.519.1497491182&try=1&failover_count=0&firstVideo=6bf451fd-11f9-37f9-a54c-d73d795839f6&hlspre=true";
    var onLoadSuccess = function(data) {
        LOGGER.debug("loaded", data);
        var stream = vdb.Utils.getValueOrDefault(data, ["data", "query", "results", "mediaObj", 0, "streams", 0], null);
        var url = stream && stream.host && stream.path ? stream.host + stream.path : null;
        this._loaderFuture.resolve(url);
    };
    var onLoadError = function(error) {
        LOGGER.error("error", error);
        this._loaderFuture.reject(error);
    };
    var getPromise = function() {
        return this._loaderFuture.getPromise();
    };
    return{init:function(yahooId) {
        LOGGER.debug("init");
        this._yahooId = yahooId;
        this._loaderFuture = new vdb.Future;
    }, load:function() {
        LOGGER.debug("load");
        vdb.ajax.get(YAHOO_VIDEO_URL.replace("%{yahoo_id}", this._yahooId), null, onLoadSuccess.bind(this), onLoadError.bind(this));
        return getPromise.call(this);
    }};
}());
vdb.html5.player.video.recovery.VideoRecovery = vdb.EventBus.extend(function() {
    function _hasAttempts() {
        return this._currentAttempt < MAX_RELOADING_COUNT;
    }
    function _getVideo() {
        return this._videoArea.getVideo() || {};
    }
    function _isRecoveryCase() {
        var MError = window["MediaError"] || {};
        var CRITICAL_ERRORS = [MError.MEDIA_ERR_SRC_NOT_SUPPORTED, MError.MEDIA_ERR_DECODE, DS_UNAVAILABLE_ERROR, BUFFERING_ERROR, RECOVERY_ERROR, 11, 12, 13, 14];
        return _getVideo.call(this).id && _hasAttempts.call(this) && (CRITICAL_ERRORS.indexOf(this._errorCode) !== -1 || !this._errorCode);
    }
    function _stopRecovering() {
        if (this._recoveryTimer) {
            this._tracker.trackRecoverySuccess({videoId:_getVideo.call(this).id, attemptNumber:this._currentAttempt, time:+new Date - this._errorTime});
            clearTimeout(this._recoveryTimer);
            this._recoveryTimer = null;
        }
        this._errorCode = null;
        this._errorTime = null;
        if (this._bufferingTimer) {
            clearTimeout(this._bufferingTimer);
            this._bufferingTimer = null;
        }
    }
    function _fatalError() {
        this.dispatchEvent(vdb.html5.player.video.recovery.VideoRecovery.FATAL_ERROR, this._errorCode);
        _stopRecovering.call(this);
    }
    function _onLoaded(data) {
        var video = _getVideo.call(this);
        this._tracker.trackVideoConfigLoad({videoId:video.id, attemptNumber:this._currentAttempt, time:+new Date - this._errorTime});
        if (!this._recoveryTimer) {
            return;
        }
        if (this._videoArea.urlProcessingRequired(video)) {
            _onYahooUrlLoaded.call(this, data);
        } else {
            _onBidLoaded.call(this, data);
        }
    }
    function _onYahooUrlLoaded(url) {
        if (url) {
            var video = _getVideo.call(this);
            video.videoUrls = [url];
            this.dispatchEvent(vdb.html5.player.video.recovery.VideoRecovery.RECOVERY, video);
        } else {
            _fatalError.call(this);
        }
    }
    function _onBidLoaded(bid) {
        var video = _getVideo.call(this);
        if (bid && bid["videos"] && bid["videos"].length > 0 && bid["videos"][0]["videoUrls"]) {
            if (bid["videos"][0]["videoId"] === video.id) {
                video.videoUrls = bid["videos"][0]["videoUrls"];
                this.dispatchEvent(vdb.html5.player.video.recovery.VideoRecovery.RECOVERY, video);
            }
        } else {
            _fatalError.call(this);
        }
    }
    function _loadVideoURLs() {
        setTimeout(function() {
            if (!this._recoveryTimer) {
                return;
            }
            this._tracker.trackRecoveryStart({videoId:_getVideo.call(this).id, errorCode:this._errorCode, attemptNumber:this._currentAttempt, time:+new Date - this._errorTime});
            var video = _getVideo.call(this);
            var recoveryDataLoader;
            if (this._videoArea.urlProcessingRequired(video)) {
                var yahooId = video.metadata["yahooId"];
                recoveryDataLoader = _getYahooUrlLoader.call(this).load(yahooId);
            } else {
                recoveryDataLoader = _getBidLoader.call(this).fetch(video.id);
            }
            recoveryDataLoader.then(_onLoaded.bind(this))["catch"](_onLoadingFailed.bind(this));
        }.bind(this), this._dsBalancingTimeout);
    }
    function _onVideoError(error) {
        if (this._recoveryTimer) {
            return;
        }
        error = error || {};
        if (this._errorCode || error.fatal) {
            return;
        }
        this._errorCode = error.code;
        if (_isRecoveryCase.call(this)) {
            clearTimeout(this._bufferingTimer);
            this._currentAttempt++;
            this._bufferingTimer = null;
            this._errorTime = +new Date;
            this._recoveryTimer = setTimeout(_onRecoveryTimeout.bind(this), this._maxRecoveryTime);
            _loadVideoURLs.call(this);
        } else {
            if (this._errorCode === DS_UNAVAILABLE_ERROR) {
                var video = _getVideo.call(this);
                this.dispatchEvent(vdb.html5.player.video.recovery.VideoRecovery.RECOVERY, video);
            } else {
                _fatalError.call(this);
            }
        }
    }
    function _onLoadingFailed() {
        if (!this._recoveryTimer) {
            return;
        }
        _onVideoError.call(this, {code:DS_UNAVAILABLE_ERROR});
    }
    function _onRecoveryTimeout() {
        this._recoveryTimer = null;
        this._errorTime = null;
        _onVideoError.call(this, {code:RECOVERY_ERROR});
    }
    function _onWaiting() {
        if (this._bufferingTimer) {
            return;
        }
        this._bufferingTimer = setTimeout(function() {
            this._bufferingTimer = null;
            _onVideoError.call(this, {code:BUFFERING_ERROR});
        }.bind(this), this._maxBufferingTime);
    }
    function _getBidLoader() {
        this._bidLoader = this._bidLoader || new vdb.loader.BidLoader(vdb.ctx);
        return this._bidLoader;
    }
    function _getYahooUrlLoader() {
        this._yahooStreamUrlLoader = this._yahooStreamUrlLoader || new vdb.html5.player.video.streamUrlLoader.YahooStreamUrlLoader;
        return this._yahooStreamUrlLoader;
    }
    function init(videoArea, timeOutRate) {
        this._super();
        timeOutRate = timeOutRate || 1E4;
        this._dsBalancingTimeout = Math.random() * timeOutRate;
        this._maxBufferingTime = Math.random() * 1E4 + 1E4;
        this._maxRecoveryTime = this._dsBalancingTimeout + Math.random() * 1E4;
        this._currentAttempt = 0;
        this._tracker = new vdb.html5.player.video.recovery.RecoveryTracker(vdb.ctx);
        this._videoArea = videoArea;
        this._recoveryTimer = null;
        this._videoArea.addEventListener(vdb.html5.player.VIDEO_ERROR, _onVideoError.bind(this));
        this._videoArea.addEventListener(vdb.html5.player.VIDEO_WAITING, _onWaiting.bind(this));
        this._videoArea.addEventListener(vdb.html5.player.VIDEO_RESUME, _stopRecovering.bind(this));
        this._videoArea.addEventListener(vdb.html5.player.VIDEO_END, _stopRecovering.bind(this));
        this._videoArea.addEventListener(vdb.html5.player.VIDEO_PLAY, _stopRecovering.bind(this));
        this._videoArea.addEventListener(vdb.html5.player.VIDEO_PAUSE, _stopRecovering.bind(this));
    }
    var DS_UNAVAILABLE_ERROR = 87;
    var BUFFERING_ERROR = 88;
    var RECOVERY_ERROR = 89;
    var MAX_RELOADING_COUNT = 2;
    return{init:init};
}());
vdb.html5.player.video.recovery.VideoRecovery.FATAL_ERROR = "VideoRecovery.FatalError";
vdb.html5.player.video.recovery.VideoRecovery.RECOVERY = "VideoRecovery.Recovery";
vdb.html5.player.video.urlProcessor = {};
vdb.html5.player.video.urlProcessor.AbstractUrlProcessor = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("AbstractUrlProcessor");
    return{init:function(video) {
        LOGGER.debug("init");
        this._video = video;
        this._videoUrls = video.videoUrls;
    }, execute:function() {
    }};
}());
vdb.html5.player.video.urlProcessor.YahooUrlProcessor = vdb.html5.player.video.urlProcessor.AbstractUrlProcessor.extend(function() {
    var LOGGER = vdb.log.getLogger("YahooUrlProcessor");
    var onUrlLoaded = function(url) {
        LOGGER.debug("url is loaded", url);
        if (url) {
            this._videoUrls[0] = url;
        }
        this._processorFuture.resolve();
    };
    return{init:function(video) {
        LOGGER.debug("init");
        this._super(video);
        this._metadata = this._video.metadata || {};
        this._yahooId = this._metadata["yahooId"];
        this._processorFuture = new vdb.Future;
    }, execute:function() {
        LOGGER.debug("replace");
        var yahooStreamUrlLoader = new vdb.html5.player.video.streamUrlLoader.YahooStreamUrlLoader(this._yahooId);
        var loaderPromise = yahooStreamUrlLoader.load();
        loaderPromise.then(onUrlLoaded.bind(this));
        return this._processorFuture.getPromise();
    }};
}());
vdb.html5.player.video.VideoAreaEvent = {};
(function(def) {
    def.EVENTS = vdb.events.VideoEvent;
    (function exposeEvents(ns, events) {
        for (var event in events) {
            if (events.hasOwnProperty(event)) {
                ns[event] = events[event];
            }
        }
    })(def, def.EVENTS);
})(vdb.html5.player);
vdb.html5.player.video.VideoArea = vdb.EventBus.extend(function() {
    function createSrc(type) {
        var source = vdb.dom.createElement("source");
        if (type) {
            source.type = type;
        }
        return source;
    }
    function onLoad(e) {
        LOGGER.debug("onLoad", this._element.readyState, e);
        this.dispatchEvent(vdb.html5.player.VIDEO_LOAD);
    }
    function shouldRecallPlay() {
        return(!this._started || this._element.paused) && this._askedToPlay && !this._paused && !this._playReceived;
    }
    function sendMetadata() {
        this.dispatchEvent(vdb.html5.player.VIDEO_METADATA, {durationWithoutAds:this.getDurationWithoutAds(), duration:this.getDuration(), playbackRate:this._element.playbackRate, width:this._element.videoWidth, height:this._element.videoHeight});
    }
    function onLoadedMetadata() {
        LOGGER.debug("onLoadedMetadata", this._element.readyState);
        if (this.getDuration()) {
            sendMetadata.call(this);
        } else {
            var onDurationChanged = function() {
                if (this.getDuration()) {
                    this._videoEvents.removeEventListener("durationchange", onDurationChanged);
                    sendMetadata.call(this);
                }
            }.bind(this);
            this._videoEvents.addEventListener("durationchange", onDurationChanged);
        }
    }
    function onWaiting() {
        LOGGER.debug("onWaiting", this._element.readyState);
        this.dispatchEvent(vdb.html5.player.VIDEO_WAITING);
    }
    function onProgress() {
        this._paused = this._paused || this._element.paused && !this._element.ended;
        if (!this._paused && this._currentTime === this._lastTime) {
            if (this._bufferingTimer && Date.now() - this._bufferingTimer > 1E3) {
                onWaiting.call(this);
            } else {
                if (this._bufferingTimer == null) {
                    this._bufferingTimer = Date.now();
                }
            }
        } else {
            this._bufferingTimer = null;
            this._lastTime = this._currentTime;
        }
        this.dispatchEvent(vdb.html5.player.VIDEO_PROGRESS, {waiting:this._element.readyState < 3, buffered:this._element.buffered, duration:this.getDuration()});
    }
    function onCanPlay(e) {
        LOGGER.debug("onCanPlay", this._element.readyState, e);
        this.kickPlay.call(this);
    }
    function onPlay() {
        this._playReceived = true;
    }
    function setPoster(posterUrl) {
        if (posterUrl) {
            this._element.poster = posterUrl;
        } else {
            this._element.removeAttribute("poster");
        }
    }
    function onPlaying(e) {
        LOGGER.debug("Play", e);
        if (!this._started) {
            this._currentTime = 0;
            this._started = true;
            this._paused = false;
            this._touched = true;
            this.dispatchEvent(vdb.html5.player.VIDEO_STARTED, {duration:this.getDuration()});
        }
        if (this._paused) {
            this._paused = false;
            LOGGER.debug("onPlaying", this._element.readyState, "resume");
            this.dispatchEvent(vdb.html5.player.VIDEO_RESUME, {duration:this.getDuration()});
        } else {
            LOGGER.debug("onPlaying", this._element.readyState, "play");
            this.dispatchEvent(vdb.html5.player.VIDEO_PLAY, {duration:this.getDuration()});
        }
        this._element.controls = nativeControlsEnabled.call(this) && this._nativeControls;
        if (this._element.poster) {
            setPoster.call(this, null);
        }
    }
    function onTimeUpdate() {
        var duration = this.getDuration();
        this._currentTime = this._element.currentTime;
        if (this._currentTime > duration) {
            this._currentTime = duration;
        }
        this.dispatchEvent(vdb.html5.player.VIDEO_TIMEUPDATE, {currentTime:this._currentTime, buffered:this._element.buffered, duration:duration, durationWithoutAds:this.getDurationWithoutAds()});
    }
    function onPause() {
        LOGGER.debug("onPause", this._element.readyState);
        this._paused = this._element.paused && !this._element.ended;
        if (this._paused) {
            this.dispatchEvent(vdb.html5.player.VIDEO_PAUSE);
        }
    }
    function onSeeking() {
        LOGGER.debug("onSeeking", this._element.readyState);
        this._seeking = true;
        this.dispatchEvent(vdb.html5.player.VIDEO_SEEKSTART, {currentTime:this._currentTime});
    }
    function onSeeked() {
        LOGGER.debug("onSeeked", this._element.readyState);
        this._seeking = false;
        this.dispatchEvent(vdb.html5.player.VIDEO_SEEKEND);
    }
    function getErrorMessage(code) {
        var msg = "";
        switch(code) {
            case MediaError.MEDIA_ERR_ABORTED:
                msg = "You aborted the video playback.";
                break;
            case MediaError.MEDIA_ERR_NETWORK:
                msg = "A network error caused the video download to fail part-way.";
                break;
            case MediaError.MEDIA_ERR_DECODE:
                msg = "The video playback was aborted due to a corruption problem or because the video used features your browser did not support.";
                break;
            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                msg = "The video could not be loaded, either because the server or network failed or because the format is not supported.";
                break;
            default:
                msg = "An unknown error occurred.";
                break;
        }
        return code + ":" + msg;
    }
    function onVolumeChange() {
        LOGGER.debug("onVolumeChange");
        this.dispatchEvent(vdb.html5.player.VIDEO_VOLUME_CHANGED, {muted:this._element.muted, volume:this._element.volume});
    }
    function onClick() {
        LOGGER.debug("onClick");
        this.dispatchEvent(vdb.html5.player.VIDEO_CLICK);
    }
    function onMouseEnter() {
        this.dispatchEvent(vdb.html5.player.MOUSE_OVER_VIDEO);
    }
    function onTouchStart() {
        this.dispatchEvent(vdb.html5.player.VIDEO_TOUCH_START);
    }
    function onWebkitBeginFullscreen() {
        this._isWebkitFullscreen = true;
        this.dispatchEvent(vdb.html5.player.VIDEO_WEBKIT_BEGIN_FULLSCREEN);
    }
    function onWebkitEndFullscreen() {
        this._isWebkitFullscreen = false;
        this.dispatchEvent(vdb.html5.player.VIDEO_WEBKIT_END_FULLSCREEN);
    }
    function setupEventListeners() {
        this._videoEvents.on("loadstart", onLoad.bind(this));
        this._videoEvents.on("loadedmetadata", onLoadedMetadata.bind(this));
        this._videoEvents.on("progress", onProgress.bind(this));
        this._videoEvents.on("play", onPlay.bind(this));
        this._videoEvents.on("playing", onPlaying.bind(this));
        this._videoEvents.on("canplay canplaythrough", onCanPlay.bind(this));
        this._videoEvents.on("timeupdate", onTimeUpdate.bind(this));
        this._videoEvents.on("pause", onPause.bind(this));
        this._videoEvents.on("seeking", onSeeking.bind(this));
        this._videoEvents.on("seeked", onSeeked.bind(this));
        this._videoEvents.on("waiting", onWaiting.bind(this));
        this._videoEvents.on("ended abort", this.onEnded.bind(this));
        this._videoEvents.on("error", this.onError.bind(this));
        this._videoEvents.on("volumechange", onVolumeChange.bind(this));
        this._videoEvents.on("click", onClick.bind(this));
        this._videoEvents.on("touchstart", onTouchStart.bind(this));
        this._videoEvents.on("webkitbeginfullscreen", onWebkitBeginFullscreen.bind(this));
        this._videoEvents.on("webkitendfullscreen", onWebkitEndFullscreen.bind(this));
        this._videoEvents.on("mouseenter", onMouseEnter.bind(this));
    }
    function enableMousePointer(b) {
        this._element.style.cursor = b ? "pointer" : "";
    }
    function appendSourceTags(sourceTags) {
        var fragment = vdb.dom.createDocumentFragment();
        var sourceTag;
        for (var i = 0;i < sourceTags.length;++i) {
            sourceTag = createSrc.call(this, sourceTags[i].type);
            fragment.appendChild(sourceTag);
            sourceTag.setAttribute("src", sourceTags[i].url);
        }
        var _sourceTagEvents = vdb.events.wrap(sourceTag);
        _sourceTagEvents.on("error", this.onError.bind(this));
        this._element.appendChild(fragment);
    }
    var LOGGER = vdb.log.getLogger("VideoArea");
    var nativeControlsEnabled = function() {
        return!vdb.html5.player.hasSkin && vdb.html5.player.showControls;
    };
    return{_video:null, _playReceived:false, _started:false, _paused:false, _touched:false, _lastTime:0, _currentTime:0, _askedToPlay:false, _bufferingTimer:null, _seeking:false, _isWebkitFullscreen:false, init:function(enablePreload) {
        var utl = vdb.Utils;
        var PlaybackMode = vdb.enums.player.PlaybackMode;
        var isIosAppMacro = vdb.ctx && vdb.ctx.getMacro(vdb.constants.PlayerMacros.IOSAPP);
        var browser = utl.browser;
        var videoAttributes = {"style":"display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 0; margin: 0; z-index: 1;"};
        this._super();
        this._isAutoplay = vdb.ctx && (vdb.ctx.playbackMode === PlaybackMode.AUTOPLAY || vdb.ctx.playbackMode === PlaybackMode.AUTOPLAY_AD_ONLY);
        if (browser.isIos() && (browser.name === "safari" && browser.version >= 10 || browser.name === "chrome" && browser.version >= 54 || browser.name === "fban")) {
            videoAttributes["playsinline"] = true;
        }
        if (vdb.ctx && vdb.ctx.playsNativeInline()) {
            if (this._isAutoplay) {
                videoAttributes["autoplay"] = true;
            }
        } else {
            if (utl.parseBoolean(isIosAppMacro)) {
                videoAttributes["webkit-playsinline"] = true;
            }
        }
        if (!enablePreload) {
            videoAttributes["preload"] = "none";
        }
        this._element = utl.createElement("video", videoAttributes);
        this._nativeControls = utl.desktopOs() ? nativeControlsEnabled.call(this) : true;
        this._videoEvents = vdb.events.wrap(this._element);
        setupEventListeners.call(this);
    }, setControls:function(controls) {
        this._nativeControls = !!controls;
    }, onEnded:function(e) {
        LOGGER.debug("onEnded", this._element.readyState, e);
        this.complete(e);
        this._started = false;
        this._playReceived = false;
    }, complete:function(e) {
        LOGGER.debug("onComplete", this._element.readyState, e);
        if (this._started) {
            this.dispatchEvent(vdb.html5.player.VIDEO_END, {currentTime:this._currentTime, complete:e.type === "ended"});
            this.dispatchEvent(vdb.html5.player.VIDEO_FORCE_END);
        }
    }, kickPlay:function() {
        if (shouldRecallPlay.call(this)) {
            this._element.play();
        }
    }, cleanVideo:function() {
        if (!this._video) {
            return;
        }
        vdb.dom.empty(this._element);
        this._element.setAttribute("src", "");
        this._element.removeAttribute("src");
        if (vdb.Utils.isIE || vdb.Utils.isEdge) {
            this._videoCleaning = true;
        }
        this._started = false;
        this._playReceived = false;
        this._touched = false;
        this._askedToPlay = false;
    }, onError:function(event) {
        if (this._videoCleaning) {
            this._videoCleaning = false;
            return;
        }
        var code;
        if (event && event.data && event.data.code) {
            code = event.data.code;
        } else {
            code = this._element.error ? this._element.error.code : null;
        }
        this.reportError(code);
    }, reportError:function(code, msg, fatal) {
        var message = "Can't play video " + this._element.currentSrc + ": " + (msg || getErrorMessage.call(this, code));
        LOGGER.debug(message);
        this.dispatchEvent(vdb.html5.player.VIDEO_ERROR, {code:code, message:message, fatal:fatal});
    }, removeControls:function() {
        this._nativeControls = false;
        if (this._element) {
            this._element.controls = this._nativeControls;
        }
    }, addControls:function() {
        this._nativeControls = nativeControlsEnabled.call(this);
        if (this._element) {
            this._element.controls = this._nativeControls;
        }
    }, isVideoSet:function(video) {
        if (!this._element.getAttribute("src") && !this._element.getElementsByTagName("source").length) {
            return false;
        }
        var currentSrc = this._element.currentSrc;
        return currentSrc && this._video === video && video.videoUrls.indexOf(currentSrc) >= 0;
    }, reset:function() {
        this.cleanVideo(true);
    }, setVideo:function(video, crossDomain) {
        if (!video) {
            this.reset();
            return;
        }
        if (typeof video === "string") {
            video = new vdb.model.Video({"videoUrls":[video], "title":"Video"});
        }
        if (this.isVideoSet(video)) {
            return;
        }
        this._video = video;
        this.cleanVideo();
        if (crossDomain) {
            this._element.setAttribute("crossorigin", "anonymous");
        } else {
            this._element.removeAttribute("crossorigin");
        }
        var amntVideos = video.videoUrls.length;
        if (amntVideos === 1) {
            this._element.setAttribute("src", video.videoUrls[0]);
        } else {
            var sourceTags = [];
            var typelessSourceTags = [];
            for (var i = 0;i < amntVideos;i++) {
                var videoUrl = video.videoUrls[i];
                if (videoUrl) {
                    var type = vdb.Utils.mimeTypeByExt(videoUrl);
                    if (!type) {
                        typelessSourceTags.push({type:type, url:videoUrl});
                    } else {
                        if (this.canPlayType(type)) {
                            sourceTags.push({type:type, url:videoUrl});
                        } else {
                            LOGGER.warn("Unsupported media type", videoUrl);
                        }
                    }
                }
            }
            sourceTags = sourceTags.concat(typelessSourceTags);
            appendSourceTags.call(this, sourceTags);
        }
        try {
            this._element.load();
        } catch (e) {
        }
    }, touch:function() {
        if (!this._touched) {
            LOGGER.debug("touch");
            try {
                this._element.load();
            } catch (e) {
                LOGGER.error(e);
            }
        }
    }, hide:function() {
        this._element.style.visibility = "hidden";
        this._element.style.display = "none";
    }, show:function() {
        this._element.style.visibility = "";
        this._element.style.display = "block";
    }, canPlayType:function(mimeType) {
        return vdb.utils.Common.isSupported(mimeType);
    }, play:function() {
        this._askedToPlay = true;
        this._element.play();
    }, pause:function() {
        this._element.pause();
    }, isPlaying:function() {
        return this._started && !this._paused;
    }, isPaused:function() {
        return this._paused;
    }, isSeeking:function() {
        return this._seeking;
    }, isStarted:function() {
        return this._started;
    }, getVideoHeight:function() {
        return this._element ? this._element.videoHeight : 0;
    }, getVideoWidth:function() {
        return this._element ? this._element.videoWidth : 0;
    }, stop:function() {
        this._element.pause();
        this.cleanVideo();
        this._element.load();
        this.dispatchEvent(vdb.html5.player.VIDEO_FORCE_END);
    }, getVideo:function() {
        return this._video;
    }, seek:function(position) {
        if (position >= 0) {
            position = isNaN(this.getDuration()) ? 0 : Math.min(position, this.getDuration() - .5);
            try {
                this._element.currentTime = position;
            } catch (e) {
            }
        }
    }, getDuration:function() {
        var videoDuration = this._element.duration;
        return videoDuration && videoDuration !== Infinity ? videoDuration : 0;
    }, getDurationWithoutAds:function() {
        return this.getDuration() - this.getAdsDuration();
    }, setAdsDuration:function(duration) {
        this._adsDuration = duration;
    }, getAdsDuration:function() {
        return this._adsDuration || 0;
    }, getCurrentTime:function() {
        return this._element.currentTime || 0;
    }, getCurrentPercent:function() {
        var percent = this.getCurrentTime() / this.getDuration();
        return isNaN(percent) ? 0 : percent;
    }, getBuffered:function() {
        return this._element.buffered;
    }, getWidth:function() {
        return this._element.offsetWidth || this._element.parentNode && this._element.parentNode.offsetWidth || 0;
    }, getHeight:function() {
        return this._element.offsetHeight || this._element.parentNode && this._element.parentNode.offsetHeight || 0;
    }, setVolume:function(volume) {
        try {
            this._element.volume = volume;
            this._element.muted = !volume;
        } catch (e) {
        }
    }, getVolume:function() {
        return this._element.volume;
    }, mute:function(muted) {
        try {
            this._element.muted = muted;
        } catch (e) {
        }
    }, muted:function() {
        return this._element.muted;
    }, setPoster:function(posterUrl) {
        setPoster.call(this, posterUrl);
    }, setBgColor:function(color) {
        this._element.style.backgroundColor = color;
    }, getParentNode:function() {
        return this._element.parentNode;
    }, getElement:function() {
        return this._element;
    }, webkitEnterFullscreen:function() {
        try {
            this._element.webkitEnterFullscreen();
        } catch (e) {
        }
    }, getCurrentSrc:function() {
        return this._element.currentSrc;
    }, webkitExitFullscreen:function() {
        try {
            this._element.webkitExitFullscreen();
        } catch (e) {
        }
    }, isWebkitFullscreen:function() {
        return this._isWebkitFullscreen;
    }, isReady:function() {
        return true;
    }, onLoad:onLoad, onLoadedMetadata:onLoadedMetadata, onCanPlay:onCanPlay, onPause:onPause, onClick:onClick, enableMousePointer:enableMousePointer};
}());
vdb.html5.player.VolumeCookieManager = vdb.core.Class.extend(function() {
    var VOLUME = "o2playervolume";
    var MUTE = "o2playermute";
    var EXPIRATION = 60 * 60 * 24;
    var bindListeners = function() {
        var PlayerEvent = vdb.constants.PlayerEvent;
        this.player.addEventListener(PlayerEvent.AD_VOLUME_CHANGED, onVolumeChange.bind(this));
        this.player.addEventListener(PlayerEvent.VIDEO_VOLUME_CHANGED, onVolumeChange.bind(this));
    };
    var onVolumeChange = function(event) {
        var volume = event && event.data && event.data.volume;
        volume = !isNaN(volume) ? volume : 1;
        volume = volume % 1 === 0 ? "" + volume : volume.toFixed(2);
        this.cookies.set(MUTE, event && event.data && event.data.muted || false, {expires:EXPIRATION});
        this.cookies.set(VOLUME, volume, {expires:EXPIRATION});
    };
    return{init:function(player) {
        var initialSound = vdb.ctx.playerAPI.getInitialSound();
        var SoundMode = vdb.enums.player.SoundMode;
        this.player = player;
        if (!vdb.ctx.isVPAID && !vdb.ctx.preview && [SoundMode.MOUSEOVER, SoundMode.MOUSEOVER_OFF].indexOf(initialSound) === -1 && !vdb.ctx.playsNativeInline()) {
            this.cookies = new vdb.utils.Cookies;
            bindListeners.call(this);
        }
    }, getVolume:function() {
        var volume = this.cookies && +this.cookies.get(VOLUME);
        return volume && (volume < 0 || volume > 1 ? undefined : volume);
    }, getMuted:function() {
        if (!this.cookies || typeof this.cookies.get(MUTE) === "undefined") {
            return undefined;
        }
        return this.cookies.get(MUTE) === "true";
    }};
}());
vdb.html5.player.VrEventProxy = vdb.core.Class.extend(function() {
    var ec = vdb.events.EventContext;
    var Event360 = vdb.html5.events.Event360;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var INBOUND_EVENT_MAP = {"setOrientation":Event360.SET_ORIENTATION, "resetOrientation":Event360.RESET_ORIENTATION, "toggleGyro":Event360.TOGGLE_GYRO, "toggleSkin":Event360.TOGGLE_SKIN, "toggleStereoscopic":Event360.TOGGLE_STEREOSCOPIC, "createTooltip":PlayerEvent.TOOLTIP_VIEW_READY, "pauseTooltip":PlayerEvent.TOOLTIP_PAUSE, "showTooltipIcon":PlayerEvent.SHOW_TOOLTIP_ICON, "hideTooltipIcon":PlayerEvent.HIDE_TOOLTIP_ICON, "openTooltipIcon":PlayerEvent.OPEN_TOOLTIP_ICON, "closeTooltipIcon":PlayerEvent.CLOSE_TOOLTIP_ICON,
        "showTooltip":PlayerEvent.SHOW_TOOLTIP, "hideTooltip":PlayerEvent.HIDE_TOOLTIP};
    var getOutboundEventHandler = function(eventName) {
        return function(e) {
            e = e || {};
            e["type"] = eventName;
            vdb.ctx.dispatchEvent(eventName, e);
        };
    };
    return{init:function(vrPlayer, eventGroup, inboundEventHandler) {
        var VrEvents = vdb["vr"]["Events"];
        var event;
        var method;
        this._outboundEventMap = {};
        this._outboundEventMap[VrEvents["MOVED"]] = Event360.MOVED;
        this._outboundEventMap[VrEvents["VIDEO_PRESS"]] = Event360.VIDEO_PRESS;
        this._outboundEventMap[VrEvents["VIDEO_RELEASE"]] = Event360.VIDEO_RELEASE;
        this._outboundEventMap[VrEvents["COMPASS_PRESS"]] = Event360.COMPASS_PRESS;
        this._outboundEventMap[VrEvents["COMPASS_RELEASE"]] = Event360.COMPASS_RELEASE;
        this._outboundEventMap[VrEvents["TOOLTIP_BUTTON_CLICK"]] = PlayerEvent.TOOLTIP_BUTTON_CLICK;
        this._outboundEventMap[VrEvents["TOOLTIP_CLICK"]] = PlayerEvent.TOOLTIP_CLICK;
        if (vrPlayer) {
            for (event in this._outboundEventMap) {
                ec.bind(vrPlayer, event, getOutboundEventHandler(this._outboundEventMap[event]));
            }
            if (!inboundEventHandler) {
                inboundEventHandler = function(method1, evt) {
                    vrPlayer[method1](evt && evt.data);
                };
            }
        }
        for (method in INBOUND_EVENT_MAP) {
            ec.bind(vdb.ctx, INBOUND_EVENT_MAP[method], inboundEventHandler.bind(null, method)).link(eventGroup);
        }
    }, notifyHandler:function(event) {
        var outboundEventName = this._outboundEventMap[event["type"]];
        if (outboundEventName) {
            getOutboundEventHandler(outboundEventName).call(null, event);
        }
    }, getOutboundEvents:function() {
        return this._outboundEventMap;
    }};
}());
vdb.html5.player.video.module.Module360 = vdb.html5.player.video.module.BaseModule360.extend(function() {
    var LOGGER = vdb.log.getLogger("Module360");
    var PlayerMacros = vdb.constants.PlayerMacros;
    return{init:function(element) {
        LOGGER.debug("init");
        this._super(element);
    }, prepareModule:function() {
        LOGGER.debug("prepareModule");
        this._super();
    }, setVideo:function(video) {
        var data360 = video && video.data360 || {};
        var player = vdb.ctx.playerAPI.player;
        LOGGER.debug("setVideo");
        vdb.ctx.vrPlayer = new vdb["vr"]["Player"]({"rendererType":vdb.Utils.isIE ? "frame" : "video", "width":vdb.Utils.isIE ? 960 : null, "height":vdb.Utils.isIE ? 540 : null, "container":this._element.parentNode, "projectionType":data360.projectionType, "tilt":data360.tilt, "centeredFishEye":vdb.ctx.getMacro(PlayerMacros.CENTEREDFISHEYE), "fishEyeAngle":vdb.ctx.getMacro(PlayerMacros.FISHEYEANGLE), "panel":{"customColor":player && player.getControlsCustomColor()}});
        new vdb.html5.player.VrEventProxy(vdb.ctx.vrPlayer, this._eventContext);
        vdb.ctx.vrPlayer["render"](this._element);
        this._originalZ = this._element.style.zIndex;
        this._element.style.zIndex = -1E3;
        this.bindEvents();
        return vdb.Promise.resolve();
    }, getOrientation:function() {
        return vdb.ctx.vrPlayer && vdb.ctx.vrPlayer["getOrientation"]();
    }, detach:function() {
        LOGGER.debug("detach");
        this._super();
        this._element.style.zIndex = this._originalZ;
    }};
}());
vdb.html5.player.video.module.Module360.isRequired = function(video) {
    return!!video && !!video.data360 && vdb.ctx.vrRenderer != vdb.enums.VrRendererType.ENVRMNT && !vdb.ctx.video360Error && !vdb.Utils.browser.isIos() && !vdb.Utils.browser["safari"] && !(vdb.Utils.isIE && !vdb.html5.player.video.module.HLSModule.isRequired(video));
};
vdb.html5.player.video.module.Module360.isPlayVideo = false;
vdb.html5.player.video.module.CrossDomainModule360 = vdb.html5.player.video.module.Module360.extend(function() {
    var LOGGER = vdb.log.getLogger("CrossDomainModule360");
    var ec = vdb.events.EventContext;
    var onLoad = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_LOAD);
    };
    var onMeta = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_METADATA, {durationWithoutAds:this._videoAdapter.duration, duration:this._videoAdapter.duration, playbackRate:this._videoAdapter.playbackRate, width:this._videoAdapter.videoWidth, height:this._videoAdapter.videoHeight});
    };
    var onWaiting = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_WAITING);
    };
    var onTimeUpdate = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_TIMEUPDATE, {currentTime:this._videoAdapter.currentTime, buffered:this._videoAdapter.buffered, duration:this._videoAdapter.duration, durationWithoutAds:this._videoAdapter.duration});
    };
    var onSeeking = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_SEEKSTART, {currentTime:this._videoAdapter.currentTime});
    };
    var onSeeked = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_SEEKEND);
    };
    var onProgress = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_PROGRESS, {waiting:this._videoAdapter.readyState, buffered:this._videoAdapter.buffered, duration:this._videoAdapter.duration});
    };
    var onPlaying = function() {
        if (!this._started) {
            this._started = true;
            this._paused = false;
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_STARTED, {duration:this.getDuration()});
        }
        if (this._paused) {
            this._paused = false;
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_RESUME, {duration:this.getDuration()});
        } else {
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_PLAY, {duration:this.getDuration()});
        }
    };
    var onPause = function() {
        this._paused = !this._videoAdapter.ended;
        if (this._paused) {
            this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_PAUSE);
        }
    };
    var onVolumeChange = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_VOLUME_CHANGED, {muted:this._videoAdapter.muted, volume:this._videoAdapter.volume});
    };
    var onEnd = function() {
        this._videoArea.dispatchEvent(vdb.html5.player.VIDEO_END, {currentTime:this._videoAdapter.currentTime, complete:true});
    };
    var onError = function(err) {
        LOGGER.debug("error", err);
        this._videoArea.onError(err);
    };
    return{init:function(element, videoArea) {
        this._super(element);
        this._videoArea = videoArea;
        this._videoAdapter = new vdb.html5.player.xdomain.CrossDomainVideo360Adapter(videoArea.muted());
    }, bindEvents:function() {
        var _onEnd = onEnd.bind(this);
        ec.bind(this._videoAdapter, "loadstart", onLoad.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "loadedmetadata", onMeta.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "waiting", onWaiting.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "timeupdate", onTimeUpdate.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "seeking", onSeeking.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "seeked", onSeeked.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "progress", onProgress.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "playing", onPlaying.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "pause", onPause.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "volumechange", onVolumeChange.bind(this)).link(this._eventContext);
        ec.bind(this._videoAdapter, "ended", _onEnd).link(this._eventContext);
        ec.bind(this._videoAdapter, "abort", _onEnd).link(this._eventContext);
        ec.bind(this._videoAdapter, "error", onError.bind(this)).link(this._eventContext);
        this._super();
    }, setVideo:function(video) {
        var videoUrls = vdb.html5.player.video.module.CrossDomainModule360.selectVideoUrls(video);
        var url = (videoUrls[0] || "").replace("http://content.uplynk.com", "https://content.uplynk.com");
        this._videoAdapter.appendTo(this._element.parentNode);
        this._originalZ = this._element.style.zIndex;
        this._element.style.zIndex = -1E3;
        this._originalElementPlay = this._element.play;
        this._element.play = function() {
        };
        this.bindEvents();
        return this._videoAdapter.setVideo({url:url, projectionType:video.data360.projectionType, tilt:video.data360.tilt}, vdb.html5.player.video.module.CrossDomainModule360._touchedAudio);
    }, play:function() {
        this._videoAdapter.play();
    }, pause:function() {
        this._videoAdapter.pause();
    }, mute:function(muted) {
        this._videoAdapter.muted = muted;
    }, seek:function(position) {
        this._videoAdapter.currentTime = position;
    }, isPlaying:function() {
        return!this._videoAdapter.paused && !this._videoAdapter.ended;
    }, getCurrentTime:function() {
        return this._videoAdapter.currentTime;
    }, getDuration:function() {
        return this._videoAdapter.duration;
    }, setVolume:function(volume) {
        this._videoAdapter.volume = volume;
    }, getVolume:function() {
        return this._videoAdapter.volume;
    }, muted:function() {
        return this._videoAdapter.muted;
    }, getOrientation:function() {
        return this._videoAdapter.orientation;
    }, detach:function() {
        LOGGER.debug("detach");
        this._super();
        this._started = false;
        this._videoAdapter.removeFromParent();
        this._element.play = this._originalElementPlay;
    }, isStarted:function() {
        return this._started;
    }, hide:function() {
        this._videoAdapter.hide();
    }, show:function() {
        this._videoAdapter.show();
    }};
}());
vdb.html5.player.video.module.CrossDomainModule360.IFRAME_360_URLS = {"http://cdn.vidible.tv":"http://cdn.vidible.tv/dev/js/xdomain360embed.html", "https://cdn-ssl.vidible.tv":"https://cdn-ssl.vidible.tv/dev/js/xdomain360embed.html", "http://videos.vidible.tv":"http://cdn.vidible.tv/dev/js/xdomain360embed.html".replace("http://cdn.vidible.tv", "http://videos.vidible.tv"), "https://videos.vidible.tv":"https://cdn-ssl.vidible.tv/dev/js/xdomain360embed.html".replace("https://cdn-ssl.vidible.tv", "https://videos.vidible.tv"),
    "http://content.uplynk.com":"http://content.uplynk.com/_aol/xdomain360.html", "https://content.uplynk.com":"https://content.uplynk.com/_aol/xdomain360.html"};
vdb.html5.player.video.module.CrossDomainModule360.IFRAME_360_URLS.PROXY_DOMAIN = "hls.adylevy.com/_aol/xdomain360.html";
vdb.html5.player.video.module.CrossDomainModule360.IFRAME_360_URLS.LOWLANDER_DOMAIN = "{bcid}.cdn.aolon.com/dev/js/xdomain360.html";
vdb.html5.player.video.module.CrossDomainModule360.selectVideoUrls = function() {
    var IFRAME_360_URLS = vdb.html5.player.video.module.CrossDomainModule360.IFRAME_360_URLS;
    var isCdnUrl = function(url) {
        var parsedUrl = vdb.Utils.parseUrl(url);
        var origin = parsedUrl.protocol + "//" + parsedUrl.hostname;
        return Object.prototype.hasOwnProperty.call(IFRAME_360_URLS, origin);
    };
    return function(video) {
        var videoUrls = video.videoUrls;
        var filteredUrls;
        if (!vdb.Utils.isIE || vdb.Utils.browser["version"] <= 10) {
            filteredUrls = videoUrls.filter(isCdnUrl);
            if (filteredUrls.length > 0) {
                videoUrls = filteredUrls;
            }
        }
        return videoUrls;
    };
}();
vdb.html5.player.video.module.CrossDomainModule360.isRequired = function(video) {
    return!!video && !!video.data360 && vdb.ctx.vrRenderer !== vdb.enums.VrRendererType.ENVRMNT && !vdb.ctx.video360Error && (vdb.Utils.browser.isIos() || vdb.Utils.browser["safari"] || vdb.Utils.isIE && vdb.Utils.browser["version"] > 10) && vdb.html5.player.video.module.CrossDomainModule360.selectVideoUrls(video).length > 0 && !(vdb.Utils.isIE && vdb.html5.player.video.module.Module360.isRequired(video));
};
vdb.html5.player.video.module.CrossDomainModule360.isPlayVideo = true;
vdb.html5.player.video.module.CrossDomainModule360._touchedAudio = document.createElement("audio");
vdb.html5.player.video.module.CrossDomainModule360.touch = function() {
    this._touchedAudio.load();
};
vdb.html5.player.video.AdjectiveVideoArea = vdb.html5.player.video.VideoArea.extend(function() {
    function detachDependencies(keepNeeded) {
        this._setVideoPromise = null;
        for (var i = 0;i < this._currentDependencies.length;i++) {
            var module = this._currentDependencies[i];
            if (!keepNeeded || !module.constructor.keepOnEnd) {
                module.instance.detach();
                this._currentDependencies[i] = null;
            }
        }
        this._currentDependencies = vdb.Utils.removeFromArray(this._currentDependencies, null);
    }
    function onModuleFailed(error) {
        this._lastTime = this._currentTime;
        var code = error ? error.code : MediaError.MEDIA_ERR_DECODE;
        detachDependencies.call(this);
        this.onError({data:{code:code}});
    }
    function onError(event) {
        if (!_tryNextVideoUrl.call(this)) {
            this._super(event);
        }
    }
    function _tryNextVideoUrl() {
        if (!this.isStarted() && this._video && this._video.urlToPlay && this._video.videoUrls.length > 1) {
            var urls = this._video.videoUrls;
            urls.splice(urls.indexOf(this._video.urlToPlay), 1);
            this._moduleFailed = true;
            this.setVideo(this._video, false);
            this.play();
            return true;
        }
        return false;
    }
    function onFinishVideoRequest() {
        detachDependencies.call(this);
        this.complete({type:"ended"});
    }
    function grabDependencies(video) {
        var result = [];
        for (var i = 0;i < this.MODULES.length;i++) {
            var module = this.MODULES[i];
            if (this._currentDependencies.indexOf(module) === -1 && module.constructor.isRequired(video)) {
                if (!module.instance) {
                    module.instance = new module.constructor(this._element, this);
                    module.instance.addEventListener(vdb.html5.player.video.module.VideoAreaModule.VIDEO_ERROR, onModuleFailed.bind(this));
                    module.instance.addEventListener(vdb.html5.player.video.module.VideoAreaModule.VIDEO_CLICK, this.onClick.bind(this));
                    module.instance.addEventListener(vdb.html5.player.video.module.VideoAreaModule.FINISH_VIDEO, onFinishVideoRequest.bind(this));
                }
                result.push(module.instance.load());
                this._currentDependencies.push(module);
            }
        }
        return vdb.Promise.all(result);
    }
    function touchModules() {
        for (var i = 0;i < this.MODULES.length;i++) {
            var module = this.MODULES[i];
            if (module.constructor.touch) {
                module.constructor.touch();
            }
        }
    }
    function isPlayFilter(module) {
        return module.constructor.isPlayVideo;
    }
    function isAbleToPlay(video) {
        for (var j = 0;j < this.MODULES.length;j++) {
            var module = this.MODULES[j];
            if (module.constructor.isPlayVideo && module.constructor.isRequired(video)) {
                return true;
            }
        }
        return this.canPlayType(vdb.Utils.mimeTypeByExt(video && video.urlToPlay || ""));
    }
    function moduleInUse(module) {
        return this._currentDependencies && this._currentDependencies.filter(function(m) {
            return m.constructor === module;
        }).length > 0;
    }
    function sendErrorIfCantRetry(video) {
        if (this._moduleFailed) {
            if (video && video.videoUrls && video.videoUrls.length > 0) {
                return true;
            }
            this.reportError(MediaError.MEDIA_ERR_NETWORK);
        }
        return false;
    }
    function filterVideoUrls(video) {
        var filteredUrls;
        var isNotHls = function(url) {
            return!vdb.Utils.isHls(url);
        };
        if ((vdb.Utils.mobileOs() || vdb.Utils.isIE) && !video.metadata["live"]) {
            filteredUrls = video.videoUrls.filter(isNotHls);
            if (filteredUrls.length > 0) {
                video.videoUrls = filteredUrls;
            }
        }
    }
    function _onFatalError(code) {
        this.reportError(code, null, true);
    }
    function _recovery(video) {
        this._recovering = true;
        this.setVideo(video);
        this.play();
    }
    function initModules() {
        var modules = [vdb.html5.player.video.module.YahooModule, vdb.html5.player.video.module.OathHLSModule, vdb.html5.player.video.module.HLSModule, vdb.html5.player.video.module.DashModule, vdb.html5.player.video.module.Module360, vdb.html5.player.video.module.CrossDomainModule360, vdb.html5.player.video.module.ErrorModule360, vdb.html5.player.video.module.EnvrmntModule360, vdb.html5.player.video.module.YoutubeModule];
        this.MODULES = [];
        for (var k in modules) {
            if (Object.prototype.hasOwnProperty.call(modules, k)) {
                this.MODULES.push({constructor:modules[k], instance:null});
            }
        }
    }
    function composeVideoObject(video, crossDomain, superSetVideo) {
        var is360 = video && video.data360;
        if (video) {
            if (typeof video === "string") {
                video = new vdb.model.Video({"videoUrls":[video], "title":"Video"});
            }
            var needToRetry = sendErrorIfCantRetry.call(this, video);
            if (this.isVideoSet(video) && !needToRetry) {
                return vdb.Promise.resolve();
            }
            this._element.pause();
            if (is360) {
                filterVideoUrls.call(this, video);
            }
            vdb.html5.player.video.SelectBestVideoUrl(video, isAbleToPlay.bind(this));
        }
        this._setVideoPromise = null;
        this._moduleFailed = false;
        if (!this._recovering) {
            this.cleanVideo(false);
        } else {
            vdb.dom.empty(this._element);
            this._element.setAttribute("src", "");
            this._element.removeAttribute("src");
            this._video = null;
            detachDependencies.call(this);
            if (vdb.Utils.isIE || vdb.Utils.isEdge) {
                this._videoCleaning = true;
            }
        }
        var playerDependenciesPromise = is360 ? vdb.html5.player.vrLoader.load().then(function() {
            return grabDependencies.call(this, video);
        }.bind(this)) : grabDependencies.call(this, video);
        return playerDependenciesPromise.then(function() {
            var result = [];
            for (var i = 0;i < this._currentDependencies.length;++i) {
                var module = this._currentDependencies[i].instance;
                result.push(module.setVideo(video, this._lastTime));
            }
            if (this._currentDependencies.filter(isPlayFilter).length === 0) {
                var is360ModuleUsed = moduleInUse.call(this, vdb.html5.player.video.module.Module360) || moduleInUse.call(this, vdb.html5.player.video.module.CrossDomainModule360);
                superSetVideo.call(this, video, is360ModuleUsed ? true : crossDomain);
            } else {
                this._video = video;
                if (crossDomain) {
                    this._element.setAttribute("crossorigin", "anonymous");
                } else {
                    this._element.removeAttribute("crossorigin");
                }
                this._setVideoPromise = vdb.Promise.all(result);
            }
            this._recovering = false;
        }.bind(this));
    }
    function urlProcessingRequired(video) {
        var yahooModuleParam = vdb.utils.UrlUtils.getParameterByName(YAHOO_MODULE_MACRO, vdb.utils.WindowUtil.getTopMostLocation());
        var yahooModuleRequired = vdb.Utils.parseBoolean(yahooModuleParam || vdb.ctx.getMacro(YAHOO_MODULE_MACRO));
        return!yahooModuleRequired && video.videoUrls.length !== 0 && video.metadata["yahooId"];
    }
    var LOGGER = vdb.log.getLogger("AdjectiveVideoArea");
    var YAHOO_MODULE_MACRO = vdb.constants.PlayerMacros.YAHOO_MODULE;
    return{init:function(recoverable) {
        this._super();
        initModules.call(this);
        this._currentDependencies = [];
        this._setVideoPromise = null;
        this._dependenciesReadyPromise = null;
        if (recoverable) {
            this._videoRecovery = new vdb.html5.player.video.recovery.VideoRecovery(this);
            this._videoRecovery.addEventListener(vdb.html5.player.video.recovery.VideoRecovery.FATAL_ERROR, _onFatalError.bind(this));
            this._videoRecovery.addEventListener(vdb.html5.player.video.recovery.VideoRecovery.RECOVERY, _recovery.bind(this));
        }
    }, setVideo:function(video, crossDomain) {
        LOGGER.debug("set video", video);
        if (urlProcessingRequired(video)) {
            var yahooUrlProcessor = new vdb.html5.player.video.urlProcessor.YahooUrlProcessor(video);
            this._dependenciesReadyPromise = yahooUrlProcessor.execute().then(composeVideoObject.bind(this, video, crossDomain, this._super));
        } else {
            this._dependenciesReadyPromise = composeVideoObject.call(this, video, crossDomain, this._super);
        }
    }, onEnded:function(e, keepDependencies) {
        if (this.isStarted()) {
            if (!keepDependencies) {
                detachDependencies.call(this);
            }
            this._super(e);
        }
    }, complete:function(e) {
        if (this._recovering) {
            return;
        }
        this._super(e);
    }, cleanVideo:function(keepNeeded) {
        if (this.isStarted()) {
            detachDependencies.call(this, keepNeeded);
        }
        this._super();
    }, play:function() {
        if (!this._dependenciesReadyPromise) {
            this._askedToPlay = true;
            return;
        }
        if (!this.isStarted()) {
            touchModules.call(this);
        }
        var superPlayVideo = this._super.bind(this);
        this._dependenciesReadyPromise.then(function() {
            var _this = this;
            var playVideo = function() {
                var module = _this._getActiveModule();
                if (module) {
                    _this._askedToPlay = true;
                    module.instance.play();
                } else {
                    superPlayVideo();
                }
            };
            if (this._currentDependencies.filter(isPlayFilter).length === 0) {
                playVideo();
            } else {
                this._setVideoPromise.then(playVideo);
            }
        }.bind(this));
    }, pause:function() {
        if (!this._dependenciesReadyPromise) {
            return;
        }
        var superPauseVideo = this._super.bind(this);
        this._dependenciesReadyPromise.then(function() {
            var module = this._getActiveModule();
            if (module) {
                module.instance.pause();
            }
            if (this._currentDependencies.filter(isPlayFilter).length === 0) {
                superPauseVideo();
            } else {
                this._setVideoPromise.then(superPauseVideo);
            }
        }.bind(this));
    }, seek:function(position) {
        if (!this._dependenciesReadyPromise) {
            return;
        }
        var module = this._getActiveModule();
        if (module && module.instance.seek) {
            module.instance.seek(position);
        } else {
            this._super(position);
        }
    }, isPlaying:function() {
        if (!this._dependenciesReadyPromise) {
            return this._super();
        }
        var module = this._getActiveModule();
        if (module && module.instance.isPlaying) {
            return module.instance.isPlaying();
        }
        return this._super();
    }, getCurrentTime:function() {
        var module = this._getActiveModule();
        if (module && module.instance.getCurrentTime) {
            return module.instance.getCurrentTime();
        }
        return this._super();
    }, getDuration:function() {
        var module = this._getActiveModule();
        if (module && module.instance.getDuration) {
            return module.instance.getDuration();
        }
        return this._super();
    }, setVolume:function(volume) {
        var module = this._getActiveModule();
        if (module && module.instance.setVolume) {
            return module.instance.setVolume(volume);
        }
        return this._super(volume);
    }, getVolume:function() {
        var module = this._getActiveModule();
        if (module && module.instance.getVolume) {
            return module.instance.getVolume();
        }
        return this._super();
    }, mute:function(muted) {
        var module = this._getActiveModule();
        if (module && module.instance.mute) {
            return module.instance.mute(muted);
        }
        return this._super(muted);
    }, muted:function() {
        var module = this._getActiveModule();
        if (module && module.instance.muted) {
            return module.instance.muted();
        }
        return this._super();
    }, hide:function() {
        var module = this._getActiveModule();
        if (module && module.instance.hide) {
            module.instance.hide();
        }
        return this._super();
    }, show:function() {
        var module = this._getActiveModule();
        if (module && module.instance.show) {
            module.instance.show();
        }
        return this._super();
    }, isStarted:function() {
        var module = this._getActiveModule();
        if (module && module.instance.isStarted) {
            return module.instance.isStarted();
        }
        return this._started;
    }, getOrientation:function() {
        var module = this._getActiveModule();
        if (module && module.instance.getOrientation) {
            return module.instance.getOrientation();
        }
        return this._super();
    }, touch:function() {
        this._super();
        touchModules.call(this);
    }, _getActiveModule:function() {
        return this._currentDependencies && this._currentDependencies[this._currentDependencies.length - 1] || null;
    }, loadDependencies:grabDependencies, urlProcessingRequired:urlProcessingRequired, onError:onError};
}());
vdb.html5.player.Display = function() {
    var $ = vdb.Utils;
    var _display = vdb.core.Class.extend(function() {
        function dispatchEvent(listeners, event, args) {
            var eventListeners = listeners[event];
            if (eventListeners) {
                eventListeners = $.cloneArray(eventListeners);
                for (var i = 0;i < eventListeners.length;i++) {
                    eventListeners[i].apply({}, args);
                }
            }
        }
        function addListener(listeners, event, listener) {
            var eventListeners = listeners[event];
            if (!eventListeners) {
                eventListeners = [];
                listeners[event] = eventListeners;
            }
            eventListeners.push(listener);
        }
        function removeListener(listeners, event, listener) {
            var eventListeners = listeners[event];
            if (eventListeners) {
                for (var i = 0;i < eventListeners.length;i++) {
                    if (eventListeners[i] === listener) {
                        eventListeners.splice(i, 1);
                        break;
                    }
                }
            }
        }
        function _setMidroll(video) {
            LOGGER.debug("set midroll:", video);
            this._mode = Mode.MIDROLL;
            if (!this.isSsai()) {
                this._contentArea.pause();
                _hideAreas.call(this);
                _setVideo.call(this, this._midrollArea, video);
            }
            return false;
        }
        function _setPreroll(video) {
            var prerollArea = this._prerollArea;
            LOGGER.debug("set preroll:", video);
            if (this.isSsai()) {
                prerollArea = this._contentArea;
            } else {
                this._contentArea.pause();
            }
            _hideAreas.call(this);
            if (vdb.html5.player.hasSkin) {
                this._prerollArea.removeControls();
            } else {
                this._prerollArea.addControls();
                this._prerollArea.setControls(vdb.Utils.iPhoneOS());
            }
            this._mode = Mode.PREROLL;
            _setVideo.call(this, prerollArea, video);
            return false;
        }
        var LOGGER = vdb.log.getLogger("Display");
        var Mode = vdb.html5.player.DisplayMode;
        var _setVideo = function(area, video) {
            LOGGER.debug("set video: ", video);
            this._currentArea = area;
            area.show();
            if (video) {
                if (typeof video === "string") {
                    video = new vdb.model.Video({"videoUrls":[video], "title":"Video"});
                } else {
                    if (video.length != null) {
                        video = new vdb.model.Video({"videoUrls":video, "title":"Video"});
                    }
                }
            }
            area.setVideo(video);
        };
        var _attachListener = function(event) {
            LOGGER.debug("attach internal listener for " + event);
            var self = this;
            this._contentArea.addEventListener(event, function() {
                dispatchEvent(self._contentListeners, event, arguments);
            });
            this._prerollArea.addEventListener(event, function() {
                dispatchEvent(self._adListeners, event, arguments);
            });
            this._midrollArea.addEventListener(event, function() {
                dispatchEvent(self._adListeners, event, arguments);
            });
        };
        var _attachListeners = function() {
            for (var event in vdb.html5.player.EVENTS) {
                if (Object.prototype.hasOwnProperty.call(vdb.html5.player.EVENTS, event)) {
                    _attachListener.call(this, vdb.html5.player.EVENTS[event]);
                }
            }
        };
        var _createContentEventDispatcher = function() {
            var self = this;
            return{addEventListener:function() {
                self.addContentListener.apply(self, arguments);
            }, removeEventListener:function() {
                self.removeContentListener.apply(self, arguments);
            }};
        };
        var _createAdEventDispatcher = function() {
            var self = this;
            return{addEventListener:function() {
                self.addAdListener.apply(self, arguments);
            }, removeEventListener:function() {
                self.removeAdListener.apply(self, arguments);
            }};
        };
        var _hideAreas = function() {
            this._contentArea.hide();
            this._midrollArea.hide();
            this._prerollArea.hide();
        };
        var triggerLoadEvents = function() {
            if (this._triggeredLoadEvents) {
                return;
            }
            this._contentArea.onLoad();
            this._contentArea.onLoadedMetadata();
            this._contentArea.onCanPlay();
        };
        return{init:function() {
            LOGGER.debug("created");
            this._context = vdb["getContext"](vdb.ctx.id);
            this._mode = Mode.NONE;
            this._ssai = false;
            this._contentListeners = {};
            this._contentDispatcher = _createContentEventDispatcher.call(this);
            this._adListeners = {};
            this._adDispatcher = _createAdEventDispatcher.call(this);
            this._queue = new vdb.utils.Queue;
            this._prerollArea = new vdb.html5.player.video.AdjectiveVideoArea;
            this._contentArea = new vdb.html5.player.video.AdjectiveVideoArea(true);
            this._midrollArea = new vdb.html5.player.video.AdjectiveVideoArea;
            this._currentArea = this._contentArea;
            if (!vdb.Utils.iPhoneOS()) {
                this._prerollArea.removeControls();
                this._midrollArea.removeControls();
            }
            this._contentArea.loadDependencies();
            _attachListeners.call(this);
        }, setControlsVisible:function(isVisible) {
            this._currentArea.setControls(isVisible);
        }, removeControls:function() {
            this._currentArea.removeControls();
        }, play:function() {
            LOGGER.debug("play " + this._mode);
            this._currentArea.play();
        }, isPlaying:function() {
            return this._currentArea.isPlaying();
        }, isPaused:function() {
            return this._currentArea.isPaused();
        }, isStarted:function() {
            return this._currentArea.isStarted();
        }, setVolume:function(volume) {
            LOGGER.debug("set volume:", volume);
            this._prerollArea.setVolume(volume);
            this._contentArea.setVolume(volume);
            this._midrollArea.setVolume(volume);
        }, getVolume:function() {
            return this._currentArea.getVolume();
        }, mute:function(muted) {
            LOGGER.debug(muted ? "mute" : "unmute");
            this._prerollArea.mute(muted);
            this._contentArea.mute(muted);
            this._midrollArea.mute(muted);
        }, getDuration:function() {
            return this._currentArea.getDuration();
        }, getDurationWithoutAds:function() {
            return this._currentArea.getDurationWithoutAds();
        }, getRemainingTime:function() {
            return this.getDuration() - this.getCurrentTime();
        }, getCurrentTime:function() {
            return this._currentArea.getCurrentTime();
        }, getMainAreaCurrentTime:function() {
            return this._contentArea.getCurrentTime();
        }, getCurrentPercent:function() {
            return this._currentArea.getCurrentPercent();
        }, getBuffered:function() {
            return this._currentArea.getBuffered();
        }, isMuted:function() {
            return this._currentArea.muted();
        }, seek:function(time) {
            LOGGER.debug("seek " + this._mode);
            this._currentArea.seek(time);
        }, show:function() {
            LOGGER.debug("show " + this._mode);
            this.hide();
            this._currentArea.show();
        }, hide:function() {
            LOGGER.debug("hide");
            _hideAreas.call(this);
        }, stop:function() {
            LOGGER.debug("stop " + this._mode);
            this._currentArea.stop();
        }, reset:function() {
            LOGGER.debug("reset");
            this._prerollArea.reset();
            this._contentArea.reset();
            this._midrollArea.reset();
            this.setSsai(false);
        }, pause:function() {
            LOGGER.debug("pause " + this._mode);
            this._currentArea.pause();
        }, getWidth:function() {
            return this._currentArea.getWidth();
        }, getHeight:function() {
            return this._currentArea.getHeight();
        }, addEventListener:function(event, listener) {
            addListener(this._adListeners, event, listener);
            addListener(this._contentListeners, event, listener);
        }, removeEventListener:function(event, listener) {
            removeListener(this._adListeners, event, listener);
            removeListener(this._contentListeners, event, listener);
        }, getContentEventDispatcher:function() {
            return this._contentDispatcher;
        }, getAdEventDispatcher:function() {
            return this._adDispatcher;
        }, resetContext:function() {
            if (this.isPlaying()) {
                this.pause();
            }
            this._mode = Mode.NONE;
            this._queue.next();
        }, emptyQueue:function() {
            this._queue.empty();
        }, setPreroll:function(video) {
            return this._queue.add(_setPreroll.bind(this, video));
        }, setMidroll:function(video) {
            return this._queue.add(_setMidroll.bind(this, video));
        }, getVideoHeight:function() {
            return this._currentArea ? this._currentArea.getVideoHeight() : 0;
        }, getVideoWidth:function() {
            return this._currentArea ? this._currentArea.getVideoWidth() : 0;
        }, setSsai:function(ssai) {
            LOGGER.debug("set ssai:", ssai);
            this._ssai = ssai;
        }, setAdsDuration:function(adsDuration) {
            this._contentArea.setAdsDuration(adsDuration);
        }, isAd:function() {
            return this.isPreroll() || this.isMidroll();
        }, isPreroll:function() {
            return this._mode === Mode.PREROLL;
        }, isMidroll:function() {
            return this._mode === Mode.MIDROLL;
        }, isSsai:function() {
            return this._ssai;
        }, addAdListener:function(event, listener) {
            LOGGER.debug("attach ad listener for " + event);
            addListener(this._adListeners, event, listener);
        }, removeAdListener:function(event, listener) {
            LOGGER.debug("detach ad listener for " + event);
            removeListener(this._adListeners, event, listener);
        }, removeAdListeners:function() {
            this._adListeners = {};
        }, setContent:function(video) {
            LOGGER.debug("set content:", video);
            this._contentArea.addControls();
            this._prerollArea.pause();
            this._midrollArea.pause();
            _hideAreas.call(this);
            var setContent = !(this.isSsai() && (this.isAd() || this.isStarted()));
            this._mode = Mode.CONTENT;
            if (setContent) {
                _setVideo.call(this, this._contentArea, video);
            } else {
                triggerLoadEvents.call(this);
            }
            this._triggeredLoadEvents = true;
        }, setBgColor:function(color) {
            this._prerollArea.setBgColor(color);
            this._contentArea.setBgColor(color);
            this._midrollArea.setBgColor(color);
        }, isContent:function() {
            return this._mode === Mode.CONTENT;
        }, hasAdsOrContent:function() {
            return this._mode !== Mode.NONE;
        }, addContentListener:function(event, listener) {
            LOGGER.debug("attach content listener for " + event);
            addListener(this._contentListeners, event, listener);
        }, removeContentListener:function(event, listener) {
            LOGGER.debug("detach content listener for " + event);
            removeListener(this._contentListeners, event, listener);
        }, removeContentListeners:function() {
            this._contentListeners = {};
        }, webkitEnterFullscreen:function() {
            this._currentArea.webkitEnterFullscreen();
        }, webkitExitFullscreen:function() {
            this._currentArea.webkitExitFullscreen();
        }, isWebkitFullscreen:function() {
            return this._currentArea.isWebkitFullscreen();
        }, getMainArea:function() {
            return this._contentArea;
        }, getPrerollArea:function() {
            return this._prerollArea;
        }, getElement:function() {
            return this._contentArea.getElement();
        }, getPrerollAreaElement:function() {
            return this.getPrerollArea().getElement();
        }, blockByVPAIDPreroll:function() {
            this._currentArea = this._prerollArea;
            this.show();
            this._mode = Mode.PREROLL;
            return this._currentArea;
        }, resumeContent:function() {
            this._prerollArea.pause();
            this._prerollArea.hide();
            this._midrollArea.pause();
            this._midrollArea.hide();
            this._currentArea = this._contentArea;
            this._contentArea.addControls();
            this._contentArea.show();
            this._mode = Mode.CONTENT;
            this.play();
        }, releaseMainArea:function() {
            if (this._mode !== Mode.CONTENT) {
                this._mode = Mode.NONE;
            }
        }, getOrientation:function() {
            return this._currentArea.getOrientation();
        }, touch:function() {
            this._prerollArea.touch();
            this._contentArea.touch();
            this._midrollArea.touch();
        }, appendTo:function(container) {
            this._container = container;
            this._container.appendChild(this._prerollArea.getElement());
            this._container.appendChild(this._contentArea.getElement());
            this._container.appendChild(this._midrollArea.getElement());
        }, detach:function() {
            this.removeContentListeners();
            this.removeAdListeners();
            this._container.removeChild(this._prerollArea.getElement());
            this._container.removeChild(this._contentArea.getElement());
            this._container.removeChild(this._midrollArea.getElement());
        }, getAdMediaUrl:function() {
            return this._prerollArea.getCurrentSrc() || this._midrollArea.getCurrentSrc();
        }};
    }());
    var instance;
    return{getInstance:function() {
        if (!instance) {
            instance = new _display;
            var injector = vdb.ctx.getInjector();
            injector.provideValue(vdb.enums.Dependencies.DISPLAY, instance);
        }
        return instance;
    }};
}();
vdb.html5.player.VRLoader = vdb.core.Class.extend(function() {
    var VR_URL = "js/lib/vr.js";
    return{init:function() {
        this.vrComponentsFuture = new vdb.Future;
        this.loadStarted = false;
    }, load:function() {
        if (!this.loadStarted) {
            this.loadStarted = true;
            vdb.Utils.injectScript(document, vdb.ctx.getCdnUrl(VR_URL), this.vrComponentsFuture.resolve);
        }
        return this.vrComponentsFuture.getPromise();
    }};
}());
vdb.html5.player.xdomain = {};
vdb.html5.player.xdomain.CrossDomainVideo360Deserializer = {deserializeTimeRanges:function(serialized) {
    return{length:serialized.length, start:function(i) {
        return i < this.length ? serialized[i].start : undefined;
    }, end:function(i) {
        return i < this.length ? serialized[i].end : undefined;
    }};
}};
vdb.html5.player.xdomain.BaseVideo360Adapter = vdb.EventBus.extend(function() {
    function defineProperties(obj) {
        Object.defineProperty(obj, "currentTime", {get:function() {
            return this._videoState["currentTime"];
        }, set:function(value) {
            this._setCurrentTime(value);
        }});
        Object.defineProperty(obj, "duration", {get:function() {
            return this._videoState["duration"];
        }});
        Object.defineProperty(obj, "readyState", {get:function() {
            return this._videoState["readyState"];
        }});
        Object.defineProperty(obj, "buffered", {get:function() {
            return this._videoState["buffered"];
        }});
        Object.defineProperty(obj, "paused", {get:function() {
            return this._videoState["paused"];
        }});
        Object.defineProperty(obj, "ended", {get:function() {
            return this._videoState["ended"];
        }});
        Object.defineProperty(obj, "src", {get:function() {
            return this._videoUrl;
        }});
        Object.defineProperty(obj, "muted", {set:function(value) {
            this._setMuted(value);
        }, get:function() {
            return this._isMuted();
        }});
        Object.defineProperty(obj, "volume", {set:function(value) {
            this._setVolume(value);
        }, get:function() {
            return this._getVolume();
        }});
        Object.defineProperty(obj, "playbackRate", {get:function() {
            return this._videoState["playbackRate"];
        }});
        Object.defineProperty(obj, "videoWidth", {get:function() {
            return this._videoState["videoWidth"];
        }});
        Object.defineProperty(obj, "videoHeight", {get:function() {
            return this._videoState["videoHeight"];
        }});
        Object.defineProperty(obj, "orientation", {set:function(value) {
            this._setOrientation(value);
        }, get:function() {
            return this._videoState["orientation"];
        }});
    }
    function VideoState() {
        this["volume"] = 1;
        this["muted"] = false;
        this["currentTime"] = 0;
        this["duration"] = 0;
        this["paused"] = true;
        this["ended"] = false;
        this["waiting"] = true;
        this["readyState"] = HTMLMediaElement.HAVE_NOTHING;
        this["buffered"] = Deserializer.deserializeTimeRanges({length:0});
    }
    var LOGGER = vdb.log.getLogger("BaseVideo360Adapter");
    var Deserializer = vdb.html5.player.xdomain.CrossDomainVideo360Deserializer;
    return{init:function() {
        this._super();
        this._videoState = new VideoState;
        this._imageData = document.createElement("canvas").getContext("2d").createImageData(1, 1);
        this._readyPromise = vdb.Promise.reject(new Error("not attached yet"));
        defineProperties(this);
    }, setVideo:function(videoData) {
        if (!this._container) {
            throw new Error("BaseVideo360Adapter: Unable to set video url before adding to DOM");
        }
        this._videoUrl = videoData.url;
    }, getImageData:function() {
        return this._imageData;
    }, appendTo:function(container) {
        LOGGER.debug("append to container");
        this._container = container;
    }};
}());
vdb.html5.player.xdomain.CrossDomainVideo360Adapter = vdb.html5.player.xdomain.BaseVideo360Adapter.extend(function() {
    var LOGGER = vdb.log.getLogger("CrossDomainVideo360Adapter");
    var ec = vdb.events.EventContext;
    var Deserializer = vdb.html5.player.xdomain.CrossDomainVideo360Deserializer;
    var IFRAME_360_URLS = vdb.html5.player.video.module.CrossDomainModule360.IFRAME_360_URLS;
    var utl = vdb.Utils;
    var browser = utl.browser;
    var emulateAudioPlayback = browser.isIos();
    var iframe;
    var onMessageReceived = function(event) {
        if (event.origin === this._iframeOrigin) {
            event.preventDefault();
            this._handle(event);
        } else {
            LOGGER.debug("Ignore message from " + event.origin);
        }
    };
    var injectVideoIframe = function() {
        iframe = this._container.ownerDocument.createElement("iframe");
        iframe.allowTransparency = "true";
        utl.setStyle(iframe, {position:"absolute", width:"100%", height:"100%", top:0, left:0, border:0, margin:0, zIndex:1, backgroundColor:"transparent"});
        iframe.onload = function() {
            try {
                ec.bind(iframe.contentWindow.parent, "message", onMessageReceived.bind(this)).link(this._eventContext);
                iframe.contentWindow.postMessage({"event":"ready"}, this._iframeOrigin);
            } catch (e) {
                LOGGER.error("Unable to receive messages", e);
            }
        }.bind(this);
        iframe.onerror = function(e) {
            LOGGER.error("iframe error", e);
            this._readyFuture.reject(e);
        };
        iframe.src = this._iframeUrl;
        this._container.appendChild(iframe);
    };
    var setIframeOrigin = function() {
        var parsedIframeUrl = utl.parseUrl(this._iframeUrl);
        this._iframeOrigin = parsedIframeUrl.protocol + "//" + parsedIframeUrl.hostname;
    };
    var onDeviceMotion = function(e) {
        var data = {"accelerationIncludingGravity":vdb.Utils.copy(e.accelerationIncludingGravity), "rotationRate":vdb.Utils.copy(e.rotationRate), "timeStamp":e.timeStamp};
        this._sendEvent("devicemotion", {"data":data});
    };
    var onWindowOrientationChange = function() {
        this._sendEvent("orientationchange", {"data":window["orientation"]});
    };
    var onKeyDown = function(e) {
        var data = {"keyCode":e.keyCode};
        this._sendEvent("keydown", {"data":data});
    };
    var getHandlers = function() {
        var _this = this;
        var handlers = {};
        var addPlayerEventHandlers = function() {
            handlers["ready"] = function() {
                _this._readyFuture.resolve();
            };
            handlers["disableemulatedaudio"] = function() {
                if (_this._audio) {
                    _this._audio.pause();
                    delete _this._audio;
                }
            };
        };
        var addVideoEventHandlers = function() {
            var videoEvents = ["loadstart", "loadedmetadata", "progress", "play", "pause", "timeupdate", "seeking", "seeked", "volumechange", "ended", "abort"];
            var getVideoEventHandler = function(eventName) {
                return function() {
                    _this.dispatchEvent(eventName);
                };
            };
            var i = 0;
            for (var len = videoEvents.length;i < len;++i) {
                handlers[videoEvents[i]] = getVideoEventHandler(videoEvents[i]);
            }
            handlers["waiting"] = function() {
                if (_this._audio && !_this._audio.paused) {
                    _this._audio.pause();
                }
                _this.dispatchEvent("waiting");
            };
            handlers["playing"] = function() {
                _this.dispatchEvent("playing");
                if (_this._audio && _this._audio.paused && !_this._audioMuted) {
                    LOGGER.debug("resume audio");
                    _this._audio.currentTime = _this._videoState["currentTime"];
                    _this._audio.play();
                }
            };
            handlers["error"] = function(message) {
                LOGGER.error("iframe error: " + message["error"]);
                _this.dispatchEvent("error");
            };
        };
        var addMouseEventHandlers = function() {
            var getContainer = function() {
                return _this._container;
            };
            var getDocument = function() {
                return _this._container && _this._container.ownerDocument;
            };
            var mouseEvents = [{event:"mouseup", getTarget:getDocument}, {event:"mousemove", getTarget:getContainer}, {event:"mouseover", getTarget:getContainer}, {event:"mouseout", getTarget:getDocument}, {event:"touchstart", getTarget:getContainer}, {event:"touchend", getTarget:getDocument}];
            var getMouseEventHandler = function(mouseEvent) {
                return function() {
                    var event = document.createEvent("Events");
                    var target = mouseEvent.getTarget();
                    if (target) {
                        event.initEvent(mouseEvent.event, true, true);
                        target.dispatchEvent(event);
                    }
                };
            };
            var i = 0;
            for (var len = mouseEvents.length;i < len;++i) {
                handlers[mouseEvents[i].event] = getMouseEventHandler(mouseEvents[i]);
            }
        };
        var addVrEventHandlers = function() {
            var VrEvents = vdb["vr"]["Events"];
            var outboundEvents = _this._vrEventProxy.getOutboundEvents();
            var event;
            handlers[VrEvents["MOVED"]] = function(e) {
                _this._videoState["orientation"] = e && e["data"];
            };
            for (event in outboundEvents) {
                if (Object.prototype.hasOwnProperty.call(outboundEvents, event)) {
                    handlers[event] = function(data) {
                        _this._vrEventProxy.notifyHandler(data);
                    };
                }
            }
        };
        addPlayerEventHandlers();
        addVideoEventHandlers();
        addMouseEventHandlers();
        addVrEventHandlers();
        return handlers;
    };
    var on360Event = function(eventName, e) {
        this._sendEvent(eventName, e && e["data"]);
    };
    return{init:function(muted) {
        LOGGER.debug("init");
        this._super();
        this._eventContext = ec.empty();
        this._vrEventProxy = new vdb.html5.player.VrEventProxy(null, this._eventContext, on360Event.bind(this));
        this._handlers = getHandlers.call(this);
        this._audioMuted = emulateAudioPlayback && (vdb.ctx.playbackMode === vdb.enums.player.PlaybackMode.AUTOPLAY || muted);
    }, _setCurrentTime:function(time) {
        LOGGER.debug("currentTime=" + time);
        if (this._audio) {
            if (!this._audio.paused) {
                LOGGER.debug("pause audio");
                this._audio.pause();
            }
            this._audio.currentTime = time;
        }
        this._sendEvent("seek", {"time":time});
    }, setVideo:function(videoData, audio) {
        this._super(videoData);
        var url = videoData.url;
        var parsedUrl = utl.parseUrl(url);
        var videoOrigin = parsedUrl.protocol + "//" + parsedUrl.hostname;
        if (emulateAudioPlayback) {
            this._audio = audio;
            this._audio.src = url;
            this._audio.load();
        }
        this._iframeUrl = IFRAME_360_URLS[videoOrigin];
        if (!this._iframeUrl) {
            var pattern = new RegExp("(.*)." + "cdn.aolon.com".replace(/\./g, "\\."));
            var matches = parsedUrl.hostname.match(pattern);
            if (matches) {
                this._iframeUrl = parsedUrl.protocol + "//" + IFRAME_360_URLS.LOWLANDER_DOMAIN.replace("{bcid}", matches[1]);
            }
        }
        if (!this._iframeUrl) {
            this._iframeUrl = parsedUrl.protocol + "//" + IFRAME_360_URLS.PROXY_DOMAIN;
            setIframeOrigin.call(this);
            url = this._iframeOrigin + "/serve?url=" + encodeURIComponent(url);
        } else {
            setIframeOrigin.call(this);
        }
        this._iframeUrl += "?e=dev" + "&v=" + vdb.version() + "&log=" + (vdb.log.Logger.getLevel() === 0) + "&seek=" + (browser.isIos() && +(utl.iPhoneOS() || utl.iPadOS()) < 10) + "&ios=" + browser.isIos() + "&ie=" + utl.isIE;
        this._readyFuture = new vdb.Future;
        this._readyPromise = this._readyFuture.getPromise();
        injectVideoIframe.call(this);
        this._bindEvents();
        var player = vdb.ctx.playerAPI.player;
        this._sendEvent("init", {"url":url, "projectionType":videoData.projectionType, "tilt":videoData.tilt, "centeredFishEye":vdb.ctx.getMacro(vdb.constants.PlayerMacros.CENTEREDFISHEYE), "fishEyeAngle":vdb.ctx.getMacro(vdb.constants.PlayerMacros.FISHEYEANGLE), "windowOrientation":window["orientation"], "customColor":player && player.getControlsCustomColor()});
        this.dispatchEvent("volumechange");
        return this._readyPromise;
    }, _setOrientation:function(orientation) {
        this._sendEvent("orientation", {"value":orientation});
    }, _setMuted:function(muted) {
        if (this._audio) {
            if (this._audioMuted !== muted) {
                this._audioMuted = muted;
                if (muted) {
                    this._audio.pause();
                } else {
                    if (!this._videoState["waiting"] && !this._videoState["paused"]) {
                        this._audio.currentTime = this._videoState["currentTime"];
                        this._audio.play();
                    }
                }
                this.dispatchEvent("volumechange");
            }
        } else {
            this._sendEvent("muted", {"value":muted});
        }
    }, hide:function() {
        iframe.style.visibility = "hidden";
        iframe.style.display = "none";
    }, show:function() {
        iframe.style.visibility = "";
        iframe.style.display = "block";
    }, _isMuted:function() {
        return this._audio ? this._audioMuted : this._videoState["muted"];
    }, _setVolume:function(volume) {
        if (this._audio) {
            this._audio.volume = volume;
            this._setMuted(!volume);
        } else {
            this._sendEvent("volume", {"value":volume});
        }
    }, _getVolume:function() {
        return this._audio ? this._audio.volume : this._videoState["volume"];
    }, load:function() {
        this._readyPromise.then(function() {
            this._sendEvent("load");
        }.bind(this));
        if (this._audio) {
            this._audio.load();
        }
    }, play:function() {
        LOGGER.debug("play");
        this._sendEvent("play");
    }, pause:function() {
        LOGGER.debug("pause");
        this._sendEvent("pause");
        if (this._audio) {
            this._audio.pause();
        }
    }, removeFromParent:function() {
        if (this._readyPromise) {
            this._readyPromise.then(function() {
                utl.removeFromParent(iframe);
            });
            this._readyPromise = vdb.Promise.reject(new Error("detached"));
            this._eventContext.unbind();
        }
    }, _send:function(message) {
        this._readyPromise.then(function() {
            iframe.contentWindow.postMessage(message, this._iframeOrigin);
        }.bind(this))["catch"](function(e) {
            LOGGER.error("Unable to send message", message, e);
        });
    }, _sendEvent:function(name, data) {
        var message = data || {};
        message["type"] = name;
        this._send(message);
    }, _bindEvents:function() {
        ec.bind(window, "devicemotion", onDeviceMotion.bind(this)).link(this._eventContext);
        ec.bind(window, "orientationchange", onWindowOrientationChange.bind(this)).link(this._eventContext);
        ec.bind(document, "keydown", onKeyDown.bind(this)).link(this._eventContext);
    }, _handle:function(event) {
        var eventData = event.data;
        var eventName = eventData["type"];
        var handler = this._handlers[eventName];
        if (eventData["videoData"]) {
            this._handleVideoProperties(eventData["videoData"]);
        }
        if (handler) {
            handler.call(this, eventData);
        }
    }, _handleVideoProperties:function(videoData) {
        for (var p in videoData) {
            if (Object.prototype.hasOwnProperty.call(videoData, p)) {
                var deserializer = this._deserializers[p];
                this._videoState[p] = deserializer ? deserializer(videoData[p]) : videoData[p];
            }
        }
    }, _deserializers:{"buffered":Deserializer.deserializeTimeRanges.bind(Deserializer)}};
}());
vdb.html5.RelatedLoader = vdb.core.Class.extend(function() {
    function fetchFromPlacement(video) {
        var parameters = vdb.ctx.getParameters();
        var relatedPlacementUrl = vdb.ctx.urls.getRelatedUrl(video["videoId"], parameters["pid"], parameters["bcid"]);
        vdb.ajax.get(relatedPlacementUrl, null, onLoaded.bind(this), _onFail.bind(this));
    }
    function _onFail() {
        LOGGER.warn("Can't load related videos");
        this.callback();
    }
    function onLoaded(response) {
        this.handleVideos.call(this, response.data["videos"]);
    }
    function handleVideos(videos) {
        var bid = new vdb.model.Bid({"id":"", "videos":videos}, this.context);
        this.callback(bid);
    }
    var LOGGER = vdb.log.getLogger("RelatedLoader");
    return{init:function(callback, context) {
        this.callback = callback;
        this.context = context;
    }, fetch:function(video) {
        var fetched = fetchFromPlacement.call(this, video);
    }, handleVideos:handleVideos};
}());
vdb.html5.RelatedPlaylistLoader = vdb.html5.RelatedLoader.extend(function() {
    function handleVideos(videos) {
        if (videos && videos.length > 0) {
            var singleVideoList = this.playerController.getPlayList().getVideos();
            var bid = {"id":"", "videos":singleVideoList.concat(videos)};
            this.playerController.setPlaylist(bid);
            if (!this._keepVideosToPlay) {
                this.playerController.setVideosToPlay(bid["videos"].length);
            }
        } else {
            this.callback();
        }
    }
    return{init:function(playerController, callback, keepVideosToPlay) {
        this.playerController = playerController;
        this._keepVideosToPlay = keepVideosToPlay;
        this._super(callback);
    }, handleVideos:handleVideos};
}());
vdb.ssai = {};
vdb.ssai.SsaiEventsEnum = {IMPRESSION:"impressions", CREATIVE_VIEW:"creativeViews", START:"starts", MIDPOINT:"midpoints", FIRST_QUARTILE:"firstquartiles", THIRD_QUARTILE:"thirdquartiles", COMPLETE:"completes", MUTE:"mutes", UNMUTE:"unmutes", PAUSE:"pauses", REWIND:"rewinds", RESUME:"resumes", FULLSCREEN:"fullscreens", EXPAND:"expands", COLLAPSE:"collapses", ACCEPT_INVITATION:"acceptInvitations", CLOSE:"closes", SKIP:"skips", CLICK:"clicks"};
vdb.ssai.PreplayParser = vdb.core.Class.extend(function() {
    var VastEvents = vdb.enums.VastEvents;
    var SsaiEventsEnum = vdb.ssai.SsaiEventsEnum;
    var eventsMapper = {IMPRESSION:"IMPRESSION", CREATIVE_VIEW:"CREATIVE_VIEW", START:"START", MIDPOINT:"MIDPOINT", FIRST_QUARTILE:"FIRST_QUARTILE", THIRD_QUARTILE:"THIRD_QUARTILE", COMPLETE:"COMPLETE", MUTE:"MUTE", UNMUTE:"UNMUTE", PAUSE:"PAUSE", REWIND:"REWIND", RESUME:"RESUME", FULLSCREEN:"FULLSCREEN", EXPAND:"EXPAND", COLLAPSE:"COLLAPSE", ACCEPT_INVITATION:"ACCEPT_INVITATION", CLOSE:"CLOSE", SKIP:"SKIP", CLICK:"CLICK"};
    var ADS_TYPE = {LINEAR:"linear"};
    var AdType = vdb.enums.AdType;
    var $ = vdb.Utils;
    var parseEvents = function(events, arr, eventEnumKey) {
        (events[SsaiEventsEnum[eventEnumKey]] || []).forEach(function(url) {
            arr.push({url:url, type:VastEvents[eventEnumKey]});
        });
    };
    var parseTrackingEvents = function(events, trackingEvents) {
        parseEvents(events, trackingEvents, eventsMapper.START);
        parseEvents(events, trackingEvents, eventsMapper.FIRST_QUARTILE);
        parseEvents(events, trackingEvents, eventsMapper.MIDPOINT);
        parseEvents(events, trackingEvents, eventsMapper.THIRD_QUARTILE);
        parseEvents(events, trackingEvents, eventsMapper.COMPLETE);
        parseEvents(events, trackingEvents, eventsMapper.MUTE);
        parseEvents(events, trackingEvents, eventsMapper.UNMUTE);
        parseEvents(events, trackingEvents, eventsMapper.PAUSE);
        parseEvents(events, trackingEvents, eventsMapper.REWIND);
        parseEvents(events, trackingEvents, eventsMapper.RESUME);
        parseEvents(events, trackingEvents, eventsMapper.FULLSCREEN);
        parseEvents(events, trackingEvents, eventsMapper.EXPAND);
        parseEvents(events, trackingEvents, eventsMapper.COLLAPSE);
        parseEvents(events, trackingEvents, eventsMapper.ACCEPT_INVITATION);
        parseEvents(events, trackingEvents, eventsMapper.CLOSE);
        parseEvents(events, trackingEvents, eventsMapper.SKIP);
        parseEvents(events, trackingEvents, eventsMapper.CLICK);
    };
    var parseAdBreakImpression = function(inlineAd, adIndex, adsBreakIndex) {
        if (adIndex > 0) {
            return;
        }
        var adBreakImpression = this.breaks[adsBreakIndex]["events"][SsaiEventsEnum.IMPRESSION];
        if (adBreakImpression) {
            inlineAd.impressions = inlineAd.impressions.concat(adBreakImpression);
        }
    };
    var getBreakOffset = function(adsBreakIndex) {
        var breakOffset = $.find(this.breakOffsets, function(offset) {
            return offset["index"] === adsBreakIndex;
        });
        return breakOffset ? breakOffset["timeOffset"] : null;
    };
    var getPlaceholderOffset = function(adsBreakIndex, adIndex) {
        return $.find(this.placeholderOffsets, function(placeholderOffset) {
            return placeholderOffset["breaksIndex"] === adsBreakIndex && placeholderOffset["adsIndex"] === adIndex;
        });
    };
    var parseResource = function(resources, companion) {
        var resource = {mimeType:companion["mimeType"], value:companion["creative"]};
        resources.push(resource);
    };
    var parseCompanionModel = function(companions, companion) {
        var companionModel = {resources:[]};
        companionModel.width = companion["width"];
        companionModel.height = companion["height"];
        companionModel.expandedWidth = companion["expandedWidth"];
        companionModel.expandedHeight = companion["expandedHeight"];
        companionModel.adSlotId = companion["adSlotId"];
        parseResource(companionModel.resources, companion);
        companions.push(companionModel);
    };
    var parseCompanionCreative = function(companions, creatives) {
        if (companions.length === 0) {
            return;
        }
        var companionCreative = {companions:[]};
        companions.forEach(function(companion) {
            parseCompanionModel(companionCreative.companions, companion);
        });
        creatives.push(companionCreative);
    };
    var parseLinearCreative = function(playUrl, ad, creatives) {
        var linearCreative = {};
        var events = ad["events"];
        var clickThrough = events["clickthroughs"];
        if (clickThrough) {
            linearCreative.clickThroughUrl = {url:clickThrough[0]};
        }
        creatives.push(linearCreative);
    };
    var parseCreatives = function(playUrl, ad, inlineAd) {
        parseLinearCreative(playUrl, ad, inlineAd.creatives);
        parseCompanionCreative(ad["companions"], inlineAd.creatives);
    };
    var parseInlineAd = function(ad, breakTimeOffset, adsBreakIndex, adIndex) {
        var inlineAd = {duration:ad["duration"], durationOnVideo:ad["duration"], breakTimeOffset:breakTimeOffset, timeOffset:this.lastAd && this.lastAd.timeOffset || breakTimeOffset || 0, position:breakTimeOffset > 0 ? AdType.MIDROLL : AdType.PREROLL, creatives:[], impressions:[]};
        if (ad["apiFramework"] && ad["apiFramework"].toLowerCase() === vdb.enums.ApiType.VPAID) {
            inlineAd.durationOnVideo = getPlaceholderOffset.call(this, adsBreakIndex, adIndex)["endTime"] - inlineAd.timeOffset;
        }
        inlineAd.timeOffsetEnd = inlineAd.timeOffset + inlineAd.durationOnVideo;
        parseCreatives(this.playUrl, ad, inlineAd);
        parseEvents(ad["events"], inlineAd.impressions, eventsMapper.IMPRESSION);
        parseAdBreakImpression.call(this, inlineAd, adIndex, adsBreakIndex);
        return inlineAd;
    };
    var parseAds = function(adsBreak, adsBreakIndex) {
        var ads = adsBreak["ads"];
        var timeOffset = getBreakOffset.call(this, adsBreakIndex) || adsBreak["timeOffset"] || 0;
        this.lastAd = null;
        ads.forEach(function(ad, adIndex) {
            var inlineAd = parseInlineAd.call(this, ad, timeOffset, adsBreakIndex, adIndex);
            this.ads.push(inlineAd);
            this.lastAd = inlineAd;
        }.bind(this));
    };
    var parseAdBreaks = function() {
        this.ads = [];
        this.breaks.forEach(function(adsBreak, adsBreakIndex) {
            if (adsBreak["type"] !== "linear") {
                return;
            }
            parseAds.call(this, adsBreak, adsBreakIndex);
        }.bind(this));
    };
    var parseMidrollTiming = function() {
        this.midrollTiming = [];
        if (this.breaks.length === 0) {
            return;
        }
        var video = this._environment.getCurrentVideo();
        var isLive = video && video.metadata["live"];
        var adsBreak;
        var breakOffset;
        var timeOffset;
        for (var i = 0;i < this.breaks.length;i++) {
            breakOffset = this.breakOffsets[i];
            adsBreak = breakOffset ? this.breaks[breakOffset["index"]] : this.breaks[i];
            timeOffset = adsBreak["timeOffset"];
            if ((timeOffset !== 0 || isLive) && adsBreak["type"] === ADS_TYPE.LINEAR && adsBreak["duration"]) {
                this.midrollTiming.push(timeOffset);
            }
        }
    };
    var getFormattedTime = function(time) {
        var sec_num = time;
        var hours = Math.floor(sec_num / 3600);
        var minutes = Math.floor(sec_num % 3600 / 60);
        var seconds = Math.floor(sec_num % 60);
        if (hours < 10) {
            hours = "0" + hours;
        }
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        if (seconds < 10) {
            seconds = "0" + seconds;
        }
        return hours + ":" + minutes + ":" + seconds;
    };
    return{init:function(preplayJson, environment) {
        this.json = preplayJson;
        this.playUrl = preplayJson["playURL"];
        this._environment = environment;
        this.parse(preplayJson["ads"] || {});
    }, parse:function(ads) {
        this.breakOffsets = ads["breakOffsets"] || [];
        this.placeholderOffsets = ads["placeholderOffsets"] || [];
        this.breaks = ads["breaks"] || [];
        parseAdBreaks.call(this);
        parseMidrollTiming.call(this);
    }, filterAdsByBreakTimeOffset:function(breakTimeOffset) {
        return this.ads.filter(function(ad) {
            return ad.breakTimeOffset === breakTimeOffset;
        });
    }, getTotalAdsDuration:function() {
        return this.ads.reduce(function(totalAdsDuration, ad) {
            return totalAdsDuration + ad.durationOnVideo;
        }, 0);
    }, getAdsPassedTime:function(time) {
        return this.ads.reduce(function(adsPassedTime, ad) {
            return adsPassedTime + (time >= ad.timeOffset ? ad.durationOnVideo : 0);
        }, 0);
    }, getFormattedMidrollTiming:function() {
        var midrollTimings = [];
        this.midrollTiming.forEach(function(midrollTiming) {
            midrollTimings.push(getFormattedTime(midrollTiming));
        });
        return midrollTimings.join(";");
    }, getUrlPrefix:function() {
        return this.json["prefix"];
    }, getSessionId:function() {
        return this.json["sid"];
    }, getMidrollTiming:function() {
        return this.midrollTiming;
    }};
}());
vdb.ssai.SsaiPingEventsEnum = {START:"start", SEEK:"seek", PING_MIDROLL_UPDATE:"pingMidrollUpdate"};
vdb.ssai.PingApiHandler = vdb.core.Class.extend(function() {
    function attachPingEvents() {
        this._eventGroup = EventContext.group(EventContext.bind(this._environment, Environment.VIDEO_START, onVideoStart.bind(this)), EventContext.bind(this._environment, Environment.VIDEO_END, onEnd.bind(this)), EventContext.bind(this._environment, Environment.VIDEO_SEEKSTART, onSeekStart.bind(this)), EventContext.bind(this._environment, Environment.VIDEO_SEEKEND, onSeekEnd.bind(this)), EventContext.bind(this._environment, Environment.VIDEO_TIMEUPDATE, this.onTimeUpdate.bind(this)));
    }
    function ping(data, forcePush) {
        var video = this._environment.getCurrentVideo();
        var isLive = video && video.metadata["live"];
        setTimeout(function() {
            data["v"] = PING_VERSION;
            data["pt"] = data["ev"] === SsaiPingEventsEnum.START && isLive ? 0 : this._display.getCurrentTime();
            pushPingUrl.call(this, this._pingUrl + "?" + vdb.Utils.serialize(data), forcePush);
        }.bind(this), 100);
    }
    function pushPingUrl(url, forcePush) {
        clearTimeout(this._seekTimeout);
        if (forcePush) {
            this._pingQueue.push(url);
            callPing.call(this);
        } else {
            this._seekTimeout = setTimeout(function() {
                this._pingQueue.push(url);
                callPing.call(this);
            }.bind(this), 100);
        }
    }
    function callPing() {
        if (this._pingCall || this._pingQueue.length === 0) {
            return;
        }
        this._pingCall = vdb.ajax.get(this._pingQueue.shift(), null, onCallPingSuccess.bind(this), onCallPingFail.bind(this));
    }
    function onCallPingSuccess(response) {
        var data = response.data;
        var nextTime = data && data["next_time"];
        var ads = data && data["ads"];
        if (ads) {
            var offset;
            var newAdBreak;
            var breaks = ads["breaks"];
            for (var i = 0;i < breaks.length;i++) {
                offset = breaks[i]["timeOffset"];
                if (vdb.Utils.indexOf(this._lastTimeOffsets, offset) === -1) {
                    this._lastTimeOffsets.push(breaks[i]["timeOffset"]);
                    newAdBreak = true;
                }
            }
            if (newAdBreak && this._onPingMidrollUpdate) {
                this._onPingMidrollUpdate({ads:ads});
            }
        }
        if (!nextTime || nextTime === -1) {
            return;
        }
        this._pingCall = null;
        this._seekStartTime = null;
        this._nextPingTime = nextTime;
        callPing.call(this);
    }
    function onCallPingFail() {
        this._pingCall = null;
        this._nextPingTime = null;
        callPing.call(this);
    }
    function onVideoStart() {
        this._pingQueue = [];
        ping.call(this, {"ev":SsaiPingEventsEnum.START});
    }
    function onSeekStart(event) {
        if (this._seekStartTime) {
            return;
        }
        this._seekStartTime = event.data.currentTime;
    }
    function onSeekEnd() {
        ping.call(this, {"ev":SsaiPingEventsEnum.SEEK, "ft":this._seekStartTime}, true);
    }
    function onEnd() {
        if (this._eventGroup) {
            this._eventGroup.unbind();
            this._eventGroup = null;
        }
    }
    var Environment = vdb.events.EnvironmentEvent;
    var SsaiPingEventsEnum = vdb.ssai.SsaiPingEventsEnum;
    var EventContext = vdb.events.EventContext;
    var PING_VERSION = 3;
    return{init:function(urlPrefix, sessionId, display, injector) {
        this._lastTimeOffsets = [];
        this._display = display;
        this._pingUrl = urlPrefix + "/session/ping/" + sessionId + ".json";
        this._injector = injector;
        this._environment = injector.resolveSync(vdb.enums.Dependencies.ENVIRONMENT);
        attachPingEvents.call(this);
    }, onTimeUpdate:function() {
        if (this._nextPingTime && this._display.getCurrentTime() > this._nextPingTime) {
            this._nextPingTime = null;
            ping.call(this, {});
        }
    }, onFinished:function(event) {
        this._seekStartTime = event.data.currentTime;
    }, onPingMidrollUpdate:function(callback) {
        this._onPingMidrollUpdate = callback;
    }};
}());
vdb.ssai.SsaiAdEntriesLoader = vdb.core.Class.extend(function() {
    function getLiveChannel() {
        if (this._parsedPaths && this._parsedVideoUrl.pathname.indexOf("/channel") === 0) {
            return "channel/";
        }
        return "";
    }
    function getAssetId() {
        if (this._parsedVideoUrl) {
            return utl.getFilename(this._parsedVideoUrl.pathname, false);
        }
        return "";
    }
    function getPlaybackParameters() {
        return this._parsedVideoUrl && this._parsedVideoUrl.query || "";
    }
    function createAdEntries() {
        var prerolls = this._ssaiParser.filterAdsByBreakTimeOffset(0);
        if (prerolls.length > 0) {
            this._adEntries.push({vastAds:prerolls, type:AdType.PREROLL, costPerImpression:0});
        }
        this._midrollTiming.forEach(function(midrollTiming) {
            var midrolls = this._ssaiParser.filterAdsByBreakTimeOffset(midrollTiming);
            this._adEntries.push({vastAds:midrolls, type:AdType.MIDROLL, costPerImpression:0, midrollTiming:Math.floor(midrollTiming)});
        }.bind(this));
    }
    function updateMidrollsEntries() {
        this._midrollTiming.forEach(function(midrollTiming) {
            var midrolls = this._ssaiParser.filterAdsByBreakTimeOffset(midrollTiming);
            this._adEntries.push({vastAds:midrolls, type:AdType.MIDROLL, costPerImpression:0, midrollTiming:Math.floor(midrollTiming)});
        }.bind(this));
    }
    function initPingApi() {
        if (this._playbackParameters.indexOf("ad.cping=1") === -1) {
            return;
        }
        this.pingHandler = new vdb.ssai.PingApiHandler(this._ssaiParser.getUrlPrefix(), this._ssaiParser.getSessionId(), this._display, this._injector);
        this.pingHandler.onPingMidrollUpdate(function(data) {
            this._display.setAdsDuration(this._ssaiParser.getTotalAdsDuration());
            this._ssaiParser.parse(data.ads);
            this._midrollTiming = this._ssaiParser.getMidrollTiming();
            updateMidrollsEntries.call(this);
        }.bind(this));
    }
    function onRequestSuccess(response) {
        this._response = response.data;
        this._ssaiParser = new vdb.ssai.PreplayParser(this._response, this._environment);
        this._adsConfig.updateMidrollTiming(this.getFormattedMidrollTiming());
        initPingApi.call(this);
        this._display.setSsai(true);
        this._video.ssaiUrl = this._ssaiParser.playUrl;
        this._display.setAdsDuration(this._ssaiParser.getTotalAdsDuration());
        this._midrollTiming = this._ssaiParser.getMidrollTiming();
        createAdEntries.call(this);
        onLoaded.call(this);
    }
    function onLoaded() {
        this._loadedFuture.resolve(this._adEntries);
    }
    function onRequestFail() {
        this._loadedFuture.reject();
    }
    function needDSPreplay() {
        var enabledByAdsConfig = this._adsConfig.isSsai();
        var isUplynkVideo = utl.isUplynk(this._videoUrl);
        var isContentBased = this._adsConfig.getAdStrategy() === vdb.enums.AdStrategyType.CONTENT_BASED;
        var noVLSMacro = !this._config.getMacro(vdb.constants.PlayerMacros.VLS_AD);
        return enabledByAdsConfig && noVLSMacro && isUplynkVideo && isContentBased;
    }
    function onPreplayFinished(response) {
        var urls = response.data["urls"] || [];
        var url;
        for (var i = 0;i < urls.length;++i) {
            if (utl.isUplynk(urls[i])) {
                url = urls[i];
                break;
            }
        }
        if (!url) {
            onRequestFail.call(this);
            return;
        }
        getUplynkPreplay.call(this);
    }
    function updateVideoValues() {
        if (this._video) {
            var hlsUrlIndex = vdb.Utils.getHlsUrlIndex(this._video);
            this._videoUrl = this._video.videoUrls[hlsUrlIndex];
            this._parsedVideoUrl = utl.parseUrl(this._videoUrl);
            this._playbackParameters = getPlaybackParameters.call(this);
            this._assetId = getAssetId.call(this);
        }
    }
    function getDSPreplay() {
        var requestParameters = this._paramsCombine.getDSPreplayParams();
        var dsPreplayUrl = this._urls.getDSPreplayUrl(this._video.id, requestParameters);
        dsPreplayUrl = dsPreplayUrl.replace(this._urls.getPreplayChannelPlaceholder(), getLiveChannel.call(this));
        vdb.ajax.get(dsPreplayUrl, null, onPreplayFinished.bind(this), onRequestFail.bind(this));
    }
    function getUplynkPreplay() {
        updateVideoValues.call(this);
        var uplynkUrl = this._urls.getBaseUrls("hls");
        vdb.ajax.get(uplynkUrl + "/preplay/" + getLiveChannel.call(this) + this._assetId + ".json" + this._playbackParameters, null, onRequestSuccess.bind(this), onRequestFail.bind(this));
    }
    function resolveDependencies() {
        this._config = this._injector.resolveSync(Dependencies.CONFIG);
        this._paramsCombine = this._injector.resolveSync(Dependencies.PARAMETERS_COMBINE);
        this._urls = this._injector.resolveSync(Dependencies.URLS);
        this._environment = this._injector.resolveSync(Dependencies.ENVIRONMENT);
        this._display = this._injector.resolveSync(Dependencies.DISPLAY);
    }
    var LOGGER = vdb.log.getLogger("SsaiAdEntriesLoader");
    var utl = vdb.Utils;
    var Dependencies = vdb.enums.Dependencies;
    var AdType = vdb.enums.AdType;
    return{init:function(injector, adsConfig) {
        LOGGER.debug("init");
        this._injector = injector;
        this._adsConfig = adsConfig;
        this._adEntries = [];
        resolveDependencies.call(this);
    }, load:function(type) {
        LOGGER.debug("loading SSAI");
        this._video = this._environment.getCurrentVideo();
        this._loadedFuture = new vdb.Future;
        updateVideoValues.call(this);
        if (type === AdType.MIDROLL || type === AdType.OVERLAY) {
            this._loadedFuture.resolve(this._adEntries);
        } else {
            if (needDSPreplay.call(this)) {
                getDSPreplay.call(this);
            } else {
                getUplynkPreplay.call(this);
            }
        }
        return this._loadedFuture.getPromise();
    }, getAdsPassedTime:function(time) {
        return this._ssaiParser && this._ssaiParser.getAdsPassedTime(time) || 0;
    }, getFormattedMidrollTiming:function() {
        return this._ssaiParser && this._ssaiParser.getFormattedMidrollTiming();
    }, getEntry:function(type, time) {
        type = type || AdType.PREROLL;
        var filtered = [];
        for (var i = 0;i < this._adEntries.length;i++) {
            var entry = this._adEntries[i];
            if (entry.type === type && (!time || entry.midrollTiming === time)) {
                filtered.push(entry);
            }
        }
        return filtered && filtered[0];
    }, onTimeUpdate:function() {
        if (this.pingHandler) {
            this.pingHandler.onTimeUpdate();
        }
    }, onFinished:function(event) {
        if (this.pingHandler) {
            this.pingHandler.onFinished(event);
        }
    }};
}());
vdb.ssai.SsaiAdManager = vdb.EventBus.extend(function() {
    function getCurrentTime() {
        return this.display.getCurrentTime() - this.entry.vastAds[0].timeOffset;
    }
    function getDuration() {
        return this.entry.vastAds[0].duration;
    }
    function checkVideoTime() {
        var percentage = getCurrentTime.call(this) / getDuration.call(this);
        if (percentage >= 1) {
            this.onVideoEnd();
        }
    }
    function trackSsaiEvent(event) {
        var list = this.entry.vastAds[0][event] || [];
        for (var i = 0;i < list.length;i++) {
            this.tracker.callExternalPixel(list[i].url);
        }
    }
    function onVideoStart() {
        if (this.entry) {
            trackSsaiEvent.call(this, SsaiEventsEnum.IMPRESSION);
            this.dispatchEvent(new AdEvent(AdEvent.AD_STARTED, this.entry.type));
        }
    }
    function onClick() {
        if (this.entry) {
            this.dispatchEvent(new AdEvent(AdEvent.AD_CLICK, this.entry.type));
        }
    }
    function onResume() {
        if (this.entry) {
            this.dispatchEvent(new AdEvent(AdEvent.AD_RESUMED, this.entry.type));
        }
    }
    function onPause() {
        if (this.entry) {
            this.dispatchEvent(new AdEvent(AdEvent.AD_PAUSED, this.entry.type));
        }
    }
    function onTimeUpdate() {
        if (this.entry) {
            var currentTime = getCurrentTime.call(this);
            var duration = getDuration.call(this);
            this.dispatchEvent(new AdEvent(AdEvent.AD_TIMEUPDATE, this.entry && this.entry.type, {progressPercent:currentTime / duration * 100, timeRemaining:duration - currentTime}));
            this.loader.onTimeUpdate();
            checkVideoTime.call(this);
        }
    }
    function onWaiting() {
        if (this.entry) {
            this.dispatchEvent(new AdEvent(AdEvent.AD_WAITING, this.entry.type));
        }
    }
    function onVolumeChanged() {
        if (this.entry) {
            this.dispatchEvent(new AdEvent(AdEvent.AD_VOLUME_CHANGED, this.entry.type));
        }
    }
    function seekToStart() {
        this.display.seek(this.entry.vastAds[0].timeOffset || -1);
    }
    var AdEvent = vdb.events.AdEvent;
    var SsaiEventsEnum = vdb.ssai.SsaiEventsEnum;
    var AdType = vdb.enums.AdType;
    var EventContext = vdb.events.EventContext;
    var VideoEvent = vdb.events.VideoEvent;
    var Dependencies = vdb.enums.Dependencies;
    return{init:function(injector, adConfig) {
        this._super();
        this.config = injector.resolveSync(Dependencies.CONFIG);
        this.environment = injector.resolveSync(Dependencies.ENVIRONMENT);
        this.tracker = injector.resolveSync(Dependencies.PIXEL_TRACKER);
        this.display = injector.resolveSync(Dependencies.DISPLAY);
        this.loader = new vdb.ssai.SsaiAdEntriesLoader(injector, adConfig);
        this.eventContext = EventContext.group(EventContext.bind(this.display, VideoEvent.VIDEO_CLICK, onClick.bind(this)), EventContext.bind(this.display, VideoEvent.VIDEO_PAUSE, onPause.bind(this)), EventContext.bind(this.display, VideoEvent.VIDEO_RESUME, onResume.bind(this)), EventContext.bind(this.display, VideoEvent.VIDEO_STARTED, onVideoStart.bind(this)), EventContext.bind(this.display, VideoEvent.VIDEO_TIMEUPDATE, onTimeUpdate.bind(this)), EventContext.bind(this.display, VideoEvent.VIDEO_VOLUME_CHANGED,
            onVolumeChanged.bind(this)), EventContext.bind(this.display, VideoEvent.VIDEO_WAITING, onWaiting.bind(this)));
    }, loadAds:function(event, callback) {
        function firePlayReady(rejected) {
            if (rejected) {
                this.dispatchEvent(new AdEvent(AdEvent.AD_ERROR));
            } else {
                this.dispatchEvent(new AdEvent(AdEvent.AD_LOADED));
            }
            if (callback) {
                setTimeout(callback, 0);
            }
        }
        return this.loader.load(event && event["type"]).then(firePlayReady.bind(this, false))["catch"](firePlayReady.bind(this, true));
    }, startAds:function(type, time) {
        type = type || AdType.PREROLL;
        if (this.entry) {
            vdb.events.EventContext.bindOnce(this, AdEvent.AD_FINISHED, this.startAds.bind(this, type, time));
            return;
        }
        this.entry = this.loader.getEntry(type, time);
        if (this.entry) {
            switch(type) {
                case AdType.PREROLL:
                    this.display.setPreroll(this.environment.getCurrentVideo());
                    break;
                case AdType.MIDROLL:
                    seekToStart.call(this);
                    onVideoStart.call(this);
                    this.display.setMidroll();
                    break;
                default:
                    break;
            }
            this.display.play();
        } else {
            this.dispatchEvent(new AdEvent(AdEvent.AD_NONE, type));
            this.dispatchEvent(new AdEvent(AdEvent.AD_BLOCKER_COMPLETE, type, {reason:vdb.enums.AdReason.NO_ADS}));
        }
    }, pauseAds:function() {
    }, resumeAds:function() {
    }, resize:function() {
    }, setVolume:function(volume) {
        this.display.setVolume(volume);
    }, mute:function(muted) {
        this.display.mute(muted);
    }, getAdsPassedTime:function() {
        return this.loader.getAdsPassedTime();
    }, onVideoEnd:function() {
        if (this.entry) {
            var type = this.entry.type;
            var time = getCurrentTime.call(this);
            this.entry = null;
            this.display.getElement().style.cursor = "auto";
            var event = new AdEvent(AdEvent.AD_FINISHED, type, {currentTime:time});
            this.loader.onFinished(event);
            this.dispatchEvent(event);
        }
    }, stop:function() {
    }, skip:function() {
    }, isPlaying:function() {
        return this.display.isPlaying();
    }};
}());
vdb.html5.subtitles = {};
vdb.html5.subtitles.Format = {TT:"tt", DFXP:"dfxp", SRT:"srt", VTT:"vtt", EMBEDDED:"embedded"};
vdb.html5.subtitles.settingsConstants = {UserSettingsStorageKey:"subtitles-user-settings", Settings:{FONT_FAMILY:"font-family", FONT_COLOR:"font-color", FONT_SIZE:"font-size", BG_COLOR:"bg-color", BG_OPACITY:"bg-opacity", WINDOW_COLOR:"window-color", WINDOW_OPACITY:"window-opacity", CHAR_EDGE_STYLE:"char-edge-style", FONT_OPACITY:"font-opacity", CAPITALIZATION:"capitalization", LOCATION_ON_SCREEN:"location-on-screen"}, FontFamilies:{ARIAL:"Arial, sans-serif", GEORGIA:"Georgia, serif", LUCIDA_SANS:'"Lucida Sans", sans-serif',
    TAHOMA:"Tahoma, serif", TIMES_NEW_ROMAN:'"Times New Roman", serif', TREBUCHET:"Trebuchet, sans-serif", VERDANA:"Verdana, sans-serif"}, Colors:{WHITE:"255, 255, 255", YELLOW:"255, 255, 0", GREEN:"0, 128, 0", CYAN:"0, 255, 255", BLUE:"0, 0, 255", MAGENTA:"255, 0, 255", RED:"255, 0, 0", BLACK:"0, 0, 0"}, CharEdgeStyles:{NONE:"", DROP_SHADOW:"rgb(34, 34, 34) 2px 2px 3px, rgb(34, 34, 34) 2px 2px 4px, rgb(34, 34, 34) 2px 2px 5px", RAISED:"rgb(34, 34, 34) 1px 1px, rgb(34, 34, 34) 2px 2px, rgb(34, 34, 34) 3px 3px",
    DEPRESSED:"rgb(204, 204, 204) 1px 1px, rgb(204, 204, 204) 0px 1px, rgb(34, 34, 34) -1px -1px, rgb(34, 34, 34) 0px -1px", OUTLINE:"rgb(34, 34, 34) 0px 0px 4px, rgb(34, 34, 34) 0px 0px 4px, rgb(34, 34, 34) 0px 0px 4px, rgb(34, 34, 34) 0px 0px 4px"}, CapitalizationOptions:{NONE:"none", UPPERCASE:"uppercase"}, ScreenLocations:{TOP:"top", BOTTOM:"bottom"}, RtlLanguages:["ar", "iw"], CountryLanguages:{"aia":"en", "sgp":"en", "atg":"en", "irl":"en", "slb":"en", "aus":"en", "jam":"en", "zaf":"en", "bhs":"en",
    "ken":"en", "swz":"en", "brb":"en", "lso":"en", "blz":"en", "lbr":"en", "ton":"en", "bmu":"en", "mwi":"en", "tto":"en", "bwa":"en", "mlt":"en", "tca":"en", "mus":"en", "uga":"en", "cmr":"en", "msr":"en", "gbr":"en", "can":"en", "nam":"en", "vut":"en", "cym":"en", "nzl":"en", "dma":"en", "nga":"en", "zmb":"en", "png":"en", "zwe":"en", "fji":"en", "gmb":"en", "gha":"en", "gib":"en", "grd":"en", "guy":"en", "sle":"en", "usa":"en", "bel":"fr", "ben":"fr", "bdi":"fr", "caf":"fr", "tcd":"fr", "com":"fr",
    "cod":"fr", "cog":"fr", "dji":"fr", "fra":"fr", "gab":"fr", "gin":"fr", "hti":"fr", "lux":"fr", "mdg":"fr", "mli":"fr", "mco":"fr", "ner":"fr", "rwa":"fr", "sen":"fr", "syc":"fr", "tgo":"fr", "rus":"ru", "isr":"iw", "arg":"es", "chl":"es", "col":"es", "cri":"es", "cub":"es", "dom":"es", "ecu":"es", "slv":"es", "gnq":"es", "gtm":"es", "hnd":"es", "mex":"es", "nic":"es", "pan":"es", "pry":"es", "per":"es", "esp":"es", "ury":"es", "jpn":"ja", "deu":"de", "aut":"de", "che":"de", "lie":"de", "bhr":"ar",
    "irq":"ar", "jor":"ar", "kwt":"ar", "lbn":"ar", "omn":"ar", "pse":"ar", "qat":"ar", "sau":"ar", "syr":"ar", "are":"ar", "yem":"ar", "chn":"zh", "hkg":"zh", "mac":"zh", "twn":"zh"}, SupportedLanguages:{"ar":"\u0627\u0644\u0639\u0631\u0628\u064a\u0629", "de":"deutsch", "en":"english", "es":"espa\u00f1ol", "fr":"fran\u00e7ais", "it":"Italiano", "iw":"\u05e2\u05d1\u05e8\u05d9\u05ea", "ja":"\u65e5\u672c\u8a9e", "ru":"\u0440\u0443\u0441\u0441\u043a\u0438\u0439", "zh_TW":"\u7e41\u9ad4\u4e2d\u6587", "zh_CN":"\u7b80\u4f53\u4e2d\u6587"}};
vdb.html5.subtitles.SettingsModel = function() {
    var settingsConstants = vdb.html5.subtitles.settingsConstants;
    var Settings = settingsConstants.Settings;
    var FontFamilies = settingsConstants.FontFamilies;
    var Colors = settingsConstants.Colors;
    var CharEdgeStyles = settingsConstants.CharEdgeStyles;
    var CapitalizationOptions = settingsConstants.CapitalizationOptions;
    var ScreenLocations = settingsConstants.ScreenLocations;
    var model = {};
    model[Settings.FONT_FAMILY] = FontFamilies.ARIAL;
    model[Settings.FONT_COLOR] = Colors.WHITE;
    model[Settings.FONT_SIZE] = "1";
    model[Settings.BG_COLOR] = Colors.BLACK;
    model[Settings.BG_OPACITY] = ".5";
    model[Settings.WINDOW_COLOR] = Colors.BLACK;
    model[Settings.WINDOW_OPACITY] = "0";
    model[Settings.CHAR_EDGE_STYLE] = CharEdgeStyles.OUTLINE;
    model[Settings.FONT_OPACITY] = "1";
    model[Settings.CAPITALIZATION] = CapitalizationOptions.NONE;
    model[Settings.LOCATION_ON_SCREEN] = ScreenLocations.BOTTOM;
    return model;
};
vdb.html5.subtitles.SubtitlesCue = vdb.core.Class.extend(function() {
    return{init:function(obj) {
        this.id = "";
        this.startTime = 0;
        this.endTime = 0;
        this.pauseOnExit = false;
        this.direction = "horizontal";
        this.snapToLines = true;
        this.linePosition = "auto";
        this.textPosition = 50;
        this.size = 100;
        this.alignment = "middle";
        this.text = "";
        this.tree = null;
        for (var p in obj) {
            if (obj.hasOwnProperty(p)) {
                this[p] = obj[p];
            }
        }
    }};
}());
vdb.html5.subtitles.BaseParser = vdb.core.Class.extend(function() {
    function error(e) {
        var message = typeof e.message === "string" ? e.message : e;
        LOGGER.warn("Unhandled exception in subtitles parser : " + message);
        this._errors.push(message);
    }
    function parse() {
        sortCues.call(this);
        return{cues:this._cues, errors:this._errors};
    }
    function sortCues() {
        this._cues.sort(function(a, b) {
            if (a.startTime < b.startTime) {
                return-1;
            }
            if (a.startTime > b.startTime) {
                return 1;
            }
            if (a.endTime > b.endTime) {
                return-1;
            }
            if (a.endTime < b.endTime) {
                return 1;
            }
            return 0;
        });
    }
    function parseRawData() {
        var data = this._rawData;
        var startTime = parseTimeStamp.call(this, data.begin);
        if (isNaN(startTime)) {
            error.call(this, "Invalid begin time found: " + data.begin);
            return;
        }
        var endTime;
        if (data.end) {
            endTime = parseTimeStamp.call(this, data.end);
        } else {
            if (data.dur) {
                endTime = startTime + parseTimeStamp.call(this, data.dur);
            }
        }
        if (isNaN(endTime) || endTime < startTime) {
            error.call(this, "Invalid timing found, begin: " + data.begin + " end: " + data.end);
            return;
        }
        this._cues.push({startTime:startTime, endTime:endTime, text:data.text});
    }
    function parseTimeStamp(timeStamp) {
        var sec;
        timeStamp = timeStamp.trim();
        if (HH_MM_SS_FF.test(timeStamp)) {
            timeStamp = formatFrameTiming.call(this, timeStamp);
        }
        if (HH_MM_SS_MS.test(timeStamp)) {
            sec = getMSfromTimeStamp.call(this, timeStamp);
        }
        if (OFFSET_TIME.test(timeStamp)) {
            sec = getMSfromOffsetTime.call(this, timeStamp);
        }
        if (isNaN(sec)) {
            return;
        }
        return sec;
    }
    function formatFrameTiming(time) {
        var index = time.lastIndexOf(":");
        var frames = time.substring(index + 1);
        return time.substring(0, index) + this.separator + framsToMS.call(this, frames);
    }
    function framsToMS(frames, fps) {
        fps = fps || FRAMES_RATE;
        for (var ms = ~~(1E3 * frames / fps) + "";ms.length < 3;) {
            ms = "0" + ms;
        }
        return ms;
    }
    function getMSfromTimeStamp(time) {
        var parts = time.split(this.separator);
        if (parts.length != 2) {
            return;
        }
        var digs = parts[0].split(":");
        var units = digs.length;
        var unitOptions = [0, +digs[0], +digs[0] * 60 + +digs[1], +digs[0] * 3600 + +digs[1] * 60 + +digs[2]];
        var sec = unitOptions[units];
        var ms = +("0." + parts[1]);
        return sec + ms;
    }
    function getMSfromOffsetTime(time) {
        var rawTime = parseFloat(time);
        var units = time.match(UNITS)[0];
        var unitScaler = {"ms":.001, "s":1, "m":60, "h":3600};
        return rawTime * unitScaler[units];
    }
    var LOGGER;
    var HH_MM_SS_FF = /^(?:(?:(?:([01]?\d|2[0-3]):)?([0-5]?\d):)?([0-5]?\d:)?)([01]?\d|2[0-4])$/;
    var HH_MM_SS_MS = /^(?:(?:(?:([01]?\d|2[0-3]):)?([0-5]?\d):)?([0-5]?\d))?[\.\,]\d?\d?\d$/;
    var OFFSET_TIME = /^(((\d+)?\.\d?\d?\d?)|\d+)([hms]|ms)$/;
    var UNITS = /([mhs]|ms)$/;
    var FRAMES_RATE = 24;
    return{init:function(type) {
        LOGGER = vdb.log.getLogger("Subtitles " + type);
        LOGGER.debug("init");
    }, error:error, parse:parse, parseRawData:parseRawData};
}());
vdb.html5.subtitles.DfxpParser = vdb.html5.subtitles.BaseParser.extend(function() {
    function parse(input) {
        this._cues = [];
        this._errors = [];
        var xmlStr = input.replace(/\s+$/, "").replace(/>\s+</g, "><");
        try {
            var xmlData = (new window.DOMParser).parseFromString(xmlStr, "text/xml");
            var xml = xmlData.documentElement;
        } catch (e) {
            this.error.call(this, e);
            return;
        }
        try {
            parseBody.call(this, xml);
        } catch (e$$0) {
            this.error.call(this, e$$0);
            return;
        }
        return this._super();
    }
    function parseBody(xml) {
        var body = xml.getElementsByTagName("body")[0];
        if (body.length == 0) {
            throw "Invalid DFXP document: <body> tag is required.";
        } else {
            var div = xml.getElementsByTagName("div")[0];
            var p = div.childNodes.length > 0 ? div.childNodes : body.childNodes.length > 0 ? body.childNodes : [];
            for (var i = 0;i < p.length;i++) {
                var pNode = p[i];
                this._rawData = {begin:pNode.getAttribute("begin") || "0", end:pNode.getAttribute("end"), dur:pNode.getAttribute("dur"), text:pNode.innerHTML || parseNodeContent(pNode)};
                this.parseRawData.call(this);
            }
        }
    }
    function parseNodeContent(node) {
        var text = "";
        var children = node.childNodes;
        for (var i = 0;i < children.length;i++) {
            var child = children[i];
            switch(child.nodeType) {
                case 3:
                    text += child.textContent;
                    break;
                case 1:
                    switch(child.tagName.toLowerCase()) {
                        case "br":
                            text += "<br />";
                            break;
                        default:
                            text += "<" + child.tagName + ">" + child.textContent + "</" + child.tagName + ">";
                            break;
                    }
                    break;
            }
        }
        return text;
    }
    return{init:function() {
        this._super("DFXP");
        this.separator = ".";
    }, parse:parse};
}());
vdb.html5.subtitles.SrtParser = vdb.html5.subtitles.BaseParser.extend(function() {
    function parse(input) {
        this._cues = [];
        this._errors = [];
        var lines = input.split(NEWLINE);
        try {
            parseLines.call(this, lines);
        } catch (e) {
            this.error.call(this, e);
            return;
        }
        return this._super();
    }
    function parseLines(lines) {
        function validateCaptionNumber(n) {
            return!isNaN(n) && lastCaptionNumber < n;
        }
        function validateText(text) {
            return text && text != "";
        }
        function skipToNextBlankLine() {
            for (;lines[i] != "" && i < lines.length;) {
                i++;
            }
        }
        if (lines.length <= 1) {
            throw "Invalid SRT document: no data found";
        } else {
            var i;
            var line;
            var times;
            var captionNumber;
            var lastCaptionNumber = 0;
            for (i = 0;i < lines.length;i++) {
                this._rawData = {};
                line = lines[i];
                if (line == "") {
                    continue;
                } else {
                    if (validateCaptionNumber(captionNumber = +line) == false) {
                        this.error.call(this, "Bad caption number found - " + line);
                        skipToNextBlankLine();
                        continue;
                    }
                }
                line = lines[++i];
                if (line.indexOf(CUE) == -1) {
                    this.error.call(this, "Timing cue not found for caption number - " + captionNumber);
                    skipToNextBlankLine();
                    continue;
                }
                times = line.split(CUE);
                this._rawData.begin = times[0].trim();
                this._rawData.end = times[1].trim();
                line = lines[++i];
                if (validateText(line)) {
                    this._rawData.text = line;
                    if (validateText(lines[i + 1])) {
                        this._rawData.text += "<br />" + lines[i + 1];
                        i++;
                    }
                    this.parseRawData.call(this);
                    skipToNextBlankLine();
                    lastCaptionNumber = captionNumber;
                }
            }
        }
    }
    var NEWLINE = /\r\n|\r|\n/;
    var CUE = " --\x3e ";
    return{init:function() {
        this._super("SRT");
        this.separator = ",";
    }, parse:parse};
}());
vdb.html5.subtitles.SubtitlesManagerEvent = {LANGUAGE_SELECTED:"LanguageSelected", LOAD_ERROR:"LoadError"};
vdb.html5.subtitles.SubtitlesView = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("Subtitles");
    var $ = vdb.utils.Common;
    var utl = vdb.Utils;
    var Settings = vdb.html5.subtitles.settingsConstants.Settings;
    var NEW_LINE_SEPARATOR = " <br /> ";
    var buildElements = function() {
        this.subtitlesContainer = utl.createElement("div", {"style":["display: none;", "position: absolute;", "width: 90%;", "padding: .5% 5%;", "text-align: center;", "z-index: 2;"]}, this.container);
        this.subtitlesText = utl.createElement("div", {"class":"subtitles-text", "style":["display: inline-block;", "padding: .5% 1%;"]}, this.subtitlesContainer);
    };
    return{init:function(container, display) {
        this.container = container;
        this.display = display;
        buildElements.call(this);
    }, render:function(model) {
        this.model = model;
        utl.setStyle(this.subtitlesContainer, {top:"", bottom:"", backgroundColor:"rgba(" + model[Settings.WINDOW_COLOR] + ", " + model[Settings.WINDOW_OPACITY] + ")"});
        this.subtitlesContainer.style[model[Settings.LOCATION_ON_SCREEN]] = "9px";
        this.subtitlesContainer.className = "subtitles-" + model[Settings.LOCATION_ON_SCREEN] + "-container";
        utl.setStyle(this.subtitlesText, {fontFamily:model[Settings.FONT_FAMILY], color:"rgba(" + model[Settings.FONT_COLOR] + ", " + model[Settings.FONT_OPACITY] + ")", textShadow:model[Settings.CHAR_EDGE_STYLE], textTransform:model[Settings.CAPITALIZATION], backgroundColor:"rgba(" + model[Settings.BG_COLOR] + ", " + model[Settings.BG_OPACITY] + ")"});
        this.setTextSize();
    }, addEvents:function() {
        this.eventContext = this.eventContext || vdb.events.EventContext.bind(vdb.ctx, vdb.constants.PlayerEvent.PLAYER_RESIZE, this.setTextSize.bind(this));
    }, removeEvents:function() {
        this.eventContext && this.eventContext.unbind();
        this.eventContext = null;
    }, updateTextLines:function(lines) {
        this.subtitlesText.innerHTML = lines.join(NEW_LINE_SEPARATOR);
        this.show();
    }, clearText:function() {
        this.hide();
        this.subtitlesText.innerHTML = "";
    }, show:function() {
        $.show(this.subtitlesContainer);
    }, hide:function() {
        $.hide(this.subtitlesContainer);
    }, setTextSize:function() {
        var videoWidth = this.display.getWidth();
        var fontSize = (12 + (videoWidth > 400 ? Math.ceil((videoWidth - 400) / 100) : 0)) * +this.model[Settings.FONT_SIZE];
        utl.setStyle(this.subtitlesText, {fontSize:fontSize + "px", lineHeight:"150%"});
    }, setRtlLanguageDirection:function(isRTL) {
        var direction = isRTL ? "rtl" : "ltr";
        LOGGER.debug("set language direction -", direction);
        utl.setStyle(this.subtitlesText, {direction:direction});
    }, eventContext:null};
}());
vdb.html5.subtitles.WebVttParser = vdb.html5.subtitles.BaseParser.extend(function() {
    var LOGGER = vdb.log.getLogger("Subtitles WebVttParser");
    var SPACE = /[\u0020\t\f]/;
    var NOSPACE = /[^\u0020\t\f]/;
    var CUE = "--\x3e";
    var NOTE = "note";
    var _skip = function(pattern) {
        for (;typeof this._line[this._pos] !== "undefined" && pattern.test(this._line[this._pos]);) {
            this._pos++;
        }
    };
    var _error = function(message, pos) {
        if (typeof pos !== "undefined") {
            message += " [" + pos + "]";
        }
        LOGGER.warn(message);
    };
    var _collectError = function(message, col) {
        _error(message);
        this._errors.push({message:message, line:this._linePos + 1, col:col});
    };
    var _collect = function(pattern) {
        for (var str = "";typeof this._line[this._pos] !== "undefined" && pattern.test(this._line[this._pos]);) {
            str += this._line[this._pos];
            this._pos++;
        }
        return str;
    };
    var _timestamp = function() {
        var units = "minutes";
        var val1;
        var val2;
        var val3;
        var val4;
        if (typeof this._line[this._pos] === "undefined") {
            _collectError.call(this, "No timestamp found.");
            return;
        }
        if (!/\d/.test(this._line[this._pos])) {
            _collectError.call(this, "Timestamp must start with a character in the range 0-9.", this._pos);
            return;
        }
        val1 = _collect.call(this, /\d/);
        if (val1.length > 2 || parseInt(val1, 10) > 59) {
            units = "hours";
        }
        if (this._line[this._pos] != ":") {
            _collectError.call(this, "No time unit separator found.", this._pos);
            return;
        }
        this._pos++;
        val2 = _collect.call(this, /\d/);
        if (val2.length != 2) {
            _collectError.call(this, "Must be exactly two digits.", this._pos);
            return;
        }
        if (units == "hours" || this._line[this._pos] == ":") {
            if (this._line[this._pos] != ":") {
                _collectError.call(this, "No seconds found or minutes is greater than 59.", this._pos);
                return;
            }
            this._pos++;
            val3 = _collect.call(this, /\d/);
            if (val3.length != 2) {
                _collectError.call(this, "Must be exactly two digits.", this._pos);
                return;
            }
        } else {
            val3 = val2;
            val2 = val1;
            val1 = "0";
        }
        if (this._line[this._pos] != ".") {
            _collectError.call(this, 'No decimal separator (".") found.', this._pos);
            if (this._line[this._pos] != ",") {
                return;
            }
        }
        this._pos++;
        val4 = _collect.call(this, /\d/);
        if (val4.length != 3) {
            _collectError.call(this, "Milliseconds must be given in three digits.", this._pos);
            return;
        }
        if (parseInt(val2, 10) > 59) {
            _collectError.call(this, "You cannot have more than 59 minutes.", this._pos);
            return;
        }
        if (parseInt(val3, 10) > 59) {
            _collectError.call(this, "You cannot have more than 59 seconds.", this._pos);
            return;
        }
        return parseInt(val1, 10) * 60 * 60 + parseInt(val2, 10) * 60 + parseInt(val3, 10) + parseInt(val4, 10) / 1E3;
    };
    var _parseSettings = function(input, cue) {
        var settings = input.split(SPACE);
        var seen = [];
        for (var i = 0;i < settings.length;i++) {
            if (settings[i] == "") {
                continue;
            }
            var index = settings[i].indexOf(":");
            var setting = settings[i].slice(0, index);
            var value = settings[i].slice(index + 1);
            if (seen.indexOf(setting) != -1) {
                _collectError.call(this, "Duplicate setting.");
            }
            seen.push(setting);
            if (value == "") {
                _collectError.call(this, "No value for setting defined.");
                return;
            }
            if (setting == "vertical") {
                if (value != "rl" && value != "lr") {
                    _collectError.call(this, "Writing direction can only be set to 'rl' or 'rl'.");
                    continue;
                }
                cue.direction = value;
            } else {
                if (setting == "line") {
                    if (!/\d/.test(value)) {
                        _collectError.call(this, "Line position takes a number or percentage.");
                        continue;
                    }
                    if (value.indexOf("-", 1) != -1) {
                        _collectError.call(this, "Line position can only have '-' at the start.");
                        continue;
                    }
                    if (value.indexOf("%") != -1 && value.indexOf("%") != value.length - 1) {
                        _collectError.call(this, "Line position can only have '%' at the end.");
                        continue;
                    }
                    if (value[0] == "-" && value[value.length - 1] == "%") {
                        _collectError.call(this, "Line position cannot be a negative percentage.");
                        continue;
                    }
                    if (value[value.length - 1] == "%") {
                        if (parseInt(value, 10) > 100) {
                            _collectError.call(this, "Line position cannot be >100%.");
                            continue;
                        }
                        cue.snapToLines = false;
                    }
                    cue.linePosition = parseInt(value, 10);
                } else {
                    if (setting == "position") {
                        if (value[value.length - 1] != "%") {
                            _collectError.call(this, "Text position must be a percentage.");
                            continue;
                        }
                        if (parseInt(value, 10) > 100) {
                            _collectError.call(this, "Size cannot be >100%.");
                            continue;
                        }
                        cue.textPosition = parseInt(value, 10);
                    } else {
                        if (setting == "size") {
                            if (value[value.length - 1] != "%") {
                                _collectError.call(this, "Size must be a percentage.");
                                continue;
                            }
                            if (parseInt(value, 10) > 100) {
                                _collectError.call(this, "Size cannot be >100%.");
                                continue;
                            }
                            cue.size = parseInt(value, 10);
                        } else {
                            if (setting == "align") {
                                if (value != "start" && value != "middle" && value != "end") {
                                    _collectError.call(this, "Alignment can only be set to 'start', 'middle', or 'end'.");
                                    continue;
                                }
                                cue.alignment = value;
                            } else {
                                _collectError.call(this, "Invalid setting.");
                            }
                        }
                    }
                }
            }
        }
    };
    var _timingParse = function(cue, previousCueStart) {
        _skip.call(this, SPACE);
        cue.startTime = _timestamp.call(this);
        if (typeof cue.startTime === "undefined") {
            return;
        }
        if (cue.startTime < previousCueStart) {
            _collectError.call(this, "Start timestamp is not greater than or equal to start timestamp of previous cue.");
        }
        if (NOSPACE.test(this._line[this._pos])) {
            _collectError.call(this, "Timestamp not separated from '--\x3e' by whitespace.", this._pos);
        }
        _skip.call(this, SPACE);
        if (this._line[this._pos] != "-") {
            _collectError.call(this, "No valid timestamp separator found.", this._pos);
            return;
        }
        this._pos++;
        if (this._line[this._pos] != "-") {
            _collectError.call(this, "No valid timestamp separator found.", this._pos);
            return;
        }
        this._pos++;
        if (this._line[this._pos] != ">") {
            _collectError.call(this, "No valid timestamp separator found.", this._pos);
            return;
        }
        this._pos++;
        if (NOSPACE.test(this._line[this._pos])) {
            _collectError.call(this, "'--\x3e' not separated from timestamp by whitespace.", this._pos);
        }
        _skip.call(this, SPACE);
        cue.endTime = _timestamp.call(this);
        if (typeof cue.endTime === "undefined") {
            return;
        }
        if (cue.endTime <= cue.startTime) {
            _collectError.call(this, "End timestamp is not greater than start timestamp.", this._pos);
        }
        if (NOSPACE.test(this._line[this._pos])) {
            this._spaceBeforeSetting = false;
        }
        _skip.call(this, SPACE);
        _parseSettings.call(this, this._line.substring(this._pos), cue);
        return true;
    };
    var parse = function(input) {
        var NEWLINE = /\r\n|\r|\n/;
        this._errors = [];
        this._linePos = 0;
        var cues = this._cues = [];
        var lines = input.split(NEWLINE);
        var alreadyCollected = false;
        if (lines[this._linePos].length < 6 || lines[this._linePos].indexOf("WEBVTT") != 0 || lines[this._linePos].length > 6 && lines[this._linePos][6] != " " && lines[this._linePos][6] != "\t") {
            _collectError.call(this, 'No valid signature. (File needs to start with "WEBVTT".)');
        }
        for (this._linePos++;lines[this._linePos] != "" && typeof lines[this._linePos] !== "undefined";) {
            _collectError.call(this, "No blank line after the signature.");
            if (lines[this._linePos].indexOf(CUE) != -1) {
                alreadyCollected = true;
                break;
            }
            this._linePos++;
        }
        for (;typeof lines[this._linePos] !== "undefined";) {
            for (var cue;!alreadyCollected && lines[this._linePos] == "";) {
                this._linePos++;
            }
            if (!alreadyCollected && typeof lines[this._linePos] === "undefined") {
                break;
            }
            cue = new vdb.html5.subtitles.SubtitlesCue;
            if (lines[this._linePos].indexOf(CUE) == -1) {
                cue.id = lines[this._linePos];
                this._linePos++;
                if (lines[this._linePos] == "" || typeof lines[this._linePos] === "undefined") {
                    _collectError.call(this, "Cue identifier cannot be standalone.");
                    continue;
                }
            }
            var previousCueStart = 0;
            this._line = lines[this._linePos];
            this._pos = 0;
            alreadyCollected = false;
            if (cues.length > 0) {
                previousCueStart = cues[cues.length - 1].startTime;
            }
            if (!_timingParse.call(this, cue, previousCueStart)) {
                cue = null;
                for (this._linePos++;lines[this._linePos] != "" && typeof lines[this._linePos] !== "undefined";) {
                    if (lines[this._linePos].indexOf(CUE) != -1) {
                        alreadyCollected = true;
                        break;
                    }
                    this._linePos++;
                }
                continue;
            }
            for (this._linePos++;lines[this._linePos] != "" && typeof lines[this._linePos] !== "undefined";) {
                if (lines[this._linePos].toLowerCase().indexOf(NOTE) === 0) {
                    this._linePos++;
                    continue;
                }
                if (lines[this._linePos].indexOf(CUE) != -1) {
                    _collectError.call(this, "Blank line missing before cue.");
                    alreadyCollected = true;
                    break;
                }
                if (cue.text != "") {
                    cue.text += "<br/>";
                }
                cue.text += lines[this._linePos];
                this._linePos++;
            }
            cues.push(cue);
        }
        return this._super();
    };
    return{init:function() {
        LOGGER.debug("init");
    }, parse:parse};
}());
vdb.html5.subtitles.SubtitlesParser = vdb.core.Class.extend(function() {
    function createParser(type) {
        var instance;
        switch(type) {
            case "tt":
                ;
            case "dfxp":
                instance = new vdb.html5.subtitles.DfxpParser;
                break;
            case "srt":
                instance = new vdb.html5.subtitles.SrtParser;
                break;
            case "vtt":
                instance = new vdb.html5.subtitles.WebVttParser;
                break;
            default:
                LOGGER.error("unsupported type of subtitles: " + type);
        }
        return instance;
    }
    var LOGGER = vdb.log.getLogger("Subtitles WebVttParser");
    return{init:function(type) {
        LOGGER.debug("init");
        this.parser = createParser(type);
    }, parse:function(input) {
        if (this.parser) {
            return this.parser.parse(input);
        }
    }, getErrors:function() {
        if (this.parser) {
            return this.parser._errors;
        }
    }};
}());
vdb.html5.subtitles.SubtitlesManager = vdb.EventBus.extend(function() {
    var LOGGER = vdb.log.getLogger("SubtitlesManager");
    var $ = vdb.utils.Common;
    var utl = vdb.Utils;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var UserSettingsStorageKey = vdb.html5.subtitles.settingsConstants.UserSettingsStorageKey;
    var sourceStatus;
    var supportedFormats;
    var EventContext = vdb.events.EventContext;
    var SubscriptMode = vdb.enums.video.SubscriptMode;
    var DEFAULT_SUBSCRIPT_MODE = SubscriptMode.ON;
    var subscriptMode;
    var languageAutoDetection;
    var settingsConstants = vdb.html5.subtitles.settingsConstants;
    var SubtitlesFormat = vdb.html5.subtitles.Format;
    var SubtitlesManagerEvent = vdb.html5.subtitles.SubtitlesManagerEvent;
    var AdEvent = vdb.events.AdEvent;
    var initSubscriptSettings = function() {
        LOGGER.debug("initSubscriptSettings");
        var uiTemplate = vdb.ctx.playerAPI.uiTemplate;
        subscriptMode = uiTemplate["enableSubscript"] ? uiTemplate["enableSubscript"].toUpperCase() : DEFAULT_SUBSCRIPT_MODE;
        languageAutoDetection = uiTemplate["languageAutoDetection"];
        LOGGER.debug("SubscriptSettings:", subscriptMode, languageAutoDetection);
    };
    var onVideoVolumeChanged = function() {
        if (!this.controller.isMuted() && subscriptMode === SubscriptMode.AUTO_DETECT) {
            this.off();
            this.player.removeEventListener(PlayerEvent.VIDEO_VOLUME_CHANGED, this.onVolumeChanged);
        }
    };
    var setGeoLanguage = function() {
        var countryLanguages = settingsConstants.CountryLanguages;
        var geo = vdb.ctx.playerAPI.geo;
        LOGGER.debug("use geo data:", geo);
        var country = geo && geo["country"];
        var countryLanguage = country ? countryLanguages[country] : null;
        if (countryLanguage) {
            LOGGER.debug("use geo language -", countryLanguage);
            this.startLanguage = countryLanguage;
        } else {
            LOGGER.debug("country language is not supported");
        }
    };
    var selectStartLanguage = function() {
        var browserLanguage = utl.getBrowserLanguage();
        var supportedLanguages = settingsConstants.SupportedLanguages;
        LOGGER.debug("select language on start");
        if (utl.browser.playsNativeInline() && this.controller.isMuted() && this.controller.isAutoplay()) {
            subscriptMode = SubscriptMode.AUTO_DETECT;
            this.onVolumeChanged = onVideoVolumeChanged.bind(this);
            this.player.addEventListener(PlayerEvent.VIDEO_VOLUME_CHANGED, this.onVolumeChanged);
        }
        if (this.macroLanguage && supportedLanguages[this.macroLanguage]) {
            this.startLanguage = this.macroLanguage;
        } else {
            if (subscriptMode === SubscriptMode.AUTO_DETECT) {
                this.startLanguage = null;
                if (supportedLanguages[languageAutoDetection]) {
                    LOGGER.debug("use languageAutoDetection property -", languageAutoDetection);
                    this.startLanguage = languageAutoDetection;
                } else {
                    if (supportedLanguages[browserLanguage]) {
                        LOGGER.debug("languageAutoDetection is not supported -", languageAutoDetection);
                        LOGGER.debug("use browser language settings -", browserLanguage);
                        this.startLanguage = browserLanguage;
                    } else {
                        LOGGER.debug("languageAutoDetection is not supported -", languageAutoDetection);
                        LOGGER.debug("browser language is not supported -", browserLanguage);
                        setGeoLanguage.call(this);
                    }
                }
            }
        }
        this.macroLanguage = null;
        LOGGER.debug("language on start:", this.startLanguage);
        if (this.startLanguage) {
            this.dispatchEvent(vdb.html5.subtitles.SubtitlesManagerEvent.LANGUAGE_SELECTED, {languageCode:this.startLanguage});
        }
    };
    var setCueIndex = function() {
        var currentTime = this.display.getCurrentTime();
        var lastCueIndex = this.cues.length - 1;
        for (var cueIndex = -1;++cueIndex < lastCueIndex && this.cues[cueIndex].endTime < currentTime;) {
        }
        this.cueIndex = cueIndex;
    };
    var nextCueIndex = function(time) {
        var currentTime = time || this.display.getCurrentTime();
        var lastCueIndex = this.cues.length - 1;
        for (var cueIndex = this.cueIndex - 1;++cueIndex < lastCueIndex && this.cues[cueIndex].endTime < currentTime;) {
        }
        this.cueIndex = cueIndex;
    };
    var getTextLines = function(cues, time, startIndex) {
        var lines = [];
        for (var i = startIndex;i < cues.length;i++) {
            if (time < cues[i].startTime) {
                break;
            } else {
                if (time < cues[i].endTime) {
                    lines.push(cues[i].text);
                }
            }
        }
        return lines;
    };
    var setSubtitlesText = function() {
        var currentTime = this.display.getCurrentTime();
        nextCueIndex.call(this, currentTime);
        var lines = getTextLines(this.cues, currentTime, this.cueIndex);
        if (lines.length) {
            this.view.updateTextLines(lines);
        } else {
            this.view.clearText();
        }
    };
    var getSources = function(subtitles, languageCode, supFormats) {
        var sources = [];
        var subtitleSources = subtitles && subtitles[languageCode] && subtitles[languageCode]["formats"];
        if (subtitleSources) {
            for (var i = 0;i < supFormats.length;i++) {
                var format = supFormats[i];
                if (subtitleSources[format]) {
                    sources.push({format:format, url:subtitleSources[format], status:vdb.html5.subtitles.SubtitlesManager.sourceStatus.IDLE});
                }
            }
        }
        return sources;
    };
    var onParseSuccess = function(parsedSubtitles) {
        LOGGER.debug("Parse succeeded", parsedSubtitles);
        this.currentSource.status = sourceStatus.SUCCESS;
        this.cues = parsedSubtitles.cues;
        if (this.loadedCues[this.videoId]) {
            this.loadedCues[this.videoId][this.currentLanguage] = utl.cloneArray(this.cues);
        }
        setCueIndex.call(this);
        this.enable();
        setSubtitlesText.call(this);
    };
    var onError = function(index) {
        this.sources[index].status = sourceStatus.FAIL;
        loadSubtitles.call(this);
    };
    var onLoadSuccess = function(index, data) {
        var format = this.currentSource.format;
        var parsedSubtitles = (new vdb.html5.subtitles.SubtitlesParser(format)).parse(data.text);
        LOGGER.debug("Load succeeded", data);
        if (!parsedSubtitles) {
            LOGGER.warn("Failed to parse subtitles for format '" + format + "'");
            onError.call(this, index);
        } else {
            if (parsedSubtitles.cues.length === 0) {
                LOGGER.warn("No cues found for format '" + format + "'", parsedSubtitles);
                onError.call(this, index);
            } else {
                onParseSuccess.call(this, parsedSubtitles);
            }
        }
    };
    var onLoadError = function(index, error) {
        LOGGER.warn("Load error!", error);
        this.currentLanguage = null;
        this.dispatchEvent(SubtitlesManagerEvent.LOAD_ERROR);
        onError.call(this, index);
    };
    var loadSubtitles = function() {
        LOGGER.debug("loadSubtitles");
        if (++this.sourceIndex < this.sources.length) {
            var index = this.sourceIndex;
            this.currentSource = this.sources[index];
            if (this.currentSource.format === SubtitlesFormat.EMBEDDED) {
                LOGGER.debug("Loading embedded subtitles");
                onParseSuccess.call(this, this._textTrack);
                return;
            }
            var src = this.currentSource.url;
            if (src) {
                LOGGER.debug("Loading from " + src);
                vdb.ajax.get(src, null, onLoadSuccess.bind(this, index), onLoadError.bind(this, index));
            }
        } else {
            LOGGER.warn("All sources failed to load!", this.sources);
        }
    };
    var prepareAutoTranslatedSubtitles = function(languageCode) {
        LOGGER.debug("prepareAutoTranslatedSubtitles:", languageCode);
        var subsServiceUrl = vdb.ctx.getBaseUrls("subs");
        this.sources.push({format:SubtitlesFormat.SRT, url:subsServiceUrl + "?id=" + this.videoId + "&target=" + languageCode, status:sourceStatus.IDLE});
    };
    var getSubtitles = function(languageCode) {
        LOGGER.debug("getSubtitles", this.videoId, languageCode);
        if (this.loadedCues[this.videoId] && this.loadedCues[this.videoId][languageCode]) {
            LOGGER.debug("Loading from memory");
            this.cues = this.loadedCues[this.videoId][languageCode];
            setCueIndex.call(this);
            this.enable();
            setSubtitlesText.call(this);
            return;
        }
        this.sources = getSources(this.subtitles, languageCode, supportedFormats);
        this.sourceIndex = -1;
        if (this.sources.length > 0) {
            loadSubtitles.call(this);
        } else {
            prepareAutoTranslatedSubtitles.call(this, languageCode);
            if (this.sources.length > 0) {
                loadSubtitles.call(this);
            } else {
                LOGGER.warn("No supported formats found for language code '" + languageCode + "'", this.subtitles);
            }
        }
    };
    var checkForSubtitles = function() {
        this.videoId = this.controller.getCurrentVideoId();
        this.loadedCues[this.videoId] = this.loadedCues[this.videoId] || {};
        if (this.hasSubtitles()) {
            LOGGER.debug("Found subtitles", this.subtitles);
            this.player.dispatchEvent(PlayerEvent.SUBTITLES_READY);
            if (this.currentLanguage) {
                getSubtitles.call(this, this.currentLanguage);
                this.dispatchEvent(vdb.html5.subtitles.SubtitlesManagerEvent.LANGUAGE_SELECTED, {languageCode:this.currentLanguage});
            }
        } else {
            this.subtitles = null;
        }
    };
    var skipEmptySources = function(video) {
        var subs = video && video.subtitles && vdb.Utils.copy(video.subtitles) || {};
        for (var lang in subs) {
            if (Object.prototype.hasOwnProperty.call(subs, lang)) {
                var formats = subs[lang] && subs[lang]["formats"] || {};
                formats = vdb.Utils.copy(formats);
                for (var f in formats) {
                    if (f.length === 0 || Object.prototype.hasOwnProperty.call(formats, f) && formats[f].length === 0) {
                        delete formats[f];
                    }
                }
                if ($.getObjectSize(formats) === 0) {
                    delete subs[lang];
                } else {
                    subs[lang]["formats"] = formats;
                }
            }
        }
        return subs;
    };
    var checkForVideoSubtitles = function() {
        var currVideo = this.controller.getCurrentVideo();
        this._externalSubtitles = skipEmptySources(currVideo);
        this.subtitles = vdb.Utils.copy(this._externalSubtitles);
        checkForSubtitles.call(this);
    };
    var hasNonEmptyCues = function(textTrack) {
        if (!textTrack.cues || !textTrack.cues.length) {
            return false;
        }
        for (var i = 0;i < textTrack.cues.length;i++) {
            if (textTrack.cues[i].text && textTrack.cues[i].text.length > 1) {
                return true;
            }
        }
        return false;
    };
    var isEmbeddedSubtitlesAdded = function(language) {
        var subtitles = this.subtitles && this.subtitles[language];
        return subtitles && subtitles["formats"] && subtitles["formats"][SubtitlesFormat.EMBEDDED] === SubtitlesFormat.EMBEDDED;
    };
    var onEmbeddedSubtitlesFound = function(textTrack) {
        this._textTrack = textTrack;
        var language = this._textTrack.language || "en";
        if (!isEmbeddedSubtitlesAdded.call(this, language)) {
            this.subtitles = this.subtitles || {};
            this.subtitles[language] = {"displayText":"Embedded", "formats":{"embedded":SubtitlesFormat.EMBEDDED}};
            this.currentSource = this.currentSource || {};
            this.embedded = true;
            checkForSubtitles.call(this);
            selectStartLanguage.call(this);
        }
    };
    var checkForEmbeddedSubtitles = function() {
        var element = this.display.getElement();
        var textTracks = element && element.textTracks || [];
        var textTrack;
        for (var i = 0;i < textTracks.length;i++) {
            if (textTracks[i].mode !== "hidden") {
                textTracks[i].mode = "hidden";
            }
            if (hasNonEmptyCues(textTracks[i])) {
                textTrack = textTracks[i];
                break;
            }
        }
        if (textTrack) {
            if (!this.cues || this.cues.length <= textTrack.cues.length) {
                onEmbeddedSubtitlesFound.call(this, textTrack);
            }
        }
    };
    var removeEvents = function() {
        if (this.contextBindGroup) {
            this.contextBindGroup.unbind();
            this.contextBindGroup = null;
        }
        this.view.removeEvents();
    };
    var addEvents = function() {
        var bind = EventContext.bind;
        this.contextBindGroup = this.contextBindGroup || this.display.isAd() ? EventContext.group(bind(this.player, PlayerEvent.AD_TIMEUPDATE, setSubtitlesText.bind(this)), bind(this.player, PlayerEvent.AD_END, this.disable.bind(this))) : EventContext.group(bind(this.player, PlayerEvent.VIDEO_TIMEUPDATE, setSubtitlesText.bind(this)), bind(this.player, PlayerEvent.VIDEO_SEEKEND, setCueIndex.bind(this)), bind(this.player, PlayerEvent.VIDEO_END, this.disable.bind(this)));
        this.view.addEvents();
    };
    var onLanguageSelected = function(data) {
        var languageCode = data && data.languageCode;
        var rtlLanguages = settingsConstants.RtlLanguages;
        this.view.setRtlLanguageDirection(rtlLanguages.indexOf(languageCode) !== -1);
    };
    var onAdStart = function() {
        if (this.controller.isBrandedWithControls()) {
            selectStartLanguage.call(this);
        }
    };
    var hideOnAdStart = function() {
        if (this.isEnabled) {
            this.view.hide();
        }
    };
    var showOnAdEnd = function() {
        if (this.isEnabled) {
            this.view.show();
        }
    };
    var initEvents = function() {
        this.player.addEventListener(PlayerEvent.AD_BLOCKER_COMPLETE, checkForVideoSubtitles.bind(this));
        this.player.addEventListener(PlayerEvent.VIDEO_START, selectStartLanguage.bind(this));
        this.player.addEventListener(PlayerEvent.AD_START, onAdStart.bind(this));
        this.player.addEventListener(PlayerEvent.VIDEO_TIMEUPDATE, checkForEmbeddedSubtitles.bind(this));
        this.addEventListener(SubtitlesManagerEvent.LANGUAGE_SELECTED, onLanguageSelected.bind(this));
        this.player.addEventListener(vdb.html5.player.VIDEO_READY, function() {
            var adController = this.controller.getAdController();
            if (adController) {
                adController.addEventListener(AdEvent.AD_BLOCKER_STARTED, hideOnAdStart.bind(this));
                adController.addEventListener(AdEvent.AD_BLOCKER_COMPLETE, showOnAdEnd.bind(this));
            }
        }.bind(this));
    };
    return{init:function(controller) {
        var userSettings = vdb.localStorage.getItem(UserSettingsStorageKey);
        var container = controller.getContainer();
        LOGGER.debug("init");
        this._super();
        sourceStatus = vdb.html5.subtitles.SubtitlesManager.sourceStatus;
        supportedFormats = vdb.html5.subtitles.SubtitlesManager.supportedFormats;
        this.controller = controller;
        this.player = controller.getPlayer();
        this.display = vdb.html5.player.Display.getInstance();
        this.defaultSettings = new vdb.html5.subtitles.SettingsModel;
        this.userSettings = userSettings ? JSON.parse(userSettings) : new vdb.html5.subtitles.SettingsModel;
        this.view = new vdb.html5.subtitles.SubtitlesView(container, this.display);
        this.view.render(this.userSettings);
        this.loadedCues = {};
        this.macroLanguage = vdb.ctx.getMacro(vdb.constants.PlayerMacros.SUBSCRIPT_LANGUAGE);
        initEvents.call(this);
        initSubscriptSettings.call(this);
    }, checkForAdSubtitles:function(subtitles) {
        this.subtitles = subtitles;
        checkForSubtitles.call(this);
    }, off:function() {
        LOGGER.debug("off");
        this.currentLanguage = null;
        this.disable();
    }, setLanguage:function(languageCode) {
        if (!languageCode) {
            return;
        }
        LOGGER.debug("setLanguage", languageCode);
        this.currentLanguage = languageCode;
        getSubtitles.call(this, languageCode);
        var data = {"interactionType":vdb.enums.UserInteraction.CC_SELECT_LANGUAGE, "interactionData":languageCode + (this.isNativeLanguage(languageCode) ? "" : "_auto")};
        this.player.dispatchEvent(PlayerEvent.USER_INTERACTION, data);
    }, enable:function(languageCode) {
        if (this.isEnabled) {
            return;
        }
        if (!this.currentLanguage && languageCode) {
            this.setLanguage(languageCode);
            return;
        }
        LOGGER.debug("enable", languageCode);
        addEvents.call(this);
        this.view.setTextSize();
        this.isEnabled = true;
        this.player.dispatchEvent(PlayerEvent.SUBTITLES_ENABLED);
    }, disable:function() {
        if (!this.isEnabled) {
            return;
        }
        LOGGER.debug("disable");
        this.view.hide();
        removeEvents.call(this);
        this.isEnabled = false;
        this.player.dispatchEvent(PlayerEvent.SUBTITLES_DISABLED);
    }, enabled:function() {
        return this.isEnabled;
    }, hide:function() {
        LOGGER.debug("hide");
        this.view.hide();
    }, getSubtitles:function() {
        return this.subtitles;
    }, hasSubtitles:function() {
        return this.subtitles && $.getObjectSize(this.subtitles) > 0;
    }, hasExternalSubtitles:function() {
        return this._externalSubtitles && $.getObjectSize(this._externalSubtitles) > 0;
    }, updateSetting:function(key, value) {
        this.userSettings[key] = value;
        vdb.localStorage.setItem(UserSettingsStorageKey, JSON.stringify(this.userSettings));
        this.view.render(this.userSettings);
    }, getSetting:function(key) {
        return this.userSettings[key];
    }, resetSettings:function() {
        vdb.localStorage.removeItem(UserSettingsStorageKey);
        this.userSettings = new vdb.html5.subtitles.SettingsModel;
        this.view.render(this.userSettings);
    }, isSubscriptEnabled:function() {
        return this.hasExternalSubtitles() && (subscriptMode === SubscriptMode.ON || subscriptMode === SubscriptMode.AUTO_DETECT);
    }, getStartLanguage:function() {
        return this.startLanguage;
    }, isNativeLanguage:function(language) {
        return typeof this.subtitles[language] !== "undefined";
    }, isEnabled:false, currentLanguage:null, sources:[], loadedCues:{}, contextBindGroup:null};
}());
(function(def) {
    var SubtitlesFormat = vdb.html5.subtitles.Format;
    def.sourceStatus = {IDLE:0, FAIL:1, SUCCESS:2};
    def.supportedFormats = [SubtitlesFormat.TT, SubtitlesFormat.DFXP, SubtitlesFormat.SRT, SubtitlesFormat.VTT, SubtitlesFormat.EMBEDDED];
})(vdb.html5.subtitles.SubtitlesManager);
vdb.tracking.HeartBeatTracker = vdb.tracking.PlayerPixelTrackerBase.extend(function() {
    var LOGGER = vdb.log.getLogger("HeartBeatTracker");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var HEARTBEAT = 20 * 1E3;
    var track = function() {
        var params = {};
        var isDelta = true;
        this.bufferedParams(params, isDelta);
        this.videoPlayedTimeParam(params);
        this.videoParams(params);
        this.sizeParams(params);
        this.skinParams(params);
        this.viewabilityParams(params);
        this.callPixel("heartbeat.gif", params);
    };
    var startTracker = function() {
        var isAutoStart = true;
        var isRecurring = true;
        if (!this._tracker.isRunning()) {
            this._tracker.schedule(track.bind(this), HEARTBEAT, isAutoStart, isRecurring);
            this._bufferedCalculator.reset();
        }
    };
    var stopTracker = function() {
        this._tracker.stop();
        this._tracker.clean();
    };
    var pauseTracker = function() {
        this._tracker.pause();
    };
    var resumeTracker = function() {
        this._tracker.resume();
    };
    var unbindLiveEvents = function() {
        LOGGER.debug("unbindLiveEvents");
        this._player.removeEventListener(PlayerEvent.VIDEO_PLAY, resumeTracker.bind(this));
        this._player.removeEventListener(PlayerEvent.VIDEO_PAUSE, pauseTracker.bind(this));
        this._player.removeEventListener(PlayerEvent.LIVE_IS_OFF, stopTracker.bind(this));
        this._player.removeEventListener(PlayerEvent.LIVE_IS_OFF, unbindLiveEvents.bind(this));
    };
    var bindLiveEvents = function() {
        LOGGER.debug("bindLiveEvents");
        this._player.addEventListener(PlayerEvent.VIDEO_PLAY, resumeTracker.bind(this));
        this._player.addEventListener(PlayerEvent.VIDEO_PAUSE, pauseTracker.bind(this));
        this._player.addEventListener(PlayerEvent.LIVE_IS_OFF, stopTracker.bind(this));
        this._player.addEventListener(PlayerEvent.LIVE_IS_OFF, unbindLiveEvents.bind(this));
    };
    var bindEvents = function() {
        LOGGER.debug("bindEvents");
        this._player.addEventListener(PlayerEvent.LIVE_IS_ON, startTracker.bind(this));
        this._player.addEventListener(PlayerEvent.LIVE_IS_ON, bindLiveEvents.bind(this));
    };
    return{init:function(controller, context) {
        LOGGER.debug("init");
        this._super(context);
        this._controller = controller;
        this._context = context;
        this._player = controller.getPlayer();
        this._trackingUrl = context.urls.TRACKING_LSTR_URL;
        this._tracker = new vdb.utils.Timer;
        bindEvents.call(this);
    }};
}());
vdb.html5.tracking = {};
vdb.html5.tracking.InteractionTracker = vdb.tracking.PlayerPixelTrackerBase.extend(function() {
    var PlayerEvent = vdb.constants.PlayerEvent;
    var buildEventMap = function() {
        var UserInteraction = vdb.enums.UserInteraction;
        var ClickToVastInteraction = vdb.enums.ClickToVastInteraction;
        this._clickEventMap = {};
        this._clickEventMap[UserInteraction.MUTE] = ClickToVastInteraction.MUTE;
        this._clickEventMap[UserInteraction.UNMUTE] = ClickToVastInteraction.UNMUTE;
        this._clickEventMap[UserInteraction.PLAY] = ClickToVastInteraction.PLAY;
        this._clickEventMap[UserInteraction.PAUSE] = ClickToVastInteraction.PAUSE;
        this._clickEventMap[UserInteraction.ENTER_FULLSCREEN] = ClickToVastInteraction.ENTER_FULLSCREEN;
        this._clickEventMap[UserInteraction.EXIT_FULLSCREEN] = ClickToVastInteraction.EXIT_FULLSCREEN;
        this._clickEventMap[UserInteraction.REPLAY] = ClickToVastInteraction.REPLAY;
        this._clickEventMap[UserInteraction.VIDEO] = UserInteraction.VIDEO;
        this._clickEventMap[UserInteraction.CC_SELECT_LANGUAGE] = UserInteraction.CC_SELECT_LANGUAGE;
        this._clickEventMap[UserInteraction.CC_ACTIVATED] = UserInteraction.CC_ACTIVATED;
        this._clickEventMap[UserInteraction.CC_DEACTIVATED] = UserInteraction.CC_DEACTIVATED;
        this._actionEventMap = {};
        this._actionEventMap[UserInteraction.HOVER] = UserInteraction.HOVER;
        this._actionEventMap[UserInteraction.SEEK_END] = UserInteraction.SEEK_END;
    };
    var reportClick = function(category, interactionData) {
        var loggerParams = this._context.getLoggerParams();
        var currentVideo = this._controller.getCurrentVideo();
        var videoTime = this._controller.getPlayerState()["currentTime"];
        var adConfig = this._controller.getAdConfigEntry();
        var parameters = {};
        this.generatePixelParams({"uid":loggerParams["uid"], "imid":loggerParams["imid"], "t":!isNaN(videoTime) ? videoTime : 0, "cd":"none", "vpl":this._context.getParam(vdb.enums.ContextParams.IS_FLOATED) ? 1 : 0, "epl":loggerParams["epl"] || "0"}, {"vid":currentVideo && currentVideo.id, "asid":adConfig && adConfig._asid, "acid":adConfig && adConfig._acid, "rid":adConfig && adConfig._rid}, parameters);
        if (category !== undefined) {
            parameters["ct"] = category;
        }
        if (interactionData !== undefined) {
            parameters["cd"] = interactionData;
        }
        this.callPixel("click.gif", parameters);
    };
    var reportAction = function(actionType) {
        var isAd = this._display.isAd();
        var adTime = isAd ? this._display.getCurrentTime() : null;
        var contentTime = this._display.isPreroll() ? 0 : this._display.getMainAreaCurrentTime();
        this._tracker.action(actionType, adTime, contentTime);
    };
    var onInteraction = function(event) {
        var data = event["data"] || {};
        var interactionType = data["interactionType"];
        var mappedEvent = this._clickEventMap[interactionType];
        var actionMappedEvent = this._actionEventMap[interactionType];
        if (mappedEvent) {
            reportClick.call(this, mappedEvent, data["interactionData"]);
        }
        if (actionMappedEvent) {
            reportAction.call(this, actionMappedEvent);
        }
    };
    return{init:function(_context, _controller) {
        this._super(_context);
        this._context = _context;
        this._controller = _controller;
        this._display = vdb.html5.player.Display.getInstance();
        this._tracker = _context.ctx.createBasicTracker();
        var player = _controller.getPlayer();
        buildEventMap.call(this);
        player.addEventListener(PlayerEvent.USER_INTERACTION, onInteraction.bind(this));
        player.addEventListener(PlayerEvent.PLAYER_API_INTERACTION, onInteraction.bind(this));
    }};
}());
vdb.html5.utils = {};
vdb.html5.utils.BufferedCalculator = vdb.core.Class.extend(function() {
    function resetBufferingMap(bufferingMap) {
        [ACCURACY_BUFFER, ACCURACY_WAIT].forEach(function(accuracyLevel) {
            bufferingMap[accuracyLevel] = bufferingMap[accuracyLevel] || {};
            bufferingMap[accuracyLevel].start = bufferingMap[accuracyLevel].start || null;
            bufferingMap[accuracyLevel].delta = 0;
            bufferingMap[accuracyLevel].total = 0;
        });
    }
    function getMostAccurateLevel(bufferingMap) {
        var mostAccurate = -1;
        [ACCURACY_BUFFER, ACCURACY_WAIT].forEach(function(accuracyLevel) {
            if (accuracyLevel > mostAccurate && bufferingMap[accuracyLevel].total) {
                mostAccurate = accuracyLevel;
            }
        });
        return mostAccurate;
    }
    function _onBufferingStart(accuracyLevel) {
        this._bufferingMap[accuracyLevel].start = Date.now();
    }
    function _onBufferingEnd(accuracyLevel) {
        var bufferingTime;
        var buffering = this._bufferingMap[accuracyLevel];
        if (buffering.start) {
            bufferingTime = Date.now() - buffering.start;
            buffering.total += bufferingTime;
            buffering.delta += bufferingTime;
            buffering.start = null;
        }
    }
    function calcTotalBuffered(buffered, minTime) {
        var i;
        var totalBuffered = 0;
        if (buffered) {
            for (i = 0;i < buffered.length;i++) {
                var start = buffered.start(i);
                var end = buffered.end(i);
                if (end > minTime) {
                    start = start > minTime ? start : minTime;
                    totalBuffered += end - start;
                    minTime = end;
                }
            }
        }
        return{total:totalBuffered, last:minTime};
    }
    function _bindEvents() {
        this._environment.addEventListener(EnvironmentEvent.VIDEO_WAITING, _onBufferingStart.bind(this, ACCURACY_WAIT));
        this._environment.addEventListener(EnvironmentEvent.VIDEO_PLAY, _onBufferingEnd.bind(this, ACCURACY_WAIT));
        this._environment.addEventListener(EnvironmentEvent.BUFFERING_START, _onBufferingStart.bind(this, ACCURACY_BUFFER));
        this._environment.addEventListener(EnvironmentEvent.BUFFERING_END, _onBufferingEnd.bind(this, ACCURACY_BUFFER));
    }
    function _unbindEvents() {
        this._environment.removeEventListener(EnvironmentEvent.VIDEO_WAITING, _onBufferingStart.bind(this, ACCURACY_WAIT));
        this._environment.removeEventListener(EnvironmentEvent.VIDEO_PLAY, _onBufferingEnd.bind(this, ACCURACY_WAIT));
        this._environment.removeEventListener(EnvironmentEvent.BUFFERING_START, _onBufferingStart.bind(this, ACCURACY_BUFFER));
        this._environment.removeEventListener(EnvironmentEvent.BUFFERING_END, _onBufferingEnd.bind(this, ACCURACY_BUFFER));
    }
    var EnvironmentEvent = vdb.events.EnvironmentEvent;
    var ACCURACY_WAIT = 0;
    var ACCURACY_BUFFER = 1;
    return{init:function(params) {
        this._environment = params[vdb.enums.Dependencies.ENVIRONMENT];
        this._bufferingMap = {};
        this.reset();
        _bindEvents.call(this);
    }, calcBufferedTimeRanges:function(buffered, isDelta) {
        var minTime = isDelta ? this._lastBufferedEnd : 0;
        var res = calcTotalBuffered.call(this, buffered, minTime);
        if (isDelta) {
            this._lastBufferedEnd = res.last;
        }
        return res.total;
    }, reset:function() {
        this._lastBufferedEnd = 0;
        resetBufferingMap(this._bufferingMap);
    }, getBufferingTime:function(isDelta) {
        var res = null;
        var accuracyLevel = getMostAccurateLevel(this._bufferingMap);
        var buffering = this._bufferingMap[accuracyLevel];
        if (buffering) {
            if (isDelta) {
                res = buffering.delta || null;
                buffering.delta = 0;
            } else {
                res = buffering.total || null;
            }
        }
        return res;
    }, dispose:function() {
        _unbindEvents.call(this);
    }};
}());
vdb.html5.utils.BufferedCalculator.$dependencies = [vdb.enums.Dependencies.ENVIRONMENT];
vdb.html5.utils.HlsBitrateTracker = vdb.core.Class.extend(function() {
    function _getHlsAvgBitrate(isDelta) {
        var avgBitrate = null;
        if (this._hlsTotalBitrate && this._hlsLevelCount) {
            avgBitrate = this._hlsTotalBitrate / this._hlsLevelCount / 1024;
        }
        if (isDelta) {
            this._hlsTotalBitrate = 0;
            this._hlsLevelCount = 0;
        }
        return avgBitrate;
    }
    function _onBitrateUpdate(data) {
        if (data) {
            this._hlsTotalBitrate += data.bitrate || 0;
            this._hlsLevelCount += 1;
        }
    }
    function _bindEvents() {
        this._environment.addEventListener(EnvironmentEvent.BITRATE_UPDATE, _onBitrateUpdate.bind(this));
    }
    function _unbindEvents() {
        this._environment.removeEventListener(EnvironmentEvent.BITRATE_UPDATE, _onBitrateUpdate.bind(this));
    }
    var EnvironmentEvent = vdb.events.EnvironmentEvent;
    return{init:function(params) {
        this._environment = params[vdb.enums.Dependencies.ENVIRONMENT];
        this._hlsTotalBitrate = 0;
        this._hlsLevelCount = 0;
        _bindEvents.call(this);
    }, getAvgBitrate:function(isDelta) {
        return _getHlsAvgBitrate.call(this, isDelta);
    }, dispose:function() {
        _unbindEvents.call(this);
    }};
}());
vdb.html5.utils.HlsBitrateTracker.$dependencies = [vdb.enums.Dependencies.ENVIRONMENT];
vdb.html5.utils.Html5PlayerUtils = function() {
    function buildMargin(top, left) {
        return top + "% 0 0 " + left + "%";
    }
    function setContainerLocation(container, location) {
        var isResponsiveOrVPAID = vdb.ctx.isVPAID || vdb.ctx.isResponsive;
        var containerMargin = !isResponsiveOrVPAID ? buildMargin(location.marginTop, location.marginLeft) : "0";
        var containerStyle = {"position":"relative", "overflow":"hidden", "margin":containerMargin, "height":"100%", "width":"100%"};
        vdb.Utils.setStyle(container, containerStyle);
    }
    function setContainerHeight(container, height) {
        vdb.Utils.setStyle(container, {"height":"calc(100% - " + height + "px)"});
    }
    return{setContainerLocation:setContainerLocation, setContainerHeight:setContainerHeight};
}();
vdb.html5.utils.scroll = {};
vdb.html5.utils.scroll.ScrollBase = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var ELASTIC_SCALE = .01;
    var VELOCITY_MAX_SAMPLING = 10;
    var EASING_DISTANCE = 8;
    var EASING_THRESHOLD = 30;
    var getScrollRangeSize = function() {
        return Math.max(this.scrollableElem[this.clientSize] - this.scrollableElemContainer[this.clientSize], 0);
    };
    var onScrollableElemTouchStart = function(e) {
        this.enableTransition(null, false);
        this.elasticFactorEnabled = true;
        this.prevTouchPos = this.getTouchPos(e);
    };
    var onScrollableElemTouchMove = function(e) {
        var touchPos = this.getTouchPos(e);
        var dir = this.scrollDir == "left" ? 1 : -1;
        var dist = touchPos - this.prevTouchPos;
        e.preventDefault();
        updateVelocity.call(this, touchPos);
        this.scrollByDistance(dist * dir);
        this.prevTouchPos = touchPos;
    };
    var onScrollableElemTouchEnd = function(e) {
        var touchPos = this.getTouchPos(e);
        var curPos = parseFloat(this.scrollableElem.style[this.scrollDir]);
        var scrollRangeSize = getScrollRangeSize.call(this);
        var dir = this.scrollDir == "left" ? 1 : -1;
        var dist;
        this.enableTransition(null, true);
        this.elasticFactorEnabled = false;
        updateVelocity.call(this, touchPos);
        dist = this.velocity * EASING_DISTANCE;
        if (Math.abs(dist) > EASING_THRESHOLD || curPos < 0 || curPos > scrollRangeSize * -1) {
            this.scrollByDistance(dist * dir);
        }
        this.prevTouchPos = touchPos;
        this.velocity = 0;
        this.velocitySamplingCount = 0;
    };
    var updateVelocity = function(pos) {
        var samplingCount = Math.min(VELOCITY_MAX_SAMPLING, ++this.velocitySamplingCount);
        var dist = pos - this.prevTouchPos;
        var v;
        if (this.velocity * dist >= 0) {
            v = (this.velocity * (samplingCount - 1) + dist) / samplingCount;
        } else {
            this.velocitySamplingCount = 0;
            v = dist;
        }
        this.velocity = v;
    };
    var addElasticFactor = function(x) {
        var sign = x > 0 ? 1 : -1;
        x = Math.abs(x);
        return x / (ELASTIC_SCALE * x + 1) * sign;
    };
    var addEvents = function() {
        if (utl.mobileOs()) {
            this.velocity = 0;
            this.velocitySamplingCount = 0;
            this.scrollableElem.addEventListener("touchstart", onScrollableElemTouchStart.bind(this));
            this.scrollableElem.addEventListener("touchmove", onScrollableElemTouchMove.bind(this));
            this.scrollableElem.addEventListener("touchend", onScrollableElemTouchEnd.bind(this));
        }
    };
    return{init:function(scrollbarType, scrollableElem, scrollContainer) {
        if (scrollbarType == vdb.html5.utils.scroll.Orientation.HORIZONTAL) {
            this.scrollDir = "left";
            this.clientSize = "clientWidth";
        } else {
            this.scrollDir = "top";
            this.clientSize = "clientHeight";
        }
        this.scrollableElem = scrollableElem;
        this.scrollableElemContainer = scrollableElem.parentNode;
        this.scrollContainer = scrollContainer;
        addEvents.call(this);
    }, scrollToPrct:function(prct) {
        this.scrollableElem.style[this.scrollDir] = getScrollRangeSize.call(this) * prct * -1 + "px";
        this.scrollPrct = prct;
    }, scrollByDistance:function(pixels) {
        var scrollPoint = parseFloat(this.scrollableElem.style[this.scrollDir]) + pixels;
        var negativeScrollRangeSize = getScrollRangeSize.call(this) * -1;
        if (scrollPoint > 0) {
            scrollPoint = this.elasticFactorEnabled ? addElasticFactor(scrollPoint) : 0;
        } else {
            if (scrollPoint < negativeScrollRangeSize) {
                scrollPoint = this.elasticFactorEnabled ? negativeScrollRangeSize + addElasticFactor(scrollPoint - negativeScrollRangeSize) : negativeScrollRangeSize;
            }
        }
        this.scrollableElem.style[this.scrollDir] = scrollPoint + "px";
        this.scrollPrct = Math.max(Math.min(scrollPoint / negativeScrollRangeSize, 1), 0);
    }, resize:function(initialResize) {
        if (initialResize) {
            setTimeout(function() {
                this.resize();
            }.bind(this), 1E3);
        }
        this.scrollToPrct(this.scrollPrct);
    }, enableTransition:function(scroller, enable) {
        var transition = enable ? this.scrollDir + " .5s ease-out" : "";
        if (scroller) {
            scroller.style["transition"] = transition;
            scroller.style["-moz-transition"] = transition;
            scroller.style["-webkit-transition"] = transition;
        }
        this.scrollableElem.style["transition"] = transition;
        this.scrollableElem.style["-moz-transition"] = transition;
        this.scrollableElem.style["-webkit-transition"] = transition;
    }, getCursorPos:function(e) {
        return this.scrollDir == "left" ? e.pageX : e.pageY;
    }, getTouchPos:function(e) {
        var touch = e.changedTouches[0];
        return this.scrollDir == "left" ? touch.pageX : touch.pageY;
    }, elasticFactorEnabled:false, scrollPrct:0, disabled:false};
}());
(function(def) {
    def.Orientation = {VERTICAL:"vertical", HORIZONTAL:"horizontal"};
})(vdb.html5.utils.scroll);
vdb.html5.utils.scroll.ScrollBar = vdb.html5.utils.scroll.ScrollBase.extend(function() {
    var buildScrollbar = function() {
        this.scrollbarTrack = vdb.Utils.createElement("div", {"class":"scrollbar-track", "style":"position: absolute;"}, this.scrollContainer);
        this.scrollbarThumb = vdb.Utils.createElement("div", {"class":"scrollbar-thumb", "style":"position: relative;"}, this.scrollbarTrack);
    };
    var getTrackRangeSize = function() {
        return this.scrollbarTrack[this.clientSize] - this.scrollbarThumb[this.clientSize];
    };
    var onScroll = function() {
        if (typeof this.onScrollCallback === "function") {
            this.onScrollCallback();
        }
    };
    var setScrollbarThumbPos = function() {
        onScroll.call(this);
        if (!this.disabled) {
            this.scrollbarThumb.style[this.scrollDir] = getTrackRangeSize.call(this) * this.scrollPrct + "px";
        }
    };
    var scrollOnMouseAction = function(e) {
        var cursorPos = this.getCursorPos(e);
        var scrollbarTrackOffset = this.scrollbarTrack.getBoundingClientRect()[this.scrollDir];
        var trackRangeSize = getTrackRangeSize.call(this);
        var scrollPoint = Math.max(Math.min(cursorPos - scrollbarTrackOffset - this.scrollbarThumb[this.clientSize] / 2, trackRangeSize), 0);
        this.scrollToPrct(scrollPoint / trackRangeSize);
    };
    var onScrollbarTrackMouseDown = function(e) {
        this.enableTransition(true);
        scrollOnMouseAction.call(this, e);
    };
    var onScrollbarThumbMouseDown = function(e) {
        e.stopPropagation();
        this.enableTransition(false);
        this.contextBindGroup = new vdb.events.EventContextBindGroup(vdb.events.EventContext.bind(this.scrollableElemContainer.ownerDocument, "mousemove", onDocumentMouseMove.bind(this)), vdb.events.EventContext.bind(this.scrollableElemContainer.ownerDocument, "mouseup", onDocumentMouseUp.bind(this)));
    };
    var onDocumentMouseMove = function(e) {
        scrollOnMouseAction.call(this, e);
    };
    var onDocumentMouseUp = function() {
        this.contextBindGroup.unbind();
    };
    var onScrollableElemContainerWheel = function(e) {
        if (this.disabled) {
            return;
        }
        e.preventDefault();
        this.enableTransition(false);
        this.scrollByDistance(e.deltaY);
    };
    var addEvents = function() {
        if (!vdb.Utils.mobileOs()) {
            this.scrollbarTrack.addEventListener("mousedown", onScrollbarTrackMouseDown.bind(this));
            this.scrollbarThumb.addEventListener("mousedown", onScrollbarThumbMouseDown.bind(this));
            this.scrollableElemContainer.addEventListener("wheel", onScrollableElemContainerWheel.bind(this));
        }
    };
    var setVisibility = function() {
        if (this.scrollableElem[this.clientSize] <= this.scrollableElemContainer[this.clientSize]) {
            vdb.utils.Common.hide(this.scrollbarTrack);
            this.disabled = true;
        } else {
            vdb.utils.Common.show(this.scrollbarTrack);
            this.disabled = false;
        }
    };
    return{init:function(scrollbarType, scrollableElem, scrollbarContainer) {
        this._super(scrollbarType, scrollableElem, scrollbarContainer);
        buildScrollbar.call(this);
        addEvents.call(this);
        this.resize(true);
    }, scrollToPrct:function(prct) {
        this._super(prct);
        setScrollbarThumbPos.call(this);
    }, scrollByDistance:function(pixels) {
        this._super(pixels * -1);
        setScrollbarThumbPos.call(this);
    }, resize:function(initialResize) {
        if (this.scrollableElemContainer[this.clientSize] > 0) {
            setVisibility.call(this);
        } else {
            if (!initialResize) {
                return;
            }
        }
        this._super(initialResize);
    }, enableTransition:function(enable) {
        this._super(this.scrollbarThumb, enable);
    }};
}());
vdb.html5.player.BarChart = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var NUM_OF_DOTTED_BOXES = 20;
    var THRESHOLD_MAP = [{threshold:50, base:10}, {threshold:100, base:20}, {threshold:200, base:50}, {threshold:500, base:100}, {threshold:1E3, base:200}, {threshold:2E3, base:500}, {threshold:5E3, base:1E3}];
    var COLORS_TYPES = {BAR_COLOR:"barColor", ROW_TITLE_COLOR:"rowTitleColor"};
    var onWaterfallEnd = function() {
        this.bars.forEach(function(bar) {
            var durationElement = bar.querySelector(".duration");
            if (bar.getBoundingClientRect().left <= durationElement.getBoundingClientRect().left) {
                utl.addClass(durationElement, "visible");
            } else {
                bar.setAttribute("title", durationElement.innerText);
            }
        });
    };
    var onWindowResize = function() {
        if (this.scrollbar) {
            this.scrollbar.resize();
        }
    };
    var getRows = function() {
        function getRow(label, numOfCols, durationColIndex, rowTitleColor) {
            function buildDottedBoxes(container) {
                for (var remainingBoxesToBuild = NUM_OF_DOTTED_BOXES;remainingBoxesToBuild;) {
                    utl.createElement("div", {"class":"dotted-box"}, container);
                    remainingBoxesToBuild--;
                }
            }
            var row = utl.createElement("li", {});
            for (var j = 0;j < numOfCols;j++) {
                var column = utl.createElement("div", {}, row);
                switch(j) {
                    case 0:
                        column.className = "row-title";
                        column.innerHTML = label || "";
                        if (rowTitleColor) {
                            utl.setStyle(column, {"background-color":rowTitleColor});
                        }
                        break;
                    case durationColIndex:
                        buildDottedBoxes(column);
                        column.className = "row-duration";
                        break;
                    default:
                        buildDottedBoxes(column);
                        break;
                }
            }
            return row;
        }
        function getEndLine(left) {
            return utl.createElement("div", {"class":"end-line", "style":"left:" + left + "%"});
        }
        function setBarChartWaterfallAnimation(currentBarChart, nextBarChart) {
            currentBarChart.addEventListener("transitionend", function() {
                utl.addClass(nextBarChart, "expand-width");
            });
        }
        function getBar(start, duration, lastThreshold, color) {
            var precentOfDurationFromRow = duration / lastThreshold * 100;
            var barWrapper = utl.createElement("div", {"class":"bar-wrapper", "style":"width:" + precentOfDurationFromRow + "%; left:" + start / lastThreshold * 100 + "%"});
            var bar = utl.createElement("div", {"class":"bar", "style":"background-color: " + color}, barWrapper);
            utl.createElement("div", {"class":"duration"}, bar, Math.floor(duration));
            return barWrapper;
        }
        function getColorByBarType(barType, colorType) {
            var result = utl.find(this.config.types, function(typeObj) {
                return typeObj.name === barType;
            });
            return result && result[colorType];
        }
        var rows;
        rows = utl.createElement("ul", {});
        this.config.data.forEach(function(data) {
            var precentOfTotalTimeFromRow = this.config.totalDuration / this.lastThreshold * 100;
            var row = getRow(data.label, this.config.columns.length, this.config.durationColIndex, getColorByBarType.call(this, data.type, COLORS_TYPES.ROW_TITLE_COLOR));
            var durationColumn = row.children[this.config.durationColIndex];
            var bar = getBar(data.start, data.duration, this.lastThreshold, getColorByBarType.call(this, data.type, COLORS_TYPES.BAR_COLOR));
            var endLine = getEndLine(precentOfTotalTimeFromRow);
            utl.addClass(bar.children[0], data.type);
            rows.appendChild(row);
            durationColumn.appendChild(bar);
            durationColumn.appendChild(endLine);
            this.bars = this.bars || [];
            this.bars.push(bar.children[0]);
        }.bind(this));
        for (var i = 0;i < this.bars.length - 1;i++) {
            setBarChartWaterfallAnimation.call(this, this.bars[i], this.bars[i + 1]);
        }
        this.bars[this.bars.length - 1].addEventListener("transitionend", onWaterfallEnd.bind(this));
        return rows;
    };
    var getAndCalculateFirstThreshold = function() {
        function getBase(data) {
            var result;
            for (var i = 0;i < THRESHOLD_MAP.length - 1;i++) {
                if (data >= THRESHOLD_MAP[i].threshold && data < THRESHOLD_MAP[i + 1].threshold || data >= THRESHOLD_MAP[i + 1].threshold) {
                    result = THRESHOLD_MAP[i + 1].base;
                    break;
                } else {
                    if (data < THRESHOLD_MAP[i].threshold) {
                        result = THRESHOLD_MAP[i].base;
                        break;
                    }
                }
            }
            return result;
        }
        var firstThreshold;
        var base;
        firstThreshold = this.config.totalDuration * 1.2 / NUM_OF_DOTTED_BOXES;
        base = getBase(firstThreshold);
        firstThreshold = Math.ceil(firstThreshold / base) * base;
        return firstThreshold;
    };
    var getThresholdRow = function() {
        var currentThreshold = 0;
        var thresholdRow = utl.createElement("div", {"class":"threshold-row"});
        var thresholdContent = utl.createElement("div", {"class":"threshold-content"}, thresholdRow);
        for (var i = 0;i < NUM_OF_DOTTED_BOXES;i++) {
            utl.createElement("div", {}, thresholdContent, utl.roundByDigit(currentThreshold / 1E3, 2) + "s");
            currentThreshold += this.firstThreshold;
        }
        return thresholdRow;
    };
    var buildControls = function() {
        this.barChartWrapper = utl.createElement("div", {"class":"bar-chart"}, this.wrapper);
        this.header = utl.createElement("div", {"class":"bar-chart-header"}, this.barChartWrapper);
        this.config.columns.forEach(function(colName) {
            utl.createElement("div", {}, this.header, colName);
        }.bind(this));
        this.rows = getRows.call(this);
        this.barChartWrapper.appendChild(this.rows);
        this.scrollbar = new vdb.html5.utils.scroll.ScrollBar(vdb.html5.utils.scroll.Orientation.VERTICAL, this.rows, this.barChartWrapper);
        this.scrollbar.resize();
        this.wrapper.appendChild(getThresholdRow.call(this));
    };
    return{init:function(wrapper, config) {
        this.wrapper = wrapper;
        this.config = config;
        this.firstThreshold = getAndCalculateFirstThreshold.call(this);
        this.lastThreshold = this.firstThreshold * NUM_OF_DOTTED_BOXES;
        buildControls.call(this);
        vdb.$win.addEventListener("resize", onWindowResize.bind(this));
    }, expandBars:function() {
        utl.addClass(this.bars[0], "expand-width");
    }, collapseBars:function() {
        utl.removeClass(this.bars, "expand-width");
    }, selectGroupOfBars:function(groupType) {
        var groupOfBars = this.barChartWrapper.getElementsByClassName(groupType);
        utl.addClass(groupOfBars, "select");
    }, unselectGroupOfBars:function(groupType) {
        var groupOfBars = this.barChartWrapper.getElementsByClassName(groupType);
        utl.removeClass(groupOfBars, "select");
    }, isBarExpanded:function(barIndex) {
        return utl.hasClass(this.bars[barIndex], "expand-width");
    }};
}());
vdb.html5.player.LoadTimeScreen = vdb.core.Class.extend(function() {
    var utl = vdb.Utils;
    var LOAD_TIME_SCREEN_TITLE = "LOAD TIMES";
    var BAR_CHART_FIRST_COLUMN_TITLE = "PHASES";
    var BAR_CHART_SECOND_COLUMN_TITLE = "TIME (in s)";
    var FOOTER_TITLE = "TOTAL LOADING TIME";
    var DOWNLOAD_BUTTON_TEXT = "Export to CSV";
    var GOOGLE_CHART_SCRIPT_URL = "https://www.gstatic.com/charts/loader.js";
    var COLORS = {PLAYER_BAR:"#5897F8", AD_BAR:"#43CCC9", AD_TITLE:"rgba(67,204,201,0.14)"};
    var BREAKPOINT_TYPE = vdb.loadTime.LoadTimeConstants.BREAKPOINT_TYPE;
    var buildControls = function() {
        this.wrapper = utl.createElement("div", {"class":"load-time-screen"});
        this.container = utl.createElement("div", {"class":"container"}, this.wrapper);
        this.content = utl.createElement("div", {"class":"content"}, this.container);
        this.header = utl.createElement("header", {}, this.content);
        utl.createElement("span", {}, this.header, LOAD_TIME_SCREEN_TITLE);
        this.closeButton = utl.createElement("div", {"style":"width: 14px; height: 14px; fill: #D0D0D0; cursor: pointer;"}, this.header, '<svg class="player-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><polygon points="16.03 13.43 2.6 0 0 2.6 13.42 16.02 0 29.4 2.6 32 16 18.6 29.39 32 32 29.4 18.6 16 32 2.6 29.39 0 16.03 13.43"/></svg>');
        this.barChartWrapper = new vdb.html5.player.BarChart(this.content, {columns:[BAR_CHART_FIRST_COLUMN_TITLE, BAR_CHART_SECOND_COLUMN_TITLE], types:[{"name":BREAKPOINT_TYPE.PLAYER, "barColor":COLORS.PLAYER_BAR}, {"name":BREAKPOINT_TYPE.AD, "barColor":COLORS.AD_BAR, "rowTitleColor":COLORS.AD_TITLE}], data:this.phasesData, durationColIndex:1, totalDuration:this.phasesData && this.phasesData[this.phasesData.length - 1].end});
        this.footer = utl.createElement("footer", {}, this.content);
        this.footerContent = utl.createElement("section", {}, this.footer);
        this.totalLoadingTimeWrapper = utl.createElement("div", {"class":"total-loading-time-wrapper"}, this.footerContent);
        this.loadingTimeLabelElement = utl.createElement("div", {"class":"total-loading-time-label"}, this.totalLoadingTimeWrapper);
        utl.createElement("span", {}, this.loadingTimeLabelElement, FOOTER_TITLE);
        this.loadingTimeDataElement = utl.createElement("div", {"class":"total-loading-time-data"}, this.totalLoadingTimeWrapper);
        utl.createElement("span", {}, this.loadingTimeDataElement, utl.roundByDigit(this.totalLoadTime / 1E3, 2) + " seconds");
        buildPieChart.call(this);
        this.downloadButtonWrapper = utl.createElement("div", {"style":"position: relative; height: 30px"}, this.footerContent);
        utl.createElement("div", {"class":"download-button"}, this.downloadButtonWrapper, DOWNLOAD_BUTTON_TEXT);
    };
    var onCloseButtonClick = function() {
        this.modal.deactivate();
        this.barChartWrapper.collapseBars();
        this.outerParentElement.removeChild(this.wrapper);
        this.visible = false;
    };
    var onDownloadButtonClick = function() {
        var rows = [[BAR_CHART_FIRST_COLUMN_TITLE, BAR_CHART_SECOND_COLUMN_TITLE, "START TIME", "END TIME"]];
        this.phasesData.forEach(function(phase) {
            rows.push([phase.label, phase.duration, phase.start, phase.end]);
        });
        utl.exportToCsv("aol-player-load-time.csv", rows);
    };
    var showScreen = function() {
        setTimeout(function() {
            this.barChartWrapper.expandBars();
            if (this.drawPieChart) {
                this.drawPieChart();
            }
        }.bind(this), 200);
        this.outerParentElement.appendChild(this.wrapper);
        this.modal.activate(this.wrapper, this.container);
        this.visible = true;
    };
    var buildPieChart = function() {
        var pieChartWrapper = utl.createElement("div", {"class":"pie-chart-wrapper"}, this.footerContent);
        var totalPlayerLoadTime = 0;
        var totalAdLoadTime = 0;
        this.phasesData.forEach(function(phase) {
            if (phase.type === BREAKPOINT_TYPE.PLAYER) {
                totalPlayerLoadTime += phase.duration;
            } else {
                if (phase.type === BREAKPOINT_TYPE.AD) {
                    totalAdLoadTime += phase.duration;
                }
            }
        });
        vdb.dom.loadScript(GOOGLE_CHART_SCRIPT_URL).then(function() {
            var charts = window["google"]["charts"];
            charts.load("current", {"packages":["corechart"]});
            charts["setOnLoadCallback"](function() {
                var visualization = window["google"]["visualization"];
                var data = visualization["arrayToDataTable"]([["Task", "Loading Time"], ["PLAYER CORE LOADING", totalPlayerLoadTime], ["AD LOADING", totalAdLoadTime]]);
                var options = {"pieHole":.5, "pieSliceTextStyle":{"color":"black"}, "legend":{"position":"labeled"}, "pieSliceText":"none", "slices":{0:{"color":COLORS.PLAYER_BAR}, 1:{"color":COLORS.AD_BAR}}, "tooltip":{"trigger":"none"}, "backgroundColor":"transparent"};
                var pieChart = new visualization["PieChart"](pieChartWrapper);
                var bindPieChartEvents = function() {
                    visualization["events"]["addListener"](pieChart, "onmouseover", function(e) {
                        if (e["row"] === 0) {
                            this.barChartWrapper.selectGroupOfBars(BREAKPOINT_TYPE.PLAYER);
                        } else {
                            this.barChartWrapper.selectGroupOfBars(BREAKPOINT_TYPE.AD);
                        }
                    }.bind(this));
                    visualization["events"]["addListener"](pieChart, "onmouseout", function(e) {
                        if (e["row"] === 0) {
                            this.barChartWrapper.unselectGroupOfBars(BREAKPOINT_TYPE.PLAYER);
                        } else {
                            this.barChartWrapper.unselectGroupOfBars(BREAKPOINT_TYPE.AD);
                        }
                    }.bind(this));
                };
                this.drawPieChart = function() {
                    pieChart["draw"](data, options);
                };
                if (this.barChartWrapper.isBarExpanded(0)) {
                    this.drawPieChart();
                }
                bindPieChartEvents.call(this);
            }.bind(this));
        }.bind(this));
    };
    var bindEvents = function() {
        this.closeButton.addEventListener("click", onCloseButtonClick.bind(this));
        this.downloadButtonWrapper.addEventListener("click", onDownloadButtonClick.bind(this));
    };
    return{init:function(outerParentElement, data) {
        this.outerParentElement = outerParentElement;
        vdb.dom.embedCssToHead(".load-time-screen{cursor:default}@font-face{font-family:Brown-Bold;src:url(https://cdn.vidible.tv/prod/fonts/Brown-Bold.otf)}@font-face{font-family:Aktiv;src:url(https://cdn.vidible.tv/prod/fonts/Aktiv-Grotesk-Regular.otf)}@font-face{font-family:Brown-Regular;src:url(https://cdn.vidible.tv/prod/fonts/Brown-Regular.otf)}@keyframes pop{50%{transform:scale(1.05)}}.load-time-screen .top-gradient{position:absolute;top:0;left:0;width:100%;height:5px;background:linear-gradient(180deg,#ebebeb 0,rgba(252,252,252,0) 100%)}.load-time-screen .container{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;flex-direction:column;transition:all .3s ease,background-position 1ms;max-height:85%}.load-time-screen .container .content{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;width:100%;height:100%;flex-direction:column;background-color:white}.load-time-screen .container .content>header{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;justify-content:space-between;min-height:40px;padding:0 1.5% 0 2.5%;background-color:#262626;color:#fff;font-family:Brown-Bold,Arial;font-size:12px;font-weight:bold}@font-face{font-family:Brown-Bold;src:url(https://cdn.vidible.tv/prod/fonts/Brown-Bold.otf)}@font-face{font-family:Aktiv;src:url(https://cdn.vidible.tv/prod/fonts/Aktiv-Grotesk-Regular.otf)}@font-face{font-family:Brown-Regular;src:url(https://cdn.vidible.tv/prod/fonts/Brown-Regular.otf)}@keyframes pop{50%{transform:scale(1.05)}}.load-time-screen .container .content .top-gradient{position:absolute;top:0;left:0;width:100%;height:5px;background:linear-gradient(180deg,#ebebeb 0,rgba(252,252,252,0) 100%)}.load-time-screen .container .content .bar-chart{position:relative;overflow:hidden;flex:1;box-shadow:0 0 3px 0 rgba(0,0,0,0.5)}.load-time-screen .container .content .bar-chart:hover .scrollbar-thumb{opacity:1}.load-time-screen .container .content .bar-chart .bar-chart-header{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;min-height:40px;padding:0 1.5% 0 2.5%;align-items:center;font-size:11px;font-family:Brown-Bold,Arial;color:#3c3c3c;box-shadow:0 0 3px 0 rgba(0,0,0,0.5)}.load-time-screen .container .content .bar-chart .bar-chart-header :first-child{flex:1}.load-time-screen .container .content .bar-chart .bar-chart-header :nth-child(2){flex:3}.load-time-screen .container .content .bar-chart ul{position:relative;list-style:none;padding:0;margin:0}.load-time-screen .container .content .bar-chart ul li{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;height:30px;color:#262626;font-size:11.5px;font-family:Aktiv,Arial;border-bottom:1px dotted #e1e1e4}.load-time-screen .container .content .bar-chart ul li>div{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;height:100%;align-items:center}.load-time-screen .container .content .bar-chart ul li .row-title{padding-left:2.5%;flex:1;background-color:#f9f9f9;border-right:1px dotted #e1e1e4;border-bottom:1px dotted #e1e1e4}.load-time-screen .container .content .bar-chart ul li .row-duration{flex:3;position:relative;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex}.load-time-screen .container .content .bar-chart ul li .row-duration .dotted-box{position:relative;height:100%;flex:1;border-right:1px dotted #e1e1e4}.load-time-screen .container .content .bar-chart ul li .row-duration .dotted-box.end-of-load-time{border-color:#9b9b9b}.load-time-screen .container .content .bar-chart ul li .row-duration .bar-wrapper{position:absolute;height:100%;font-family:Brown-Regular,Arial;font-size:11px;color:white}.load-time-screen .container .content .bar-chart ul li .row-duration .bar-wrapper .bar{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;justify-content:flex-end;flex:1;width:0;height:100%;position:relative;overflow:hidden;-webkit-transition-property:all;-moz-transition-property:all;-o-transition-property:all;transition-property:all;-webkit-transition-duration:.1s;-moz-transition-duration:.1s;-o-transition-duration:.1s;transition-duration:.1s;-webkit-transition-timing-function:linear;-moz-transition-timing-function:linear;-o-transition-timing-function:linear;transition-timing-function:linear}.load-time-screen .container .content .bar-chart ul li .row-duration .bar-wrapper .bar.expand-width{width:100%;padding-right:5px;box-sizing:border-box}.load-time-screen .container .content .bar-chart ul li .row-duration .bar-wrapper .bar.expand-width.select{box-shadow:0 0 4px 1px rgba(0,0,0,0.4)}.load-time-screen .container .content .bar-chart ul li .row-duration .bar-wrapper .bar .duration{opacity:0;display:inline-block;-webkit-transition-property:opacity;-moz-transition-property:opacity;-o-transition-property:opacity;transition-property:opacity;-webkit-transition-duration:.7s;-moz-transition-duration:.7s;-o-transition-duration:.7s;transition-duration:.7s;-webkit-transition-timing-function:ease-in;-moz-transition-timing-function:ease-in;-o-transition-timing-function:ease-in;transition-timing-function:ease-in}.load-time-screen .container .content .bar-chart ul li .row-duration .bar-wrapper .bar .duration.visible{opacity:1}.load-time-screen .container .content .bar-chart ul li:hover .bar{animation:pop .3s linear 1;box-shadow:0 0 4px 1px rgba(0,0,0,0.4)}.load-time-screen .container .content .bar-chart ul li:hover .row-title{font-family:Brown-Bold,Arial}.load-time-screen .container .content .bar-chart ul li:last-of-type{border:0}.load-time-screen .container .content .bar-chart ul .end-line{position:absolute;top:0;height:100%;border-bottom:1px solid;width:1px;background-color:black}.load-time-screen .container .content .bar-chart .scrollbar-track{position:absolute;top:0;right:0;width:7px;height:100%;cursor:pointer}.load-time-screen .container .content .bar-chart .scrollbar-track .scrollbar-thumb{position:relative;height:33%;background-color:#d4d4d4;cursor:-webkit-grab;cursor:-moz-grab;opacity:0;-moz-transition:opacity .5s;-webkit-transition:opacity .5s;transition:opacity .5s}.load-time-screen .container .content .threshold-row{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;height:22px;line-height:22px}.load-time-screen .container .content .threshold-row:before{flex:1;display:block;content:'';padding-left:2.5%}.load-time-screen .container .content .threshold-row .threshold-content{font-family:Aktiv,Arial;flex:3;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex}.load-time-screen .container .content .threshold-row .threshold-content>div{flex:1;font-size:9px;color:rgba(38,38,38,0.5)}.load-time-screen .container .content footer{position:relative;padding:0 2.5%;height:80px}.load-time-screen .container .content footer section{height:80px;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;align-items:center;padding-bottom:22px;box-sizing:border-box}.load-time-screen .container .content footer section>div{flex:1}.load-time-screen .container .content footer section .total-loading-time-wrapper .total-loading-time-label{font-family:Brown-Bold,Arial;color:#3c3c3c;font-size:13px;line-height:15px}.load-time-screen .container .content footer section .total-loading-time-wrapper .total-loading-time-data{color:#262626;font-size:14px;font-family:Aktiv,Arial;line-height:16px}.load-time-screen .container .content footer section .pie-chart-wrapper{height:101px;padding-top:10px;box-sizing:border-box;flex:2}.load-time-screen .container .content footer section .pie-chart-wrapper div[dir=ltr]{margin:0 auto}.load-time-screen .container .content footer section .pie-chart-wrapper svg text{font-family:Brown-Bold,Arial;fill:rgba(38,38,38,0.6)}.load-time-screen .container .content footer section .download-button{cursor:pointer;position:absolute;right:0;height:35px;width:146px;border-radius:4px;background-color:#00b9e4;font-family:Aktiv;color:white;font-size:12px;line-height:35px;text-align:center}",
            this.outerParentElement.ownerDocument.head);
        this.modal = new vdb.html5.player.Modal;
        this.phasesData = data["breakpoints"].pop();
        this.totalLoadTime = this.phasesData && this.phasesData[this.phasesData.length - 1].end;
        buildControls.call(this);
        bindEvents.call(this);
        showScreen.call(this);
    }, show:showScreen, isVisible:function() {
        return this.visible;
    }};
}());
window["create"] = function(container, opts, $win, $doc) {
    vdb.$win = $win;
    vdb.$doc = $doc;
    var utl = vdb.Utils;
    var PlaybackMode = vdb.enums.player.PlaybackMode;
    var SoundMode = vdb.enums.player.SoundMode;
    var extraManager = new vdb.modules.ExtraManager("html5", document, vdb, vdb.ctx);
    var player = new vdb.html5.player.Player(container, extraManager, opts.uiTemplate);
    var playerWidget = opts.playerWidget;
    var uiTemplate = opts.uiTemplate;
    var extrasResolver = new vdb.extras.ExtrasResolver(uiTemplate);
    if (opts.bid["videos"].length === 0 && (vdb.ctx.isVPAID || extrasResolver.hasExtra("inreadexpander.js"))) {
        playerWidget["adOnly"] = true;
        uiTemplate["videosToPlay"] = 0;
    }
    var config = {autoplay:uiTemplate["initialization"] === PlaybackMode.AUTOPLAY, fullscreenOnUnmute:uiTemplate["fullscreenOnUnmute"] && !!utl.mobileOs(), mouseoverStart:uiTemplate["initialization"] === PlaybackMode.MOUSEOVER, volume:uiTemplate["initialVolume"], sound:uiTemplate["sound"], videosToPlay:uiTemplate["videosToPlay"] || 0, controlsConfig:uiTemplate["controlsConfig"], adConfig:opts.adConfig, autoplayInView:opts.autoplayInView, autoPauseOutOfView:uiTemplate["autoPauseOutOfView"], isAol:playerWidget["isAol"],
        adOnly:playerWidget["adOnly"], previewPoster:uiTemplate["previewPoster"] || vdb.html5.enums.PreviewPosterType.STATIC, timeLinePreview:uiTemplate["timelinepreview"], covering:uiTemplate["coveringsHtml"], skin:uiTemplate["html5Skin"], shuffleVideos:!!uiTemplate["shuffleVideos"], playerWidget:playerWidget};
    config.muted = [SoundMode.MUTED, SoundMode.MOUSEOVER, SoundMode.MOUSEOVER_OFF].indexOf(config.sound) !== -1;
    config.adConfig.autoplayAdOnly = uiTemplate["initialization"] === PlaybackMode.AUTOPLAY_AD_ONLY;
    config.adConfig.autoplay = config.autoplay || config.adConfig.autoplayAdOnly;
    config.adConfig.volume = config.volume;
    config.adConfig.autoplayInView = config.autoplayInView;
    config.adConfig.publisherPayout = uiTemplate["publisherPayout"];
    config.adConfig.publisherAmount = uiTemplate["publisherAmount"];
    if (config.adOnly) {
        if (opts.bid["videos"].length > 0) {
            config.adPosterVideo = opts.bid["videos"][0];
        }
        opts.bid = {"videos":[]};
    }
    if (config.shuffleVideos) {
        vdb.utils.Common.shuffleArray(opts.bid["videos"]);
    }
    player.configure(config, opts.bid);
    return player;
};
vdb.html5.player.Player = vdb.EventBus.extend(function() {
    function cssSize(val) {
        return val ? val + "px" : "0";
    }
    function _initBackground() {
        var div;
        var style;
        var conf = vdb.ctx.api.uiTemplate;
        if (conf["backgroundFill"]) {
            style = "position:absolute;left:0;top:0;width:100%;height:100%;z-index:-1;background-color:" + vdb.player.bgColor;
            div = vdb.dom.nodeFromHTML("<div style='" + style + "'></div>");
            this._element.appendChild(div);
        }
        if (conf["backgroundSkin"]) {
            var style_image = "background-image:url(" + conf["backgroundSkin"] + ");";
            var style_sizes;
            var sl = conf["backgroundSkinLocation"];
            if (sl && (sl["w"] || sl["h"])) {
                var l = cssSize(sl["x"]);
                var t = cssSize(sl["y"]);
                var w = cssSize(sl["w"]);
                var h = cssSize(sl["h"]);
                style_sizes = "left:" + l + ";top:" + t + ";width:" + w + ";height:" + h;
            } else {
                style_sizes = "left:0;top:0;width:100%;height:100%";
            }
            style = "position:absolute;" + style_image + style_sizes;
            div = vdb.dom.nodeFromHTML("<div style='" + style + "'></div>");
            this._element.appendChild(div);
        }
    }
    function _createPlayerContainer() {
        var container = vdb.dom.createElement("div");
        container.setAttribute("id", "AolHtml5Player");
        if (utl.mobileOs()) {
            utl.addClass(container, "mobile-mode");
        } else {
            utl.addClass(container, "hover-enabled");
        }
        if (utl.isHandset()) {
            utl.addClass(container, "handset-mode");
        }
        utl.setStyle(container, {"position":"relative", "overflow":"hidden", "backgroundColor":vdb.player.bgColor, "width":"100%", "height":"100%"});
        this._element.appendChild(container);
        return container;
    }
    function _initEvents() {
        var tracker = vdb.createBasicTracker();
        vdb.events.EventContext.bindOnce(this, vdb.html5.player.VIDEO_READY, function() {
            tracker.display(this.getSize());
        }.bind(this));
        this.addEventListener(PlayerEvent.AD_START, function(e) {
            if (e.data && e.data.type === vdb.enums.AdType.OVERLAY) {
                return;
            }
            utl.addClass(this.container, "ad-mode");
        }.bind(this));
        this.addEventListener(PlayerEvent.AD_INTERACTION_END, function(e) {
            if (e) {
                if (e.data && e.data.data === "expand" && !this._shareScreenOpened) {
                    utl.addClass(this.container, "ad-mode");
                } else {
                    utl.removeClass(this.container, "ad-mode");
                }
            }
        }.bind(this));
        this.addEventListener(PlayerEvent.SHARE_SCREEN_OPENED, function() {
            this._shareScreenOpened = true;
        }.bind(this));
        this.addEventListener(PlayerEvent.SHARE_SCREEN_CLOSED, function() {
            this._shareScreenOpened = false;
        }.bind(this));
        this.addEventListener(vdb.html5.player.AD_SLOT_END, function(e) {
            if (e.data && e.data.type === vdb.enums.AdType.OVERLAY) {
                return;
            }
            utl.removeClass(this.container, "ad-mode");
        }.bind(this));
        this.addEventListener(PlayerEvent.ENTER_FULLSCREEN, function() {
            utl.addClass(this.container, "fullscreen-mode");
        }.bind(this));
        this.addEventListener(PlayerEvent.EXIT_FULLSCREEN, function() {
            utl.removeClass(this.container, "fullscreen-mode");
        }.bind(this));
        window.addEventListener("resize", function() {
            vdb.ctx.dispatchEvent(PlayerEvent.PLAYER_RESIZE);
        });
    }
    function injectorProvide() {
        vdb.ctx.getInjector().provideValue(vdb.enums.Dependencies.ROOT_CONTAINER, this.container);
        vdb.ctx.getInjector().provideClass(vdb.enums.Dependencies.BITRATE_TRACKER, vdb.html5.utils.HlsBitrateTracker);
        vdb.ctx.getInjector().provideClass(vdb.enums.Dependencies.BUFFERED_CALCULATOR, vdb.html5.utils.BufferedCalculator);
    }
    function onPlayerContainerClick(e) {
        if (e.altKey) {
            if (!this.loadTimeScreen) {
                this.loadTimeScreen = new vdb.html5.player.LoadTimeScreen(vdb.ctx.api.getPlayerWrapper(), vdb.ctx.api["getLoadTime"]());
                this.controller.pause();
            } else {
                if (!this.loadTimeScreen.isVisible()) {
                    this.loadTimeScreen.show();
                    this.controller.pause();
                }
            }
            e.stopPropagation();
        }
    }
    function initPlayerContainerEvents() {
        var useCapture = true;
        this.container.addEventListener("click", onPlayerContainerClick.bind(this), useCapture);
    }
    var LOGGER = vdb.log.getLogger("Player");
    var DEFAULT_COLOR = 1092578;
    var $ = vdb.utils.Common;
    var utl = vdb.Utils;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var _createVideosContainer = function(container) {
        var videoContainerWrapper = container;
        var videosContainer;
        if (vdb.ctx.playerAPI.absoluteVideoWrapper) {
            videoContainerWrapper = utl.createElement("div", {"class":"absolute-wrapper", "style":"height: 100%;"}, container);
        }
        videosContainer = utl.createElement("div", {"id":"videos-container"}, videoContainerWrapper);
        vdb.html5.utils.Html5PlayerUtils.setContainerLocation(videosContainer, vdb.ctx.playerAPI.videoLocation);
        return videosContainer;
    };
    return{init:function(element, extraManager, uiTemplate) {
        LOGGER.debug("create", {"element":element, "extraManager":extraManager});
        this._super();
        vdb.player.bgColor = $.hexColorFromInt(vdb.ctx.api.uiTemplate["backgroundColor"]);
        this._element = element;
        this._extraManager = extraManager;
        this._uiTemplate = uiTemplate;
        _initBackground.call(this);
        _initEvents.call(this);
    }, configure:function(config, bid) {
        LOGGER.debug("configure", config, bid);
        var sound = vdb.ctx.api.uiTemplate["sound"];
        this.controlsConfig = config.controlsConfig || {};
        vdb.dom.embedCssToHead(".player-icon{vertical-align:top}.hover-enabled .poster-outer-container:hover .poster-control .player-icon{fill:#customColor}.player-spinner{display:inline-block;position:absolute;top:calc(50% - 41px);left:calc(50% - 41px);width:74px;height:74px;padding:4px;color:#customColor;background:rgba(34,34,34,0.5);border-radius:74px;z-index:5;-webkit-animation:rotate 1s linear infinite;-moz-animation:rotate 1s linear infinite;-ms-animation:rotate 1s linear infinite;animation:rotate 1s linear infinite}@-ms-keyframes rotate{from{-ms-transform:rotate(0deg)}to{-ms-transform:rotate(360deg)}}@-moz-keyframes rotate{from{-moz-transform:rotate(0deg)}to{-moz-transform:rotate(360deg)}}@-webkit-keyframes rotate{from{-webkit-transform:rotate(0deg)}to{-webkit-transform:rotate(360deg)}}@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}".replace(/#customColor/g,
            this.getControlsCustomColor()));
        this.container = _createPlayerContainer.call(this);
        if (vdb.utils.UrlUtils.getParameterByName("loadtime")) {
            initPlayerContainerEvents.call(this);
        }
        injectorProvide.call(this);
        this.spinner = new vdb.html5.player.Spinner(this);
        this.videosContainer = _createVideosContainer.call(this, this.container);
        this.controller = vdb.html5.player.createController(this, config);
        new vdb.html5.player.TimeParamManager(this);
        vdb.events.addEventListener(this.container, "click", function() {
            this.dispatchEvent(PlayerEvent.PLAYER_CLICK);
        }.bind(this));
        if (sound === vdb.enums.player.SoundMode.MOUSEOVER) {
            this.controller.turnOnMouseOverSound();
        } else {
            if (sound === vdb.enums.player.SoundMode.MOUSEOVER_OFF) {
                this.controller.turnOnMouseOverOffSound();
            }
        }
        this.onBidUpdated(bid);
    }, getSize:function() {
        var width;
        var height;
        if (vdb.Utils.hasClass(this._element, vdb.utils.ChromeModeHack.CHROME_MODE_HACK_CLASS_NAME)) {
            width = this._uiTemplate["playerWidth"];
            height = this._uiTemplate["playerHeight"];
        } else {
            width = this._element.offsetWidth;
            height = this._element.offsetHeight;
        }
        return{width:width, height:height};
    }, dispatchEvent:function(event, data) {
        var eventData = {};
        if (typeof event === "string") {
            eventData.type = event;
            eventData.eventName = event;
            eventData.data = data;
        } else {
            eventData = event;
        }
        this._super(eventData);
    }, onBidUpdated:function(bid) {
        this._extraManager.resetState();
        vdb.events.EventContext.bindOnce(this._extraManager, vdb.events.PlayerModuleEvent.BLOCKING_EXTRAS_LOADED, function() {
            this._extraManager.initExtras(this.controller);
        }.bind(this));
        vdb.events.EventContext.bindOnce(this._extraManager, vdb.events.PlayerModuleEvent.BLOCKING_EXTRAS_RELEASED, function() {
            this.controller.setPlaylist(bid, true);
        }.bind(this));
        var extrasResolver = new vdb.extras.ExtrasResolver(this._uiTemplate, bid);
        this._extraManager.loadExtras(extrasResolver.getPlayerExtras().concat(extrasResolver.getPlaylistDependantExtras()));
    }, getPlayerState:function() {
        return this.controller.getPlayerState();
    }, getElement:function() {
        return this._element;
    }, getControlsConfig:function() {
        return this.controlsConfig;
    }, getControlsCustomColor:function() {
        return $.hexColorFromInt(utl.getValueOrDefault(this.controlsConfig, ["colorSchema", "mainColor", "backgroundColor"], DEFAULT_COLOR));
    }, isAdOnly:function() {
        return vdb.ctx.api.config["playerWidget"]["adOnly"] || false;
    }, isBranded:function() {
        return vdb.ctx.api.config["brandedContent"] || false;
    }};
}());
vdb.html5.utils.scroll.ScrollButtons = vdb.html5.utils.scroll.ScrollBase.extend(function() {
    var $ = vdb.utils.Common;
    var utl = vdb.Utils;
    var INITIAL_SPEED = .5;
    var MAX_SPEED = 10;
    var buildScrollButton = function(prefix) {
        var scrollButtonWrapper = utl.createElement("div", {"class":["scroll-button-wrapper", prefix + "-scroll-button-wrapper"], "style":"position: absolute;"}, this.scrollContainer);
        var scrollButton = utl.createElement("div", {"class":"scroll-button"}, scrollButtonWrapper);
        utl.createElement("div", {"class":"scroll-button-icon"}, scrollButton);
        return scrollButtonWrapper;
    };
    var bindEventsToBtn = function(btn, dir, speedProp) {
        var that = this;
        var speed = speedProp || INITIAL_SPEED;
        btn.onmouseover = function() {
            that.scrollInterval = setInterval(function() {
                that.scrollByDistance(dir * speed);
                speed = Math.min(speed + .03, MAX_SPEED);
            }, 1);
        };
        btn.onmouseout = function() {
            speed = speedProp || INITIAL_SPEED;
            clearInterval(that.scrollInterval);
        };
        btn.onmousedown = function() {
            clearInterval(that.scrollInterval);
            that.scrollInterval = setInterval(function() {
                that.scrollByDistance(dir * MAX_SPEED);
            }, 1);
        };
        btn.onmouseup = function() {
            clearInterval(that.scrollInterval);
            that.scrollInterval = setInterval(function() {
                that.scrollByDistance(dir * speed);
                speed = Math.min(speed + .03, MAX_SPEED);
            }, 1);
        };
    };
    var onScroll = function() {
        if (!this.isMobile) {
            utl.toggleClass(this.prevBtn, "disabled", this.scrollPrct == 0);
            utl.toggleClass(this.nextBtn, "disabled", this.scrollPrct == 1);
        }
        if (typeof this.onScrollCallback === "function") {
            this.onScrollCallback();
        }
    };
    var setVisibility = function() {
        if (!this.isMobile) {
            if (this.scrollableElem[this.clientSize] <= this.scrollableElemContainer[this.clientSize]) {
                $.hide([this.prevBtn, this.nextBtn]);
                this.disabled = true;
            } else {
                $.show([this.prevBtn, this.nextBtn]);
                this.disabled = false;
            }
        }
    };
    return{init:function(scrollbarType, scrollableElem, scrollButtonsContainer, rewindDuration, leafDuration) {
        this._super(scrollbarType, scrollableElem, scrollButtonsContainer);
        this.isMobile = utl.mobileOs();
        if (!this.isMobile) {
            this.prevBtn = buildScrollButton.call(this, "prev");
            this.nextBtn = buildScrollButton.call(this, "next");
            utl.addClass(this.prevBtn, "disabled");
            bindEventsToBtn.call(this, this.prevBtn, 1, rewindDuration);
            bindEventsToBtn.call(this, this.nextBtn, -1, leafDuration);
        }
        this.resize(true);
    }, scrollByDistance:function(pixels) {
        this._super(pixels);
        onScroll.call(this);
    }, resize:function(initialResize) {
        if (this.scrollableElemContainer[this.clientSize] > 0) {
            setVisibility.call(this);
        } else {
            if (!initialResize) {
                return;
            }
        }
        this._super(initialResize);
    }};
}());
vdb.html5.utils.TimeQueueEntry = vdb.core.Class.extend(function() {
    return{init:function(time, type, percent, coalesce) {
        this.time = time;
        this.type = type;
        this.percent = percent || 0;
        this.coalesce = Boolean(coalesce);
    }, toString:function() {
        return "TimeQueueEntry{time=" + this.time + ", type=" + this.type + ", percent=" + this.percent + ", coalesce=" + this.coalesce + "}";
    }};
}());
vdb.html5.utils.TimeQueue = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("TimeQueue");
    var AdStrategyType = vdb.enums.AdStrategyType;
    var TimeQueueEvent = vdb.events.TimeQueueEvent;
    var AdType = vdb.enums.AdType;
    var TimeUnit = vdb.html5.enums.TimeUnit;
    var init = function(eventBus) {
        this._eventBus = eventBus;
        this._events = [];
        this._videoLength = null;
        this._currentIndex = null;
    };
    var set = function(currentVideo, adsConfig) {
        var adConfigList = currentVideo.adConfigList || [];
        var cuePointsList = currentVideo.cuePoints || [];
        if (cuePointsList.length > 0) {
            if (adConfigList.length > 0) {
                adConfigList = adConfigList.filter(function(ad) {
                    return ad["adType"] !== vdb.enums.AdType.MIDROLL;
                });
            }
            Array.prototype.push.apply(adConfigList, currentVideo.cuePointsToAdsConfig());
        }
        if (adsConfig.getAdStrategy() === AdStrategyType.ADSET_BASED || vdb.utils.Common.getObjectSize(adConfigList) === 0) {
            this.add(TimeQueueEvent.MIDROLL, adsConfig.getMidrollTiming());
            this.add(TimeQueueEvent.OVERLAY, adsConfig.getOverlayTiming());
        } else {
            var timePoints = [];
            for (var i = 0;i < adConfigList.length;i++) {
                if (adConfigList[i]["adType"] === AdType.MIDROLL) {
                    var unit = adConfigList[i]["unit"];
                    var value = adConfigList[i]["value"];
                    if (unit === TimeUnit.SECOND) {
                        timePoints.push("00:00:" + ("0" + value).slice(-2));
                    } else {
                        if (unit === TimeUnit.PERCENT) {
                            timePoints.push(value + "%");
                        }
                    }
                }
            }
            this.add(TimeQueueEvent.MIDROLL, timePoints);
        }
    };
    var initQueue = function(video, videoDurationInSeconds, adsConfig) {
        LOGGER.debug("initQueue", video, "videoDurationInSeconds", videoDurationInSeconds);
        this._events = [];
        this._videoLength = videoDurationInSeconds;
        this._currentIndex = 0;
        set.call(this, video || {}, adsConfig);
    };
    var reset = function() {
        this._currentIndex = 0;
        this._events = [];
    };
    var add = function(eventType, times, coalesce) {
        if (!times) {
            return;
        }
        coalesce = Boolean(coalesce);
        LOGGER.debug("add", eventType, times, coalesce);
        var items = vdb.Utils.isArray(times) ? times : times.split(";");
        if (items.length === 0) {
            return;
        }
        var time = null;
        var curPercent = 0;
        for (var i = 0;i < items.length;i++) {
            var curTime = items[i].trim();
            if (curTime !== "") {
                if (curTime.indexOf("%") === -1) {
                    time = vdb.Utils.timeToSec(curTime);
                } else {
                    curPercent = Number(curTime.substr(0, curTime.length - 1));
                    time = this._videoLength * curPercent / 100;
                }
                var entry = new vdb.html5.utils.TimeQueueEntry(time, eventType, curPercent, coalesce);
                LOGGER.debug("add", entry);
                this._events.push(entry);
            }
        }
        this._events.sort(function(a, b) {
            return a.time - b.time;
        });
    };
    var check = function(curTimeInSeconds) {
        var coalesceHash = {};
        for (var i = this._currentIndex;i < this._events.length;i++) {
            var curTQE = this._events[i];
            if (curTimeInSeconds >= curTQE.time) {
                var fire = true;
                if (curTQE.coalesce) {
                    if (coalesceHash[curTQE.type]) {
                        fire = false;
                    } else {
                        coalesceHash[curTQE.type] = true;
                    }
                }
                if (fire) {
                    var event = new TimeQueueEvent(curTQE.type, curTQE.time, curTQE.percent);
                    LOGGER.info("Fire", event);
                    this._eventBus.dispatchEvent(event);
                }
                this._currentIndex++;
            } else {
                break;
            }
        }
    };
    return{init:init, initQueue:initQueue, add:add, check:check, reset:reset};
}());
vdb.html5.player.PlayerController = {};
(function(def) {
    def.DISPLAY_READY = "DisplayReady";
    def.BID_UPDATED = "BidUpdated";
    def.VIDEO_READY = "PlayerReadyEvent";
    def.AD_SLOT_END = "AdSlotEndEvent";
    def.AD_NONE = "AdNone";
    def.hasSkin = false;
    def.vrLoader = new vdb.html5.player.VRLoader;
    def.PlayerController = vdb.EventBus.extend({});
    def.PlayerMacros = vdb.constants.PlayerMacros;
    if (vdb.ctx && vdb.ctx.isVPAID) {
        def.showControls = vdb.ctx.getMacro(def.PlayerMacros.SHOWVPAIDCONTROLS) === "1";
    } else {
        def.showControls = vdb.ctx && vdb.ctx.placement ? !!vdb.ctx.placement["playerTemplate"]["controlsSkin"] : true;
    }
    def.createController = function(player, config) {
        var LOGGER = vdb.log.getLogger("PlayerController");
        var $ = vdb.utils.Common;
        var utl = vdb.Utils;
        var urlUtils = vdb.utils.UrlUtils;
        var isMobile = utl.mobileOs();
        var PlayerEvent = vdb.constants.PlayerEvent;
        var AdStrategyType = vdb.enums.AdStrategyType;
        var AdType = vdb.enums.AdType;
        var AdEngineType = vdb.enums.AdEngineType;
        var VideoPlayType = vdb.html5.enums.VideoPlayType;
        var SoundMode = vdb.enums.player.SoundMode;
        var AdEvent = vdb.events.AdEvent;
        var AdReason = vdb.enums.AdReason;
        var DEFAULT_SKIN_TYPE = "skin5";
        var controller;
        var _timeQ;
        var _container = player.container;
        var _videosContainer = player.videosContainer;
        var _context;
        var _ready = false;
        var _timeEventQueue;
        var _adCanAutoplay = true;
        var _isIosApp = vdb.ctx.getMacro(def.PlayerMacros.IOSAPP) === "1" || vdb.ctx.getMacro(def.PlayerMacros.IOSAPP) === "true";
        var _macrosResolver;
        var _autoplay = config.autoplay;
        var _autoplayInView = config.autoplayInView || 0;
        var _videoPlayType = _autoplay ? VideoPlayType.AUTOPLAY : VideoPlayType.CLICK;
        _videoPlayType = _autoplayInView ? VideoPlayType.AUTO_PLAY_IN_VIEW : _videoPlayType;
        var _mouseoverStart = config.mouseoverStart || false;
        var _startVideo = 0;
        var _volumeCookieManager = new vdb.html5.player.VolumeCookieManager(player);
        var _initialSound = vdb.ctx.playerAPI.getInitialSound();
        var _parseVolume = function(volume) {
            var v = parseFloat(volume);
            v = isNaN(v) ? 1 : v;
            v = v > 1 ? Math.min(v / 100, 1) : v;
            return v;
        };
        var _volume = _parseVolume(config.volume);
        var _muted = config.muted || false;
        config.volume = _volume;
        config.adConfig.volume = _volume;
        config.adConfig.muted = _muted;
        var _videosToPlay = config.videosToPlay;
        var _contextIntentFired = false;
        var _playAdOnLoad;
        var _lastAdType;
        var _playlist;
        var _video;
        var _nextVideoIndex = -1;
        var _deferCommand;
        var _fsController;
        var _poster;
        var _posterInteraction;
        var _ageGate;
        var _spinner = player.spinner;
        var _coveringsManager;
        var _skinsManager;
        var _subtitlesManager;
        var _skin;
        var _adInfoBar;
        var _overlayContainer;
        var _isNewVideo = false;
        var _display = vdb.html5.player.Display.getInstance();
        var _readyEventFired = false;
        var _contextStarted = false;
        var _startTimer = NaN;
        var _contentEventDispatcher;
        var _failedVideoIndices = [];
        var _muteContext = null;
        var _qoeTracker;
        var _tracker;
        var _vidibleContentTracker = new vdb.reporter.VidibleContentTracker(player, vdb);
        var _thirdPartyContentTracker;
        var _adController;
        var _lookAheadManager;
        var _adConfigEntry = null;
        var _posterPromise = null;
        var _adBlockerStart = false;
        var _adLoadStarted = false;
        var _adCycleInProgress = false;
        var _adInterrupted = false;
        var _adsPreloadingDisabled = vdb.ctx.getMacro(def.PlayerMacros.DISABLE_ADS_PRELOADING) === "true";
        var _liveManager;
        var _adsConfig = new vdb.html5.player.AdConfig(config.adConfig);
        var _state = new vdb.html5.player.PlayerState;
        var _skinsEnabled = function() {
            var isSkinUserDisabled = vdb.ctx.getMacro(def.PlayerMacros.HIDESKIN) === "1" || urlUtils.getParameterByName("hideskin") === "1";
            var hasBrowserSupport = !(utl.isIE && utl.browser.version === 9);
            if (isSkinUserDisabled) {
                vdb.dom.hideVideoElementControls();
            }
            return!isSkinUserDisabled && hasBrowserSupport && def.showControls;
        }();
        var _isSkinVisible = false;
        var _iPadAdStarted = false;
        var _wasFullScreen = false;
        var _adEngineType;
        var _hasAdBlocker;
        var _dontStopOnEnd;
        var _messageReceiver;
        var CONTEXT_STARTED_TIMEOUT = 7E3;
        var _clearStartTimer = function() {
            if (!isNaN(_startTimer)) {
                clearTimeout(_startTimer);
                _startTimer = NaN;
            }
        };
        var isAdBlockerStarted = function() {
            return _adBlockerStart;
        };
        var _removePoster = function() {
            if (_poster) {
                _display.show();
                _poster.remove();
                _poster = null;
            }
        };
        var _fireContentVideoEvent = function(playerEventType, eventData) {
            if (!_video) {
                return;
            }
            eventData = eventData || {};
            eventData["id"] = _video.id;
            eventData["name"] = _video.title;
            eventData["url"] = _video.ssaiUrl || _video.videoUrls[0];
            eventData["bcid"] = _context.buyerCompanyId;
            player.dispatchEvent(playerEventType, eventData);
        };
        var _stopOnEnd = function() {
            return _videosToPlay === 1 && _playlist.getLength() > 1 && !_dontStopOnEnd;
        };
        var dispatchContextEnd = function(data) {
            player.dispatchEvent(PlayerEvent.CONTEXT_ENDED, data);
            _contextStarted = false;
        };
        var _setVideoPlayType = function(vpt) {
            _videoPlayType = vpt;
        };
        var clearVideo = function() {
            _video = null;
        };
        var _isFailedVideo = function(index) {
            return _failedVideoIndices.indexOf(index) !== -1;
        };
        var _drawError = function(error) {
            _context.drawErrorMessage(_container, error);
        };
        var _showSpinner = function() {
            if (_spinner) {
                _spinner.show();
            }
        };
        var _dispatchContextIntent = function() {
            if (!_contextIntentFired) {
                _contextIntentFired = true;
                player.dispatchEvent(PlayerEvent.CONTEXT_INTENT);
            }
        };
        var _firePlayTriggered = function() {
            _dispatchContextIntent();
            setTimeout(function() {
                _fireContentVideoEvent(PlayerEvent.PLAY_TRIGGERED);
            }, 0);
        };
        var _displayResumeAdPoster = function(callback) {
            _coveringsManager.getCovering().then(function() {
                _poster = new vdb.coverings.covering.ResumeAdPoster(_container);
                _poster.setOnPosterAction(function() {
                    _poster.remove();
                    _poster = null;
                    callback();
                });
            });
        };
        var _hideSpinner = function() {
            if (_spinner) {
                _spinner.hide();
            }
        };
        var move360 = function(x, y) {
            _display.move360(x, y);
        };
        var _getInitialVolume = function() {
            var cookieVolume = _volumeCookieManager.getVolume();
            return isNaN(cookieVolume) ? _volume : cookieVolume;
        };
        var _getInitialMuted = function() {
            var cookieMuted = _volumeCookieManager.getMuted();
            return isMobile || typeof cookieMuted === "undefined" ? _muted : cookieMuted;
        };
        var _initVideoSetting = function() {
            _display.setVolume(_getInitialVolume());
            _display.mute(_getInitialMuted());
        };
        var _getSkinType = function() {
            return urlUtils.getParameterByName("qaptplayerskintype") || config.skin || DEFAULT_SKIN_TYPE;
        };
        var _getCoveringType = function() {
            return urlUtils.getParameterByName("coveringtype") || config.covering || _getSkinType();
        };
        var disableInView = function() {
            if (_muteContext) {
                _muteContext.unbind();
                _muteContext = null;
            }
            player.dispatchEvent(PlayerEvent.DISABLE_INVIEW);
        };
        var _setVideosToPlay = function(l) {
            _videosToPlay = l;
            config.videosToPlay = l;
        };
        var _getPercentBuffered = function(videoDuration, buffered) {
            var bufferedLen = buffered.length;
            var bufferedEnd;
            var percentBuffered = 0;
            if (videoDuration > 0 && bufferedLen > 0) {
                bufferedEnd = buffered.end(bufferedLen - 1);
                percentBuffered = bufferedEnd / videoDuration * 100;
            }
            return percentBuffered;
        };
        var _getCurrentTimeWithoutAds = function(currentTime) {
            var adsPassedTime = _adController && _adController.getAdsPassedTime(currentTime) || 0;
            return currentTime - adsPassedTime;
        };
        var _onVideoSeekStart = function(eventData) {
            _fireContentVideoEvent(PlayerEvent.VIDEO_SEEKSTART, eventData);
        };
        var _onVideoSeekEnd = function() {
            _fireContentVideoEvent(PlayerEvent.VIDEO_SEEKEND);
        };
        var _onVideoProgress = function(eventData) {
            _fireContentVideoEvent(PlayerEvent.VIDEO_PROGRESS, {"percentBuffered":_getPercentBuffered(eventData.duration, eventData.buffered)});
        };
        var _onVideoWaiting = function() {
            _fireContentVideoEvent(PlayerEvent.VIDEO_WAITING);
        };
        var _onVideoBufferingStart = function() {
            _fireContentVideoEvent(PlayerEvent.BUFFERING_START);
        };
        var _onVideoBufferingEnd = function() {
            _fireContentVideoEvent(PlayerEvent.BUFFERING_END);
        };
        var _getClickUrl = function() {
            return config.adConfig["clickThroughUrl"] || _video && _video.metadata["clickUrl"];
        };
        var _isInlineAd = function(adEventData) {
            return adEventData.playerSubType === "inline";
        };
        var _onAdCampanionsShow = function() {
            player.dispatchEvent(PlayerEvent.AD_SHOW_COMPANIONS);
        };
        var _onAdSubtitlesFound = function(event) {
            if (_subtitlesManager) {
                _subtitlesManager.checkForAdSubtitles(event["data"]["subtitles"]);
            }
        };
        var _onAdEngineResponse = function(event) {
            player.dispatchEvent(PlayerEvent.AD_ENGINE_RESPONSE, event["data"]);
        };
        var _onAdNone = function(adEvent) {
            player.dispatchEvent(def.AD_NONE, adEvent);
        };
        var _onAdInteractionStarted = function(event) {
            LOGGER.debug("onAdInteractionStarted()", event);
            if (_display.isContent()) {
                _display.pause();
            }
        };
        var _getVideoPlayType = function() {
            return _videoPlayType;
        };
        var _getPlayerState = function() {
            return vdb.Utils.copy(_state.getState(), {"videoId":_video ? _video.id : null, "w":player.getSize().width, "h":player.getSize().height, "totalAdTime":0, "totalAdsCount":0, "vpt":_getVideoPlayType(), "sequence":_video ? _video.originalIndex : ""});
        };
        var _fireAdEvent = function(playerEventType, adEvent, data) {
            var adEventData = adEvent && adEvent.data || {};
            var ad = adEventData.ad;
            if (!data) {
                data = {};
            }
            if (ad) {
                data["id"] = ad.getAcid();
                data["name"] = ad.getName();
                data["rid"] = ad.getRuleId();
                data["transactionId"] = ad.getTransactionId();
                data["type"] = ad.getType();
                data["url"] = ad.getUrl();
                data["usid"] = ad.getUsid();
                data["vendor"] = ad.getVendor();
            }
            data["skippable"] = adEventData.skippable;
            data["skipOffsetTime"] = adEventData.skipOffsetTime;
            data["skipOffsetPercent"] = adEventData.skipOffsetPercent;
            data["isInline"] = _isInlineAd(adEventData);
            if (adEventData.currentTime !== undefined) {
                data["currentTime"] = adEventData.currentTime;
            }
            if (adEventData.duration !== undefined) {
                data["duration"] = adEventData.duration;
            }
            if (adEventData.timeRemaining !== undefined) {
                data["timeRemaining"] = adEventData.timeRemaining;
            }
            if (adEventData.progressPercent !== undefined) {
                data["progressPercent"] = adEventData.progressPercent;
            }
            if (adEventData.maxTime !== undefined) {
                data["maxTime"] = adEventData.maxTime;
            }
            if (adEventData.creativeId !== undefined) {
                data["creativeId"] = adEventData.creativeId;
            }
            if (adEventData.adId !== undefined) {
                data["adId"] = adEventData.adId;
            }
            if (adEventData.adIconsContainer !== undefined) {
                data["adIconsContainer"] = adEventData.adIconsContainer;
            }
            if (adEventData.creativeId !== undefined) {
                data["renditionId"] = adEventData.renditionId;
            }
            if (adEventData.parameters !== undefined) {
                data["parameters"] = adEventData.parameters;
            }
            if (adEventData.config360 !== undefined) {
                data["config360"] = adEventData.config360;
            }
            if (adEventData.volume !== undefined) {
                data["volume"] = adEventData.volume;
            }
            if (adEventData.muted !== undefined) {
                data["muted"] = adEventData.muted;
            }
            player.dispatchEvent(playerEventType, data);
        };
        var forceStop = function() {
            player.dispatchEvent(vdb.enums.Html5PlayerEventType.FORCE_STOP);
        };
        var stop = function() {
            vdb.events.EventContext.bindOnce(_adController, AdEvent.AD_ENGINE_COMPLETE, forceStop);
            vdb.events.EventContext.bindOnce(_contentEventDispatcher, def.VIDEO_FORCE_END, forceStop);
            if (_timeEventQueue) {
                _timeEventQueue.unbind();
            }
            _adController.stop();
            _display.stop();
        };
        var _markVideoAsFailed = function(index) {
            if (!_isFailedVideo(index)) {
                LOGGER.debug("onVideoError", "mark video as failed", "index", index);
                _failedVideoIndices.push(index);
            }
        };
        var getResolver = function() {
            if (!_macrosResolver) {
                _macrosResolver = new vdb.utils.MacrosResolver(vdb.ctx.getInjector(), config.adConfig);
            }
            return _macrosResolver;
        };
        var _set360 = function(video) {
            var videoProjectionType = (video.metadata["videoProjectionType"] || "").toLowerCase();
            _video.data360 = {projectionType:utl.containsValue(vdb.enums.video.ProjectionType360, videoProjectionType) ? videoProjectionType : vdb.enums.video.ProjectionType360.EQUIRECTANGULAR, tilt:urlUtils.getParameterByName("tilt") || _context.getMacro(def.PlayerMacros.TILT)};
            if (!_messageReceiver && vdb.utils.WindowUtil.getTopMostWindow() !== window.top && vdb.Utils.mobileOs()) {
                _messageReceiver = new vdb.html5.player.MessageReceiver;
            }
        };
        var _setReportingVideo = function(video) {
            _vidibleContentTracker.setVideo(video);
            _thirdPartyContentTracker.setVideo(video);
            _state.onVideoChange();
        };
        var _isReadyForPreroll = function() {
            var adConfigList = _playlist.isEmpty() ? [] : _video.adConfigList;
            if (_adsConfig.getAdStrategy() === AdStrategyType.ADSET_BASED || adConfigList.length === 0) {
                return true;
            }
            for (var i = 0;i < adConfigList.length;i++) {
                if (adConfigList[i]["adType"] === AdType.PREROLL) {
                    return true;
                }
            }
            return false;
        };
        var dispatchContextStart = function(isAd) {
            if (!_contextStarted) {
                _contextStarted = true;
                _clearStartTimer();
                player.dispatchEvent(PlayerEvent.CONTEXT_STARTED, {"duration":_video && _video.metadata["duration"] / 1E3 || "", "isAd":isAd});
            }
        };
        var _onAdEngineRun = function(event) {
            _adConfigEntry = event.getAdConfigEntry();
            _adEngineType = _adConfigEntry._adEngineType;
            if (_adConfigEntry._adEngineType === AdEngineType.IMA && isMobile && _autoplayInView === 0) {
                _removePoster();
            }
        };
        var mute = function(callback) {
            if (!isAdBlockerStarted()) {
                vdb.events.EventContext.bindOnce(_contentEventDispatcher, def.VIDEO_VOLUME_CHANGED, callback);
            }
            _display.mute(true);
            _adController.mute(true);
            if (callback) {
                callback();
            }
        };
        var unMute = function(callback) {
            if (isAdBlockerStarted()) {
                if (callback) {
                    callback();
                }
            } else {
                vdb.events.EventContext.bindOnce(_contentEventDispatcher, def.VIDEO_VOLUME_CHANGED, callback);
            }
            if (_adController) {
                _adController.mute(false);
            }
            _display.mute(false);
        };
        var isMuted = function() {
            if (isAdBlockerStarted()) {
                return _adController.isMuted();
            }
            return _display.isMuted();
        };
        var seek = function(time, callback) {
            if ((!isAdBlockerStarted() || this.isBrandedWithControls()) && !_poster) {
                vdb.events.EventContext.bindOnce(_contentEventDispatcher, def.VIDEO_SEEK, callback);
                _display.seek(time);
            }
        };
        var sendKey = function(keyCode) {
            $.sendKeyDown(_container.ownerDocument, keyCode);
        };
        var setVolume = function(volume) {
            var normalizedVolume = _parseVolume(volume);
            LOGGER.debug("Set Volume: " + volume + " [normalized: " + normalizedVolume + "]");
            if (isAdBlockerStarted()) {
                _adController.setVolume(normalizedVolume);
            } else {
                _display.setVolume(normalizedVolume);
            }
        };
        var getVolume = function() {
            if (isAdBlockerStarted()) {
                return _adController.getVolume();
            }
            return _display.getVolume();
        };
        var _mutePlayerSilently = function() {
            mute(function() {
            });
        };
        var _unMutePlayerSilently = function() {
            _muted = false;
            unMute(function() {
            });
        };
        var turnOnMouseOverSound = function() {
            _muteContext = vdb.events.EventContext.bindOnce(_container, "mouseover", _unMutePlayerSilently);
        };
        var turnOnMouseOverOffSound = function() {
            _muteContext = vdb.events.EventContext.group(vdb.events.EventContext.bind(_container, "mouseover", _unMutePlayerSilently), vdb.events.EventContext.bind(_container, "mouseout", _mutePlayerSilently));
        };
        var getAdConfigEntry = function() {
            return _adConfigEntry;
        };
        var getLiveManager = function() {
            return _liveManager;
        };
        var setControls = function(b) {
            _display.setControlsVisible(b);
        };
        var removeControls = function() {
            _display.removeControls();
        };
        var isPlaying = function() {
            if (_adController && isAdBlockerStarted()) {
                return _adController.isPlaying();
            }
            return _display.isPlaying();
        };
        var toggleFullscreen = function(onOff) {
            var usePseudoFullscreenMode = vdb.Utils.browser.isIos() && _video && _video.data360 && _display.isContent() || urlUtils.getParameterByName("forcepseudofullscreen") === "1";
            _fsController.toggleFullscreen(usePseudoFullscreenMode, onOff);
        };
        var _startPrerolls = vdb.Promise.wrapWaiting(vdb.ctx.vpaidStartedPromise, function() {
            _firePlayTriggered();
            _adLoadStarted = false;
            LOGGER.debug("Start prerolls");
            if (utl.iPadOS() && !_iPadAdStarted) {
                _iPadAdStarted = true;
                if (!_poster) {
                    _displayResumeAdPoster(_display.play.bind(_display));
                }
            }
            if (_lookAheadManager.hasLookAhead()) {
                _lookAheadManager.look().then(_adController.startAds.bind(_adController))["catch"](function() {
                    LOGGER.warn("Skipped lookahead ad");
                });
            } else {
                _adController.startAds();
            }
            if (vdb.Utils.mobileOs() && !vdb.ctx.isVPAID) {
                setTimeout(_hideSpinner, 5E3);
            }
        });
        var _playOnPoster = function() {
            _posterInteraction = true;
            _display.touch();
            _iPadAdStarted = true;
            _setVideoPlayType(VideoPlayType.CLICK);
            _removePoster();
            _showSpinner();
            _startPrerolls();
        };
        var _setPlayPoster = function(posterActionCallback, isReplay) {
            var curVideo = _playlist.getVideo(_startVideo) || config.adPosterVideo && new vdb.model.Video(config.adPosterVideo);
            _posterPromise = _coveringsManager.getCovering().then(function() {
                _posterPromise = null;
                if (_poster) {
                    player.dispatchEvent(PlayerEvent.VIDEO_POSTER_READY, _poster);
                } else {
                    _poster = new vdb.coverings.covering.PlayPoster(player, _container, curVideo, _mouseoverStart, config.previewPoster.toLowerCase() === vdb.html5.enums.PreviewPosterType.ANIMATED && !_autoplayInView, !!isReplay, controller);
                }
                _hideSpinner();
                if (isReplay) {
                    _tracker.action("replay-poster", null, _state.getCurrentTime());
                }
                if (posterActionCallback) {
                    _poster.setOnPosterAction(posterActionCallback);
                }
            });
        };
        var _onAdQuartile = function(adEvent) {
            _fireAdEvent.call(this, PlayerEvent.AD_QUARTILE, adEvent, {"adStage":adEvent.data.adStage});
        };
        var _showPoster = function() {
            _setPlayPoster(_playOnPoster);
            _display.hide();
        };
        var delayContextStartedTimeout = function() {
            if (!isNaN(_startTimer)) {
                LOGGER.debug("delay ContextStartedTimeout");
                clearTimeout(_startTimer);
                _startTimer = setTimeout(_onContextStartedTimeout, CONTEXT_STARTED_TIMEOUT);
            }
        };
        var _showClickToPlay = function(callback) {
            _setPlayPoster(function() {
                if (_adsPreloadingDisabled) {
                    _loadPrerolls();
                }
                _posterInteraction = true;
                _display.touch();
                _removePoster();
                _setVideoPlayType(VideoPlayType.CLICK);
                _showSpinner();
                if (callback) {
                    callback();
                }
            });
        };
        var _onContextStartedTimeout = function() {
            if (_adLoadStarted || _adConfigEntry) {
                delayContextStartedTimeout();
                return;
            }
            LOGGER.debug("onContextStartedTimeout");
            _clearStartTimer();
            _autoplay = false;
            _context.getInjector().resolveSync(vdb.enums.Dependencies.ERROR_TRACKER).trackError("android", "autoplay", "fallback to CTP by timeout");
            _muted = [SoundMode.MUTED, SoundMode.MOUSEOVER, SoundMode.MOUSEOVER_OFF].indexOf(_initialSound) !== -1;
            _initVideoSetting.call(this);
            _adController.mute(_getInitialMuted());
            _showClickToPlay(function() {
                _display.play();
            }, true);
        };
        var _finish = function() {
            _videosToPlay = config.videosToPlay;
            if (utl.mobileOs()) {
                _fsController.attemptToExitFullscreen();
                _wasFullScreen = false;
            }
            _display.hide();
            if (controller.adOnly && _videosToPlay !== 0 || _playlist.getLength() === 1) {
                _setPlayPoster(function() {
                    player.dispatchEvent(PlayerEvent.USER_INTERACTION, {"interactionType":vdb.enums.UserInteraction.REPLAY});
                    _display.touch();
                    _removePoster();
                    _setVideoPlayType(VideoPlayType.CLICK);
                    clearVideo();
                    play(_startVideo);
                }, true);
            }
        };
        var _onPlaylistEnd = function(nextVideoIndex) {
            LOGGER.debug("onPlaylistEnd");
            _fireContentVideoEvent(PlayerEvent.PLAYLIST_END);
            if (_videosToPlay === 0) {
                _finish();
            } else {
                clearVideo();
                play(nextVideoIndex);
            }
        };
        var _moveToNextVideo = function() {
            var currentVideoIndex;
            var startIndex = _playlist.getCurrentVideoIndex();
            var nextVideoIndex = -1;
            var playlistEnd = false;
            do {
                currentVideoIndex = _playlist.selectNextVideo();
                if (!playlistEnd) {
                    playlistEnd = currentVideoIndex === _startVideo;
                }
                if (_isFailedVideo(currentVideoIndex)) {
                    LOGGER.debug("selectNextVideo", "Ignore failed video", "index", currentVideoIndex);
                } else {
                    nextVideoIndex = currentVideoIndex;
                    break;
                }
            } while (currentVideoIndex !== startIndex);
            if (nextVideoIndex === -1) {
                LOGGER.warn("selectNextVideo", "all videos failed");
                _drawError({title:"Playback error", description:"We're sorry, but we can't play any videos in the current playlist. Please try another browser.", code:13});
                return;
            }
            if (playlistEnd) {
                _onPlaylistEnd(nextVideoIndex);
            } else {
                play(nextVideoIndex);
            }
        };
        var _onVideoEnd = function(eventData) {
            _timeQ.reset();
            _adController.stop();
            _vidibleContentTracker.fireCompletePlaying(eventData.currentTime, eventData.complete);
            _state.stopPlayTimeCounting();
            if (eventData.complete) {
                _thirdPartyContentTracker.fireContentQuartile(4);
                _display.reset();
            }
            _fireContentVideoEvent(PlayerEvent.VIDEO_END, {"currentTime":eventData.currentTime, "complete":eventData.complete, "stop":eventData.complete && _stopOnEnd()});
            dispatchContextEnd();
            if (eventData.videoSelected) {
                return;
            }
            _setVideoPlayType(VideoPlayType.AUTOPLAY);
            if (--_videosToPlay === 0) {
                if (_playlist.getNextVideoIndex() === _startVideo) {
                    _onPlaylistEnd(_startVideo);
                } else {
                    _finish();
                }
                forceStop();
                return;
            }
            if (eventData.complete) {
                _moveToNextVideo();
            }
            _vidibleContentTracker.setVideo(_video);
        };
        var _reportVideoChoose = function() {
            if (!_readyEventFired) {
                _readyEventFired = true;
                if (_video) {
                    _fireContentVideoEvent(PlayerEvent.PLAYER_READY);
                } else {
                    player.dispatchEvent(PlayerEvent.PLAYER_READY, {});
                }
            }
            if (_video && _isNewVideo) {
                _isNewVideo = false;
                _setReportingVideo(_video);
                _fireContentVideoEvent(PlayerEvent.VIDEO_SELECTED);
            }
        };
        var _onAdBlockerComplete = function(event) {
            event = event || {};
            delayContextStartedTimeout();
            player.dispatchEvent(PlayerEvent.AD_BLOCKER_COMPLETE, {type:event.adType || AdType.PREROLL});
            var adStarted = _adBlockerStart;
            _adBlockerStart = false;
            _adCycleInProgress = false;
            var reason = event.data && event.data["reason"];
            var hasNoAds = reason === AdReason.NO_ADS;
            if (!_playlist.isEmpty()) {
                player.dispatchEvent(def.AD_SLOT_END, event);
                if (_adInterrupted) {
                    dispatchContextEnd();
                }
                LOGGER.debug("Show main video on event", event);
                if (_nextVideoIndex !== -1) {
                    LOGGER.debug("Ad Blocker complete. Play video with index " + _nextVideoIndex);
                    play(_nextVideoIndex);
                    _nextVideoIndex = -1;
                } else {
                    if (!_autoplay && !_posterInteraction) {
                        _setPlayPoster(function() {
                            _firePlayTriggered();
                            _posterInteraction = true;
                            _display.touch();
                            _ageGate.checkAge();
                            _removePoster();
                            _showSpinner();
                        });
                        return;
                    }
                }
                var noAdOrBroken = hasNoAds || reason === AdReason.AD_GROUP_FAILED;
                if (!_adInterrupted && (adStarted || noAdOrBroken || event.adType === AdType.PREROLL)) {
                    if (event.adType === AdType.MIDROLL) {
                        _display.resumeContent();
                    } else {
                        _ageGate.checkAge();
                    }
                } else {
                    _adInterrupted = false;
                }
            } else {
                if (hasNoAds) {
                    LOGGER.debug("No ads or content - draw error");
                    dispatchContextEnd();
                    _drawError();
                } else {
                    if (_videosToPlay > 0) {
                        LOGGER.debug("Playlist is empty. Run preroll again.");
                        setTimeout(_loadPrerolls, 100);
                        dispatchContextEnd();
                    } else {
                        _finish();
                        dispatchContextEnd({"failed":true});
                    }
                }
            }
        };
        var _onAdLinearChange = function(event) {
            if (_display.isContent()) {
                var isLinear = event && event.data && event.data.isLinear;
                if (isLinear) {
                    _display.pause();
                } else {
                    _display.play();
                }
            } else {
                if (_video) {
                    _setContent();
                } else {
                    _updateCurrentVideo();
                }
            }
            _onAdBlockerComplete(event);
        };
        var _loadPrerolls = function() {
            if (!_isReadyForPreroll()) {
                _reportVideoChoose();
                _onAdBlockerComplete();
                return;
            }
            LOGGER.debug("Load prerolls");
            _showSpinner();
            _adLoadStarted = true;
            if (_playAdOnLoad && (_videosToPlay > 0 || controller.adOnly || config.videosToPlay === 0)) {
                _reportVideoChoose();
                _adController.loadAds(null, _startPrerolls);
            } else {
                _playAdOnLoad = false;
                _adController.loadAds(null, function(opts) {
                    opts = opts || {};
                    _adLoadStarted = false;
                    _adCanAutoplay = opts["canAutoplay"] !== false;
                    if (!_adCanAutoplay && !_posterInteraction) {
                        _showClickToPlay(_startPrerolls, true);
                        _posterPromise.then(_reportVideoChoose);
                        return;
                    }
                    _reportVideoChoose();
                    if (_playAdOnLoad) {
                        _startPrerolls();
                    } else {
                        if (_autoplayInView === 0 || _adsPreloadingDisabled) {
                            if (_videosToPlay > 0 && (_autoplay || !_poster) || controller.adOnly && (config.videosToPlay > _videosToPlay || config.videosToPlay === 0)) {
                                if (_posterPromise) {
                                    _posterPromise.then(function() {
                                        _poster.setOnPosterAction(_playOnPoster);
                                    });
                                } else {
                                    _playOnPoster();
                                }
                            } else {
                                if (_poster) {
                                    _poster.setOnPosterAction(_playOnPoster);
                                } else {
                                    _setPlayPoster(_playOnPoster);
                                }
                            }
                        }
                    }
                });
            }
        };
        var _updateCurrentVideo = function() {
            if (_contextStarted) {
                _onVideoEnd({complete:false, currentTime:_state.getCurrentTime(), videoSelected:true});
            }
            _isNewVideo = _playlist.isEmpty() || _video !== _playlist.getCurrentVideo();
            if (_isNewVideo) {
                _video = _playlist.getCurrentVideo();
                if (vdb.Utils360.checkIfVideo360(_video)) {
                    _set360(_video);
                }
                if (_video) {
                    _setReportingVideo(_video);
                }
                _display.resetContext();
                _contextIntentFired = false;
                if (!_adsPreloadingDisabled) {
                    _loadPrerolls();
                } else {
                    if (_autoplayInView !== 0) {
                        _reportVideoChoose();
                    }
                }
            }
        };
        var _selectVideo = function(index) {
            _playlist.selectVideoByIndex(index);
            _updateCurrentVideo();
        };
        var play = function(index) {
            index = Number(index);
            if (!_ready) {
                _deferCommand = function() {
                    play(index);
                };
            } else {
                LOGGER.debug("play", "index", index);
                _context.clearErrorMessage();
                if (isAdBlockerStarted()) {
                    LOGGER.debug("play", "stop ad");
                    _nextVideoIndex = index;
                    _adInterrupted = true;
                    _adController.stop();
                    _removePoster();
                } else {
                    _playAdOnLoad = true;
                    if (isNaN(index)) {
                        _updateCurrentVideo();
                    } else {
                        _selectVideo(index);
                    }
                }
            }
            _firePlayTriggered();
        };
        var replay = function() {
            clearVideo();
            play(_playlist.getCurrentVideoIndex());
        };
        var pausedOutOfView = false;
        var pause = function() {
            if (_adController) {
                _adController.pauseAds();
            }
            if (!isAdBlockerStarted()) {
                _display.pause();
            }
        };
        var resume = function() {
            if (_poster) {
                if (!config.adConfig.autoplayAdOnly && _adCanAutoplay) {
                    _poster.posterAction();
                }
            } else {
                _adController.resumeAds();
                if (!isAdBlockerStarted()) {
                    _display.play();
                }
            }
        };
        var inView = function() {
            if (!_contextStarted) {
                if (vdb.ctx.playsNativeInline()) {
                    _autoplay = true;
                    if (_autoplayInView !== 0 && _adsPreloadingDisabled) {
                        _loadPrerolls();
                    } else {
                        if (_poster) {
                            resume();
                        } else {
                            _startPrerolls();
                        }
                    }
                } else {
                    if (!_poster) {
                        _showPoster();
                    }
                }
            } else {
                if (pausedOutOfView) {
                    resume();
                }
            }
        };
        var outOfView = function() {
            if (!_fsController.isFullscreen()) {
                if (!_display.isPaused()) {
                    pause();
                    pausedOutOfView = true;
                    _vidibleContentTracker.fireVideoAutoPause();
                }
            }
        };
        var togglePlay = function() {
            if (isPlaying()) {
                pause();
            } else {
                resume();
            }
        };
        var _defaultVideoClickBehavior = togglePlay;
        var toggleMute = function() {
            if (isMuted()) {
                if (getVolume() == null) {
                    setVolume(.1);
                } else {
                    unMute();
                }
            } else {
                mute();
            }
        };
        var _initVideoComponents = function() {
            _fsController = new vdb.html5.player.FullscreenController(controller);
            _overlayContainer = (new vdb.html5.player.OverlayContainer(player)).overlayContainer;
            _coveringsManager = new vdb.html5.player.CoveringsManager(_getCoveringType());
            if (vdb.ctx.getMacro(def.PlayerMacros.ENABLE_SUBSCRIPT) !== "0") {
                _subtitlesManager = new vdb.html5.subtitles.SubtitlesManager(controller);
            }
            if (_skinsEnabled) {
                var skinType = _getSkinType();
                player.addEventListener(PlayerEvent.PLAYER_SKIN_READY, function(e) {
                    _skin = e.data;
                    removeControls();
                });
                _skinsManager = new vdb.html5.player.SkinsManager(controller);
                _skinsManager.loadSkin(skinType);
            }
            _adInfoBar = new vdb.html5.player.AdInfoBar(controller);
        };
        var _initUserInteractionEvents = function() {
            var EC = vdb.events.EventContext;
            var UserInteraction = vdb.enums.UserInteraction;
            var hoverThrottler;
            var inViewDisabled = false;
            var onEnterContainer = function() {
                clearTimeout(hoverThrottler);
                hoverThrottler = setTimeout(function() {
                    player.dispatchEvent(PlayerEvent.USER_INTERACTION, {"interactionType":UserInteraction.HOVER});
                }, 1E3);
            };
            var onLeaveContainer = function() {
                clearTimeout(hoverThrottler);
            };
            var onUserInteraction = function(e) {
                var data = e["data"] || {};
                var interactionType = data["interactionType"];
                if (interactionType !== UserInteraction.HOVER) {
                    if (!inViewDisabled) {
                        disableInView();
                        inViewDisabled = true;
                    }
                    if (interactionType === UserInteraction.UNMUTE_OVERLAY_CLICK) {
                        unMute();
                        player.dispatchEvent(PlayerEvent.SHOW_CONTROLS);
                        if (config.fullscreenOnUnmute) {
                            toggleFullscreen(true);
                        }
                    }
                }
            };
            EC.bind(_container, "mouseenter", onEnterContainer);
            EC.bind(_container, "mouseleave", onLeaveContainer);
            EC.bind(player, PlayerEvent.USER_INTERACTION, onUserInteraction);
        };
        var _onAdFinished = function(adEvent) {
            LOGGER.debug("onAdFinished", "adEvent", adEvent);
            if (adEvent.data && adEvent.data.ad && adEvent.data.ad._adEngineType !== AdEngineType.IMA) {
                _wasFullScreen = _display.isWebkitFullscreen();
            }
            _adEngineType = null;
            if (controller.adOnly) {
                Math.max(_videosToPlay--, 0);
            }
            _fireAdEvent.call(this, PlayerEvent.AD_END, adEvent, {"currentTime":adEvent.data && adEvent.data.currentTime});
        };
        var _onAdBlockerStart = function(event) {
            _adBlockerStart = true;
            if (_display.isPlaying() && isMobile) {
                _wasFullScreen = _display.getMainArea().isWebkitFullscreen();
                if (!utl.browser.isIos() || _display.isContent()) {
                    _fsController.attemptToExitFullscreen();
                }
            }
            if (_display.isContent()) {
                LOGGER.debug("Hide main video (midroll started):", event);
                _display.pause();
                _display.hide();
            }
            if (!_display.hasAdsOrContent()) {
                _display.hide();
            }
        };
        var _onAdBlockerRequest = function(event) {
            _lastAdType = event.adType;
            player.dispatchEvent(PlayerEvent.AD_BLOCKER_REQUEST, {type:event.adType});
        };
        var _onAdsLoaded = function(adEvent) {
            LOGGER.debug("onAdsLoaded()", adEvent);
            _fireAdEvent.call(this, PlayerEvent.ADS_LOADED, adEvent);
        };
        var _onAdLoaded = function(adEvent) {
            LOGGER.debug("onAdLoaded()", adEvent);
            _fireAdEvent.call(this, PlayerEvent.AD_META, adEvent);
        };
        var _onAdStarted = function(adEvent) {
            LOGGER.debug("onAdStarted()", "adEvent", adEvent);
            _removePoster();
            var ad = adEvent && adEvent.data && adEvent.data.ad || {};
            if (utl.browser.isIos()) {
                if (ad._adEngineType !== AdEngineType.IMA && adEvent.data && adEvent.data.apiType !== vdb.enums.ApiType.VPAID && _wasFullScreen === true) {
                    _display.webkitEnterFullscreen();
                }
            }
            _hideSpinner();
            dispatchContextStart(true);
            _fireAdEvent.call(this, PlayerEvent.AD_START, adEvent, {"adCampaignId":ad._acid, "adSetId":ad._asid});
            _fireAdEvent.call(this, PlayerEvent.AD_PLAY, adEvent);
        };
        var _onAdPaused = function(adEvent) {
            LOGGER.debug("onAdPaused()", "adEvent", adEvent);
            _fireAdEvent.call(this, PlayerEvent.AD_PAUSED, adEvent);
            if ((!def.hasSkin || _skin.showResumeAdPoster) && !_isInlineAd(adEvent.data)) {
                _displayResumeAdPoster(resume);
            }
        };
        var _onAdVolumeChanged = function(adEvent) {
            LOGGER.debug("onAdVolumeChanged()", "adEvent", adEvent);
            _fireAdEvent.call(this, PlayerEvent.AD_VOLUME_CHANGED, adEvent);
        };
        var _onAdTimeUpdate = function(adEvent) {
            LOGGER.debug("onAdTimeUpdate()", "adEvent", adEvent);
            _fireAdEvent.call(this, PlayerEvent.AD_TIMEUPDATE, adEvent);
        };
        var _onAdWaiting = function(adEvent) {
            LOGGER.debug("onAdWaiting()", "adEvent", adEvent);
            _fireAdEvent.call(this, PlayerEvent.AD_WAITING, adEvent);
        };
        var _onAdResumed = function(adEvent) {
            LOGGER.debug("onAdResumed()", "adEvent", adEvent);
            _removePoster();
            _fireAdEvent.call(this, PlayerEvent.AD_PLAY, adEvent);
        };
        var _onAdClicked = function(adEvent) {
            LOGGER.debug("onAdClicked()", "adEvent", adEvent);
            if (isPlaying()) {
                pause();
            } else {
                if (!adEvent.data.clickThroughUrl) {
                    resume();
                }
            }
            _fireAdEvent.call(this, PlayerEvent.AD_CLICK, adEvent);
        };
        var _onAdStarting = function(event) {
            _removePoster();
            var data = event.data.data || {};
            var creativeDuration = event.data.target && event.data.target.creative ? event.data.target.creative.duration : 0;
            data.duration = data.duration || creativeDuration;
            data.adType = event.adType;
            player.dispatchEvent(PlayerEvent.AD_STARTING, data);
        };
        var _setContent = function() {
            if (_lastAdType === AdType.PREROLL) {
                _showSpinner();
            }
            _display.setContent(_video);
        };
        var _enableClickthrough = function() {
            var clickableTimeInSeconds = _video.metadata["clickableTimeInSeconds"] || 0;
            var currentTime = _getPlayerState().currentTime;
            var enableClickthrough = currentTime >= clickableTimeInSeconds;
            LOGGER.debug("Clickthrough is", enableClickthrough ? "enabled" : "disabled", "clickableTimeInSeconds:", clickableTimeInSeconds, "currentTime:", currentTime);
            return enableClickthrough;
        };
        var _onVideoClick = function() {
            var clickUrl = _getClickUrl();
            player.dispatchEvent(PlayerEvent.USER_INTERACTION, {"interactionType":vdb.enums.UserInteraction.VIDEO});
            _thirdPartyContentTracker.fireContentClick();
            if (clickUrl && _enableClickthrough()) {
                $.openLinkInNewTab(clickUrl);
                if (isPlaying()) {
                    pause();
                }
            } else {
                if (_skin && (!isMobile || _isSkinVisible) && !(_skin.ccMenu && _skin.ccMenu.isLocked) && !_video.data360) {
                    _defaultVideoClickBehavior();
                }
            }
        };
        var _onVideoRollOver = function() {
            if (!isAdBlockerStarted()) {
                _display.getMainArea().enableMousePointer(_getClickUrl() && _enableClickthrough());
            }
        };
        var _onVideoTouchStart = function() {
            _display.touch();
            _isSkinVisible = _skin && _skin.isSkinVisible;
        };
        var _bindTimeQueueEvents = function() {
            function handler(event) {
                if (_adBlockerStart || _adLoadStarted || _adCycleInProgress) {
                    LOGGER.info("Queuing time queue event ", event, " reason: blocking ad in place");
                    _timeEventQueue.link(vdb.events.EventContext.bindOnce(_adController, AdEvent.AD_BLOCKER_COMPLETE, handler.bind(null, event)));
                } else {
                    var eventClone = vdb.Utils.copy(event);
                    switch(event.type) {
                        case vdb.events.TimeQueueEvent.PREROLL:
                            eventClone.type = AdType.PREROLL;
                            break;
                        case vdb.events.TimeQueueEvent.MIDROLL:
                            eventClone.type = AdType.MIDROLL;
                            break;
                        case vdb.events.TimeQueueEvent.OVERLAY:
                            eventClone.type = AdType.OVERLAY;
                            break;
                        default:
                            return;
                    }
                    _adLoadStarted = true;
                    _adCycleInProgress = true;
                    _adController.loadAds(eventClone, function() {
                        _adLoadStarted = false;
                        _adController.startAds(eventClone.type, eventClone.time);
                    });
                }
            }
            _timeEventQueue = vdb.events.EventContext.empty();
            controller.addEventListener(vdb.events.TimeQueueEvent.MIDROLL, handler);
            controller.addEventListener(vdb.events.TimeQueueEvent.OVERLAY, handler);
        };
        var _addEventListeners = function() {
            _bindTimeQueueEvents();
            _adController.setVolume(_getInitialVolume());
            _adController.mute(_getInitialMuted());
            _adController.addEventListener(AdEvent.ADS_LOADED, _onAdsLoaded);
            _adController.addEventListener(AdEvent.AD_LOADED, _onAdLoaded);
            _adController.addEventListener(AdEvent.AD_STARTED, _onAdStarted);
            _adController.addEventListener(AdEvent.AD_STARTING, _onAdStarting);
            _adController.addEventListener(AdEvent.AD_PAUSED, _onAdPaused);
            _adController.addEventListener(AdEvent.AD_VOLUME_CHANGED, _onAdVolumeChanged);
            _adController.addEventListener(AdEvent.AD_TIMEUPDATE, _onAdTimeUpdate);
            _adController.addEventListener(AdEvent.AD_WAITING, _onAdWaiting);
            _adController.addEventListener(AdEvent.AD_QUARTILE, _onAdQuartile);
            _adController.addEventListener(AdEvent.AD_RESUMED, _onAdResumed);
            _adController.addEventListener(AdEvent.AD_CLICK, _onAdClicked);
            _adController.addEventListener(AdEvent.AD_FINISHED, _onAdFinished);
            _adController.addEventListener(AdEvent.AD_NONE, _onAdNone);
            _adController.addEventListener(AdEvent.AD_BLOCKER_STARTED, _onAdBlockerStart);
            _adController.addEventListener(AdEvent.AD_BLOCKER_COMPLETE, _onAdBlockerComplete);
            _adController.addEventListener(AdEvent.AD_BLOCKER_REQUEST, _onAdBlockerRequest);
            _adController.addEventListener(AdEvent.AD_INTERACTION_START, _onAdInteractionStarted);
            _adController.addEventListener(AdEvent.AD_LINEAR_CHANGE, _onAdLinearChange);
            _adController.addEventListener(AdEvent.AD_ENGINE_RUN, _onAdEngineRun);
            _adController.addEventListener(AdEvent.AD_SHOW_COMPANIONS, _onAdCampanionsShow);
            _adController.addEventListener(AdEvent.AD_SUBTITLES_FOUND, _onAdSubtitlesFound);
            _adController.addEventListener(vdb.events.TrackEvent.AD_ENGINE_RESPONSE, _onAdEngineResponse);
            _context.addEventListener(PlayerEvent.PLAYER_RESIZE, function() {
                _adController.resize();
            });
            _thirdPartyContentTracker = new vdb.reporter.ThirdPartyContentTracker(player, getResolver());
        };
        var _initAdController = function() {
            var injector = vdb.ctx.getInjector();
            return vdb.html5.player.AdControllerProducer.produce(injector, controller.getAdContainers(), _adsConfig, _hasAdBlocker).then(function(adController) {
                _adController = adController;
                var loadTimeLimit = injector.resolveSync(vdb.enums.Dependencies.CONFIG).getLoadTimeLimit();
                _lookAheadManager = new vdb.html5.player.LookAheadAdManager(controller, !!loadTimeLimit);
                _addEventListeners();
            });
        };
        var _completeInit = function() {
            _playAdOnLoad = _adsConfig.isAutoplay() && (utl.desktopOs() || vdb.ctx.playsNativeInline());
            player.dispatchEvent(def.VIDEO_READY);
            _display.stop();
            if (_deferCommand) {
                _deferCommand();
                _deferCommand = null;
            } else {
                if (_playlist.isEmpty() && _autoplayInView === 0 && _autoplay) {
                    play(_startVideo);
                } else {
                    if (_poster) {
                        _playAdOnLoad = false;
                    }
                    if (!_autoplay && !_playAdOnLoad && _autoplayInView === 0) {
                        _showClickToPlay();
                    } else {
                        if (_autoplayInView !== 0) {
                            vdb.events.EventContext.bindOnce(vdb.ctx, PlayerEvent.ALLOW_POSTER, _showPoster);
                        }
                    }
                    if (_autoplay && (utl.desktopOs() || vdb.ctx.playsNativeInline() || _isIosApp)) {
                        _clearStartTimer();
                        var isAndroid = utl.browser["platform"] && utl.browser["platform"]["android"];
                        if (isAndroid && vdb.ctx.playsNativeInline()) {
                            _startTimer = setTimeout(_onContextStartedTimeout, CONTEXT_STARTED_TIMEOUT);
                        }
                        play(_startVideo);
                    } else {
                        _selectVideo(_startVideo);
                    }
                }
            }
        };
        var _onReady = function() {
            _autoplay = _autoplay || _posterInteraction || config.autoplay && vdb.Utils360.checkIfVideo360(_playlist.getVideo(_startVideo)) && vdb.ctx.getMacro(def.PlayerMacros.MOBILE360) && utl.browser.isIos();
            var cfg = _context.getInjector().resolveSync(vdb.enums.Dependencies.CONFIG);
            var aggressiveMode = cfg.isAggressiveMode();
            if (_hasAdBlocker && !aggressiveMode) {
                player.dispatchEvent(def.VIDEO_READY);
                _setPlayPoster(_autoplay || _context.ctx.AdBlockerOverlay ? null : function() {
                    _posterInteraction = true;
                    _poster.removeControls();
                    _poster.setOnPosterAction(null);
                    _display.detach();
                    _context.showAdBlockerOverlay();
                });
                _display.hide();
            } else {
                _ready = true;
                _state.onPlayerReady();
                if (!_adController) {
                    _initAdController().then(_completeInit);
                } else {
                    _completeInit();
                }
            }
        };
        var adBlockerCheckCallback = function(hasAdBlocker) {
            _hasAdBlocker = hasAdBlocker;
            setTimeout(_onReady, 0);
        };
        var _checkAdBlocker = function() {
            var adBlockerSnifferResult = _context["adBlockerSnifferResult"];
            if (adBlockerSnifferResult) {
                adBlockerSnifferResult.then(adBlockerCheckCallback);
                return;
            }
            adBlockerCheckCallback(false);
        };
        var _setPlaylist = vdb.Promise.wrapWaiting(vdb.ctx.vpaidStartedPromise, function(bid, initPlayer) {
            if (!(bid instanceof vdb.model.Bid)) {
                bid = new vdb.model.Bid(bid, _context);
            }
            _playlist = bid;
            this.playlistFuture.resolve(bid);
            player.dispatchEvent(def.BID_UPDATED);
            if (initPlayer) {
                if (typeof _hasAdBlocker === "undefined") {
                    _checkAdBlocker();
                } else {
                    setTimeout(_onReady, 0);
                }
            }
        });
        var continueStart = function() {
            _thirdPartyContentTracker.fireContentImpression();
            _setContent();
            _display.show();
            _display.play();
            if (utl.browser.isIos() && _wasFullScreen === true) {
                _display.webkitEnterFullscreen();
            }
        };
        var _onMetaData = function(eventData) {
            _state.onMetadata(eventData, _video);
            _vidibleContentTracker.setVideoDuration(eventData.durationWithoutAds);
            _thirdPartyContentTracker.setVideoDuration(eventData.durationWithoutAds);
            _fireContentVideoEvent(PlayerEvent.VIDEO_META, {"duration":eventData.duration, "durationWithoutAds":eventData.durationWithoutAds});
            _timeQ.initQueue(_video, _state.getVideoLength(), _adsConfig);
        };
        var _onVideoPlay = function() {
            _hideSpinner();
            _fireContentVideoEvent(PlayerEvent.VIDEO_PLAY);
            _state.startPlayTimeCounting();
            _vidibleContentTracker.onVideoPlay();
            pausedOutOfView = false;
            if (config.fullscreenOnUnmute && !_fsController.isFullscreen()) {
                toggleFullscreen();
            }
        };
        var _onVideoStarted = function(event) {
            _removePoster();
            _state.onVideoPlay();
            _video.vpt = _getVideoPlayType();
            _setReportingVideo(_video);
            _vidibleContentTracker.fireStartPlaying();
            _thirdPartyContentTracker.fireContentView();
            _hideSpinner();
            dispatchContextStart(false);
            _fireContentVideoEvent(PlayerEvent.VIDEO_START, {"duration":event.duration, "stopOnEnd":_stopOnEnd()});
        };
        var _onVideoPause = function() {
            _fireContentVideoEvent(PlayerEvent.VIDEO_PAUSE);
            _state.stopPlayTimeCounting();
            _vidibleContentTracker.onVideoPause();
        };
        var _onVolumeChanged = function(eventData) {
            _fireContentVideoEvent(PlayerEvent.VIDEO_VOLUME_CHANGED, {volume:eventData.volume, muted:eventData.muted});
        };
        var _onThirdPartyPosterAvailable = function(tpPoster) {
            function setThirdPartyPoster(poster) {
                poster.setThirdPartyPoster(tpPoster);
            }
            if (_poster) {
                setThirdPartyPoster(_poster);
            } else {
                player.addEventListener(PlayerEvent.VIDEO_POSTER_READY, function(event) {
                    setThirdPartyPoster(event.data);
                });
            }
        };
        var _onTimeUpdate = function(eventData) {
            var currentTimeWithoutAds = _getCurrentTimeWithoutAds(eventData.currentTime);
            _state.onTimeUpdate(eventData.currentTime);
            _vidibleContentTracker.firePlaybackPixels(currentTimeWithoutAds);
            _thirdPartyContentTracker.fireVideoTimeUpdate(currentTimeWithoutAds);
            _fireContentVideoEvent(PlayerEvent.VIDEO_TIMEUPDATE, {"currentTime":eventData.currentTime, "duration":eventData.duration, "durationWithoutAds":eventData.durationWithoutAds, "percentBuffered":_getPercentBuffered(eventData.duration, eventData.buffered)});
            _timeQ.check(_state.getCurrentTime());
        };
        var _onHandleVideoError = function(error) {
            if (!error.fatal) {
                return;
            }
            if (error.code === MediaError.MEDIA_ERR_DECODE || error.code === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED) {
                _vidibleContentTracker.onError(error);
                _qoeTracker.trackError(error);
                _timeQ.reset();
                _markVideoAsFailed(_playlist.getCurrentVideoIndex());
                _moveToNextVideo();
                _vidibleContentTracker.setVideo(_video);
            } else {
                if (error.code === MediaError.MEDIA_ERR_NETWORK) {
                    _drawError({title:"Network Error", description:"Sorry, a network error caused the video download to fail. Please refresh and try again.", code:14});
                }
            }
        };
        var playUntilLookAhead = function() {
            if (!_playlist.isEmpty()) {
                if (_nextVideoIndex !== -1) {
                    play(_nextVideoIndex);
                    _nextVideoIndex = -1;
                } else {
                    if (!_autoplay && !_posterInteraction) {
                        _setPlayPoster(function() {
                            _posterInteraction = true;
                            _display.touch();
                            _ageGate.checkAge();
                            _removePoster();
                            _showSpinner();
                        });
                        return;
                    }
                }
                _ageGate.checkAge();
            } else {
                LOGGER.debug("Playlist is empty. Run preroll again.");
                if (_videosToPlay > 0) {
                    setTimeout(_loadPrerolls, 100);
                    dispatchContextEnd();
                } else {
                    _finish();
                    dispatchContextEnd({"failed":true});
                }
            }
        };
        var PlayerController = def.PlayerController.extend({init:function() {
            this._super();
            this.playlistFuture = new vdb.Future;
        }, play:play, replay:replay, pause:pause, resume:resume, inView:inView, outOfView:outOfView, stop:stop, isAdBlockerStarted:isAdBlockerStarted, setVolume:setVolume, getVolume:getVolume, setControls:setControls, removeControls:removeControls, setPlaylist:_setPlaylist, setVideosToPlay:_setVideosToPlay, continueStart:continueStart, getPlayerState:_getPlayerState, setVideoPlayType:_setVideoPlayType, turnOnMouseOverSound:turnOnMouseOverSound, turnOnMouseOverOffSound:turnOnMouseOverOffSound, getAdConfigEntry:getAdConfigEntry,
            getLiveManager:getLiveManager, moveToNextVideo:_moveToNextVideo, mute:mute, unMute:unMute, isMuted:isMuted, seekTo:seek, sendKey:sendKey, getResolver:getResolver, isPlaying:isPlaying, toggleFullscreen:toggleFullscreen, togglePlay:togglePlay, toggleMute:toggleMute, move360:move360, hideSpinner:_hideSpinner, clearVideo:clearVideo, playUntilLookAhead:playUntilLookAhead, getContext:function() {
                return _context;
            }, getSkin:function() {
                return new vdb.Promise(function(resolve) {
                    if (_skin) {
                        resolve(_skin);
                    } else {
                        player.addEventListener(PlayerEvent.PLAYER_SKIN_READY, function(e) {
                            resolve(e.data);
                        });
                    }
                });
            }, getCurrentVideoId:function() {
                if (_video) {
                    return _video.id;
                }
                return _adConfigEntry ? _adConfigEntry.getVideoId() : "";
            }, getCurrentVideoTitle:function() {
                if (_video) {
                    return _video.title;
                }
                return _adConfigEntry ? _adConfigEntry.getVideoTitle() : "";
            }, getCurrentVideo:function() {
                return _video;
            }, getCurrentVideoIndex:function() {
                return _playlist ? _playlist.getCurrentVideoIndex() : null;
            }, getNextVideo:function() {
                return _playlist ? _playlist.getNextVideo() : null;
            }, getNextVideoIndex:function() {
                return _playlist ? _playlist.getNextVideoIndex() : null;
            }, getVideo:function(index) {
                return _playlist ? _playlist.getVideo(index) : null;
            }, getPlayList:function() {
                return _playlist;
            }, getPlaylistPromise:function() {
                return this.playlistFuture.getPromise();
            }, getPlayer:function() {
                return player;
            }, getContainer:function() {
                return _container;
            }, getAdContainers:function() {
                return{adContainer:_videosContainer, overlayContainer:_overlayContainer};
            }, getSubtitlesManager:function() {
                return _subtitlesManager;
            }, getAdController:function() {
                return _adController;
            }, getAdsConfig:function() {
                return _adsConfig;
            }, getAdInfoBar:function() {
                return _adInfoBar;
            }, isReady:function() {
                return _ready;
            }, hasContextStarted:function() {
                return _contextStarted;
            }, adBlockerCheckCallback:adBlockerCheckCallback, isAol:config.isAol, adOnly:config.adOnly, width:player.getSize().width, height:player.getSize().height, timeLinePreview:config.timeLinePreview, isBrandedWithControls:function() {
                return player.isBranded() && (_adEngineType === AdEngineType.VAST || _adEngineType === AdEngineType.EMBED_VAST);
            }, isAutoplay:function() {
                return _autoplay;
            }, isAutoplayInView:function() {
                return _autoplayInView;
            }, clickOnPoster:function() {
                _posterInteraction = true;
            }, getSkinType:function() {
                return _getSkinType();
            }, getPoster:function() {
                return _poster;
            }, getDefaultVideoClickBehavior:function() {
                return _defaultVideoClickBehavior;
            }, setDefaultVideoClickBehavior:function(defaultVideoClickBehavior) {
                _defaultVideoClickBehavior = defaultVideoClickBehavior;
            }});
        controller = new PlayerController;
        _timeQ = new vdb.html5.utils.TimeQueue(controller);
        var _initVideoListeners = function() {
            _display.addContentListener(def.VIDEO_METADATA, _onMetaData);
            _display.addContentListener(def.VIDEO_PLAY, _onVideoPlay);
            _display.addContentListener(def.VIDEO_STARTED, _onVideoStarted);
            _display.addContentListener(def.VIDEO_PAUSE, _onVideoPause);
            _display.addContentListener(def.VIDEO_RESUME, _onVideoPlay);
            _display.addContentListener(def.VIDEO_VOLUME_CHANGED, _onVolumeChanged);
            _display.addContentListener(def.VIDEO_TIMEUPDATE, _onTimeUpdate);
            _display.addContentListener(def.VIDEO_SEEKSTART, _onVideoSeekStart);
            _display.addContentListener(def.VIDEO_SEEKEND, _onVideoSeekEnd);
            _display.addContentListener(def.VIDEO_PROGRESS, _onVideoProgress);
            _display.addContentListener(def.VIDEO_WAITING, _onVideoWaiting);
            _display.addContentListener(def.VIDEO_BUFFERING_START, _onVideoBufferingStart);
            _display.addContentListener(def.VIDEO_BUFFERING_END, _onVideoBufferingEnd);
            _display.addContentListener(def.VIDEO_END, _onVideoEnd);
            _display.addContentListener(def.VIDEO_CLICK, _onVideoClick);
            _display.addContentListener(def.VIDEO_TOUCH_START, _onVideoTouchStart);
            _display.addContentListener(def.VIDEO_ERROR, _onHandleVideoError);
            _display.addContentListener(def.MOUSE_OVER_VIDEO, _onVideoRollOver);
            _display.addContentListener(def.THIRD_PARTY_POSTER_AVAILABLE, _onThirdPartyPosterAvailable);
        };
        var _initContext = function() {
            _context = vdb["getContext"](vdb.ctx.id);
            _qoeTracker = new vdb.tracking.QoETracker(_context);
            _tracker = vdb.createBasicTracker();
        };
        var _initDisplay = function() {
            _contentEventDispatcher = _display.getContentEventDispatcher();
            _display.appendTo(_videosContainer);
            if (controller.isAol) {
                _display.setBgColor("black");
            }
            _initVideoListeners();
            _initVideoComponents();
            _initVideoSetting();
        };
        var _initController = function() {
            LOGGER.debug("init");
            _ageGate = new vdb.html5.player.AgeGate(controller);
            new vdb.html5.tracking.InteractionTracker(vdb.ctx, controller);
            _liveManager = new vdb.html5.live.LiveManager(controller, vdb.ctx);
            _initDisplay();
            _initUserInteractionEvents();
        };
        _initController();
        _initContext();
        return controller;
    };
})(vdb.html5.player);
vdb.extras.OverlayVideoController = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("OverlayVideoController");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var SWAP_EVENT = "OverlayVideoController";
    var internalEventBus = new vdb.EventBus;
    var instanceCounter = 0;
    var utl = vdb.Utils;
    var $ = vdb.utils.Common;
    var CLICK_EVENT = utl.mobileOs() ? "touchstart" : "click";
    var createVideoArea = function(videoUrl) {
        var videoArea = new vdb.html5.player.video.AdjectiveVideoArea;
        var videoAreaContainer = utl.createElement("div", {"class":["video-container"]}, this._container);
        videoAreaContainer.appendChild(utl.createElement("div", {"class":["video-area"]}, this._container));
        videoAreaContainer.appendChild(videoArea.getElement());
        videoArea.setVideo(videoUrl);
        videoArea.mute(true);
        videoArea.touch();
        videoArea.play();
        videoArea.addEventListener(vdb.html5.player.VIDEO_PLAY, onPlay.bind(this));
        videoArea.addEventListener(vdb.html5.player.VIDEO_RESUME, onPlay.bind(this));
        videoArea.addEventListener(vdb.html5.player.VIDEO_PAUSE, onPause.bind(this));
        videoArea.addEventListener(vdb.html5.player.VIDEO_END, onVideoEnd.bind(this));
        return videoArea;
    };
    var createPlaybackButton = function() {
        var button = utl.createElement("div", {"class":["play-button-pp", "control"]}, this._container);
        button.addEventListener(CLICK_EVENT, onPlaybackClick.bind(this));
        return button;
    };
    var createSwapButton = function() {
        var swapButton = utl.createElement("div", {"class":["swap-button-pp", "control"]}, this._container);
        swapButton.addEventListener(CLICK_EVENT, onSwapClick.bind(this));
    };
    var createCloseButton = function() {
        var closeButton = utl.createElement("div", {"class":["close-button-pp", "control"]}, this._container);
        closeButton.addEventListener(CLICK_EVENT, onCloseClick.bind(this));
    };
    var onPlaybackClick = function() {
        if (utl.hasClass(this._playbackButton, "play-button-pp")) {
            this._videoArea.play();
        } else {
            this._videoArea.pause();
        }
    };
    var onSwapClick = function() {
        var muted = !this._videoArea.muted();
        internalEventBus.dispatchEvent(SWAP_EVENT, {id:this._instanceId, muted:muted});
        this._videoArea.mute(muted);
        this._volumeChangeTimer = setTimeout(onVolumeChangeTimer.bind(this), 200);
        if (muted) {
            this._playerController.unMute();
        } else {
            this._playerController.mute();
        }
    };
    var onCloseClick = function() {
        this._videoArea.reset();
        utl.removeFromParent(this._container);
    };
    var onPlay = function() {
        $.show(this._container);
        utl.replaceClass(this._playbackButton, "play-button-pp", "pause-button-pp");
    };
    var onPause = function() {
        utl.replaceClass(this._playbackButton, "pause-button-pp", "play-button-pp");
    };
    var onVideoEnd = function() {
        onCloseClick.call(this);
        this._videoArea = null;
    };
    var onVolumeChange = function() {
        if (typeof this._volumeChangeTimer !== "undefined") {
            return;
        }
        this._videoArea.mute(true);
    };
    var onVolumeChangeTimer = function() {
        this._volumeChangeTimer = undefined;
    };
    var onGlobalSwap = function(data) {
        if (data.id == this._instanceId) {
        } else {
            this._videoArea.mute(true);
        }
    };
    var addStyle = function() {
        if (instanceCounter == 0) {
            vdb.dom.embedCssToHead(".video-overlay-container.left-top{top:24px;left:24px}.video-overlay-container.right-top{top:68px;right:24px}.video-overlay-container.right-bottom{bottom:68px;right:24px}.video-overlay-container.left-bottom{bottom:68px;left:24px}.video-overlay-container{width:212px;height:120px;position:absolute;background-color:rgba(22,22,22,0.85);border-radius:4px;z-index:1}.video-overlay-container .video-container{width:202px;height:110px;left:4px;top:4px;position:relative}.video-overlay-container .control{position:absolute;background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJIAAABcCAYAAACFmexKAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGOTdGMTE3NDA3MjA2ODExODIyQUE3Qzg0QkRDMDAwRSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozNzYyNzhDMzI2MzYxMUU2ODFFRkRCNTM4NDFDRjAxMiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozNzYyNzhDMjI2MzYxMUU2ODFFRkRCNTM4NDFDRjAxMiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RkY3RjExNzQwNzIwNjgxMTgyMkFBN0M4NEJEQzAwMEUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6Rjk3RjExNzQwNzIwNjgxMTgyMkFBN0M4NEJEQzAwMEUiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5++zobAAAZVklEQVR42uxdCVgVx5ZuQBBZFCOCC4uiQdB8giQqmEmeJnlq1OCG72XyQqLRaCLuUb+QqAMmxiQqRgNu4/apL5P5cCUu0THRLCOIRsHPfcEBFBE1YFhEZJn626r7+l763tvbBfrG832lfXup89N1qurU6XNOOdTV1XFP6AmppWb4p0uXLmrqcCPlWVJ6k/I0KZ1I8SbFnV4vJ+UeKddJuUpKJim/kVKhlOG1a9c4O8ftSLENICWCFH9SvOi1ElLySTlFyhGKqVYK3+zsbHO3hJMSS8pfyMDSxcHBwYvywYM/kbKVlCyxB8PCwv4lSKCNGzdKfiHvvPOOA/nvBVJG0z+2uYXbW9LSmZSXSJlIykP6EnaS8jPhXSeDt9FvveK2IEAxpLxLSoCZe7xp6UXKeFLySPlPUrZbEygRgkQvIWUkO0GEiB16UWFGmUXKLlLmUOESH5HkEHkhg8h/U0gJFp53cnJyCAgIcGnfvr1L69atmzVv3pxH9PDhw7ri4uLqW7duVeXl5VXV1NTU0QYcTMtlUmcyaZSDthx6dYA7iJSlpPSAuiFoUGsEgfuElNdJmU1KjsTnIDxbSPFgJ6zwxf1/JeUtKlTKBIm8tEDyXwIp/di5Fi1aOEZFRXlERER4kuG6BWkER0t1kMapJcPsg1OnTpWmp6eXPXjwoJY27EpS/zHUTxomV2MB0gPuF0lZQadbOUIkpB6k7CBlOkZLK/dGk5KKfiQ8KYGvB31uFClpRs9CCjFnW5oiyMt6jfyXyPSHli1bOg0bNqz1Cy+84GXaCKivtLS0uqqqih9mXVxcHD09PZuZgkTj/PLLLyV79+4t/uOPP2roaegfCwiW7yxNEUJdQ6+4BdSflGRSnJVKoclI8oiOvEfN6EjBVK/yUCH45VR3u1xPR7KgU0DC32cSO2jQIK/XXnvNG72a/RFXr16tOHPmTPnFixcr8vPzSVtUGekOpFEc/P39XUJCQtx69uzp3rVrVzc05CuvvPLU888/7/Xdd9/dPXjwYAmpCz1yKeGLN71Cjg6iU9yYzparESKRkcSZ1jnazDS3QqUQcbRjop5XrY5ItDH+g5R/x+9WrVo5vffee+26devG9+5Hjx7VZWRk3N+3b19xUVHRIzkofHx8nIcOHdo6MjKylbOzM/8WLl++XLFmzZpbJSUlrJf/N/ibNoq1EUkvuOm0kkqnJFvQWVL+RkqNYER6jvx3wvRGMlVzy5Yt40aPHs2FhoYazl+4cIHbvn07N3v2bKgDYjx6kxHppLURaRZrDKKIOs+aNcuvTZs2zpRB+datW4sKCwsfKfkL0YCbNm0qOnDgQHFsbKwPAe8eHBzs9vHHHwckJSXdIAou6v07KfdJWSazer3gHikmRDt37gw2PVdWVlbzySef3Lhy5cpDGXCfoTy2C869IXbjkiVLuKysLO78+fPc/PnzeWGCEBGeXGVlJX99wYIFYo/iPZ9ky01zusVE1hjx8fEBaIza2to68ofeWbp06U2ljSEk1IG6duzYcQd1gwd4gSe9ZSLFInVK0wtuR4bTGkGIEhMT5QoRo4kmbfyC2E1jxozhXF1deaGB8BD9zyBEOB8TE2Ou/r8I/yCxVU4imxZmzpzp5+Hh4QT9Ye3atQVQMrW0hqMuTDOoGzzACzzBm96SSDFJWZ3pBTemmEApfGCegK6mEGYg5SW0G9UjjEAYiZgwQV1gQoTz3bt3t6TjceZGJCyV3aHATZw4sZ23tzffo0nlt06cOFFuKzsP6gYP2GvAE3oNVSLdmYBYIT3h7i+1fiwO5s2b50ca01UhxL+YGFk5c8L0xhvGMx9+C3UmEWotKkjUaMfbW7DKgQ5A5+07mZmZZbb+XgMeu3btuoNjKMfAQC9FUWyWjI16wt3LUn2lpaU1mNKEwkR0vfYK4UUIjm+buwk60TfffGN0Dr9x3gIV1xMkutqJY1MDlso4JkvjcqJclnANROAFpRjHwODl5cWmijiKUWyVpjfcgZaEKCEhIR/KNRMmjHbr168vUghN+Kkl35wQCXUirDCFOhOUcDOUIzYiwbraDQdY4qIXVFdX123ZsqWoIT0EwAsrK/AGhiFDhrDhs5sZZVGPuFuZnZ+JEF2/fr0KyjWECStFsjQvyMjIUDo9C3n9r9gNqampRjrRsGHDjHQmmADM0E9igjSSDaOw/OI4PT39vharHCWrIvDmlxkECzMiUtO82DJaj7hFCULEjiFMROe6LhSiiIgIt9WrV3cKDg42fHAODAx0kVj9f4mdnDNnDuo1LP2FCnivXr3462boG1NBgrUJX7i5yMhID1hv2aqEayQCb2AAFmCip1+iWDktcMNmIyxyr6vAfV+RskOEaO7cuR19fX1doIBDmCBEiYmJfhYeE/KCzed7EYWeI/XVU6yZMJkxRqKe34wEifzh8MnhJfzZZ5/15Ce/nJwKuZZf0Lp16zq/9NJLnmoFCbyvXbvG+/4899xzrD5g7C2YTjTDrRVJwU1I0QfeSZMm+TJTAMwNpJH9IEQtW7a0ZFjOM/k9DeYplX8mnp9uahjDt5rezGaBr+HUnK5oTsYSeMqUKe3j4uJ82GcEpYTvYLyxIiioBbAJbDCc1ri1JGu4CZ1WUm9SUlJBRUWFYTXn7u7uZEWIQKdMfl8h5R/Q4RX+eTX0+cv1BIl77CHIz7XsqzjR5CvUvMyXX37Za/Hixf7t2rVrprQOhgGYBHqAcIrRHLcWJAH3USX1Xrp06eHChQtvCIVJAv0kcg4uIGMUjExl9Lk00wuOwuVox44dXdgKBF/D1b5Q0iNdlyxZEkh0BXclzwMDW3kxbNxjl1jOlrjVkgTcJ5VOb7CiY2Uo8XbwOGHmGpzTwjkRJzUl9zNBakPtMM2oLaPa1KVCKWH4JVp/x7Fjx7Yhw7zslwYsQmyEnhLcYjPcakgCbvg8rZNbb+fOnV0SEhL8JUxnBpUV/cvC9Wt0RQkDaRJVnpntrYT+TqLXR3Fm3GxBDBA/Yri6uvKCBectLV8sPhlER0e3IcO8K1EOb8p5lmFh2Lh/OefbHLcasoKb9XB8k5DsRgLTAOmQ1yTeftZ09GBOaCKUxZlx7pdKjg35cuuexD6ZKq3wsbaFToc656hQqBULEr/KqKysrGVKosYCxKWlpd1btGhRgdxnGRaGjWFtCNxqyApuRvjEMJN77B6rFT2idebIeAa6zzKquxXT6bCY/l5Gr0sSpHu85er+fX5eh68yi6ZQS+Xl5TVffPHFzc2bN9+rqZHXQWAzARYhNobV1rjVkATcnMkKbrJGI1MFrUvqqhBuJTupOQIOgQg9Yh+cWTjSLHp9J2fGDUUoSPwK4ubNm1VMp/Hz83NR+1fl5ORUEkU7NzMzU5FtB/7SzB+ZYTNZ7dgEt1qSgNuUEPUBH+tzckZ5k9/naB0/S6xiJNWLRmpxPxMk3riUm5tbxZTE0NBQNzUv84cffiiJj4/PLywsrFZaB8MATMAmxGor3FqQBNycmWkOrogfcfWt0aILGEq49yPyO0bGdMbCkeQGAbBwpGhzgsT73cJdAfFbVMNXZPv5/fffq1euXHkrJSWlCI72ahoEkRv8GpVgogGKBqxa49aSJOA2R+gMiE2DD9ObpGyg08pdqvs8osen6bU36b07OOlRtjCM/pMziWmTQXjuG84k0JQt/2G0gk9w85MnT5Z2797dPSgoyA1RE3K/W02YMCFHi8YA7y5duvA9+7fffitlq2oTA5tmuLUiKbhZVIcVgTphwZiohmwSjsRGJPTmH3Fw/PjxMgzJGDrh39NYvRq8gQFYMjIymCn/R4qV0wL3qFGjLguL3OsqcDcW4XvfYJEFEe/MRjqj0Xn8HjduHH9dhAZzgu+HQgsptPJXEY6MSFIEAUZFRbVC6E1D+/a0a9fOGbxxDCw0RJphNCXd4W6sbCScmXCkKVOmcD///DP8z7lNmzbBa8EgRBUVFfx1nBch0XCkX0i5hAP41OAlNGvWzOGtt97yURiLrojACzzBGxgEvkWXKEZT0itucwKEoEYkptjGPc42gs8T3rTTN+OMM5Fso/f+jZNmXBYNR4qLi+Pc3Nx4oYHwbN682SBEOD958mRz9dUPR6KRoSnU9lGTlpYGpY4LCQlxb8gpDi6q4IljhEQDC72UIhYKrVfcIoTQHvi0IrNIgAzWLBvJdk4QHmTBblR/viMjEEYcJkzw02ZChPO9e/e2hJkzHZE4mqKF9+s9dOhQCRzocTxixIi2ffr08bB1Y4DHyJEjDc77iKunl45ZSh+jV9wCepGuvNSEb7NsJC9auMdsOBKE6YMPPjA6h984b4HEw5EoIRarHAavNWvWFN69e/eRo6MjlLH2RDJttrRG3eBBeDmA59q1awup0Q1CkSChCr3i7k/KKo6mtFFJbrSu/maumw1Hgk6E+H8h4bepAm5CxWYFieb5mY9jpG1Zvnw5HxYDs/+kSZM6IC2MlroH6kKdqBs8wAs8BVPDAim5h3SKW3Y2EgnfvVk2ErFpLt+cEAl1IvhpC3UmKOEWjKhmRyQ0yj6O+ssgMcLixYvzaA93IMvgtvAvwgpFi1UO6kKdqPvevXs8L5qMAbSOYNkrtT6d4YZhb6nckUhiZ0CdS0SMjqLhSCkpKUY60dixY410plWrVpnj85PY8t+Ukqjh6R94QYsWLcp7991328HoB6UyMTGxE9LD7N+/v/j27duyltm+vr7OUE6F6WEQXLhu3bpCQY/+lmKQS3rBLZqNhCzV60WrIGUOmT5vZGdnq81GgnCkWaY3Jicnc1OnTuVXZ0wnYgo4hAzXzZAhHMlixjaxhFUDBw70io6ONkpYlZOT8+DMmTNl5KU+yM/Pf4j8i8J68EXe39+/eWhoaIuePXt6wCme9SwslbHSgpIsGLZXc2YSVknJ2KYD3MCAcJ5Aa4IEIXr77bdvnD17Vkk2Ekytg0mdQjvTATGjpAL6npOSaMvkJbxGFUd+BWQthV55eXl1ZWUl/zJdXV0d3N3dJaXQI8+WkfsSNE791xRx9+EepxzmrAkSwVSL0YjoMZUKGzyW1Jkp+P00NWaqWc2WUYPpZVmCRF8Eeg8yoT3PzqF39+3b1wMxZV27dpWU1PPq1asP8A0KnzQEll82fydaU1DlCFITxj2XGhQ5KVMbhGn8+PE3iNKrRJjWkzqXmJyLptZ2JR9u0XnqJSOVHCpEXxR5H+8M5B4nbQjBCz169OgfKIjfgi8QoiaQQIE1DhoBw3NBQUEVoisEX8MZXaRGu0O2WJ43UdwWs5GAL0ZClmuJjIyOK1asaN+vX7/rCnhFiJxj4UhbZI5MGIne4kTCkZopaJhDpFH+hxz+G/fYf4ZPfI4XnZub+xBFQjUs8TkUwV+VJh3VMe5AS0IUGxubD2We1O8H4Ub4EVkkaJGNREgsvMgoYbsFspiw3TC1qTSCiW3FwJa1cP/U0xYSDYH7nLlOTFaXLufPn+ed4cLCwpqvXLmyw2effVZ08OBBpRHECCF/xso9hi0k6GcUyVtIGAnSE2pYsiRIVs3g/fu7JSQk+MyYMeNWVlYWP4p269bN5dKlS1UqBEk1OT5p1kah+0qFKCUlpSN8wjHthYeHNw8JCXHZtm2bn9a85NKT3ZEaATe177SR+/zChQt9YZbAMRTxTZs2+UF/euqpp+RkI7GdIJn8kVKGZk13GSK862TwNtc4esJ92sxqyiJNnz69AMLj6enpxOxiEh471aCCJOOFiO4yBIeuHj16uAQFBbkgA4mbmxvfcyoqKuoQSZKTk1N17ty5KpoAwWiXIVJnMmkUm+6O1MRwHzVnR7JEp0+ffjhu3LgbQmGSQD81KUEiL63eLkMeHh6OI0aM8Bg4cKBnr169WpBGsKhzkcapJQriA7ICKd29e3cZIcMuQ6R+fpch0jC5GgtQU8TNspEEyv17YHnXKBuJpmRY/luaIsh1o12GvL29neLi4lrHxMR4mTZCbW0th33O8PJ5RYRcxz5o8A0ybZzt27eXEOWx+O7du0a7DBEs31maIoQ6kl5xU1vWIjmNBdPAli1b/AkuJ5H6xYITPobNS870bxNBojqF0cfPCRMmeE2ZMsUbvZo1ABlyK44cOVKekZFRceHChSr2vYoRFMTQ0FCXyMhItwEDBriTUcCNNRB6d3Jy8t3169fX+/gppoNIESQ94OYaYVObRhEk2hiGXYbatm3rtGLFinZ9+/bleze+lO/Zs+f+mjVrinNzc2W5YwQGBiJDfuvhw4e3YrH6mZmZFdOmTbt1584do12GTBvFmiDpBTclOJ/t4LTxjjQaODnBNlsNIUiWdAPDLkNdu3Z13rlzZwBrjPT09PKhQ4f+X3x8fJHcxuAnbvIMnkUdqAvn+vTp4wYe4EVv+zsn4jsjgfSEu6lkI7GNIFHdYiJrjG+//TagQ4cOzvgutWzZsjuxsbE3r1+/rvqPRx2oa+nSpXdQN3iAl6BRJlIsUhVrPeLGCq6xspHYTpDoKieRTQsbNmzwg3IH/WHGjBkFq1at0nyXodWrVxejbvAAL/AEb3pLIsUkZXWmO9yUZGcjESG52UhsPiJhqczvMgTdws/Pj+/Rc+fOvbV//36bpR5G3eCBpS14grfS3ZF0hls4zUnORmJiuf6IPpvDNRI5ihjteHsLVjlMt0hKSrqzb98+m+8yBB7Lly/ndxkCb2Cgl6IoNkvGRt3hFqGGyEZi21UbjknZQ0o3DM+HDx/ujKUy9sF48803bzaUlwB689atWztGRUW5Y4k9cODA67dv38aKCKHPwzGrmKx+dIfbHkl0d6TJkye3RmMgze+8efMafJeh+fPnF9FdGR2x3KaXrO6OpDPcditIvJecp6enIyy/ON69e/d9LVY5SlZF4M2bfwkWYKKXzO6OpEPcdilIhl2GoqOjPfB5AJZfGO0aCxh4AwOwABM9bXZ3JCW44WgvLHKvq8Btt4Jk2GVo8ODB/I4+2dnZFUqMdr/++mvn0aNHq94dCbyzsrJ428qrr75qbpchzXBrRRJx27Ug8S4V4eHhfM/58ccfFS2ZsWX5l19+2f7zzz/3UZuqGN/B8H9YWFgLYKOnnzMRJE1wa0kScNutIPG7DD3zzDMu7Kt4enq6KkvrmDFjvFJTU/0DAgIU747EMAATsNHT9XZH0hK3FiQBt90KEm+Bffrpp/k/GnM8voarrbxHjx6ue/bsCRw0aJCitDLAACxCbJzI7kha41ZLEnDbrSDx/sM+Pj786AG/HFOXCqUEd9Dk5OSO8fHxsndHAgakWxZi40R2R7IFbjUkAbfdChI/YiCiE/8z5y7NmDg6wuLcZuPGjR3lPsvCowWOaPV2R7IVbjVkBbdd25FsTk92R7J/QeJXGUhWYNKLNCHoC+vXr783fvx42bsjMSyC0abe7ki2wq2GrOC2O2LzN+K3WhUVFfHzOnyVEU2BSAq1DJD6Zc6cOYWHDx+W/SLh6gosOGbYuPq7I9kEtxqSgNtuRyQ+AuLKlStVTKdBGLDays+dO1c5fPjwXCVCBIK/NPORZtg4kd2RtMatliTgtltB4iMQzp49W8WG4n79+qnyI05NTS2JiYnJz8vLU7w7UlRUlBubHoBNiNVWuLUgCbjtVpD4HLhwzkL8Fo4RNaGkwtu3b1fPnj371ocfflikdqNihgGYBLFc9XZH0gK3liQBt90KEttliDtw4AC/o09YWJgboibkVkhGhJxdu3aVqgUG3uHh4XzP/v77763tjqQat1YkEbfdCpJhl6G0tLQyDMmY4wU+NQ1O4A0MwAJM9LTZ3ZGU4EZQobDIva4Ct13bkfgdfODdB/0GxyNGjGjVuXPnBu/d4AneOEZUa2lpqbXdkfSI224FybDLEKIj0DDIaP/pp582+C5D4Emz6dci+oNesro7ks5w26cg0chQfpchRI1+/fXX/C5DkZGR7u+//36DTXGYGsATxwiJFkSwpoiFQusVtz2PSBxN0cJvM7Bhw4aS48eP8/afGTNmtB06dKjNdxkCj5kzZ/K7DIE34urppWOW0sfoFbfdChIlwy5D06ZNK7xx48YjfLWHs9qQIUNstrRG3eCBdMXgOX36dMW7I+kMt30KEs3zw+8yhLQtSBReXFxcA7P/V1991QFpYbTeZQh1om7wAC/wFEwNC6TkHtIrbnsekdAohl2Grl69+uj111/Poz3cYdasWW23bdvWMSgoSPWqCHWgLtSJugsKCnhe4ElvWUewSN4dSa+47VaQKGGHn3+yRomJick7duxYOVNk9+7d2wl+2Z06dZLdMHgGz6IOpqAiu8eoUaOEjaFmdyQ94tY1yU60RYZvr6lTpxolrMrOzn5w5MiRMvJSH1y8ePGh6dd3fJEPCQlpHhUV1WLAgAEecIoXJqzCSkugoPIreU7jRFtNCfefTpAEL8FolyGk0ENUKxz8TX2AUF9JSUl1eXk5/zLd3d0dvLy86u0yBMsvDIiwtwhS6MESnKBx6r8mh/tPK0j0RdTbZQi9G0GAgwYN8oyIiJCU1PPUqVN8Uk98PqBJPRnxuwxZU1DlCFJTxf2nFiTBCzHsMiQ8j/gt+AIFBwe7+Pr6Ogk9BJFMAX45ZPqoEsnIepEa7Q5J5C9LkJoi7ieCZKyDGO0yJJOv0S5DchOfKxGkpoTbrgVJBT3ZHUkmbrsVpCf0hNTS/wswADlzu2KTjtsDAAAAAElFTkSuQmCC') no-repeat;cursor:pointer;z-index:4}.video-overlay-container .play-button-pp{left:-15px;bottom:-12px;width:45px;height:45px;background-position:0 0}.video-overlay-container .play-button-pp:hover{background-position:0 -46px}.video-overlay-container .pause-button-pp{left:-15px;bottom:-12px;width:45px;height:45px;background-position:-46px 0}.video-overlay-container .pause-button-pp:hover{background-position:-46px -46px}.video-overlay-container .swap-button-pp{left:28px;bottom:-8px;width:30px;height:30px;background-position:-92px 0}.video-overlay-container .swap-button-pp:hover{background-position:-92px -30px}.video-overlay-container .close-button-pp{width:23px;height:23px;top:-6px;right:-6px;background-position:-122px 0}.video-overlay-container .close-button-pp:hover{background-position:-122px -23px}")
            ;
        }
    };
    return{init:function(videoUrl, playerController, position) {
        addStyle();
        this._playerController = playerController;
        this._instanceId = instanceCounter++;
        var mainClass = "video-overlay-container " + (position || "right-bottom");
        this._container = utl.createElement("div", {"class":mainClass}, this._playerController.getContainer());
        var player = this._playerController.getPlayer();
        player.addEventListener(PlayerEvent.AD_VOLUME_CHANGED, onVolumeChange.bind(this));
        player.addEventListener(PlayerEvent.VIDEO_VOLUME_CHANGED, onVolumeChange.bind(this));
        internalEventBus.addEventListener(SWAP_EVENT, onGlobalSwap.bind(this));
        $.hide(this._container);
        this._videoArea = createVideoArea.call(this, videoUrl);
        this._playbackButton = createPlaybackButton.call(this);
        createSwapButton.call(this);
        createCloseButton.call(this);
    }, hide:function() {
        if (this._videoArea) {
            this._videoArea.pause();
            $.hide(this._container);
        }
    }, show:function() {
        if (this._videoArea) {
            this._videoArea.play();
            $.show(this._container);
        }
    }};
}());
vdb.skins = {};
vdb.skins.LiveButton = vdb.EventBus.extend(function() {
    var $ = vdb.utils.Common;
    var utl = vdb.Utils;
    var PlayerEvent = vdb.constants.PlayerEvent;
    var LIVE_BUTTON_ICON_ACTIVE = "live-button-active";
    var show = function() {
        $.show(this.liveButtonCell);
    };
    var hide = function() {
        $.hide(this.liveButtonCell);
    };
    var triggerLiveButtonState = function(setActive) {
        if (!this.liveIsOn) {
            utl.toggleClass(this.liveButtonIcon, LIVE_BUTTON_ICON_ACTIVE, setActive);
        }
    };
    var liveIsOn = function() {
        if ($.isHidden(this.liveButtonCell)) {
            show.call(this);
        }
        triggerLiveButtonState.call(this, true);
        this.liveIsOn = true;
    };
    var liveIsLost = function() {
        this.liveIsOn = false;
        triggerLiveButtonState.call(this, false);
    };
    var liveIsOff = function() {
        this.liveIsOn = false;
        hide.call(this);
    };
    var goLive = function() {
        this.controller.getLiveManager().resumeLive();
    };
    var createLiveButton = function() {
        this.liveButtonCell = utl.createElement("div", {"class":"live-button-cell", "style":"display: none;"}, this.container);
        this.liveButton = utl.createElement("div", {"class":"live-button"}, this.liveButtonCell);
        this.liveButtonIcon = utl.createElement("div", {"class":["live-button-icon", "skin-control"]}, this.liveButton, this.options.buttonIcon);
        this.liveButton.addEventListener("click", goLive.bind(this));
        this.liveButton.addEventListener("mouseover", triggerLiveButtonState.bind(this, true));
        this.liveButton.addEventListener("mouseout", triggerLiveButtonState.bind(this, false));
        this.player.addEventListener(PlayerEvent.LIVE_IS_ON, liveIsOn.bind(this));
        this.player.addEventListener(PlayerEvent.LIVE_IS_LOST, liveIsLost.bind(this));
        this.player.addEventListener(PlayerEvent.LIVE_IS_OFF, liveIsOff.bind(this));
    };
    return{init:function(controller, container, options) {
        this.container = container;
        this.controller = controller;
        this.player = controller.getPlayer();
        this.options = options || {};
    }, createLiveButton:createLiveButton};
}());
vdb.html5.live = {};
vdb.html5.live.LiveManager = vdb.core.Class.extend(function() {
    var LOGGER = vdb.log.getLogger("LiveManager");
    var PlayerEvent = vdb.constants.PlayerEvent;
    var EventContext = vdb.events.EventContext;
    var DEFAULT_FRAGMENT_LENGTH = 15;
    var LIVE_STATE = {LIVE_OFF:"liveoff", LIVE_ON:"liveon", NOT_LIVE:"notlive"};
    var isLiveVideo = function() {
        var video = this.controller.getCurrentVideo();
        return!!(video && video.metadata && video.metadata["live"]);
    };
    var liveIsOn = function() {
        this.liveState = LIVE_STATE.LIVE_ON;
        this.player.dispatchEvent(PlayerEvent.LIVE_IS_ON);
    };
    var liveIsLost = function() {
        this.liveState = LIVE_STATE.LIVE_OFF;
        this.player.dispatchEvent(PlayerEvent.LIVE_IS_LOST);
    };
    var liveIsOff = function() {
        this.liveState = LIVE_STATE.NOT_LIVE;
        this.player.dispatchEvent(PlayerEvent.LIVE_IS_OFF);
    };
    var resumeLive = function() {
        var position;
        var display;
        var hls;
        if (!isLiveVideo.call(this)) {
            return;
        }
        hls = vdb.html5.player.video.module.HLSModule.hls;
        display = vdb.html5.player.Display.getInstance();
        position = hls && hls["liveSyncPosition"] || display.getDuration() - DEFAULT_FRAGMENT_LENGTH;
        display.seek(position);
        if (!display.isPaused()) {
            liveIsOn.call(this);
        }
    };
    var onAdBlockerComplete = function() {
        this.adMeta = EventContext.bindOnce(this.player, PlayerEvent.AD_META, liveIsOff.bind(this));
    };
    var addEventListeners = function() {
        this._eventsContext = EventContext.group(EventContext.bind(this.player, PlayerEvent.VIDEO_PAUSE, liveIsLost.bind(this)), EventContext.bind(this.player, PlayerEvent.VIDEO_PLAY, checkIsLive.bind(this)), EventContext.bind(this.player, PlayerEvent.VIDEO_END, liveIsOff.bind(this)), EventContext.bind(this.player, PlayerEvent.AD_BLOCKER_COMPLETE, onAdBlockerComplete.bind(this)));
    };
    var clearEventsContext = function() {
        if (this._eventsContext) {
            this._eventsContext.unbind();
            this._eventsContext = null;
        }
    };
    var checkIsLive = function() {
        clearEventsContext.call(this);
        if (isLiveVideo.call(this)) {
            addEventListeners.call(this);
            if (this.liveState === LIVE_STATE.NOT_LIVE) {
                liveIsOn.call(this);
            }
        } else {
            liveIsOff.call(this);
        }
    };
    return{init:function(controller, context) {
        LOGGER.debug("init");
        this.controller = controller;
        this.player = controller.getPlayer();
        this.liveState = LIVE_STATE.NOT_LIVE;
        new vdb.tracking.HeartBeatTracker(controller, context);
        EventContext.group(EventContext.bind(this.player, PlayerEvent.VIDEO_START, checkIsLive.bind(this)), EventContext.bind(this.player, vdb.html5.player.BID_UPDATED, checkIsLive.bind(this)));
        checkIsLive.call(this);
    }, resumeLive:resumeLive};
}());
vdb.share = {};
vdb.share.SocialNetworkEnum = {SHARE:"share", REACTIONS:"reactions", LIKE:"like", GOOGLE:"google", FACEBOOK:"facebook", TWITTER:"twitter", LINKEDIN:"linkedin", WEIBO:"weibo", EMBED:"embed", EMAIL:"email", LINK:"link"};


document['bundledExtras'] = document['bundledExtras'] || {};
document['bundledExtras']['share'] = function () {
    (function() {
        var SharingExtra = vdb.extras.Html5Extra.extend(function() {
            return{initExtra:function(extraConfig, controller) {
                this._super(extraConfig);
                controller.getSkin().then(function(skin) {
                    vdb.sharingManager = new vdb.share.SharingManager(extraConfig["config"] || {}, controller, skin);
                });
            }};
        }());
        vdb["registerExtra"](SharingExtra);
    })();
    vdb.share.SharingUrlResolver = vdb.core.Class.extend(function() {
        return{init:function(controller) {
            this._controller = controller;
            this._urlResolver = vdb.utils.PlaceholdersResolver.create(["[VIDEO_ID]", function() {
                return encodeURIComponent(vdb.ctx.api.adapter.getCurrentVideoId());
            }], ["[AOL_VIDEO_ID]", function() {
                var currentVideo = vdb.ctx.api.adapter.getCurrentVideo();
                return encodeURIComponent(currentVideo ? currentVideo.aolId || currentVideo.id : vdb.ctx.api.adapter.getCurrentVideoId());
            }]);
        }, resolve:function(url) {
            switch(url) {
                case "demo":
                    return vdb.ctx.getDemoUrl();
                case "client":
                    return vdb.ctx.getReferrer();
                default:
                    return this._urlResolver.join(this._controller.getResolver()).resolve(url);
            }
        }};
    }());
    vdb.share.SocialNetwork = vdb.core.Class.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this.settings = settings;
            this._controller = controller;
            this.smallWindow = smallWindow;
            this._player = controller.getPlayer();
            this._urlResolver = new vdb.share.SharingUrlResolver(controller);
            this._basicTracker = vdb.ctx.ctx.createBasicTracker();
        }, getSharerUrl:function() {
            throw "Social Network sharer url is not specified";
        }, getShareTarget:function() {
            return "_blank";
        }, share:function(customSize) {
            this.track();
            if (customSize) {
                window.open(this.getSharerUrl(), this.getShareTarget(), "width=" + customSize["width"] + ",height=" + customSize["height"]);
            } else {
                if (this.smallWindow === "true") {
                    window.open(this.getSharerUrl(), this.getShareTarget(), "width=800,height=600");
                } else {
                    window.open(this.getSharerUrl(), this.getShareTarget());
                }
            }
            this._controller.pause();
        }, track:function() {
            var playerState = this._player.getPlayerState();
            var currentTime = playerState.currentTime || 0;
            var controller = this._controller;
            this._basicTracker.action(this.getType(), null, currentTime);
        }, getUrl:function() {
            return this._urlResolver.resolve(this.settings["url"]);
        }, getType:function() {
            return "";
        }};
    }());
    vdb.share.Email = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._controller = controller;
            this._super(settings, controller, smallWindow);
        }, getMessage:function() {
            return this._controller.getCurrentVideoTitle() || this.settings["message"] || "Interesting video!";
        }, getSubject:function(message) {
            return message ? message.split(" ").slice(0, 5).join(" ") : this.settings["message"] || "Interesting video!";
        }, getSharerUrl:function() {
            return "mailto:?subject={0}&body={1}".replace("{0}", encodeURIComponent(this.getSubject())).replace("{1}", encodeURIComponent(this.getMessage() + "\r\n\r\n" + this.getUrl()));
        }, getEmailUrl:function(address, message, time) {
            var text = message || this.getMessage(message);
            return time ? "mailto:?subject={0}&body={1}".replace(":?", ":" + encodeURIComponent(address) + "?").replace("{0}", encodeURIComponent(this.getSubject(message))).replace("{1}", encodeURIComponent(text + "\r\n\r\n" + this.getUrl(time))) : "mailto:?subject={0}&body={1}".replace(":?", ":" + encodeURIComponent(address) + "?").replace("{0}", encodeURIComponent(this.getSubject())).replace("{1}", encodeURIComponent(text + "\r\n\r\n" + this.getUrl(time)));
        }, sendEmail:function(address, message, time) {
            var getEmailUrl = this.getEmailUrl(address, message, time);
            this.track();
            this._controller.pause();
            window.open(getEmailUrl, vdb.Utils.desktopOs() ? "_blank" : "_top", this.smallWindow === "true" ? "width=800,height=600" : "");
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.EMAIL;
        }, getUrl:function(time) {
            var url = this.settings["url"] ? this._urlResolver.resolve(this.settings["url"]) : vdb.utils.WindowUtil.getTopMostLocation();
            if (url.indexOf("?") === -1 && time) {
                url += "?t=" + vdb.Utils.timeToSec(time);
            } else {
                if (time) {
                    url += "&t=" + vdb.Utils.timeToSec(time);
                }
            }
            return url;
        }};
    }());
    vdb.share.Embed = vdb.share.SocialNetwork.extend(function() {
        var LOGGER = vdb.log.getLogger("Embed");
        var utl = vdb.Utils;
        var PlayerEvent = vdb.constants.PlayerEvent;
        var lastVideoId;
        var setVideoEmbedData = function(videoId) {
            var src = vdb.ctx.getBaseUrls("ds") + "/embed/" + videoId + "/" + vdb.ctx.playerId + "/" + vdb.ctx.buyerCompanyId + ".js";
            this._embedTextbox.value = "Loading...";
            utl.addClass(this._embedCopyBtn, "embed-disabled-copy-btn");
            vdb.ajax.get(src, null, onLoadSuccess.bind(this), onLoadError.bind(this));
        };
        var onLoadSuccess = function(data) {
            LOGGER.debug("Load succeeded", data);
            this._embedTextbox.value = data.text.replace(/\\/g, "");
            utl.removeClass(this._embedCopyBtn, "embed-disabled-copy-btn");
        };
        var onAdBlockerComplete = function() {
            if (!this.eventContextGroup) {
                this.eventContextGroup = new vdb.events.EventContextBindGroup;
            }
            this.eventContextGroup.addContext(vdb.events.EventContext.bindOnce(this._player, PlayerEvent.AD_META, restoreDefaultClasses.bind(this)));
        };
        var restoreDefaultClasses = function() {
            if (this.eventContextGroup) {
                this.eventContextGroup.unbind();
            }
            this.eventContextGroup = null;
            utl.removeClass(this._upperIconsWrapper, "hide-upper-icons-wrapper");
            utl.removeClass(this._embedWrapper, "show-embed-wrapper");
        };
        var onLoadError = function(error) {
            LOGGER.warn("Load error!", error);
        };
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, setControls:function(upperIconsWrapper, embedWrapper, embedTextbox, embedCopyBtn) {
            this._upperIconsWrapper = upperIconsWrapper;
            this._embedWrapper = embedWrapper;
            this._embedTextbox = embedTextbox;
            this._embedCopyBtn = embedCopyBtn;
        }, attachEvents:function() {
            this._player.addEventListener(PlayerEvent.AD_BLOCKER_COMPLETE, onAdBlockerComplete.bind(this));
            this._player.addEventListener(PlayerEvent.AD_END, restoreDefaultClasses.bind(this));
            this._player.addEventListener(PlayerEvent.CONTEXT_ENDED, restoreDefaultClasses.bind(this));
        }, share:function() {
            this.track();
            var currentVideoId = this._controller.getCurrentVideoId();
            if (currentVideoId !== lastVideoId) {
                lastVideoId = currentVideoId;
                setVideoEmbedData.call(this, lastVideoId);
            }
            utl.addClass(this._upperIconsWrapper, "hide-upper-icons-wrapper");
            utl.addClass(this._embedWrapper, "show-embed-wrapper");
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.EMBED;
        }};
    }());
    vdb.share.Facebook = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, getSharerUrl:function() {
            return "http://www.facebook.com/sharer/sharer.php?u={}&display=popup".replace("{}", encodeURIComponent(this.getUrl()));
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.FACEBOOK;
        }};
    }());
    vdb.share.Google = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, getSharerUrl:function() {
            return "https://plus.google.com/share?url={0}".replace("{0}", encodeURIComponent(this.getUrl()));
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.GOOGLE;
        }};
    }());
    vdb.share.Link = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, getMessage:function() {
            return "";
        }, getSharerUrl:function() {
            return "";
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.LINK;
        }, getLink:function(videoId, bcid, time) {
            if (!vdb.utils.StringUtils.isEmpty(this.settings.url) && this.settings.url !== "client") {
                return this.settings.url;
            }
            return time ? vdb.ctx.getDirectVideoUrl() + "/" + videoId + "/?t=" + vdb.Utils.timeToSec(time) : vdb.ctx.getDirectVideoUrl() + "/" + videoId;
        }};
    }());
    vdb.share.Linkedin = {};
    vdb.share.Linedin = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, getTitle:function() {
            return this.settings["title"] || "Check out this great video I am watching over at ";
        }, getSummary:function() {
            return this.settings["summary"] || this._player.controller.getCurrentVideo().title || "Great video";
        }, getSharerUrl:function() {
            return "https://www.linkedin.com/shareArticle?url={1}&title={2}&summary={3}".replace("{1}", encodeURIComponent(this.getUrl())).replace("{2}", encodeURIComponent(this.getTitle() + " ")).replace("{3}", encodeURIComponent(this.getSummary() + " "));
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.LINKEDIN;
        }};
    }());
    vdb.share.Twitter = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, getMessage:function() {
            return this.settings["message"] || "Check out this great video I am watching over at";
        }, getSharerUrl:function() {
            return "http://delivery.vidible.tv/social/redirect?socialUrl={0}&shareUrl={1}".replace("{0}", encodeURIComponent("https://twitter.com/intent/tweet?source=webclient&text=" + encodeURIComponent(this.getMessage() + " "))).replace("{1}", encodeURIComponent(this.getUrl()));
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.TWITTER;
        }};
    }());
    vdb.share.Weibo = vdb.share.SocialNetwork.extend(function() {
        return{init:function(settings, controller, smallWindow) {
            this._super(settings, controller, smallWindow);
        }, getMessage:function() {
            return this.settings["message"] || "Check out this great video I am watching over at";
        }, getSharerUrl:function() {
            return "http://service.weibo.com/share/share.php?url={1}&appkey=&title={2}&pic=&ralateUid=&language=zh_cn".replace("{1}", encodeURIComponent(this.getUrl())).replace("{2}", encodeURIComponent(this.getMessage() + " "));
        }, getType:function() {
            return vdb.share.SocialNetworkEnum.WEIBO;
        }};
    }());
    vdb.share.SharingManager = vdb.core.Class.extend(function() {
        function isSocialNetworkClass(aClass) {
            var getType = aClass.prototype && aClass.prototype.getType;
            return typeof getType !== "undefined" && shareButtonsOrder.indexOf(getType()) > -1;
        }
        function getSupportedSocialNetworks() {
            var supportedSocialNetworks = {};
            for (var prop in vdb.share) {
                if (Object.prototype.hasOwnProperty.call(vdb.share, prop)) {
                    var SharingClass = vdb.share[prop];
                    if (isSocialNetworkClass(SharingClass)) {
                        var type = SharingClass.prototype.getType().toLowerCase();
                        supportedSocialNetworks[type] = SharingClass;
                    }
                }
            }
            return supportedSocialNetworks;
        }
        function getTypeByConfig(shareSettings, name) {
            var type = name.toLowerCase();
            if (type === SocialNetworkEnum.LIKE && (this.forceReactions || shareSettings[name]["Type"] === REACTIONS_SETTINGS_TYPE)) {
                return SocialNetworkEnum.REACTIONS;
            }
            return type;
        }
        var LOGGER = vdb.log.getLogger("share.SharingManager");
        var SocialNetworkEnum = vdb.share.SocialNetworkEnum;
        var REACTIONS_SETTINGS_TYPE = "5 Image Reactions";
        var shareButtonsOrder = [SocialNetworkEnum.REACTIONS, SocialNetworkEnum.LIKE, SocialNetworkEnum.FACEBOOK, SocialNetworkEnum.TWITTER, SocialNetworkEnum.LINKEDIN, SocialNetworkEnum.GOOGLE, SocialNetworkEnum.WEIBO, SocialNetworkEnum.EMAIL, SocialNetworkEnum.EMBED, SocialNetworkEnum.LINK];
        return{init:function(shareSettings, controller, skin) {
            var supportedNetworks = getSupportedSocialNetworks();
            this.forceReactions = vdb.utils.UrlUtils.getParameterByName("forcereactions") || vdb.ctx.getMacro(vdb.constants.PlayerMacros.FORCEREACTIONS) || false;
            if (this.forceReactions) {
                shareSettings["Like"] = {"enabled":"true", "Type":REACTIONS_SETTINGS_TYPE, "Location":"Over Content and Ad"};
            }
            LOGGER.debug("Supported social networks: ", supportedNetworks);
            var socialNetworks = [];
            for (var name in shareSettings) {
                if (Object.prototype.hasOwnProperty.call(shareSettings, name)) {
                    var settings = shareSettings[name];
                    var smallWindow = shareSettings["openInSmallWindow"];
                    var enabled = settings["enabled"] === "true";
                    var type = getTypeByConfig.call(this, shareSettings, name);
                    if (enabled) {
                        var url = settings["url"];
                        if (!url || url === "sharingUrl") {
                            settings["url"] = shareSettings["sharingUrl"] || "client";
                        }
                        var SocialNetworkConstructor = supportedNetworks[type];
                        if (SocialNetworkConstructor) {
                            socialNetworks[shareButtonsOrder.indexOf(type)] = new SocialNetworkConstructor(settings, controller, smallWindow);
                            LOGGER.debug("Found social network:", type);
                        } else {
                            LOGGER.warn("Ignore non-supported social network: " + name);
                        }
                    } else {
                        LOGGER.debug("Skip disabled social network:", type);
                    }
                }
            }
            socialNetworks = socialNetworks.filter(function(e) {
                return e;
            });
            LOGGER.info("set social networks", socialNetworks);
            skin.setSocialNetworks(socialNetworks, shareSettings["showOnAd"] === "true", shareSettings["Like"] && shareSettings["Like"]["Location"], shareSettings["sharePosition"]);
        }};
    }());


};

document['bundledExtras'] = document['bundledExtras'] || {};
document['bundledExtras']['comscorestreamsense'] = function () {
    vdb.extras.ComScoreStreamSense = vdb.extras.Html5Extra.extend(function() {
        var LOGGER = vdb.log.getLogger("ComScoreStreamSense");
        var configVals;
        var pageHostname = vdb.Utils.getHostFromUrl(vdb.utils.WindowUtil.getTopMostLocation());
        var adTypes = {PREROLL:"Preroll", MIDROLL:"Midroll", POSTROLL:"Postroll"};
        var adContentTypes = {PREROLL:"LinearOnDemandPreRoll", MIDROLL:"LinearOnDemandMidRoll", POSTROLL:"LinearOnDemandPostRoll", OTHER:"Other"};
        var videoContentTypes = {LIVE:"Live", LONGFORM:"LongFormOnDemand", SHORTFORM:"ShortFormOnDemand"};
        var AOL_ACCOUNT_ID = "1000009";
        var FIVEMIN_ACCOUNT_ID = "6473742";
        var UNKNOWN_CATEGORY = "Unknown_Category";
        var UNKNOWN_CATEGORY_ID = "Unknown_Category_ID";
        var UNKNOWN_AOL = "5Min_unknown_AOL";
        var CS_NULL = "*null";
        var PlayerMacros = vdb.constants.PlayerMacros;
        var fillVideoData = function() {
            this.videoData = this.playerAdapter.getCurrentVideo();
            if (!this.videoData) {
                return;
            }
            var duration = this.videoData.metadata["duration"];
            this.videoDuration = isNaN(duration) ? 0 : duration / 1E3;
            this.isLongForm = this.videoDuration / 60 > 10;
            this.c3 = (this.videoData.categoryIds || "").split(",")[0] || this.c3;
            this.c6 = this.videoData.catName || this.c6;
        };
        var onContextIntent = function() {
            this.streamSense = new ns_["StreamingTag"]({"customerC2":this.clientId});
            var isAolAcct = isAolAccount.call(this);
            this.videoDuration = 0;
            this.isLongForm = false;
            this.c3 = UNKNOWN_CATEGORY_ID;
            this.c4 = isAolAcct ? vdb.Utils.getS265Channel() || UNKNOWN_AOL : pageHostname;
            this.c6 = isAolAcct ? UNKNOWN_CATEGORY : CS_NULL;
            fillVideoData.call(this);
        };
        var isAolAccount = function() {
            return(this.player.config["bcInfo"] || {})["oo"];
        };
        var isAolMode = function() {
            return this.player.playerWidget["isAol"];
        };
        var getValueWithSpaces = function(value) {
            if (value) {
                value = value.split("+").join(" ");
            }
            return value;
        };
        var setMetadata = function(metadata) {
            var aolMode = isAolMode.call(this);
            metadata["ns_st_ci"] = (this.videoData.aolId || this.videoData.id) + "";
            if (aolMode) {
                metadata["c3"] = configVals["c3"] || this.c3;
                metadata["c4"] = this.c4;
                metadata["c6"] = this.c6;
            } else {
                var notAolConfigParams = ["c1", "c3", "c4", "c6", "c7", "c8", "c9", "ns_st_ty", "bb_pub_d"];
                metadata["c3"] = CS_NULL;
                metadata["c4"] = CS_NULL;
                metadata["c6"] = CS_NULL;
                for (var p in notAolConfigParams) {
                    var key = notAolConfigParams[p];
                    if (configVals[key]) {
                        metadata[key] = configVals[key];
                    }
                }
            }
            var csVideoInfo = this.videoData.cs || {};
            var csAccountInfo = getCsAccountInfo();
            var stackedAccountId = getStackedAccountId(csVideoInfo, csAccountInfo);
            if (stackedAccountId) {
                metadata["ca2"] = stackedAccountId;
                metadata["ca_ns_st_ty"] = configVals["ca_ns_st_ty"];
                metadata["ca_bb_pub_d"] = configVals["ca_bb_pub_d"];
                var optionalStackedParams = ["ca1", "ca7", "ca8", "ca9"];
                for (var i = 0;i < optionalStackedParams.length;i++) {
                    if (configVals[optionalStackedParams[i]]) {
                        metadata[optionalStackedParams[i]] = configVals[optionalStackedParams[i]];
                    }
                }
                metadata["ca3"] = getValueWithSpaces(getVideoOrConfigParam("ca3", csVideoInfo)) || this.c3;
                metadata["ca4"] = stackedAccountId == vdb.ctx.getMacro(PlayerMacros.CSACCID) && csAccountInfo.ca4 ? csAccountInfo.ca4 : getValueWithSpaces(getVideoOrConfigParam("ca4", csVideoInfo)) || pageHostname;
                metadata["ca6"] = getValueWithSpaces(getVideoOrConfigParam("ca6", csVideoInfo)) || this.c6;
            }
            return metadata;
        };
        var getVideoOrConfigParam = function(param, videoData) {
            var res;
            if (videoData) {
                res = videoData[param];
            }
            return res || configVals[param];
        };
        var getStackedAccountId = function(csVideoInfo, csAccountInfo) {
            var videoStackedAccountId = csVideoInfo["accountId"] || csVideoInfo["ca2"];
            var videoStackedPriority = !!csVideoInfo["p"] || !!csVideoInfo["priority"];
            var csVideoPriority = videoStackedAccountId != undefined && videoStackedPriority;
            var accountId = csVideoPriority ? videoStackedAccountId : csAccountInfo.accountId || videoStackedAccountId;
            return accountId || null;
        };
        var getCsAccountInfo = function() {
            var csaccid = vdb.ctx.getMacro(PlayerMacros.CSACCID) || null;
            var csca2 = configVals["csca2"] || configVals["stackedClientId"];
            var useCsca2 = csca2 && (!csaccid || configVals["csca2p"] == "true");
            return{accountId:useCsca2 ? csca2 : csaccid, isOverride:useCsca2, ca4:vdb.ctx.getMacro(PlayerMacros.CSC4) || null};
        };
        var setAdClip = function(e) {
            if (!this.videoData) {
                return;
            }
            var adType = e.data.adType;
            if (!vdb.Utils.contains(adTypes, adType)) {
                return;
            }
            var duration = !isNaN(e.data.duration) ? e.data.duration : 0;
            var metadata = setMetadata.call(this, {"ns_st_cl":duration * 1E3});
            this.streamSense["playVideoAdvertisement"](metadata, ns_["StreamingTag"]["AdType"][getAdType(adType)]);
            LOGGER.debug("playVideoAdvertisement", metadata);
        };
        var stopClip = function() {
            if (!this.videoData) {
                return;
            }
            this.streamSense["stop"]();
        };
        var getAdType = function(adType) {
            var res;
            switch(adType) {
                case adTypes.PREROLL:
                    res = adContentTypes.PREROLL;
                    break;
                case adTypes.MIDROLL:
                    res = adContentTypes.MIDROLL;
                    break;
                case adTypes.POSTROLL:
                    res = adContentTypes.POSTROLL;
                    break;
                default:
                    res = adContentTypes.OTHER;
            }
            return res;
        };
        var setContentClip = function() {
            var metadata = setMetadata.call(this, {"ns_st_cl":this.videoData.metadata["duration"], "ns_st_st":this.videoData.showTitle || CS_NULL, "ns_st_pu":this.videoData.partnerName || "Unknown_AOL_Partner", "ns_st_pr":this.videoData.studioName || "", "ns_st_ep":this.videoData.title || "Unknown_Video", "ns_st_sn":this.videoData.seasonNumber || CS_NULL, "ns_st_en":this.videoData.episodeNumber || CS_NULL, "ns_st_ge":CS_NULL, "ns_st_ti":CS_NULL, "ns_st_ia":0, "ns_st_ce":1, "ns_st_ddt":CS_NULL, "ns_st_tdt":CS_NULL});
            var videoType = this.videoData.metadata["live"] ? videoContentTypes.LIVE : this.isLongForm ? videoContentTypes.LONGFORM : videoContentTypes.SHORTFORM;
            this.streamSense["playVideoContentPart"](metadata, ns_["StreamingTag"]["ContentType"][videoType]);
            LOGGER.debug("playVideoContentPart", metadata);
        };
        var getAccountCode = function() {
            return isAolAccount.call(this) ? AOL_ACCOUNT_ID : FIVEMIN_ACCOUNT_ID;
        };
        var getClientId = function() {
            var value;
            if (isAolMode.call(this)) {
                value = getAccountCode.call(this);
            } else {
                value = configVals["clientId"];
            }
            return value;
        };
        var isLoaded = function() {
            return!!ns_;
        };
        var bindEvents = function() {
            LOGGER.debug("Load complete");
            this.clientId = getClientId.call(this);
            this.playerAdapter = vdb.ctx.api.adapter;
            if (this.clientId) {
                this.player.addEventListener(vdb.constants.PlayerEvent.AD_STARTING, setAdClip.bind(this));
                this.playerAdapter.addEventListener(vdb.constants.PlayerEvent.CONTEXT_INTENT, onContextIntent.bind(this));
                this.playerAdapter.addEventListener(vdb.constants.PlayerEvent.VIDEO_SELECTED, fillVideoData.bind(this));
                this.playerAdapter.addEventListener(vdb.constants.PlayerEvent.AD_END, stopClip.bind(this));
                this.playerAdapter.addEventListener(vdb.constants.PlayerEvent.VIDEO_PLAY, setContentClip.bind(this));
                this.playerAdapter.addEventListener(vdb.constants.PlayerEvent.VIDEO_PAUSE, stopClip.bind(this));
                this.playerAdapter.addEventListener(vdb.constants.PlayerEvent.VIDEO_END, stopClip.bind(this));
            }
            this.unblockExtra();
        };
        var loadAndBind = function() {
            if (isLoaded()) {
                bindEvents.call(this);
            } else {
                vdb.dom.loadScript(vdb.ctx.getCdnUrl("js/lib/ComScore.StreamSense.js")).then(bindEvents.bind(this));
            }
        };
        var setAdapter = function(adapter) {
            this.adapter = adapter;
            loadAndBind.call(this);
        };
        return{initExtra:function(config) {
            this.player = vdb.ctx["getPlayer"]();
            if (this.player.playerWidget["adOnly"]) {
                this.unblockExtra();
                return;
            }
            LOGGER.debug("Init extra");
            configVals = config["config"] || {};
            if (vdb.ctx.api.adapter) {
                setAdapter.call(this, vdb.ctx.api.adapter);
            } else {
                vdb.ctx.addEventListener(vdb.adapter.CREATED, setAdapter.bind(this));
            }
        }};
    }());
    vdb["registerExtra"](vdb.extras.ComScoreStreamSense);


};

document['bundledExtras'] = document['bundledExtras'] || {};
document['bundledExtras']['akamai_sola'] = function () {
    vdb.extras.AkamaiSola = vdb.extras.Html5Extra.extend(function() {
        function onPlayerAdapterCreated(adapter) {
            this._playerAdapter = adapter;
        }
        var LOGGER = vdb.log.getLogger("AkamaiSola");
        var PLAYER_ID = "Aol Html5 Player O2";
        var PREROLL = "Preroll";
        var SCRIPT_SRC = vdb.ctx.getCdnUrl("js/lib/akamaihtml5-min.js");
        var PlayerEvents = vdb.constants.PlayerEvent;
        var initExtra = function(config, controller) {
            LOGGER.debug("Init extra");
            this._player = controller.getPlayer();
            this._api = vdb.ctx.api;
            var isLive = !!(new vdb.model.Bid(this._api.bid)).getCurrentVideo().metadata["live"];
            if (!isLive) {
                this.unblockExtra();
                return;
            }
            isLive = !!(new vdb.model.Bid(this._api.bid)).getCurrentVideo().metadata["live"];
            if (!isLive) {
                this.unblockExtra();
                return;
            }
            if (this._api.adapter) {
                onPlayerAdapterCreated.call(this, this._api.adapter);
            } else {
                vdb.ctx.addEventListener(vdb.ctx.ctx.adapter.CREATED, onPlayerAdapterCreated.bind(this));
            }
            _initParams.call(this);
            _attachEvents.call(this);
            this._videoProgressCalculator = new vdb.reporter.VideoProgressCalculator;
            window["AKAMAI_MEDIA_ANALYTICS_CONFIG_FILE_PATH"] = vdb.ctx.urls.isSecure() ? isLive ? "https://ma180-r.analytics.edgekey.net/config/beacon-7771.xml" : "https://ma180-r.analytics.edgekey.net/config/beacon-7767.xml" : isLive ? "http://ma180-r.analytics.edgesuite.net/config/beacon-6527.xml" : "http://ma180-r.analytics.edgesuite.net/config/beacon-6327.xml";
            vdb.dom.loadScript(SCRIPT_SRC).then(_onInjected.bind(this));
        };
        var _onInjected = function() {
            this.unblockExtra();
        };
        var _initParams = function() {
            var loggerParams = vdb.ctx.getLoggerParams();
            var bcInfo = this._api.bcInfo;
            this._imid = loggerParams["imid"];
            this._vvuid = loggerParams["vvuid"];
            this._device = vdb.Utils.mobileOs() ? vdb.Utils.browser.platform.name : "pc";
            this._contextVal = bcInfo["sid"] && bcInfo["skey"] ? bcInfo["sid"] + "-" + bcInfo["skey"] : "";
        };
        var _isPreroll = function(type) {
            return type === PREROLL;
        };
        var _onPlayerReady = function(event) {
            this._videoElement = vdb.html5.player.Display.getInstance().getElement();
        };
        var _onBeforePrerollStart = function(event) {
            if (!_isPreroll(event["data"]["type"])) {
                return;
            }
            this._currentAdQuartile = 0;
            this._videoElement.setAttribute("data-isad", "true");
        };
        var _onPrerollStarted = function(event) {
            if (!_isPreroll(event["data"]["adType"])) {
                return;
            }
            var adObj = {"adTitle":event.data.title, "adDuration":event.data.duration};
            window["akamaiHandleAdLoaded"](adObj);
            this._videoProgressCalculator.setVideoDuration(event.data.duration);
            window["akamaiHandleAdStarted"]();
        };
        var _onAdTimeUpdate = function(event) {
            var currentTime = event.data.currentTime;
            if (currentTime > 0) {
                var quartile = this._videoProgressCalculator.getQuartile(currentTime);
                if (this._currentAdQuartile < quartile && quartile <= 4) {
                    this._currentAdQuartile++;
                    _onQuartile(quartile);
                    _onAdTimeUpdate.call(this, event);
                }
            }
        };
        var _onQuartile = function(quartile) {
            switch(quartile) {
                case 1:
                    window["akamaiHandleAdFirstQuartile"]();
                    break;
                case 2:
                    window["akamaiHandleAdMidPoint"]();
                    break;
                case 3:
                    window["akamaiHandleAdThirdQuartile"]();
                    break;
                case 4:
                    window["akamaiHandleAdCompleted"]();
                    break;
            }
        };
        var _onBeforeContentStart = function(event) {
            _onPlayerReady.call(this);
            this._videoElement.setAttribute("data-isad", "false");
            var video = event.data;
            var isLive = !!this._playerAdapter.getCurrentVideo().metadata["live"];
            var videoTitle = video.title;
            var videoData = {"title":videoTitle, "category":video.category || "", "show":video.studio || "", "contentLength":isLive ? "" : video.duration, "device":this._device, "deliveryType":isLive ? "L" : "O", "playerId":PLAYER_ID, "imid":this._imid, "vvuid":this._vvuid, "context":this._contextVal, "AAcontext":this._contextVal, "eventName":videoTitle};
            _setVideoData(videoData);
        };
        var _setVideoData = function(data) {
            for (var name in data) {
                window["setAkamaiMediaAnalyticsData"](name, data[name]);
            }
        };
        var _attachEvents = function() {
            this._player.addEventListener(PlayerEvents.AD_META, _onBeforePrerollStart.bind(this));
            this._player.addEventListener(PlayerEvents.PLAYER_READY, _onPlayerReady.bind(this));
            this._player.addEventListener(PlayerEvents.AD_START, _onPrerollStarted.bind(this));
            this._player.addEventListener(PlayerEvents.AD_TIMEUPDATE, _onAdTimeUpdate.bind(this));
            this._player.addEventListener(PlayerEvents.VIDEO_META, _onBeforeContentStart.bind(this));
        };
        return{initExtra:initExtra};
    }());
    vdb["registerExtra"](vdb.extras.AkamaiSola);


};
// Copyright (c) 2016 comScore, Inc.
!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.ns_=b(a.ns_)}):"object"==typeof module&&module.exports?module.exports=b():a.ns_=b(a.ns_)}(this,function(a){a=a||{},a.ns_=a;var b={uid:function(){var a=1;return function(){return+new Date+"_"+a++}}(),filter:function(a,b){var c={};for(var d in b)b.hasOwnProperty(d)&&a(b[d])&&(c[d]=b[d]);return c},extend:function(a){var b,c=arguments.length;a=a||{};for(var d=1;c>d;d++)if(b=arguments[d])for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);return a},getString:function(a,b){var c=String(a);return null==a?b||"na":c},getLong:function(a,b){var c=Number(a);return null==a||isNaN(c)?b||0:c},getInteger:function(a,b){var c=Number(parseInt(a));return null==a||isNaN(c)?b||0:c},getBoolean:function(a,b){var c="true"==String(a).toLowerCase();return null==a?b||!1:c},parseBoolean:function(a,b){return b=b||!1,a?"0"==a?!1:void 0:b},isNotEmpty:function(a){return!this.isEmpty(a)},isEmpty:function(a){return void 0===a||null===a||""===a||a instanceof Array&&0===a.length},indexOf:function(a,b){var c=-1;return this.forEach(b,function(b,d){b==a&&(c=d)}),c},forEach:function(a,b,c){try{if("function"==typeof b)if(c="undefined"!=typeof c?c:null,"number"!=typeof a.length||"undefined"==typeof a[0]){var d="undefined"!=typeof a.__proto__;for(var e in a)a.hasOwnProperty(e)&&(!d||d&&"undefined"==typeof a.__proto__[e])&&"function"!=typeof a[e]&&b.call(c,a[e],e)}else for(var f=0,g=a.length;g>f;f++)b.call(c,a[f],f)}catch(h){}},regionMatches:function(a,b,c,d,e){if(0>b||0>d||b+e>a.length||d+e>c.length)return!1;for(;--e>=0;){var f=a.charAt(b++),g=c.charAt(d++);if(f!=g)return!1}return!0},size:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},log:function(a,b){if("undefined"!=typeof b&&b&&"undefined"!=typeof console&&console){var c=new Date,d=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();console.log(d,a)}},isTrue:function(a){return"undefined"==typeof a?!1:"string"==typeof a?(a=a.toLowerCase(),"true"===a||"1"===a||"on"===a):!!a},toString:function(a){if("undefined"==typeof a)return"undefined";if("string"==typeof a)return a;if("[object Array]"===Object.prototype.toString.call(a))return a.join(",");if(this.size(a)>0){var b="";for(var c in a)a.hasOwnProperty(c)&&(b+=c+":"+a[c]+";");return b}return a.toString()},exists:function(a){return"undefined"!=typeof a&&null!=a},firstGreaterThan0:function(){for(var a=0,b=arguments.length;b>a;a++){var c=arguments[a];if(c>0)return c}return 0},cloneObject:function(a){if(null==a||"object"!=typeof a)return a;var b=function(){function a(){}function b(b){return"object"==typeof b?(a.prototype=b,new a):b}function c(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])}function d(){this.copiedObjects=[];var a=this;this.recursiveDeepCopy=function(b){return a.deepCopy(b)},this.depth=0}function e(a,b){var c=new d;return b&&(c.maxDepth=b),c.deepCopy(a)}function f(a){return"undefined"!=typeof window&&window&&window.Node?a instanceof Node:"undefined"!=typeof document&&a===document?!0:"number"==typeof a.nodeType&&a.attributes&&a.childNodes&&a.cloneNode}var g=[];return c.prototype={constructor:c,canCopy:function(){return!1},create:function(a){},populate:function(a,b,c){}},d.prototype={constructor:d,maxDepth:256,cacheResult:function(a,b){this.copiedObjects.push([a,b])},getCachedResult:function(a){for(var b=this.copiedObjects,c=b.length,d=0;c>d;d++)if(b[d][0]===a)return b[d][1]},deepCopy:function(a){if(null===a)return null;if("object"!=typeof a)return a;var b=this.getCachedResult(a);if(b)return b;for(var c=0;c<g.length;c++){var d=g[c];if(d.canCopy(a))return this.applyDeepCopier(d,a)}throw new Error("Unable to clone the following object "+a)},applyDeepCopier:function(a,b){var c=a.create(b);if(this.cacheResult(b,c),this.depth++,this.depth>this.maxDepth)throw new Error("Maximum recursion depth exceeded.");return a.populate(this.recursiveDeepCopy,b,c),this.depth--,c}},e.DeepCopier=c,e.deepCopiers=g,e.register=function(a){a instanceof c||(a=new c(a)),g.unshift(a)},e.register({canCopy:function(){return!0},create:function(a){return a instanceof a.constructor?b(a.constructor.prototype):{}},populate:function(a,b,c){for(var d in b)b.hasOwnProperty(d)&&(c[d]=a(b[d]));return c}}),e.register({canCopy:function(a){return a instanceof Array},create:function(a){return new a.constructor},populate:function(a,b,c){for(var d=0;d<b.length;d++)c.push(a(b[d]));return c}}),e.register({canCopy:function(a){return a instanceof Date},create:function(a){return new Date(a)}}),e.register({canCopy:function(a){return f(a)},create:function(a){return"undefined"!=typeof document&&a===document?document:a.cloneNode(!1)},populate:function(a,b,c){if("undefined"!=typeof document&&b===document)return document;if(b.childNodes&&b.childNodes.length)for(var d=0;d<b.childNodes.length;d++){var e=a(b.childNodes[d]);c.appendChild(e)}}}),{deepCopy:e}}();return b.deepCopy(a)},safeGet:function(a,b){return b=this.exists(b)?b:"",this.exists(a)?a:b},getBrowserName:function(){if(!navigator)return"";var a,b,c=navigator.userAgent||"",d=navigator.appName||"";return-1!=(b=c.indexOf("Opera"))||-1!=(b=c.indexOf("OPR/"))?d="Opera":-1!=(b=c.indexOf("Android"))?d="Android":-1!=(b=c.indexOf("Chrome"))?d="Chrome":-1!=(b=c.indexOf("Safari"))?d="Safari":-1!=(b=c.indexOf("Firefox"))?d="Firefox":-1!=(b=c.indexOf("IEMobile"))?d="Internet Explorer Mobile":"Microsoft Internet Explorer"==d||"Netscape"==d?d="Internet Explorer":(a=c.lastIndexOf(" ")+1)<(b=c.lastIndexOf("/"))?(d=c.substring(a,b),d.toLowerCase()==d.toUpperCase()&&(d=navigator.appName)):d="unknown",d},getBrowserFullVersion:function(){if(!navigator)return"";var a,b,c,d,e=navigator.userAgent||"",f=navigator.appName||"",g=navigator.appVersion?""+parseFloat(navigator.appVersion):"";return-1!=(b=e.indexOf("Opera"))?(g=e.substring(b+6),-1!=(b=e.indexOf("Version"))&&(g=e.substring(b+8))):-1!=(b=e.indexOf("OPR/"))?g=e.substring(b+4):-1!=(b=e.indexOf("Android"))?g=e.substring(b+11):-1!=(b=e.indexOf("Chrome"))?g=e.substring(b+7):-1!=(b=e.indexOf("Safari"))?(g=e.substring(b+7),-1!=(b=e.indexOf("Version"))&&(g=e.substring(b+8))):-1!=(b=e.indexOf("Firefox"))?g=e.substring(b+8):"Microsoft Internet Explorer"==f?(d=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})"),null!=d.exec(e)&&(g=parseFloat(RegExp.$1))):"Netscape"==f?(d=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})"),null!=d.exec(e)&&(g=parseFloat(RegExp.$1))):g=e.lastIndexOf(" ")+1<(b=e.lastIndexOf("/"))?e.substring(b+1):"unknown",g=g.toString(),-1!=(c=g.indexOf(";"))&&(g=g.substring(0,c)),-1!=(c=g.indexOf(" "))&&(g=g.substring(0,c)),-1!=(c=g.indexOf(")"))&&(g=g.substring(0,c)),a=parseInt(""+g,10),isNaN(a)&&(g=""+parseFloat(navigator.appVersion)),g},browserAcceptsLargeURLs:function(){return"undefined"!=typeof window?(null!==window.ActiveXObject,!0):!0},getNamespace:function(){return a.ns_||a}};return a.StreamSense=a.StreamSense||function(){var c=function(){var a="cs_";return function(){var c="undefined"!=typeof localStorage?localStorage:null;b.extend(this,{get:function(b){return c&&c.getItem(a+b)},set:function(b,d){c&&c.setItem(a+b,d)},has:function(b){return c&&c.getItem(a+b)},remove:function(b){c&&c.removeItem(a+b)},clear:function(){for(var b=0;c&&b<c.length;++b){var d=c.key(b);d.substr(0,a.length)===a&&c.removeItem(d)}}})}}(),d=function(a,b){if("undefined"!=typeof Image){var c=new Image;c.onload=function(){b&&b(200),c=null},c.onerror=function(){b&&b(),c=null},c.src=a}},e=function(a,b,c){c&&"undefined"!=typeof setTimeout&&setTimeout(c,0)},f=function(){return{dir:function(){return null},append:function(a,b,c){},write:function(a,b,c){},deleteFile:function(){return!1},read:function(){return null}}}(),g=function(){return{PLATFORM:"generic",httpGet:d,httpPost:e,Storage:c,IO:f,getCrossPublisherId:function(){return null},getAppName:function(){return h.UNKNOWN_VALUE},getAppVersion:function(){return h.UNKNOWN_VALUE},getVisitorId:function(){return this.getDeviceName()+ +new Date+~~(1e3*Math.random())},getVisitorIdSuffix:function(){return"72"},getDeviceName:function(){return h.UNKNOWN_VALUE},getPlatformVersion:function(){return h.UNKNOWN_VALUE},getPlatformName:function(){return"js"},getRuntimeName:function(){return h.UNKNOWN_VALUE},getRuntimeVersion:function(){return h.UNKNOWN_VALUE},getResolution:function(){return h.UNKNOWN_VALUE},getLanguage:function(){return h.UNKNOWN_VALUE},getPackageName:function(){return null},isConnectionAvailable:function(){return!0},isCompatible:function(){return!0},autoSelect:function(){},setPlatformAPI:function(){},isCrossPublisherIdChanged:function(){return!1},setTimeout:function(a,b){return setTimeout(a,b)},clearTimeout:function(a){return clearTimeout(a)},getDeviceArchitecture:function(){return h.UNKNOWN_VALUE},getConnectionType:function(){return h.UNKNOWN_VALUE},getDeviceJailBrokenFlag:function(){return h.UNKNOWN_VALUE},isConnSecure:function(){return"s"===document.location.href.charAt(4)},processMeasurementLabels:function(){}}}(),h={UNKNOWN_VALUE:"unknown",UNKNOWN_RESOLUTION:"0x0"};b.jsonObjectToStringDictionary=function(a){var b={};for(var c in a){var d=a[c];null===d||void 0===d?b[c]=d:b[c]=a[c]+""}return b},b.getKeys=function(a,b){var c,d=[];for(c in a)b&&!b.test(c)||!a.hasOwnProperty(c)||(d[d.length]=c);return d},b.fixEventTime=function(a){if(a.ns_ts)return parseInt(a.ns_ts);var b=+new Date;return a.ns_ts=String(b),b},b.isBrowser=function(){return"undefined"!=typeof window&&"undefined"!=typeof document},b.addNewPlaybackInterval=function(a,c,d,e){var f={};if(!(d>=c))return b.cloneObject(a);if(f.start=c,f.end=d,0==a.length)return a.push(f),b.cloneObject(a);var g;for(g=0;g<a.length;g++)if(f.start>=a[g].start&&f.end<=a[g].end)return b.cloneObject(a);var h,i=!1;for(h=0;h<a.length;h++)if(h+1===a.length&&f.start>=a[h].start||f.start>=a[h].start&&f.start<a[h+1].start){a.splice(h+1,0,f),i=!0;break}i||a.splice(0,0,f);var j=[a[0]];for(g=1;g<a.length;g++)j[j.length-1].end+e<a[g].start?j.push(a[g]):j[j.length-1].end<a[g].end&&(j[j.length-1].end=a[g].end);return b.cloneObject(j)};var i=function(){var a=["play","pause","pause-on-buffering","end","buffer","buffer-stop","keep-alive","hb","custom","load","start","skstart","adskip","cta","error","trans","drmfa","drmap","drmde","bitrt","playrt","volume","window","audio","video","subs","cdn"];return{PLAY:0,PAUSE:1,PAUSE_ON_BUFFERING:2,END:3,BUFFER:4,BUFFER_STOP:5,KEEPALIVE:6,HEARTBEAT:7,CUSTOM:8,LOAD:9,START:10,SEEK_START:11,AD_SKIP:12,CTA:13,ERROR:14,TRANSFER:15,DRM_FAILED:16,DRM_APPROVED:17,DRM_DENIED:18,BIT_RATE:19,PLAYBACK_RATE:20,VOLUME:21,WINDOW_STATE:22,AUDIO:23,VIDEO:24,SUBS:25,CDN:26,toString:function(b){return a[b]}}}(),j=function(){return{IDLE:0,PLAYBACK_NOT_STARTED:1,PLAYING:2,PAUSED:3,BUFFERING_BEFORE_PLAYBACK:4,BUFFERING_DURING_PLAYBACK:5,BUFFERING_DURING_SEEKING:6,BUFFERING_DURING_PAUSE:7,SEEKING_BEFORE_PLAYBACK:8,SEEKING_DURING_PLAYBACK:9,SEEKING_DURING_BUFFERING:10,SEEKING_DURING_PAUSE:11,PAUSED_DURING_BUFFERING:12}}(),k=function(){var a=["c","s","r"];return{SINGLE_CLIP:0,SEGMENTED:1,REDUCED:2,toString:function(b){return a[b]}}}(),l={STREAMSENSE_VERSION:"5.1.1.160316",MODEL_VERSION:"5.1",DEFAULT_PLAYERNAME:"js_api",DEFAULT_HEARTBEAT_INTERVAL:[{playingtime:6e4,interval:1e4},{playingtime:null,interval:6e4}],DEFAULT_KEEP_ALIVE_INTERVAL:12e5,DEFAULT_PAUSED_ON_BUFFERING_INTERVAL:500,C1_VALUE:"19",C10_VALUE:"js",NS_AP_C12M_VALUE:"1",NS_NC_VALUE:"1",PAGE_NAME_LABEL:"name",RESTRICTED_URL_LENGTH_LIMIT:2048,URL_LENGTH_LIMIT:4096,THROTTLING_DELAY:500,INTERVAL_MERGE_TOLERANCE:500,STANDARD_METADATA_LABELS:["ns_st_ci","ns_st_pr","ns_st_sn","ns_st_en","ns_st_ep","ns_st_ty","ns_st_ct","ns_st_li","ns_st_ad","ns_st_bn","ns_st_tb","ns_st_an","ns_st_ta","ns_st_pu","c3","c4","c6"],LABELS_ORDER:["c1","c2","ca2","cb2","cc2","cd2","ns_site","ca_ns_site","cb_ns_site","cc_ns_site","cd_ns_site","ns_vsite","ca_ns_vsite","cb_ns_vsite","cc_ns_vsite","cd_ns_vsite","ns_alias","ca_ns_alias","cb_ns_alias","cc_ns_alias","cd_ns_alias","ns_ap_an","ca_ns_ap_an","cb_ns_ap_an","cc_ns_ap_an","cd_ns_ap_an","ns_ap_pn","ns_ap_pv","c12","ca12","cb12","cc12","cd12","ns_ak","ns_ap_hw","name","ns_ap_ni","ns_ap_ec","ns_ap_ev","ns_ap_device","ns_ap_id","ns_ap_csf","ns_ap_bi","ns_ap_pfm","ns_ap_pfv","ns_ap_ver","ca_ns_ap_ver","cb_ns_ap_ver","cc_ns_ap_ver","cd_ns_ap_ver","ns_ap_sv","ns_ap_cv","ns_type","ca_ns_type","cb_ns_type","cc_ns_type","cd_ns_type","ns_radio","ns_nc","cs_partner","cs_xcid","ns_ap_ui","ca_ns_ap_ui","cb_ns_ap_ui","cc_ns_ap_ui","cd_ns_ap_ui","ns_ap_gs","ns_st_sv","ns_st_pv","ns_st_smv","ns_st_it","ns_st_id","ns_st_ec","ns_st_sp","ns_st_sc","ns_st_sq","ns_st_ppc","ns_st_apc","ns_st_spc","ns_st_cn","ns_st_ev","ns_st_po","ns_st_cl","ns_st_el","ns_st_sl","ns_st_pb","ns_st_hc","ns_st_mp","ca_ns_st_mp","cb_ns_st_mp","cc_ns_st_mp","cd_ns_st_mp","ns_st_mv","ca_ns_st_mv","cb_ns_st_mv","cc_ns_st_mv","cd_ns_st_mv","ns_st_pn","ns_st_tp","ns_st_ad","ns_st_li","ns_st_ci","ns_st_si","ns_st_pt","ns_st_dpt","ns_st_ipt","ns_st_et","ns_st_det","ns_st_upc","ns_st_dupc","ns_st_iupc","ns_st_upa","ns_st_dupa","ns_st_iupa","ns_st_lpc","ns_st_dlpc","ns_st_lpa","ns_st_dlpa","ns_st_pa","ns_ap_jb","ns_ap_et","ns_ap_res","ns_ap_sd","ns_ap_po","ns_ap_ot","ns_ap_c12m","cs_c12u","ca_cs_c12u","cb_cs_c12u","cc_cs_c12u","cd_cs_c12u","ns_ap_install","ns_ap_updated","ns_ap_lastrun","ns_ap_cs","ns_ap_runs","ns_ap_usage","ns_ap_fg","ns_ap_ft","ns_ap_dft","ns_ap_bt","ns_ap_dbt","ns_ap_dit","ns_ap_as","ns_ap_das","ns_ap_it","ns_ap_uc","ns_ap_aus","ns_ap_daus","ns_ap_us","ns_ap_dus","ns_ap_ut","ns_ap_oc","ns_ap_uxc","ns_ap_uxs","ns_ap_lang","ns_ap_ar","ns_ap_miss","ns_ts","ns_st_ca","ns_st_cp","ns_st_er","ca_ns_st_er","cb_ns_st_er","cc_ns_st_er","cd_ns_st_er","ns_st_pe","ns_st_ui","ca_ns_st_ui","cb_ns_st_ui","cc_ns_st_ui","cd_ns_st_ui","ns_st_bc","ns_st_dbc","ns_st_bt","ns_st_dbt","ns_st_bp","ns_st_lt","ns_st_skc","ns_st_dskc","ns_st_ska","ns_st_dska","ns_st_skd","ns_st_skt","ns_st_dskt","ns_st_pc","ns_st_dpc","ns_st_pp","ns_st_br","ns_st_pbr","ns_st_rt","ns_st_prt","ns_st_ub","ns_st_vo","ns_st_pvo","ns_st_ws","ns_st_pws","ns_st_ki","ns_st_rp","ns_st_bn","ns_st_tb","ns_st_an","ns_st_ta","ns_st_pl","ns_st_pr","ns_st_sn","ns_st_en","ns_st_ep","ns_st_sr","ns_st_ty","ns_st_ct","ns_st_cs","ns_st_ge","ns_st_st","ns_st_ce","ns_st_ia","ns_st_dt","ns_st_ddt","ns_st_tdt","ns_st_tm","ns_st_dtm","ns_st_ttm","ns_st_de","ns_st_pu","ns_st_ti","ns_st_cu","ns_st_fee","ns_st_at","ns_st_pat","ns_st_vt","ns_st_pvt","ns_st_tt","ns_st_ptt","ns_st_cdn","ns_st_pcdn","ns_ap_i1","ns_ap_i2","ns_ap_i3","ns_ap_i4","ns_ap_i5","ns_ap_i6","ns_ap_referrer","ns_clid","ns_campaign","ns_source","ns_mchannel","ns_linkname","ns_fee","gclid","utm_campaign","utm_source","utm_medium","utm_term","utm_content","ns_ecommerce","ns_ec_sv","ns_client_id","ns_order_id","ns_ec_cur","ns_orderline_id","ns_orderlines","ns_prod_id","ns_qty","ns_prod_price","ns_prod_grp","ns_brand","ns_shop","ns_category","category","ns_c","ns_search_term","ns_search_result","ns_m_exp","ns_m_chs","c3","ca3","cb3","cc3","cd3","c4","ca4","cb4","cc4","cd4","c5","ca5","cb5","cc5","cd5","c6","ca6","cb6","cc6","cd6","c10","c11","c13","c14","c15","c16","c7","c8","c9","ns_ap_er"]},m=function(){function a(){function a(){I={},I.ns_st_pt="0",I.ns_st_bt="0",I.ns_st_bc="0",I.ns_st_pc="0",I.ns_st_sq="0",I.ns_st_cl="0",I.ns_st_pn="1",I.ns_st_tp="1",I.ns_st_skc="0",I.ns_st_et="0",I.ns_st_cn="1",I.ns_st_sc="0",I.ns_st_ska="0",I.ns_st_skd="0",I.ns_st_skt="0",I.ns_st_upc="0",I.ns_st_lpc="0",I.ns_st_upa="0",I.ns_st_lpa="0",I.ns_st_ub="0",I.ns_st_br="0",f=!1,e=!1,d=h.UNKNOWN_VALUE,g=NaN,m=0,j=0,i=NaN,n=NaN,p=0,o=0,k=0,s=NaN,q=[],r=[],t=0,u=0,v=0,w=0,x=0,y=0,z=NaN,A=0,B=!1,C=NaN,F=!1,E=0,H=0,D=0,G=0,J=0,K=0,L=0,M=0,N=0}function c(){var a,b,c=0;for(a=0;a<q.length;a++)c+=Math.abs(q[a].end-q[a].start);O.setUniquePlaybackInterval(c);var d=0;for(a=0;a<q.length;a++)b=Math.abs(q[a].end-q[a].start),b>d&&(d=b);O.setLongestPlaybackInterval(d);var e=0;for(a=0;a<r.length;a++)e+=Math.abs(r[a].end-r[a].start);O.setAssetUniquePlaybackInterval(e);var f=0;for(a=0;a<r.length;a++)b=Math.abs(r[a].end-r[a].start),b>f&&(f=b);O.setAssetLongestPlaybackInterval(f)}var d,e,f,g,i,j,k,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O=this,P=l.INTERVAL_MERGE_TOLERANCE;b.extend(this,{getHash:function(){return d},setHash:function(a){d=a},setPlaybackIntervalMergeTolerance:function(a){P=a},getPlaybackIntervalMergeTolerance:function(){return P},setLabels:function(a){null!=a&&b.extend(I,a)},getLabels:function(){return I},setLabel:function(a,b){var c={};c[a]=b,O.setLabels(c)},getLabel:function(a){return I[a]},getClipNumber:function(){return parseInt(O.getLabel("ns_st_cn"))},setClipNumber:function(a){O.setLabel("ns_st_cn",String(a))},getPartNumber:function(){return parseInt(O.getLabel("ns_st_pn"))},createLabels:function(a){var c=a||{};c.ns_st_dbt=String(O.getBufferingTime()-A),A=O.getBufferingTime(),c.ns_st_det=String(O.getElapsedTime()-o),o=O.getElapsedTime(),c.ns_st_dupc=String(O.getUniquePlaybackInterval()-t),t=O.getUniquePlaybackInterval(),parseInt(c.ns_st_dupc)<0&&(c.ns_st_dupc="0");var d;d=b.exists(c.ns_st_upc)?parseInt(c.ns_st_upc):O.getUniquePlaybackInterval(),c.ns_st_iupc=String(d-u),u=d,parseInt(c.ns_st_iupc)<0&&(c.ns_st_iupc="0"),c.ns_st_dupa=String(O.getAssetUniquePlaybackInterval()-v),v=O.getAssetUniquePlaybackInterval(),parseInt(c.ns_st_dupa)<0&&(c.ns_st_dupa="0");var e;e=b.exists(c.ns_st_upa)?parseInt(c.ns_st_upa):O.getAssetUniquePlaybackInterval(),c.ns_st_iupa=String(e-w),w=e,parseInt(c.ns_st_iupa)<0&&(c.ns_st_iupa="0"),c.ns_st_dlpc=String(O.getLongestPlaybackInterval()-x),x=O.getLongestPlaybackInterval(),parseInt(c.ns_st_dlpc)<0&&(c.ns_st_dlpc="0"),c.ns_st_dlpa=String(O.getAssetLongestPlaybackInterval()-y),y=O.getAssetLongestPlaybackInterval(),parseInt(c.ns_st_dlpa)<0&&(c.ns_st_dlpa="0");var g;return g=b.exists(c.ns_st_pt)?parseInt(c.ns_st_pt):O.getPlaybackTime(),c.ns_st_ipt=String(g-k),k=g,c.ns_st_dpt=String(O.getPlaybackTime()-j),j=O.getPlaybackTime(),c.ns_st_dpc=String(O.getPauses()-J),J=O.getPauses(),c.ns_st_dskc=String(O.getSeeks()-K),K=O.getSeeks(),c.ns_st_dbc=String(O.getBuffers()-L),L=O.getBuffers(),c.ns_st_dskt=String(O.getSeekingTime()-D),D=O.getSeekingTime(),c.ns_st_dska=String(O.getSeekingAmount()-G),G=O.getSeekingAmount(),b.extend(c,O.getLabels()),O.setSeekingDirection(0),f&&(c.ns_st_spc=String(M),c.ns_st_apc=String(N)),f||b.parseBoolean(c.ns_st_sc)||(c.ns_st_sc="1"),c},getVideoTrack:function(){return O.getLabel("ns_st_vt")},setVideoTrack:function(a){O.setLabel("ns_st_vt",String(a))},getAudioTrack:function(){return O.getLabel("ns_st_at")},setAudioTrack:function(a){O.setLabel("ns_st_at",String(a))},getSubtitleTrack:function(){return O.getLabel("ns_st_tt")},setSubtitleTrack:function(a){O.setLabel("ns_st_tt",String(a))},getCDN:function(){return O.getLabel("ns_st_cdn")},setCDN:function(a){O.setLabel("ns_st_cdn",String(a))},getClipPlaybackIntervals:function(){return q},setClipPlaybackIntervals:function(a){q=a},getAssetPlaybackIntervals:function(){return r},getUniquePlaybackInterval:function(){return parseInt(O.getLabel("ns_st_upc"))},getAssetUniquePlaybackInterval:function(){return parseInt(O.getLabel("ns_st_upa"))},setAssetUniquePlaybackInterval:function(a){O.setLabel("ns_st_upa",String(a))},setUniquePlaybackInterval:function(a){O.setLabel("ns_st_upc",String(a))},getLongestPlaybackInterval:function(){return parseInt(O.getLabel("ns_st_lpc"))},setLongestPlaybackInterval:function(a){O.setLabel("ns_st_lpc",String(a))},getAssetLongestPlaybackInterval:function(){return parseInt(O.getLabel("ns_st_lpa"))},setAssetLongestPlaybackInterval:function(a){O.setLabel("ns_st_lpa",String(a))},incrementPauses:function(){O.setLabel("ns_st_pc",String(O.getPauses()+1))},incrementSeeks:function(){O.setLabel("ns_st_skc",String(O.getSeeks()+1))},incrementPlayCounter:function(){O.setLabel("ns_st_sq",String(O.getPlayCounter()+1))},getPlayCounter:function(){return parseInt(O.getLabel("ns_st_sq"))},getBufferingTime:function(){return parseInt(O.getLabel("ns_st_bt"))},setBufferingTime:function(a){O.setLabel("ns_st_bt",String(a))},addBufferingTime:function(a){if(!isNaN(z)){var b=O.getBufferingTime();b+=a-z,O.setBufferingTime(b),z=NaN}},setPlaybackStartPosition:function(a){s=parseInt(a)},getPlaybackStartPosition:function(){return s},addInterval:function(a){isNaN(s)||isNaN(a)||(q=b.addNewPlaybackInterval(q,s,a,P),r=b.addNewPlaybackInterval(r,s,a,P),c(),s=NaN)},getElapsedTime:function(){return parseInt(O.getLabel("ns_st_et"))},setElapsedTime:function(a){O.setLabel("ns_st_et",String(a))},addElapsedTime:function(a){if(!isNaN(n)){var b=O.getElapsedTime();b+=a-n,O.setElapsedTime(b),n=NaN}},getElapsedTimestamp:function(){return n},setElapsedTimestamp:function(a){n=a},addPlaybackTime:function(a){if(!isNaN(g)){var b=O.getPlaybackTime();b+=a-g,O.setPlaybackTime(b),g=NaN}},getPlaybackTime:function(){return parseInt(O.getLabel("ns_st_pt"))},getExpectedPlaybackPosition:function(a){return isNaN(g)||(m+=a-g),m},setPlaybackTimeOffset:function(a){m=a},getPlaybackTimeOffset:function(){return m},setPlaybackTime:function(a){O.setLabel("ns_st_pt",String(a))},getPlaybackTimestamp:function(){return g},setPlaybackTimestamp:function(a){g=a},setPreviousPlaybackTime:function(a){j=a},setPreviousPlaybackTimestamp:function(a){i=a},getBufferingTimestamp:function(){return z},setBufferingTimestamp:function(a){z=a},getPauses:function(){return parseInt(O.getLabel("ns_st_pc"))},setPauses:function(a){O.setLabel("ns_st_pc",String(a))},getSeeks:function(){return parseInt(O.getLabel("ns_st_skc"))},setSeeks:function(a){O.setLabel("ns_st_skc",String(a))},setSeeking:function(a){B=a},isSeeking:function(){return B},setCollectingSeekingTime:function(a){F=a},isCollectingSeekingTime:function(){return F},setClipStarted:function(a){e=a},isClipStarted:function(){return e},setPlaybackStarted:function(a){f=a},isPlaybackStarted:function(){return f},setSeekingTimestamp:function(a){C=a},getSeekingTimestamp:function(){return C},addSeekingTime:function(a){if(!isNaN(C)){var b=O.getSeekingTime();b+=a-C,O.setSeekingTime(b),C=NaN}},getSeekingTime:function(){return parseInt(O.getLabel("ns_st_skt"))},setSeekingTime:function(a){O.setLabel("ns_st_skt",String(a))},setSeekingTimeBeforeEnd:function(a){H=a},getSeekingTimeBeforeEnd:function(){return H},setSeekStartPosition:function(a){E=a},getSeekStartPosition:function(){return E},setSeekingAmount:function(a){O.setLabel("ns_st_ska",String(a))},getSeekingAmount:function(){return parseInt(O.getLabel("ns_st_ska"))},addSeekingAmount:function(a){var b=O.getSeekingAmount();b+=Math.abs(a-E),O.setSeekingAmount(b);var c;E==a?c=0:E>a?c=-1:a>E&&(c=1),O.setSeekingDirection(c),E=0},getSeekingDirection:function(){return parseInt(O.getLabel("ns_st_skd"))},setSeekingDirection:function(a){O.setLabel("ns_st_skd",String(a))},resetClipLifecycleLabels:function(){I.ns_st_pt="0",j=0,k=0,I.ns_st_bt="0",A=0,I.ns_st_bc="0",L=0,I.ns_st_pc="0",J=0,I.ns_st_sq="0",I.ns_st_upa="0",v=0,w=0,I.ns_st_et="0",o=0,I.ns_st_lpa="0",y=0,I.ns_st_skt="0",D=0,I.ns_st_ska="0",G=0,I.ns_st_skc="0",K=0},incrementSegmentPlaybackCounter:function(){M++},incrementClipLoadCounter:function(){O.setLabel("ns_st_sc",String(O.getClipLoadCounter()+1))},incrementAssetPlaybackCounter:function(){N++},setPreviousUniquePlaybackInterval:function(a){t=a},setPreviousEventIndependentUniquePlaybackInterval:function(a){u=a},setPreviousLongestPlaybackInterval:function(a){x=a},resetAssetPlaybackCounters:function(){r=[],O.setAssetUniquePlaybackInterval(0),v=0,w=0,O.setAssetLongestPlaybackInterval(0),y=0},setSegmentPlaybackCounter:function(a){M=a},setClipLoadCounter:function(a){O.setLabel("ns_st_sc",String(a))},setAssetPlaybackCounter:function(a){N=a},setLowestPartNumberPlayed:function(a){p=a},getSegmentPlaybackCounter:function(){return M},getClipLoadCounter:function(){return parseInt(O.getLabel("ns_st_sc"))},getAssetPlaybackCounter:function(){return N},getLowestPartNumberPlayed:function(){return p},getBuffers:function(){return parseInt(O.getLabel("ns_st_bc"))},incrementBufferCount:function(){O.setLabel("ns_st_bc",String(O.getBuffers()+1))},getPreviousBufferingTime:function(){return A}}),a()}return a.resetClip=function(a,b,c){for(var d=a.getLabels(),e={},f=0;c&&f<c.length;++f)d.hasOwnProperty(c[f])&&(e[c[f]]=d[c[f]]);b.setLabels(e),b.setPlaybackIntervalMergeTolerance(a.getPlaybackIntervalMergeTolerance())},a}(),n=function(){function a(){function a(){c=new m,f={},f.ns_st_bp="0",f.ns_st_pa="0",f.ns_st_pp="0",f.ns_st_sp="1",f.ns_st_id=String(+new Date),d=NaN,e=NaN,h={},i=0,g=!1,j=!1,k=0}var c,d,e,f,g,h,i,j,k,l=this;b.extend(this,{resetClip:function(){var a=c;c=new m,m.resetClip(a,c)},hashExists:function(a){return null!=h[a]},storeHash:function(a){h[a]={}},removeHash:function(a){delete h[a]},storeClipPlaybackCounters:function(){for(var a in h)if(h.hasOwnProperty(a)&&h[a].clipNumber===c.getClipNumber()){b.extend(h[a],{segmentPlaybackCounter:c.getSegmentPlaybackCounter(),clipLoadCounter:c.getClipLoadCounter(),assetPlaybackCounter:c.getAssetPlaybackCounter(),lowestPartNumberPlayed:c.getLowestPartNumberPlayed(),seeking:c.isSeeking(),seekingTimeBeforeEnd:c.getSeekingTimeBeforeEnd(),seekingStartPosition:c.getSeekStartPosition(),clipPlaybackIntervals:c.getClipPlaybackIntervals(),uniquePlaybackInterval:c.getUniquePlaybackInterval(),longestPlaybackInterval:c.getLongestPlaybackInterval(),videoTrack:c.getVideoTrack(),audioTrack:c.getAudioTrack(),subtitleTrack:c.getSubtitleTrack(),cdn:c.getCDN()});break}},getStoredClipRegisters:function(a){return h[a]},getClipNumber:function(a){return h[a].clipNumber},getMaxClipNumber:function(){return i},storeClipNumber:function(a,b){h[a].clipNumber=b,b>i&&(i=b)},setLabels:function(a){null!=a&&b.extend(f,a)},getLabels:function(){return f},setLabel:function(a,b){var c={};c[a]=b,l.setLabels(c)},getLabel:function(a){return f[a]},getClip:function(){return c},createLabels:function(a){var d=a||{};return j||(d.ns_st_pb=null!=d.ns_st_pb?d.ns_st_pb:"1"),b.extend(d,l.getLabels()),c.isPlaybackStarted()&&(d.ns_st_ppc=String(k)),d},incrementPlayCounter:function(){l.setLabel("ns_st_sp",String(parseInt(l.getLabel("ns_st_sp"))+1))},incrementPauses:function(){l.setLabel("ns_st_pp",String(l.getPauses()+1))},addPlaybackTime:function(a){if(!isNaN(e)){var b=l.getPlaybackTime();b+=a-e,l.setPlaybackTime(b),e=NaN}},addBufferingTime:function(a){if(!isNaN(d)){var b=l.getBufferingTime();b+=a-d,l.setBufferingTime(b),d=NaN}},getBufferingTime:function(){return parseInt(l.getLabel("ns_st_bp"))},setBufferingTime:function(a){l.setLabel("ns_st_bp",String(a))},getPlaybackTime:function(){return parseInt(l.getLabel("ns_st_pa"))},setBufferingTimestamp:function(a){d=a},getBufferingTimestamp:function(){return d},setPlaybackTime:function(a){l.setLabel("ns_st_pa",String(a))},setPlaybackTimestamp:function(a){e=a},getPlaybackTimestamp:function(){return e},getPauses:function(){return parseInt(l.getLabel("ns_st_pp"))},setPauses:function(a){l.setLabel("ns_st_pp",String(a))},isPlaylistStarted:function(){return g},setPlaylistStarted:function(a){g=a},getPlaybackCounter:function(){return k},incrementPlaybackCounter:function(){k++},setFirstEventSent:function(a){j=a}}),a()}return a.resetPlaylist=function(b,c,d){for(var e=b.getClip(),f=b.getLabels(),g={},h=0;d&&h<d.length;h++)f.hasOwnProperty(d[h])&&(g[d[h]]=f[d[h]]);c=new a,c.setLabels(g),m.resetClip(e,c.getClip(),d)},a}(),o=function(){return function(a){function c(){e=1}function d(c){f=b.extend({},c);var d=a.getSSECore().getPixelURL();if(a.getAppCore()){if(a.getSSECore().isProperlyInitialized()){var e=a.getSSECore().getExports().am,g=a.getSSECore().getExports().et,h=e.newApplicationMeasurement(a.getAppCore(),g.HIDDEN,c,d);a.getAppCore().getQueue().offer(h)}}else d&&a.getSSECore().getPlatformAPI().httpGet(a.getSSECore().prepareUrl(d,c))}var e,f,g=this;b.extend(this,{newEvent:function(a){d(a.eventLabels),a.eventType!=i.HEARTBEAT&&g.incrementEventCounter()},getEventCounter:function(){return e},incrementEventCounter:function(){e++},setEventCounter:function(a){e=a},getMeasurementSnapshot:function(){return f}}),c()}}(),p=function(){return function(a){function c(){g=0,h=0}function d(){h++;var c={},d=b.fixEventTime(c);c.ns_st_po=String(a.getPlaylist().getClip().getPlaybackTimeOffset()+(d-a.getPlaylist().getClip().getPlaybackTimestamp())),c.ns_st_pa=String(a.getPlaylist().getPlaybackTime()+(d-a.getPlaylist().getPlaybackTimestamp())),c.ns_st_pt=String(a.getPlaylist().getClip().getPlaybackTime()+(d-a.getPlaylist().getClip().getPlaybackTimestamp())),c.ns_st_dpt=String(d-a.getPlaylist().getClip().getPlaybackTimestamp()),a.getStateMachine().getCurrentState()==j.BUFFERING_DURING_PLAYBACK?(c.ns_st_bp=String(a.getPlaylist().getBufferingTime()+(d-a.getPlaylist().getBufferingTimestamp())),c.ns_st_bt=String(a.getPlaylist().getClip().getBufferingTime()+(d-a.getPlaylist().getClip().getBufferingTimestamp())),c.ns_st_dbt=String(d-a.getPlaylist().getClip().getBufferingTimestamp())):c.ns_st_dbt=String(a.getPlaylist().getClip().getBufferingTime()-a.getPlaylist().getClip().getPreviousBufferingTime()),c.ns_st_et=String(a.getPlaylist().getClip().getElapsedTime()+(d-a.getPlaylist().getClip().getElapsedTimestamp())),c.ns_st_det=String(d-a.getPlaylist().getClip().getElapsedTimestamp());var e=b.cloneObject(a.getPlaylist().getClip().getClipPlaybackIntervals()),f=b.cloneObject(a.getPlaylist().getClip().getAssetPlaybackIntervals());e=b.addNewPlaybackInterval(e,a.getPlaylist().getClip().getPlaybackStartPosition(),parseInt(c.ns_st_po),a.getPlaylist().getClip().getPlaybackIntervalMergeTolerance()),f=b.addNewPlaybackInterval(f,a.getPlaylist().getClip().getPlaybackStartPosition(),parseInt(c.ns_st_po),a.getPlaylist().getClip().getPlaybackIntervalMergeTolerance());var l,m,n=0;for(l=0;l<e.length;l++)n+=Math.abs(e[l].end-e[l].start);c.ns_st_upc=String(n),c.ns_st_dupc=String(n-a.getPlaylist().getClip().getUniquePlaybackInterval());var o=0;for(l=0;l<e.length;l++)m=Math.abs(e[l].end-e[l].start),m>o&&(o=m);c.ns_st_lpc=String(o),c.ns_st_dlpc=String(o-a.getPlaylist().getClip().getLongestPlaybackInterval());var p=0;for(l=0;l<f.length;l++)p+=Math.abs(f[l].end-f[l].start);c.ns_st_upa=String(p),c.ns_st_dupa=String(p-a.getPlaylist().getClip().getAssetUniquePlaybackInterval());var q=0;for(l=0;l<f.length;l++)m=Math.abs(f[l].end-f[l].start),m>q&&(q=m);c.ns_st_lpa=String(q),c.ns_st_dlpa=String(q-a.getPlaylist().getClip().getAssetLongestPlaybackInterval()),c.ns_st_hc=String(a.getHeartbeat().getCount());var r=a.getSSECore().createLabels(i.HEARTBEAT,c,d);a.getEventManager().newEvent(r),g=0,k.resume()}function e(){null!=f&&(a.getSSECore().getPlatformAPI().clearTimeout(f),f=null)}var f,g,h,k=this,m=l.DEFAULT_HEARTBEAT_INTERVAL;b.extend(this,{getCount:function(){return h},setIntervals:function(a){m=a},getInterval:function(a){var b=0;if(null!=m)for(var c=0;c<m.length;c++){var d=m[c],e=d.playingtime;if(!e||e>a){b=d.interval;break}}return b},resume:function(){e();var b=k.getInterval(a.getPlaylist().getClip().getPlaybackTime()+(+new Date-a.getPlaylist().getClip().getPlaybackTimestamp()));if(b>0){var c=g>0?g:b;f=a.getSSECore().getPlatformAPI().setTimeout(d,c)}g=0},pause:function(){e();var b=k.getInterval(a.getPlaylist().getClip().getPlaybackTime()+(+new Date-a.getPlaylist().getClip().getPlaybackTimestamp()));g=b-(a.getPlaylist().getClip().getPlaybackTime()+(+new Date-a.getPlaylist().getClip().getPlaybackTimestamp()))%b}}),c()}}(),q=function(){return function(a){function c(){}function d(){var c={},d=b.fixEventTime(c);c.ns_st_po=String(a.getPlaylist().getClip().getExpectedPlaybackPosition(d)),a.getPlaylist().addPlaybackTime(d),a.getPlaylist().setPlaybackTimestamp(d),a.getPlaylist().getClip().addPlaybackTime(d),a.getPlaylist().getClip().setPlaybackTimestamp(d),a.getStateMachine().getCurrentState()==j.BUFFERING_DURING_PLAYBACK&&(a.getPlaylist().addBufferingTime(d),a.getPlaylist().setBufferingTimestamp(d),a.getPlaylist().getClip().addBufferingTime(d),a.getPlaylist().getClip().setBufferingTimestamp(d)),a.getPlaylist().getClip().addElapsedTime(d),a.getPlaylist().getClip().setElapsedTimestamp(d),a.getPlaylist().getClip().addInterval(parseInt(c.ns_st_po)),a.getPlaylist().getClip().setPlaybackStartPosition(parseInt(c.ns_st_po));
    var e=a.getSSECore().createLabels(i.KEEPALIVE,c,d);a.getEventManager().newEvent(e),g.resume()}function e(){null!=f&&(a.getSSECore().getPlatformAPI().clearTimeout(f),f=null)}var f,g=this,h=l.DEFAULT_KEEP_ALIVE_INTERVAL;b.extend(g,{resume:function(){e(),f=a.getSSECore().getPlatformAPI().setTimeout(d,h)},pause:function(){e()},setInterval:function(a){h=a},getInterval:function(){return h}}),c()}}(),r=function(){return function(a){function c(){f=j.IDLE,e=null,d=NaN}var d,e,f,g=this;b.extend(g,{eventTypeToState:function(a){if(f==j.IDLE){if(a==i.PLAY)return j.PLAYING;if(a==i.SEEK_START)return j.SEEKING_BEFORE_PLAYBACK;if(a==i.BUFFER)return j.BUFFERING_BEFORE_PLAYBACK}else if(f==j.PLAYBACK_NOT_STARTED){if(a==i.PLAY)return j.PLAYING;if(a==i.SEEK_START)return j.SEEKING_BEFORE_PLAYBACK;if(a==i.BUFFER)return j.BUFFERING_BEFORE_PLAYBACK;if(a==i.END||a==i.AD_SKIP)return j.IDLE}else if(f==j.PLAYING){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.BUFFER)return j.BUFFERING_DURING_PLAYBACK;if(a==i.PAUSE)return j.PAUSED;if(a==i.SEEK_START)return j.SEEKING_DURING_PLAYBACK}else if(f==j.PAUSED){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.BUFFER)return j.BUFFERING_DURING_PAUSE;if(a==i.PLAY)return j.PLAYING;if(a==i.SEEK_START)return j.SEEKING_DURING_PAUSE}else if(f==j.BUFFERING_BEFORE_PLAYBACK){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PAUSE||a==i.BUFFER_STOP)return j.PLAYBACK_NOT_STARTED;if(a==i.PLAY)return j.PLAYING;if(a==i.SEEK_START)return j.SEEKING_BEFORE_PLAYBACK}else if(f==j.BUFFERING_DURING_PLAYBACK){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PLAY||a==i.BUFFER_STOP)return j.PLAYING;if(a==i.PAUSE_ON_BUFFERING)return j.PAUSED_DURING_BUFFERING;if(a==i.SEEK_START)return j.SEEKING_DURING_BUFFERING;if(a==i.PAUSE)return j.PAUSED}else if(f==j.BUFFERING_DURING_SEEKING){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PLAY)return j.PLAYING;if(a==i.BUFFER_STOP)return j.SEEKING_DURING_PLAYBACK;if(a==i.PAUSE)return j.PAUSED}else if(f==j.BUFFERING_DURING_PAUSE){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PLAY)return j.PLAYING;if(a==i.SEEK_START)return j.SEEKING_DURING_PAUSE;if(a==i.BUFFER_STOP||a==i.PAUSE)return j.PAUSED}else if(f==j.SEEKING_BEFORE_PLAYBACK){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PAUSE)return j.PLAYBACK_NOT_STARTED;if(a==i.PLAY)return j.PLAYING;if(a==i.BUFFER)return j.BUFFERING_BEFORE_PLAYBACK}else if(f==j.SEEKING_DURING_PLAYBACK){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PLAY)return j.PLAYING;if(a==i.PAUSE)return j.PAUSED;if(a==i.BUFFER)return j.BUFFERING_DURING_SEEKING}else if(f==j.SEEKING_DURING_BUFFERING){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PLAY)return j.PLAYING;if(a==i.PAUSE||a==i.BUFFER_STOP)return j.PAUSED}else if(f==j.SEEKING_DURING_PAUSE){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.PLAY)return j.PLAYING;if(a==i.PAUSE||a==i.BUFFER_STOP)return j.PAUSED;if(a==i.BUFFER)return j.BUFFERING_DURING_PAUSE}else if(f==j.PAUSED_DURING_BUFFERING){if(a==i.END||a==i.AD_SKIP)return j.IDLE;if(a==i.SEEK_START)return j.SEEKING_DURING_BUFFERING;if(a==i.PAUSE)return j.PAUSED;if(a==i.PLAY||a==i.BUFFER_STOP)return j.PLAYING}return null},getCurrentState:function(){return f},newEvent:function(a,b){var c=g.eventTypeToState(a);f!=c&&(e=f,f=c,d=b)},getPreviousState:function(){return e},getLastStateChangeTimestamp:function(){return d}}),c()}}(),s=function(){return function(a){var c=this;b.extend(c,{onSeekStartWhenPausedOrBufferingDuringPause:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()?a.getPlaylist().getClip().isCollectingSeekingTime()||(a.getPlaylist().getClip().setSeekingTimestamp(b),a.getPlaylist().getClip().setCollectingSeekingTime(!0)):a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().isSeeking()||(a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b))},onBufferWhenSeekingOrPlayBackNotStartedOrPaused:function(b,c){a.getPlaylist().setBufferingTimestamp(b),a.getPlaylist().getClip().setBufferingTimestamp(b)},onPlayWhenSeekingDuringBufferingOrSeekingDuringPause:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)},onBufferStopWhenBufferingDuringSeekingOrBufferingDuringPause:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b)},onPauseWhenSeekingDuringPlaybackOrSeekingDuringPause:function(b,c){a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))},onEndOrAdSkipWhenSeekingDuringBufferingOrSeekingDuringPause:function(c,d){a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getPlaylist().getClip().addElapsedTime(c);var e=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(e),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onBufferStopWhenSeekingDuringBufferingOrSeekingDuringPause:function(b,c){a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))}})}}(),t=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){a.getPlaylist().addBufferingTime(c),a.getPlaylist().getClip().addBufferingTime(c),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onBufferStop:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))},onSeekStart:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()?a.getPlaylist().getClip().isCollectingSeekingTime()||(a.getPlaylist().getClip().setSeekingTimestamp(b),a.getPlaylist().getClip().setCollectingSeekingTime(!0)):a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().isSeeking()||(a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b))},onPause:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().isPlaylistStarted()||(a.getPlaylist().setPlaylistStarted(!0),a.getPlaylist().incrementPlaybackCounter()),a.getPlaylist().getClip().setClipStarted(!0),a.getPlaylist().getClip().setPlaybackStarted(!0),a.getPlaylist().getClip().incrementSegmentPlaybackCounter(),(0==a.getPlaylist().getClip().getLowestPartNumberPlayed()||parseInt(a.getPlaylist().getClip().getLabels().ns_st_pn)<=a.getPlaylist().getClip().getLowestPartNumberPlayed())&&(a.getPlaylist().getClip().setLowestPartNumberPlayed(parseInt(a.getPlaylist().getClip().getLabels().ns_st_pn)),a.getPlaylist().getClip().incrementAssetPlaybackCounter(),a.getPlaylist().getClip().resetAssetPlaybackCounters()),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getSSECore().isLoadingTimeSent()||(c.ns_st_lt=String(a.getSSECore().getLoadTimeOffset()+b-a.getSSECore().getInitTimestamp()),a.getSSECore().setLoadingTimeSent(!0)),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),u=function(){return function(a){var c=this;b.extend(c,{onEndAndSkip:function(c,d){a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getPlaylist().addBufferingTime(c),a.getPlaylist().getClip().addBufferingTime(c),a.getPlaylist().getClip().addElapsedTime(c);var e=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(e),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onPause:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b)},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),v=function(){return function(a){var c=this;b.extend(c,{onPauseOnBuffering:function(b,c){var d=parseInt(c.ns_st_po);a.getSSECore().stopPausedOnBufferingTimer(),a.getHeartbeat().pause(),a.getSSECore().resetKeepAlive(),a.getPlaylist().addPlaybackTime(b),a.getPlaylist().getClip().addPlaybackTime(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().addInterval(d),a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses();var e=a.getSSECore().createLabels(i.PAUSE,c,b);a.getEventManager().newEvent(e),a.getPlaylist().setBufferingTimestamp(b),a.getPlaylist().getClip().setBufferingTimestamp(b),a.getPlaylist().getClip().setPlaybackTimeOffset(d)},onBufferStop:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b)},onEndOrAdSkip:function(c,d){var e=parseInt(d.ns_st_po);a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getSSECore().stopPausedOnBufferingTimer(),a.getPlaylist().addBufferingTime(c),a.getPlaylist().getClip().addBufferingTime(c),a.getPlaylist().getClip().addPlaybackTime(c),a.getPlaylist().getClip().addElapsedTime(c),a.getPlaylist().getClip().addInterval(e);var f=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(f),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onSeekStart:function(b,c){var d=parseInt(c.ns_st_po);a.getSSECore().stopPausedOnBufferingTimer(),a.getPlaylist().addPlaybackTime(b),a.getPlaylist().getClip().addPlaybackTime(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().addInterval(d),a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses();var e=a.getSSECore().createLabels(i.PAUSE,c,b);a.getEventManager().newEvent(e)},onPause:function(b,c){var d=parseInt(c.ns_st_po);a.getSSECore().stopPausedOnBufferingTimer(),a.getPlaylist().addPlaybackTime(b),a.getPlaylist().getClip().addPlaybackTime(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().addInterval(d),a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses();var e=a.getSSECore().createLabels(i.PAUSE,c,b);a.getEventManager().newEvent(e)},onPlay:function(b,c){a.getSSECore().stopPausedOnBufferingTimer(),a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b)}})}}(),w=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getSSECore().stopPausedOnBufferingTimer(),a.getPlaylist().addBufferingTime(c),a.getPlaylist().getClip().addBufferingTime(c),a.getPlaylist().getClip().addElapsedTime(c);var e=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(e),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onPause:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses(),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),x=function(){return function(a){var c=this;b.extend(c,{onBuffer:function(b,c){a.getPlaylist().getClip().setSeekingTime(a.getPlaylist().getClip().getSeekingTimeBeforeEnd()),a.getPlaylist().setBufferingTimestamp(b),a.getPlaylist().getClip().setBufferingTimestamp(b)},onSeekStart:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().setSeekingTime(a.getPlaylist().getClip().getSeekingTimeBeforeEnd()),a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b)},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().setSeekingTime(a.getPlaylist().getClip().getSeekingTimeBeforeEnd()),a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().isPlaylistStarted()||(a.getPlaylist().setPlaylistStarted(!0),a.getPlaylist().incrementPlaybackCounter()),a.getPlaylist().getClip().setClipStarted(!0),a.getPlaylist().getClip().setPlaybackStarted(!0),a.getPlaylist().getClip().incrementSegmentPlaybackCounter(),(0==a.getPlaylist().getClip().getLowestPartNumberPlayed()||parseInt(a.getPlaylist().getClip().getLabel("ns_st_pn"))<=a.getPlaylist().getClip().getLowestPartNumberPlayed())&&(a.getPlaylist().getClip().setLowestPartNumberPlayed(parseInt(a.getPlaylist().getClip().getLabel("ns_st_pn"))),a.getPlaylist().getClip().incrementAssetPlaybackCounter(),a.getPlaylist().getClip().resetAssetPlaybackCounters()),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getSSECore().isLoadingTimeSent()||(c.ns_st_lt=String(a.getSSECore().getLoadTimeOffset()+b-a.getSSECore().getInitTimestamp()),a.getSSECore().setLoadingTimeSent(!0)),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),y=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getPlaylist().getClip().addElapsedTime(c);var e=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(e),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),z=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getPlaylist().addBufferingTime(c),a.getPlaylist().getClip().addBufferingTime(c),a.getPlaylist().getClip().addElapsedTime(c);var e=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(e),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onBufferStop:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)},onSeekStart:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().isSeeking()?a.getPlaylist().getClip().isCollectingSeekingTime()||(a.getPlaylist().getClip().setSeekingTimestamp(b),a.getPlaylist().getClip().setCollectingSeekingTime(!0)):a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().isSeeking()||(a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b))},onPause:function(b,c){a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses()},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().addBufferingTime(b),a.getPlaylist().getClip().addBufferingTime(b),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),A=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onSeekStart:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()?a.getPlaylist().getClip().setSeekingTimestamp(b):a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().isSeeking()||(a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b))},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().isPlaylistStarted()||(a.getPlaylist().setPlaylistStarted(!0),a.getPlaylist().incrementPlaybackCounter()),a.getPlaylist().getClip().setClipStarted(!0),a.getPlaylist().getClip().setPlaybackStarted(!0),a.getPlaylist().getClip().incrementSegmentPlaybackCounter(),(0==a.getPlaylist().getClip().getLowestPartNumberPlayed()||parseInt(a.getPlaylist().getClip().getLabels().ns_st_pn)<=a.getPlaylist().getClip().getLowestPartNumberPlayed())&&(a.getPlaylist().getClip().setLowestPartNumberPlayed(parseInt(a.getPlaylist().getClip().getLabels().ns_st_pn)),a.getPlaylist().getClip().incrementAssetPlaybackCounter(),a.getPlaylist().getClip().resetAssetPlaybackCounters()),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getSSECore().isLoadingTimeSent()||(c.ns_st_lt=String(a.getSSECore().getLoadTimeOffset()+b-a.getSSECore().getInitTimestamp()),a.getSSECore().setLoadingTimeSent(!0)),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),B=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){var e=parseInt(d.ns_st_po);a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getPlaylist().addPlaybackTime(c),a.getPlaylist().getClip().addPlaybackTime(c),a.getPlaylist().getClip().addElapsedTime(c),a.getPlaylist().getClip().addInterval(e);var f=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(f),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onBuffer:function(b,c){a.getSSECore().isPauseOnBufferingEnabled()&&a.getSSECore().startPausedOnBufferingTimer(b,c),a.getPlaylist().getClip().incrementBufferCount(),a.getPlaylist().setBufferingTimestamp(b),a.getPlaylist().getClip().setBufferingTimestamp(b)},onSeekStart:function(b,c){var d=parseInt(c.ns_st_po);a.getHeartbeat().pause(),a.getSSECore().resetKeepAlive(),a.getPlaylist().addPlaybackTime(b),a.getPlaylist().getClip().addPlaybackTime(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().addInterval(d),a.getPlaylist().getClip().incrementSeeks(),a.getPlaylist().getClip().setSeeking(!0),a.getPlaylist().getClip().setCollectingSeekingTime(!0),a.getPlaylist().getClip().setSeekStartPosition(d),a.getPlaylist().getClip().setSeekingTimestamp(b),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses();var e=a.getSSECore().createLabels(i.PAUSE,c,b);a.getEventManager().newEvent(e)},onPause:function(b,c){var d=parseInt(c.ns_st_po);a.getHeartbeat().pause(),a.getSSECore().resetKeepAlive(),a.getPlaylist().addPlaybackTime(b),a.getPlaylist().getClip().addPlaybackTime(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().addInterval(d),a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses();var e=a.getSSECore().createLabels(i.PAUSE,c,b);a.getEventManager().newEvent(e)}})}}(),C=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onPause:function(b,c){a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().isPlaylistStarted()||(a.getPlaylist().setPlaylistStarted(!0),a.getPlaylist().incrementPlaybackCounter()),a.getPlaylist().getClip().setClipStarted(!0),a.getPlaylist().getClip().setPlaybackStarted(!0),a.getPlaylist().getClip().incrementSegmentPlaybackCounter(),(0==a.getPlaylist().getClip().getLowestPartNumberPlayed()||parseInt(a.getPlaylist().getClip().getLabels().ns_st_pn)<=a.getPlaylist().getClip().getLowestPartNumberPlayed())&&(a.getPlaylist().getClip().setLowestPartNumberPlayed(parseInt(a.getPlaylist().getClip().getLabels().ns_st_pn)),a.getPlaylist().getClip().incrementAssetPlaybackCounter(),a.getPlaylist().getClip().resetAssetPlaybackCounters()),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getSSECore().isLoadingTimeSent()||(c.ns_st_lt=String(a.getSSECore().getLoadTimeOffset()+b-a.getSSECore().getInitTimestamp()),a.getSSECore().setLoadingTimeSent(!0)),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),D=function(){return function(a){var c=this;b.extend(c,{onPause:function(b,c){a.getPlaylist().incrementPauses(),a.getPlaylist().getClip().incrementPauses(),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1))}})}}(),E=function(){return function(a){var c=this;b.extend(c,{onEndOrAdSkip:function(c,d){parseInt(d.ns_st_po);a.getSSECore().resetHeartbeat(),a.getSSECore().resetKeepAlive(),a.getPlaylist().getClip().addElapsedTime(c);var e=a.getSSECore().createLabels(i.END,d,c);a.getEventManager().newEvent(e),a.getPlaylist().getClip().isSeeking()&&a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().setSeekingTimeBeforeEnd(c-a.getPlaylist().getClip().getSeekingTimestamp()),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().storeClipPlaybackCounters(),a.getPlaylist().getClip().resetClipLifecycleLabels(),a.getPlaylist().getClip().setPlaybackStarted(!1),d.hasOwnProperty("ns_st_pe")&&b.parseBoolean(d.ns_st_pe,!1)&&a.getSSECore().resetPlaylist()},onPlay:function(b,c){var d=parseInt(c.ns_st_po);a.getPlaylist().getClip().isSeeking()&&(a.getPlaylist().getClip().isCollectingSeekingTime()&&(a.getPlaylist().getClip().addSeekingTime(b),a.getPlaylist().getClip().setCollectingSeekingTime(!1)),a.getPlaylist().getClip().addSeekingAmount(d),a.getPlaylist().getClip().setSeeking(!1)),a.getPlaylist().getClip().incrementPlayCounter(),a.getPlaylist().setPlaybackTimestamp(b),a.getPlaylist().getClip().setPlaybackTimestamp(b),a.getPlaylist().getClip().addElapsedTime(b),a.getPlaylist().getClip().setElapsedTimestamp(b),a.getPlaylist().getClip().setPlaybackStartPosition(d),a.getSSECore().isLoadingTimeSent()||(c.ns_st_lt=String(a.getSSECore().getLoadTimeOffset()+b-a.getSSECore().getInitTimestamp()),a.getSSECore().setLoadingTimeSent(!0)),a.getHeartbeat().resume(),a.getKeepAlive().resume();var e=a.getSSECore().createLabels(i.PLAY,c,b);a.getEventManager().newEvent(e)}})}}(),F=function(){return function(){function a(){f=new G(aa),b.getNamespace().comScore?(ba=b.getNamespace().comScore.exports,f.setAppCore(ba.c())):f.setAppCore(null),f.setKeepAlive(new q(f)),
    f.setHeartbeat(new p(f)),f.setEventManager(new o(f)),f.setStateMachine(new r),f.setPlaylist(new n),$={},m=new x(f),F=new y(f),H=new A(f),I=new B(f),J=new t(f),K=new v(f),L=new w(f),M=new u(f),N=new z(f),O=new C(f),P=new D(f),Q=new E(f),R=new s(f),S=!1,T=0,U=+new Date,V=!0,X=!1,Z=[]}function c(a){var b=f.getStateMachine().getCurrentState();if(b==j.IDLE||b==j.PLAYBACK_NOT_STARTED||b==j.BUFFERING_BEFORE_PLAYBACK||b==j.SEEKING_BEFORE_PLAYBACK){if(a==i.PLAY)return!0}else if(b==j.PLAYING){if(a==i.END||a==i.AD_SKIP||a==i.SEEK_START||a==i.PAUSE)return!0}else if(b==j.PAUSED||b==j.BUFFERING_DURING_PAUSE||b==j.SEEKING_DURING_PLAYBACK||b==j.SEEKING_DURING_BUFFERING||b==j.SEEKING_DURING_PAUSE){if(a==i.END||a==i.AD_SKIP||a==i.PLAY)return!0}else if(b==j.BUFFERING_DURING_PLAYBACK){if(a==i.PAUSE_ON_BUFFERING||a==i.END||a==i.AD_SKIP||a==i.SEEK_START||a==i.PAUSE||a==i.PLAY)return!0}else if(b==j.BUFFERING_DURING_SEEKING){if(a==i.END||a==i.AD_SKIP||a==i.PAUSE||a==i.PLAY)return!0}else if(b==j.PAUSED_DURING_BUFFERING&&(a==i.END||a==i.AD_SKIP||a==i.BUFFER_STOP||a==i.PLAY))return!0;return!1}function d(a,b,d){var e=f.getStateMachine().getCurrentState();a==i.AD_SKIP&&!d.hasOwnProperty("ns_st_ui")&&c(a)?d.ns_st_ui="skip":a==i.SEEK_START&&!d.hasOwnProperty("ns_st_ui")&&c(a)&&(d.ns_st_ui="seek"),e==j.IDLE?a==i.BUFFER?m.onBuffer(b,d):a==i.SEEK_START?m.onSeekStart(b,d):a==i.PLAY&&m.onPlay(b,d):e==j.PLAYBACK_NOT_STARTED?a==i.END||a==i.AD_SKIP?H.onEndOrAdSkip(b,d):a==i.SEEK_START?H.onSeekStart(b,d):a==i.PLAY?H.onPlay(b,d):a==i.BUFFER&&R.onBufferWhenSeekingOrPlayBackNotStartedOrPaused(b,d):e==j.PLAYING?a==i.END||a==i.AD_SKIP?I.onEndOrAdSkip(b,d):a==i.BUFFER?I.onBuffer(b,d):a==i.SEEK_START?I.onSeekStart(b,d):a==i.PAUSE&&I.onPause(b,d):e==j.PAUSED?a==i.END||a==i.AD_SKIP?F.onEndOrAdSkip(b,d):a==i.PLAY?F.onPlay(b,d):a==i.BUFFER?R.onBufferWhenSeekingOrPlayBackNotStartedOrPaused(b,d):a==i.SEEK_START&&R.onSeekStartWhenPausedOrBufferingDuringPause(b,d):e==j.BUFFERING_BEFORE_PLAYBACK?a==i.END||a==i.AD_SKIP?J.onEndOrAdSkip(b,d):a==i.BUFFER_STOP?J.onBufferStop(b,d):a==i.SEEK_START?J.onSeekStart(b,d):a==i.PAUSE?J.onPause(b,d):a==i.PLAY&&J.onPlay(b,d):e==j.BUFFERING_DURING_PLAYBACK?a==i.PAUSE_ON_BUFFERING?K.onPauseOnBuffering(b,d):a==i.BUFFER_STOP?K.onBufferStop(b,d):a==i.END||a==i.AD_SKIP?K.onEndOrAdSkip(b,d):a==i.SEEK_START?K.onSeekStart(b,d):a==i.PAUSE?K.onPause(b,d):a==i.PLAY&&K.onPlay(b,d):e==j.BUFFERING_DURING_SEEKING?a==i.END||a==i.AD_SKIP?L.onEndOrAdSkip(b,d):a==i.PAUSE?L.onPause(b,d):a==i.PLAY?L.onPlay(b,d):a==i.BUFFER_STOP&&R.onBufferStopWhenBufferingDuringSeekingOrBufferingDuringPause(b,d):e==j.BUFFERING_DURING_PAUSE?a==i.END||a==i.AD_SKIP?M.onEndAndSkip(b,d):a==i.PAUSE?M.onPause(b,d):a==i.PLAY?M.onPlay(b,d):a==i.SEEK_START?R.onSeekStartWhenPausedOrBufferingDuringPause(b,d):a==i.BUFFER_STOP&&R.onBufferStopWhenBufferingDuringSeekingOrBufferingDuringPause(b,d):e==j.SEEKING_BEFORE_PLAYBACK?a==i.END||a==i.AD_SKIP?O.onEndOrAdSkip(b,d):a==i.PAUSE?O.onPause(b,d):a==i.PLAY?O.onPlay(b,d):a==i.BUFFER&&R.onBufferWhenSeekingOrPlayBackNotStartedOrPaused(b,d):e==j.SEEKING_DURING_PLAYBACK?a==i.END||a==i.AD_SKIP?Q.onEndOrAdSkip(b,d):a==i.PLAY?Q.onPlay(b,d):a==i.BUFFER?R.onBufferWhenSeekingOrPlayBackNotStartedOrPaused(b,d):a==i.PAUSE&&R.onPauseWhenSeekingDuringPlaybackOrSeekingDuringPause(b,d):e==j.SEEKING_DURING_BUFFERING?a==i.PAUSE?P.onPause(b,d):a==i.BUFFER?R.onBufferWhenSeekingOrPlayBackNotStartedOrPaused(b,d):a==i.PLAY?R.onPlayWhenSeekingDuringBufferingOrSeekingDuringPause(b,d):a==i.END||a==i.AD_SKIP?R.onEndOrAdSkipWhenSeekingDuringBufferingOrSeekingDuringPause(b,d):a==i.BUFFER_STOP&&R.onBufferStopWhenSeekingDuringBufferingOrSeekingDuringPause(b,d):e==j.PAUSED_DURING_BUFFERING?a==i.END||a==i.AD_SKIP?N.onEndOrAdSkip(b,d):a==i.BUFFER_STOP?N.onBufferStop(b,d):a==i.SEEK_START?N.onSeekStart(b,d):a==i.PAUSE?N.onPause(b,d):a==i.PLAY&&N.onPlay(b,d):e==j.SEEKING_DURING_PAUSE&&(a==i.BUFFER?R.onBufferWhenSeekingOrPlayBackNotStartedOrPaused(b,d):a==i.PLAY?R.onPlayWhenSeekingDuringBufferingOrSeekingDuringPause(b,d):a==i.PAUSE?R.onPauseWhenSeekingDuringPlaybackOrSeekingDuringPause(b,d):a==i.END||a==i.AD_SKIP?R.onEndOrAdSkipWhenSeekingDuringBufferingOrSeekingDuringPause(b,d):a==i.BUFFER_STOP&&R.onBufferStopWhenSeekingDuringBufferingOrSeekingDuringPause(b,d)),c(a)&&f.getPlaylist().setFirstEventSent(!0)}function e(a,c){for(var d,e=ea.encodeURIComponent||escape,f=[],g=l.LABELS_ORDER,h=a.split("?"),i=h[0],j=h[1],k=j.split("&"),m=0,n=k.length;n>m;m++){var o=k[m].split("="),p=unescape(o[0]),q=unescape(o[1]);p&&(c[p]=q)}for(var r={},s=0,t=g.length;t>s;s++){var u=g[s];if(c.hasOwnProperty(u)){var v=c[u];"undefined"!=typeof v&&null!=v&&(r[u]=!0,f.push(e(u)+"="+e(c[u])))}}for(var w in c)if(c.hasOwnProperty(w)){if(r[w])continue;var x=c[w];"undefined"!=typeof x&&null!=x&&f.push(e(w)+"="+e(c[w]))}d=i+"?"+f.join("&"),d=d+(d.indexOf("&c8=")<0?"&c8="+e(fa.title):"")+(d.indexOf("&c7=")<0?"&c7="+e(fa.URL):"")+(d.indexOf("&c9=")<0?"&c9="+e(fa.referrer):"");var y=b.browserAcceptsLargeURLs()?l.URL_LENGTH_LIMIT:l.RESTRICTED_URL_LENGTH_LIMIT;if(d.length>y&&d.indexOf("&")>0){var z=d.substr(0,y-8).lastIndexOf("&");d=(d.substring(0,z)+"&ns_cut="+e(d.substring(z+1))).substr(0,y)}return d}var f,m,F,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa=this,ba={},ca=l.DEFAULT_PAUSED_ON_BUFFERING_INTERVAL,da=l.THROTTLING_DELAY;b.extend(aa,{createLabels:function(a,c,d){var e={};if("undefined"!=typeof document){var g=document;e.c7=g.URL,e.c8=g.title,e.c9=g.referrer}return null!=c&&b.extend(e,c),e.ns_ts=null!=e.ns_ts?e.ns_ts:String(+new Date),e.ns_st_ev=null!=e.ns_st_ev?e.ns_st_ev:i.toString(a),e.ns_st_mp=null!=e.ns_st_mp?e.ns_st_mp:l.DEFAULT_PLAYERNAME,e.ns_st_mv=null!=e.ns_st_mv?e.ns_st_mv:l.STREAMSENSE_VERSION,e.ns_st_ub=null!=e.ns_st_ub?e.ns_st_ub:"0",e.ns_st_br=null!=e.ns_st_br?e.ns_st_br:"0",e.ns_st_pn=null!=e.ns_st_pn?e.ns_st_pn:"1",e.ns_st_tp=null!=e.ns_st_tp?e.ns_st_tp:"1",e.ns_st_it=null!=e.ns_st_it?e.ns_st_it:k.toString(k.SINGLE_CLIP),e.ns_st_sv=null!=e.ns_st_sv?e.ns_st_sv:l.STREAMSENSE_VERSION,e.ns_st_smv=null!=e.ns_st_smv?e.ns_st_smv:l.MODEL_VERSION,e.ns_type=null!=e.ns_type?e.ns_type:"hidden",e.ns_st_ec=null!=e.ns_st_ec?e.ns_st_ec:String(f.getEventManager().getEventCounter()),e.ns_st_po=null!=e.ns_st_po?e.ns_st_po:String(f.getPlaylist().getPlaylist().getClip().getExpectedPlaybackPosition(d)),e.ns_st_ki=null!=e.ns_st_ki?e.ns_st_ki:String(f.getKeepAlive().getInterval()),f.getPlaylist().createLabels(e),f.getPlaylist().getClip().createLabels(e),b.extend(e,aa.getLabels()),b.extend(e,c),{eventType:a,eventLabels:e}},newEvent:function(a,b,c,e){aa.stopDelayedTransitionTimer();var g=f.getStateMachine().getCurrentState(),h=f.getStateMachine().eventTypeToState(a);if(null!=h&&h!=g)if(!aa.isThrottlingEnabled()||g!=j.PLAYING&&g!=j.PAUSED||h!=j.PLAYING&&h!=j.PAUSED||e){c.ns_st_po||(f.getStateMachine().getCurrentState()==j.PLAYING&&a==i.BUFFER||f.getStateMachine().getCurrentState()==j.BUFFERING_DURING_PLAYBACK&&a==i.BUFFER_STOP?c.ns_st_po=String(f.getPlaylist().getClip().getPlaybackTimeOffset()+(b-f.getPlaylist().getClip().getPlaybackTimestamp())):c.ns_st_po=String(f.getPlaylist().getClip().getExpectedPlaybackPosition(b))),d(a,b,c);var k=0;isNaN(f.getStateMachine().getLastStateChangeTimestamp())||(k=b-f.getStateMachine().getLastStateChangeTimestamp()),f.getStateMachine().newEvent(a,b);for(var l=0,m=Z.length;m>l;l++)Z[l](g,h,c,k)}else Y=f.getPlatformAPI().setTimeout(function(a,c,d){return function(){aa.newEvent(a,b,d,!0)}}(a,h,c),da)},newPseudoEvent:function(a,b,c){if(a!=i.LOAD&&a!=i.START||f.getStateMachine().getCurrentState()==j.IDLE){a!=i.ERROR||c.ns_st_er||(c.ns_st_er=h.UNKNOWN_VALUE),f.getStateMachine().getCurrentState()!=j.IDLE&&f.getStateMachine().getCurrentState()!=j.PLAYBACK_NOT_STARTED&&f.getStateMachine().getCurrentState()!=j.SEEKING_BEFORE_PLAYBACK&&f.getStateMachine().getCurrentState()!=j.BUFFERING_BEFORE_PLAYBACK&&(f.getPlaylist().getClip().addElapsedTime(b),f.getPlaylist().getClip().setElapsedTimestamp(b));var d,e,g,k=!0,l=!1;switch(a){case i.BIT_RATE:d="ns_st_br",e="ns_st_pbr",l=!0;break;case i.PLAYBACK_RATE:d="ns_st_rt",e="ns_st_prt",l=!0;break;case i.VOLUME:d="ns_st_vo",e="ns_st_pvo",l=!0;break;case i.WINDOW_STATE:d="ns_st_ws",e="ns_st_pws",l=!0;break;case i.AUDIO:d="ns_st_at",e="ns_st_pat",l=!1;break;case i.VIDEO:d="ns_st_vt",e="ns_st_pvt",l=!1;break;case i.SUBS:d="ns_st_tt",e="ns_st_ptt",l=!1;break;case i.CDN:d="ns_st_cdn",e="ns_st_pcdn",l=!1;break;default:k=!1}if(k&&c.hasOwnProperty(d)&&(l?(aa.getLabels().hasOwnProperty(d)&&(g=aa.getLabels()[d],c[e]=g),aa.setLabel(d,c[d])):(f.getPlaylist().getClip().getLabels().hasOwnProperty(d)&&(g=f.getPlaylist().getClip().getLabels()[d],c[e]=g),f.getPlaylist().getClip().setLabel(d,c[d]))),!k||f.getStateMachine().getCurrentState()==j.PLAYING||f.getStateMachine().getCurrentState()==j.BUFFERING_DURING_PLAYBACK){c.ns_st_po||(c.ns_st_po=String(f.getPlaylist().getClip().getExpectedPlaybackPosition(b))),f.getStateMachine().getCurrentState()!=j.PLAYING&&f.getStateMachine().getCurrentState()!=j.BUFFERING_DURING_PLAYBACK||(f.getPlaylist().addPlaybackTime(b),f.getPlaylist().setPlaybackTimestamp(b),f.getPlaylist().getClip().addPlaybackTime(b),f.getPlaylist().getClip().setPlaybackTimestamp(b),f.getPlaylist().getClip().addInterval(parseInt(c.ns_st_po)),f.getPlaylist().getClip().setPlaybackStartPosition(parseInt(c.ns_st_po))),f.getStateMachine().getCurrentState()!=j.BUFFERING_BEFORE_PLAYBACK&&f.getStateMachine().getCurrentState()!=j.BUFFERING_DURING_PAUSE&&f.getStateMachine().getCurrentState()!=j.BUFFERING_DURING_PLAYBACK&&f.getStateMachine().getCurrentState()!=j.BUFFERING_DURING_SEEKING||(f.getPlaylist().addBufferingTime(b),f.getPlaylist().setBufferingTimestamp(b),f.getPlaylist().getClip().addBufferingTime(b),f.getPlaylist().getClip().setBufferingTimestamp(b));var m=aa.createLabels(a,c,b);f.getEventManager().newEvent(m)}}},getState:function(){return f.getStateMachine().getCurrentState()},addListener:function(a){Z.push(a)},removeListener:function(a){Z.splice(b.indexOf(a,Z),1)},getLabel:function(a){return $[a]},getLabels:function(){return $},setLabel:function(a,b){null==b?delete $[a]:$[a]=b},setLabels:function(a){for(var b in a)a.hasOwnProperty(b)&&aa.setLabel(b,a[b])},getPlatformAPI:function(){return f.getAppCore()?f.getAppCore().getPlatformAPI():g},getExports:function(){return ba},isProperlyInitialized:function(){var a=f.getAppCore().getAppContext(),b=f.getAppCore().getSalt(),c=f.getAppCore().getPixelURL();return a&&c&&b},setImplementationType:function(a){f.getStateMachine().getCurrentState()!=j.IDLE||a!=k.SINGLE_CLIP&&a!=k.SEGMENTED&&a!=k.REDUCED||f.getPlaylist().setLabel("ns_st_it",k.toString(a))},setThrottlingDelay:function(a){da=a},getThrottlingDelay:function(){return da},isThrottlingEnabled:function(){return X},setThrottlingEnabled:function(a){X=a},isLoadingTimeSent:function(){return S},setLoadingTimeSent:function(a){S=a},getLoadTimeOffset:function(){return T},setLoadTimeOffset:function(a){T=a},getInitTimestamp:function(){return U},setPauseOnBufferingInterval:function(a){ca=a},getPauseOnBufferingInterval:function(){return ca},isPauseOnBufferingEnabled:function(){return V},setPauseOnBufferingEnabled:function(a){V=a},startPausedOnBufferingTimer:function(a,c){aa.stopPausedOnBufferingTimer(),W=aa.getPlatformAPI().setTimeout(function(){var d={},e=b.fixEventTime(d),f=parseInt(c.ns_st_po);d.ns_st_po=String(f+e-a),aa.newEvent(i.PAUSE_ON_BUFFERING,e,d)},ca)},stopPausedOnBufferingTimer:function(){null!=W&&(aa.getPlatformAPI().clearTimeout(W),W=null)},stopDelayedTransitionTimer:function(){Y&&(aa.getPlatformAPI().clearTimeout(Y),Y=null)},setPixelURL:function(a){if(null==a||0==a.length)return null;var b=decodeURIComponent||unescape,c=a.indexOf("?");if(c>=0){if(c<a.length-1){for(var d=a.substring(c+1).split("&"),e=0,f=d.length;f>e;e++){var g=d[e],h=g.split("=");2==h.length?aa.setLabel(h[0],b(h[1])):1==h.length&&aa.setLabel(l.PAGE_NAME_LABEL,b(h[0]))}a=a.substring(0,c+1)}}else a+="?";return _=a},getPixelURL:function(){return _?_:"undefined"!=typeof ns_p&&"string"==typeof ns_p.src?_=ns_p.src.replace(/&amp;/,"&").replace(/&ns__t=\d+/,""):"string"==typeof ns_pixelUrl?_=ns_pixelUrl.replace(/&amp;/,"&").replace(/&ns__t=\d+/,""):null},getSseSM:function(){return f},resetPlaylist:function(a){var b=f.getPlaylist();f.setPlaylist(new n),n.resetPlaylist(b,f.getPlaylist(),a)},resetHeartbeat:function(){f.getHeartbeat().pause(),f.setHeartbeat(new p(f))},resetKeepAlive:function(){f.getKeepAlive().pause(),f.setKeepAlive(new q(f))}});var ea,fa;b.isBrowser()?(ea=window,fa=document):(ea={},fa={location:{href:""},title:"",URL:"",referrer:"",cookie:""}),b.extend(this,{prepareUrl:e}),a()}}(),G=function(){return function(a){var c,d,e,f,g,h,i=this;b.extend(i,{getAppCore:function(){return c},getSSECore:function(){return a},getEventManager:function(){return d},getStateMachine:function(){return e},getHeartbeat:function(){return f},getKeepAlive:function(){return g},getPlaylist:function(){return h},setAppCore:function(a){c=a},setKeepAlive:function(a){g=a},setHeartbeat:function(a){f=a},setEventManager:function(a){d=a},setStateMachine:function(a){e=a},setPlaylist:function(a){h=a}})}}(),H=function(){return function(a,c){function d(){h=new F,g=!0,a&&k.setLabels(a),c&&k.setPixelURL(c)}function e(a,b){k.notify(i.CUSTOM,a,b)}function f(){g&&h.getSseSM().getStateMachine().getCurrentState()!=j.IDLE&&k.end()}var g,h,k=this,m=l.STANDARD_METADATA_LABELS;b.extend(this,{isProperlyInitialized:function(){return h.isProperlyInitialized()},reset:function(a){var b=h;b.getSseSM().getKeepAlive().pause(),b.getSseSM().getHeartbeat().pause(),h=new F,n.resetPlaylist(b.getSseSM().getPlaylist(),h.getSseSM().getPlaylist(),a)},setPauseOnBufferingInterval:function(a){h.setPauseOnBufferingInterval(a)},getPauseOnBufferingInterval:function(){return h.getPauseOnBufferingInterval()},setKeepAliveInterval:function(a){h.getSseSM().getKeepAlive().setInterval(a)},getKeepAliveInterval:function(){return h.getSseSM().getKeepAlive().getInterval()},setHeartbeatIntervals:function(a){h.getSseSM().getHeartbeat().setIntervals(a)},play:function(a,b){k.notify(i.PLAY,a,b)},pause:function(a,b){k.notify(i.PAUSE,a,b)},end:function(a,b){k.notify(i.END,a,b)},bufferStart:function(a,b){k.notify(i.BUFFER,a,b)},bufferStop:function(a,b){k.notify(i.BUFFER_STOP,a,b)},load:function(a,b){k.notify(i.LOAD,a,b)},start:function(a,b){k.notify(i.START,a,b)},seekStart:function(a,b){k.notify(i.SEEK_START,a,b)},skipAd:function(a,b){k.notify(i.AD_SKIP,a,b)},callToAction:function(a,b){k.notify(i.CTA,a,b)},error:function(a,b){k.notify(i.ERROR,a,b)},transferPlayback:function(a,b){k.notify(i.TRANSFER,a,b)},drmFail:function(a,b){k.notify(i.DRM_FAILED,a,b)},drmApprove:function(a,b){k.notify(i.DRM_APPROVED,a,b)},drmDeny:function(a,b){k.notify(i.DRM_DENIED,a,b)},changeBitrate:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_br=String(a),k.notify(i.BIT_RATE,d,b)}},changePlaybackRate:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_rt=String(a),k.notify(i.PLAYBACK_RATE,d,b)}},changeVolume:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_vo=String(a),k.notify(i.VOLUME,d,b)}},changeWindowState:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_ws=String(a),k.notify(i.WINDOW_STATE,d,b)}},changeAudio:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_at=String(a),k.notify(i.AUDIO,d,b)}},changeVideo:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_vt=String(a),k.notify(i.VIDEO,d,b)}},changeSubtitle:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_tt=String(a),k.notify(i.SUBS,d,b)}},changeCDN:function(a,b,c){if(null!=a){var d=c||{};d.ns_st_cdn=String(a),k.notify(i.CDN,d,b)}},notify:function(a){var c,d;if(c="object"==typeof arguments[1]?arguments[1]:"object"==typeof arguments[2]?arguments[2]:{},d="number"==typeof arguments[1]?arguments[1]:"number"==typeof arguments[2]?arguments[2]:NaN,i.toString(a)){c=b.jsonObjectToStringDictionary(c);var e=b.fixEventTime(c);c.ns_st_po||isNaN(d)||(c.ns_st_po=b.getInteger(d,0).toString()),c.ns_st_po&&h.getSseSM().getPlaylist().getClip().setPlaybackTimeOffset(parseInt(c.ns_st_po)),a==i.PLAY||a==i.PAUSE||a==i.BUFFER||a==i.END||a==i.SEEK_START||a==i.AD_SKIP||a==i.BUFFER_STOP?h.newEvent(a,e,c):h.newPseudoEvent(a,e,c)}},getLabels:function(){return h.getLabels()},getState:function(){return h.getSseSM().getStateMachine().getCurrentState()},setLabels:function(a){h.setLabels(a)},getLabel:function(a){return h.getLabel(a)},setLabel:function(a,b){h.setLabel(a,b)},getLoadTimeOffset:function(){return h.getLoadTimeOffset()},setLoadTimeOffset:function(a){h.setLoadTimeOffset(a)},setPixelURL:function(a){return h.setPixelURL(a)},getPixelURL:function(){return h.getSseSM().getSSECore().getPixelURL()},setImplementationType:function(a){h.setImplementationType(a)},isPauseOnBufferingEnabled:function(){return h.isPauseOnBufferingEnabled()},setPauseOnBufferingEnabled:function(a){h.setPauseOnBufferingEnabled(a)},isThrottlingEnabled:function(){return h.isThrottlingEnabled()},setThrottlingEnabled:function(a){h.setThrottlingEnabled(a)},setThrottlingDelay:function(a){h.setThrottlingDelay(a)},getThrottlingDelay:function(){return h.getThrottlingDelay()},setPlaybackIntervalMergeTolerance:function(a){h.getSseSM().getPlaylist().getClip().setPlaybackIntervalMergeTolerance(a)},getPlaybackIntervalMergeTolerance:function(){return h.getSseSM().getPlaylist().getClip().getPlaybackIntervalMergeTolerance()},setClip:function(a,c,d){if(void 0===d&&(d=!0),a=b.jsonObjectToStringDictionary(a),d&&h.getSseSM().getStateMachine().getCurrentState()!==j.IDLE&&k.end(),h.getSseSM().getStateMachine().getCurrentState()==j.IDLE){var e="",f=0;if(null!=a.ns_st_cn)e=String(a.ns_st_cn);else for(var g=0;g<m.length;g++)a[m[g]]&&(e+=m[g]+":"+a[m[g]]+";");var i=h.getSseSM().getPlaylist(),l=i.getClip();l.isClipStarted()?(i.hashExists(l.getHash())||(i.storeHash(l.getHash()),i.storeClipNumber(l.getHash(),l.getClipNumber())),i.storeClipPlaybackCounters(),f=i.hashExists(e)?i.getClipNumber(e):b.exists(a.ns_st_cn)?parseInt(a.ns_st_cn):i.getMaxClipNumber()+1):f=i.hashExists(e)?i.getClipNumber(e):l.getClipNumber(),i.resetClip(),l=i.getClip(),l.setHash(e),l.setClipNumber(f),l.setLabels(a);var n=i.getStoredClipRegisters(e);return n&&(l.setClipStarted(!0),l.setSegmentPlaybackCounter(n.segmentPlaybackCounter),l.setClipLoadCounter(n.clipLoadCounter),l.setAssetPlaybackCounter(n.assetPlaybackCounter),l.setLowestPartNumberPlayed(n.lowestPartNumberPlayed),l.setSeeking(n.seeking),l.setSeekingTimeBeforeEnd(n.seekingTimeBeforeEnd),l.setSeekStartPosition(n.seekingStartPosition),l.setClipPlaybackIntervals(n.clipPlaybackIntervals),l.setUniquePlaybackInterval(n.uniquePlaybackInterval),l.setLongestPlaybackInterval(n.longestPlaybackInterval),l.setVideoTrack(n.videoTrack),l.setAudioTrack(n.audioTrack),l.setSubtitleTrack(n.subtitleTrack),l.setCDN(n.cdn),l.setPreviousUniquePlaybackInterval(n.uniquePlaybackInterval),l.setPreviousEventIndependentUniquePlaybackInterval(n.uniquePlaybackInterval),l.setPreviousLongestPlaybackInterval(n.longestPlaybackInterval)),l.incrementClipLoadCounter(),l.isClipStarted()&&c&&(i.incrementPlayCounter(),i.incrementPlaybackCounter()),!0}return!1},setPlaylist:function(a,c){return void 0===c&&(c=!0),a=b.jsonObjectToStringDictionary(a),c&&h.getSseSM().getStateMachine().getCurrentState()!==j.IDLE&&k.end(),h.getSseSM().getStateMachine().getCurrentState()==j.IDLE?(h.getSseSM().getPlaylist().isPlaylistStarted()&&h.resetPlaylist(),h.getSseSM().getPlaylist().setLabels(a),!0):!1},importState:function(){},exportState:function(){return{}},getVersion:function(){return l.STREAMSENSE_VERSION},addListener:function(a){h.addListener(a)},removeListener:function(a){h.removeListener(a)},getClip:function(){return console&&console.warn&&console.warn("getClip() is deprecated. Use getPlaylist().getClip() instead."),h.getSseSM().getPlaylist().getClip()},getPlaylist:function(){return h.getSseSM().getPlaylist()},setHttpGet:function(a){"function"==typeof a&&(h.getPlatformAPI().httpGet=a)},setHttpPost:function(a){"function"==typeof a&&(h.getPlatformAPI().httpPost=a)},setExitEndEventEnabled:function(a){g=a},isExitEndEventEnabled:function(){return g},getPlatformAPI:function(){return h.getPlatformAPI()}}),b.extend(this,{customNotify:e,viewNotify:function(a,b){a=a||k.getPixelURL(),a&&viewNotify(a,b)}}),b.isBrowser()&&(window.addEventListener?(window.addEventListener("beforeunload",f),window.addEventListener("unload",f)):window.attachEvent&&(window.attachEvent("onbeforeunload",f),window.attachEvent("onunload",f))),d()}}();return function(c){function d(a,b){return x[z]||f(a,b)}function e(){z=-1;for(var b=0;y>=b;b++)if(x.hasOwnProperty(String(b))){z=b;break}return a.StreamSense.activeIndex=z,z}function f(b,c){return b=b||null,c=c||null,b&&"object"==typeof b&&(c=b,b=null),x[++y]=new a.StreamSense(c,b),e(),x[y]}function g(){var b=!1,c=z;if("number"==typeof arguments[0]&&isFinite(arguments[0]))c=arguments[0];else if(arguments[0]instanceof a.StreamSense)for(var d in x)if(x.hasOwnProperty(d)&&x[d]===arguments[0]){c=d;break}return x.hasOwnProperty(String(c))&&(b=x[c],delete x[c],b.reset(),e()),b}function h(a){return a=a||{},d().setPlaylist(a),d().getPlaylist()}function i(a,b,c){return a=a||{},"number"==typeof b&&(a.ns_st_cn=String(b)),d().setClip(a,c),d().getClip()}function j(a,b,c){return"undefined"==typeof a?!1:(c=c||null,b=b||{},d().notify(a,b,c))}function k(a){"undefined"!=typeof a&&d().setLabels(a)}function l(){return d().getLabels()}function m(a){"undefined"!=typeof a&&d().getPlaylist().setLabels(a)}function n(){return d().getPlaylist().getLabels()}function o(a){"undefined"!=typeof a&&d().getClip().setLabels(a)}function p(){return d().getClip().getLabels()}function q(a){return d().reset(a||{})}function r(a){return d().getPlaylist().reset(a||{})}function s(a){return d().getClip().reset(a||{})}function t(a){return a=a||{},d().viewNotify(null,a)}function u(a,b){return arguments.length>2&&(a=arguments[1],b=arguments[2]),a=a||{},"number"==typeof b&&(a.ns_st_po=String(b)),d().customNotify(a,b)}function v(){return d().exportState()}function w(a){d().importState(a)}var x={},y=-1,z=-1;b.extend(c,{activeIndex:z,newInstance:f,"new":f,destroyInstance:g,destroy:g,newPlaylist:h,newClip:i,notify:j,setLabels:k,getLabels:l,setPlaylistLabels:m,getPlaylistLabels:n,setClipLabels:o,getClipLabels:p,resetInstance:q,resetPlaylist:r,resetClip:s,viewEvent:t,customEvent:u,exportState:v,importState:w})}(H),H.PlayerEvents=i,H.InternalStates=j,H.ImplementationType=k,H}(),a.StreamingTag=a.StreamingTag||function(){var c=a.StreamSense,d=(a.StreamSense.PlayerEvents,a.StreamSense.InternalStates||null),e=a.StreamSense.ImplementationType||null,f=null!=a.StreamSense.InternalStates&&null!=a.StreamSense.ImplementationType;return function(){var a={LongFormOnDemand:"12",ShortFormOnDemand:"11",Live:"13",UserGeneratedLongFormOnDemand:"22",UserGeneratedShortFormOnDemand:"21",UserGeneratedLive:"23",Bumper:"99",Other:"00"},g={LinearOnDemandPreRoll:"11",LinearOnDemandMidRoll:"12",LinearOnDemandPostRoll:"13",LinearLive:"21",Other:"00"},h=function(a){function g(){if(f)if(b.getNamespace().comScore)q=new c,q.setImplementationType(e.REDUCED);else if(b.exists(a))if(r=b.isTrue(a.debug),b.exists(a.customerC2)&&a.customerC2.length>0){var d=a.secure?"https://sb":"http"+("s"==document.location.href.charAt(4)?"s://sb":"://b");q=new c,q.setPixelURL(d+".scorecardresearch.com/p?c1=2"),q.setLabel("c2",a.customerC2),q.setImplementationType(e.REDUCED)}else r&&console&&console.log("Warning: customerC2 is not provided (or incorrect) in the StreamingTag configuration.")}function h(a){b.exists(a)||(a={});for(var c in t)t.hasOwnProperty(c)&&!b.exists(a[t[c]])&&("ns_st_ci"==t[c]?a.ns_st_ci="0":a[t[c]]="*null");return a}function i(a){for(var b in t)if(t.hasOwnProperty(b)&&!j(t[b],o,a))return!1;return!0}function j(a,c,d){if(b.exists(a)&&b.exists(c)&&b.exists(d)){var e=c[a],f=d[a];return b.exists(e)&&b.exists(f)&&e===f}return!1}function k(a){n++;var c={ns_st_cn:String(n),ns_st_pn:"1",ns_st_tp:"0"};b.extend(c,a),q.setClip(c),o=a,q.play()}function l(a){n++,a=h(a);var c={ns_st_cn:String(n),ns_st_pn:"1",ns_st_tp:"1",ns_st_ad:"1"};b.extend(c,a),q.setClip(c),q.play(),p=!1}function m(a,b){a=h(a),u==s.None&&(u=b),p&&u==b&&i(a)?(q.getClip().setLabels(a),q.getState()!=d.PLAYING&&q.play()):k(a),p=!0,u=b}var n=0,o=null,p=!1,q=null,r=!1,s={None:0,AudioContent:1,VideoContent:2},t=["ns_st_ci","c3","c4","c6","ns_st_st","ns_st_pu","ns_st_pr","ns_st_ep","ns_st_sn","ns_st_en","ns_st_ct"],u=s.None;b.extend(this,{playAdvertisement:function(){if(q){r&&console&&console.warn("Calling deprecated function 'playAdvertisement'. Please call 'playVideoAdvertisement' or 'playAudioAdvertisement' functions instead.");var a={ns_st_ct:"va"};l(a)}},playVideoAdvertisement:function(a,c){if(q){var d={ns_st_ct:"va"};c?d.ns_st_ct="va"+c:r&&console&&console.warn("Calling 'playVideoAdvertisement' without specifying the media type as a second parameter."),a&&b.extend(d,a),l(d)}},playAudioAdvertisement:function(a,c){if(q){var d={ns_st_ct:"aa"};c?d.ns_st_ct="aa"+c:r&&console&&console.warn("Calling 'playAudioAdvertisement' without specifying the media type as a second parameter."),a&&b.extend(d,a),l(d)}},playContentPart:function(a){if(q){r&&console&&console.warn("Calling deprecated function 'playContentPart'. Please call 'playVideoContentPart' or 'playAudioContentPart' functions instead.");var c={ns_st_ct:"vc"};a&&b.extend(c,a),m(c,s.VideoContent)}},playVideoContentPart:function(a,c){if(q){var d={ns_st_ct:"vc"};c?d.ns_st_ct="vc"+c:r&&console&&console.warn("Calling 'playVideoContentPart' without specifying the media type as a second parameter."),a&&b.extend(d,a),m(d,s.VideoContent)}},playAudioContentPart:function(a,c){if(q){var d={ns_st_ct:"ac"};c?d.ns_st_ct="ac"+c:r&&console&&console.warn("Calling 'playAudioContentPart' without specifying the media type as a second parameter."),a&&b.extend(d,a),m(d,s.AudioContent)}},stop:function(){q&&q.pause()}}),g()};return function(a){}(h),h.ContentType=a,h.AdType=g,h}()}(),a});

